<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The AQUA Project, Glasgow University, 1993-1998

The simplifier utilities
-}</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span>
</span><span id="line-9"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html"><span class="hs-identifier">GHC.Core.Opt.Simplify.Utils</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-10"></span><span>        </span><span class="hs-comment">-- Rebuilding</span><span>
</span><span id="line-11"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#rebuildLam"><span class="hs-identifier">rebuildLam</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#mkCase"><span class="hs-identifier">mkCase</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#prepareAlts"><span class="hs-identifier">prepareAlts</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#tryEtaExpandRhs"><span class="hs-identifier">tryEtaExpandRhs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#wantEtaExpansion"><span class="hs-identifier">wantEtaExpansion</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>
</span><span id="line-14"></span><span>        </span><span class="hs-comment">-- Inlining,</span><span>
</span><span id="line-15"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#preInlineUnconditionally"><span class="hs-identifier">preInlineUnconditionally</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#postInlineUnconditionally"><span class="hs-identifier">postInlineUnconditionally</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#activeRule"><span class="hs-identifier">activeRule</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#getUnfoldingInRuleMatch"><span class="hs-identifier">getUnfoldingInRuleMatch</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#updModeForStableUnfoldings"><span class="hs-identifier">updModeForStableUnfoldings</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#updModeForRules"><span class="hs-identifier">updModeForRules</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>
</span><span id="line-20"></span><span>        </span><span class="hs-comment">-- The BindContext type</span><span>
</span><span id="line-21"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BindContext"><span class="hs-identifier">BindContext</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#bindContextLevel"><span class="hs-identifier">bindContextLevel</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>
</span><span id="line-23"></span><span>        </span><span class="hs-comment">-- The continuation type</span><span>
</span><span id="line-24"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier">SimplCont</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#DupFlag"><span class="hs-identifier">DupFlag</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#FromWhat"><span class="hs-identifier">FromWhat</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StaticEnv"><span class="hs-identifier">StaticEnv</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-25"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#isSimplified"><span class="hs-identifier">isSimplified</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contIsStop"><span class="hs-identifier">contIsStop</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-26"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contIsDupable"><span class="hs-identifier">contIsDupable</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contResultType"><span class="hs-identifier">contResultType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleType"><span class="hs-identifier">contHoleType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleScaling"><span class="hs-identifier">contHoleScaling</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-27"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contIsTrivial"><span class="hs-identifier">contIsTrivial</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contArgs"><span class="hs-identifier">contArgs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contIsRhs"><span class="hs-identifier">contIsRhs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-28"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#countArgs"><span class="hs-identifier">countArgs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#mkBoringStop"><span class="hs-identifier">mkBoringStop</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#mkRhsStop"><span class="hs-identifier">mkRhsStop</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#mkLazyArgStop"><span class="hs-identifier">mkLazyArgStop</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#interestingCallContext"><span class="hs-identifier">interestingCallContext</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-31"></span><span>
</span><span id="line-32"></span><span>        </span><span class="hs-comment">-- ArgInfo</span><span>
</span><span id="line-33"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgInfo"><span class="hs-identifier">ArgInfo</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgSpec"><span class="hs-identifier">ArgSpec</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#RewriteCall"><span class="hs-identifier">RewriteCall</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#mkArgInfo"><span class="hs-identifier">mkArgInfo</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-34"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#addValArgTo"><span class="hs-identifier">addValArgTo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#addCastTo"><span class="hs-identifier">addCastTo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#addTyArgTo"><span class="hs-identifier">addTyArgTo</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-35"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#argInfoExpr"><span class="hs-identifier">argInfoExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#argInfoAppArgs"><span class="hs-identifier">argInfoAppArgs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-36"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#pushSimplifiedArgs"><span class="hs-identifier">pushSimplifiedArgs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#pushSimplifiedRevArgs"><span class="hs-identifier">pushSimplifiedRevArgs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-37"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#isStrictArgInfo"><span class="hs-identifier">isStrictArgInfo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#lazyArgContext"><span class="hs-identifier">lazyArgContext</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-38"></span><span>
</span><span id="line-39"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#abstractFloats"><span class="hs-identifier">abstractFloats</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-40"></span><span>
</span><span id="line-41"></span><span>        </span><span class="hs-comment">-- Utilities</span><span>
</span><span id="line-42"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#isExitJoinId"><span class="hs-identifier">isExitJoinId</span></a></span><span>
</span><span id="line-43"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-44"></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Prelude.Basic.html#head"><span class="hs-identifier">head</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">init</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">last</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Prelude.Basic.html#tail"><span class="hs-identifier">tail</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Partial</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Prelude.Basic.html#head"><span class="hs-identifier">head</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.html"><span class="hs-identifier">GHC.Core</span></a></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Literal.html"><span class="hs-identifier">GHC.Types.Literal</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Literal.html#isLitRubbish"><span class="hs-identifier">isLitRubbish</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html"><span class="hs-identifier">GHC.Core.Opt.Simplify.Env</span></a></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Inline.html"><span class="hs-identifier">GHC.Core.Opt.Simplify.Inline</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Inline.html#smallEnoughToInline"><span class="hs-identifier">smallEnoughToInline</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Stats.html"><span class="hs-identifier">GHC.Core.Opt.Stats</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Stats.html#Tick"><span class="hs-identifier">Tick</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html"><span class="hs-identifier">GHC.Core.Subst</span></a></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Ppr.html"><span class="hs-identifier">GHC.Core.Ppr</span></a></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Ppr.html"><span class="hs-identifier">GHC.Core.TyCo.Ppr</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Ppr.html#pprParendType"><span class="hs-identifier">pprParendType</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.FVs.html"><span class="hs-identifier">GHC.Core.FVs</span></a></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html"><span class="hs-identifier">GHC.Core.Utils</span></a></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html"><span class="hs-identifier">GHC.Core.Rules</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleEnv"><span class="hs-identifier">RuleEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#getRules"><span class="hs-identifier">getRules</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html"><span class="hs-identifier">GHC.Core.Opt.Arity</span></a></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html"><span class="hs-identifier">GHC.Core.Unfold</span></a></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.Make.html"><span class="hs-identifier">GHC.Core.Unfold.Make</span></a></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html"><span class="hs-identifier">GHC.Core.Opt.Simplify.Monad</span></a></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Type.html"><span class="hs-identifier">GHC.Core.Type</span></a></span><span>     </span><span class="hs-keyword">hiding</span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#substTy"><span class="hs-identifier">substTy</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html"><span class="hs-identifier">GHC.Core.Coercion</span></a></span><span> </span><span class="hs-keyword">hiding</span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#substCo"><span class="hs-identifier">substCo</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html"><span class="hs-identifier">GHC.Core.DataCon</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#dataConWorkId"><span class="hs-identifier">dataConWorkId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#isNullaryRepDataCon"><span class="hs-identifier">isNullaryRepDataCon</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Multiplicity.html"><span class="hs-identifier">GHC.Core.Multiplicity</span></a></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.ConstantFold.html"><span class="hs-identifier">GHC.Core.Opt.ConstantFold</span></a></span><span>
</span><span id="line-68"></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.html"><span class="hs-identifier">GHC.Types.Name</span></a></span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.html"><span class="hs-identifier">GHC.Types.Id</span></a></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.Info.html"><span class="hs-identifier">GHC.Types.Id.Info</span></a></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Tickish.html"><span class="hs-identifier">GHC.Types.Tickish</span></a></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html"><span class="hs-identifier">GHC.Types.Demand</span></a></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html"><span class="hs-identifier">GHC.Types.Var.Set</span></a></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html"><span class="hs-identifier">GHC.Types.Basic</span></a></span><span>
</span><span id="line-76"></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.OrdList.html"><span class="hs-identifier">GHC.Data.OrdList</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Data.OrdList.html#isNilOL"><span class="hs-identifier">isNilOL</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html"><span class="hs-identifier">GHC.Data.FastString</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier">fsLit</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Monad.html"><span class="hs-identifier">GHC.Utils.Monad</span></a></span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-84"></span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">when</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">sortBy</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.Env.html"><span class="hs-identifier">GHC.Types.Name.Env</span></a></span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Graph.html"><span class="hs-identifier">Data.Graph</span></a></span><span>
</span><span id="line-89"></span><span>
</span><span id="line-90"></span><span class="annot"><span class="hs-comment">{- *********************************************************************
*                                                                      *
                The BindContext type
*                                                                      *
********************************************************************* -}</span></span><span>
</span><span id="line-95"></span><span>
</span><span id="line-96"></span><span class="hs-comment">-- What sort of binding is this? A let-binding or a join-binding?</span><span>
</span><span id="line-97"></span><span class="hs-keyword">data</span><span> </span><span id="BindContext"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BindContext"><span class="hs-identifier hs-var">BindContext</span></a></span></span><span>
</span><span id="line-98"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="BC_Let"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BC_Let"><span class="hs-identifier hs-var">BC_Let</span></a></span></span><span>                 </span><span class="hs-comment">-- A regular let-binding</span><span>
</span><span id="line-99"></span><span>      </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#RecFlag"><span class="hs-identifier hs-type">RecFlag</span></a></span><span>
</span><span id="line-100"></span><span>
</span><span id="line-101"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="BC_Join"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BC_Join"><span class="hs-identifier hs-var">BC_Join</span></a></span></span><span>                </span><span class="hs-comment">-- A join point with continuation k</span><span>
</span><span id="line-102"></span><span>      </span><span class="annot"><a href="GHC.Types.Basic.html#RecFlag"><span class="hs-identifier hs-type">RecFlag</span></a></span><span>              </span><span class="hs-comment">-- See Note [Rules and unfolding for join points]</span><span>
</span><span id="line-103"></span><span>      </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>            </span><span class="hs-comment">-- in GHC.Core.Opt.Simplify</span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#bindContextLevel"><span class="hs-identifier hs-type">bindContextLevel</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BindContext"><span class="hs-identifier hs-type">BindContext</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span>
</span><span id="line-106"></span><span id="bindContextLevel"><span class="annot"><span class="annottext">bindContextLevel :: BindContext -&gt; TopLevelFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#bindContextLevel"><span class="hs-identifier hs-var hs-var">bindContextLevel</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BC_Let"><span class="hs-identifier hs-type">BC_Let</span></a></span><span> </span><span id="local-6989586621682977051"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682977051"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682977051"><span class="hs-identifier hs-var">top_lvl</span></a></span><span>
</span><span id="line-107"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#bindContextLevel"><span class="hs-identifier hs-var">bindContextLevel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BC_Join"><span class="hs-identifier hs-type">BC_Join</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="GHC.Types.Basic.html#NotTopLevel"><span class="hs-identifier hs-var">NotTopLevel</span></a></span><span>
</span><span id="line-108"></span><span>
</span><span id="line-109"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#bindContextRec"><span class="hs-identifier hs-type">bindContextRec</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BindContext"><span class="hs-identifier hs-type">BindContext</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#RecFlag"><span class="hs-identifier hs-type">RecFlag</span></a></span><span>
</span><span id="line-110"></span><span id="bindContextRec"><span class="annot"><span class="annottext">bindContextRec :: BindContext -&gt; RecFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#bindContextRec"><span class="hs-identifier hs-var hs-var">bindContextRec</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BC_Let"><span class="hs-identifier hs-type">BC_Let</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682977054"><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621682977054"><span class="hs-identifier hs-var">rec_flag</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621682977054"><span class="hs-identifier hs-var">rec_flag</span></a></span><span>
</span><span id="line-111"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#bindContextRec"><span class="hs-identifier hs-var">bindContextRec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BC_Join"><span class="hs-identifier hs-type">BC_Join</span></a></span><span> </span><span id="local-6989586621682977055"><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621682977055"><span class="hs-identifier hs-var">rec_flag</span></a></span></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621682977055"><span class="hs-identifier hs-var">rec_flag</span></a></span><span>
</span><span id="line-112"></span><span>
</span><span id="line-113"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#isJoinBC"><span class="hs-identifier hs-type">isJoinBC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BindContext"><span class="hs-identifier hs-type">BindContext</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-114"></span><span id="isJoinBC"><span class="annot"><span class="annottext">isJoinBC :: BindContext -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#isJoinBC"><span class="hs-identifier hs-var hs-var">isJoinBC</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BC_Let"><span class="hs-identifier hs-type">BC_Let</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-115"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#isJoinBC"><span class="hs-identifier hs-var">isJoinBC</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BC_Join"><span class="hs-identifier hs-type">BC_Join</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-116"></span><span>
</span><span id="line-117"></span><span>
</span><span id="line-118"></span><span class="annot"><span class="hs-comment">{- *********************************************************************
*                                                                      *
                The SimplCont and DupFlag types
*                                                                      *
************************************************************************

A SimplCont allows the simplifier to traverse the expression in a
zipper-like fashion.  The SimplCont represents the rest of the expression,
&quot;above&quot; the point of interest.

You can also think of a SimplCont as an &quot;evaluation context&quot;, using
that term in the way it is used for operational semantics. This is the
way I usually think of it, For example you'll often see a syntax for
evaluation context looking like
        C ::= []  |  C e   |  case C of alts  |  C `cast` co
That's the kind of thing we are doing here, and I use that syntax in
the comments.


Key points:
  * A SimplCont describes a *strict* context (just like
    evaluation contexts do).  E.g. Just [] is not a SimplCont

  * A SimplCont describes a context that *does not* bind
    any variables.  E.g. \x. [] is not a SimplCont
-}</span></span><span>
</span><span id="line-144"></span><span>
</span><span id="line-145"></span><span class="hs-keyword">data</span><span> </span><span id="SimplCont"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-var">SimplCont</span></a></span></span><span>
</span><span id="line-146"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="Stop"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span></span><span>                </span><span class="annot"><span class="hs-comment">-- ^ Stop[e] = e</span></span><span>
</span><span id="line-147"></span><span>        </span><span class="annot"><a href="GHC.Core.html#OutType"><span class="hs-identifier hs-type">OutType</span></a></span><span>         </span><span class="annot"><span class="hs-comment">-- ^ Type of the &lt;hole&gt;</span></span><span>
</span><span id="line-148"></span><span>        </span><span class="annot"><a href="GHC.Core.Unfold.html#CallCtxt"><span class="hs-identifier hs-type">CallCtxt</span></a></span><span>        </span><span class="hs-comment">-- ^ Tells if there is something interesting about</span><span>
</span><span id="line-149"></span><span>                        </span><span class="hs-comment">--          the syntactic context, and hence the inliner</span><span>
</span><span id="line-150"></span><span>                        </span><span class="hs-comment">--          should be a bit keener (see interestingCallContext)</span><span>
</span><span id="line-151"></span><span>                        </span><span class="hs-comment">-- Specifically:</span><span>
</span><span id="line-152"></span><span>                        </span><span class="hs-comment">--     This is an argument of a function that has RULES</span><span>
</span><span id="line-153"></span><span>                        </span><span class="hs-comment">--     Inlining the call might allow the rule to fire</span><span>
</span><span id="line-154"></span><span>                        </span><span class="hs-comment">-- Never ValAppCxt (use ApplyToVal instead)</span><span>
</span><span id="line-155"></span><span>                        </span><span class="hs-comment">-- or CaseCtxt (use Select instead)</span><span>
</span><span id="line-156"></span><span>        </span><span class="annot"><a href="GHC.Types.Demand.html#SubDemand"><span class="hs-identifier hs-type">SubDemand</span></a></span><span>       </span><span class="hs-comment">-- ^ The evaluation context of e. Tells how e is evaluated.</span><span>
</span><span id="line-157"></span><span>                        </span><span class="hs-comment">-- This fuels eta-expansion or eta-reduction without looking</span><span>
</span><span id="line-158"></span><span>                        </span><span class="hs-comment">-- at lambda bodies, for example.</span><span>
</span><span id="line-159"></span><span>                        </span><span class="hs-comment">--</span><span>
</span><span id="line-160"></span><span>                        </span><span class="hs-comment">-- See Note [Eta reduction based on evaluation context]</span><span>
</span><span id="line-161"></span><span>                        </span><span class="hs-comment">-- The evaluation context for other SimplConts can be</span><span>
</span><span id="line-162"></span><span>                        </span><span class="hs-comment">-- reconstructed with 'contEvalContext'</span><span>
</span><span id="line-163"></span><span>
</span><span id="line-164"></span><span>
</span><span id="line-165"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="CastIt"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#CastIt"><span class="hs-identifier hs-var">CastIt</span></a></span></span><span>              </span><span class="hs-comment">-- (CastIt co K)[e] = K[ e `cast` co ]</span><span>
</span><span id="line-166"></span><span>      </span><span class="hs-special">{</span><span> </span><span id="sc_co"><span class="annot"><span class="annottext">SimplCont -&gt; OutCoercion
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_co"><span class="hs-identifier hs-var hs-var">sc_co</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#OutCoercion"><span class="hs-identifier hs-type">OutCoercion</span></a></span><span>  </span><span class="hs-comment">-- The coercion simplified</span><span>
</span><span id="line-167"></span><span>                                </span><span class="hs-comment">-- Invariant: never an identity coercion</span><span>
</span><span id="line-168"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="sc_opt"><span class="annot"><span class="annottext">SimplCont -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_opt"><span class="hs-identifier hs-var hs-var">sc_opt</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>         </span><span class="hs-comment">-- True &lt;=&gt; sc_co has had optCoercion applied to it</span><span>
</span><span id="line-169"></span><span>                                </span><span class="hs-comment">--      See Note [Avoid re-simplifying coercions]</span><span>
</span><span id="line-170"></span><span>                                </span><span class="hs-comment">--      in GHC.Core.Opt.Simplify.Iteration</span><span>
</span><span id="line-171"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="sc_cont"><span class="annot"><span class="annottext">SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var hs-var">sc_cont</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-172"></span><span>
</span><span id="line-173"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="ApplyToVal"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToVal"><span class="hs-identifier hs-var">ApplyToVal</span></a></span></span><span>         </span><span class="hs-comment">-- (ApplyToVal arg K)[e] = K[ e arg ]</span><span>
</span><span id="line-174"></span><span>      </span><span class="hs-special">{</span><span> </span><span id="sc_dup"><span class="annot"><span class="annottext">SimplCont -&gt; DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_dup"><span class="hs-identifier hs-var hs-var">sc_dup</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#DupFlag"><span class="hs-identifier hs-type">DupFlag</span></a></span><span>   </span><span class="hs-comment">-- See Note [DupFlag invariants]</span><span>
</span><span id="line-175"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="sc_hole_ty"><span class="annot"><span class="annottext">SimplCont -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_hole_ty"><span class="hs-identifier hs-var hs-var">sc_hole_ty</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#OutType"><span class="hs-identifier hs-type">OutType</span></a></span><span>   </span><span class="hs-comment">-- Type of the function, presumably (forall a. blah)</span><span>
</span><span id="line-176"></span><span>                                </span><span class="hs-comment">-- See Note [The hole type in ApplyToTy]</span><span>
</span><span id="line-177"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="sc_arg"><span class="annot"><span class="annottext">SimplCont -&gt; OutExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_arg"><span class="hs-identifier hs-var hs-var">sc_arg</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span>       </span><span class="hs-comment">-- The argument,</span><span>
</span><span id="line-178"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="sc_env"><span class="annot"><span class="annottext">SimplCont -&gt; StaticEnv
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_env"><span class="hs-identifier hs-var hs-var">sc_env</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StaticEnv"><span class="hs-identifier hs-type">StaticEnv</span></a></span><span>    </span><span class="hs-comment">-- see Note [StaticEnv invariant]</span><span>
</span><span id="line-179"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="sc_cont"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-180"></span><span>
</span><span id="line-181"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="ApplyToTy"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToTy"><span class="hs-identifier hs-var">ApplyToTy</span></a></span></span><span>          </span><span class="hs-comment">-- (ApplyToTy ty K)[e] = K[ e ty ]</span><span>
</span><span id="line-182"></span><span>      </span><span class="hs-special">{</span><span> </span><span id="sc_arg_ty"><span class="annot"><span class="annottext">SimplCont -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_arg_ty"><span class="hs-identifier hs-var hs-var">sc_arg_ty</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#OutType"><span class="hs-identifier hs-type">OutType</span></a></span><span>     </span><span class="hs-comment">-- Argument type</span><span>
</span><span id="line-183"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="sc_hole_ty"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_hole_ty"><span class="hs-identifier hs-var">sc_hole_ty</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#OutType"><span class="hs-identifier hs-type">OutType</span></a></span><span>     </span><span class="hs-comment">-- Type of the function, presumably (forall a. blah)</span><span>
</span><span id="line-184"></span><span>                                  </span><span class="hs-comment">-- See Note [The hole type in ApplyToTy]</span><span>
</span><span id="line-185"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="sc_cont"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-186"></span><span>
</span><span id="line-187"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="Select"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#Select"><span class="hs-identifier hs-var">Select</span></a></span></span><span>             </span><span class="hs-comment">-- (Select alts K)[e] = K[ case e of alts ]</span><span>
</span><span id="line-188"></span><span>      </span><span class="hs-special">{</span><span> </span><span id="sc_dup"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_dup"><span class="hs-identifier hs-var">sc_dup</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#DupFlag"><span class="hs-identifier hs-type">DupFlag</span></a></span><span>        </span><span class="hs-comment">-- See Note [DupFlag invariants]</span><span>
</span><span id="line-189"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="sc_bndr"><span class="annot"><span class="annottext">SimplCont -&gt; Id
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_bndr"><span class="hs-identifier hs-var hs-var">sc_bndr</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span>           </span><span class="hs-comment">-- case binder</span><span>
</span><span id="line-190"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="sc_alts"><span class="annot"><span class="annottext">SimplCont -&gt; [InAlt]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_alts"><span class="hs-identifier hs-var hs-var">sc_alts</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#InAlt"><span class="hs-identifier hs-type">InAlt</span></a></span><span class="hs-special">]</span><span>        </span><span class="hs-comment">-- Alternatives</span><span>
</span><span id="line-191"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="sc_env"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_env"><span class="hs-identifier hs-var">sc_env</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StaticEnv"><span class="hs-identifier hs-type">StaticEnv</span></a></span><span>      </span><span class="hs-comment">-- See Note [StaticEnv invariant]</span><span>
</span><span id="line-192"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="sc_cont"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-193"></span><span>
</span><span id="line-194"></span><span>  </span><span class="hs-comment">-- The two strict forms have no DupFlag, because we never duplicate them</span><span>
</span><span id="line-195"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="StrictBind"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StrictBind"><span class="hs-identifier hs-var">StrictBind</span></a></span></span><span>          </span><span class="hs-comment">-- (StrictBind x b K)[e] = let x = e in K[b]</span><span>
</span><span id="line-196"></span><span>                        </span><span class="hs-comment">--       or, equivalently,  = K[ (\x.b) e ]</span><span>
</span><span id="line-197"></span><span>      </span><span class="hs-special">{</span><span> </span><span id="sc_dup"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_dup"><span class="hs-identifier hs-var">sc_dup</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#DupFlag"><span class="hs-identifier hs-type">DupFlag</span></a></span><span>        </span><span class="hs-comment">-- See Note [DupFlag invariants]</span><span>
</span><span id="line-198"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="sc_from"><span class="annot"><span class="annottext">SimplCont -&gt; FromWhat
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_from"><span class="hs-identifier hs-var hs-var">sc_from</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#FromWhat"><span class="hs-identifier hs-type">FromWhat</span></a></span><span>
</span><span id="line-199"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="sc_bndr"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_bndr"><span class="hs-identifier hs-var">sc_bndr</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span>
</span><span id="line-200"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="sc_body"><span class="annot"><span class="annottext">SimplCont -&gt; OutExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_body"><span class="hs-identifier hs-var hs-var">sc_body</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span>
</span><span id="line-201"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="sc_env"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_env"><span class="hs-identifier hs-var">sc_env</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StaticEnv"><span class="hs-identifier hs-type">StaticEnv</span></a></span><span>      </span><span class="hs-comment">-- Static env for both sc_bndr (stable unfolding thereof)</span><span>
</span><span id="line-202"></span><span>                                   </span><span class="hs-comment">-- and sc_body.  Also see Note [StaticEnv invariant]</span><span>
</span><span id="line-203"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="sc_cont"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-204"></span><span>
</span><span id="line-205"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="StrictArg"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StrictArg"><span class="hs-identifier hs-var">StrictArg</span></a></span></span><span>           </span><span class="hs-comment">-- (StrictArg (f e1 ..en) K)[e] = K[ f e1 .. en e ]</span><span>
</span><span id="line-206"></span><span>      </span><span class="hs-special">{</span><span> </span><span id="sc_dup"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_dup"><span class="hs-identifier hs-var">sc_dup</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#DupFlag"><span class="hs-identifier hs-type">DupFlag</span></a></span><span>     </span><span class="hs-comment">-- Always Simplified or OkToDup</span><span>
</span><span id="line-207"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="sc_fun"><span class="annot"><span class="annottext">SimplCont -&gt; ArgInfo
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_fun"><span class="hs-identifier hs-var hs-var">sc_fun</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span>     </span><span class="hs-comment">-- Specifies f, e1..en, Whether f has rules, etc</span><span>
</span><span id="line-208"></span><span>                               </span><span class="hs-comment">--     plus demands and discount flags for *this* arg</span><span>
</span><span id="line-209"></span><span>                               </span><span class="hs-comment">--          and further args</span><span>
</span><span id="line-210"></span><span>                               </span><span class="hs-comment">--     So ai_dmds and ai_discs are never empty</span><span>
</span><span id="line-211"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="sc_fun_ty"><span class="annot"><span class="annottext">SimplCont -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_fun_ty"><span class="hs-identifier hs-var hs-var">sc_fun_ty</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#OutType"><span class="hs-identifier hs-type">OutType</span></a></span><span>   </span><span class="hs-comment">-- Type of the function (f e1 .. en),</span><span>
</span><span id="line-212"></span><span>                               </span><span class="hs-comment">-- presumably (arg_ty -&gt; res_ty)</span><span>
</span><span id="line-213"></span><span>                               </span><span class="hs-comment">-- where res_ty is expected by sc_cont</span><span>
</span><span id="line-214"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="sc_cont"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-215"></span><span>
</span><span id="line-216"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="TickIt"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#TickIt"><span class="hs-identifier hs-var">TickIt</span></a></span></span><span>              </span><span class="hs-comment">-- (TickIt t K)[e] = K[ tick t e ]</span><span>
</span><span id="line-217"></span><span>        </span><span class="annot"><a href="GHC.Types.Tickish.html#CoreTickish"><span class="hs-identifier hs-type">CoreTickish</span></a></span><span>     </span><span class="hs-comment">-- Tick tickish &lt;hole&gt;</span><span>
</span><span id="line-218"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-219"></span><span>
</span><span id="line-220"></span><span class="hs-keyword">type</span><span> </span><span id="StaticEnv"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StaticEnv"><span class="hs-identifier hs-var">StaticEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span>       </span><span class="hs-comment">-- Just the static part is relevant</span><span>
</span><span id="line-221"></span><span>
</span><span id="line-222"></span><span class="hs-keyword">data</span><span> </span><span id="FromWhat"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#FromWhat"><span class="hs-identifier hs-var">FromWhat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="FromLet"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#FromLet"><span class="hs-identifier hs-var">FromLet</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="FromBeta"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#FromBeta"><span class="hs-identifier hs-var">FromBeta</span></a></span></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Levity"><span class="hs-identifier hs-type">Levity</span></a></span><span>
</span><span id="line-223"></span><span>
</span><span id="line-224"></span><span class="hs-comment">-- See Note [DupFlag invariants]</span><span>
</span><span id="line-225"></span><span class="hs-keyword">data</span><span> </span><span id="DupFlag"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#DupFlag"><span class="hs-identifier hs-var">DupFlag</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="NoDup"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#NoDup"><span class="hs-identifier hs-var">NoDup</span></a></span></span><span>       </span><span class="hs-comment">-- Unsimplified, might be big</span><span>
</span><span id="line-226"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span id="Simplified"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#Simplified"><span class="hs-identifier hs-var">Simplified</span></a></span></span><span>  </span><span class="hs-comment">-- Simplified</span><span>
</span><span id="line-227"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span id="OkToDup"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#OkToDup"><span class="hs-identifier hs-var">OkToDup</span></a></span></span><span>     </span><span class="hs-comment">-- Simplified and small</span><span>
</span><span id="line-228"></span><span>
</span><span id="line-229"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#isSimplified"><span class="hs-identifier hs-type">isSimplified</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#DupFlag"><span class="hs-identifier hs-type">DupFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-230"></span><span id="isSimplified"><span class="annot"><span class="annottext">isSimplified :: DupFlag -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#isSimplified"><span class="hs-identifier hs-var hs-var">isSimplified</span></a></span></span><span> </span><span class="annot"><span class="annottext">DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#NoDup"><span class="hs-identifier hs-var">NoDup</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-231"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#isSimplified"><span class="hs-identifier hs-var">isSimplified</span></a></span><span> </span><span class="annot"><span class="annottext">DupFlag
</span><span class="hs-identifier">_</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>       </span><span class="hs-comment">-- Invariant: the subst-env is empty</span><span>
</span><span id="line-232"></span><span>
</span><span id="line-233"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#perhapsSubstTy"><span class="hs-identifier hs-type">perhapsSubstTy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#DupFlag"><span class="hs-identifier hs-type">DupFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StaticEnv"><span class="hs-identifier hs-type">StaticEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-234"></span><span id="perhapsSubstTy"><span class="annot"><span class="annottext">perhapsSubstTy :: DupFlag -&gt; StaticEnv -&gt; OutType -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#perhapsSubstTy"><span class="hs-identifier hs-var hs-var">perhapsSubstTy</span></a></span></span><span> </span><span id="local-6989586621682977091"><span class="annot"><span class="annottext">DupFlag
</span><a href="#local-6989586621682977091"><span class="hs-identifier hs-var">dup</span></a></span></span><span> </span><span id="local-6989586621682977092"><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977092"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682977093"><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977093"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-235"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">DupFlag -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#isSimplified"><span class="hs-identifier hs-var">isSimplified</span></a></span><span> </span><span class="annot"><span class="annottext">DupFlag
</span><a href="#local-6989586621682977091"><span class="hs-identifier hs-var">dup</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977093"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-236"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; StaticEnv -&gt; OutType -&gt; OutType
StaticEnv -&gt; OutType -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Env.html#substTy"><span class="hs-identifier hs-var">substTy</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977092"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977093"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-237"></span><span>
</span><span id="line-238"></span><span class="hs-comment">{- Note [StaticEnv invariant]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We pair up an InExpr or InAlts with a StaticEnv, which establishes the
lexical scope for that InExpr.

When we simplify that InExpr/InAlts, we use
  - Its captured StaticEnv
  - Overriding its InScopeSet with the larger one at the
    simplification point.

Why override the InScopeSet?  Example:
      (let y = ey in f) ex
By the time we simplify ex, 'y' will be in scope.

However the InScopeSet in the StaticEnv is not irrelevant: it should
include all the free vars of applying the substitution to the InExpr.
Reason: contHoleType uses perhapsSubstTy to apply the substitution to
the expression, and that (rightly) gives ASSERT failures if the InScopeSet
isn't big enough.

Note [DupFlag invariants]
~~~~~~~~~~~~~~~~~~~~~~~~~
In both ApplyToVal { se_dup = dup, se_env = env, se_cont = k}
   and  Select { se_dup = dup, se_env = env, se_cont = k}
the following invariants hold

  (a) if dup = OkToDup, then continuation k is also ok-to-dup
  (b) if dup = OkToDup or Simplified, the subst-env is empty,
               or at least is always ignored; the payload is
               already an OutThing
-}</span><span>
</span><span id="line-269"></span><span>
</span><span id="line-270"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#DupFlag"><span class="hs-identifier hs-type">DupFlag</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-271"></span><span>  </span><span id="local-6989586621682977101"><span class="annot"><span class="annottext">ppr :: DupFlag -&gt; SDoc
</span><a href="#local-6989586621682977101"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="annot"><span class="annottext">DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#OkToDup"><span class="hs-identifier hs-var">OkToDup</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ok&quot;</span></span><span>
</span><span id="line-272"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#NoDup"><span class="hs-identifier hs-var">NoDup</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;nodup&quot;</span></span><span>
</span><span id="line-273"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#Simplified"><span class="hs-identifier hs-var">Simplified</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;simpl&quot;</span></span><span>
</span><span id="line-274"></span><span>
</span><span id="line-275"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-276"></span><span>  </span><span id="local-6989586621682977168"><span class="annot"><span class="annottext">ppr :: SimplCont -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#Stop"><span class="hs-identifier hs-type">Stop</span></a></span><span> </span><span id="local-6989586621682977169"><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977169"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621682977170"><span class="annot"><span class="annottext">CallCtxt
</span><a href="#local-6989586621682977170"><span class="hs-identifier hs-var">interesting</span></a></span></span><span> </span><span id="local-6989586621682977171"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621682977171"><span class="hs-identifier hs-var">eval_sd</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-277"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Stop&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#brackets"><span class="hs-identifier hs-var">brackets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="annot"><span class="annottext">([SDoc] -&gt; SDoc) -&gt; [SDoc] -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; [SDoc] -&gt; [SDoc]
forall doc. IsLine doc =&gt; doc -&gt; [doc] -&gt; [doc]
</span><a href="GHC.Utils.Outputable.html#punctuate"><span class="hs-identifier hs-var">punctuate</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a></span><span> </span><span class="annot"><span class="annottext">[SDoc]
</span><a href="#local-6989586621682977177"><span class="hs-identifier hs-var">pps</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">OutType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977169"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-278"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-279"></span><span>      </span><span id="local-6989586621682977177"><span class="annot"><span class="annottext">pps :: [SDoc]
</span><a href="#local-6989586621682977177"><span class="hs-identifier hs-var hs-var">pps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">CallCtxt -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CallCtxt
</span><a href="#local-6989586621682977170"><span class="hs-identifier hs-var">interesting</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; [SDoc] -&gt; [SDoc]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubDemand -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621682977171"><span class="hs-identifier hs-var">eval_sd</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621682977171"><span class="hs-identifier hs-var">eval_sd</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand -&gt; SubDemand -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="GHC.Types.Demand.html#topSubDmd"><span class="hs-identifier hs-var">topSubDmd</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-280"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#CastIt"><span class="hs-identifier hs-type">CastIt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_co :: SimplCont -&gt; OutCoercion
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_co"><span class="hs-identifier hs-var">sc_co</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977181"><span class="annot"><span class="annottext">OutCoercion
</span><a href="#local-6989586621682977181"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977182"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977182"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-281"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;CastIt&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">OutCoercion -&gt; SDoc
</span><a href="GHC.Core.Ppr.html#pprOptCo"><span class="hs-identifier hs-var">pprOptCo</span></a></span><span> </span><span class="annot"><span class="annottext">OutCoercion
</span><a href="#local-6989586621682977181"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977182"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-282"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#TickIt"><span class="hs-identifier hs-type">TickIt</span></a></span><span> </span><span id="local-6989586621682977185"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682977185"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621682977186"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977186"><span class="hs-identifier hs-var">cont</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-283"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;TickIt&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682977185"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977186"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-284"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToTy"><span class="hs-identifier hs-type">ApplyToTy</span></a></span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_arg_ty :: SimplCont -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_arg_ty"><span class="hs-identifier hs-var">sc_arg_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977187"><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977187"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977188"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977188"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-285"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ApplyToTy&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">OutType -&gt; SDoc
</span><a href="GHC.Core.TyCo.Ppr.html#pprParendType"><span class="hs-identifier hs-var">pprParendType</span></a></span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977187"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977188"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-286"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToVal"><span class="hs-identifier hs-type">ApplyToVal</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_arg :: SimplCont -&gt; OutExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_arg"><span class="hs-identifier hs-var">sc_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977189"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977189"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_dup :: SimplCont -&gt; DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_dup"><span class="hs-identifier hs-var">sc_dup</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977190"><span class="annot"><span class="annottext">DupFlag
</span><a href="#local-6989586621682977190"><span class="hs-identifier hs-var">dup</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977191"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977191"><span class="hs-identifier hs-var">cont</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_hole_ty :: SimplCont -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_hole_ty"><span class="hs-identifier hs-var">sc_hole_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977192"><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977192"><span class="hs-identifier hs-var">hole_ty</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-287"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SDoc -&gt; BranchCount -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ApplyToVal&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">DupFlag -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">DupFlag
</span><a href="#local-6989586621682977190"><span class="hs-identifier hs-var">dup</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;hole&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">OutType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977192"><span class="hs-identifier hs-var">hole_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-288"></span><span>          </span><span class="annot"><span class="annottext">BranchCount
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutExpr -&gt; SDoc
forall b. OutputableBndr b =&gt; Expr b -&gt; SDoc
</span><a href="GHC.Core.Ppr.html#pprParendExpr"><span class="hs-identifier hs-var">pprParendExpr</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977189"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-289"></span><span>      </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977191"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-290"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StrictBind"><span class="hs-identifier hs-type">StrictBind</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_bndr :: SimplCont -&gt; Id
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_bndr"><span class="hs-identifier hs-var">sc_bndr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977195"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977195"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977196"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977196"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-291"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;StrictBind&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977195"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977196"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-292"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StrictArg"><span class="hs-identifier hs-type">StrictArg</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_fun :: SimplCont -&gt; ArgInfo
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_fun"><span class="hs-identifier hs-var">sc_fun</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977197"><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682977197"><span class="hs-identifier hs-var">ai</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977198"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977198"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-293"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;StrictArg&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArgInfo -&gt; Id
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_fun"><span class="hs-identifier hs-var">ai_fun</span></a></span><span> </span><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682977197"><span class="hs-identifier hs-var">ai</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977198"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-294"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#Select"><span class="hs-identifier hs-type">Select</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_dup :: SimplCont -&gt; DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_dup"><span class="hs-identifier hs-var">sc_dup</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977200"><span class="annot"><span class="annottext">DupFlag
</span><a href="#local-6989586621682977200"><span class="hs-identifier hs-var">dup</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_bndr :: SimplCont -&gt; Id
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_bndr"><span class="hs-identifier hs-var">sc_bndr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977201"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977201"><span class="hs-identifier hs-var">bndr</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_alts :: SimplCont -&gt; [InAlt]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_alts"><span class="hs-identifier hs-var">sc_alts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977202"><span class="annot"><span class="annottext">[InAlt]
</span><a href="#local-6989586621682977202"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977203"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977203"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-295"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Select&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">DupFlag -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">DupFlag
</span><a href="#local-6989586621682977200"><span class="hs-identifier hs-var">dup</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977201"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-296"></span><span>      </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsOutput doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#whenPprDebug"><span class="hs-identifier hs-var">whenPprDebug</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BranchCount -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a></span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; SDoc) -&gt; SDoc -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[InAlt] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[InAlt]
</span><a href="#local-6989586621682977202"><span class="hs-identifier hs-var">alts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977203"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-297"></span><span>
</span><span id="line-298"></span><span>
</span><span id="line-299"></span><span class="hs-comment">{- Note [The hole type in ApplyToTy]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The sc_hole_ty field of ApplyToTy records the type of the &quot;hole&quot; in the
continuation.  It is absolutely necessary to compute contHoleType, but it is
not used for anything else (and hence may not be evaluated).

Why is it necessary for contHoleType?  Consider the continuation
     ApplyToType Int (Stop Int)
corresponding to
     (&lt;hole&gt; @Int) :: Int
What is the type of &lt;hole&gt;?  It could be (forall a. Int) or (forall a. a),
and there is no way to know which, so we must record it.

In a chain of applications  (f @t1 @t2 @t3) we'll lazily compute exprType
for (f @t1) and (f @t1 @t2), which is potentially non-linear; but it probably
doesn't matter because we'll never compute them all.

************************************************************************
*                                                                      *
                ArgInfo and ArgSpec
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-322"></span><span>
</span><span id="line-323"></span><span class="hs-keyword">data</span><span> </span><span id="ArgInfo"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgInfo"><span class="hs-identifier hs-var">ArgInfo</span></a></span></span><span>
</span><span id="line-324"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="ArgInfo"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgInfo"><span class="hs-identifier hs-var">ArgInfo</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-325"></span><span>        </span><span id="ai_fun"><span class="annot"><span class="annottext">ArgInfo -&gt; Id
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_fun"><span class="hs-identifier hs-var hs-var">ai_fun</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span class="hs-special">,</span><span>      </span><span class="hs-comment">-- The function</span><span>
</span><span id="line-326"></span><span>        </span><span id="ai_args"><span class="annot"><span class="annottext">ArgInfo -&gt; [ArgSpec]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_args"><span class="hs-identifier hs-var hs-var">ai_args</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgSpec"><span class="hs-identifier hs-type">ArgSpec</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- ...applied to these args (which are in *reverse* order)</span><span>
</span><span id="line-327"></span><span>
</span><span id="line-328"></span><span>        </span><span id="ai_rewrite"><span class="annot"><span class="annottext">ArgInfo -&gt; RewriteCall
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_rewrite"><span class="hs-identifier hs-var hs-var">ai_rewrite</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#RewriteCall"><span class="hs-identifier hs-type">RewriteCall</span></a></span><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- What transformation to try next for this call</span><span>
</span><span id="line-329"></span><span>             </span><span class="hs-comment">-- See Note [Rewrite rules and inlining] in GHC.Core.Opt.Simplify.Iteration</span><span>
</span><span id="line-330"></span><span>
</span><span id="line-331"></span><span>        </span><span id="ai_encl"><span class="annot"><span class="annottext">ArgInfo -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_encl"><span class="hs-identifier hs-var hs-var">ai_encl</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">,</span><span>        </span><span class="hs-comment">-- Flag saying whether this function</span><span>
</span><span id="line-332"></span><span>                                </span><span class="hs-comment">-- or an enclosing one has rules (recursively)</span><span>
</span><span id="line-333"></span><span>                                </span><span class="hs-comment">--      True =&gt; be keener to inline in all args</span><span>
</span><span id="line-334"></span><span>
</span><span id="line-335"></span><span>        </span><span id="ai_dmds"><span class="annot"><span class="annottext">ArgInfo -&gt; [Demand]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_dmds"><span class="hs-identifier hs-var hs-var">ai_dmds</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>    </span><span class="hs-comment">-- Demands on remaining value arguments (beyond ai_args)</span><span>
</span><span id="line-336"></span><span>                                </span><span class="hs-comment">--   Usually infinite, but if it is finite it guarantees</span><span>
</span><span id="line-337"></span><span>                                </span><span class="hs-comment">--   that the function diverges after being given</span><span>
</span><span id="line-338"></span><span>                                </span><span class="hs-comment">--   that number of args</span><span>
</span><span id="line-339"></span><span>
</span><span id="line-340"></span><span>        </span><span id="ai_discs"><span class="annot"><span class="annottext">ArgInfo -&gt; [BranchCount]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_discs"><span class="hs-identifier hs-var hs-var">ai_discs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">]</span><span>       </span><span class="hs-comment">-- Discounts for remaining value arguments (beyond ai_args)</span><span>
</span><span id="line-341"></span><span>                                </span><span class="hs-comment">--   non-zero =&gt; be keener to inline</span><span>
</span><span id="line-342"></span><span>                                </span><span class="hs-comment">--   Always infinite</span><span>
</span><span id="line-343"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-344"></span><span>
</span><span id="line-345"></span><span class="hs-keyword">data</span><span> </span><span id="RewriteCall"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#RewriteCall"><span class="hs-identifier hs-var">RewriteCall</span></a></span></span><span>  </span><span class="hs-comment">-- What rewriting to try next for this call</span><span>
</span><span id="line-346"></span><span>                  </span><span class="hs-comment">-- See Note [Rewrite rules and inlining] in GHC.Core.Opt.Simplify.Iteration</span><span>
</span><span id="line-347"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="TryRules"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#TryRules"><span class="hs-identifier hs-var">TryRules</span></a></span></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#FullArgCount"><span class="hs-identifier hs-type">FullArgCount</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-348"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="TryInlining"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#TryInlining"><span class="hs-identifier hs-var">TryInlining</span></a></span></span><span>
</span><span id="line-349"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="TryNothing"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#TryNothing"><span class="hs-identifier hs-var">TryNothing</span></a></span></span><span>
</span><span id="line-350"></span><span>
</span><span id="line-351"></span><span class="hs-keyword">data</span><span> </span><span id="ArgSpec"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgSpec"><span class="hs-identifier hs-var">ArgSpec</span></a></span></span><span>
</span><span id="line-352"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="ValArg"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ValArg"><span class="hs-identifier hs-var">ValArg</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="as_dmd"><span class="annot"><span class="annottext">ArgSpec -&gt; Demand
</span><a href="GHC.Core.Opt.Simplify.Utils.html#as_dmd"><span class="hs-identifier hs-var hs-var">as_dmd</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span>        </span><span class="hs-comment">-- Demand placed on this argument</span><span>
</span><span id="line-353"></span><span>           </span><span class="hs-special">,</span><span> </span><span id="as_arg"><span class="annot"><span class="annottext">ArgSpec -&gt; OutExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#as_arg"><span class="hs-identifier hs-var hs-var">as_arg</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>       </span><span class="hs-comment">-- Apply to this (coercion or value); c.f. ApplyToVal</span><span>
</span><span id="line-354"></span><span>           </span><span class="hs-special">,</span><span> </span><span id="as_hole_ty"><span class="annot"><span class="annottext">ArgSpec -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#as_hole_ty"><span class="hs-identifier hs-var hs-var">as_hole_ty</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#OutType"><span class="hs-identifier hs-type">OutType</span></a></span><span> </span><span class="hs-special">}</span><span>  </span><span class="hs-comment">-- Type of the function (presumably t1 -&gt; t2)</span><span>
</span><span id="line-355"></span><span>
</span><span id="line-356"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="TyArg"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#TyArg"><span class="hs-identifier hs-var">TyArg</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="as_arg_ty"><span class="annot"><span class="annottext">ArgSpec -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#as_arg_ty"><span class="hs-identifier hs-var hs-var">as_arg_ty</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#OutType"><span class="hs-identifier hs-type">OutType</span></a></span><span>     </span><span class="hs-comment">-- Apply to this type; c.f. ApplyToTy</span><span>
</span><span id="line-357"></span><span>          </span><span class="hs-special">,</span><span> </span><span id="as_hole_ty"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#as_hole_ty"><span class="hs-identifier hs-var">as_hole_ty</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#OutType"><span class="hs-identifier hs-type">OutType</span></a></span><span> </span><span class="hs-special">}</span><span>   </span><span class="hs-comment">-- Type of the function (presumably forall a. blah)</span><span>
</span><span id="line-358"></span><span>
</span><span id="line-359"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="CastBy"><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#CastBy"><span class="hs-identifier hs-var">CastBy</span></a></span></span><span> </span><span class="annot"><a href="GHC.Core.html#OutCoercion"><span class="hs-identifier hs-type">OutCoercion</span></a></span><span>                </span><span class="hs-comment">-- Cast by this; c.f. CastIt</span><span>
</span><span id="line-360"></span><span>                                      </span><span class="hs-comment">-- Coercion is optimised</span><span>
</span><span id="line-361"></span><span>
</span><span id="line-362"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-363"></span><span>  </span><span id="local-6989586621682977240"><span class="annot"><span class="annottext">ppr :: ArgInfo -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ai_fun :: ArgInfo -&gt; Id
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_fun"><span class="hs-identifier hs-var">ai_fun</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977241"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977241"><span class="hs-identifier hs-var">fun</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ai_args :: ArgInfo -&gt; [ArgSpec]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_args"><span class="hs-identifier hs-var">ai_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977242"><span class="annot"><span class="annottext">[ArgSpec]
</span><a href="#local-6989586621682977242"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ai_dmds :: ArgInfo -&gt; [Demand]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_dmds"><span class="hs-identifier hs-var">ai_dmds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977243"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682977243"><span class="hs-identifier hs-var">dmds</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-364"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ArgInfo&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#braces"><span class="hs-identifier hs-var">braces</span></a></span><span>
</span><span id="line-365"></span><span>         </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;fun =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977241"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-366"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;dmds(first 10) =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BranchCount -&gt; [Demand] -&gt; [Demand]
forall a. BranchCount -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><span class="hs-number">10</span></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682977243"><span class="hs-identifier hs-var">dmds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-367"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;args =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgSpec] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgSpec]
</span><a href="#local-6989586621682977242"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-368"></span><span>
</span><span id="line-369"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgSpec"><span class="hs-identifier hs-type">ArgSpec</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-370"></span><span>  </span><span id="local-6989586621682977257"><span class="annot"><span class="annottext">ppr :: ArgSpec -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ValArg"><span class="hs-identifier hs-type">ValArg</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">as_arg :: ArgSpec -&gt; OutExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#as_arg"><span class="hs-identifier hs-var">as_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977258"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977258"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ValArg&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977258"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-371"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#TyArg"><span class="hs-identifier hs-type">TyArg</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">as_arg_ty :: ArgSpec -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#as_arg_ty"><span class="hs-identifier hs-var">as_arg_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977259"><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977259"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;TyArg&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">OutType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977259"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-372"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#CastBy"><span class="hs-identifier hs-type">CastBy</span></a></span><span> </span><span id="local-6989586621682977260"><span class="annot"><span class="annottext">OutCoercion
</span><a href="#local-6989586621682977260"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">)</span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;CastBy&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">OutCoercion -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">OutCoercion
</span><a href="#local-6989586621682977260"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-373"></span><span>
</span><span id="line-374"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#addValArgTo"><span class="hs-identifier hs-type">addValArgTo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutType"><span class="hs-identifier hs-type">OutType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span>
</span><span id="line-375"></span><span id="addValArgTo"><span class="annot"><span class="annottext">addValArgTo :: ArgInfo -&gt; OutExpr -&gt; OutType -&gt; ArgInfo
</span><a href="GHC.Core.Opt.Simplify.Utils.html#addValArgTo"><span class="hs-identifier hs-var hs-var">addValArgTo</span></a></span></span><span> </span><span id="local-6989586621682977261"><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682977261"><span class="hs-identifier hs-var">ai</span></a></span></span><span> </span><span id="local-6989586621682977262"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977262"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span id="local-6989586621682977263"><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977263"><span class="hs-identifier hs-var">hole_ty</span></a></span></span><span>
</span><span id="line-376"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ai_dmds :: ArgInfo -&gt; [Demand]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_dmds"><span class="hs-identifier hs-var">ai_dmds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977264"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682977264"><span class="hs-identifier hs-var">dmd</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682977265"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682977265"><span class="hs-identifier hs-var">dmds</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ai_discs :: ArgInfo -&gt; [BranchCount]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_discs"><span class="hs-identifier hs-var">ai_discs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><span class="hs-identifier">_</span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682977266"><span class="annot"><span class="annottext">[BranchCount]
</span><a href="#local-6989586621682977266"><span class="hs-identifier hs-var">discs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ai_rewrite :: ArgInfo -&gt; RewriteCall
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_rewrite"><span class="hs-identifier hs-var">ai_rewrite</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977267"><span class="annot"><span class="annottext">RewriteCall
</span><a href="#local-6989586621682977267"><span class="hs-identifier hs-var">rew</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682977261"><span class="hs-identifier hs-var">ai</span></a></span><span>
</span><span id="line-377"></span><span>      </span><span class="hs-comment">-- Pop the top demand and and discounts off</span><span>
</span><span id="line-378"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682977268"><span class="annot"><span class="annottext">arg_spec :: ArgSpec
</span><a href="#local-6989586621682977268"><span class="hs-identifier hs-var hs-var">arg_spec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ValArg"><span class="hs-identifier hs-type">ValArg</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">as_arg :: OutExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#as_arg"><span class="hs-identifier hs-var">as_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977262"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">as_hole_ty :: OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#as_hole_ty"><span class="hs-identifier hs-var">as_hole_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977263"><span class="hs-identifier hs-var">hole_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">as_dmd :: Demand
</span><a href="GHC.Core.Opt.Simplify.Utils.html#as_dmd"><span class="hs-identifier hs-var">as_dmd</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682977264"><span class="hs-identifier hs-var">dmd</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-379"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682977261"><span class="hs-identifier hs-var">ai</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ai_args"><span class="hs-identifier hs-var">ai_args</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682977268"><span class="hs-identifier hs-type">arg_spec</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ai_args"><span class="hs-identifier hs-var">ai_args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977261"><span class="hs-identifier hs-type">ai</span></a></span><span>
</span><span id="line-380"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ai_dmds"><span class="hs-identifier hs-var">ai_dmds</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682977265"><span class="hs-identifier hs-type">dmds</span></a></span><span>
</span><span id="line-381"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ai_discs"><span class="hs-identifier hs-var">ai_discs</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682977266"><span class="hs-identifier hs-type">discs</span></a></span><span>
</span><span id="line-382"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ai_rewrite"><span class="hs-identifier hs-var">ai_rewrite</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#decArgCount"><span class="hs-identifier hs-type">decArgCount</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977267"><span class="hs-identifier hs-type">rew</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-383"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-384"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; ArgInfo
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;addValArgTo&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArgInfo -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682977261"><span class="hs-identifier hs-var">ai</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977262"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-385"></span><span>    </span><span class="hs-comment">-- There should always be enough demands and discounts</span><span>
</span><span id="line-386"></span><span>
</span><span id="line-387"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#addTyArgTo"><span class="hs-identifier hs-type">addTyArgTo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutType"><span class="hs-identifier hs-type">OutType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutType"><span class="hs-identifier hs-type">OutType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span>
</span><span id="line-388"></span><span id="addTyArgTo"><span class="annot"><span class="annottext">addTyArgTo :: ArgInfo -&gt; OutType -&gt; OutType -&gt; ArgInfo
</span><a href="GHC.Core.Opt.Simplify.Utils.html#addTyArgTo"><span class="hs-identifier hs-var hs-var">addTyArgTo</span></a></span></span><span> </span><span id="local-6989586621682977271"><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682977271"><span class="hs-identifier hs-var">ai</span></a></span></span><span> </span><span id="local-6989586621682977272"><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977272"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span> </span><span id="local-6989586621682977273"><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977273"><span class="hs-identifier hs-var">hole_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682977271"><span class="hs-identifier hs-var">ai</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ai_args"><span class="hs-identifier hs-var">ai_args</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682977274"><span class="hs-identifier hs-type">arg_spec</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ai_args"><span class="hs-identifier hs-var">ai_args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977271"><span class="hs-identifier hs-type">ai</span></a></span><span>
</span><span id="line-389"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ai_rewrite"><span class="hs-identifier hs-var">ai_rewrite</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#decArgCount"><span class="hs-identifier hs-type">decArgCount</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ai_rewrite"><span class="hs-identifier hs-var">ai_rewrite</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977271"><span class="hs-identifier hs-type">ai</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-390"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-391"></span><span>    </span><span id="local-6989586621682977274"><span class="annot"><span class="annottext">arg_spec :: ArgSpec
</span><a href="#local-6989586621682977274"><span class="hs-identifier hs-var hs-var">arg_spec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#TyArg"><span class="hs-identifier hs-type">TyArg</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">as_arg_ty :: OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#as_arg_ty"><span class="hs-identifier hs-var">as_arg_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977272"><span class="hs-identifier hs-var">arg_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">as_hole_ty :: OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#as_hole_ty"><span class="hs-identifier hs-var">as_hole_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977273"><span class="hs-identifier hs-var">hole_ty</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-392"></span><span>
</span><span id="line-393"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#addCastTo"><span class="hs-identifier hs-type">addCastTo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutCoercion"><span class="hs-identifier hs-type">OutCoercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span>
</span><span id="line-394"></span><span id="addCastTo"><span class="annot"><span class="annottext">addCastTo :: ArgInfo -&gt; OutCoercion -&gt; ArgInfo
</span><a href="GHC.Core.Opt.Simplify.Utils.html#addCastTo"><span class="hs-identifier hs-var hs-var">addCastTo</span></a></span></span><span> </span><span id="local-6989586621682977275"><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682977275"><span class="hs-identifier hs-var">ai</span></a></span></span><span> </span><span id="local-6989586621682977276"><span class="annot"><span class="annottext">OutCoercion
</span><a href="#local-6989586621682977276"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682977275"><span class="hs-identifier hs-var">ai</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ai_args"><span class="hs-identifier hs-var">ai_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#CastBy"><span class="hs-identifier hs-type">CastBy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977276"><span class="hs-identifier hs-type">co</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ai_args"><span class="hs-identifier hs-var">ai_args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977275"><span class="hs-identifier hs-type">ai</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-395"></span><span>
</span><span id="line-396"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#isStrictArgInfo"><span class="hs-identifier hs-type">isStrictArgInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-397"></span><span class="hs-comment">-- True if the function is strict in the next argument</span><span>
</span><span id="line-398"></span><span id="isStrictArgInfo"><span class="annot"><span class="annottext">isStrictArgInfo :: ArgInfo -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#isStrictArgInfo"><span class="hs-identifier hs-var hs-var">isStrictArgInfo</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ai_dmds :: ArgInfo -&gt; [Demand]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_dmds"><span class="hs-identifier hs-var">ai_dmds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977277"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682977277"><span class="hs-identifier hs-var">dmds</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-399"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621682977278"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682977278"><span class="hs-identifier hs-var">dmd</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[Demand]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682977277"><span class="hs-identifier hs-var">dmds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Demand -&gt; Bool
</span><a href="GHC.Types.Demand.html#isStrUsedDmd"><span class="hs-identifier hs-var">isStrUsedDmd</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682977278"><span class="hs-identifier hs-var">dmd</span></a></span><span>
</span><span id="line-400"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-401"></span><span>
</span><span id="line-402"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#argInfoAppArgs"><span class="hs-identifier hs-type">argInfoAppArgs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgSpec"><span class="hs-identifier hs-type">ArgSpec</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-403"></span><span id="argInfoAppArgs"><span class="annot"><span class="annottext">argInfoAppArgs :: [ArgSpec] -&gt; [OutExpr]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#argInfoAppArgs"><span class="hs-identifier hs-var hs-var">argInfoAppArgs</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>                              </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-404"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#argInfoAppArgs"><span class="hs-identifier hs-var">argInfoAppArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#CastBy"><span class="hs-identifier hs-type">CastBy</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>                </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[ArgSpec]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Stop at a cast</span><span>
</span><span id="line-405"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#argInfoAppArgs"><span class="hs-identifier hs-var">argInfoAppArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ValArg"><span class="hs-identifier hs-type">ValArg</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">as_arg :: ArgSpec -&gt; OutExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#as_arg"><span class="hs-identifier hs-var">as_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977280"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977280"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-special">}</span><span>  </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682977281"><span class="annot"><span class="annottext">[ArgSpec]
</span><a href="#local-6989586621682977281"><span class="hs-keyword hs-var">as</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977280"><span class="hs-identifier hs-var">arg</span></a></span><span>     </span><span class="annot"><span class="annottext">OutExpr -&gt; [OutExpr] -&gt; [OutExpr]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ArgSpec] -&gt; [OutExpr]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#argInfoAppArgs"><span class="hs-identifier hs-var">argInfoAppArgs</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgSpec]
</span><a href="#local-6989586621682977281"><span class="hs-keyword hs-var">as</span></a></span><span>
</span><span id="line-406"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#argInfoAppArgs"><span class="hs-identifier hs-var">argInfoAppArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#TyArg"><span class="hs-identifier hs-type">TyArg</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">as_arg_ty :: ArgSpec -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#as_arg_ty"><span class="hs-identifier hs-var">as_arg_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977282"><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977282"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682977283"><span class="annot"><span class="annottext">[ArgSpec]
</span><a href="#local-6989586621682977283"><span class="hs-keyword hs-var">as</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutType -&gt; OutExpr
forall b. OutType -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977282"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; [OutExpr] -&gt; [OutExpr]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ArgSpec] -&gt; [OutExpr]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#argInfoAppArgs"><span class="hs-identifier hs-var">argInfoAppArgs</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgSpec]
</span><a href="#local-6989586621682977283"><span class="hs-keyword hs-var">as</span></a></span><span>
</span><span id="line-407"></span><span>
</span><span id="line-408"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#pushSimplifiedArgs"><span class="hs-identifier hs-type">pushSimplifiedArgs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#pushSimplifiedRevArgs"><span class="hs-identifier hs-type">pushSimplifiedRevArgs</span></a></span><span>
</span><span id="line-409"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span>
</span><span id="line-410"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgSpec"><span class="hs-identifier hs-type">ArgSpec</span></a></span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- In normal, forward order for pushSimplifiedArgs,</span><span>
</span><span id="line-411"></span><span>                 </span><span class="hs-comment">-- in /reverse/ order for pushSimplifiedRevArgs</span><span>
</span><span id="line-412"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-413"></span><span id="pushSimplifiedArgs"><span class="annot"><span class="annottext">pushSimplifiedArgs :: StaticEnv -&gt; [ArgSpec] -&gt; SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#pushSimplifiedArgs"><span class="hs-identifier hs-var hs-var">pushSimplifiedArgs</span></a></span></span><span>    </span><span id="local-6989586621682977285"><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977285"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682977286"><span class="annot"><span class="annottext">[ArgSpec]
</span><a href="#local-6989586621682977286"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621682977287"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977287"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ArgSpec -&gt; SimplCont -&gt; SimplCont)
-&gt; SimplCont -&gt; [ArgSpec] -&gt; SimplCont
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StaticEnv -&gt; ArgSpec -&gt; SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#pushSimplifiedArg"><span class="hs-identifier hs-var">pushSimplifiedArg</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977285"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>             </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977287"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgSpec]
</span><a href="#local-6989586621682977286"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-414"></span><span id="pushSimplifiedRevArgs"><span class="annot"><span class="annottext">pushSimplifiedRevArgs :: StaticEnv -&gt; [ArgSpec] -&gt; SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#pushSimplifiedRevArgs"><span class="hs-identifier hs-var hs-var">pushSimplifiedRevArgs</span></a></span></span><span> </span><span id="local-6989586621682977290"><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977290"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682977291"><span class="annot"><span class="annottext">[ArgSpec]
</span><a href="#local-6989586621682977291"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621682977292"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977292"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SimplCont -&gt; ArgSpec -&gt; SimplCont)
-&gt; SimplCont -&gt; [ArgSpec] -&gt; SimplCont
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682977294"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977294"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621682977295"><span class="annot"><span class="annottext">ArgSpec
</span><a href="#local-6989586621682977295"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StaticEnv -&gt; ArgSpec -&gt; SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#pushSimplifiedArg"><span class="hs-identifier hs-var">pushSimplifiedArg</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977290"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">ArgSpec
</span><a href="#local-6989586621682977295"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977294"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977292"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgSpec]
</span><a href="#local-6989586621682977291"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-415"></span><span>
</span><span id="line-416"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#pushSimplifiedArg"><span class="hs-identifier hs-type">pushSimplifiedArg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgSpec"><span class="hs-identifier hs-type">ArgSpec</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-417"></span><span id="pushSimplifiedArg"><span class="annot"><span class="annottext">pushSimplifiedArg :: StaticEnv -&gt; ArgSpec -&gt; SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#pushSimplifiedArg"><span class="hs-identifier hs-var hs-var">pushSimplifiedArg</span></a></span></span><span> </span><span id="local-6989586621682977296"><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977296"><span class="hs-identifier hs-var">_env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#TyArg"><span class="hs-identifier hs-type">TyArg</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">as_arg_ty :: ArgSpec -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#as_arg_ty"><span class="hs-identifier hs-var">as_arg_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977297"><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977297"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">as_hole_ty :: ArgSpec -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#as_hole_ty"><span class="hs-identifier hs-var">as_hole_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977298"><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977298"><span class="hs-identifier hs-var">hole_ty</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621682977299"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977299"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-418"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToTy"><span class="hs-identifier hs-type">ApplyToTy</span></a></span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_arg_ty :: OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_arg_ty"><span class="hs-identifier hs-var">sc_arg_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977297"><span class="hs-identifier hs-var">arg_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_hole_ty :: OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_hole_ty"><span class="hs-identifier hs-var">sc_hole_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977298"><span class="hs-identifier hs-var">hole_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977299"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-419"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#pushSimplifiedArg"><span class="hs-identifier hs-var">pushSimplifiedArg</span></a></span><span> </span><span id="local-6989586621682977300"><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977300"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ValArg"><span class="hs-identifier hs-type">ValArg</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">as_arg :: ArgSpec -&gt; OutExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#as_arg"><span class="hs-identifier hs-var">as_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977301"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977301"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">as_hole_ty :: ArgSpec -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#as_hole_ty"><span class="hs-identifier hs-var">as_hole_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977302"><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977302"><span class="hs-identifier hs-var">hole_ty</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621682977303"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977303"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-420"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToVal"><span class="hs-identifier hs-type">ApplyToVal</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_arg :: OutExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_arg"><span class="hs-identifier hs-var">sc_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977301"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_env :: StaticEnv
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_env"><span class="hs-identifier hs-var">sc_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977300"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_dup :: DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_dup"><span class="hs-identifier hs-var">sc_dup</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#Simplified"><span class="hs-identifier hs-var">Simplified</span></a></span><span>
</span><span id="line-421"></span><span>                 </span><span class="hs-comment">-- The SubstEnv will be ignored since sc_dup=Simplified</span><span>
</span><span id="line-422"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_hole_ty :: OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_hole_ty"><span class="hs-identifier hs-var">sc_hole_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977302"><span class="hs-identifier hs-var">hole_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977303"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-423"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#pushSimplifiedArg"><span class="hs-identifier hs-var">pushSimplifiedArg</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#CastBy"><span class="hs-identifier hs-type">CastBy</span></a></span><span> </span><span id="local-6989586621682977304"><span class="annot"><span class="annottext">OutCoercion
</span><a href="#local-6989586621682977304"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682977305"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977305"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-424"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#CastIt"><span class="hs-identifier hs-type">CastIt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_co :: OutCoercion
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_co"><span class="hs-identifier hs-var">sc_co</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutCoercion
</span><a href="#local-6989586621682977304"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977305"><span class="hs-identifier hs-var">cont</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_opt :: Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_opt"><span class="hs-identifier hs-var">sc_opt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-425"></span><span>
</span><span id="line-426"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#argInfoExpr"><span class="hs-identifier hs-type">argInfoExpr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgSpec"><span class="hs-identifier hs-type">ArgSpec</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>
</span><span id="line-427"></span><span class="hs-comment">-- NB: the [ArgSpec] is reversed so that the first arg</span><span>
</span><span id="line-428"></span><span class="hs-comment">-- in the list is the last one in the application</span><span>
</span><span id="line-429"></span><span id="argInfoExpr"><span class="annot"><span class="annottext">argInfoExpr :: Id -&gt; [ArgSpec] -&gt; OutExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#argInfoExpr"><span class="hs-identifier hs-var hs-var">argInfoExpr</span></a></span></span><span> </span><span id="local-6989586621682977306"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977306"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621682977307"><span class="annot"><span class="annottext">[ArgSpec]
</span><a href="#local-6989586621682977307"><span class="hs-identifier hs-var">rev_args</span></a></span></span><span>
</span><span id="line-430"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ArgSpec] -&gt; OutExpr
</span><a href="#local-6989586621682977308"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgSpec]
</span><a href="#local-6989586621682977307"><span class="hs-identifier hs-var">rev_args</span></a></span><span>
</span><span id="line-431"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-432"></span><span>    </span><span id="local-6989586621682977308"><span class="annot"><span class="annottext">go :: [ArgSpec] -&gt; OutExpr
</span><a href="#local-6989586621682977308"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>                              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; OutExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977306"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-433"></span><span>    </span><span class="annot"><a href="#local-6989586621682977308"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ValArg"><span class="hs-identifier hs-type">ValArg</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">as_arg :: ArgSpec -&gt; OutExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#as_arg"><span class="hs-identifier hs-var">as_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977310"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977310"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-special">}</span><span>  </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682977311"><span class="annot"><span class="annottext">[ArgSpec]
</span><a href="#local-6989586621682977311"><span class="hs-keyword hs-var">as</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ArgSpec] -&gt; OutExpr
</span><a href="#local-6989586621682977308"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgSpec]
</span><a href="#local-6989586621682977311"><span class="hs-keyword hs-var">as</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; OutExpr -&gt; OutExpr
forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-operator hs-var">`App`</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977310"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-434"></span><span>    </span><span class="annot"><a href="#local-6989586621682977308"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#TyArg"><span class="hs-identifier hs-type">TyArg</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">as_arg_ty :: ArgSpec -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#as_arg_ty"><span class="hs-identifier hs-var">as_arg_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977313"><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977313"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682977314"><span class="annot"><span class="annottext">[ArgSpec]
</span><a href="#local-6989586621682977314"><span class="hs-keyword hs-var">as</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ArgSpec] -&gt; OutExpr
</span><a href="#local-6989586621682977308"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgSpec]
</span><a href="#local-6989586621682977314"><span class="hs-keyword hs-var">as</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; OutExpr -&gt; OutExpr
forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-operator hs-var">`App`</span></a></span><span> </span><span class="annot"><span class="annottext">OutType -&gt; OutExpr
forall b. OutType -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977313"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-435"></span><span>    </span><span class="annot"><a href="#local-6989586621682977308"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#CastBy"><span class="hs-identifier hs-type">CastBy</span></a></span><span> </span><span id="local-6989586621682977315"><span class="annot"><span class="annottext">OutCoercion
</span><a href="#local-6989586621682977315"><span class="hs-identifier hs-var">co</span></a></span></span><span>                </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682977316"><span class="annot"><span class="annottext">[ArgSpec]
</span><a href="#local-6989586621682977316"><span class="hs-keyword hs-var">as</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; OutExpr -&gt; OutCoercion -&gt; OutExpr
OutExpr -&gt; OutCoercion -&gt; OutExpr
</span><a href="GHC.Core.Utils.html#mkCast"><span class="hs-identifier hs-var">mkCast</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ArgSpec] -&gt; OutExpr
</span><a href="#local-6989586621682977308"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgSpec]
</span><a href="#local-6989586621682977316"><span class="hs-keyword hs-var">as</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OutCoercion
</span><a href="#local-6989586621682977315"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-436"></span><span>
</span><span id="line-437"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#decArgCount"><span class="hs-identifier hs-type">decArgCount</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#RewriteCall"><span class="hs-identifier hs-type">RewriteCall</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#RewriteCall"><span class="hs-identifier hs-type">RewriteCall</span></a></span><span>
</span><span id="line-438"></span><span id="decArgCount"><span class="annot"><span class="annottext">decArgCount :: RewriteCall -&gt; RewriteCall
</span><a href="GHC.Core.Opt.Simplify.Utils.html#decArgCount"><span class="hs-identifier hs-var hs-var">decArgCount</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#TryRules"><span class="hs-identifier hs-type">TryRules</span></a></span><span> </span><span id="local-6989586621682977318"><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977318"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621682977319"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682977319"><span class="hs-identifier hs-var">rules</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BranchCount -&gt; [CoreRule] -&gt; RewriteCall
</span><a href="GHC.Core.Opt.Simplify.Utils.html#TryRules"><span class="hs-identifier hs-var">TryRules</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977318"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">BranchCount -&gt; BranchCount -&gt; BranchCount
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">BranchCount
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682977319"><span class="hs-identifier hs-var">rules</span></a></span><span>
</span><span id="line-439"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#decArgCount"><span class="hs-identifier hs-var">decArgCount</span></a></span><span> </span><span id="local-6989586621682977320"><span class="annot"><span class="annottext">RewriteCall
</span><a href="#local-6989586621682977320"><span class="hs-identifier hs-var">rew</span></a></span></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RewriteCall
</span><a href="#local-6989586621682977320"><span class="hs-identifier hs-var">rew</span></a></span><span>
</span><span id="line-440"></span><span>
</span><span id="line-441"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#mkRewriteCall"><span class="hs-identifier hs-type">mkRewriteCall</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleEnv"><span class="hs-identifier hs-type">RuleEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#RewriteCall"><span class="hs-identifier hs-type">RewriteCall</span></a></span><span>
</span><span id="line-442"></span><span class="hs-comment">-- See Note [Rewrite rules and inlining] in GHC.Core.Opt.Simplify.Iteration</span><span>
</span><span id="line-443"></span><span class="hs-comment">-- We try to skip any unnecessary stages:</span><span>
</span><span id="line-444"></span><span class="hs-comment">--    No rules     =&gt; skip TryRules</span><span>
</span><span id="line-445"></span><span class="hs-comment">--    No unfolding =&gt; skip TryInlining</span><span>
</span><span id="line-446"></span><span class="hs-comment">-- This skipping is &quot;just&quot; for efficiency.  But rebuildCall is</span><span>
</span><span id="line-447"></span><span class="hs-comment">-- quite a heavy hammer, so skipping stages is a good plan.</span><span>
</span><span id="line-448"></span><span class="hs-comment">-- And it's extremely simple to do.</span><span>
</span><span id="line-449"></span><span id="mkRewriteCall"><span class="annot"><span class="annottext">mkRewriteCall :: Id -&gt; RuleEnv -&gt; RewriteCall
</span><a href="GHC.Core.Opt.Simplify.Utils.html#mkRewriteCall"><span class="hs-identifier hs-var hs-var">mkRewriteCall</span></a></span></span><span> </span><span id="local-6989586621682977322"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977322"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621682977323"><span class="annot"><span class="annottext">RuleEnv
</span><a href="#local-6989586621682977323"><span class="hs-identifier hs-var">rule_env</span></a></span></span><span>
</span><span id="line-450"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreRule] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682977326"><span class="hs-identifier hs-var">rules</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BranchCount -&gt; [CoreRule] -&gt; RewriteCall
</span><a href="GHC.Core.Opt.Simplify.Utils.html#TryRules"><span class="hs-identifier hs-var">TryRules</span></a></span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977327"><span class="hs-identifier hs-var">n_required</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682977326"><span class="hs-identifier hs-var">rules</span></a></span><span>
</span><span id="line-451"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; Bool
</span><a href="GHC.Core.html#canUnfold"><span class="hs-identifier hs-var">canUnfold</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682977329"><span class="hs-identifier hs-var">unf</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RewriteCall
</span><a href="GHC.Core.Opt.Simplify.Utils.html#TryInlining"><span class="hs-identifier hs-var">TryInlining</span></a></span><span>
</span><span id="line-452"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RewriteCall
</span><a href="GHC.Core.Opt.Simplify.Utils.html#TryNothing"><span class="hs-identifier hs-var">TryNothing</span></a></span><span>
</span><span id="line-453"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-454"></span><span>    </span><span id="local-6989586621682977327"><span class="annot"><span class="annottext">n_required :: BranchCount
</span><a href="#local-6989586621682977327"><span class="hs-identifier hs-var hs-var">n_required</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[BranchCount] -&gt; BranchCount
forall a. Ord a =&gt; [a] -&gt; a
forall (t :: * -&gt; *) a. (Foldable t, Ord a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">maximum</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CoreRule -&gt; BranchCount) -&gt; [CoreRule] -&gt; [BranchCount]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">CoreRule -&gt; BranchCount
</span><a href="GHC.Core.html#ruleArity"><span class="hs-identifier hs-var">ruleArity</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682977326"><span class="hs-identifier hs-var">rules</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-455"></span><span>    </span><span id="local-6989586621682977326"><span class="annot"><span class="annottext">rules :: [CoreRule]
</span><a href="#local-6989586621682977326"><span class="hs-identifier hs-var hs-var">rules</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleEnv -&gt; Id -&gt; [CoreRule]
</span><a href="GHC.Core.Rules.html#getRules"><span class="hs-identifier hs-var">getRules</span></a></span><span> </span><span class="annot"><span class="annottext">RuleEnv
</span><a href="#local-6989586621682977323"><span class="hs-identifier hs-var">rule_env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977322"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-456"></span><span>    </span><span id="local-6989586621682977329"><span class="annot"><span class="annottext">unf :: Unfolding
</span><a href="#local-6989586621682977329"><span class="hs-identifier hs-var hs-var">unf</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdUnfoldingFun
</span><a href="GHC.Types.Id.html#idUnfolding"><span class="hs-identifier hs-var">idUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977322"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-457"></span><span>
</span><span id="line-458"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Functions on SimplCont
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-465"></span><span>
</span><span id="line-466"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#mkBoringStop"><span class="hs-identifier hs-type">mkBoringStop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#OutType"><span class="hs-identifier hs-type">OutType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-467"></span><span id="mkBoringStop"><span class="annot"><span class="annottext">mkBoringStop :: OutType -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#mkBoringStop"><span class="hs-identifier hs-var hs-var">mkBoringStop</span></a></span></span><span> </span><span id="local-6989586621682977333"><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977333"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutType -&gt; CallCtxt -&gt; SubDemand -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977333"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">CallCtxt
</span><a href="GHC.Core.Unfold.html#BoringCtxt"><span class="hs-identifier hs-var">BoringCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="GHC.Types.Demand.html#topSubDmd"><span class="hs-identifier hs-var">topSubDmd</span></a></span><span>
</span><span id="line-468"></span><span>
</span><span id="line-469"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#mkRhsStop"><span class="hs-identifier hs-type">mkRhsStop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#OutType"><span class="hs-identifier hs-type">OutType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#RecFlag"><span class="hs-identifier hs-type">RecFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-470"></span><span class="hs-comment">-- See Note [RHS of lets] in GHC.Core.Unfold</span><span>
</span><span id="line-471"></span><span id="mkRhsStop"><span class="annot"><span class="annottext">mkRhsStop :: OutType -&gt; RecFlag -&gt; Demand -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#mkRhsStop"><span class="hs-identifier hs-var hs-var">mkRhsStop</span></a></span></span><span> </span><span id="local-6989586621682977335"><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977335"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621682977336"><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621682977336"><span class="hs-identifier hs-var">is_rec</span></a></span></span><span> </span><span id="local-6989586621682977337"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682977337"><span class="hs-identifier hs-var">bndr_dmd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutType -&gt; CallCtxt -&gt; SubDemand -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977335"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RecFlag -&gt; CallCtxt
</span><a href="GHC.Core.Unfold.html#RhsCtxt"><span class="hs-identifier hs-var">RhsCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621682977336"><span class="hs-identifier hs-var">is_rec</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Demand -&gt; SubDemand
</span><a href="GHC.Types.Demand.html#subDemandIfEvaluated"><span class="hs-identifier hs-var">subDemandIfEvaluated</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682977337"><span class="hs-identifier hs-var">bndr_dmd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-472"></span><span>
</span><span id="line-473"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#mkLazyArgStop"><span class="hs-identifier hs-type">mkLazyArgStop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#OutType"><span class="hs-identifier hs-type">OutType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-474"></span><span id="mkLazyArgStop"><span class="annot"><span class="annottext">mkLazyArgStop :: OutType -&gt; ArgInfo -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#mkLazyArgStop"><span class="hs-identifier hs-var hs-var">mkLazyArgStop</span></a></span></span><span> </span><span id="local-6989586621682977340"><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977340"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621682977341"><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682977341"><span class="hs-identifier hs-var">fun_info</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutType -&gt; CallCtxt -&gt; SubDemand -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977340"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArgInfo -&gt; CallCtxt
</span><a href="GHC.Core.Opt.Simplify.Utils.html#lazyArgContext"><span class="hs-identifier hs-var">lazyArgContext</span></a></span><span> </span><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682977341"><span class="hs-identifier hs-var">fun_info</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621682977342"><span class="hs-identifier hs-var">arg_sd</span></a></span><span>
</span><span id="line-475"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-476"></span><span>    </span><span id="local-6989586621682977342"><span class="annot"><span class="annottext">arg_sd :: SubDemand
</span><a href="#local-6989586621682977342"><span class="hs-identifier hs-var hs-var">arg_sd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Demand -&gt; SubDemand
</span><a href="GHC.Types.Demand.html#subDemandIfEvaluated"><span class="hs-identifier hs-var">subDemandIfEvaluated</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Demand] -&gt; Demand
forall a. HasCallStack =&gt; [a] -&gt; a
</span><a href="GHC.Prelude.Basic.html#head"><span class="hs-identifier hs-var">Partial.head</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArgInfo -&gt; [Demand]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_dmds"><span class="hs-identifier hs-var">ai_dmds</span></a></span><span> </span><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682977341"><span class="hs-identifier hs-var">fun_info</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-477"></span><span>
</span><span id="line-478"></span><span class="hs-comment">-------------------</span><span>
</span><span id="line-479"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contIsRhs"><span class="hs-identifier hs-type">contIsRhs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#RecFlag"><span class="hs-identifier hs-type">RecFlag</span></a></span><span>
</span><span id="line-480"></span><span id="contIsRhs"><span class="annot"><span class="annottext">contIsRhs :: SimplCont -&gt; Maybe RecFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contIsRhs"><span class="hs-identifier hs-var hs-var">contIsRhs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#Stop"><span class="hs-identifier hs-type">Stop</span></a></span><span> </span><span class="annot"><span class="annottext">OutType
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Unfold.html#RhsCtxt"><span class="hs-identifier hs-type">RhsCtxt</span></a></span><span> </span><span id="local-6989586621682977343"><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621682977343"><span class="hs-identifier hs-var">is_rec</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RecFlag -&gt; Maybe RecFlag
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621682977343"><span class="hs-identifier hs-var">is_rec</span></a></span><span>
</span><span id="line-481"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contIsRhs"><span class="hs-identifier hs-var">contIsRhs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#CastIt"><span class="hs-identifier hs-type">CastIt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977344"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977344"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Maybe RecFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contIsRhs"><span class="hs-identifier hs-var">contIsRhs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977344"><span class="hs-identifier hs-var">k</span></a></span><span>   </span><span class="hs-comment">-- For f = e |&gt; co, treat e as Rhs context</span><span>
</span><span id="line-482"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contIsRhs"><span class="hs-identifier hs-var">contIsRhs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><span class="hs-identifier">_</span></span><span>                           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe RecFlag
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-483"></span><span>
</span><span id="line-484"></span><span class="hs-comment">-------------------</span><span>
</span><span id="line-485"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contIsStop"><span class="hs-identifier hs-type">contIsStop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-486"></span><span id="contIsStop"><span class="annot"><span class="annottext">contIsStop :: SimplCont -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contIsStop"><span class="hs-identifier hs-var hs-var">contIsStop</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#Stop"><span class="hs-identifier hs-type">Stop</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-487"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contIsStop"><span class="hs-identifier hs-var">contIsStop</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><span class="hs-identifier">_</span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-488"></span><span>
</span><span id="line-489"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contIsDupable"><span class="hs-identifier hs-type">contIsDupable</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-490"></span><span id="contIsDupable"><span class="annot"><span class="annottext">contIsDupable :: SimplCont -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contIsDupable"><span class="hs-identifier hs-var hs-var">contIsDupable</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#Stop"><span class="hs-identifier hs-type">Stop</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>                         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-491"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contIsDupable"><span class="hs-identifier hs-var">contIsDupable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToTy"><span class="hs-identifier hs-type">ApplyToTy</span></a></span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977345"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977345"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contIsDupable"><span class="hs-identifier hs-var">contIsDupable</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977345"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-492"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contIsDupable"><span class="hs-identifier hs-var">contIsDupable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToVal"><span class="hs-identifier hs-type">ApplyToVal</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_dup :: SimplCont -&gt; DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_dup"><span class="hs-identifier hs-var">sc_dup</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#OkToDup"><span class="hs-identifier hs-var">OkToDup</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-comment">-- See Note [DupFlag invariants]</span><span>
</span><span id="line-493"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contIsDupable"><span class="hs-identifier hs-var">contIsDupable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#Select"><span class="hs-identifier hs-type">Select</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_dup :: SimplCont -&gt; DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_dup"><span class="hs-identifier hs-var">sc_dup</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#OkToDup"><span class="hs-identifier hs-var">OkToDup</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-comment">-- ...ditto...</span><span>
</span><span id="line-494"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contIsDupable"><span class="hs-identifier hs-var">contIsDupable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StrictArg"><span class="hs-identifier hs-type">StrictArg</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_dup :: SimplCont -&gt; DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_dup"><span class="hs-identifier hs-var">sc_dup</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#OkToDup"><span class="hs-identifier hs-var">OkToDup</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-comment">-- ...ditto...</span><span>
</span><span id="line-495"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contIsDupable"><span class="hs-identifier hs-var">contIsDupable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#CastIt"><span class="hs-identifier hs-type">CastIt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977346"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977346"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contIsDupable"><span class="hs-identifier hs-var">contIsDupable</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977346"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-496"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contIsDupable"><span class="hs-identifier hs-var">contIsDupable</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><span class="hs-identifier">_</span></span><span>                                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-497"></span><span>
</span><span id="line-498"></span><span class="hs-comment">-------------------</span><span>
</span><span id="line-499"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contIsTrivial"><span class="hs-identifier hs-type">contIsTrivial</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-500"></span><span id="contIsTrivial"><span class="annot"><span class="annottext">contIsTrivial :: SimplCont -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contIsTrivial"><span class="hs-identifier hs-var hs-var">contIsTrivial</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#Stop"><span class="hs-identifier hs-type">Stop</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>                                         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-501"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contIsTrivial"><span class="hs-identifier hs-var">contIsTrivial</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToTy"><span class="hs-identifier hs-type">ApplyToTy</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977347"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977347"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>                       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contIsTrivial"><span class="hs-identifier hs-var">contIsTrivial</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977347"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-502"></span><span class="hs-comment">-- This one doesn't look right.  A value application is not trivial</span><span>
</span><span id="line-503"></span><span class="hs-comment">-- contIsTrivial (ApplyToVal { sc_arg = Coercion _, sc_cont = k }) = contIsTrivial k</span><span>
</span><span id="line-504"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contIsTrivial"><span class="hs-identifier hs-var">contIsTrivial</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#CastIt"><span class="hs-identifier hs-type">CastIt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977348"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977348"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>                          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contIsTrivial"><span class="hs-identifier hs-var">contIsTrivial</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977348"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-505"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contIsTrivial"><span class="hs-identifier hs-var">contIsTrivial</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><span class="hs-identifier">_</span></span><span>                                                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-506"></span><span>
</span><span id="line-507"></span><span class="hs-comment">-------------------</span><span>
</span><span id="line-508"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contResultType"><span class="hs-identifier hs-type">contResultType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutType"><span class="hs-identifier hs-type">OutType</span></a></span><span>
</span><span id="line-509"></span><span id="contResultType"><span class="annot"><span class="annottext">contResultType :: SimplCont -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contResultType"><span class="hs-identifier hs-var hs-var">contResultType</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#Stop"><span class="hs-identifier hs-type">Stop</span></a></span><span> </span><span id="local-6989586621682977349"><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977349"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="annot"><span class="annottext">CallCtxt
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977349"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-510"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#CastIt"><span class="hs-identifier hs-type">CastIt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977350"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977350"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977350"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-511"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StrictBind"><span class="hs-identifier hs-type">StrictBind</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977351"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977351"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977351"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-512"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StrictArg"><span class="hs-identifier hs-type">StrictArg</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977352"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977352"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977352"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-513"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#Select"><span class="hs-identifier hs-type">Select</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977353"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977353"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977353"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-514"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToTy"><span class="hs-identifier hs-type">ApplyToTy</span></a></span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977354"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977354"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977354"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-515"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToVal"><span class="hs-identifier hs-type">ApplyToVal</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977355"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977355"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977355"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-516"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#TickIt"><span class="hs-identifier hs-type">TickIt</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682977356"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977356"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">)</span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977356"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-517"></span><span>
</span><span id="line-518"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleType"><span class="hs-identifier hs-type">contHoleType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutType"><span class="hs-identifier hs-type">OutType</span></a></span><span>
</span><span id="line-519"></span><span id="contHoleType"><span class="annot"><span class="annottext">contHoleType :: SimplCont -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleType"><span class="hs-identifier hs-var hs-var">contHoleType</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#Stop"><span class="hs-identifier hs-type">Stop</span></a></span><span> </span><span id="local-6989586621682977357"><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977357"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="annot"><span class="annottext">CallCtxt
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>                    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977357"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-520"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleType"><span class="hs-identifier hs-var">contHoleType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#TickIt"><span class="hs-identifier hs-type">TickIt</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682977358"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977358"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">)</span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleType"><span class="hs-identifier hs-var">contHoleType</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977358"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-521"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleType"><span class="hs-identifier hs-var">contHoleType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#CastIt"><span class="hs-identifier hs-type">CastIt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_co :: SimplCont -&gt; OutCoercion
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_co"><span class="hs-identifier hs-var">sc_co</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977359"><span class="annot"><span class="annottext">OutCoercion
</span><a href="#local-6989586621682977359"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; OutCoercion -&gt; OutType
OutCoercion -&gt; OutType
</span><a href="GHC.Core.Coercion.html#coercionLKind"><span class="hs-identifier hs-var">coercionLKind</span></a></span><span> </span><span class="annot"><span class="annottext">OutCoercion
</span><a href="#local-6989586621682977359"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-522"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleType"><span class="hs-identifier hs-var">contHoleType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StrictBind"><span class="hs-identifier hs-type">StrictBind</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_bndr :: SimplCont -&gt; Id
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_bndr"><span class="hs-identifier hs-var">sc_bndr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977361"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977361"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_dup :: SimplCont -&gt; DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_dup"><span class="hs-identifier hs-var">sc_dup</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977362"><span class="annot"><span class="annottext">DupFlag
</span><a href="#local-6989586621682977362"><span class="hs-identifier hs-var">dup</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_env :: SimplCont -&gt; StaticEnv
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_env"><span class="hs-identifier hs-var">sc_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977363"><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977363"><span class="hs-identifier hs-var">se</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-523"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DupFlag -&gt; StaticEnv -&gt; OutType -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#perhapsSubstTy"><span class="hs-identifier hs-var">perhapsSubstTy</span></a></span><span> </span><span class="annot"><span class="annottext">DupFlag
</span><a href="#local-6989586621682977362"><span class="hs-identifier hs-var">dup</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977363"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; OutType
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977361"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-524"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleType"><span class="hs-identifier hs-var">contHoleType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StrictArg"><span class="hs-identifier hs-type">StrictArg</span></a></span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_fun_ty :: SimplCont -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_fun_ty"><span class="hs-identifier hs-var">sc_fun_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977365"><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977365"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; OutType -&gt; OutType
OutType -&gt; OutType
</span><a href="GHC.Core.Type.html#funArgTy"><span class="hs-identifier hs-var">funArgTy</span></a></span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977365"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-525"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleType"><span class="hs-identifier hs-var">contHoleType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToTy"><span class="hs-identifier hs-type">ApplyToTy</span></a></span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_hole_ty :: SimplCont -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_hole_ty"><span class="hs-identifier hs-var">sc_hole_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977367"><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977367"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977367"><span class="hs-identifier hs-var">ty</span></a></span><span>  </span><span class="hs-comment">-- See Note [The hole type in ApplyToTy]</span><span>
</span><span id="line-526"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleType"><span class="hs-identifier hs-var">contHoleType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToVal"><span class="hs-identifier hs-type">ApplyToVal</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_hole_ty :: SimplCont -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_hole_ty"><span class="hs-identifier hs-var">sc_hole_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977368"><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977368"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977368"><span class="hs-identifier hs-var">ty</span></a></span><span>  </span><span class="hs-comment">-- See Note [The hole type in ApplyToTy]</span><span>
</span><span id="line-527"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleType"><span class="hs-identifier hs-var">contHoleType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#Select"><span class="hs-identifier hs-type">Select</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_dup :: SimplCont -&gt; DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_dup"><span class="hs-identifier hs-var">sc_dup</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977369"><span class="annot"><span class="annottext">DupFlag
</span><a href="#local-6989586621682977369"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_bndr :: SimplCont -&gt; Id
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_bndr"><span class="hs-identifier hs-var">sc_bndr</span></a></span><span> </span><span class="hs-glyph">=</span><span>  </span><span id="local-6989586621682977370"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977370"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_env :: SimplCont -&gt; StaticEnv
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_env"><span class="hs-identifier hs-var">sc_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977371"><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977371"><span class="hs-identifier hs-var">se</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-528"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DupFlag -&gt; StaticEnv -&gt; OutType -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#perhapsSubstTy"><span class="hs-identifier hs-var">perhapsSubstTy</span></a></span><span> </span><span class="annot"><span class="annottext">DupFlag
</span><a href="#local-6989586621682977369"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977371"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; OutType
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977370"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-529"></span><span>
</span><span id="line-530"></span><span>
</span><span id="line-531"></span><span class="hs-comment">-- Computes the multiplicity scaling factor at the hole. That is, in (case [] of</span><span>
</span><span id="line-532"></span><span class="hs-comment">-- x ::(p) _ { &#8230; }) (respectively for arguments of functions), the scaling</span><span>
</span><span id="line-533"></span><span class="hs-comment">-- factor is p. And in E[G[]], the scaling factor is the product of the scaling</span><span>
</span><span id="line-534"></span><span class="hs-comment">-- factor of E and that of G.</span><span>
</span><span id="line-535"></span><span class="hs-comment">--</span><span>
</span><span id="line-536"></span><span class="hs-comment">-- The scaling factor at the hole of E[] is used to determine how a binder</span><span>
</span><span id="line-537"></span><span class="hs-comment">-- should be scaled if it commutes with E. This appears, in particular, in the</span><span>
</span><span id="line-538"></span><span class="hs-comment">-- case-of-case transformation.</span><span>
</span><span id="line-539"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleScaling"><span class="hs-identifier hs-type">contHoleScaling</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Mult"><span class="hs-identifier hs-type">Mult</span></a></span><span>
</span><span id="line-540"></span><span id="contHoleScaling"><span class="annot"><span class="annottext">contHoleScaling :: SimplCont -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleScaling"><span class="hs-identifier hs-var hs-var">contHoleScaling</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#Stop"><span class="hs-identifier hs-type">Stop</span></a></span><span> </span><span class="annot"><span class="annottext">OutType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">CallCtxt
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="GHC.Core.Type.html#OneTy"><span class="hs-identifier hs-var">OneTy</span></a></span><span>
</span><span id="line-541"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleScaling"><span class="hs-identifier hs-var">contHoleScaling</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#CastIt"><span class="hs-identifier hs-type">CastIt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977374"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977374"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-542"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleScaling"><span class="hs-identifier hs-var">contHoleScaling</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977374"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-543"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleScaling"><span class="hs-identifier hs-var">contHoleScaling</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StrictBind"><span class="hs-identifier hs-type">StrictBind</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_bndr :: SimplCont -&gt; Id
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_bndr"><span class="hs-identifier hs-var">sc_bndr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977375"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977375"><span class="hs-identifier hs-var">id</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977376"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977376"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-544"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; OutType
</span><a href="GHC.Types.Id.html#idMult"><span class="hs-identifier hs-var">idMult</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977375"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">OutType -&gt; OutType -&gt; OutType
</span><a href="GHC.Core.Multiplicity.html#mkMultMul"><span class="hs-operator hs-var">`mkMultMul`</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleScaling"><span class="hs-identifier hs-var">contHoleScaling</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977376"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-545"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleScaling"><span class="hs-identifier hs-var">contHoleScaling</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#Select"><span class="hs-identifier hs-type">Select</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_bndr :: SimplCont -&gt; Id
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_bndr"><span class="hs-identifier hs-var">sc_bndr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977379"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977379"><span class="hs-identifier hs-var">id</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977380"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977380"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-546"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; OutType
</span><a href="GHC.Types.Id.html#idMult"><span class="hs-identifier hs-var">idMult</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977379"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">OutType -&gt; OutType -&gt; OutType
</span><a href="GHC.Core.Multiplicity.html#mkMultMul"><span class="hs-operator hs-var">`mkMultMul`</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleScaling"><span class="hs-identifier hs-var">contHoleScaling</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977380"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-547"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleScaling"><span class="hs-identifier hs-var">contHoleScaling</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StrictArg"><span class="hs-identifier hs-type">StrictArg</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_fun_ty :: SimplCont -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_fun_ty"><span class="hs-identifier hs-var">sc_fun_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977381"><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977381"><span class="hs-identifier hs-var">fun_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977382"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977382"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-548"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977383"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">OutType -&gt; OutType -&gt; OutType
</span><a href="GHC.Core.Multiplicity.html#mkMultMul"><span class="hs-operator hs-var">`mkMultMul`</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleScaling"><span class="hs-identifier hs-var">contHoleScaling</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977382"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-549"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-550"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682977383"><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977383"><span class="hs-identifier hs-var">w</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OutType
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OutType
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutType -&gt; (OutType, OutType, OutType)
</span><a href="GHC.Core.Type.html#splitFunTy"><span class="hs-identifier hs-var">splitFunTy</span></a></span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977381"><span class="hs-identifier hs-var">fun_ty</span></a></span><span>
</span><span id="line-551"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleScaling"><span class="hs-identifier hs-var">contHoleScaling</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToTy"><span class="hs-identifier hs-type">ApplyToTy</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977385"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977385"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleScaling"><span class="hs-identifier hs-var">contHoleScaling</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977385"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-552"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleScaling"><span class="hs-identifier hs-var">contHoleScaling</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToVal"><span class="hs-identifier hs-type">ApplyToVal</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977386"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977386"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleScaling"><span class="hs-identifier hs-var">contHoleScaling</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977386"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-553"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleScaling"><span class="hs-identifier hs-var">contHoleScaling</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#TickIt"><span class="hs-identifier hs-type">TickIt</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682977387"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977387"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; OutType
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleScaling"><span class="hs-identifier hs-var">contHoleScaling</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977387"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-554"></span><span>
</span><span id="line-555"></span><span class="hs-comment">-------------------</span><span>
</span><span id="line-556"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#countArgs"><span class="hs-identifier hs-type">countArgs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-557"></span><span class="hs-comment">-- Count all arguments, including types, coercions,</span><span>
</span><span id="line-558"></span><span class="hs-comment">-- and other values; skipping over casts.</span><span>
</span><span id="line-559"></span><span id="countArgs"><span class="annot"><span class="annottext">countArgs :: SimplCont -&gt; BranchCount
</span><a href="GHC.Core.Opt.Simplify.Utils.html#countArgs"><span class="hs-identifier hs-var hs-var">countArgs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToTy"><span class="hs-identifier hs-type">ApplyToTy</span></a></span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977388"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977388"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">BranchCount -&gt; BranchCount -&gt; BranchCount
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; BranchCount
</span><a href="GHC.Core.Opt.Simplify.Utils.html#countArgs"><span class="hs-identifier hs-var">countArgs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977388"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-560"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#countArgs"><span class="hs-identifier hs-var">countArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToVal"><span class="hs-identifier hs-type">ApplyToVal</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977390"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977390"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">BranchCount -&gt; BranchCount -&gt; BranchCount
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; BranchCount
</span><a href="GHC.Core.Opt.Simplify.Utils.html#countArgs"><span class="hs-identifier hs-var">countArgs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977390"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-561"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#countArgs"><span class="hs-identifier hs-var">countArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#CastIt"><span class="hs-identifier hs-type">CastIt</span></a></span><span>     </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977391"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977391"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; BranchCount
</span><a href="GHC.Core.Opt.Simplify.Utils.html#countArgs"><span class="hs-identifier hs-var">countArgs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977391"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-562"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#countArgs"><span class="hs-identifier hs-var">countArgs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><span class="hs-identifier">_</span></span><span>                               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><span class="hs-number">0</span></span><span>
</span><span id="line-563"></span><span>
</span><span id="line-564"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#countValArgs"><span class="hs-identifier hs-type">countValArgs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-565"></span><span class="hs-comment">-- Count value arguments only</span><span>
</span><span id="line-566"></span><span id="countValArgs"><span class="annot"><span class="annottext">countValArgs :: SimplCont -&gt; BranchCount
</span><a href="GHC.Core.Opt.Simplify.Utils.html#countValArgs"><span class="hs-identifier hs-var hs-var">countValArgs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToTy"><span class="hs-identifier hs-type">ApplyToTy</span></a></span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977393"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977393"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; BranchCount
</span><a href="GHC.Core.Opt.Simplify.Utils.html#countValArgs"><span class="hs-identifier hs-var">countValArgs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977393"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-567"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#countValArgs"><span class="hs-identifier hs-var">countValArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToVal"><span class="hs-identifier hs-type">ApplyToVal</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977394"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977394"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">BranchCount -&gt; BranchCount -&gt; BranchCount
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; BranchCount
</span><a href="GHC.Core.Opt.Simplify.Utils.html#countValArgs"><span class="hs-identifier hs-var">countValArgs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977394"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-568"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#countValArgs"><span class="hs-identifier hs-var">countValArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#CastIt"><span class="hs-identifier hs-type">CastIt</span></a></span><span>     </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977395"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977395"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; BranchCount
</span><a href="GHC.Core.Opt.Simplify.Utils.html#countValArgs"><span class="hs-identifier hs-var">countValArgs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977395"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-569"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#countValArgs"><span class="hs-identifier hs-var">countValArgs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><span class="hs-identifier">_</span></span><span>                               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><span class="hs-number">0</span></span><span>
</span><span id="line-570"></span><span>
</span><span id="line-571"></span><span class="hs-comment">-------------------</span><span>
</span><span id="line-572"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contArgs"><span class="hs-identifier hs-type">contArgs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Unfold.html#ArgSummary"><span class="hs-identifier hs-type">ArgSummary</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-573"></span><span class="hs-comment">-- Summarises value args, discards type args and coercions</span><span>
</span><span id="line-574"></span><span class="hs-comment">-- The returned continuation of the call is only used to</span><span>
</span><span id="line-575"></span><span class="hs-comment">-- answer questions like &quot;are you interesting?&quot;</span><span>
</span><span id="line-576"></span><span id="contArgs"><span class="annot"><span class="annottext">contArgs :: SimplCont -&gt; (Bool, [ArgSummary], SimplCont)
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contArgs"><span class="hs-identifier hs-var hs-var">contArgs</span></a></span></span><span> </span><span id="local-6989586621682977396"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977396"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-577"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Bool
</span><a href="#local-6989586621682977397"><span class="hs-identifier hs-var">lone</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977396"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977396"><span class="hs-identifier hs-var">cont</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-578"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ArgSummary] -&gt; SimplCont -&gt; (Bool, [ArgSummary], SimplCont)
</span><a href="#local-6989586621682977398"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977396"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-579"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-580"></span><span>    </span><span id="local-6989586621682977397"><span class="annot"><span class="annottext">lone :: SimplCont -&gt; Bool
</span><a href="#local-6989586621682977397"><span class="hs-identifier hs-var hs-var">lone</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToTy"><span class="hs-identifier hs-type">ApplyToTy</span></a></span><span>  </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>  </span><span class="hs-comment">-- See Note [Lone variables] in GHC.Core.Unfold</span><span>
</span><span id="line-581"></span><span>    </span><span class="annot"><a href="#local-6989586621682977397"><span class="hs-identifier hs-var">lone</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToVal"><span class="hs-identifier hs-type">ApplyToVal</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>  </span><span class="hs-comment">-- NB: even a type application or cast</span><span>
</span><span id="line-582"></span><span>    </span><span class="annot"><a href="#local-6989586621682977397"><span class="hs-identifier hs-var">lone</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#CastIt"><span class="hs-identifier hs-type">CastIt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>  </span><span class="hs-comment">--     stops it being &quot;lone&quot;</span><span>
</span><span id="line-583"></span><span>    </span><span class="annot"><a href="#local-6989586621682977397"><span class="hs-identifier hs-var">lone</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><span class="hs-identifier">_</span></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-584"></span><span>
</span><span id="line-585"></span><span>    </span><span id="local-6989586621682977398"><span class="annot"><span class="annottext">go :: [ArgSummary] -&gt; SimplCont -&gt; (Bool, [ArgSummary], SimplCont)
</span><a href="#local-6989586621682977398"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621682977399"><span class="annot"><span class="annottext">[ArgSummary]
</span><a href="#local-6989586621682977399"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToVal"><span class="hs-identifier hs-type">ApplyToVal</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_arg :: SimplCont -&gt; OutExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_arg"><span class="hs-identifier hs-var">sc_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977400"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977400"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_env :: SimplCont -&gt; StaticEnv
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_env"><span class="hs-identifier hs-var">sc_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977401"><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977401"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977402"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977402"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-586"></span><span>                                        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ArgSummary] -&gt; SimplCont -&gt; (Bool, [ArgSummary], SimplCont)
</span><a href="#local-6989586621682977398"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutExpr -&gt; StaticEnv -&gt; ArgSummary
</span><a href="#local-6989586621682977403"><span class="hs-identifier hs-var">is_interesting</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977400"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977401"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="annot"><span class="annottext">ArgSummary -&gt; [ArgSummary] -&gt; [ArgSummary]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ArgSummary]
</span><a href="#local-6989586621682977399"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977402"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-587"></span><span>    </span><span class="annot"><a href="#local-6989586621682977398"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682977404"><span class="annot"><span class="annottext">[ArgSummary]
</span><a href="#local-6989586621682977404"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToTy"><span class="hs-identifier hs-type">ApplyToTy</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977405"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977405"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ArgSummary] -&gt; SimplCont -&gt; (Bool, [ArgSummary], SimplCont)
</span><a href="#local-6989586621682977398"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgSummary]
</span><a href="#local-6989586621682977404"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977405"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-588"></span><span>    </span><span class="annot"><a href="#local-6989586621682977398"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682977406"><span class="annot"><span class="annottext">[ArgSummary]
</span><a href="#local-6989586621682977406"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#CastIt"><span class="hs-identifier hs-type">CastIt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977407"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977407"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ArgSummary] -&gt; SimplCont -&gt; (Bool, [ArgSummary], SimplCont)
</span><a href="#local-6989586621682977398"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgSummary]
</span><a href="#local-6989586621682977406"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977407"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-589"></span><span>    </span><span class="annot"><a href="#local-6989586621682977398"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682977408"><span class="annot"><span class="annottext">[ArgSummary]
</span><a href="#local-6989586621682977408"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621682977409"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977409"><span class="hs-identifier hs-var">k</span></a></span></span><span>                           </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[ArgSummary] -&gt; [ArgSummary]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[ArgSummary]
</span><a href="#local-6989586621682977408"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977409"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-590"></span><span>
</span><span id="line-591"></span><span>    </span><span id="local-6989586621682977403"><span class="annot"><span class="annottext">is_interesting :: OutExpr -&gt; StaticEnv -&gt; ArgSummary
</span><a href="#local-6989586621682977403"><span class="hs-identifier hs-var hs-var">is_interesting</span></a></span></span><span> </span><span id="local-6989586621682977411"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977411"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span id="local-6989586621682977412"><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977412"><span class="hs-identifier hs-var">se</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticEnv -&gt; OutExpr -&gt; ArgSummary
</span><a href="GHC.Core.Opt.Simplify.Utils.html#interestingArg"><span class="hs-identifier hs-var">interestingArg</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977412"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977411"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-592"></span><span>                   </span><span class="hs-comment">-- Do *not* use short-cutting substitution here</span><span>
</span><span id="line-593"></span><span>                   </span><span class="hs-comment">-- because we want to get as much IdInfo as possible</span><span>
</span><span id="line-594"></span><span>
</span><span id="line-595"></span><span class="hs-comment">-- | Describes how the 'SimplCont' will evaluate the hole as a 'SubDemand'.</span><span>
</span><span id="line-596"></span><span class="hs-comment">-- This can be more insightful than the limited syntactic context that</span><span>
</span><span id="line-597"></span><span class="hs-comment">-- 'SimplCont' provides, because the 'Stop' constructor might carry a useful</span><span>
</span><span id="line-598"></span><span class="hs-comment">-- 'SubDemand'.</span><span>
</span><span id="line-599"></span><span class="hs-comment">-- For example, when simplifying the argument `e` in `f e` and `f` has the</span><span>
</span><span id="line-600"></span><span class="hs-comment">-- demand signature `&lt;MP(S,A)&gt;`, this function will give you back `P(S,A)` when</span><span>
</span><span id="line-601"></span><span class="hs-comment">-- simplifying `e`.</span><span>
</span><span id="line-602"></span><span class="hs-comment">--</span><span>
</span><span id="line-603"></span><span class="hs-comment">-- PRECONDITION: Don't call with 'ApplyToVal'. We haven't thoroughly thought</span><span>
</span><span id="line-604"></span><span class="hs-comment">-- about what to do then and no call sites so far seem to care.</span><span>
</span><span id="line-605"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contEvalContext"><span class="hs-identifier hs-type">contEvalContext</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#SubDemand"><span class="hs-identifier hs-type">SubDemand</span></a></span><span>
</span><span id="line-606"></span><span id="contEvalContext"><span class="annot"><span class="annottext">contEvalContext :: SimplCont -&gt; SubDemand
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contEvalContext"><span class="hs-identifier hs-var hs-var">contEvalContext</span></a></span></span><span> </span><span id="local-6989586621682977414"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977414"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977414"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-607"></span><span>  </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#Stop"><span class="hs-identifier hs-type">Stop</span></a></span><span> </span><span class="annot"><span class="annottext">OutType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">CallCtxt
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682977415"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621682977415"><span class="hs-identifier hs-var">sd</span></a></span></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621682977415"><span class="hs-identifier hs-var">sd</span></a></span><span>
</span><span id="line-608"></span><span>  </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#TickIt"><span class="hs-identifier hs-type">TickIt</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682977416"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977416"><span class="hs-identifier hs-var">k</span></a></span></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; SubDemand
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contEvalContext"><span class="hs-identifier hs-var">contEvalContext</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977416"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-609"></span><span>  </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#CastIt"><span class="hs-identifier hs-type">CastIt</span></a></span><span>   </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977417"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977417"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; SubDemand
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contEvalContext"><span class="hs-identifier hs-var">contEvalContext</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977417"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-610"></span><span>  </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToTy"><span class="hs-identifier hs-type">ApplyToTy</span></a></span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977418"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977418"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; SubDemand
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contEvalContext"><span class="hs-identifier hs-var">contEvalContext</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977418"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-611"></span><span>    </span><span class="hs-comment">--  ApplyToVal{sc_cont=k}      -&gt; mkCalledOnceDmd $ contEvalContext k</span><span>
</span><span id="line-612"></span><span>    </span><span class="hs-comment">-- Not 100% sure that's correct, . Here's an example:</span><span>
</span><span id="line-613"></span><span>    </span><span class="hs-comment">--   f (e x) and f :: &lt;SC(S,C(1,L))&gt;</span><span>
</span><span id="line-614"></span><span>    </span><span class="hs-comment">-- then what is the evaluation context of 'e' when we simplify it? E.g.,</span><span>
</span><span id="line-615"></span><span>    </span><span class="hs-comment">--   simpl e (ApplyToVal x $ Stop &quot;C(S,C(1,L))&quot;)</span><span>
</span><span id="line-616"></span><span>    </span><span class="hs-comment">-- then it *should* be &quot;C(1,C(S,C(1,L))&quot;, so perhaps correct after all.</span><span>
</span><span id="line-617"></span><span>    </span><span class="hs-comment">-- But for now we just panic:</span><span>
</span><span id="line-618"></span><span>  </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToVal"><span class="hs-identifier hs-type">ApplyToVal</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; SubDemand
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;contEvalContext&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplCont -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977414"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-619"></span><span>  </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StrictArg"><span class="hs-identifier hs-type">StrictArg</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">sc_fun :: SimplCont -&gt; ArgInfo
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_fun"><span class="hs-identifier hs-var">sc_fun</span></a></span><span class="hs-glyph">=</span><span id="local-6989586621682977419"><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682977419"><span class="hs-identifier hs-var">fun_info</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Demand -&gt; SubDemand
</span><a href="GHC.Types.Demand.html#subDemandIfEvaluated"><span class="hs-identifier hs-var">subDemandIfEvaluated</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Demand] -&gt; Demand
forall a. HasCallStack =&gt; [a] -&gt; a
</span><a href="GHC.Prelude.Basic.html#head"><span class="hs-identifier hs-var">Partial.head</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArgInfo -&gt; [Demand]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_dmds"><span class="hs-identifier hs-var">ai_dmds</span></a></span><span> </span><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682977419"><span class="hs-identifier hs-var">fun_info</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-620"></span><span>  </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StrictBind"><span class="hs-identifier hs-type">StrictBind</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">sc_bndr :: SimplCont -&gt; Id
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_bndr"><span class="hs-identifier hs-var">sc_bndr</span></a></span><span class="hs-glyph">=</span><span id="local-6989586621682977420"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977420"><span class="hs-identifier hs-var">bndr</span></a></span></span><span class="hs-special">}</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Demand -&gt; SubDemand
</span><a href="GHC.Types.Demand.html#subDemandIfEvaluated"><span class="hs-identifier hs-var">subDemandIfEvaluated</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Demand
</span><a href="GHC.Types.Id.html#idDemandInfo"><span class="hs-identifier hs-var">idDemandInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977420"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-621"></span><span>  </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#Select"><span class="hs-identifier hs-type">Select</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="GHC.Types.Demand.html#topSubDmd"><span class="hs-identifier hs-var">topSubDmd</span></a></span><span>
</span><span id="line-622"></span><span>    </span><span class="hs-comment">-- Perhaps reconstruct the demand on the scrutinee by looking at field</span><span>
</span><span id="line-623"></span><span>    </span><span class="hs-comment">-- and case binder dmds, see addCaseBndrDmd. No priority right now.</span><span>
</span><span id="line-624"></span><span>
</span><span id="line-625"></span><span class="hs-comment">-------------------</span><span>
</span><span id="line-626"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#mkArgInfo"><span class="hs-identifier hs-type">mkArgInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleEnv"><span class="hs-identifier hs-type">RuleEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span>
</span><span id="line-627"></span><span>
</span><span id="line-628"></span><span id="mkArgInfo"><span class="annot"><span class="annottext">mkArgInfo :: StaticEnv -&gt; RuleEnv -&gt; Id -&gt; SimplCont -&gt; ArgInfo
</span><a href="GHC.Core.Opt.Simplify.Utils.html#mkArgInfo"><span class="hs-identifier hs-var hs-var">mkArgInfo</span></a></span></span><span> </span><span id="local-6989586621682977422"><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977422"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682977423"><span class="annot"><span class="annottext">RuleEnv
</span><a href="#local-6989586621682977423"><span class="hs-identifier hs-var">rule_base</span></a></span></span><span> </span><span id="local-6989586621682977424"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977424"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621682977425"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977425"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-629"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977426"><span class="hs-identifier hs-var">n_val_args</span></a></span><span> </span><span class="annot"><span class="annottext">BranchCount -&gt; BranchCount -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; BranchCount
</span><a href="GHC.Types.Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977424"><span class="hs-identifier hs-var">fun</span></a></span><span>            </span><span class="hs-comment">-- Note [Unsaturated functions]</span><span>
</span><span id="line-630"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ai_fun :: Id
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_fun"><span class="hs-identifier hs-var">ai_fun</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977424"><span class="hs-identifier hs-var">fun</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ai_args :: [ArgSpec]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_args"><span class="hs-identifier hs-var">ai_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-631"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ai_rewrite :: RewriteCall
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_rewrite"><span class="hs-identifier hs-var">ai_rewrite</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RewriteCall
</span><a href="#local-6989586621682977429"><span class="hs-identifier hs-var">fun_rewrite</span></a></span><span>
</span><span id="line-632"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ai_encl :: Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_encl"><span class="hs-identifier hs-var">ai_encl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-633"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ai_dmds :: [Demand]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_dmds"><span class="hs-identifier hs-var">ai_dmds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682977430"><span class="hs-identifier hs-var">vanilla_dmds</span></a></span><span>
</span><span id="line-634"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ai_discs :: [BranchCount]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_discs"><span class="hs-identifier hs-var">ai_discs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[BranchCount]
</span><a href="#local-6989586621682977431"><span class="hs-identifier hs-var">vanilla_discounts</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-635"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-636"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ai_fun :: Id
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_fun"><span class="hs-identifier hs-var">ai_fun</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977424"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-637"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ai_args :: [ArgSpec]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_args"><span class="hs-identifier hs-var">ai_args</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-638"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ai_rewrite :: RewriteCall
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_rewrite"><span class="hs-identifier hs-var">ai_rewrite</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RewriteCall
</span><a href="#local-6989586621682977429"><span class="hs-identifier hs-var">fun_rewrite</span></a></span><span>
</span><span id="line-639"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ai_encl :: Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_encl"><span class="hs-identifier hs-var">ai_encl</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682977432"><span class="hs-identifier hs-var">fun_has_rules</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contHasRules"><span class="hs-identifier hs-var">contHasRules</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977425"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-640"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ai_dmds :: [Demand]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_dmds"><span class="hs-identifier hs-var">ai_dmds</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutType -&gt; [Demand] -&gt; [Demand]
</span><a href="#local-6989586621682977435"><span class="hs-identifier hs-var">add_type_strictness</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; OutType
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977424"><span class="hs-identifier hs-var">fun</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682977436"><span class="hs-identifier hs-var">arg_dmds</span></a></span><span>
</span><span id="line-641"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ai_discs :: [BranchCount]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_discs"><span class="hs-identifier hs-var">ai_discs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[BranchCount]
</span><a href="#local-6989586621682977437"><span class="hs-identifier hs-var">arg_discounts</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-642"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-643"></span><span>    </span><span id="local-6989586621682977426"><span class="annot"><span class="annottext">n_val_args :: BranchCount
</span><a href="#local-6989586621682977426"><span class="hs-identifier hs-var hs-var">n_val_args</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; BranchCount
</span><a href="GHC.Core.Opt.Simplify.Utils.html#countValArgs"><span class="hs-identifier hs-var">countValArgs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977425"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-644"></span><span>    </span><span id="local-6989586621682977429"><span class="annot"><span class="annottext">fun_rewrite :: RewriteCall
</span><a href="#local-6989586621682977429"><span class="hs-identifier hs-var hs-var">fun_rewrite</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; RuleEnv -&gt; RewriteCall
</span><a href="GHC.Core.Opt.Simplify.Utils.html#mkRewriteCall"><span class="hs-identifier hs-var">mkRewriteCall</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977424"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">RuleEnv
</span><a href="#local-6989586621682977423"><span class="hs-identifier hs-var">rule_base</span></a></span><span>
</span><span id="line-645"></span><span>    </span><span id="local-6989586621682977432"><span class="annot"><span class="annottext">fun_has_rules :: Bool
</span><a href="#local-6989586621682977432"><span class="hs-identifier hs-var hs-var">fun_has_rules</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">RewriteCall
</span><a href="#local-6989586621682977429"><span class="hs-identifier hs-var">fun_rewrite</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-646"></span><span>                      </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#TryRules"><span class="hs-identifier hs-type">TryRules</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-647"></span><span>                      </span><span class="annot"><span class="annottext">RewriteCall
</span><span class="hs-identifier">_</span></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-648"></span><span>
</span><span id="line-649"></span><span>    </span><span class="annot"><a href="#local-6989586621682977431"><span class="hs-identifier hs-type">vanilla_discounts</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682977437"><span class="hs-identifier hs-type">arg_discounts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">]</span><span>
</span><span id="line-650"></span><span>    </span><span id="local-6989586621682977431"><span class="annot"><span class="annottext">vanilla_discounts :: [BranchCount]
</span><a href="#local-6989586621682977431"><span class="hs-identifier hs-var hs-var">vanilla_discounts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BranchCount -&gt; [BranchCount]
forall a. a -&gt; [a]
</span><span class="hs-identifier hs-var">repeat</span></span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><span class="hs-number">0</span></span><span>
</span><span id="line-651"></span><span>    </span><span id="local-6989586621682977437"><span class="annot"><span class="annottext">arg_discounts :: [BranchCount]
</span><a href="#local-6989586621682977437"><span class="hs-identifier hs-var hs-var">arg_discounts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IdUnfoldingFun
</span><a href="GHC.Types.Id.html#idUnfolding"><span class="hs-identifier hs-var">idUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977424"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-652"></span><span>                        </span><span class="annot"><a href="GHC.Core.html#CoreUnfolding"><span class="hs-identifier hs-type">CoreUnfolding</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">uf_guidance :: Unfolding -&gt; UnfoldingGuidance
</span><a href="GHC.Core.html#uf_guidance"><span class="hs-identifier hs-var">uf_guidance</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.html#UnfIfGoodArgs"><span class="hs-identifier hs-type">UnfIfGoodArgs</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">ug_args :: UnfoldingGuidance -&gt; [BranchCount]
</span><a href="GHC.Core.html#ug_args"><span class="hs-identifier hs-var">ug_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977443"><span class="annot"><span class="annottext">[BranchCount]
</span><a href="#local-6989586621682977443"><span class="hs-identifier hs-var">discounts</span></a></span></span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><span id="line-653"></span><span>                              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[BranchCount]
</span><a href="#local-6989586621682977443"><span class="hs-identifier hs-var">discounts</span></a></span><span> </span><span class="annot"><span class="annottext">[BranchCount] -&gt; [BranchCount] -&gt; [BranchCount]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[BranchCount]
</span><a href="#local-6989586621682977431"><span class="hs-identifier hs-var">vanilla_discounts</span></a></span><span>
</span><span id="line-654"></span><span>                        </span><span class="annot"><span class="annottext">Unfolding
</span><span class="hs-identifier">_</span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[BranchCount]
</span><a href="#local-6989586621682977431"><span class="hs-identifier hs-var">vanilla_discounts</span></a></span><span>
</span><span id="line-655"></span><span>
</span><span id="line-656"></span><span>    </span><span class="annot"><a href="#local-6989586621682977430"><span class="hs-identifier hs-type">vanilla_dmds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682977436"><span class="hs-identifier hs-type">arg_dmds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-657"></span><span>    </span><span id="local-6989586621682977430"><span class="annot"><span class="annottext">vanilla_dmds :: [Demand]
</span><a href="#local-6989586621682977430"><span class="hs-identifier hs-var hs-var">vanilla_dmds</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Demand -&gt; [Demand]
forall a. a -&gt; [a]
</span><span class="hs-identifier hs-var">repeat</span></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="GHC.Types.Demand.html#topDmd"><span class="hs-identifier hs-var">topDmd</span></a></span><span>
</span><span id="line-658"></span><span>
</span><span id="line-659"></span><span>    </span><span id="local-6989586621682977436"><span class="annot"><span class="annottext">arg_dmds :: [Demand]
</span><a href="#local-6989586621682977436"><span class="hs-identifier hs-var hs-var">arg_dmds</span></a></span></span><span>
</span><span id="line-660"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StaticEnv -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Env.html#seInline"><span class="hs-identifier hs-var">seInline</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977422"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-661"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682977430"><span class="hs-identifier hs-var">vanilla_dmds</span></a></span><span> </span><span class="hs-comment">-- See Note [Do not expose strictness if sm_inline=False]</span><span>
</span><span id="line-662"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-663"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- add_type_str fun_ty $</span><span>
</span><span id="line-664"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">DmdSig -&gt; ([Demand], Divergence)
</span><a href="GHC.Types.Demand.html#splitDmdSig"><span class="hs-identifier hs-var">splitDmdSig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; DmdSig
</span><a href="GHC.Types.Id.html#idDmdSig"><span class="hs-identifier hs-var">idDmdSig</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977424"><span class="hs-identifier hs-var">fun</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-665"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621682977448"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682977448"><span class="hs-identifier hs-var">demands</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682977449"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682977449"><span class="hs-identifier hs-var">result_info</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-666"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682977448"><span class="hs-identifier hs-var">demands</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand] -&gt; BranchCount -&gt; Bool
forall a. [a] -&gt; BranchCount -&gt; Bool
</span><a href="GHC.Utils.Misc.html#lengthExceeds"><span class="hs-operator hs-var">`lengthExceeds`</span></a></span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977426"><span class="hs-identifier hs-var">n_val_args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-667"></span><span>                </span><span class="hs-glyph">-&gt;</span><span>      </span><span class="hs-comment">-- Enough args, use the strictness given.</span><span>
</span><span id="line-668"></span><span>                        </span><span class="hs-comment">-- For bottoming functions we used to pretend that the arg</span><span>
</span><span id="line-669"></span><span>                        </span><span class="hs-comment">-- is lazy, so that we don't treat the arg as an</span><span>
</span><span id="line-670"></span><span>                        </span><span class="hs-comment">-- interesting context.  This avoids substituting</span><span>
</span><span id="line-671"></span><span>                        </span><span class="hs-comment">-- top-level bindings for (say) strings into</span><span>
</span><span id="line-672"></span><span>                        </span><span class="hs-comment">-- calls to error.  But now we are more careful about</span><span>
</span><span id="line-673"></span><span>                        </span><span class="hs-comment">-- inlining lone variables, so its ok</span><span>
</span><span id="line-674"></span><span>                        </span><span class="hs-comment">-- (see GHC.Core.Op.Simplify.Utils.analyseCont)</span><span>
</span><span id="line-675"></span><span>                   </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Divergence -&gt; Bool
</span><a href="GHC.Types.Demand.html#isDeadEndDiv"><span class="hs-identifier hs-var">isDeadEndDiv</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682977449"><span class="hs-identifier hs-var">result_info</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-676"></span><span>                        </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682977448"><span class="hs-identifier hs-var">demands</span></a></span><span>  </span><span class="hs-comment">-- Finite =&gt; result is bottom</span><span>
</span><span id="line-677"></span><span>                   </span><span class="hs-keyword">else</span><span>
</span><span id="line-678"></span><span>                        </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682977448"><span class="hs-identifier hs-var">demands</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand] -&gt; [Demand] -&gt; [Demand]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682977430"><span class="hs-identifier hs-var">vanilla_dmds</span></a></span><span>
</span><span id="line-679"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-680"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; String -&gt; SDoc -&gt; [Demand] -&gt; [Demand]
forall a. HasCallStack =&gt; Bool -&gt; String -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Trace.html#warnPprTrace"><span class="hs-identifier hs-var">warnPprTrace</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;More demands than arity&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977424"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">BranchCount -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; BranchCount
</span><a href="GHC.Types.Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977424"><span class="hs-identifier hs-var">fun</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-681"></span><span>                                </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">BranchCount -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977426"><span class="hs-identifier hs-var">n_val_args</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682977448"><span class="hs-identifier hs-var">demands</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Demand] -&gt; [Demand]) -&gt; [Demand] -&gt; [Demand]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-682"></span><span>                  </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682977430"><span class="hs-identifier hs-var">vanilla_dmds</span></a></span><span>      </span><span class="hs-comment">-- Not enough args, or no strictness</span><span>
</span><span id="line-683"></span><span>
</span><span id="line-684"></span><span>    </span><span class="annot"><a href="#local-6989586621682977435"><span class="hs-identifier hs-type">add_type_strictness</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-685"></span><span>    </span><span class="hs-comment">-- If the function arg types are strict, record that in the 'strictness bits'</span><span>
</span><span id="line-686"></span><span>    </span><span class="hs-comment">-- No need to instantiate because unboxed types (which dominate the strict</span><span>
</span><span id="line-687"></span><span>    </span><span class="hs-comment">--   types) can't instantiate type variables.</span><span>
</span><span id="line-688"></span><span>    </span><span class="hs-comment">-- add_type_strictness is done repeatedly (for each call);</span><span>
</span><span id="line-689"></span><span>    </span><span class="hs-comment">--   might be better once-for-all in the function</span><span>
</span><span id="line-690"></span><span>    </span><span class="hs-comment">-- But beware primops/datacons with no strictness</span><span>
</span><span id="line-691"></span><span>
</span><span id="line-692"></span><span>    </span><span id="local-6989586621682977435"><span class="annot"><span class="annottext">add_type_strictness :: OutType -&gt; [Demand] -&gt; [Demand]
</span><a href="#local-6989586621682977435"><span class="hs-identifier hs-var hs-var">add_type_strictness</span></a></span></span><span> </span><span id="local-6989586621682977453"><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977453"><span class="hs-identifier hs-var">fun_ty</span></a></span></span><span> </span><span id="local-6989586621682977454"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682977454"><span class="hs-identifier hs-var">dmds</span></a></span></span><span>
</span><span id="line-693"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Demand] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682977454"><span class="hs-identifier hs-var">dmds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-694"></span><span>
</span><span id="line-695"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682977455"><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977455"><span class="hs-identifier hs-var">fun_ty'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OutType -&gt; Maybe (Id, OutType)
</span><a href="GHC.Core.Type.html#splitForAllTyCoVar_maybe"><span class="hs-identifier hs-var">splitForAllTyCoVar_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977453"><span class="hs-identifier hs-var">fun_ty</span></a></span><span>
</span><span id="line-696"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutType -&gt; [Demand] -&gt; [Demand]
</span><a href="#local-6989586621682977435"><span class="hs-identifier hs-var">add_type_strictness</span></a></span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977455"><span class="hs-identifier hs-var">fun_ty'</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682977454"><span class="hs-identifier hs-var">dmds</span></a></span><span>     </span><span class="hs-comment">-- Look through foralls</span><span>
</span><span id="line-697"></span><span>
</span><span id="line-698"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FunTyFlag
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OutType
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682977457"><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977457"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682977458"><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977458"><span class="hs-identifier hs-var">fun_ty'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OutType -&gt; Maybe (FunTyFlag, OutType, OutType, OutType)
</span><a href="GHC.Core.Type.html#splitFunTy_maybe"><span class="hs-identifier hs-var">splitFunTy_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977453"><span class="hs-identifier hs-var">fun_ty</span></a></span><span>        </span><span class="hs-comment">-- Add strict-type info</span><span>
</span><span id="line-699"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621682977460"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682977460"><span class="hs-identifier hs-var">dmd</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682977461"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682977461"><span class="hs-identifier hs-var">rest_dmds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682977454"><span class="hs-identifier hs-var">dmds</span></a></span><span>
</span><span id="line-700"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682977462"><span class="annot"><span class="annottext">dmd' :: Demand
</span><a href="#local-6989586621682977462"><span class="hs-identifier hs-var hs-var">dmd'</span></a></span></span><span>
</span><span id="line-701"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">OutType -&gt; Bool
</span><a href="GHC.Core.Type.html#definitelyUnliftedType"><span class="hs-identifier hs-var">definitelyUnliftedType</span></a></span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977457"><span class="hs-identifier hs-var">arg_ty</span></a></span><span>
</span><span id="line-702"></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Demand -&gt; Demand
</span><a href="GHC.Types.Demand.html#strictifyDmd"><span class="hs-identifier hs-var">strictifyDmd</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682977460"><span class="hs-identifier hs-var">dmd</span></a></span><span>
</span><span id="line-703"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-704"></span><span>             </span><span class="hs-comment">-- Something that's not definitely unlifted.</span><span>
</span><span id="line-705"></span><span>             </span><span class="hs-comment">-- If the type is representation-polymorphic, we can't know whether</span><span>
</span><span id="line-706"></span><span>             </span><span class="hs-comment">-- it's strict.</span><span>
</span><span id="line-707"></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682977460"><span class="hs-identifier hs-var">dmd</span></a></span><span>
</span><span id="line-708"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682977462"><span class="hs-identifier hs-var">dmd'</span></a></span><span> </span><span class="annot"><span class="annottext">Demand -&gt; [Demand] -&gt; [Demand]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">OutType -&gt; [Demand] -&gt; [Demand]
</span><a href="#local-6989586621682977435"><span class="hs-identifier hs-var">add_type_strictness</span></a></span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977458"><span class="hs-identifier hs-var">fun_ty'</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682977461"><span class="hs-identifier hs-var">rest_dmds</span></a></span><span>
</span><span id="line-709"></span><span>
</span><span id="line-710"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-711"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682977454"><span class="hs-identifier hs-var">dmds</span></a></span><span>
</span><span id="line-712"></span><span>
</span><span id="line-713"></span><span class="hs-comment">{- Note [Unsaturated functions]
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider (test eyeball/inline4)
        x = a:as
        y = f x
where f has arity 2.  Then we do not want to inline 'x', because
it'll just be floated out again.  Even if f has lots of discounts
on its first argument -- it must be saturated for these to kick in

Note [Do not expose strictness if sm_inline=False]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#15163 showed a case in which we had

  {-# INLINE [1] zip #-}
  zip = undefined

  {-# RULES &quot;foo&quot; forall as bs. stream (zip as bs) = ..blah... #-}

If we expose zip's bottoming nature when simplifying the LHS of the
RULE we get
  {-# RULES &quot;foo&quot; forall as bs.
                   stream (case zip of {}) = ..blah... #-}
discarding the arguments to zip.  Usually this is fine, but on the
LHS of a rule it's not, because 'as' and 'bs' are now not bound on
the LHS.

This is a pretty pathological example, so I'm not losing sleep over
it, but the simplest solution was to check sm_inline; if it is False,
which it is on the LHS of a rule (see updModeForRules), then don't
make use of the strictness info for the function.
-}</span><span>
</span><span id="line-744"></span><span>
</span><span id="line-745"></span><span>
</span><span id="line-746"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Interesting arguments
*                                                                      *
************************************************************************

Note [Interesting call context]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We want to avoid inlining an expression where there can't possibly be
any gain, such as in an argument position.  Hence, if the continuation
is interesting (eg. a case scrutinee that isn't just a seq, application etc.)
then we inline, otherwise we don't.

Previously some_benefit used to return True only if the variable was
applied to some value arguments.  This didn't work:

        let x = _coerce_ (T Int) Int (I# 3) in
        case _coerce_ Int (T Int) x of
                I# y -&gt; ....

we want to inline x, but can't see that it's a constructor in a case
scrutinee position, and some_benefit is False.

Another example:

dMonadST = _/\_ t -&gt; :Monad (g1 _@_ t, g2 _@_ t, g3 _@_ t)

....  case dMonadST _@_ x0 of (a,b,c) -&gt; ....

we'd really like to inline dMonadST here, but we *don't* want to
inline if the case expression is just

        case x of y { DEFAULT -&gt; ... }

since we can just eliminate this case instead (x is in WHNF).  Similar
applies when x is bound to a lambda expression.  Hence
contIsInteresting looks for case expressions with just a single
default case.

Note [No case of case is boring]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we see
   case f x of &lt;alts&gt;

we'd usually treat the context as interesting, to encourage 'f' to
inline.  But if case-of-case is off, it's really not so interesting
after all, because we are unlikely to be able to push the case
expression into the branches of any case in f's unfolding.  So, to
reduce unnecessary code expansion, we just make the context look boring.
This made a small compile-time perf improvement in perf/compiler/T6048,
and it looks plausible to me.

Note [Seq is boring]
~~~~~~~~~~~~~~~~~~~~
Suppose
  f x = case v of
          True  -&gt; Just x
          False -&gt; Just (x-1)

Now consider these variants of
   case (f x) of ...

1. [Dead case binder]: inline f
      case f x of b{-dead-} { DEFAULT -&gt; blah[no b] }
   Inlining (f x) will allow us to avoid ever allocating (Just x),
   since the case binder `b` is dead.  We will end up with a
     join point for blah, thus
         join j = blah in
         case v of { True -&gt; j; False -&gt; j }
   which will turn into (case v of DEFAULT -&gt; blah)
   All good

2. [Live case binder, live alt binders]: inline f
       case f x of b { Just y -&gt; blah[y,b] }
   Inlining (f x) will mean we still allocate (Just x),
   but we also get to bind `y` without fetching it out of the Just, thus
         join j y b = blah[y,b]
         case v of { True -&gt; j x (Just x)
                   ; False -&gt; let y = x-1 in j y (Just y) }
   Inlining (f x) has a small benefit, perhaps.
   (To T14955 it makes a surprisingly large difference of ~30% to inline here.)

3. [Live case binder, dead alt binders]: maybe don't inline f
      case f x of b { DEFAULT -&gt; blah[b] }
   Inlining (f x) will still mean we allocate (Just x). We'd get:
         join j b = blah[b]
         case v of { True -&gt; j (Just x); False -&gt; j (Just (x-1)) }
   No new optimisations are revealed. Nothing is gained.
   (This is the situation in T22317.)

   A variant is when we have a data constructor with dead binders:
       case g x of b { (x{-dead-}, x{-dead-}) -&gt; blah[b, no x, no y] }
   Instead of DEFAULT we have a single constructor alternative
   with all dead binders.  Again, no gain from inlining (f x)

4. [Live case binder, dead alt binders]: small f
   Suppose f is CPR'd, so it looks like
       f x = case $wf x of (# a #) -&gt; Just a
   Then even in case (3) we want to inline:
      case f x of b { DEFAULT -&gt; blah[b] }
   --&gt;
      case $wf x of (# a #) -&gt;
      let b = Just a in blah[b]
   This is very good; we now know a lot about `b` (instead of nothing)
   and `blah` might benefit.  Similarly if `f` has a join point
      f x = join $j y = Just y in ...
   Again the case (f x) is now consuming a constructor (Just y).

   This is very like the situation described in Note [RHS of lets]
   in GHC.Core.Opt.Simplify.Inline; (case e of b -&gt; blah) is just
   like a strict `let`.

Conclusion: in interestingCallCtxt, a case-expression (i.e. Select continuation)
usually gives a CaseCtxt (cases 1,2); but when (cases 3,4):
  * It has a non-dead case-binder
  * It has one alternative
  * All the binders in the alternative are dead
then the `case` is just a strict let-binding, so use RhsCtxt NonRecursive.
This RhsCtxt gives a small incentive for small functions to inline.
That incentive is what is needed in case (4).

Wrinkle (SB1).  The 'small incentive' is implemented by `calc_some_benefit` in
GHC.Core.Opt.Simplify.Inline.tryUnfolding.  We restrict the incentive just to
funtions that have unfolding guidance of `UnfWhen`, which particularly includes
wrappers created by CPR, exactly case (4) above.  Without this limitation I
got too much fruitless inlining, which led to regressions (#22317 is an example).

A good example of a function where this 'small incentive' is important is
GHC.Num.Integer where we ended up with calls like this:
     case (integerSignum a b) of r -&gt; ...
but were failing to inline integerSignum, even though it always returns
a single constructor, so it is very helpful to inline it. There is also an
issue of confluence-of-the-simplifier.  Suppose we have
    f x = case x of r -&gt; ...
and the Simplifier sees
    f (integerSigNum a b)
Because `f` scrutines `x`, the unfolding guidance for f gives a discount
for `x`; and that discount makes interestingCallContext for the context
`f &lt;&gt;` return DiscArgCtxt, which again gives that incentive.  We don't want
the incentive to disappear when we inline `f`!
-}</span><span>
</span><span id="line-888"></span><span>
</span><span id="line-889"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#lazyArgContext"><span class="hs-identifier hs-type">lazyArgContext</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#CallCtxt"><span class="hs-identifier hs-type">CallCtxt</span></a></span><span>
</span><span id="line-890"></span><span class="hs-comment">-- Use this for lazy arguments</span><span>
</span><span id="line-891"></span><span id="lazyArgContext"><span class="annot"><span class="annottext">lazyArgContext :: ArgInfo -&gt; CallCtxt
</span><a href="GHC.Core.Opt.Simplify.Utils.html#lazyArgContext"><span class="hs-identifier hs-var hs-var">lazyArgContext</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ai_encl :: ArgInfo -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_encl"><span class="hs-identifier hs-var">ai_encl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977465"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682977465"><span class="hs-identifier hs-var">encl_rules</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ai_discs :: ArgInfo -&gt; [BranchCount]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_discs"><span class="hs-identifier hs-var">ai_discs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977466"><span class="annot"><span class="annottext">[BranchCount]
</span><a href="#local-6989586621682977466"><span class="hs-identifier hs-var">discs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-892"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682977465"><span class="hs-identifier hs-var">encl_rules</span></a></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallCtxt
</span><a href="GHC.Core.Unfold.html#RuleArgCtxt"><span class="hs-identifier hs-var">RuleArgCtxt</span></a></span><span>
</span><span id="line-893"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621682977468"><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977468"><span class="hs-identifier hs-var">disc</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[BranchCount]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[BranchCount]
</span><a href="#local-6989586621682977466"><span class="hs-identifier hs-var">discs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977468"><span class="hs-identifier hs-var">disc</span></a></span><span> </span><span class="annot"><span class="annottext">BranchCount -&gt; BranchCount -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallCtxt
</span><a href="GHC.Core.Unfold.html#DiscArgCtxt"><span class="hs-identifier hs-var">DiscArgCtxt</span></a></span><span>  </span><span class="hs-comment">-- Be keener here</span><span>
</span><span id="line-894"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallCtxt
</span><a href="GHC.Core.Unfold.html#BoringCtxt"><span class="hs-identifier hs-var">BoringCtxt</span></a></span><span>   </span><span class="hs-comment">-- Nothing interesting</span><span>
</span><span id="line-895"></span><span>
</span><span id="line-896"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#strictArgContext"><span class="hs-identifier hs-type">strictArgContext</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#CallCtxt"><span class="hs-identifier hs-type">CallCtxt</span></a></span><span>
</span><span id="line-897"></span><span id="strictArgContext"><span class="annot"><span class="annottext">strictArgContext :: ArgInfo -&gt; CallCtxt
</span><a href="GHC.Core.Opt.Simplify.Utils.html#strictArgContext"><span class="hs-identifier hs-var hs-var">strictArgContext</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ai_encl :: ArgInfo -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_encl"><span class="hs-identifier hs-var">ai_encl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977472"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682977472"><span class="hs-identifier hs-var">encl_rules</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ai_discs :: ArgInfo -&gt; [BranchCount]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_discs"><span class="hs-identifier hs-var">ai_discs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977473"><span class="annot"><span class="annottext">[BranchCount]
</span><a href="#local-6989586621682977473"><span class="hs-identifier hs-var">discs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-898"></span><span class="hs-comment">-- Use this for strict arguments</span><span>
</span><span id="line-899"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682977472"><span class="hs-identifier hs-var">encl_rules</span></a></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallCtxt
</span><a href="GHC.Core.Unfold.html#RuleArgCtxt"><span class="hs-identifier hs-var">RuleArgCtxt</span></a></span><span>
</span><span id="line-900"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621682977474"><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977474"><span class="hs-identifier hs-var">disc</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[BranchCount]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[BranchCount]
</span><a href="#local-6989586621682977473"><span class="hs-identifier hs-var">discs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977474"><span class="hs-identifier hs-var">disc</span></a></span><span> </span><span class="annot"><span class="annottext">BranchCount -&gt; BranchCount -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallCtxt
</span><a href="GHC.Core.Unfold.html#DiscArgCtxt"><span class="hs-identifier hs-var">DiscArgCtxt</span></a></span><span>  </span><span class="hs-comment">-- Be keener here</span><span>
</span><span id="line-901"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RecFlag -&gt; CallCtxt
</span><a href="GHC.Core.Unfold.html#RhsCtxt"><span class="hs-identifier hs-var">RhsCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="GHC.Types.Basic.html#NonRecursive"><span class="hs-identifier hs-var">NonRecursive</span></a></span><span>
</span><span id="line-902"></span><span>      </span><span class="hs-comment">-- Why RhsCtxt?  if we see f (g x), and f is strict, we</span><span>
</span><span id="line-903"></span><span>      </span><span class="hs-comment">-- want to be a bit more eager to inline g, because it may</span><span>
</span><span id="line-904"></span><span>      </span><span class="hs-comment">-- expose an eval (on x perhaps) that can be eliminated or</span><span>
</span><span id="line-905"></span><span>      </span><span class="hs-comment">-- shared. I saw this in nofib 'boyer2', RewriteFuns.onewayunify1</span><span>
</span><span id="line-906"></span><span>      </span><span class="hs-comment">-- It's worth an 18% improvement in allocation for this</span><span>
</span><span id="line-907"></span><span>      </span><span class="hs-comment">-- particular benchmark; 5% on 'mate' and 1.3% on 'multiplier'</span><span>
</span><span id="line-908"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-909"></span><span>      </span><span class="hs-comment">-- Why NonRecursive?  Becuase it's a bit like</span><span>
</span><span id="line-910"></span><span>      </span><span class="hs-comment">--   let a = g x in f a</span><span>
</span><span id="line-911"></span><span>
</span><span id="line-912"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#interestingCallContext"><span class="hs-identifier hs-type">interestingCallContext</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#CallCtxt"><span class="hs-identifier hs-type">CallCtxt</span></a></span><span>
</span><span id="line-913"></span><span class="hs-comment">-- See Note [Interesting call context]</span><span>
</span><span id="line-914"></span><span id="interestingCallContext"><span class="annot"><span class="annottext">interestingCallContext :: StaticEnv -&gt; SimplCont -&gt; CallCtxt
</span><a href="GHC.Core.Opt.Simplify.Utils.html#interestingCallContext"><span class="hs-identifier hs-var hs-var">interestingCallContext</span></a></span></span><span> </span><span id="local-6989586621682977476"><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977476"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682977477"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977477"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-915"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; CallCtxt
</span><a href="#local-6989586621682977478"><span class="hs-identifier hs-var">interesting</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977477"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-916"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-917"></span><span>    </span><span id="local-6989586621682977478"><span class="annot"><span class="annottext">interesting :: SimplCont -&gt; CallCtxt
</span><a href="#local-6989586621682977478"><span class="hs-identifier hs-var hs-var">interesting</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#Select"><span class="hs-identifier hs-type">Select</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">sc_alts :: SimplCont -&gt; [InAlt]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_alts"><span class="hs-identifier hs-var">sc_alts</span></a></span><span class="hs-glyph">=</span><span id="local-6989586621682977479"><span class="annot"><span class="annottext">[InAlt]
</span><a href="#local-6989586621682977479"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_bndr :: SimplCont -&gt; Id
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_bndr"><span class="hs-identifier hs-var">sc_bndr</span></a></span><span class="hs-glyph">=</span><span id="local-6989586621682977480"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977480"><span class="hs-identifier hs-var">case_bndr</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-918"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StaticEnv -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Env.html#seCaseCase"><span class="hs-identifier hs-var">seCaseCase</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977476"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallCtxt
</span><a href="GHC.Core.Unfold.html#BoringCtxt"><span class="hs-identifier hs-var">BoringCtxt</span></a></span><span> </span><span class="hs-comment">-- See Note [No case of case is boring]</span><span>
</span><span id="line-919"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682977483"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977483"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><span class="hs-identifier">_</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[InAlt]
</span><a href="#local-6989586621682977479"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-920"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; [Id] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isDeadBinder"><span class="hs-identifier hs-var">isDeadBinder</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977483"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-921"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isDeadBinder"><span class="hs-identifier hs-var">isDeadBinder</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977480"><span class="hs-identifier hs-var">case_bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RecFlag -&gt; CallCtxt
</span><a href="GHC.Core.Unfold.html#RhsCtxt"><span class="hs-identifier hs-var">RhsCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="GHC.Types.Basic.html#NonRecursive"><span class="hs-identifier hs-var">NonRecursive</span></a></span><span> </span><span class="hs-comment">-- See Note [Seq is boring]</span><span>
</span><span id="line-922"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallCtxt
</span><a href="GHC.Core.Unfold.html#CaseCtxt"><span class="hs-identifier hs-var">CaseCtxt</span></a></span><span>
</span><span id="line-923"></span><span>
</span><span id="line-924"></span><span>
</span><span id="line-925"></span><span>    </span><span class="annot"><a href="#local-6989586621682977478"><span class="hs-identifier hs-var">interesting</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToVal"><span class="hs-identifier hs-type">ApplyToVal</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallCtxt
</span><a href="GHC.Core.Unfold.html#ValAppCtxt"><span class="hs-identifier hs-var">ValAppCtxt</span></a></span><span>
</span><span id="line-926"></span><span>        </span><span class="hs-comment">-- Can happen if we have (f Int |&gt; co) y</span><span>
</span><span id="line-927"></span><span>        </span><span class="hs-comment">-- If f has an INLINE prag we need to give it some</span><span>
</span><span id="line-928"></span><span>        </span><span class="hs-comment">-- motivation to inline. See Note [Cast then apply]</span><span>
</span><span id="line-929"></span><span>        </span><span class="hs-comment">-- in GHC.Core.Unfold</span><span>
</span><span id="line-930"></span><span>
</span><span id="line-931"></span><span>    </span><span class="annot"><a href="#local-6989586621682977478"><span class="hs-identifier hs-var">interesting</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StrictArg"><span class="hs-identifier hs-type">StrictArg</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_fun :: SimplCont -&gt; ArgInfo
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_fun"><span class="hs-identifier hs-var">sc_fun</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977488"><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682977488"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArgInfo -&gt; CallCtxt
</span><a href="GHC.Core.Opt.Simplify.Utils.html#strictArgContext"><span class="hs-identifier hs-var">strictArgContext</span></a></span><span> </span><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682977488"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-932"></span><span>    </span><span class="annot"><a href="#local-6989586621682977478"><span class="hs-identifier hs-var">interesting</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StrictBind"><span class="hs-identifier hs-type">StrictBind</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallCtxt
</span><a href="GHC.Core.Unfold.html#BoringCtxt"><span class="hs-identifier hs-var">BoringCtxt</span></a></span><span>
</span><span id="line-933"></span><span>    </span><span class="annot"><a href="#local-6989586621682977478"><span class="hs-identifier hs-var">interesting</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#Stop"><span class="hs-identifier hs-type">Stop</span></a></span><span> </span><span class="annot"><span class="annottext">OutType
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682977489"><span class="annot"><span class="annottext">CallCtxt
</span><a href="#local-6989586621682977489"><span class="hs-identifier hs-var">cci</span></a></span></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallCtxt
</span><a href="#local-6989586621682977489"><span class="hs-identifier hs-var">cci</span></a></span><span>
</span><span id="line-934"></span><span>    </span><span class="annot"><a href="#local-6989586621682977478"><span class="hs-identifier hs-var">interesting</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#TickIt"><span class="hs-identifier hs-type">TickIt</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682977490"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977490"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">)</span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; CallCtxt
</span><a href="#local-6989586621682977478"><span class="hs-identifier hs-var">interesting</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977490"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-935"></span><span>    </span><span class="annot"><a href="#local-6989586621682977478"><span class="hs-identifier hs-var">interesting</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToTy"><span class="hs-identifier hs-type">ApplyToTy</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977491"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977491"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; CallCtxt
</span><a href="#local-6989586621682977478"><span class="hs-identifier hs-var">interesting</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977491"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-936"></span><span>    </span><span class="annot"><a href="#local-6989586621682977478"><span class="hs-identifier hs-var">interesting</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#CastIt"><span class="hs-identifier hs-type">CastIt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977492"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977492"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; CallCtxt
</span><a href="#local-6989586621682977478"><span class="hs-identifier hs-var">interesting</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977492"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-937"></span><span>        </span><span class="hs-comment">-- If this call is the arg of a strict function, the context</span><span>
</span><span id="line-938"></span><span>        </span><span class="hs-comment">-- is a bit interesting.  If we inline here, we may get useful</span><span>
</span><span id="line-939"></span><span>        </span><span class="hs-comment">-- evaluation information to avoid repeated evals: e.g.</span><span>
</span><span id="line-940"></span><span>        </span><span class="hs-comment">--      x + (y * z)</span><span>
</span><span id="line-941"></span><span>        </span><span class="hs-comment">-- Here the contIsInteresting makes the '*' keener to inline,</span><span>
</span><span id="line-942"></span><span>        </span><span class="hs-comment">-- which in turn exposes a constructor which makes the '+' inline.</span><span>
</span><span id="line-943"></span><span>        </span><span class="hs-comment">-- Assuming that +,* aren't small enough to inline regardless.</span><span>
</span><span id="line-944"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-945"></span><span>        </span><span class="hs-comment">-- It's also very important to inline in a strict context for things</span><span>
</span><span id="line-946"></span><span>        </span><span class="hs-comment">-- like</span><span>
</span><span id="line-947"></span><span>        </span><span class="hs-comment">--              foldr k z (f x)</span><span>
</span><span id="line-948"></span><span>        </span><span class="hs-comment">-- Here, the context of (f x) is strict, and if f's unfolding is</span><span>
</span><span id="line-949"></span><span>        </span><span class="hs-comment">-- a build it's *great* to inline it here.  So we must ensure that</span><span>
</span><span id="line-950"></span><span>        </span><span class="hs-comment">-- the context for (f x) is not totally uninteresting.</span><span>
</span><span id="line-951"></span><span>
</span><span id="line-952"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contHasRules"><span class="hs-identifier hs-type">contHasRules</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-953"></span><span class="hs-comment">-- If the argument has form (f x y), where x,y are boring,</span><span>
</span><span id="line-954"></span><span class="hs-comment">-- and f is marked INLINE, then we don't want to inline f.</span><span>
</span><span id="line-955"></span><span class="hs-comment">-- But if the context of the argument is</span><span>
</span><span id="line-956"></span><span class="hs-comment">--      g (f x y)</span><span>
</span><span id="line-957"></span><span class="hs-comment">-- where g has rules, then we *do* want to inline f, in case it</span><span>
</span><span id="line-958"></span><span class="hs-comment">-- exposes a rule that might fire.  Similarly, if the context is</span><span>
</span><span id="line-959"></span><span class="hs-comment">--      h (g (f x x))</span><span>
</span><span id="line-960"></span><span class="hs-comment">-- where h has rules, then we do want to inline f.  So contHasRules</span><span>
</span><span id="line-961"></span><span class="hs-comment">-- tries to see if the context of the f-call is a call to a function</span><span>
</span><span id="line-962"></span><span class="hs-comment">-- with rules.</span><span>
</span><span id="line-963"></span><span class="hs-comment">--</span><span>
</span><span id="line-964"></span><span class="hs-comment">-- The ai_encl flag makes this happen; if it's</span><span>
</span><span id="line-965"></span><span class="hs-comment">-- set, the inliner gets just enough keener to inline f</span><span>
</span><span id="line-966"></span><span class="hs-comment">-- regardless of how boring f's arguments are, if it's marked INLINE</span><span>
</span><span id="line-967"></span><span class="hs-comment">--</span><span>
</span><span id="line-968"></span><span class="hs-comment">-- The alternative would be to *always* inline an INLINE function,</span><span>
</span><span id="line-969"></span><span class="hs-comment">-- regardless of how boring its context is; but that seems overkill</span><span>
</span><span id="line-970"></span><span class="hs-comment">-- For example, it'd mean that wrapper functions were always inlined</span><span>
</span><span id="line-971"></span><span id="contHasRules"><span class="annot"><span class="annottext">contHasRules :: SimplCont -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contHasRules"><span class="hs-identifier hs-var hs-var">contHasRules</span></a></span></span><span> </span><span id="local-6989586621682977493"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977493"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-972"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Bool
</span><a href="#local-6989586621682977494"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977493"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-973"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-974"></span><span>    </span><span id="local-6989586621682977494"><span class="annot"><span class="annottext">go :: SimplCont -&gt; Bool
</span><a href="#local-6989586621682977494"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToVal"><span class="hs-identifier hs-type">ApplyToVal</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977495"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977495"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Bool
</span><a href="#local-6989586621682977494"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977495"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-975"></span><span>    </span><span class="annot"><a href="#local-6989586621682977494"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToTy"><span class="hs-identifier hs-type">ApplyToTy</span></a></span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977496"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977496"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Bool
</span><a href="#local-6989586621682977494"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977496"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-976"></span><span>    </span><span class="annot"><a href="#local-6989586621682977494"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#CastIt"><span class="hs-identifier hs-type">CastIt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977497"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977497"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Bool
</span><a href="#local-6989586621682977494"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977497"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-977"></span><span>    </span><span class="annot"><a href="#local-6989586621682977494"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StrictArg"><span class="hs-identifier hs-type">StrictArg</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_fun :: SimplCont -&gt; ArgInfo
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_fun"><span class="hs-identifier hs-var">sc_fun</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977498"><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682977498"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArgInfo -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_encl"><span class="hs-identifier hs-var">ai_encl</span></a></span><span> </span><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682977498"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-978"></span><span>    </span><span class="annot"><a href="#local-6989586621682977494"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#Stop"><span class="hs-identifier hs-type">Stop</span></a></span><span> </span><span class="annot"><span class="annottext">OutType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">CallCtxt
</span><a href="GHC.Core.Unfold.html#RuleArgCtxt"><span class="hs-identifier hs-var">RuleArgCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-979"></span><span>    </span><span class="annot"><a href="#local-6989586621682977494"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#TickIt"><span class="hs-identifier hs-type">TickIt</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682977499"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977499"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">)</span><span>                    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Bool
</span><a href="#local-6989586621682977494"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977499"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-980"></span><span>    </span><span class="annot"><a href="#local-6989586621682977494"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#Select"><span class="hs-identifier hs-type">Select</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-981"></span><span>    </span><span class="annot"><a href="#local-6989586621682977494"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StrictBind"><span class="hs-identifier hs-type">StrictBind</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>      </span><span class="hs-comment">-- ??</span><span>
</span><span id="line-982"></span><span>    </span><span class="annot"><a href="#local-6989586621682977494"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#Stop"><span class="hs-identifier hs-type">Stop</span></a></span><span> </span><span class="annot"><span class="annottext">OutType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">CallCtxt
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>                    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-983"></span><span>
</span><span id="line-984"></span><span class="hs-comment">{- Note [Interesting arguments]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
An argument is interesting if it deserves a discount for unfoldings
with a discount in that argument position.  The idea is to avoid
unfolding a function that is applied only to variables that have no
unfolding (i.e. they are probably lambda bound): f x y z There is
little point in inlining f here.

Generally, *values* (like (C a b) and (\x.e)) deserve discounts.  But
we must look through lets, eg (let x = e in C a b), because the let will
float, exposing the value, if we inline.  That makes it different to
exprIsHNF.

Before 2009 we said it was interesting if the argument had *any* structure
at all; i.e. (hasSomeUnfolding v).  But does too much inlining; see #3016.

But we don't regard (f x y) as interesting, unless f is unsaturated.
If it's saturated and f hasn't inlined, then it's probably not going
to now!

Note [Conlike is interesting]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
        f d = ...((*) d x y)...
        ... f (df d')...
where df is con-like. Then we'd really like to inline 'f' so that the
rule for (*) (df d) can fire.  To do this
  a) we give a discount for being an argument of a class-op (eg (*) d)
  b) we say that a con-like argument (eg (df d)) is interesting
-}</span><span>
</span><span id="line-1014"></span><span>
</span><span id="line-1015"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#interestingArg"><span class="hs-identifier hs-type">interestingArg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#ArgSummary"><span class="hs-identifier hs-type">ArgSummary</span></a></span><span>
</span><span id="line-1016"></span><span class="hs-comment">-- See Note [Interesting arguments]</span><span>
</span><span id="line-1017"></span><span id="interestingArg"><span class="annot"><span class="annottext">interestingArg :: StaticEnv -&gt; OutExpr -&gt; ArgSummary
</span><a href="GHC.Core.Opt.Simplify.Utils.html#interestingArg"><span class="hs-identifier hs-var hs-var">interestingArg</span></a></span></span><span> </span><span id="local-6989586621682977501"><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977501"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682977502"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977502"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticEnv -&gt; BranchCount -&gt; OutExpr -&gt; ArgSummary
</span><a href="#local-6989586621682977503"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977501"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977502"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1018"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1019"></span><span>    </span><span class="hs-comment">-- n is # value args to which the expression is applied</span><span>
</span><span id="line-1020"></span><span>    </span><span id="local-6989586621682977503"><span class="annot"><span class="annottext">go :: StaticEnv -&gt; BranchCount -&gt; OutExpr -&gt; ArgSummary
</span><a href="#local-6989586621682977503"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621682977508"><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977508"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682977509"><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977509"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682977510"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977510"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1021"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">StaticEnv -&gt; Id -&gt; SimplSR
</span><a href="GHC.Core.Opt.Simplify.Env.html#substId"><span class="hs-identifier hs-var">substId</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977508"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977510"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1022"></span><span>           </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#DoneId"><span class="hs-identifier hs-type">DoneId</span></a></span><span> </span><span id="local-6989586621682977513"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977513"><span class="hs-identifier hs-var">v'</span></a></span></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">BranchCount -&gt; Id -&gt; ArgSummary
</span><a href="#local-6989586621682977514"><span class="hs-identifier hs-var">go_var</span></a></span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977509"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977513"><span class="hs-identifier hs-var">v'</span></a></span><span>
</span><span id="line-1023"></span><span>           </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#DoneEx"><span class="hs-identifier hs-type">DoneEx</span></a></span><span> </span><span id="local-6989586621682977516"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977516"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">JoinPointHood
</span><span class="hs-identifier">_</span></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StaticEnv -&gt; BranchCount -&gt; OutExpr -&gt; ArgSummary
</span><a href="#local-6989586621682977503"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StaticEnv -&gt; StaticEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#zapSubstEnv"><span class="hs-identifier hs-var">zapSubstEnv</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977508"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>             </span><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977509"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977516"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1024"></span><span>           </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#ContEx"><span class="hs-identifier hs-type">ContEx</span></a></span><span> </span><span id="local-6989586621682977519"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621682977519"><span class="hs-identifier hs-var">tvs</span></a></span></span><span> </span><span id="local-6989586621682977520"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621682977520"><span class="hs-identifier hs-var">cvs</span></a></span></span><span> </span><span id="local-6989586621682977521"><span class="annot"><span class="annottext">SimplIdSubst
</span><a href="#local-6989586621682977521"><span class="hs-identifier hs-var">ids</span></a></span></span><span> </span><span id="local-6989586621682977522"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977522"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StaticEnv -&gt; BranchCount -&gt; OutExpr -&gt; ArgSummary
</span><a href="#local-6989586621682977503"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StaticEnv -&gt; TvSubstEnv -&gt; CvSubstEnv -&gt; SimplIdSubst -&gt; StaticEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#setSubstEnv"><span class="hs-identifier hs-var">setSubstEnv</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977508"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621682977519"><span class="hs-identifier hs-var">tvs</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621682977520"><span class="hs-identifier hs-var">cvs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplIdSubst
</span><a href="#local-6989586621682977521"><span class="hs-identifier hs-var">ids</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977509"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977522"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1025"></span><span>
</span><span id="line-1026"></span><span>    </span><span class="annot"><a href="#local-6989586621682977503"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><span class="hs-identifier">_</span></span><span>   </span><span class="annot"><span class="annottext">BranchCount
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-type">Lit</span></a></span><span> </span><span id="local-6989586621682977525"><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621682977525"><span class="hs-identifier hs-var">l</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1027"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Literal -&gt; Bool
</span><a href="GHC.Types.Literal.html#isLitRubbish"><span class="hs-identifier hs-var">isLitRubbish</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621682977525"><span class="hs-identifier hs-var">l</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArgSummary
</span><a href="GHC.Core.Unfold.html#TrivArg"><span class="hs-identifier hs-var">TrivArg</span></a></span><span> </span><span class="hs-comment">-- Leads to unproductive inlining in WWRec, #20035</span><span>
</span><span id="line-1028"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArgSummary
</span><a href="GHC.Core.Unfold.html#ValueArg"><span class="hs-identifier hs-var">ValueArg</span></a></span><span>
</span><span id="line-1029"></span><span>    </span><span class="annot"><a href="#local-6989586621682977503"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><span class="hs-identifier">_</span></span><span>   </span><span class="annot"><span class="annottext">BranchCount
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="annot"><span class="annottext">OutType
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArgSummary
</span><a href="GHC.Core.Unfold.html#TrivArg"><span class="hs-identifier hs-var">TrivArg</span></a></span><span>
</span><span id="line-1030"></span><span>    </span><span class="annot"><a href="#local-6989586621682977503"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><span class="hs-identifier">_</span></span><span>   </span><span class="annot"><span class="annottext">BranchCount
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="annot"><span class="annottext">OutCoercion
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArgSummary
</span><a href="GHC.Core.Unfold.html#TrivArg"><span class="hs-identifier hs-var">TrivArg</span></a></span><span>
</span><span id="line-1031"></span><span>    </span><span class="annot"><a href="#local-6989586621682977503"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682977529"><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977529"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682977530"><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977530"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621682977531"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977531"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="annot"><span class="annottext">OutType
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticEnv -&gt; BranchCount -&gt; OutExpr -&gt; ArgSummary
</span><a href="#local-6989586621682977503"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977529"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977530"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977531"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-1032"></span><span>    </span><span class="annot"><a href="#local-6989586621682977503"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682977532"><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977532"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682977533"><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977533"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621682977534"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977534"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticEnv -&gt; BranchCount -&gt; OutExpr -&gt; ArgSummary
</span><a href="#local-6989586621682977503"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977532"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977533"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">BranchCount -&gt; BranchCount -&gt; BranchCount
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span class="annot"><span class="annottext">BranchCount
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977534"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-1033"></span><span>    </span><span class="annot"><a href="#local-6989586621682977503"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682977535"><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977535"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682977536"><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977536"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682977538"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977538"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticEnv -&gt; BranchCount -&gt; OutExpr -&gt; ArgSummary
</span><a href="#local-6989586621682977503"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977535"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977536"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977538"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-1034"></span><span>    </span><span class="annot"><a href="#local-6989586621682977503"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682977539"><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977539"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682977540"><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977540"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682977542"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977542"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">OutCoercion
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticEnv -&gt; BranchCount -&gt; OutExpr -&gt; ArgSummary
</span><a href="#local-6989586621682977503"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977539"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977540"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977542"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1035"></span><span>    </span><span class="annot"><a href="#local-6989586621682977503"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682977543"><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977543"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682977544"><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977544"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621682977546"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977546"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621682977547"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977547"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1036"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977546"><span class="hs-identifier hs-var">v</span></a></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticEnv -&gt; BranchCount -&gt; OutExpr -&gt; ArgSummary
</span><a href="#local-6989586621682977503"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977543"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977544"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977547"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1037"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977544"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">BranchCount -&gt; BranchCount -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span class="annot"><span class="annottext">BranchCount
</span><span class="hs-number">0</span></span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArgSummary
</span><a href="GHC.Core.Unfold.html#NonTrivArg"><span class="hs-identifier hs-var">NonTrivArg</span></a></span><span>     </span><span class="hs-comment">-- (\x.b) e   is NonTriv</span><span>
</span><span id="line-1038"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArgSummary
</span><a href="GHC.Core.Unfold.html#ValueArg"><span class="hs-identifier hs-var">ValueArg</span></a></span><span>
</span><span id="line-1039"></span><span>    </span><span class="annot"><a href="#local-6989586621682977503"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArgSummary
</span><a href="GHC.Core.Unfold.html#NonTrivArg"><span class="hs-identifier hs-var">NonTrivArg</span></a></span><span>
</span><span id="line-1040"></span><span>    </span><span class="annot"><a href="#local-6989586621682977503"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682977551"><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977551"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682977552"><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977552"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621682977554"><span class="annot"><span class="annottext">Bind Id
</span><a href="#local-6989586621682977554"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682977555"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977555"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">StaticEnv -&gt; BranchCount -&gt; OutExpr -&gt; ArgSummary
</span><a href="#local-6989586621682977503"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977556"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977552"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977555"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1041"></span><span>                                   </span><span class="annot"><span class="annottext">ArgSummary
</span><a href="GHC.Core.Unfold.html#ValueArg"><span class="hs-identifier hs-var">ValueArg</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ArgSummary
</span><a href="GHC.Core.Unfold.html#ValueArg"><span class="hs-identifier hs-var">ValueArg</span></a></span><span>
</span><span id="line-1042"></span><span>                                   </span><span class="annot"><span class="annottext">ArgSummary
</span><span class="hs-identifier">_</span></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ArgSummary
</span><a href="GHC.Core.Unfold.html#NonTrivArg"><span class="hs-identifier hs-var">NonTrivArg</span></a></span><span>
</span><span id="line-1043"></span><span>                               </span><span class="hs-keyword">where</span><span>
</span><span id="line-1044"></span><span>                                 </span><span id="local-6989586621682977556"><span class="annot"><span class="annottext">env' :: StaticEnv
</span><a href="#local-6989586621682977556"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977551"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv -&gt; [Id] -&gt; StaticEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#addNewInScopeIds"><span class="hs-operator hs-var">`addNewInScopeIds`</span></a></span><span> </span><span class="annot"><span class="annottext">Bind Id -&gt; [Id]
forall b. Bind b -&gt; [b]
</span><a href="GHC.Core.html#bindersOf"><span class="hs-identifier hs-var">bindersOf</span></a></span><span> </span><span class="annot"><span class="annottext">Bind Id
</span><a href="#local-6989586621682977554"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-1045"></span><span>
</span><span id="line-1046"></span><span>    </span><span id="local-6989586621682977514"><span class="annot"><span class="annottext">go_var :: BranchCount -&gt; Id -&gt; ArgSummary
</span><a href="#local-6989586621682977514"><span class="hs-identifier hs-var hs-var">go_var</span></a></span></span><span> </span><span id="local-6989586621682977562"><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977562"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621682977563"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977563"><span class="hs-identifier hs-var">v</span></a></span></span><span>
</span><span id="line-1047"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isConLikeId"><span class="hs-identifier hs-var">isConLikeId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977563"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArgSummary
</span><a href="GHC.Core.Unfold.html#ValueArg"><span class="hs-identifier hs-var">ValueArg</span></a></span><span>   </span><span class="hs-comment">-- Experimenting with 'conlike' rather that</span><span>
</span><span id="line-1048"></span><span>                                    </span><span class="hs-comment">--    data constructors here</span><span>
</span><span id="line-1049"></span><span>                                    </span><span class="hs-comment">-- DFuns are con-like; see Note [Conlike is interesting]</span><span>
</span><span id="line-1050"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; BranchCount
</span><a href="GHC.Types.Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977563"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">BranchCount -&gt; BranchCount -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977562"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArgSummary
</span><a href="GHC.Core.Unfold.html#ValueArg"><span class="hs-identifier hs-var">ValueArg</span></a></span><span>   </span><span class="hs-comment">-- Catches (eg) primops with arity but no unfolding</span><span>
</span><span id="line-1051"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977562"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">BranchCount -&gt; BranchCount -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><span class="hs-number">0</span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArgSummary
</span><a href="GHC.Core.Unfold.html#NonTrivArg"><span class="hs-identifier hs-var">NonTrivArg</span></a></span><span> </span><span class="hs-comment">-- Saturated or unknown call</span><span>
</span><span id="line-1052"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>  </span><span class="hs-comment">-- n==0, no value arguments; look for an interesting unfolding</span><span>
</span><span id="line-1053"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IdUnfoldingFun
</span><a href="GHC.Types.Id.html#idUnfolding"><span class="hs-identifier hs-var">idUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977563"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1054"></span><span>           </span><span class="annot"><a href="GHC.Core.html#OtherCon"><span class="hs-identifier hs-type">OtherCon</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ArgSummary
</span><a href="GHC.Core.Unfold.html#NonTrivArg"><span class="hs-identifier hs-var">NonTrivArg</span></a></span><span>   </span><span class="hs-comment">-- It's evaluated, but that's all we know</span><span>
</span><span id="line-1055"></span><span>           </span><span class="annot"><a href="GHC.Core.html#OtherCon"><span class="hs-identifier hs-type">OtherCon</span></a></span><span> </span><span class="annot"><span class="annottext">[AltCon]
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ArgSummary
</span><a href="GHC.Core.Unfold.html#ValueArg"><span class="hs-identifier hs-var">ValueArg</span></a></span><span>     </span><span class="hs-comment">-- Evaluated and we know it isn't these constructors</span><span>
</span><span id="line-1056"></span><span>              </span><span class="hs-comment">-- See Note [OtherCon and interestingArg]</span><span>
</span><span id="line-1057"></span><span>           </span><span class="annot"><a href="GHC.Core.html#DFunUnfolding"><span class="hs-identifier hs-type">DFunUnfolding</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ArgSummary
</span><a href="GHC.Core.Unfold.html#ValueArg"><span class="hs-identifier hs-var">ValueArg</span></a></span><span>   </span><span class="hs-comment">-- We konw that idArity=0</span><span>
</span><span id="line-1058"></span><span>           </span><span class="annot"><a href="GHC.Core.html#CoreUnfolding"><span class="hs-identifier hs-type">CoreUnfolding</span></a></span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">uf_cache :: Unfolding -&gt; UnfoldingCache
</span><a href="GHC.Core.html#uf_cache"><span class="hs-identifier hs-var">uf_cache</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977568"><span class="annot"><span class="annottext">UnfoldingCache
</span><a href="#local-6989586621682977568"><span class="hs-identifier hs-var">cache</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1059"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">UnfoldingCache -&gt; Bool
</span><a href="GHC.Core.html#uf_is_conlike"><span class="hs-identifier hs-var">uf_is_conlike</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingCache
</span><a href="#local-6989586621682977568"><span class="hs-identifier hs-var">cache</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ArgSummary
</span><a href="GHC.Core.Unfold.html#ValueArg"><span class="hs-identifier hs-var">ValueArg</span></a></span><span>    </span><span class="hs-comment">-- Includes constructor applications</span><span>
</span><span id="line-1060"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">UnfoldingCache -&gt; Bool
</span><a href="GHC.Core.html#uf_is_value"><span class="hs-identifier hs-var">uf_is_value</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingCache
</span><a href="#local-6989586621682977568"><span class="hs-identifier hs-var">cache</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ArgSummary
</span><a href="GHC.Core.Unfold.html#NonTrivArg"><span class="hs-identifier hs-var">NonTrivArg</span></a></span><span>  </span><span class="hs-comment">-- Things like partial applications</span><span>
</span><span id="line-1061"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ArgSummary
</span><a href="GHC.Core.Unfold.html#TrivArg"><span class="hs-identifier hs-var">TrivArg</span></a></span><span>
</span><span id="line-1062"></span><span>           </span><span class="annot"><span class="annottext">Unfolding
</span><a href="GHC.Core.html#BootUnfolding"><span class="hs-identifier hs-var">BootUnfolding</span></a></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ArgSummary
</span><a href="GHC.Core.Unfold.html#TrivArg"><span class="hs-identifier hs-var">TrivArg</span></a></span><span>
</span><span id="line-1063"></span><span>           </span><span class="annot"><span class="annottext">Unfolding
</span><a href="GHC.Core.html#NoUnfolding"><span class="hs-identifier hs-var">NoUnfolding</span></a></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ArgSummary
</span><a href="GHC.Core.Unfold.html#TrivArg"><span class="hs-identifier hs-var">TrivArg</span></a></span><span>
</span><span id="line-1064"></span><span>
</span><span id="line-1065"></span><span class="hs-comment">{- Note [OtherCon and interestingArg]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
interstingArg returns
   (a) NonTrivArg for an arg with an OtherCon [] unfolding
   (b) ValueArg for an arg with an OtherCon [c1,c2..] unfolding.

Reason for (a): I found (in the GHC.Num.Integer library) that I was
inlining a pretty big function when all we knew was that its arguments
were evaluated, nothing more.  That in turn make the enclosing function
too big to inline elsewhere.

Reason for (b): we want to inline integerCompare here
  integerLt# :: Integer -&gt; Integer -&gt; Bool#
  integerLt# (IS x) (IS y)                  = x &lt;# y
  integerLt# x y | LT &lt;- integerCompare x y = 1#
  integerLt# _ _                            = 0#

************************************************************************
*                                                                      *
                  SimplMode
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-1088"></span><span>
</span><span id="line-1089"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#updModeForStableUnfoldings"><span class="hs-identifier hs-type">updModeForStableUnfoldings</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Activation"><span class="hs-identifier hs-type">Activation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplMode"><span class="hs-identifier hs-type">SimplMode</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplMode"><span class="hs-identifier hs-type">SimplMode</span></a></span><span>
</span><span id="line-1090"></span><span class="hs-comment">-- See Note [The environments of the Simplify pass]</span><span>
</span><span id="line-1091"></span><span id="updModeForStableUnfoldings"><span class="annot"><span class="annottext">updModeForStableUnfoldings :: Activation -&gt; SimplMode -&gt; SimplMode
</span><a href="GHC.Core.Opt.Simplify.Utils.html#updModeForStableUnfoldings"><span class="hs-identifier hs-var hs-var">updModeForStableUnfoldings</span></a></span></span><span> </span><span id="local-6989586621682977573"><span class="annot"><span class="annottext">Activation
</span><a href="#local-6989586621682977573"><span class="hs-identifier hs-var">unf_act</span></a></span></span><span> </span><span id="local-6989586621682977574"><span class="annot"><span class="annottext">SimplMode
</span><a href="#local-6989586621682977574"><span class="hs-identifier hs-var">current_mode</span></a></span></span><span>
</span><span id="line-1092"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplMode
</span><a href="#local-6989586621682977574"><span class="hs-identifier hs-var">current_mode</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#sm_phase"><span class="hs-identifier hs-var">sm_phase</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682977576"><span class="hs-identifier hs-type">phaseFromActivation</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977573"><span class="hs-identifier hs-type">unf_act</span></a></span><span>
</span><span id="line-1093"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#sm_eta_expand"><span class="hs-identifier hs-var">sm_eta_expand</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span>
</span><span id="line-1094"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#sm_inline"><span class="hs-identifier hs-var">sm_inline</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">True</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1095"></span><span>       </span><span class="hs-comment">-- sm_eta_expand: see Note [Eta expansion in stable unfoldings and rules]</span><span>
</span><span id="line-1096"></span><span>       </span><span class="hs-comment">-- sm_rules: just inherit; sm_rules might be &quot;off&quot;</span><span>
</span><span id="line-1097"></span><span>       </span><span class="hs-comment">--           because of -fno-enable-rewrite-rules</span><span>
</span><span id="line-1098"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1099"></span><span>    </span><span id="local-6989586621682977576"><span class="annot"><span class="annottext">phaseFromActivation :: Activation -&gt; CompilerPhase
</span><a href="#local-6989586621682977576"><span class="hs-identifier hs-var hs-var">phaseFromActivation</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Basic.html#ActiveAfter"><span class="hs-identifier hs-type">ActiveAfter</span></a></span><span> </span><span class="annot"><span class="annottext">SourceText
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682977580"><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977580"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BranchCount -&gt; CompilerPhase
</span><a href="GHC.Types.Basic.html#Phase"><span class="hs-identifier hs-var">Phase</span></a></span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977580"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1100"></span><span>    </span><span class="annot"><a href="#local-6989586621682977576"><span class="hs-identifier hs-var">phaseFromActivation</span></a></span><span> </span><span class="annot"><span class="annottext">Activation
</span><span class="hs-identifier">_</span></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CompilerPhase
</span><a href="GHC.Types.Basic.html#InitialPhase"><span class="hs-identifier hs-var">InitialPhase</span></a></span><span>
</span><span id="line-1101"></span><span>
</span><span id="line-1102"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#updModeForRules"><span class="hs-identifier hs-type">updModeForRules</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplMode"><span class="hs-identifier hs-type">SimplMode</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplMode"><span class="hs-identifier hs-type">SimplMode</span></a></span><span>
</span><span id="line-1103"></span><span class="hs-comment">-- See Note [Simplifying rules]</span><span>
</span><span id="line-1104"></span><span class="hs-comment">-- See Note [The environments of the Simplify pass]</span><span>
</span><span id="line-1105"></span><span id="updModeForRules"><span class="annot"><span class="annottext">updModeForRules :: SimplMode -&gt; SimplMode
</span><a href="GHC.Core.Opt.Simplify.Utils.html#updModeForRules"><span class="hs-identifier hs-var hs-var">updModeForRules</span></a></span></span><span> </span><span id="local-6989586621682977583"><span class="annot"><span class="annottext">SimplMode
</span><a href="#local-6989586621682977583"><span class="hs-identifier hs-var">current_mode</span></a></span></span><span>
</span><span id="line-1106"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplMode
</span><a href="#local-6989586621682977583"><span class="hs-identifier hs-var">current_mode</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#sm_phase"><span class="hs-identifier hs-var">sm_phase</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#InitialPhase"><span class="hs-identifier hs-type">InitialPhase</span></a></span><span>
</span><span id="line-1107"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#sm_inline"><span class="hs-identifier hs-var">sm_inline</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span>
</span><span id="line-1108"></span><span>                      </span><span class="hs-comment">-- See Note [Do not expose strictness if sm_inline=False]</span><span>
</span><span id="line-1109"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#sm_rules"><span class="hs-identifier hs-var">sm_rules</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span>
</span><span id="line-1110"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#sm_cast_swizzle"><span class="hs-identifier hs-var">sm_cast_swizzle</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span>
</span><span id="line-1111"></span><span>                      </span><span class="hs-comment">-- See Note [Cast swizzling on rule LHSs]</span><span>
</span><span id="line-1112"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#sm_eta_expand"><span class="hs-identifier hs-var">sm_eta_expand</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1113"></span><span>
</span><span id="line-1114"></span><span class="hs-comment">{- Note [Simplifying rules]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When simplifying a rule LHS, refrain from /any/ inlining or applying
of other RULES. Doing anything to the LHS is plain confusing, because
it means that what the rule matches is not what the user
wrote. c.f. #10595, and #10528.

* sm_inline, sm_rules: inlining (or applying rules) on rule LHSs risks
  introducing Ticks into the LHS, which makes matching
  trickier. #10665, #10745.

  Doing this to either side confounds tools like HERMIT, which seek to reason
  about and apply the RULES as originally written. See #10829.

  See also Note [Do not expose strictness if sm_inline=False]

* sm_eta_expand: the template (LHS) of a rule must only mention coercion
  /variables/ not arbitrary coercions.  See Note [Casts in the template] in
  GHC.Core.Rules.  Eta expansion can create new coercions; so we switch
  it off.

There is, however, one case where we are pretty much /forced/ to transform the
LHS of a rule: postInlineUnconditionally. For instance, in the case of

    let f = g @Int in f

We very much want to inline f into the body of the let. However, to do so (and
be able to safely drop f's binding) we must inline into all occurrences of f,
including those in the LHS of rules.

This can cause somewhat surprising results; for instance, in #18162 we found
that a rule template contained ticks in its arguments, because
postInlineUnconditionally substituted in a trivial expression that contains
ticks. See Note [Tick annotations in RULE matching] in GHC.Core.Rules for
details.

Note [Cast swizzling on rule LHSs]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In the LHS of a RULE we may have
       (\x. blah |&gt; CoVar cv)
where `cv` is a coercion variable.  Critically, we really only want
coercion /variables/, not general coercions, on the LHS of a RULE.  So
we don't want to swizzle this to
      (\x. blah) |&gt; (Refl xty `FunCo` CoVar cv)
So we switch off cast swizzling in updModeForRules.

Note [Eta expansion in stable unfoldings and rules]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
SPJ Jul 22: whether or not eta-expansion is switched on in a stable
unfolding, or the RHS of a RULE, seems to be a bit moot. But switching
it on adds clutter, so I'm experimenting with switching off
eta-expansion in such places.

In the olden days, we really /wanted/ to switch it off.

    Old note: If we have a stable unfolding
      f :: Ord a =&gt; a -&gt; IO ()
      -- Unfolding template
      --    = /\a \(d:Ord a) (x:a). bla
    we do not want to eta-expand to
      f :: Ord a =&gt; a -&gt; IO ()
      -- Unfolding template
      --    = (/\a \(d:Ord a) (x:a) (eta:State#). bla eta) |&gt; co
    because now specialisation of the overloading doesn't work properly
    (see Note [Specialisation shape] in GHC.Core.Opt.Specialise), #9509.
    So we disable eta-expansion in stable unfoldings.

But this old note is no longer relevant because the specialiser has
improved: see Note [Account for casts in binding] in
GHC.Core.Opt.Specialise.  So we seem to have a free choice.

Note [Inlining in gentle mode]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Something is inlined if
   (i)   the sm_inline flag is on, AND
   (ii)  the thing has an INLINE pragma, AND
   (iii) the thing is inlinable in the earliest phase.

Example of why (iii) is important:
  {-# INLINE [~1] g #-}
  g = ...

  {-# INLINE f #-}
  f x = g (g x)

If we were to inline g into f's inlining, then an importing module would
never be able to do
        f e --&gt; g (g e) ---&gt; RULE fires
because the stable unfolding for f has had g inlined into it.

On the other hand, it is bad not to do ANY inlining into an
stable unfolding, because then recursive knots in instance declarations
don't get unravelled.

However, *sometimes* SimplGently must do no call-site inlining at all
(hence sm_inline = False).  Before full laziness we must be careful
not to inline wrappers, because doing so inhibits floating
    e.g. ...(case f x of ...)...
    ==&gt; ...(case (case x of I# x# -&gt; fw x#) of ...)...
    ==&gt; ...(case x of I# x# -&gt; case fw x# of ...)...
and now the redex (f x) isn't floatable any more.

The no-inlining thing is also important for Template Haskell.  You might be
compiling in one-shot mode with -O2; but when TH compiles a splice before
running it, we don't want to use -O2.  Indeed, we don't want to inline
anything, because the byte-code interpreter might get confused about
unboxed tuples and suchlike.

Note [Simplifying inside stable unfoldings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We must take care with simplification inside stable unfoldings (which come from
INLINE pragmas).

First, consider the following example
        let f = \pq -&gt; BIG
        in
        let g = \y -&gt; f y y
            {-# INLINE g #-}
        in ...g...g...g...g...g...
Now, if that's the ONLY occurrence of f, it might be inlined inside g,
and thence copied multiple times when g is inlined. HENCE we treat
any occurrence in a stable unfolding as a multiple occurrence, not a single
one; see OccurAnal.addRuleUsage.

Second, we do want *do* to some modest rules/inlining stuff in stable
unfoldings, partly to eliminate senseless crap, and partly to break
the recursive knots generated by instance declarations.

However, suppose we have
        {-# INLINE &lt;act&gt; f #-}
        f = &lt;rhs&gt;
meaning &quot;inline f in phases p where activation &lt;act&gt;(p) holds&quot;.
Then what inlinings/rules can we apply to the copy of &lt;rhs&gt; captured in
f's stable unfolding?  Our model is that literally &lt;rhs&gt; is substituted for
f when it is inlined.  So our conservative plan (implemented by
updModeForStableUnfoldings) is this:

  -------------------------------------------------------------
  When simplifying the RHS of a stable unfolding, set the phase
  to the phase in which the stable unfolding first becomes active
  -------------------------------------------------------------

That ensures that

  a) Rules/inlinings that *cease* being active before p will
     not apply to the stable unfolding, consistent with it being
     inlined in its *original* form in phase p.

  b) Rules/inlinings that only become active *after* p will
     not apply to the stable unfolding, again to be consistent with
     inlining the *original* rhs in phase p.

For example,
        {-# INLINE f #-}
        f x = ...g...

        {-# NOINLINE [1] g #-}
        g y = ...

        {-# RULE h g = ... #-}
Here we must not inline g into f's RHS, even when we get to phase 0,
because when f is later inlined into some other module we want the
rule for h to fire.

Similarly, consider
        {-# INLINE f #-}
        f x = ...g...

        g y = ...
and suppose that there are auto-generated specialisations and a strictness
wrapper for g.  The specialisations get activation AlwaysActive, and the
strictness wrapper get activation (ActiveAfter 0).  So the strictness
wrepper fails the test and won't be inlined into f's stable unfolding. That
means f can inline, expose the specialised call to g, so the specialisation
rules can fire.

A note about wrappers
~~~~~~~~~~~~~~~~~~~~~
It's also important not to inline a worker back into a wrapper.
A wrapper looks like
        wraper = inline_me (\x -&gt; ...worker... )
Normally, the inline_me prevents the worker getting inlined into
the wrapper (initially, the worker's only call site!).  But,
if the wrapper is sure to be called, the strictness analyser will
mark it 'demanded', so when the RHS is simplified, it'll get an ArgOf
continuation.
-}</span><span>
</span><span id="line-1301"></span><span>
</span><span id="line-1302"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#getUnfoldingInRuleMatch"><span class="hs-identifier hs-type">getUnfoldingInRuleMatch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InScopeEnv"><span class="hs-identifier hs-type">InScopeEnv</span></a></span><span>
</span><span id="line-1303"></span><span class="hs-comment">-- When matching in RULE, we want to &quot;look through&quot; an unfolding</span><span>
</span><span id="line-1304"></span><span class="hs-comment">-- (to see a constructor) if *rules* are on, even if *inlinings*</span><span>
</span><span id="line-1305"></span><span class="hs-comment">-- are not.  A notable example is DFuns, which really we want to</span><span>
</span><span id="line-1306"></span><span class="hs-comment">-- match in rules like (op dfun) in gentle mode. Another example</span><span>
</span><span id="line-1307"></span><span class="hs-comment">-- is 'otherwise' which we want exprIsConApp_maybe to be able to</span><span>
</span><span id="line-1308"></span><span class="hs-comment">-- see very early on</span><span>
</span><span id="line-1309"></span><span id="getUnfoldingInRuleMatch"><span class="annot"><span class="annottext">getUnfoldingInRuleMatch :: StaticEnv -&gt; InScopeEnv
</span><a href="GHC.Core.Opt.Simplify.Utils.html#getUnfoldingInRuleMatch"><span class="hs-identifier hs-var hs-var">getUnfoldingInRuleMatch</span></a></span></span><span> </span><span id="local-6989586621682977586"><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977586"><span class="hs-identifier hs-var">env</span></a></span></span><span>
</span><span id="line-1310"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; IdUnfoldingFun -&gt; InScopeEnv
</span><a href="GHC.Core.html#ISE"><span class="hs-identifier hs-var">ISE</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682977588"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">IdUnfoldingFun
</span><a href="#local-6989586621682977589"><span class="hs-identifier hs-var">id_unf</span></a></span><span>
</span><span id="line-1311"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1312"></span><span>    </span><span id="local-6989586621682977588"><span class="annot"><span class="annottext">in_scope :: InScopeSet
</span><a href="#local-6989586621682977588"><span class="hs-identifier hs-var hs-var">in_scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticEnv -&gt; InScopeSet
</span><a href="GHC.Core.Opt.Simplify.Env.html#seInScope"><span class="hs-identifier hs-var">seInScope</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977586"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1313"></span><span>    </span><span id="local-6989586621682977591"><span class="annot"><span class="annottext">phase :: CompilerPhase
</span><a href="#local-6989586621682977591"><span class="hs-identifier hs-var hs-var">phase</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticEnv -&gt; CompilerPhase
</span><a href="GHC.Core.Opt.Simplify.Env.html#sePhase"><span class="hs-identifier hs-var">sePhase</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977586"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1314"></span><span>    </span><span id="local-6989586621682977589"><span class="annot"><span class="annottext">id_unf :: IdUnfoldingFun
</span><a href="#local-6989586621682977589"><span class="hs-identifier hs-var hs-var">id_unf</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Activation -&gt; Bool) -&gt; IdUnfoldingFun
</span><a href="GHC.Types.Id.html#whenActiveUnfoldingFun"><span class="hs-identifier hs-var">whenActiveUnfoldingFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CompilerPhase -&gt; Activation -&gt; Bool
</span><a href="GHC.Types.Basic.html#isActive"><span class="hs-identifier hs-var">isActive</span></a></span><span> </span><span class="annot"><span class="annottext">CompilerPhase
</span><a href="#local-6989586621682977591"><span class="hs-identifier hs-var">phase</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1315"></span><span>     </span><span class="hs-comment">-- When sm_rules was off we used to test for a /stable/ unfolding,</span><span>
</span><span id="line-1316"></span><span>     </span><span class="hs-comment">-- but that seems wrong (#20941)</span><span>
</span><span id="line-1317"></span><span>
</span><span id="line-1318"></span><span class="hs-comment">----------------------</span><span>
</span><span id="line-1319"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#activeRule"><span class="hs-identifier hs-type">activeRule</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplMode"><span class="hs-identifier hs-type">SimplMode</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Activation"><span class="hs-identifier hs-type">Activation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1320"></span><span class="hs-comment">-- Nothing =&gt; No rules at all</span><span>
</span><span id="line-1321"></span><span id="activeRule"><span class="annot"><span class="annottext">activeRule :: SimplMode -&gt; Activation -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#activeRule"><span class="hs-identifier hs-var hs-var">activeRule</span></a></span></span><span> </span><span id="local-6989586621682977595"><span class="annot"><span class="annottext">SimplMode
</span><a href="#local-6989586621682977595"><span class="hs-identifier hs-var">mode</span></a></span></span><span>
</span><span id="line-1322"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplMode -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Env.html#sm_rules"><span class="hs-identifier hs-var">sm_rules</span></a></span><span> </span><span class="annot"><span class="annottext">SimplMode
</span><a href="#local-6989586621682977595"><span class="hs-identifier hs-var">mode</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">Activation
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>     </span><span class="hs-comment">-- Rewriting is off</span><span>
</span><span id="line-1323"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CompilerPhase -&gt; Activation -&gt; Bool
</span><a href="GHC.Types.Basic.html#isActive"><span class="hs-identifier hs-var">isActive</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplMode -&gt; CompilerPhase
</span><a href="GHC.Core.Opt.Simplify.Env.html#sm_phase"><span class="hs-identifier hs-var">sm_phase</span></a></span><span> </span><span class="annot"><span class="annottext">SimplMode
</span><a href="#local-6989586621682977595"><span class="hs-identifier hs-var">mode</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1324"></span><span>
</span><span id="line-1325"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
                  preInlineUnconditionally
*                                                                      *
************************************************************************

preInlineUnconditionally
~~~~~~~~~~~~~~~~~~~~~~~~
@preInlineUnconditionally@ examines a bndr to see if it is used just
once in a completely safe way, so that it is safe to discard the
binding inline its RHS at the (unique) usage site, REGARDLESS of how
big the RHS might be.  If this is the case we don't simplify the RHS
first, but just inline it un-simplified.

This is much better than first simplifying a perhaps-huge RHS and then
inlining and re-simplifying it.  Indeed, it can be at least quadratically
better.  Consider

        x1 = e1
        x2 = e2[x1]
        x3 = e3[x2]
        ...etc...
        xN = eN[xN-1]

We may end up simplifying e1 N times, e2 N-1 times, e3 N-3 times etc.
This can happen with cascades of functions too:

        f1 = \x1.e1
        f2 = \xs.e2[f1]
        f3 = \xs.e3[f3]
        ...etc...

THE MAIN INVARIANT is this:

        ----  preInlineUnconditionally invariant -----
   IF preInlineUnconditionally chooses to inline x = &lt;rhs&gt;
   THEN doing the inlining should not change the occurrence
        info for the free vars of &lt;rhs&gt;
        ----------------------------------------------

For example, it's tempting to look at trivial binding like
        x = y
and inline it unconditionally.  But suppose x is used many times,
but this is the unique occurrence of y.  Then inlining x would change
y's occurrence info, which breaks the invariant.  It matters: y
might have a BIG rhs, which will now be dup'd at every occurrence of x.


Even RHSs labelled InlineMe aren't caught here, because there might be
no benefit from inlining at the call site.

[Sept 01] Don't unconditionally inline a top-level thing, because that
can simply make a static thing into something built dynamically.  E.g.
        x = (a,b)
        main = \s -&gt; h x

[Remember that we treat \s as a one-shot lambda.]  No point in
inlining x unless there is something interesting about the call site.

But watch out: if you aren't careful, some useful foldr/build fusion
can be lost (most notably in spectral/hartel/parstof) because the
foldr didn't see the build.  Doing the dynamic allocation isn't a big
deal, in fact, but losing the fusion can be.  But the right thing here
seems to be to do a callSiteInline based on the fact that there is
something interesting about the call site (it's strict).  Hmm.  That
seems a bit fragile.

Conclusion: inline top level things gaily until FinalPhase (the last
phase), at which point don't.

Note [pre/postInlineUnconditionally in gentle mode]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Even in gentle mode we want to do preInlineUnconditionally.  The
reason is that too little clean-up happens if you don't inline
use-once things.  Also a bit of inlining is *good* for full laziness;
it can expose constant sub-expressions.  Example in
spectral/mandel/Mandel.hs, where the mandelset function gets a useful
let-float if you inline windowToViewport

However, as usual for Gentle mode, do not inline things that are
inactive in the initial stages.  See Note [Gentle mode].

Note [Stable unfoldings and preInlineUnconditionally]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Surprisingly, do not pre-inline-unconditionally Ids with INLINE pragmas!
Example

   {-# INLINE f #-}
   f :: Eq a =&gt; a -&gt; a
   f x = ...

   fInt :: Int -&gt; Int
   fInt = f Int dEqInt

   ...fInt...fInt...fInt...

Here f occurs just once, in the RHS of fInt. But if we inline it there
it might make fInt look big, and we'll lose the opportunity to inline f
at each of fInt's call sites.  The INLINE pragma will only inline when
the application is saturated for exactly this reason; and we don't
want PreInlineUnconditionally to second-guess it. A live example is #3736.
    c.f. Note [Stable unfoldings and postInlineUnconditionally]

NB: this only applies for INLINE things. Do /not/ switch off
preInlineUnconditionally for

* INLINABLE. It just says to GHC &quot;inline this if you like&quot;.  If there
  is a unique occurrence, we want to inline the stable unfolding, not
  the RHS.

* NONLINE[n] just switches off inlining until phase n.  We should
  respect that, but after phase n, just behave as usual.

* NoUserInlinePrag.  There is no pragma at all. This ends up on wrappers.
  (See #18815.)

Note [Top-level bottoming Ids]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Don't inline top-level Ids that are bottoming, even if they are used just
once, because FloatOut has gone to some trouble to extract them out.
Inlining them won't make the program run faster!

Note [Do not inline CoVars unconditionally]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Coercion variables appear inside coercions, and the RHS of a let-binding
is a term (not a coercion) so we can't necessarily inline the latter in
the former.
-}</span><span>
</span><span id="line-1454"></span><span>
</span><span id="line-1455"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#preInlineUnconditionally"><span class="hs-identifier hs-type">preInlineUnconditionally</span></a></span><span>
</span><span id="line-1456"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span>
</span><span id="line-1457"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StaticEnv"><span class="hs-identifier hs-type">StaticEnv</span></a></span><span>  </span><span class="hs-comment">-- These two go together</span><span>
</span><span id="line-1458"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span>       </span><span class="hs-comment">-- Returned env has extended substitution</span><span>
</span><span id="line-1459"></span><span class="hs-comment">-- Precondition: rhs satisfies the let-can-float invariant</span><span>
</span><span id="line-1460"></span><span class="hs-comment">-- See Note [Core let-can-float invariant] in GHC.Core</span><span>
</span><span id="line-1461"></span><span class="hs-comment">-- Reason: we don't want to inline single uses, or discard dead bindings,</span><span>
</span><span id="line-1462"></span><span class="hs-comment">--         for unlifted, side-effect-ful bindings</span><span>
</span><span id="line-1463"></span><span id="preInlineUnconditionally"><span class="annot"><span class="annottext">preInlineUnconditionally :: StaticEnv
-&gt; TopLevelFlag -&gt; Id -&gt; OutExpr -&gt; StaticEnv -&gt; Maybe StaticEnv
</span><a href="GHC.Core.Opt.Simplify.Utils.html#preInlineUnconditionally"><span class="hs-identifier hs-var hs-var">preInlineUnconditionally</span></a></span></span><span> </span><span id="local-6989586621682977596"><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977596"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682977597"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682977597"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621682977598"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977598"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682977599"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977599"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span id="local-6989586621682977600"><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977600"><span class="hs-identifier hs-var">rhs_env</span></a></span></span><span>
</span><span id="line-1464"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682977601"><span class="hs-identifier hs-var">pre_inline_unconditionally</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe StaticEnv
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1465"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682977602"><span class="hs-identifier hs-var">active</span></a></span><span>                               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe StaticEnv
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1466"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; Bool
</span><a href="GHC.Types.Basic.html#isTopLevel"><span class="hs-identifier hs-var">isTopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682977597"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isDeadEndId"><span class="hs-identifier hs-var">isDeadEndId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977598"><span class="hs-identifier hs-var">bndr</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe StaticEnv
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-comment">-- Note [Top-level bottoming Ids]</span><span>
</span><span id="line-1467"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977598"><span class="hs-identifier hs-var">bndr</span></a></span><span>                             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe StaticEnv
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-comment">-- Note [Do not inline CoVars unconditionally]</span><span>
</span><span id="line-1468"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#isExitJoinId"><span class="hs-identifier hs-var">isExitJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977598"><span class="hs-identifier hs-var">bndr</span></a></span><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe StaticEnv
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-comment">-- Note [Do not inline exit join points]</span><span>
</span><span id="line-1469"></span><span>                                                       </span><span class="hs-comment">-- in module Exitify</span><span>
</span><span id="line-1470"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OccInfo -&gt; Bool
</span><a href="#local-6989586621682977607"><span class="hs-identifier hs-var">one_occ</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; OccInfo
</span><a href="GHC.Types.Id.html#idOccInfo"><span class="hs-identifier hs-var">idOccInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977598"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe StaticEnv
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1471"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Unfolding -&gt; Bool
</span><a href="GHC.Core.html#isStableUnfolding"><span class="hs-identifier hs-var">isStableUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682977610"><span class="hs-identifier hs-var">unf</span></a></span><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticEnv -&gt; Maybe StaticEnv
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(StaticEnv -&gt; Maybe StaticEnv) -&gt; StaticEnv -&gt; Maybe StaticEnv
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutExpr -&gt; StaticEnv
</span><a href="#local-6989586621682977612"><span class="hs-identifier hs-var">extend_subst_with</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977599"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1472"></span><span>
</span><span id="line-1473"></span><span>  </span><span class="hs-comment">-- See Note [Stable unfoldings and preInlineUnconditionally]</span><span>
</span><span id="line-1474"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InlinePragma -&gt; Bool
</span><a href="GHC.Types.Basic.html#isInlinePragma"><span class="hs-identifier hs-var">isInlinePragma</span></a></span><span> </span><span class="annot"><span class="annottext">InlinePragma
</span><a href="#local-6989586621682977614"><span class="hs-identifier hs-var">inline_prag</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1475"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682977615"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977615"><span class="hs-identifier hs-var">inl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; Maybe OutExpr
</span><a href="GHC.Core.html#maybeUnfoldingTemplate"><span class="hs-identifier hs-var">maybeUnfoldingTemplate</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682977610"><span class="hs-identifier hs-var">unf</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticEnv -&gt; Maybe StaticEnv
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(StaticEnv -&gt; Maybe StaticEnv) -&gt; StaticEnv -&gt; Maybe StaticEnv
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutExpr -&gt; StaticEnv
</span><a href="#local-6989586621682977612"><span class="hs-identifier hs-var">extend_subst_with</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977615"><span class="hs-identifier hs-var">inl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1476"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe StaticEnv
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1477"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1478"></span><span>    </span><span id="local-6989586621682977610"><span class="annot"><span class="annottext">unf :: Unfolding
</span><a href="#local-6989586621682977610"><span class="hs-identifier hs-var hs-var">unf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdUnfoldingFun
</span><a href="GHC.Types.Id.html#idUnfolding"><span class="hs-identifier hs-var">idUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977598"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-1479"></span><span>    </span><span id="local-6989586621682977612"><span class="annot"><span class="annottext">extend_subst_with :: OutExpr -&gt; StaticEnv
</span><a href="#local-6989586621682977612"><span class="hs-identifier hs-var hs-var">extend_subst_with</span></a></span></span><span> </span><span id="local-6989586621682977617"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977617"><span class="hs-identifier hs-var">inl_rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticEnv -&gt; Id -&gt; SimplSR -&gt; StaticEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#extendIdSubst"><span class="hs-identifier hs-var">extendIdSubst</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977596"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977598"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">(SimplSR -&gt; StaticEnv) -&gt; SimplSR -&gt; StaticEnv
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StaticEnv -&gt; OutExpr -&gt; SimplSR
</span><a href="GHC.Core.Opt.Simplify.Env.html#mkContEx"><span class="hs-identifier hs-var">mkContEx</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977600"><span class="hs-identifier hs-var">rhs_env</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977617"><span class="hs-identifier hs-var">inl_rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1480"></span><span>
</span><span id="line-1481"></span><span>    </span><span id="local-6989586621682977607"><span class="annot"><span class="annottext">one_occ :: OccInfo -&gt; Bool
</span><a href="#local-6989586621682977607"><span class="hs-identifier hs-var hs-var">one_occ</span></a></span></span><span> </span><span class="annot"><span class="annottext">OccInfo
</span><a href="GHC.Types.Basic.html#IAmDead"><span class="hs-identifier hs-var">IAmDead</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-comment">-- Happens in ((\x.1) v)</span><span>
</span><span id="line-1482"></span><span>    </span><span class="annot"><a href="#local-6989586621682977607"><span class="hs-identifier hs-var">one_occ</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#OneOcc"><span class="hs-identifier hs-type">OneOcc</span></a></span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">occ_n_br :: OccInfo -&gt; BranchCount
</span><a href="GHC.Types.Basic.html#occ_n_br"><span class="hs-identifier hs-var">occ_n_br</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><span class="hs-number">1</span></span><span>
</span><span id="line-1483"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">occ_in_lam :: OccInfo -&gt; InsideLam
</span><a href="GHC.Types.Basic.html#occ_in_lam"><span class="hs-identifier hs-var">occ_in_lam</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InsideLam
</span><a href="GHC.Types.Basic.html#NotInsideLam"><span class="hs-identifier hs-var">NotInsideLam</span></a></span><span> </span><span class="hs-special">}</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; Bool
</span><a href="GHC.Types.Basic.html#isNotTopLevel"><span class="hs-identifier hs-var">isNotTopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682977597"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682977626"><span class="hs-identifier hs-var">early_phase</span></a></span><span>
</span><span id="line-1484"></span><span>    </span><span class="annot"><a href="#local-6989586621682977607"><span class="hs-identifier hs-var">one_occ</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#OneOcc"><span class="hs-identifier hs-type">OneOcc</span></a></span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">occ_n_br :: OccInfo -&gt; BranchCount
</span><a href="GHC.Types.Basic.html#occ_n_br"><span class="hs-identifier hs-var">occ_n_br</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><span class="hs-number">1</span></span><span>
</span><span id="line-1485"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">occ_in_lam :: OccInfo -&gt; InsideLam
</span><a href="GHC.Types.Basic.html#occ_in_lam"><span class="hs-identifier hs-var">occ_in_lam</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InsideLam
</span><a href="GHC.Types.Basic.html#IsInsideLam"><span class="hs-identifier hs-var">IsInsideLam</span></a></span><span>
</span><span id="line-1486"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">occ_int_cxt :: OccInfo -&gt; InterestingCxt
</span><a href="GHC.Types.Basic.html#occ_int_cxt"><span class="hs-identifier hs-var">occ_int_cxt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InterestingCxt
</span><a href="GHC.Types.Basic.html#IsInteresting"><span class="hs-identifier hs-var">IsInteresting</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; Bool
</span><a href="#local-6989586621682977630"><span class="hs-identifier hs-var">canInlineInLam</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977599"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1487"></span><span>    </span><span class="annot"><a href="#local-6989586621682977607"><span class="hs-identifier hs-var">one_occ</span></a></span><span> </span><span class="annot"><span class="annottext">OccInfo
</span><span class="hs-identifier">_</span></span><span>                                     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1488"></span><span>
</span><span id="line-1489"></span><span>    </span><span id="local-6989586621682977601"><span class="annot"><span class="annottext">pre_inline_unconditionally :: Bool
</span><a href="#local-6989586621682977601"><span class="hs-identifier hs-var hs-var">pre_inline_unconditionally</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticEnv -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Env.html#sePreInline"><span class="hs-identifier hs-var">sePreInline</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977596"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1490"></span><span>    </span><span id="local-6989586621682977602"><span class="annot"><span class="annottext">active :: Bool
</span><a href="#local-6989586621682977602"><span class="hs-identifier hs-var hs-var">active</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CompilerPhase -&gt; Activation -&gt; Bool
</span><a href="GHC.Types.Basic.html#isActive"><span class="hs-identifier hs-var">isActive</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StaticEnv -&gt; CompilerPhase
</span><a href="GHC.Core.Opt.Simplify.Env.html#sePhase"><span class="hs-identifier hs-var">sePhase</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977596"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InlinePragma -&gt; Activation
</span><a href="GHC.Types.Basic.html#inlinePragmaActivation"><span class="hs-identifier hs-var">inlinePragmaActivation</span></a></span><span> </span><span class="annot"><span class="annottext">InlinePragma
</span><a href="#local-6989586621682977614"><span class="hs-identifier hs-var">inline_prag</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1491"></span><span>             </span><span class="hs-comment">-- See Note [pre/postInlineUnconditionally in gentle mode]</span><span>
</span><span id="line-1492"></span><span>    </span><span id="local-6989586621682977614"><span class="annot"><span class="annottext">inline_prag :: InlinePragma
</span><a href="#local-6989586621682977614"><span class="hs-identifier hs-var hs-var">inline_prag</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; InlinePragma
</span><a href="GHC.Types.Id.html#idInlinePragma"><span class="hs-identifier hs-var">idInlinePragma</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977598"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-1493"></span><span>
</span><span id="line-1494"></span><span class="hs-comment">-- Be very careful before inlining inside a lambda, because (a) we must not</span><span>
</span><span id="line-1495"></span><span class="hs-comment">-- invalidate occurrence information, and (b) we want to avoid pushing a</span><span>
</span><span id="line-1496"></span><span class="hs-comment">-- single allocation (here) into multiple allocations (inside lambda).</span><span>
</span><span id="line-1497"></span><span class="hs-comment">-- Inlining a *function* with a single *saturated* call would be ok, mind you.</span><span>
</span><span id="line-1498"></span><span class="hs-comment">--      || (if is_cheap &amp;&amp; not (canInlineInLam rhs) then pprTrace &quot;preinline&quot; (ppr bndr &lt;+&gt; ppr rhs) ok else ok)</span><span>
</span><span id="line-1499"></span><span class="hs-comment">--      where</span><span>
</span><span id="line-1500"></span><span class="hs-comment">--              is_cheap = exprIsCheap rhs</span><span>
</span><span id="line-1501"></span><span class="hs-comment">--              ok = is_cheap &amp;&amp; int_cxt</span><span>
</span><span id="line-1502"></span><span>
</span><span id="line-1503"></span><span>        </span><span class="hs-comment">--      int_cxt         The context isn't totally boring</span><span>
</span><span id="line-1504"></span><span>        </span><span class="hs-comment">-- E.g. let f = \ab.BIG in \y. map f xs</span><span>
</span><span id="line-1505"></span><span>        </span><span class="hs-comment">--      Don't want to substitute for f, because then we allocate</span><span>
</span><span id="line-1506"></span><span>        </span><span class="hs-comment">--      its closure every time the \y is called</span><span>
</span><span id="line-1507"></span><span>        </span><span class="hs-comment">-- But: let f = \ab.BIG in \y. map (f y) xs</span><span>
</span><span id="line-1508"></span><span>        </span><span class="hs-comment">--      Now we do want to substitute for f, even though it's not</span><span>
</span><span id="line-1509"></span><span>        </span><span class="hs-comment">--      saturated, because we're going to allocate a closure for</span><span>
</span><span id="line-1510"></span><span>        </span><span class="hs-comment">--      (f y) every time round the loop anyhow.</span><span>
</span><span id="line-1511"></span><span>
</span><span id="line-1512"></span><span>        </span><span class="hs-comment">-- canInlineInLam =&gt; free vars of rhs are (Once in_lam) or Many,</span><span>
</span><span id="line-1513"></span><span>        </span><span class="hs-comment">-- so substituting rhs inside a lambda doesn't change the occ info.</span><span>
</span><span id="line-1514"></span><span>        </span><span class="hs-comment">-- Sadly, not quite the same as exprIsHNF.</span><span>
</span><span id="line-1515"></span><span>    </span><span id="local-6989586621682977630"><span class="annot"><span class="annottext">canInlineInLam :: OutExpr -&gt; Bool
</span><a href="#local-6989586621682977630"><span class="hs-identifier hs-var hs-var">canInlineInLam</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-type">Lit</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1516"></span><span>    </span><span class="annot"><a href="#local-6989586621682977630"><span class="hs-identifier hs-var">canInlineInLam</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621682977634"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977634"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682977635"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977635"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Core.html#isRuntimeVar"><span class="hs-identifier hs-var">isRuntimeVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977634"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; Bool
</span><a href="#local-6989586621682977630"><span class="hs-identifier hs-var">canInlineInLam</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977635"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1517"></span><span>    </span><span class="annot"><a href="#local-6989586621682977630"><span class="hs-identifier hs-var">canInlineInLam</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621682977637"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682977637"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621682977638"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977638"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishIsCode"><span class="hs-identifier hs-var">tickishIsCode</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682977637"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; Bool
</span><a href="#local-6989586621682977630"><span class="hs-identifier hs-var">canInlineInLam</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977638"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1518"></span><span>    </span><span class="annot"><a href="#local-6989586621682977630"><span class="hs-identifier hs-var">canInlineInLam</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><span class="hs-identifier">_</span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1519"></span><span>      </span><span class="hs-comment">-- not ticks.  Counting ticks cannot be duplicated, and non-counting</span><span>
</span><span id="line-1520"></span><span>      </span><span class="hs-comment">-- ticks around a Lam will disappear anyway.</span><span>
</span><span id="line-1521"></span><span>
</span><span id="line-1522"></span><span>    </span><span id="local-6989586621682977626"><span class="annot"><span class="annottext">early_phase :: Bool
</span><a href="#local-6989586621682977626"><span class="hs-identifier hs-var hs-var">early_phase</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticEnv -&gt; CompilerPhase
</span><a href="GHC.Core.Opt.Simplify.Env.html#sePhase"><span class="hs-identifier hs-var">sePhase</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977596"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CompilerPhase -&gt; CompilerPhase -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">CompilerPhase
</span><a href="GHC.Types.Basic.html#FinalPhase"><span class="hs-identifier hs-var">FinalPhase</span></a></span><span>
</span><span id="line-1523"></span><span>    </span><span class="hs-comment">-- If we don't have this early_phase test, consider</span><span>
</span><span id="line-1524"></span><span>    </span><span class="hs-comment">--      x = length [1,2,3]</span><span>
</span><span id="line-1525"></span><span>    </span><span class="hs-comment">-- The full laziness pass carefully floats all the cons cells to</span><span>
</span><span id="line-1526"></span><span>    </span><span class="hs-comment">-- top level, and preInlineUnconditionally floats them all back in.</span><span>
</span><span id="line-1527"></span><span>    </span><span class="hs-comment">-- Result is (a) static allocation replaced by dynamic allocation</span><span>
</span><span id="line-1528"></span><span>    </span><span class="hs-comment">--           (b) many simplifier iterations because this tickles</span><span>
</span><span id="line-1529"></span><span>    </span><span class="hs-comment">--               a related problem; only one inlining per pass</span><span>
</span><span id="line-1530"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-1531"></span><span>    </span><span class="hs-comment">-- On the other hand, I have seen cases where top-level fusion is</span><span>
</span><span id="line-1532"></span><span>    </span><span class="hs-comment">-- lost if we don't inline top level thing (e.g. string constants)</span><span>
</span><span id="line-1533"></span><span>    </span><span class="hs-comment">-- Hence the test for phase zero (which is the phase for all the final</span><span>
</span><span id="line-1534"></span><span>    </span><span class="hs-comment">-- simplifications).  Until phase zero we take no special notice of</span><span>
</span><span id="line-1535"></span><span>    </span><span class="hs-comment">-- top level things, but then we become more leery about inlining</span><span>
</span><span id="line-1536"></span><span>    </span><span class="hs-comment">-- them.</span><span>
</span><span id="line-1537"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-1538"></span><span>    </span><span class="hs-comment">-- What exactly to check in `early_phase` above is the subject of #17910.</span><span>
</span><span id="line-1539"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-1540"></span><span>    </span><span class="hs-comment">-- !10088 introduced an additional Simplifier iteration in LargeRecord</span><span>
</span><span id="line-1541"></span><span>    </span><span class="hs-comment">-- because we first FloatOut `case unsafeEqualityProof of ... -&gt; I# 2#`</span><span>
</span><span id="line-1542"></span><span>    </span><span class="hs-comment">-- (a non-trivial value) which we immediately inline back in.</span><span>
</span><span id="line-1543"></span><span>    </span><span class="hs-comment">-- Ideally, we'd never have inlined it because the binding turns out to</span><span>
</span><span id="line-1544"></span><span>    </span><span class="hs-comment">-- be expandable; unfortunately we need an iteration of the Simplifier to</span><span>
</span><span id="line-1545"></span><span>    </span><span class="hs-comment">-- attach the proper unfolding and can't check isExpandableUnfolding right</span><span>
</span><span id="line-1546"></span><span>    </span><span class="hs-comment">-- here.</span><span>
</span><span id="line-1547"></span><span>    </span><span class="hs-comment">-- (Nor can we check for `exprIsExpandable rhs`, because that needs to look</span><span>
</span><span id="line-1548"></span><span>    </span><span class="hs-comment">-- at the non-existent unfolding for the `I# 2#` which is also floated out.)</span><span>
</span><span id="line-1549"></span><span>
</span><span id="line-1550"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
                  postInlineUnconditionally
*                                                                      *
************************************************************************

postInlineUnconditionally
~~~~~~~~~~~~~~~~~~~~~~~~~
@postInlineUnconditionally@ decides whether to unconditionally inline
a thing based on the form of its RHS; in particular if it has a
trivial RHS.  If so, we can inline and discard the binding altogether.

NB: a loop breaker has must_keep_binding = True and non-loop-breakers
only have *forward* references. Hence, it's safe to discard the binding

NOTE: This isn't our last opportunity to inline.  We're at the binding
site right now, and we'll get another opportunity when we get to the
occurrence(s)

Note that we do this unconditional inlining only for trivial RHSs.
Don't inline even WHNFs inside lambdas; doing so may simply increase
allocation when the function is called. This isn't the last chance; see
NOTE above.

NB: Even inline pragmas (e.g. IMustBeINLINEd) are ignored here Why?
Because we don't even want to inline them into the RHS of constructor
arguments. See NOTE above

NB: At one time even NOINLINE was ignored here: if the rhs is trivial
it's best to inline it anyway.  We often get a=E; b=a from desugaring,
with both a and b marked NOINLINE.  But that seems incompatible with
our new view that inlining is like a RULE, so I'm sticking to the 'active'
story for now.

NB: unconditional inlining of this sort can introduce ticks in places that
may seem surprising; for instance, the LHS of rules. See Note [Simplifying
rules] for details.
-}</span><span>
</span><span id="line-1589"></span><span>
</span><span id="line-1590"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#postInlineUnconditionally"><span class="hs-identifier hs-type">postInlineUnconditionally</span></a></span><span>
</span><span id="line-1591"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BindContext"><span class="hs-identifier hs-type">BindContext</span></a></span><span>
</span><span id="line-1592"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span>    </span><span class="hs-comment">-- The binder (*not* a CoVar), including its unfolding</span><span>
</span><span id="line-1593"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>
</span><span id="line-1594"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1595"></span><span class="hs-comment">-- Precondition: rhs satisfies the let-can-float invariant</span><span>
</span><span id="line-1596"></span><span class="hs-comment">-- See Note [Core let-can-float invariant] in GHC.Core</span><span>
</span><span id="line-1597"></span><span class="hs-comment">-- Reason: we don't want to inline single uses, or discard dead bindings,</span><span>
</span><span id="line-1598"></span><span class="hs-comment">--         for unlifted, side-effect-ful bindings</span><span>
</span><span id="line-1599"></span><span id="postInlineUnconditionally"><span class="annot"><span class="annottext">postInlineUnconditionally :: StaticEnv -&gt; BindContext -&gt; Id -&gt; Id -&gt; OutExpr -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#postInlineUnconditionally"><span class="hs-identifier hs-var hs-var">postInlineUnconditionally</span></a></span></span><span> </span><span id="local-6989586621682977641"><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977641"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682977642"><span class="annot"><span class="annottext">BindContext
</span><a href="#local-6989586621682977642"><span class="hs-identifier hs-var">bind_cxt</span></a></span></span><span> </span><span id="local-6989586621682977643"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977643"><span class="hs-identifier hs-var">old_bndr</span></a></span></span><span> </span><span id="local-6989586621682977644"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977644"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682977645"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977645"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-1600"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682977646"><span class="hs-identifier hs-var">active</span></a></span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1601"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">OccInfo -&gt; Bool
</span><a href="GHC.Types.Basic.html#isWeakLoopBreaker"><span class="hs-identifier hs-var">isWeakLoopBreaker</span></a></span><span> </span><span class="annot"><span class="annottext">OccInfo
</span><a href="#local-6989586621682977648"><span class="hs-identifier hs-var">occ_info</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-comment">-- If it's a loop-breaker of any kind, don't inline</span><span>
</span><span id="line-1602"></span><span>                                        </span><span class="hs-comment">-- because it might be referred to &quot;earlier&quot;</span><span>
</span><span id="line-1603"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; Bool
</span><a href="GHC.Core.html#isStableUnfolding"><span class="hs-identifier hs-var">isStableUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682977649"><span class="hs-identifier hs-var">unfolding</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-comment">-- Note [Stable unfoldings and postInlineUnconditionally]</span><span>
</span><span id="line-1604"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; Bool
</span><a href="GHC.Types.Basic.html#isTopLevel"><span class="hs-identifier hs-var">isTopLevel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BindContext -&gt; TopLevelFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#bindContextLevel"><span class="hs-identifier hs-var">bindContextLevel</span></a></span><span> </span><span class="annot"><span class="annottext">BindContext
</span><a href="#local-6989586621682977642"><span class="hs-identifier hs-var">bind_cxt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1605"></span><span>                                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-comment">-- Note [Top level and postInlineUnconditionally]</span><span>
</span><span id="line-1606"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977645"><span class="hs-identifier hs-var">rhs</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1607"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BC_Join"><span class="hs-identifier hs-type">BC_Join</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BindContext
</span><a href="#local-6989586621682977642"><span class="hs-identifier hs-var">bind_cxt</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-comment">-- See point (1) of Note [Duplicating join points]</span><span>
</span><span id="line-1608"></span><span>                                        </span><span class="hs-comment">--     in GHC.Core.Opt.Simplify.Iteration</span><span>
</span><span id="line-1609"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1610"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">OccInfo
</span><a href="#local-6989586621682977648"><span class="hs-identifier hs-var">occ_info</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1611"></span><span>      </span><span class="annot"><a href="GHC.Types.Basic.html#OneOcc"><span class="hs-identifier hs-type">OneOcc</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">occ_in_lam :: OccInfo -&gt; InsideLam
</span><a href="GHC.Types.Basic.html#occ_in_lam"><span class="hs-identifier hs-var">occ_in_lam</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977651"><span class="annot"><span class="annottext">InsideLam
</span><a href="#local-6989586621682977651"><span class="hs-identifier hs-var">in_lam</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">occ_int_cxt :: OccInfo -&gt; InterestingCxt
</span><a href="GHC.Types.Basic.html#occ_int_cxt"><span class="hs-identifier hs-var">occ_int_cxt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977652"><span class="annot"><span class="annottext">InterestingCxt
</span><a href="#local-6989586621682977652"><span class="hs-identifier hs-var">int_cxt</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">occ_n_br :: OccInfo -&gt; BranchCount
</span><a href="GHC.Types.Basic.html#occ_n_br"><span class="hs-identifier hs-var">occ_n_br</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682977653"><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977653"><span class="hs-identifier hs-var">n_br</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1612"></span><span>        </span><span class="hs-comment">-- See Note [Inline small things to avoid creating a thunk]</span><span>
</span><span id="line-1613"></span><span>
</span><span id="line-1614"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977653"><span class="hs-identifier hs-var">n_br</span></a></span><span> </span><span class="annot"><span class="annottext">BranchCount -&gt; BranchCount -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><span class="hs-number">100</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>  </span><span class="hs-comment">-- See #23627</span><span>
</span><span id="line-1615"></span><span>
</span><span id="line-1616"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><a href="#local-6989586621682977653"><span class="hs-identifier hs-var">n_br</span></a></span><span> </span><span class="annot"><span class="annottext">BranchCount -&gt; BranchCount -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">BranchCount
</span><span class="hs-number">1</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InsideLam
</span><a href="GHC.Types.Basic.html#NotInsideLam"><span class="hs-identifier hs-var">NotInsideLam</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InsideLam
</span><a href="#local-6989586621682977651"><span class="hs-identifier hs-var">in_lam</span></a></span><span>  </span><span class="hs-comment">-- One syntactic occurrence</span><span>
</span><span id="line-1617"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>                              </span><span class="hs-comment">-- See Note [Post-inline for single-use things]</span><span>
</span><span id="line-1618"></span><span>
</span><span id="line-1619"></span><span class="hs-comment">--        | is_unlifted                        -- Unlifted binding, hence ok-for-spec</span><span>
</span><span id="line-1620"></span><span class="hs-comment">--        -&gt; True                              -- hence cheap to inline probably just a primop</span><span>
</span><span id="line-1621"></span><span class="hs-comment">--                                             -- Not a big deal either way</span><span>
</span><span id="line-1622"></span><span class="hs-comment">-- No, this is wrong.  {v = p +# q; x = K v}.</span><span>
</span><span id="line-1623"></span><span class="hs-comment">-- Don't inline v; it'll just get floated out again. Stupid.</span><span>
</span><span id="line-1624"></span><span>
</span><span id="line-1625"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682977654"><span class="hs-identifier hs-var">is_demanded</span></a></span><span>
</span><span id="line-1626"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>                            </span><span class="hs-comment">-- No allocation (it'll be a case expression in the end)</span><span>
</span><span id="line-1627"></span><span>                                            </span><span class="hs-comment">-- so inlining duplicates code but nothing more</span><span>
</span><span id="line-1628"></span><span>
</span><span id="line-1629"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1630"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InsideLam -&gt; InterestingCxt -&gt; Bool
</span><a href="#local-6989586621682977655"><span class="hs-identifier hs-var">work_ok</span></a></span><span> </span><span class="annot"><span class="annottext">InsideLam
</span><a href="#local-6989586621682977651"><span class="hs-identifier hs-var">in_lam</span></a></span><span> </span><span class="annot"><span class="annottext">InterestingCxt
</span><a href="#local-6989586621682977652"><span class="hs-identifier hs-var">int_cxt</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts -&gt; Unfolding -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Inline.html#smallEnoughToInline"><span class="hs-identifier hs-var">smallEnoughToInline</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682977656"><span class="hs-identifier hs-var">uf_opts</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682977649"><span class="hs-identifier hs-var">unfolding</span></a></span><span>
</span><span id="line-1631"></span><span>              </span><span class="hs-comment">-- Multiple syntactic occurences; but lazy, and small enough to dup</span><span>
</span><span id="line-1632"></span><span>              </span><span class="hs-comment">-- ToDo: consider discount on smallEnoughToInline if int_cxt is true</span><span>
</span><span id="line-1633"></span><span>
</span><span id="line-1634"></span><span>      </span><span class="annot"><span class="annottext">OccInfo
</span><a href="GHC.Types.Basic.html#IAmDead"><span class="hs-identifier hs-var">IAmDead</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>   </span><span class="hs-comment">-- This happens; for example, the case_bndr during case of</span><span>
</span><span id="line-1635"></span><span>                        </span><span class="hs-comment">-- known constructor:  case (a,b) of x { (p,q) -&gt; ... }</span><span>
</span><span id="line-1636"></span><span>                        </span><span class="hs-comment">-- Here x isn't mentioned in the RHS, so we don't want to</span><span>
</span><span id="line-1637"></span><span>                        </span><span class="hs-comment">-- create the (dead) let-binding  let x = (a,b) in ...</span><span>
</span><span id="line-1638"></span><span>
</span><span id="line-1639"></span><span>      </span><span class="annot"><span class="annottext">OccInfo
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1640"></span><span>
</span><span id="line-1641"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1642"></span><span>    </span><span id="local-6989586621682977655"><span class="annot"><span class="annottext">work_ok :: InsideLam -&gt; InterestingCxt -&gt; Bool
</span><a href="#local-6989586621682977655"><span class="hs-identifier hs-var hs-var">work_ok</span></a></span></span><span> </span><span class="annot"><span class="annottext">InsideLam
</span><a href="GHC.Types.Basic.html#NotInsideLam"><span class="hs-identifier hs-var">NotInsideLam</span></a></span><span> </span><span class="annot"><span class="annottext">InterestingCxt
</span><span class="hs-identifier">_</span></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1643"></span><span>    </span><span class="annot"><a href="#local-6989586621682977655"><span class="hs-identifier hs-var">work_ok</span></a></span><span> </span><span class="annot"><span class="annottext">InsideLam
</span><a href="GHC.Types.Basic.html#IsInsideLam"><span class="hs-identifier hs-var">IsInsideLam</span></a></span><span>  </span><span class="annot"><span class="annottext">InterestingCxt
</span><a href="GHC.Types.Basic.html#IsInteresting"><span class="hs-identifier hs-var">IsInteresting</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; Bool
</span><a href="GHC.Core.html#isCheapUnfolding"><span class="hs-identifier hs-var">isCheapUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682977649"><span class="hs-identifier hs-var">unfolding</span></a></span><span>
</span><span id="line-1644"></span><span>    </span><span class="annot"><a href="#local-6989586621682977655"><span class="hs-identifier hs-var">work_ok</span></a></span><span> </span><span class="annot"><span class="annottext">InsideLam
</span><a href="GHC.Types.Basic.html#IsInsideLam"><span class="hs-identifier hs-var">IsInsideLam</span></a></span><span>  </span><span class="annot"><span class="annottext">InterestingCxt
</span><a href="GHC.Types.Basic.html#NotInteresting"><span class="hs-identifier hs-var">NotInteresting</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1645"></span><span>      </span><span class="hs-comment">-- NotInsideLam: outside a lambda, we want to be reasonably aggressive</span><span>
</span><span id="line-1646"></span><span>      </span><span class="hs-comment">-- about inlining into multiple branches of case</span><span>
</span><span id="line-1647"></span><span>      </span><span class="hs-comment">-- e.g. let x = &lt;non-value&gt;</span><span>
</span><span id="line-1648"></span><span>      </span><span class="hs-comment">--      in case y of { C1 -&gt; ..x..; C2 -&gt; ..x..; C3 -&gt; ... }</span><span>
</span><span id="line-1649"></span><span>      </span><span class="hs-comment">-- Inlining can be a big win if C3 is the hot-spot, even if</span><span>
</span><span id="line-1650"></span><span>      </span><span class="hs-comment">-- the uses in C1, C2 are not 'interesting'</span><span>
</span><span id="line-1651"></span><span>      </span><span class="hs-comment">-- An example that gets worse if you add int_cxt here is 'clausify'</span><span>
</span><span id="line-1652"></span><span>
</span><span id="line-1653"></span><span>      </span><span class="hs-comment">-- InsideLam: check for acceptable work duplication, using isCheapUnfoldign</span><span>
</span><span id="line-1654"></span><span>      </span><span class="hs-comment">-- int_cxt to prevent us inlining inside a lambda without some</span><span>
</span><span id="line-1655"></span><span>      </span><span class="hs-comment">-- good reason.  See the notes on int_cxt in preInlineUnconditionally</span><span>
</span><span id="line-1656"></span><span>
</span><span id="line-1657"></span><span class="hs-comment">--    is_unlifted = isUnliftedType (idType bndr)</span><span>
</span><span id="line-1658"></span><span>    </span><span id="local-6989586621682977654"><span class="annot"><span class="annottext">is_demanded :: Bool
</span><a href="#local-6989586621682977654"><span class="hs-identifier hs-var hs-var">is_demanded</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Demand -&gt; Bool
</span><a href="GHC.Types.Demand.html#isStrUsedDmd"><span class="hs-identifier hs-var">isStrUsedDmd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Demand
</span><a href="GHC.Types.Id.html#idDemandInfo"><span class="hs-identifier hs-var">idDemandInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977644"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1659"></span><span>    </span><span id="local-6989586621682977648"><span class="annot"><span class="annottext">occ_info :: OccInfo
</span><a href="#local-6989586621682977648"><span class="hs-identifier hs-var hs-var">occ_info</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; OccInfo
</span><a href="GHC.Types.Id.html#idOccInfo"><span class="hs-identifier hs-var">idOccInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977643"><span class="hs-identifier hs-var">old_bndr</span></a></span><span>
</span><span id="line-1660"></span><span>    </span><span id="local-6989586621682977649"><span class="annot"><span class="annottext">unfolding :: Unfolding
</span><a href="#local-6989586621682977649"><span class="hs-identifier hs-var hs-var">unfolding</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdUnfoldingFun
</span><a href="GHC.Types.Id.html#idUnfolding"><span class="hs-identifier hs-var">idUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977644"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-1661"></span><span>    </span><span id="local-6989586621682977656"><span class="annot"><span class="annottext">uf_opts :: UnfoldingOpts
</span><a href="#local-6989586621682977656"><span class="hs-identifier hs-var hs-var">uf_opts</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticEnv -&gt; UnfoldingOpts
</span><a href="GHC.Core.Opt.Simplify.Env.html#seUnfoldingOpts"><span class="hs-identifier hs-var">seUnfoldingOpts</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977641"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1662"></span><span>    </span><span id="local-6989586621682977660"><span class="annot"><span class="annottext">phase :: CompilerPhase
</span><a href="#local-6989586621682977660"><span class="hs-identifier hs-var hs-var">phase</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticEnv -&gt; CompilerPhase
</span><a href="GHC.Core.Opt.Simplify.Env.html#sePhase"><span class="hs-identifier hs-var">sePhase</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977641"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1663"></span><span>    </span><span id="local-6989586621682977646"><span class="annot"><span class="annottext">active :: Bool
</span><a href="#local-6989586621682977646"><span class="hs-identifier hs-var hs-var">active</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CompilerPhase -&gt; Activation -&gt; Bool
</span><a href="GHC.Types.Basic.html#isActive"><span class="hs-identifier hs-var">isActive</span></a></span><span> </span><span class="annot"><span class="annottext">CompilerPhase
</span><a href="#local-6989586621682977660"><span class="hs-identifier hs-var">phase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Activation
</span><a href="GHC.Types.Id.html#idInlineActivation"><span class="hs-identifier hs-var">idInlineActivation</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977644"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1664"></span><span>        </span><span class="hs-comment">-- See Note [pre/postInlineUnconditionally in gentle mode]</span><span>
</span><span id="line-1665"></span><span>
</span><span id="line-1666"></span><span class="hs-comment">{- Note [Inline small things to avoid creating a thunk]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The point of examining occ_info here is that for *non-values* that
occur outside a lambda, the call-site inliner won't have a chance
(because it doesn't know that the thing only occurs once).  The
pre-inliner won't have gotten it either, if the thing occurs in more
than one branch So the main target is things like

     let x = f y in
     case v of
        True  -&gt; case x of ...
        False -&gt; case x of ...

This is very important in practice; e.g. wheel-seive1 doubles
in allocation if you miss this out.  And bits of GHC itself start
to allocate more.  An egregious example is test perf/compiler/T14697,
where GHC.Driver.CmdLine.$wprocessArgs allocated hugely more.

Note [Post-inline for single-use things]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we have

   let x = rhs in ...x...

and `x` is used exactly once, and not inside a lambda, then we will usually
preInlineUnconditinally. But we can still get this situation in
postInlineUnconditionally:

  case K rhs of K x -&gt; ...x....

Here we'll use `simplAuxBind` to bind `x` to (the already-simplified) `rhs`;
and `x` is used exactly once.  It's beneficial to inline right away; otherwise
we risk creating

   let x = rhs in ...x...

which will take another iteration of the Simplifier to eliminate.  We do this in
two places

1. In the full `postInlineUnconditionally` look for the special case
   of &quot;one occurrence, not under a lambda&quot;, and inline unconditionally then.

   This is a bit risky: see Note [Avoiding simplifying repeatedly] in
   Simplify.Iteration.  But in practice it seems to be a small win.

2. `simplAuxBind` does a kind of poor-man's `postInlineUnconditionally`.  It
   does not need to account for many of the cases (e.g. top level) that the
   full `postInlineUnconditionally` does.  Moreover, we don't have an
   OutId, which `postInlineUnconditionally` needs.  I got a slight improvement
   in compiler performance when I added this test.

Here's an example that we don't currently handle well:
     let f = if b then Left (\x.BIG) else Right (\y.BIG)
     in \y. ....case f of {...} ....
Here f is used just once, and duplicating the case work is fine (exprIsCheap).
But
 - We can't preInlineUnconditionally because that would invalidate
   the occ info for b.
 - We can't postInlineUnconditionally because the RHS is big, and
   that risks exponential behaviour
 - We can't call-site inline, because the rhs is big
Alas!


Note [Top level and postInlineUnconditionally]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We don't do postInlineUnconditionally for top-level things (even for
ones that are trivial):

  * Doing so will inline top-level error expressions that have been
    carefully floated out by FloatOut.  More generally, it might
    replace static allocation with dynamic.

  * Even for trivial expressions there's a problem.  Consider
      {-# RULE &quot;foo&quot; forall (xs::[T]). reverse xs = ruggle xs #-}
      blah xs = reverse xs
      ruggle = sort
    In one simplifier pass we might fire the rule, getting
      blah xs = ruggle xs
    but in *that* simplifier pass we must not do postInlineUnconditionally
    on 'ruggle' because then we'll have an unbound occurrence of 'ruggle'

    If the rhs is trivial it'll be inlined by callSiteInline, and then
    the binding will be dead and discarded by the next use of OccurAnal

  * There is less point, because the main goal is to get rid of local
    bindings used in multiple case branches.

  * The inliner should inline trivial things at call sites anyway.

  * The Id might be exported.  We could check for that separately,
    but since we aren't going to postInlineUnconditionally /any/
    top-level bindings, we don't need to test.

Note [Stable unfoldings and postInlineUnconditionally]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Do not do postInlineUnconditionally if the Id has a stable unfolding,
otherwise we lose the unfolding.  Example

     -- f has stable unfolding with rhs (e |&gt; co)
     --   where 'e' is big
     f = e |&gt; co

Then there's a danger we'll optimise to

     f' = e
     f = f' |&gt; co

and now postInlineUnconditionally, losing the stable unfolding on f.  Now f'
won't inline because 'e' is too big.

    c.f. Note [Stable unfoldings and preInlineUnconditionally]


************************************************************************
*                                                                      *
        Rebuilding a lambda
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-1786"></span><span>
</span><span id="line-1787"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#rebuildLam"><span class="hs-identifier hs-type">rebuildLam</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span>
</span><span id="line-1788"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#OutBndr"><span class="hs-identifier hs-type">OutBndr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>
</span><span id="line-1789"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-1790"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>
</span><span id="line-1791"></span><span class="hs-comment">-- (rebuildLam env bndrs body cont)</span><span>
</span><span id="line-1792"></span><span class="hs-comment">-- returns expr which means the same as \bndrs. body</span><span>
</span><span id="line-1793"></span><span class="hs-comment">--</span><span>
</span><span id="line-1794"></span><span class="hs-comment">-- But it tries</span><span>
</span><span id="line-1795"></span><span class="hs-comment">--      a) eta reduction, if that gives a trivial expression</span><span>
</span><span id="line-1796"></span><span class="hs-comment">--      b) eta expansion [only if there are some value lambdas]</span><span>
</span><span id="line-1797"></span><span class="hs-comment">--</span><span>
</span><span id="line-1798"></span><span class="hs-comment">-- NB: the SimplEnv already includes the [OutBndr] in its in-scope set</span><span>
</span><span id="line-1799"></span><span>
</span><span id="line-1800"></span><span id="rebuildLam"><span class="annot"><span class="annottext">rebuildLam :: StaticEnv -&gt; [Id] -&gt; OutExpr -&gt; SimplCont -&gt; SimplM OutExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#rebuildLam"><span class="hs-identifier hs-var hs-var">rebuildLam</span></a></span></span><span> </span><span id="local-6989586621682977663"><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977663"><span class="hs-identifier hs-var">_env</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621682977664"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977664"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621682977665"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977665"><span class="hs-identifier hs-var">_cont</span></a></span></span><span>
</span><span id="line-1801"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; SimplM OutExpr
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977664"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-1802"></span><span>
</span><span id="line-1803"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#rebuildLam"><span class="hs-identifier hs-var">rebuildLam</span></a></span><span> </span><span id="local-6989586621682977666"><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977666"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682977667"><span class="annot"><span class="annottext">bndrs :: [Id]
</span><a href="#local-6989586621682977667"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621682977668"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977668"><span class="hs-identifier hs-var">bndr</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[Id]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682977669"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977669"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621682977670"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977670"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-1804"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;rebuildLam&quot;</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; OutExpr -&gt; SimplM OutExpr
</span><a href="#local-6989586621682977671"><span class="hs-identifier hs-var">try_eta</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977667"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977669"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-1805"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1806"></span><span>    </span><span id="local-6989586621682977672"><span class="annot"><span class="annottext">rec_ids :: UnVarSet
</span><a href="#local-6989586621682977672"><span class="hs-identifier hs-var hs-var">rec_ids</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticEnv -&gt; UnVarSet
</span><a href="GHC.Core.Opt.Simplify.Env.html#seRecIds"><span class="hs-identifier hs-var">seRecIds</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977666"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1807"></span><span>    </span><span id="local-6989586621682977674"><span class="annot"><span class="annottext">in_scope :: InScopeSet
</span><a href="#local-6989586621682977674"><span class="hs-identifier hs-var hs-var">in_scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticEnv -&gt; InScopeSet
</span><a href="GHC.Core.Opt.Simplify.Env.html#getInScope"><span class="hs-identifier hs-var">getInScope</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977666"><span class="hs-identifier hs-var">env</span></a></span><span>  </span><span class="hs-comment">-- Includes 'bndrs'</span><span>
</span><span id="line-1808"></span><span>    </span><span id="local-6989586621682977676"><span class="annot"><span class="annottext">mb_rhs :: Maybe RecFlag
</span><a href="#local-6989586621682977676"><span class="hs-identifier hs-var hs-var">mb_rhs</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Maybe RecFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contIsRhs"><span class="hs-identifier hs-var">contIsRhs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977670"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1809"></span><span>
</span><span id="line-1810"></span><span>    </span><span class="hs-comment">-- See Note [Eta reduction based on evaluation context]</span><span>
</span><span id="line-1811"></span><span>    </span><span id="local-6989586621682977677"><span class="annot"><span class="annottext">eval_sd :: SubDemand
</span><a href="#local-6989586621682977677"><span class="hs-identifier hs-var hs-var">eval_sd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; SubDemand
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contEvalContext"><span class="hs-identifier hs-var">contEvalContext</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682977670"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1812"></span><span>        </span><span class="hs-comment">-- NB: cont is never ApplyToVal, because beta-reduction would</span><span>
</span><span id="line-1813"></span><span>        </span><span class="hs-comment">-- have happened.  So contEvalContext can panic on ApplyToVal.</span><span>
</span><span id="line-1814"></span><span>
</span><span id="line-1815"></span><span>    </span><span class="annot"><a href="#local-6989586621682977671"><span class="hs-identifier hs-type">try_eta</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#OutBndr"><span class="hs-identifier hs-type">OutBndr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>
</span><span id="line-1816"></span><span>    </span><span id="local-6989586621682977671"><span class="annot"><span class="annottext">try_eta :: [Id] -&gt; OutExpr -&gt; SimplM OutExpr
</span><a href="#local-6989586621682977671"><span class="hs-identifier hs-var hs-var">try_eta</span></a></span></span><span> </span><span id="local-6989586621682977678"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977678"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span id="local-6989586621682977679"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977679"><span class="hs-identifier hs-var">body</span></a></span></span><span>
</span><span id="line-1817"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-comment">-- Try eta reduction</span><span>
</span><span id="line-1818"></span><span>        </span><span class="annot"><span class="annottext">StaticEnv -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Env.html#seDoEtaReduction"><span class="hs-identifier hs-var">seDoEtaReduction</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977666"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1819"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682977681"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977681"><span class="hs-identifier hs-var">etad_lam</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UnVarSet -&gt; [Id] -&gt; OutExpr -&gt; SubDemand -&gt; Maybe OutExpr
</span><a href="GHC.Core.Opt.Arity.html#tryEtaReduce"><span class="hs-identifier hs-var">tryEtaReduce</span></a></span><span> </span><span class="annot"><span class="annottext">UnVarSet
</span><a href="#local-6989586621682977672"><span class="hs-identifier hs-var">rec_ids</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977678"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977679"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621682977677"><span class="hs-identifier hs-var">eval_sd</span></a></span><span>
</span><span id="line-1820"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Tick -&gt; SimplM ()
</span><a href="GHC.Core.Opt.Simplify.Monad.html#tick"><span class="hs-identifier hs-var">tick</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Tick
</span><a href="GHC.Core.Opt.Stats.html#EtaReduction"><span class="hs-identifier hs-var">EtaReduction</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977668"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1821"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; SimplM OutExpr
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977681"><span class="hs-identifier hs-var">etad_lam</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1822"></span><span>
</span><span id="line-1823"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-comment">-- Try eta expansion</span><span>
</span><span id="line-1824"></span><span>        </span><span class="annot"><span class="annottext">Maybe RecFlag
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe RecFlag
</span><a href="#local-6989586621682977676"><span class="hs-identifier hs-var">mb_rhs</span></a></span><span>  </span><span class="hs-comment">-- See Note [Eta expanding lambdas]</span><span>
</span><span id="line-1825"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticEnv -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Env.html#seEtaExpand"><span class="hs-identifier hs-var">seEtaExpand</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977666"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1826"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; [Id] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Core.html#isRuntimeVar"><span class="hs-identifier hs-var">isRuntimeVar</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977678"><span class="hs-identifier hs-var">bndrs</span></a></span><span>  </span><span class="hs-comment">-- Only when there is at least one value lambda already</span><span>
</span><span id="line-1827"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682977687"><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682977687"><span class="hs-identifier hs-var">body_arity</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; ArityOpts -&gt; OutExpr -&gt; Maybe SafeArityType
ArityOpts -&gt; OutExpr -&gt; Maybe SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#exprEtaExpandArity"><span class="hs-identifier hs-var">exprEtaExpandArity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StaticEnv -&gt; ArityOpts
</span><a href="GHC.Core.Opt.Simplify.Env.html#seArityOpts"><span class="hs-identifier hs-var">seArityOpts</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977666"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977679"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-1828"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Tick -&gt; SimplM ()
</span><a href="GHC.Core.Opt.Simplify.Monad.html#tick"><span class="hs-identifier hs-var">tick</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Tick
</span><a href="GHC.Core.Opt.Stats.html#EtaExpansion"><span class="hs-identifier hs-var">EtaExpansion</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977668"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1829"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682977691"><span class="annot"><span class="annottext">body' :: OutExpr
</span><a href="#local-6989586621682977691"><span class="hs-identifier hs-var hs-var hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; SafeArityType -&gt; OutExpr -&gt; OutExpr
</span><a href="GHC.Core.Opt.Arity.html#etaExpandAT"><span class="hs-identifier hs-var">etaExpandAT</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682977674"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682977687"><span class="hs-identifier hs-var">body_arity</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977679"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-1830"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; SimplM ()
</span><a href="GHC.Core.Opt.Simplify.Monad.html#traceSmpl"><span class="hs-identifier hs-var">traceSmpl</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;eta expand&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;before&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977679"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-1831"></span><span>                                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;after&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977691"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1832"></span><span>           </span><span class="hs-comment">-- NB: body' might have an outer Cast, but if so</span><span>
</span><span id="line-1833"></span><span>           </span><span class="hs-comment">--     mk_lams will pull it further out, past 'bndrs' to the top</span><span>
</span><span id="line-1834"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; SimplM OutExpr
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id] -&gt; OutExpr -&gt; OutExpr
</span><a href="#local-6989586621682977695"><span class="hs-identifier hs-var">mk_lams</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977678"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977691"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1835"></span><span>
</span><span id="line-1836"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1837"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; SimplM OutExpr
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id] -&gt; OutExpr -&gt; OutExpr
</span><a href="#local-6989586621682977695"><span class="hs-identifier hs-var">mk_lams</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977678"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977679"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1838"></span><span>
</span><span id="line-1839"></span><span>    </span><span class="annot"><a href="#local-6989586621682977695"><span class="hs-identifier hs-type">mk_lams</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#OutBndr"><span class="hs-identifier hs-type">OutBndr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>
</span><span id="line-1840"></span><span>    </span><span class="hs-comment">-- mk_lams pulls casts and ticks to the top</span><span>
</span><span id="line-1841"></span><span>    </span><span id="local-6989586621682977695"><span class="annot"><span class="annottext">mk_lams :: [Id] -&gt; OutExpr -&gt; OutExpr
</span><a href="#local-6989586621682977695"><span class="hs-identifier hs-var hs-var">mk_lams</span></a></span></span><span> </span><span id="local-6989586621682977696"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977696"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span id="local-6989586621682977697"><span class="annot"><span class="annottext">body :: OutExpr
</span><a href="#local-6989586621682977697"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1842"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; OutExpr -&gt; OutExpr
</span><a href="#local-6989586621682977695"><span class="hs-identifier hs-var">mk_lams</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977696"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Id] -&gt; [Id]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977698"><span class="hs-identifier hs-var">bndrs1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977699"><span class="hs-identifier hs-var">body1</span></a></span><span>
</span><span id="line-1843"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-1844"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621682977698"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977698"><span class="hs-identifier hs-var">bndrs1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682977699"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977699"><span class="hs-identifier hs-var">body1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; ([Id], OutExpr)
forall b. Expr b -&gt; ([b], Expr b)
</span><a href="GHC.Core.html#collectBinders"><span class="hs-identifier hs-var">collectBinders</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977697"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-1845"></span><span>
</span><span id="line-1846"></span><span>    </span><span class="annot"><a href="#local-6989586621682977695"><span class="hs-identifier hs-var">mk_lams</span></a></span><span> </span><span id="local-6989586621682977701"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977701"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621682977702"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682977702"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621682977703"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977703"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1847"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682977702"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-1848"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; OutExpr -&gt; OutExpr
</span><a href="GHC.Core.Utils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682977702"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id] -&gt; OutExpr -&gt; OutExpr
</span><a href="#local-6989586621682977695"><span class="hs-identifier hs-var">mk_lams</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977701"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977703"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1849"></span><span>
</span><span id="line-1850"></span><span>    </span><span class="annot"><a href="#local-6989586621682977695"><span class="hs-identifier hs-var">mk_lams</span></a></span><span> </span><span id="local-6989586621682977706"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977706"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682977707"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977707"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621682977708"><span class="annot"><span class="annottext">OutCoercion
</span><a href="#local-6989586621682977708"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1851"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-comment">-- Note [Casts and lambdas]</span><span>
</span><span id="line-1852"></span><span>        </span><span class="annot"><span class="annottext">StaticEnv -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Env.html#seCastSwizzle"><span class="hs-identifier hs-var">seCastSwizzle</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977666"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1853"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; [Id] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="#local-6989586621682977710"><span class="hs-identifier hs-var">bad</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977706"><span class="hs-identifier hs-var">bndrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1854"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; OutExpr -&gt; OutCoercion -&gt; OutExpr
OutExpr -&gt; OutCoercion -&gt; OutExpr
</span><a href="GHC.Core.Utils.html#mkCast"><span class="hs-identifier hs-var">mkCast</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id] -&gt; OutExpr -&gt; OutExpr
</span><a href="#local-6989586621682977695"><span class="hs-identifier hs-var">mk_lams</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977706"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977707"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; [Id] -&gt; OutCoercion -&gt; OutCoercion
</span><a href="GHC.Core.Coercion.html#mkPiCos"><span class="hs-identifier hs-var">mkPiCos</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Representational"><span class="hs-identifier hs-var">Representational</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977706"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">OutCoercion
</span><a href="#local-6989586621682977708"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1855"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-1856"></span><span>        </span><span id="local-6989586621682977713"><span class="annot"><span class="annottext">co_vars :: TyCoVarSet
</span><a href="#local-6989586621682977713"><span class="hs-identifier hs-var hs-var">co_vars</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutCoercion -&gt; TyCoVarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfCo"><span class="hs-identifier hs-var">tyCoVarsOfCo</span></a></span><span> </span><span class="annot"><span class="annottext">OutCoercion
</span><a href="#local-6989586621682977708"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1857"></span><span>        </span><span id="local-6989586621682977710"><span class="annot"><span class="annottext">bad :: Id -&gt; Bool
</span><a href="#local-6989586621682977710"><span class="hs-identifier hs-var hs-var">bad</span></a></span></span><span> </span><span id="local-6989586621682977715"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977715"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977715"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977715"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; TyCoVarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">TyCoVarSet
</span><a href="#local-6989586621682977713"><span class="hs-identifier hs-var">co_vars</span></a></span><span>
</span><span id="line-1858"></span><span>
</span><span id="line-1859"></span><span>    </span><span class="annot"><a href="#local-6989586621682977695"><span class="hs-identifier hs-var">mk_lams</span></a></span><span> </span><span id="local-6989586621682977717"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977717"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span id="local-6989586621682977718"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977718"><span class="hs-identifier hs-var">body</span></a></span></span><span>
</span><span id="line-1860"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; OutExpr -&gt; OutExpr
forall b. [b] -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#mkLams"><span class="hs-identifier hs-var">mkLams</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977717"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977718"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-1861"></span><span>
</span><span id="line-1862"></span><span class="hs-comment">{-
Note [Eta expanding lambdas]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In general we *do* want to eta-expand lambdas. Consider
   f (\x -&gt; case x of (a,b) -&gt; \s -&gt; blah)
where 's' is a state token, and hence can be eta expanded.  This
showed up in the code for GHc.IO.Handle.Text.hPutChar, a rather
important function!

The eta-expansion will never happen unless we do it now.  (Well, it's
possible that CorePrep will do it, but CorePrep only has a half-baked
eta-expander that can't deal with casts.  So it's much better to do it
here.)

However, when the lambda is let-bound, as the RHS of a let, we have a
better eta-expander (in the form of tryEtaExpandRhs), so we don't
bother to try expansion in mkLam in that case; hence the contIsRhs
guard.

Note [Casts and lambdas]
~~~~~~~~~~~~~~~~~~~~~~~~
Consider
        (\(x:tx). (\(y:ty). e) `cast` co)

We float the cast out, thus
        (\(x:tx) (y:ty). e) `cast` (tx -&gt; co)

We do this for at least three reasons:

1. There is a danger here that the two lambdas look separated, and the
   full laziness pass might float an expression to between the two.

2. The occurrence analyser will mark x as InsideLam if the Lam nodes
   are separated (see the Lam case of occAnal).  By floating the cast
   out we put the two Lams together, so x can get a vanilla Once
   annotation.  If this lambda is the RHS of a let, which we inline,
   we can do preInlineUnconditionally on that x=arg binding.  With the
   InsideLam OccInfo, we can't do that, which results in an extra
   iteration of the Simplifier.

3. It may cancel with another cast.  E.g
      (\x. e |&gt; co1) |&gt; co2
   If we float out co1 it might cancel with co2.  Similarly
      let f = (\x. e |&gt; co1) in ...
   If we float out co1, and then do cast worker/wrapper, we get
      let f1 = \x.e; f = f1 |&gt; co1 in ...
   and now we can inline f, hoping that co1 may cancel at a call site.

TL;DR: put the lambdas together if at all possible.

In general, here's the transformation:
        \x. e `cast` co   ===&gt;   (\x. e) `cast` (tx -&gt; co)
        /\a. e `cast` co  ===&gt;   (/\a. e) `cast` (/\a. co)
        /\g. e `cast` co  ===&gt;   (/\g. e) `cast` (/\g. co)
                          (if not (g `in` co))

We call this &quot;cast swizzling&quot;. It is controlled by sm_cast_swizzle.
See also Note [Cast swizzling on rule LHSs]

Wrinkles

* Notice that it works regardless of 'e'.  Originally it worked only
  if 'e' was itself a lambda, but in some cases that resulted in
  fruitless iteration in the simplifier.  A good example was when
  compiling Text.ParserCombinators.ReadPrec, where we had a definition
  like    (\x. Get `cast` g)
  where Get is a constructor with nonzero arity.  Then mkLam eta-expanded
  the Get, and the next iteration eta-reduced it, and then eta-expanded
  it again.

* Note also the side condition for the case of coercion binders, namely
  not (any bad bndrs).  It does not make sense to transform
          /\g. e `cast` g  ==&gt;  (/\g.e) `cast` (/\g.g)
  because the latter is not well-kinded.


************************************************************************
*                                                                      *
              Eta expansion
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-1944"></span><span>
</span><span id="line-1945"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#tryEtaExpandRhs"><span class="hs-identifier hs-type">tryEtaExpandRhs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BindContext"><span class="hs-identifier hs-type">BindContext</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>
</span><span id="line-1946"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1947"></span><span class="hs-comment">-- See Note [Eta-expanding at let bindings]</span><span>
</span><span id="line-1948"></span><span id="tryEtaExpandRhs"><span class="annot"><span class="annottext">tryEtaExpandRhs :: StaticEnv
-&gt; BindContext -&gt; Id -&gt; OutExpr -&gt; SimplM (SafeArityType, OutExpr)
</span><a href="GHC.Core.Opt.Simplify.Utils.html#tryEtaExpandRhs"><span class="hs-identifier hs-var hs-var">tryEtaExpandRhs</span></a></span></span><span> </span><span id="local-6989586621682977721"><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977721"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682977722"><span class="annot"><span class="annottext">BindContext
</span><a href="#local-6989586621682977722"><span class="hs-identifier hs-var">bind_cxt</span></a></span></span><span> </span><span id="local-6989586621682977723"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977723"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682977724"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977724"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-1949"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">StaticEnv -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Env.html#seEtaExpand"><span class="hs-identifier hs-var">seEtaExpand</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977721"><span class="hs-identifier hs-var">env</span></a></span><span>         </span><span class="hs-comment">-- If Eta-expansion is on</span><span>
</span><span id="line-1950"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#wantEtaExpansion"><span class="hs-identifier hs-var">wantEtaExpansion</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977724"><span class="hs-identifier hs-var">rhs</span></a></span><span>    </span><span class="hs-comment">-- and we'd like to eta-expand e</span><span>
</span><span id="line-1951"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682977725"><span class="hs-identifier hs-var">do_eta_expand</span></a></span><span>           </span><span class="hs-comment">-- and e's manifest arity is lower than</span><span>
</span><span id="line-1952"></span><span>                            </span><span class="hs-comment">--     what it could be</span><span>
</span><span id="line-1953"></span><span>                            </span><span class="hs-comment">--     (never true for join points)</span><span>
</span><span id="line-1954"></span><span>  </span><span class="hs-glyph">=</span><span>                         </span><span class="hs-comment">-- Do eta-expansion.</span><span>
</span><span id="line-1955"></span><span>    </span><span class="annot"><span class="annottext">Bool
-&gt; SDoc
-&gt; SimplM (SafeArityType, OutExpr)
-&gt; SimplM (SafeArityType, OutExpr)
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BindContext -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#isJoinBC"><span class="hs-identifier hs-var">isJoinBC</span></a></span><span> </span><span class="annot"><span class="annottext">BindContext
</span><a href="#local-6989586621682977722"><span class="hs-identifier hs-var">bind_cxt</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977723"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SimplM (SafeArityType, OutExpr)
 -&gt; SimplM (SafeArityType, OutExpr))
-&gt; SimplM (SafeArityType, OutExpr)
-&gt; SimplM (SafeArityType, OutExpr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1956"></span><span>       </span><span class="hs-comment">-- assert: this never happens for join points; see GHC.Core.Opt.Arity</span><span>
</span><span id="line-1957"></span><span>       </span><span class="hs-comment">--         Note [Do not eta-expand join points]</span><span>
</span><span id="line-1958"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Tick -&gt; SimplM ()
</span><a href="GHC.Core.Opt.Simplify.Monad.html#tick"><span class="hs-identifier hs-var">tick</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Tick
</span><a href="GHC.Core.Opt.Stats.html#EtaExpansion"><span class="hs-identifier hs-var">EtaExpansion</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977723"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1959"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(SafeArityType, OutExpr) -&gt; SimplM (SafeArityType, OutExpr)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682977727"><span class="hs-identifier hs-var">arity_type</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; SafeArityType -&gt; OutExpr -&gt; OutExpr
</span><a href="GHC.Core.Opt.Arity.html#etaExpandAT"><span class="hs-identifier hs-var">etaExpandAT</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682977728"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682977727"><span class="hs-identifier hs-var">arity_type</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977724"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1960"></span><span>
</span><span id="line-1961"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1962"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SafeArityType, OutExpr) -&gt; SimplM (SafeArityType, OutExpr)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682977727"><span class="hs-identifier hs-var">arity_type</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977724"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1963"></span><span>
</span><span id="line-1964"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1965"></span><span>    </span><span id="local-6989586621682977728"><span class="annot"><span class="annottext">in_scope :: InScopeSet
</span><a href="#local-6989586621682977728"><span class="hs-identifier hs-var hs-var">in_scope</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticEnv -&gt; InScopeSet
</span><a href="GHC.Core.Opt.Simplify.Env.html#getInScope"><span class="hs-identifier hs-var">getInScope</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977721"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1966"></span><span>    </span><span id="local-6989586621682977729"><span class="annot"><span class="annottext">arity_opts :: ArityOpts
</span><a href="#local-6989586621682977729"><span class="hs-identifier hs-var hs-var">arity_opts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticEnv -&gt; ArityOpts
</span><a href="GHC.Core.Opt.Simplify.Env.html#seArityOpts"><span class="hs-identifier hs-var">seArityOpts</span></a></span><span> </span><span class="annot"><span class="annottext">StaticEnv
</span><a href="#local-6989586621682977721"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1967"></span><span>    </span><span id="local-6989586621682977730"><span class="annot"><span class="annottext">is_rec :: RecFlag
</span><a href="#local-6989586621682977730"><span class="hs-identifier hs-var hs-var">is_rec</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BindContext -&gt; RecFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#bindContextRec"><span class="hs-identifier hs-var">bindContextRec</span></a></span><span> </span><span class="annot"><span class="annottext">BindContext
</span><a href="#local-6989586621682977722"><span class="hs-identifier hs-var">bind_cxt</span></a></span><span>
</span><span id="line-1968"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682977725"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682977725"><span class="hs-identifier hs-var">do_eta_expand</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682977727"><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682977727"><span class="hs-identifier hs-var">arity_type</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityOpts -&gt; RecFlag -&gt; Id -&gt; OutExpr -&gt; (Bool, SafeArityType)
</span><a href="GHC.Core.Opt.Arity.html#findRhsArity"><span class="hs-identifier hs-var">findRhsArity</span></a></span><span> </span><span class="annot"><span class="annottext">ArityOpts
</span><a href="#local-6989586621682977729"><span class="hs-identifier hs-var">arity_opts</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621682977730"><span class="hs-identifier hs-var">is_rec</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977723"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977724"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1969"></span><span>
</span><span id="line-1970"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#wantEtaExpansion"><span class="hs-identifier hs-type">wantEtaExpansion</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1971"></span><span class="hs-comment">-- Mostly True; but False of PAPs which will immediately eta-reduce again</span><span>
</span><span id="line-1972"></span><span class="hs-comment">-- See Note [Which RHSs do we eta-expand?]</span><span>
</span><span id="line-1973"></span><span id="wantEtaExpansion"><span class="annot"><span class="annottext">wantEtaExpansion :: OutExpr -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#wantEtaExpansion"><span class="hs-identifier hs-var hs-var">wantEtaExpansion</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682977732"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977732"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">OutCoercion
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#wantEtaExpansion"><span class="hs-identifier hs-var">wantEtaExpansion</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977732"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1974"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#wantEtaExpansion"><span class="hs-identifier hs-var">wantEtaExpansion</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682977733"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977733"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#wantEtaExpansion"><span class="hs-identifier hs-var">wantEtaExpansion</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977733"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1975"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#wantEtaExpansion"><span class="hs-identifier hs-var">wantEtaExpansion</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621682977734"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977734"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682977735"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977735"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977734"><span class="hs-identifier hs-var">b</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#wantEtaExpansion"><span class="hs-identifier hs-var">wantEtaExpansion</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977735"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1976"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#wantEtaExpansion"><span class="hs-identifier hs-var">wantEtaExpansion</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621682977736"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977736"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#wantEtaExpansion"><span class="hs-identifier hs-var">wantEtaExpansion</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977736"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1977"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#wantEtaExpansion"><span class="hs-identifier hs-var">wantEtaExpansion</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1978"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#wantEtaExpansion"><span class="hs-identifier hs-var">wantEtaExpansion</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-type">Lit</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1979"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#wantEtaExpansion"><span class="hs-identifier hs-var">wantEtaExpansion</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><span class="hs-identifier">_</span></span><span>                      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1980"></span><span>
</span><span id="line-1981"></span><span class="hs-comment">{-
Note [Eta-expanding at let bindings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We now eta expand at let-bindings, which is where the payoff comes.
The most significant thing is that we can do a simple arity analysis
(in GHC.Core.Opt.Arity.findRhsArity), which we can't do for free-floating lambdas

One useful consequence of not eta-expanding lambdas is this example:
   genMap :: C a =&gt; ...
   {-# INLINE genMap #-}
   genMap f xs = ...

   myMap :: D a =&gt; ...
   {-# INLINE myMap #-}
   myMap = genMap

Notice that 'genMap' should only inline if applied to two arguments.
In the stable unfolding for myMap we'll have the unfolding
    (\d -&gt; genMap Int (..d..))
We do not want to eta-expand to
    (\d f xs -&gt; genMap Int (..d..) f xs)
because then 'genMap' will inline, and it really shouldn't: at least
as far as the programmer is concerned, it's not applied to two
arguments!

Note [Which RHSs do we eta-expand?]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We don't eta-expand:

* Trivial RHSs, e.g.     f = g
  If we eta expand do
    f = \x. g x
  we'll just eta-reduce again, and so on; so the
  simplifier never terminates.

* PAPs: see Note [Do not eta-expand PAPs]

What about things like this?
   f = case y of p -&gt; \x -&gt; blah

Here we do eta-expand.  This is a change (Jun 20), but if we have
really decided that f has arity 1, then putting that lambda at the top
seems like a Good idea.

Note [Do not eta-expand PAPs]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We used to have old_arity = manifestArity rhs, which meant that we
would eta-expand even PAPs.  But this gives no particular advantage,
and can lead to a massive blow-up in code size, exhibited by #9020.
Suppose we have a PAP
    foo :: IO ()
    foo = returnIO ()
Then we can eta-expand to
    foo = (\eta. (returnIO () |&gt; sym g) eta) |&gt; g
where
    g :: IO () ~ State# RealWorld -&gt; (# State# RealWorld, () #)

But there is really no point in doing this, and it generates masses of
coercions and whatnot that eventually disappear again. For T9020, GHC
allocated 6.6G before, and 0.8G afterwards; and residency dropped from
1.8G to 45M.

Moreover, if we eta expand
        f = g d  ==&gt;  f = \x. g d x
that might in turn make g inline (if it has an inline pragma), which
we might not want.  After all, INLINE pragmas say &quot;inline only when
saturated&quot; so we don't want to be too gung-ho about saturating!

But note that this won't eta-expand, say
  f = \g -&gt; map g
Does it matter not eta-expanding such functions?  I'm not sure.  Perhaps
strictness analysis will have less to bite on?


************************************************************************
*                                                                      *
\subsection{Floating lets out of big lambdas}
*                                                                      *
************************************************************************

Note [Floating and type abstraction]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this:
        x = /\a. C e1 e2
We'd like to float this to
        y1 = /\a. e1
        y2 = /\a. e2
        x  = /\a. C (y1 a) (y2 a)
for the usual reasons: we want to inline x rather vigorously.

You may think that this kind of thing is rare.  But in some programs it is
common.  For example, if you do closure conversion you might get:

        data a :-&gt; b = forall e. (e -&gt; a -&gt; b) :$ e

        f_cc :: forall a. a :-&gt; a
        f_cc = /\a. (\e. id a) :$ ()

Now we really want to inline that f_cc thing so that the
construction of the closure goes away.

So I have elaborated simplLazyBind to understand right-hand sides that look
like
        /\ a1..an. body

and treat them specially. The real work is done in
GHC.Core.Opt.Simplify.Utils.abstractFloats, but there is quite a bit of plumbing
in simplLazyBind as well.

The same transformation is good when there are lets in the body:

        /\abc -&gt; let(rec) x = e in b
   ==&gt;
        let(rec) x' = /\abc -&gt; let x = x' a b c in e
        in
        /\abc -&gt; let x = x' a b c in b

This is good because it can turn things like:

        let f = /\a -&gt; letrec g = ... g ... in g
into
        letrec g' = /\a -&gt; ... g' a ...
        in
        let f = /\ a -&gt; g' a

which is better.  In effect, it means that big lambdas don't impede
let-floating.

This optimisation is CRUCIAL in eliminating the junk introduced by
desugaring mutually recursive definitions.  Don't eliminate it lightly!

[May 1999]  If we do this transformation *regardless* then we can
end up with some pretty silly stuff.  For example,

        let
            st = /\ s -&gt; let { x1=r1 ; x2=r2 } in ...
        in ..
becomes
        let y1 = /\s -&gt; r1
            y2 = /\s -&gt; r2
            st = /\s -&gt; ...[y1 s/x1, y2 s/x2]
        in ..

Unless the &quot;...&quot; is a WHNF there is really no point in doing this.
Indeed it can make things worse.  Suppose x1 is used strictly,
and is of the form

        x1* = case f y of { (a,b) -&gt; e }

If we abstract this wrt the tyvar we then can't do the case inline
as we would normally do.

That's why the whole transformation is part of the same process that
floats let-bindings and constructor arguments out of RHSs.  In particular,
it is guarded by the doFloatFromRhs call in simplLazyBind.

Note [Which type variables to abstract over]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Abstract only over the type variables free in the rhs wrt which the
new binding is abstracted.  Several points worth noting

(AB1) The naive approach of abstracting wrt the
      tyvars free in the Id's /type/ fails. Consider:
          /\ a b -&gt; let t :: (a,b) = (e1, e2)
                        x :: a     = fst t
                    in ...
      Here, b isn't free in x's type, but we must nevertheless
      abstract wrt b as well, because t's type mentions b.
      Since t is floated too, we'd end up with the bogus:
           poly_t = /\ a b -&gt; (e1, e2)
           poly_x = /\ a   -&gt; fst (poly_t a *b*)

(AB2) We must do closeOverKinds.  Example (#10934):
       f = /\k (f:k-&gt;*) (a:k). let t = AccFailure @ (f a) in ...
      Here we want to float 't', but we must remember to abstract over
      'k' as well, even though it is not explicitly mentioned in the RHS,
      otherwise we get
         t = /\ (f:k-&gt;*) (a:k). AccFailure @ (f a)
      which is obviously bogus.

(AB3) We get the variables to abstract over by filtering down the
      the main_tvs for the original function, picking only ones
      mentioned in the abstracted body. This means:
      - they are automatically in dependency order, because main_tvs is
      - there is no issue about non-determinism
      - we don't gratuitously change order, which may help (in a tiny
        way) with CSE and/or the compiler-debugging experience

(AB4) For a recursive group, it's a bit of a pain to work out the minimal
      set of tyvars over which to abstract:
           /\ a b c.  let x = ...a... in
                      letrec { p = ...x...q...
                               q = .....p...b... } in
                      ...
      Since 'x' is abstracted over 'a', the {p,q} group must be abstracted
      over 'a' (because x is replaced by (poly_x a)) as well as 'b'.
      Remember this bizarre case too:
           x::a = x
      Here, we must abstract 'x' over 'a'.

      Why is it worth doing this?  Partly tidiness; and partly #22459
      which showed that it's harder to do polymorphic specialisation well
      if there are dictionaries abstracted over unnecessary type variables.
      See Note [Weird special case for SpecDict] in GHC.Core.Opt.Specialise

(AB5) We do dependency analysis on recursive groups prior to determining
      which variables to abstract over.
      This is useful, because ANFisation in prepareBinding may float out
      values out of a complex recursive binding, e.g.,
          letrec { xs = g @a &quot;blah&quot;# ((:) 1 []) xs } in ...
        ==&gt; { prepareBinding }
          letrec { foo = &quot;blah&quot;#
                   bar = [42]
                   xs = g @a foo bar xs } in
          ...
      and we don't want to abstract foo and bar over @a.

      (Why is it OK to float the unlifted `foo` there?
      See Note [Core top-level string literals] in GHC.Core;
      it is controlled by GHC.Core.Opt.Simplify.Env.unitLetFloat.)

      It is also necessary to do dependency analysis, because
      otherwise (in #24551) we might get `foo = \@_ -&gt; &quot;missing&quot;#` at the
      top-level, and that triggers a CoreLint error because `foo` is *not*
      manifestly a literal string.
-}</span><span>
</span><span id="line-2207"></span><span>
</span><span id="line-2208"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#abstractFloats"><span class="hs-identifier hs-type">abstractFloats</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#UnfoldingOpts"><span class="hs-identifier hs-type">UnfoldingOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#OutTyVar"><span class="hs-identifier hs-type">OutTyVar</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span>
</span><span id="line-2209"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#OutBind"><span class="hs-identifier hs-type">OutBind</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2210"></span><span id="abstractFloats"><span class="annot"><span class="annottext">abstractFloats :: UnfoldingOpts
-&gt; TopLevelFlag
-&gt; [Id]
-&gt; SimplFloats
-&gt; OutExpr
-&gt; SimplM ([Bind Id], OutExpr)
</span><a href="GHC.Core.Opt.Simplify.Utils.html#abstractFloats"><span class="hs-identifier hs-var hs-var">abstractFloats</span></a></span></span><span> </span><span id="local-6989586621682977739"><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682977739"><span class="hs-identifier hs-var">uf_opts</span></a></span></span><span> </span><span id="local-6989586621682977740"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682977740"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621682977741"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977741"><span class="hs-identifier hs-var">main_tvs</span></a></span></span><span> </span><span id="local-6989586621682977742"><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682977742"><span class="hs-identifier hs-var">floats</span></a></span></span><span> </span><span id="local-6989586621682977743"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977743"><span class="hs-identifier hs-var">body</span></a></span></span><span>
</span><span id="line-2211"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SimplM ([Bind Id], OutExpr) -&gt; SimplM ([Bind Id], OutExpr)
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Bind Id] -&gt; Bool
forall (f :: * -&gt; *) a. Foldable f =&gt; f a -&gt; Bool
</span><a href="GHC.Utils.Misc.html#notNull"><span class="hs-identifier hs-var">notNull</span></a></span><span> </span><span class="annot"><span class="annottext">[Bind Id]
</span><a href="#local-6989586621682977746"><span class="hs-identifier hs-var">body_floats</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SimplM ([Bind Id], OutExpr) -&gt; SimplM ([Bind Id], OutExpr))
-&gt; SimplM ([Bind Id], OutExpr) -&gt; SimplM ([Bind Id], OutExpr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2212"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; SimplM ([Bind Id], OutExpr) -&gt; SimplM ([Bind Id], OutExpr)
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OrdList (Bind Id) -&gt; Bool
forall a. OrdList a -&gt; Bool
</span><a href="GHC.Data.OrdList.html#isNilOL"><span class="hs-identifier hs-var">isNilOL</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplFloats -&gt; OrdList (Bind Id)
</span><a href="GHC.Core.Opt.Simplify.Env.html#sfJoinFloats"><span class="hs-identifier hs-var">sfJoinFloats</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682977742"><span class="hs-identifier hs-var">floats</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SimplM ([Bind Id], OutExpr) -&gt; SimplM ([Bind Id], OutExpr))
-&gt; SimplM ([Bind Id], OutExpr) -&gt; SimplM ([Bind Id], OutExpr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2213"></span><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682977748"><span class="annot"><span class="annottext">sccs :: [SCC (Id, OutExpr, TyCoVarSet)]
</span><a href="#local-6989586621682977748"><span class="hs-identifier hs-var hs-var hs-var">sccs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Bind Id -&gt; [SCC (Id, OutExpr, TyCoVarSet)])
-&gt; [Bind Id] -&gt; [SCC (Id, OutExpr, TyCoVarSet)]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">Bind Id -&gt; [SCC (Id, OutExpr, TyCoVarSet)]
</span><a href="#local-6989586621682977750"><span class="hs-identifier hs-var">to_sccs</span></a></span><span> </span><span class="annot"><span class="annottext">[Bind Id]
</span><a href="#local-6989586621682977746"><span class="hs-identifier hs-var">body_floats</span></a></span><span>
</span><span id="line-2214"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682977751"><span class="annot"><a href="#local-6989586621682977751"><span class="hs-identifier hs-var">subst</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682977752"><span class="annot"><a href="#local-6989586621682977752"><span class="hs-identifier hs-var">float_binds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Subst -&gt; SCC (Id, OutExpr, TyCoVarSet) -&gt; SimplM (Subst, Bind Id))
-&gt; Subst
-&gt; [SCC (Id, OutExpr, TyCoVarSet)]
-&gt; SimplM (Subst, [Bind Id])
forall (m :: * -&gt; *) (t :: * -&gt; *) acc x y.
(Monad m, Traversable t) =&gt;
(acc -&gt; x -&gt; m (acc, y)) -&gt; acc -&gt; t x -&gt; m (acc, t y)
</span><a href="GHC.Utils.Monad.html#mapAccumLM"><span class="hs-identifier hs-var">mapAccumLM</span></a></span><span> </span><span class="annot"><span class="annottext">Subst -&gt; SCC (Id, OutExpr, TyCoVarSet) -&gt; SimplM (Subst, Bind Id)
</span><a href="#local-6989586621682977754"><span class="hs-identifier hs-var">abstract</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682977755"><span class="hs-identifier hs-var">empty_subst</span></a></span><span> </span><span class="annot"><span class="annottext">[SCC (Id, OutExpr, TyCoVarSet)]
</span><a href="#local-6989586621682977748"><span class="hs-identifier hs-var">sccs</span></a></span><span>
</span><span id="line-2215"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682977752"><span class="hs-identifier hs-type">float_binds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#substExpr"><span class="hs-identifier hs-type">GHC.Core.Subst.substExpr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977751"><span class="hs-identifier hs-type">subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977743"><span class="hs-identifier hs-type">body</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2216"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2217"></span><span>    </span><span id="local-6989586621682977757"><span class="annot"><span class="annottext">is_top_lvl :: Bool
</span><a href="#local-6989586621682977757"><span class="hs-identifier hs-var hs-var">is_top_lvl</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; Bool
</span><a href="GHC.Types.Basic.html#isTopLevel"><span class="hs-identifier hs-var">isTopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682977740"><span class="hs-identifier hs-var">top_lvl</span></a></span><span>
</span><span id="line-2218"></span><span>    </span><span id="local-6989586621682977746"><span class="annot"><span class="annottext">body_floats :: [Bind Id]
</span><a href="#local-6989586621682977746"><span class="hs-identifier hs-var hs-var">body_floats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LetFloats -&gt; [Bind Id]
</span><a href="GHC.Core.Opt.Simplify.Env.html#letFloatBinds"><span class="hs-identifier hs-var">letFloatBinds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplFloats -&gt; LetFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#sfLetFloats"><span class="hs-identifier hs-var">sfLetFloats</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682977742"><span class="hs-identifier hs-var">floats</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2219"></span><span>    </span><span id="local-6989586621682977755"><span class="annot"><span class="annottext">empty_subst :: Subst
</span><a href="#local-6989586621682977755"><span class="hs-identifier hs-var hs-var">empty_subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#mkEmptySubst"><span class="hs-identifier hs-var">GHC.Core.Subst.mkEmptySubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplFloats -&gt; InScopeSet
</span><a href="GHC.Core.Opt.Simplify.Env.html#sfInScope"><span class="hs-identifier hs-var">sfInScope</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682977742"><span class="hs-identifier hs-var">floats</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2220"></span><span>
</span><span id="line-2221"></span><span>    </span><span class="hs-comment">-- See wrinkle (AB5) in Note [Which type variables to abstract over]</span><span>
</span><span id="line-2222"></span><span>    </span><span class="hs-comment">-- for why we need to re-do dependency analysis</span><span>
</span><span id="line-2223"></span><span>    </span><span class="annot"><a href="#local-6989586621682977750"><span class="hs-identifier hs-type">to_sccs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#OutBind"><span class="hs-identifier hs-type">OutBind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Graph.html#SCC"><span class="hs-identifier hs-type">SCC</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-2224"></span><span>    </span><span id="local-6989586621682977750"><span class="annot"><span class="annottext">to_sccs :: Bind Id -&gt; [SCC (Id, OutExpr, TyCoVarSet)]
</span><a href="#local-6989586621682977750"><span class="hs-identifier hs-var hs-var">to_sccs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span id="local-6989586621682977764"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977764"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span id="local-6989586621682977765"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977765"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">(Id, OutExpr, TyCoVarSet) -&gt; SCC (Id, OutExpr, TyCoVarSet)
forall vertex. vertex -&gt; SCC vertex
</span><a href="../../containers-0.7-5a8f/src/Data.Graph.html#AcyclicSCC"><span class="hs-identifier hs-var">AcyclicSCC</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977764"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977765"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TyCoVarSet
</span><a href="GHC.Types.Var.Set.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- emptyVarSet: abstract doesn't need it</span><span>
</span><span id="line-2225"></span><span>    </span><span class="annot"><a href="#local-6989586621682977750"><span class="hs-identifier hs-var">to_sccs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span id="local-6989586621682977769"><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621682977769"><span class="hs-identifier hs-var">prs</span></a></span></span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SCC (Id, OutExpr, TyCoVarSet)]
</span><a href="#local-6989586621682977770"><span class="hs-identifier hs-var">sccs</span></a></span><span>
</span><span id="line-2226"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-2227"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621682977771"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977771"><span class="hs-identifier hs-var">ids</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682977772"><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621682977772"><span class="hs-identifier hs-var">rhss</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr)] -&gt; ([Id], [OutExpr])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621682977769"><span class="hs-identifier hs-var">prs</span></a></span><span>
</span><span id="line-2228"></span><span>        </span><span id="local-6989586621682977770"><span class="annot"><span class="annottext">sccs :: [SCC (Id, OutExpr, TyCoVarSet)]
</span><a href="#local-6989586621682977770"><span class="hs-identifier hs-var hs-var">sccs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Id, OutExpr, TyCoVarSet) -&gt; [Name])
-&gt; ((Id, OutExpr, TyCoVarSet) -&gt; [Name])
-&gt; [(Id, OutExpr, TyCoVarSet)]
-&gt; [SCC (Id, OutExpr, TyCoVarSet)]
forall node.
(node -&gt; [Name]) -&gt; (node -&gt; [Name]) -&gt; [node] -&gt; [SCC node]
</span><a href="GHC.Types.Name.Env.html#depAnal"><span class="hs-identifier hs-var">depAnal</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621682977775"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977775"><span class="hs-identifier hs-var">id</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682977776"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977776"><span class="hs-identifier hs-var">_rhs</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682977777"><span class="annot"><span class="annottext">TyCoVarSet
</span><a href="#local-6989586621682977777"><span class="hs-identifier hs-var">_fvs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Id -&gt; Name
forall a. NamedThing a =&gt; a -&gt; Name
</span><a href="GHC.Types.Name.html#getName"><span class="hs-identifier hs-var">getName</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977775"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2229"></span><span>                       </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621682977779"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977779"><span class="hs-identifier hs-var">_id</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682977780"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977780"><span class="hs-identifier hs-var">_rhs</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682977781"><span class="annot"><span class="annottext">TyCoVarSet
</span><a href="#local-6989586621682977781"><span class="hs-identifier hs-var">fvs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; [Name] -&gt; [Name]) -&gt; [Name] -&gt; TyCoVarSet -&gt; [Name]
forall a. (Id -&gt; a -&gt; a) -&gt; a -&gt; TyCoVarSet -&gt; a
</span><a href="GHC.Types.Var.Set.html#nonDetStrictFoldVarSet"><span class="hs-identifier hs-var">nonDetStrictFoldVarSet</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; [Name] -&gt; [Name])
-&gt; (Id -&gt; Name) -&gt; Id -&gt; [Name] -&gt; [Name]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Name
forall a. NamedThing a =&gt; a -&gt; Name
</span><a href="GHC.Types.Name.html#getName"><span class="hs-identifier hs-var">getName</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">TyCoVarSet
</span><a href="#local-6989586621682977781"><span class="hs-identifier hs-var">fvs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Wrinkle (AB3)</span><span>
</span><span id="line-2230"></span><span>                       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id] -&gt; [OutExpr] -&gt; [TyCoVarSet] -&gt; [(Id, OutExpr, TyCoVarSet)]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><span class="hs-identifier hs-var">zip3</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977771"><span class="hs-identifier hs-var">ids</span></a></span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621682977772"><span class="hs-identifier hs-var">rhss</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(OutExpr -&gt; TyCoVarSet) -&gt; [OutExpr] -&gt; [TyCoVarSet]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; TyCoVarSet
</span><a href="GHC.Core.FVs.html#exprFreeVars"><span class="hs-identifier hs-var">exprFreeVars</span></a></span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621682977772"><span class="hs-identifier hs-var">rhss</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2231"></span><span>
</span><span id="line-2232"></span><span>    </span><span class="annot"><a href="#local-6989586621682977754"><span class="hs-identifier hs-type">abstract</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">GHC.Core.Subst.Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Graph.html#SCC"><span class="hs-identifier hs-type">SCC</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">GHC.Core.Subst.Subst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutBind"><span class="hs-identifier hs-type">OutBind</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2233"></span><span>    </span><span id="local-6989586621682977754"><span class="annot"><span class="annottext">abstract :: Subst -&gt; SCC (Id, OutExpr, TyCoVarSet) -&gt; SimplM (Subst, Bind Id)
</span><a href="#local-6989586621682977754"><span class="hs-identifier hs-var hs-var">abstract</span></a></span></span><span> </span><span id="local-6989586621682977786"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682977786"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Graph.html#AcyclicSCC"><span class="hs-identifier hs-type">AcyclicSCC</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682977787"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977787"><span class="hs-identifier hs-var">id</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682977788"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977788"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682977789"><span class="annot"><span class="annottext">TyCoVarSet
</span><a href="#local-6989586621682977789"><span class="hs-identifier hs-var">_empty_var_set</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2234"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682977790"><span class="annot"><a href="#local-6989586621682977790"><span class="hs-identifier hs-var">poly_id1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682977791"><span class="annot"><a href="#local-6989586621682977791"><span class="hs-identifier hs-var">poly_app</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; Id -&gt; SimplM (Id, OutExpr)
</span><a href="#local-6989586621682977792"><span class="hs-identifier hs-var">mk_poly1</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977793"><span class="hs-identifier hs-var">tvs_here</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977787"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-2235"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682977794"><span class="annot"><a href="#local-6989586621682977794"><span class="hs-identifier hs-var">poly_id2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682977795"><span class="annot"><a href="#local-6989586621682977795"><span class="hs-identifier hs-var">poly_rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682977796"><span class="hs-identifier hs-type">mk_poly2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977790"><span class="hs-identifier hs-type">poly_id1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977793"><span class="hs-identifier hs-type">tvs_here</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977797"><span class="hs-identifier hs-type">rhs'</span></a></span><span>
</span><span id="line-2236"></span><span>                 </span><span class="hs-glyph">!</span><span id="local-6989586621682977798"><span class="annot"><a href="#local-6989586621682977798"><span class="hs-identifier hs-var hs-var">subst'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Id -&gt; OutExpr -&gt; Subst
</span><a href="GHC.Core.Subst.html#extendIdSubst"><span class="hs-identifier hs-var">GHC.Core.Subst.extendIdSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682977786"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977787"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977791"><span class="hs-identifier hs-var">poly_app</span></a></span><span>
</span><span id="line-2237"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682977798"><span class="hs-identifier hs-type">subst'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977794"><span class="hs-identifier hs-type">poly_id2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977795"><span class="hs-identifier hs-type">poly_rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2238"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-2239"></span><span>        </span><span id="local-6989586621682977797"><span class="annot"><span class="annottext">rhs' :: OutExpr
</span><a href="#local-6989586621682977797"><span class="hs-identifier hs-var hs-var">rhs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; OutExpr -&gt; OutExpr
Subst -&gt; OutExpr -&gt; OutExpr
</span><a href="GHC.Core.Subst.html#substExpr"><span class="hs-identifier hs-var">GHC.Core.Subst.substExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682977786"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977788"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-2240"></span><span>
</span><span id="line-2241"></span><span>        </span><span class="hs-comment">-- tvs_here: see Note [Which type variables to abstract over]</span><span>
</span><span id="line-2242"></span><span>        </span><span id="local-6989586621682977793"><span class="annot"><span class="annottext">tvs_here :: [Id]
</span><a href="#local-6989586621682977793"><span class="hs-identifier hs-var hs-var">tvs_here</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCoVarSet -&gt; [Id]
</span><a href="#local-6989586621682977800"><span class="hs-identifier hs-var">choose_tvs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; OutExpr -&gt; TyCoVarSet
</span><a href="GHC.Core.FVs.html#exprSomeFreeVars"><span class="hs-identifier hs-var">exprSomeFreeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977797"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2243"></span><span>
</span><span id="line-2244"></span><span>    </span><span class="annot"><a href="#local-6989586621682977754"><span class="hs-identifier hs-var">abstract</span></a></span><span> </span><span id="local-6989586621682977802"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682977802"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Graph.html#CyclicSCC"><span class="hs-identifier hs-type">CyclicSCC</span></a></span><span> </span><span id="local-6989586621682977804"><span class="annot"><span class="annottext">[(Id, OutExpr, TyCoVarSet)]
</span><a href="#local-6989586621682977804"><span class="hs-identifier hs-var">trpls</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2245"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682977805"><span class="annot"><a href="#local-6989586621682977805"><span class="hs-identifier hs-var">poly_ids</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682977806"><span class="annot"><a href="#local-6989586621682977806"><span class="hs-identifier hs-var">poly_apps</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; SimplM (Id, OutExpr)) -&gt; [Id] -&gt; SimplM ([Id], [OutExpr])
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; m (b, c)) -&gt; [a] -&gt; m ([b], [c])
</span><span class="hs-identifier hs-var">mapAndUnzipM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id] -&gt; Id -&gt; SimplM (Id, OutExpr)
</span><a href="#local-6989586621682977792"><span class="hs-identifier hs-var">mk_poly1</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977808"><span class="hs-identifier hs-var">tvs_here</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977809"><span class="hs-identifier hs-var">ids</span></a></span><span>
</span><span id="line-2246"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682977810"><span class="annot"><a href="#local-6989586621682977810"><span class="hs-identifier hs-var hs-var">subst'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; [(Id, OutExpr)] -&gt; Subst
</span><a href="GHC.Core.Subst.html#extendSubstList"><span class="hs-identifier hs-var">GHC.Core.Subst.extendSubstList</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682977802"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977809"><span class="hs-identifier hs-var">ids</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [OutExpr] -&gt; [(Id, OutExpr)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-operator hs-var">`zip`</span></span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621682977806"><span class="hs-identifier hs-var">poly_apps</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2247"></span><span>                 </span><span id="local-6989586621682977812"><span class="annot"><a href="#local-6989586621682977812"><span class="hs-identifier hs-var hs-var">poly_pairs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Id -&gt; [Id] -&gt; OutExpr -&gt; (Id, OutExpr)
</span><a href="#local-6989586621682977796"><span class="hs-identifier hs-var">mk_poly2</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977813"><span class="hs-identifier hs-var">poly_id</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977808"><span class="hs-identifier hs-var">tvs_here</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977814"><span class="hs-identifier hs-var">rhs'</span></a></span><span>
</span><span id="line-2248"></span><span>                              </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682977813"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977813"><span class="hs-identifier hs-var">poly_id</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682977815"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977815"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977805"><span class="hs-identifier hs-var">poly_ids</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [OutExpr] -&gt; [(Id, OutExpr)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-operator hs-var">`zip`</span></span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621682977816"><span class="hs-identifier hs-var">rhss</span></a></span><span>
</span><span id="line-2249"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682977814"><span class="annot"><span class="annottext">rhs' :: OutExpr
</span><a href="#local-6989586621682977814"><span class="hs-identifier hs-var hs-var">rhs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; OutExpr -&gt; OutExpr
Subst -&gt; OutExpr -&gt; OutExpr
</span><a href="GHC.Core.Subst.html#substExpr"><span class="hs-identifier hs-var">GHC.Core.Subst.substExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682977810"><span class="hs-identifier hs-var">subst'</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977815"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-2250"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682977810"><span class="hs-identifier hs-type">subst'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977812"><span class="hs-identifier hs-type">poly_pairs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2251"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-2252"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621682977809"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977809"><span class="hs-identifier hs-var">ids</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682977816"><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621682977816"><span class="hs-identifier hs-var">rhss</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682977817"><span class="annot"><span class="annottext">[TyCoVarSet]
</span><a href="#local-6989586621682977817"><span class="hs-identifier hs-var">_fvss</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr, TyCoVarSet)] -&gt; ([Id], [OutExpr], [TyCoVarSet])
forall a b c. [(a, b, c)] -&gt; ([a], [b], [c])
</span><span class="hs-identifier hs-var">unzip3</span></span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr, TyCoVarSet)]
</span><a href="#local-6989586621682977804"><span class="hs-identifier hs-var">trpls</span></a></span><span>
</span><span id="line-2253"></span><span>
</span><span id="line-2254"></span><span>        </span><span class="hs-comment">-- tvs_here: see Note [Which type variables to abstract over]</span><span>
</span><span id="line-2255"></span><span>        </span><span id="local-6989586621682977808"><span class="annot"><span class="annottext">tvs_here :: [Id]
</span><a href="#local-6989586621682977808"><span class="hs-identifier hs-var hs-var">tvs_here</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCoVarSet -&gt; [Id]
</span><a href="#local-6989586621682977800"><span class="hs-identifier hs-var">choose_tvs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Id, OutExpr, TyCoVarSet) -&gt; TyCoVarSet)
-&gt; [(Id, OutExpr, TyCoVarSet)] -&gt; TyCoVarSet
forall a. (a -&gt; TyCoVarSet) -&gt; [a] -&gt; TyCoVarSet
</span><a href="GHC.Types.Var.Set.html#mapUnionVarSet"><span class="hs-identifier hs-var">mapUnionVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">(Id, OutExpr, TyCoVarSet) -&gt; TyCoVarSet
forall {b}. (Id, b, TyCoVarSet) -&gt; TyCoVarSet
</span><a href="#local-6989586621682977820"><span class="hs-identifier hs-var">get_bind_fvs</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr, TyCoVarSet)]
</span><a href="#local-6989586621682977804"><span class="hs-identifier hs-var">trpls</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2256"></span><span>
</span><span id="line-2257"></span><span>        </span><span class="hs-comment">-- See wrinkle (AB4) in Note [Which type variables to abstract over]</span><span>
</span><span id="line-2258"></span><span>        </span><span id="local-6989586621682977820"><span class="annot"><span class="annottext">get_bind_fvs :: (Id, b, TyCoVarSet) -&gt; TyCoVarSet
</span><a href="#local-6989586621682977820"><span class="hs-identifier hs-var hs-var">get_bind_fvs</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682977821"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977821"><span class="hs-identifier hs-var">id</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682977822"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621682977822"><span class="hs-identifier hs-var">_rhs</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682977823"><span class="annot"><span class="annottext">TyCoVarSet
</span><a href="#local-6989586621682977823"><span class="hs-identifier hs-var">rhs_fvs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutType -&gt; TyCoVarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; OutType
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977821"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TyCoVarSet -&gt; TyCoVarSet -&gt; TyCoVarSet
</span><a href="GHC.Types.Var.Set.html#unionVarSet"><span class="hs-operator hs-var">`unionVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">TyCoVarSet -&gt; TyCoVarSet
</span><a href="#local-6989586621682977826"><span class="hs-identifier hs-var">get_rec_rhs_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">TyCoVarSet
</span><a href="#local-6989586621682977823"><span class="hs-identifier hs-var">rhs_fvs</span></a></span><span>
</span><span id="line-2259"></span><span>        </span><span id="local-6989586621682977826"><span class="annot"><span class="annottext">get_rec_rhs_tvs :: TyCoVarSet -&gt; TyCoVarSet
</span><a href="#local-6989586621682977826"><span class="hs-identifier hs-var hs-var">get_rec_rhs_tvs</span></a></span></span><span> </span><span id="local-6989586621682977827"><span class="annot"><span class="annottext">TyCoVarSet
</span><a href="#local-6989586621682977827"><span class="hs-identifier hs-var">rhs_fvs</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; TyCoVarSet -&gt; TyCoVarSet)
-&gt; TyCoVarSet -&gt; TyCoVarSet -&gt; TyCoVarSet
forall a. (Id -&gt; a -&gt; a) -&gt; a -&gt; TyCoVarSet -&gt; a
</span><a href="GHC.Types.Var.Set.html#nonDetStrictFoldVarSet"><span class="hs-identifier hs-var">nonDetStrictFoldVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; TyCoVarSet -&gt; TyCoVarSet
</span><a href="#local-6989586621682977828"><span class="hs-identifier hs-var">get_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">TyCoVarSet
</span><a href="GHC.Types.Var.Set.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">TyCoVarSet
</span><a href="#local-6989586621682977827"><span class="hs-identifier hs-var">rhs_fvs</span></a></span><span>
</span><span id="line-2260"></span><span>                                  </span><span class="hs-comment">-- nonDet is safe because of wrinkle (AB3)</span><span>
</span><span id="line-2261"></span><span>
</span><span id="line-2262"></span><span>        </span><span class="annot"><a href="#local-6989586621682977828"><span class="hs-identifier hs-type">get_tvs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span>
</span><span id="line-2263"></span><span>        </span><span id="local-6989586621682977828"><span class="annot"><span class="annottext">get_tvs :: Id -&gt; TyCoVarSet -&gt; TyCoVarSet
</span><a href="#local-6989586621682977828"><span class="hs-identifier hs-var hs-var">get_tvs</span></a></span></span><span> </span><span id="local-6989586621682977830"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977830"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span id="local-6989586621682977831"><span class="annot"><span class="annottext">TyCoVarSet
</span><a href="#local-6989586621682977831"><span class="hs-identifier hs-var">free_tvs</span></a></span></span><span>
</span><span id="line-2264"></span><span>           </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977830"><span class="hs-identifier hs-var">var</span></a></span><span>      </span><span class="hs-comment">-- CoVars have been substituted away</span><span>
</span><span id="line-2265"></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCoVarSet -&gt; Id -&gt; TyCoVarSet
</span><a href="GHC.Types.Var.Set.html#extendVarSet"><span class="hs-identifier hs-var">extendVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">TyCoVarSet
</span><a href="#local-6989586621682977831"><span class="hs-identifier hs-var">free_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977830"><span class="hs-identifier hs-var">var</span></a></span><span>
</span><span id="line-2266"></span><span>           </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977830"><span class="hs-identifier hs-var">var</span></a></span><span>  </span><span class="hs-comment">-- CoVars can be free in the RHS, but they are never let-bound;</span><span>
</span><span id="line-2267"></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCoVarSet
</span><a href="#local-6989586621682977831"><span class="hs-identifier hs-var">free_tvs</span></a></span><span>     </span><span class="hs-comment">-- Do not call lookupIdSubst_maybe, though (#23426)</span><span>
</span><span id="line-2268"></span><span>                          </span><span class="hs-comment">--    because it has a non-CoVar precondition</span><span>
</span><span id="line-2269"></span><span>           </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682977833"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977833"><span class="hs-identifier hs-var">poly_app</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Id -&gt; Maybe OutExpr
Subst -&gt; Id -&gt; Maybe OutExpr
</span><a href="GHC.Core.Subst.html#lookupIdSubst_maybe"><span class="hs-identifier hs-var">GHC.Core.Subst.lookupIdSubst_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682977802"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977830"><span class="hs-identifier hs-var">var</span></a></span><span>
</span><span id="line-2270"></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- 'var' is like 'x' in (AB4)</span><span>
</span><span id="line-2271"></span><span>             </span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; OutExpr -&gt; TyCoVarSet
</span><a href="GHC.Core.FVs.html#exprSomeFreeVars"><span class="hs-identifier hs-var">exprSomeFreeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977833"><span class="hs-identifier hs-var">poly_app</span></a></span><span> </span><span class="annot"><span class="annottext">TyCoVarSet -&gt; TyCoVarSet -&gt; TyCoVarSet
</span><a href="GHC.Types.Var.Set.html#unionVarSet"><span class="hs-operator hs-var">`unionVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">TyCoVarSet
</span><a href="#local-6989586621682977831"><span class="hs-identifier hs-var">free_tvs</span></a></span><span>
</span><span id="line-2272"></span><span>           </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2273"></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCoVarSet
</span><a href="#local-6989586621682977831"><span class="hs-identifier hs-var">free_tvs</span></a></span><span>
</span><span id="line-2274"></span><span>
</span><span id="line-2275"></span><span>    </span><span id="local-6989586621682977800"><span class="annot"><span class="annottext">choose_tvs :: TyCoVarSet -&gt; [Id]
</span><a href="#local-6989586621682977800"><span class="hs-identifier hs-var hs-var">choose_tvs</span></a></span></span><span> </span><span id="local-6989586621682977835"><span class="annot"><span class="annottext">TyCoVarSet
</span><a href="#local-6989586621682977835"><span class="hs-identifier hs-var">free_tvs</span></a></span></span><span>
</span><span id="line-2276"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; [Id] -&gt; [Id]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; TyCoVarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">TyCoVarSet
</span><a href="#local-6989586621682977836"><span class="hs-identifier hs-var">all_free_tvs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977741"><span class="hs-identifier hs-var">main_tvs</span></a></span><span>  </span><span class="hs-comment">-- (AB3)</span><span>
</span><span id="line-2277"></span><span>       </span><span class="hs-keyword">where</span><span>
</span><span id="line-2278"></span><span>         </span><span id="local-6989586621682977836"><span class="annot"><span class="annottext">all_free_tvs :: TyCoVarSet
</span><a href="#local-6989586621682977836"><span class="hs-identifier hs-var hs-var">all_free_tvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCoVarSet -&gt; TyCoVarSet
</span><a href="GHC.Core.TyCo.FVs.html#closeOverKinds"><span class="hs-identifier hs-var">closeOverKinds</span></a></span><span> </span><span class="annot"><span class="annottext">TyCoVarSet
</span><a href="#local-6989586621682977835"><span class="hs-identifier hs-var">free_tvs</span></a></span><span>       </span><span class="hs-comment">-- (AB2)</span><span>
</span><span id="line-2279"></span><span>
</span><span id="line-2280"></span><span>    </span><span class="annot"><a href="#local-6989586621682977792"><span class="hs-identifier hs-type">mk_poly1</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2281"></span><span>    </span><span id="local-6989586621682977792"><span class="annot"><span class="annottext">mk_poly1 :: [Id] -&gt; Id -&gt; SimplM (Id, OutExpr)
</span><a href="#local-6989586621682977792"><span class="hs-identifier hs-var hs-var">mk_poly1</span></a></span></span><span> </span><span id="local-6989586621682977839"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977839"><span class="hs-identifier hs-var">tvs_here</span></a></span></span><span> </span><span id="local-6989586621682977840"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977840"><span class="hs-identifier hs-var">var</span></a></span></span><span>
</span><span id="line-2282"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682977841"><span class="annot"><a href="#local-6989586621682977841"><span class="hs-identifier hs-var">uniq</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplM Unique
forall (m :: * -&gt; *). MonadUnique m =&gt; m Unique
</span><a href="GHC.Types.Unique.Supply.html#getUniqueM"><span class="hs-identifier hs-var">getUniqueM</span></a></span><span>
</span><span id="line-2283"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span>  </span><span id="local-6989586621682977843"><span class="annot"><a href="#local-6989586621682977843"><span class="hs-identifier hs-var hs-var">poly_name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Unique -&gt; Name
</span><a href="GHC.Types.Name.html#setNameUnique"><span class="hs-identifier hs-var">setNameUnique</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Name
</span><a href="GHC.Types.Id.html#idName"><span class="hs-identifier hs-var">idName</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977840"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682977841"><span class="hs-identifier hs-var">uniq</span></a></span><span>      </span><span class="hs-comment">-- Keep same name</span><span>
</span><span id="line-2284"></span><span>                  </span><span id="local-6989586621682977846"><span class="annot"><a href="#local-6989586621682977846"><span class="hs-identifier hs-var hs-var">poly_ty</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; OutType -&gt; OutType
</span><a href="GHC.Core.Type.html#mkInfForAllTys"><span class="hs-identifier hs-var">mkInfForAllTys</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977839"><span class="hs-identifier hs-var">tvs_here</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; OutType
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977840"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- But new type of course</span><span>
</span><span id="line-2285"></span><span>                  </span><span id="local-6989586621682977848"><span class="annot"><a href="#local-6989586621682977848"><span class="hs-identifier hs-var hs-var">poly_id</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; [Id] -&gt; Id -&gt; Id
</span><a href="GHC.Types.Id.html#transferPolyIdInfo"><span class="hs-identifier hs-var">transferPolyIdInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977840"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977839"><span class="hs-identifier hs-var">tvs_here</span></a></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Id) -&gt; Id -&gt; Id
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-comment">-- Note [transferPolyIdInfo] in GHC.Types.Id</span><span>
</span><span id="line-2286"></span><span>                              </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Name -&gt; OutType -&gt; OutType -&gt; Id
Name -&gt; OutType -&gt; OutType -&gt; Id
</span><a href="GHC.Types.Id.html#mkLocalId"><span class="hs-identifier hs-var">mkLocalId</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682977843"><span class="hs-identifier hs-var">poly_name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; OutType
</span><a href="GHC.Types.Id.html#idMult"><span class="hs-identifier hs-var">idMult</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977840"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977846"><span class="hs-identifier hs-var">poly_ty</span></a></span><span>
</span><span id="line-2287"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682977848"><span class="hs-identifier hs-type">poly_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#mkTyApps"><span class="hs-identifier hs-type">mkTyApps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977848"><span class="hs-identifier hs-type">poly_id</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#mkTyVarTys"><span class="hs-identifier hs-type">mkTyVarTys</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977839"><span class="hs-identifier hs-type">tvs_here</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2288"></span><span>                </span><span class="hs-comment">-- In the olden days, it was crucial to copy the occInfo of the original var,</span><span>
</span><span id="line-2289"></span><span>                </span><span class="hs-comment">-- because we were looking at occurrence-analysed but as yet unsimplified code!</span><span>
</span><span id="line-2290"></span><span>                </span><span class="hs-comment">-- In particular, we mustn't lose the loop breakers.  BUT NOW we are looking</span><span>
</span><span id="line-2291"></span><span>                </span><span class="hs-comment">-- at already simplified code, so it doesn't matter</span><span>
</span><span id="line-2292"></span><span>                </span><span class="hs-comment">--</span><span>
</span><span id="line-2293"></span><span>                </span><span class="hs-comment">-- It's even right to retain single-occurrence or dead-var info:</span><span>
</span><span id="line-2294"></span><span>                </span><span class="hs-comment">-- Suppose we started with  /\a -&gt; let x = E in B</span><span>
</span><span id="line-2295"></span><span>                </span><span class="hs-comment">-- where x occurs once in B. Then we transform to:</span><span>
</span><span id="line-2296"></span><span>                </span><span class="hs-comment">--      let x' = /\a -&gt; E in /\a -&gt; let x* = x' a in B</span><span>
</span><span id="line-2297"></span><span>                </span><span class="hs-comment">-- where x* has an INLINE prag on it.  Now, once x* is inlined,</span><span>
</span><span id="line-2298"></span><span>                </span><span class="hs-comment">-- the occurrences of x' will be just the occurrences originally</span><span>
</span><span id="line-2299"></span><span>                </span><span class="hs-comment">-- pinned on x.</span><span>
</span><span id="line-2300"></span><span>
</span><span id="line-2301"></span><span>    </span><span class="annot"><a href="#local-6989586621682977796"><span class="hs-identifier hs-type">mk_poly2</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2302"></span><span>    </span><span id="local-6989586621682977796"><span class="annot"><span class="annottext">mk_poly2 :: Id -&gt; [Id] -&gt; OutExpr -&gt; (Id, OutExpr)
</span><a href="#local-6989586621682977796"><span class="hs-identifier hs-var hs-var">mk_poly2</span></a></span></span><span> </span><span id="local-6989586621682977853"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977853"><span class="hs-identifier hs-var">poly_id</span></a></span></span><span> </span><span id="local-6989586621682977854"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977854"><span class="hs-identifier hs-var">tvs_here</span></a></span></span><span> </span><span id="local-6989586621682977855"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977855"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-2303"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977853"><span class="hs-identifier hs-var">poly_id</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Unfolding -&gt; Id
</span><a href="GHC.Types.Id.html#setIdUnfolding"><span class="hs-operator hs-var">`setIdUnfolding`</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682977857"><span class="hs-identifier hs-var">unf</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977858"><span class="hs-identifier hs-var">poly_rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2304"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-2305"></span><span>        </span><span id="local-6989586621682977858"><span class="annot"><span class="annottext">poly_rhs :: OutExpr
</span><a href="#local-6989586621682977858"><span class="hs-identifier hs-var hs-var">poly_rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; OutExpr -&gt; OutExpr
forall b. [b] -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#mkLams"><span class="hs-identifier hs-var">mkLams</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977854"><span class="hs-identifier hs-var">tvs_here</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977855"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-2306"></span><span>        </span><span id="local-6989586621682977857"><span class="annot"><span class="annottext">unf :: Unfolding
</span><a href="#local-6989586621682977857"><span class="hs-identifier hs-var hs-var">unf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
-&gt; UnfoldingSource
-&gt; Bool
-&gt; Bool
-&gt; Bool
-&gt; OutExpr
-&gt; Maybe UnfoldingCache
-&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkUnfolding"><span class="hs-identifier hs-var">mkUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682977739"><span class="hs-identifier hs-var">uf_opts</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="GHC.Types.Basic.html#VanillaSrc"><span class="hs-identifier hs-var">VanillaSrc</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682977757"><span class="hs-identifier hs-var">is_top_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977858"><span class="hs-identifier hs-var">poly_rhs</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe UnfoldingCache
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-2307"></span><span>
</span><span id="line-2308"></span><span>        </span><span class="hs-comment">-- We want the unfolding.  Consider</span><span>
</span><span id="line-2309"></span><span>        </span><span class="hs-comment">--      let</span><span>
</span><span id="line-2310"></span><span>        </span><span class="hs-comment">--            x = /\a. let y = ... in Just y</span><span>
</span><span id="line-2311"></span><span>        </span><span class="hs-comment">--      in body</span><span>
</span><span id="line-2312"></span><span>        </span><span class="hs-comment">-- Then we float the y-binding out (via abstractFloats and addPolyBind)</span><span>
</span><span id="line-2313"></span><span>        </span><span class="hs-comment">-- but 'x' may well then be inlined in 'body' in which case we'd like the</span><span>
</span><span id="line-2314"></span><span>        </span><span class="hs-comment">-- opportunity to inline 'y' too.</span><span>
</span><span id="line-2315"></span><span>
</span><span id="line-2316"></span><span class="hs-comment">{-
Note [Abstract over coercions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If a coercion variable (g :: a ~ Int) is free in the RHS, then so is the
type variable a.  Rather than sort this mess out, we simply bale out and abstract
wrt all the type variables if any of them are coercion variables.


Historical note: if you use let-bindings instead of a substitution, beware of this:

                -- Suppose we start with:
                --
                --      x = /\ a -&gt; let g = G in E
                --
                -- Then we'll float to get
                --
                --      x = let poly_g = /\ a -&gt; G
                --          in /\ a -&gt; let g = poly_g a in E
                --
                -- But now the occurrence analyser will see just one occurrence
                -- of poly_g, not inside a lambda, so the simplifier will
                -- PreInlineUnconditionally poly_g back into g!  Badk to square 1!
                -- (I used to think that the &quot;don't inline lone occurrences&quot; stuff
                --  would stop this happening, but since it's the *only* occurrence,
                --  PreInlineUnconditionally kicks in first!)
                --
                -- Solution: put an INLINE note on g's RHS, so that poly_g seems
                --           to appear many times.  (NB: mkInlineMe eliminates
                --           such notes on trivial RHSs, so do it manually.)

************************************************************************
*                                                                      *
                prepareAlts
*                                                                      *
************************************************************************

prepareAlts tries these things:

1.  filterAlts: eliminate alternatives that cannot match, including
    the DEFAULT alternative.  Here &quot;cannot match&quot; includes knowledge
    from GADTs

2.  refineDefaultAlt: if the DEFAULT alternative can match only one
    possible constructor, then make that constructor explicit.
    e.g.
        case e of x { DEFAULT -&gt; rhs }
     ===&gt;
        case e of x { (a,b) -&gt; rhs }
    where the type is a single constructor type.  This gives better code
    when rhs also scrutinises x or e.
    See GHC.Core.Utils Note [Refine DEFAULT case alternatives]

3. combineIdenticalAlts: combine identical alternatives into a DEFAULT.
   See CoreUtils Note [Combine identical alternatives], which also
   says why we do this on InAlts not on OutAlts

4. Returns a list of the constructors that cannot holds in the
   DEFAULT alternative (if there is one)

It's a good idea to do this stuff before simplifying the alternatives, to
avoid simplifying alternatives we know can't happen, and to come up with
the list of constructors that are handled, to put into the IdInfo of the
case binder, for use when simplifying the alternatives.

Eliminating the default alternative in (1) isn't so obvious, but it can
happen:

data Colour = Red | Green | Blue

f x = case x of
        Red -&gt; ..
        Green -&gt; ..
        DEFAULT -&gt; h x

h y = case y of
        Blue -&gt; ..
        DEFAULT -&gt; [ case y of ... ]

If we inline h into f, the default case of the inlined h can't happen.
If we don't notice this, we may end up filtering out *all* the cases
of the inner case y, which give us nowhere to go!

Note [Shadowing in prepareAlts]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Note that we pass case_bndr::InId to prepareAlts; an /InId/, not an
/OutId/.  This is vital, because `refineDefaultAlt` uses `tys` to build
a new /InAlt/.  If you pass an OutId, we'll end up applying the
substitution twice: disaster (#23012).

However this does mean that filling in the default alt might be
delayed by a simplifier cycle, because an InId has less info than an
OutId.  Test simplCore/should_compile/simpl013 apparently shows this
up, although I'm not sure exactly how..
-}</span><span>
</span><span id="line-2410"></span><span>
</span><span id="line-2411"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#prepareAlts"><span class="hs-identifier hs-type">prepareAlts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#InAlt"><span class="hs-identifier hs-type">InAlt</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#InAlt"><span class="hs-identifier hs-type">InAlt</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2412"></span><span class="hs-comment">-- The returned alternatives can be empty, none are possible</span><span>
</span><span id="line-2413"></span><span class="hs-comment">--</span><span>
</span><span id="line-2414"></span><span class="hs-comment">-- Note that case_bndr is an InId; see Note [Shadowing in prepareAlts]</span><span>
</span><span id="line-2415"></span><span id="prepareAlts"><span class="annot"><span class="annottext">prepareAlts :: OutExpr -&gt; Id -&gt; [InAlt] -&gt; SimplM ([AltCon], [InAlt])
</span><a href="GHC.Core.Opt.Simplify.Utils.html#prepareAlts"><span class="hs-identifier hs-var hs-var">prepareAlts</span></a></span></span><span> </span><span id="local-6989586621682977861"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977861"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621682977862"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977862"><span class="hs-identifier hs-var">case_bndr</span></a></span></span><span> </span><span id="local-6989586621682977863"><span class="annot"><span class="annottext">[InAlt]
</span><a href="#local-6989586621682977863"><span class="hs-identifier hs-var">alts</span></a></span></span><span>
</span><span id="line-2416"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682977864"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682977864"><span class="hs-identifier hs-var">tc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682977865"><span class="annot"><span class="annottext">[OutType]
</span><a href="#local-6989586621682977865"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; OutType -&gt; Maybe (TyCon, [OutType])
OutType -&gt; Maybe (TyCon, [OutType])
</span><a href="GHC.Core.Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; OutType
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977862"><span class="hs-identifier hs-var">case_bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2417"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682977867"><span class="annot"><a href="#local-6989586621682977867"><span class="hs-identifier hs-var">us</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplM [Unique]
forall (m :: * -&gt; *). MonadUnique m =&gt; m [Unique]
</span><a href="GHC.Types.Unique.Supply.html#getUniquesM"><span class="hs-identifier hs-var">getUniquesM</span></a></span><span>
</span><span id="line-2418"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682977869"><span class="annot"><a href="#local-6989586621682977869"><span class="hs-identifier hs-var">idcs1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682977870"><span class="annot"><a href="#local-6989586621682977870"><span class="hs-identifier hs-var">alts1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#filterAlts"><span class="hs-identifier hs-type">filterAlts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977864"><span class="hs-identifier hs-type">tc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977865"><span class="hs-identifier hs-type">tys</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977872"><span class="hs-identifier hs-type">imposs_cons</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977863"><span class="hs-identifier hs-type">alts</span></a></span><span>
</span><span id="line-2419"></span><span>             </span><span class="hs-special">(</span><span id="local-6989586621682977873"><span class="annot"><a href="#local-6989586621682977873"><span class="hs-identifier hs-var">yes2</span></a></span></span><span class="hs-special">,</span><span>  </span><span id="local-6989586621682977874"><span class="annot"><a href="#local-6989586621682977874"><span class="hs-identifier hs-var">alts2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#refineDefaultAlt"><span class="hs-identifier hs-type">refineDefaultAlt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977867"><span class="hs-identifier hs-type">us</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Id.html#idMult"><span class="hs-identifier hs-type">idMult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977862"><span class="hs-identifier hs-type">case_bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682977864"><span class="hs-identifier hs-type">tc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977865"><span class="hs-identifier hs-type">tys</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977869"><span class="hs-identifier hs-type">idcs1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977870"><span class="hs-identifier hs-type">alts1</span></a></span><span>
</span><span id="line-2420"></span><span>               </span><span class="hs-comment">-- The multiplicity on case_bndr's is the multiplicity of the</span><span>
</span><span id="line-2421"></span><span>               </span><span class="hs-comment">-- case expression The newly introduced patterns in</span><span>
</span><span id="line-2422"></span><span>               </span><span class="hs-comment">-- refineDefaultAlt must be scaled by this multiplicity</span><span>
</span><span id="line-2423"></span><span>             </span><span class="hs-special">(</span><span id="local-6989586621682977876"><span class="annot"><a href="#local-6989586621682977876"><span class="hs-identifier hs-var">yes3</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682977877"><span class="annot"><a href="#local-6989586621682977877"><span class="hs-identifier hs-var">idcs3</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682977878"><span class="annot"><a href="#local-6989586621682977878"><span class="hs-identifier hs-var">alts3</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#combineIdenticalAlts"><span class="hs-identifier hs-type">combineIdenticalAlts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977869"><span class="hs-identifier hs-type">idcs1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977874"><span class="hs-identifier hs-type">alts2</span></a></span><span>
</span><span id="line-2424"></span><span>             </span><span class="hs-comment">-- &quot;idcs&quot; stands for &quot;impossible default data constructors&quot;</span><span>
</span><span id="line-2425"></span><span>             </span><span class="hs-comment">-- i.e. the constructors that can't match the default case</span><span>
</span><span id="line-2426"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">when</span></span><span> </span><span class="annot"><a href="#local-6989586621682977873"><span class="hs-identifier hs-type">yes2</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#tick"><span class="hs-identifier hs-type">tick</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Stats.html#FillInCaseDefault"><span class="hs-identifier hs-type">FillInCaseDefault</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977862"><span class="hs-identifier hs-type">case_bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2427"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">when</span></span><span> </span><span class="annot"><a href="#local-6989586621682977876"><span class="hs-identifier hs-type">yes3</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#tick"><span class="hs-identifier hs-type">tick</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Stats.html#AltMerge"><span class="hs-identifier hs-type">AltMerge</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977862"><span class="hs-identifier hs-type">case_bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2428"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682977877"><span class="hs-identifier hs-type">idcs3</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682977878"><span class="hs-identifier hs-type">alts3</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2429"></span><span>
</span><span id="line-2430"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>  </span><span class="hs-comment">-- Not a data type, so nothing interesting happens</span><span>
</span><span id="line-2431"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([AltCon], [InAlt]) -&gt; SimplM ([AltCon], [InAlt])
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[InAlt]
</span><a href="#local-6989586621682977863"><span class="hs-identifier hs-var">alts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2432"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2433"></span><span>    </span><span id="local-6989586621682977872"><span class="annot"><span class="annottext">imposs_cons :: [AltCon]
</span><a href="#local-6989586621682977872"><span class="hs-identifier hs-var hs-var">imposs_cons</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977861"><span class="hs-identifier hs-var">scrut</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2434"></span><span>                    </span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682977882"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977882"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; [AltCon]
</span><a href="GHC.Core.html#otherCons"><span class="hs-identifier hs-var">otherCons</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdUnfoldingFun
</span><a href="GHC.Types.Id.html#idUnfolding"><span class="hs-identifier hs-var">idUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977882"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2435"></span><span>                    </span><span class="annot"><span class="annottext">OutExpr
</span><span class="hs-identifier">_</span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-2436"></span><span>
</span><span id="line-2437"></span><span class="hs-comment">{- Note [Merging nested cases]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The basic case-merge stuff is described in Note [Merge Nested Cases] in GHC.Core.Utils

We do it here in `prepareAlts` (on InAlts) rather than after (on OutAlts) for two reasons:

* It &quot;belongs&quot; here with `filterAlts`, `refineDefaultAlt` and `combineIdenticalAlts`.

* In test perf/compiler/T22428 I found that I was getting extra Simplifer iterations:
    1. Create a join point
    2. That join point gets inlined at all call sites, so it is now dead.
    3. Case-merge happened, but left behind some trivial bindings (see `mergeCaseAlts`)
    4. Get rid of the trivial bindings
  The first two seem reasonable.  It's imaginable that we could do better on
  (3), by making case-merge join-point-aware, but it's not trivial.  But the
  fourth is just stupid.  Rather than always do an extra iteration, it's better
  to do the transformation on the input-end of teh Simplifier.
-}</span><span>
</span><span id="line-2455"></span><span>
</span><span id="line-2456"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
                mkCase
*                                                                      *
************************************************************************

mkCase tries these things

* Note [Eliminate Identity Case]
* Note [Scrutinee Constant Folding]

Note [Eliminate Identity Case]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        case e of               ===&gt; e
                True  -&gt; True;
                False -&gt; False

and similar friends.

Note [Scrutinee Constant Folding]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
     case x op# k# of _ {  ===&gt; case x of _ {
        a1# -&gt; e1                  (a1# inv_op# k#) -&gt; e1
        a2# -&gt; e2                  (a2# inv_op# k#) -&gt; e2
        ...                        ...
        DEFAULT -&gt; ed              DEFAULT -&gt; ed

     where (x op# k#) inv_op# k# == x

And similarly for commuted arguments and for some unary operations.

The purpose of this transformation is not only to avoid an arithmetic
operation at runtime but to allow other transformations to apply in cascade.

Example with the &quot;Merge Nested Cases&quot; optimization (from #12877):

      main = case t of t0
         0##     -&gt; ...
         DEFAULT -&gt; case t0 `minusWord#` 1## of t1
            0##     -&gt; ...
            DEFAULT -&gt; case t1 `minusWord#` 1## of t2
               0##     -&gt; ...
               DEFAULT -&gt; case t2 `minusWord#` 1## of _
                  0##     -&gt; ...
                  DEFAULT -&gt; ...

  becomes:

      main = case t of _
      0##     -&gt; ...
      1##     -&gt; ...
      2##     -&gt; ...
      3##     -&gt; ...
      DEFAULT -&gt; ...

There are some wrinkles.

Wrinkle 1:
  Do not apply caseRules if there is just a single DEFAULT alternative,
  unless the case-binder is dead. Example:
     case e +# 3# of b { DEFAULT -&gt; rhs }
  If we applied the transformation here we would (stupidly) get
     case e of b' { DEFAULT -&gt; let b = b' +# 3# in rhs }
  and now the process may repeat, because that let will really
  be a case. But if the original case binder b is dead, we instead get
     case e of b' { DEFAULT -&gt; rhs }
  and there is no such problem.

  See Note [Example of case-merging and caseRules] for a compelling
  example of why this dead-binder business can be really important.


Wrinkle 2:
  The type of the scrutinee might change.  E.g.
        case tagToEnum (x :: Int#) of (b::Bool)
          False -&gt; e1
          True -&gt; e2
  ==&gt;
        case x of (b'::Int#)
          DEFAULT -&gt; e1
          1#      -&gt; e2

Wrinkle 3:
  The case binder may be used in the right hand sides, so we need
  to make a local binding for it, if it is alive.  e.g.
         case e +# 10# of b
           DEFAULT -&gt; blah...b...
           44#     -&gt; blah2...b...
  ===&gt;
         case e of b'
           DEFAULT -&gt; let b = b' +# 10# in blah...b...
           34#     -&gt; let b = 44# in blah2...b...

  Note that in the non-DEFAULT cases we know what to bind 'b' to,
  whereas in the DEFAULT case we must reconstruct the original value.
  But NB: we use b'; we do not duplicate 'e'.

Wrinkle 4:
  In dataToTag we might need to make up some fake binders;
  see Note [caseRules for dataToTag] in GHC.Core.Opt.ConstantFold


Note [Example of case-merging and caseRules]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The case-transformation rules are quite powerful. Here's a
subtle example from #22375.  We start with

  data T = A | B | ...
    deriving Eq

  f :: T -&gt; String
  f x = if | x==A -&gt; &quot;one&quot;
           | x==B -&gt; &quot;two&quot;
           | ...

In Core after a bit of simplification we get:

    f x = case dataToTagLarge# x of a# { _DEFAULT -&gt;
          case a# of
            _DEFAULT -&gt; case dataToTagLarge# x of b# { _DEFAULT -&gt;
                        case b# of
                           _DEFAULT -&gt; ...
                           1# -&gt; &quot;two&quot;
                        }
            0# -&gt; &quot;one&quot;
          }

Now consider what mkCase does to these case expressions.
The case-merge transformation Note [Merge Nested Cases]
does this (affecting both pairs of cases):

    f x = case dataToTagLarge# x of a# {
             _DEFAULT -&gt; case dataToTagLarge# x of b# {
                          _DEFAULT -&gt; ...
                          1# -&gt; &quot;two&quot;
                         }
             0# -&gt; &quot;one&quot;
          }

Now Note [caseRules for dataToTag] does its work, again
on both dataToTagLarge# cases:

    f x = case x of x1 {
             _DEFAULT -&gt; case dataToTagLarge# x1 of a# { _DEFAULT -&gt;
                         case x of x2 {
                           _DEFAULT -&gt; case dataToTagLarge# x2 of b# { _DEFAULT -&gt; ... }
                           B -&gt; &quot;two&quot;
                         }}
             A -&gt; &quot;one&quot;
          }


The new dataToTagLarge# calls come from the &quot;reconstruct scrutinee&quot; part of
caseRules (note that a# and b# were not dead in the original program
before all this merging).  However, since a# and b# /are/ in fact dead
in the resulting program, we are left with redundant dataToTagLarge# calls.
But they are easily eliminated by doing caseRules again, in
the next Simplifier iteration, this time noticing that a# and b# are
dead.  Hence the &quot;dead-binder&quot; sub-case of Wrinkle 1 of Note
[Scrutinee Constant Folding] above.  Once we do this we get

    f x = case x of x1 {
             _DEFAULT -&gt; case x1 of x2 { _DEFAULT -&gt;
                         case x1 of x2 {
                            _DEFAULT -&gt; case x2 of x3 { _DEFAULT -&gt; ... }
                            B -&gt; &quot;two&quot;
                         }}
             A -&gt; &quot;one&quot;
          }

and now we can do case-merge again, getting the desired

    f x = case x of
            A -&gt; &quot;one&quot;
            B -&gt; &quot;two&quot;
            ...

-}</span><span>
</span><span id="line-2635"></span><span>
</span><span id="line-2636"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#mkCase"><span class="hs-identifier hs-type">mkCase</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#mkCase1"><span class="hs-identifier hs-type">mkCase1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#mkCase2"><span class="hs-identifier hs-type">mkCase2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#mkCase3"><span class="hs-identifier hs-type">mkCase3</span></a></span><span>
</span><span id="line-2637"></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplMode"><span class="hs-identifier hs-type">SimplMode</span></a></span><span>
</span><span id="line-2638"></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span>
</span><span id="line-2639"></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutType"><span class="hs-identifier hs-type">OutType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#OutAlt"><span class="hs-identifier hs-type">OutAlt</span></a></span><span class="hs-special">]</span><span>               </span><span class="hs-comment">-- Alternatives in standard (increasing) order</span><span>
</span><span id="line-2640"></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>
</span><span id="line-2641"></span><span>
</span><span id="line-2642"></span><span class="hs-comment">--------------------------------------------------</span><span>
</span><span id="line-2643"></span><span class="hs-comment">--      1. Merge Nested Cases</span><span>
</span><span id="line-2644"></span><span class="hs-comment">--         See Note [Merge Nested Cases]</span><span>
</span><span id="line-2645"></span><span class="hs-comment">--             Note [Example of case-merging and caseRules]</span><span>
</span><span id="line-2646"></span><span class="hs-comment">--             Note [Cascading case merge]</span><span>
</span><span id="line-2647"></span><span class="hs-comment">--------------------------------------------------</span><span>
</span><span id="line-2648"></span><span>
</span><span id="line-2649"></span><span id="mkCase"><span class="annot"><span class="annottext">mkCase :: SimplMode -&gt; OutExpr -&gt; Id -&gt; OutType -&gt; [InAlt] -&gt; SimplM OutExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#mkCase"><span class="hs-identifier hs-var hs-var">mkCase</span></a></span></span><span> </span><span id="local-6989586621682977888"><span class="annot"><span class="annottext">SimplMode
</span><a href="#local-6989586621682977888"><span class="hs-identifier hs-var">mode</span></a></span></span><span> </span><span id="local-6989586621682977889"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977889"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621682977890"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977890"><span class="hs-identifier hs-var">outer_bndr</span></a></span></span><span> </span><span id="local-6989586621682977891"><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977891"><span class="hs-identifier hs-var">alts_ty</span></a></span></span><span> </span><span id="local-6989586621682977892"><span class="annot"><span class="annottext">[InAlt]
</span><a href="#local-6989586621682977892"><span class="hs-identifier hs-var">alts</span></a></span></span><span>
</span><span id="line-2650"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SimplMode -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Env.html#sm_case_merge"><span class="hs-identifier hs-var">sm_case_merge</span></a></span><span> </span><span class="annot"><span class="annottext">SimplMode
</span><a href="#local-6989586621682977888"><span class="hs-identifier hs-var">mode</span></a></span><span>
</span><span id="line-2651"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682977894"><span class="annot"><span class="annottext">[Bind Id]
</span><a href="#local-6989586621682977894"><span class="hs-identifier hs-var">joins</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682977895"><span class="annot"><span class="annottext">[InAlt]
</span><a href="#local-6989586621682977895"><span class="hs-identifier hs-var">alts'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Id -&gt; [InAlt] -&gt; Maybe ([Bind Id], [InAlt])
</span><a href="GHC.Core.Utils.html#mergeCaseAlts"><span class="hs-identifier hs-var">mergeCaseAlts</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977890"><span class="hs-identifier hs-var">outer_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">[InAlt]
</span><a href="#local-6989586621682977892"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-2652"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Tick -&gt; SimplM ()
</span><a href="GHC.Core.Opt.Simplify.Monad.html#tick"><span class="hs-identifier hs-var">tick</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Tick
</span><a href="GHC.Core.Opt.Stats.html#CaseMerge"><span class="hs-identifier hs-var">CaseMerge</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977890"><span class="hs-identifier hs-var">outer_bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2653"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682977898"><span class="annot"><a href="#local-6989586621682977898"><span class="hs-identifier hs-var">case_expr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplMode -&gt; OutExpr -&gt; Id -&gt; OutType -&gt; [InAlt] -&gt; SimplM OutExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#mkCase1"><span class="hs-identifier hs-var">mkCase1</span></a></span><span> </span><span class="annot"><span class="annottext">SimplMode
</span><a href="#local-6989586621682977888"><span class="hs-identifier hs-var">mode</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977889"><span class="hs-identifier hs-var">scrut</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977890"><span class="hs-identifier hs-var">outer_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977891"><span class="hs-identifier hs-var">alts_ty</span></a></span><span> </span><span class="annot"><span class="annottext">[InAlt]
</span><a href="#local-6989586621682977895"><span class="hs-identifier hs-var">alts'</span></a></span><span>
</span><span id="line-2654"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#mkLets"><span class="hs-identifier hs-type">mkLets</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977894"><span class="hs-identifier hs-type">joins</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977898"><span class="hs-identifier hs-type">case_expr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2655"></span><span>        </span><span class="hs-comment">-- mkCase1: don't call mkCase recursively!</span><span>
</span><span id="line-2656"></span><span>        </span><span class="hs-comment">-- Firstly, there's no point, because inner alts have already had</span><span>
</span><span id="line-2657"></span><span>        </span><span class="hs-comment">-- mkCase applied to them, so they won't have a case in their default</span><span>
</span><span id="line-2658"></span><span>        </span><span class="hs-comment">-- Secondly, if you do, you get an infinite loop, because the bindCaseBndr</span><span>
</span><span id="line-2659"></span><span>        </span><span class="hs-comment">-- in munge_rhs may put a case into the DEFAULT branch!</span><span>
</span><span id="line-2660"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2661"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplMode -&gt; OutExpr -&gt; Id -&gt; OutType -&gt; [InAlt] -&gt; SimplM OutExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#mkCase1"><span class="hs-identifier hs-var">mkCase1</span></a></span><span> </span><span class="annot"><span class="annottext">SimplMode
</span><a href="#local-6989586621682977888"><span class="hs-identifier hs-var">mode</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977889"><span class="hs-identifier hs-var">scrut</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977890"><span class="hs-identifier hs-var">outer_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977891"><span class="hs-identifier hs-var">alts_ty</span></a></span><span> </span><span class="annot"><span class="annottext">[InAlt]
</span><a href="#local-6989586621682977892"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-2662"></span><span>
</span><span id="line-2663"></span><span class="hs-comment">--------------------------------------------------</span><span>
</span><span id="line-2664"></span><span class="hs-comment">--      2. Eliminate Identity Case</span><span>
</span><span id="line-2665"></span><span class="hs-comment">--         See Note [Eliminate Identity Case]</span><span>
</span><span id="line-2666"></span><span class="hs-comment">--------------------------------------------------</span><span>
</span><span id="line-2667"></span><span>
</span><span id="line-2668"></span><span id="mkCase1"><span class="annot"><span class="annottext">mkCase1 :: SimplMode -&gt; OutExpr -&gt; Id -&gt; OutType -&gt; [InAlt] -&gt; SimplM OutExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#mkCase1"><span class="hs-identifier hs-var hs-var">mkCase1</span></a></span></span><span> </span><span id="local-6989586621682977900"><span class="annot"><span class="annottext">SimplMode
</span><a href="#local-6989586621682977900"><span class="hs-identifier hs-var">_mode</span></a></span></span><span> </span><span id="local-6989586621682977901"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977901"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621682977902"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977902"><span class="hs-identifier hs-var">case_bndr</span></a></span></span><span> </span><span class="annot"><span class="annottext">OutType
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682977903"><span class="annot"><span class="annottext">alts :: [InAlt]
</span><a href="#local-6989586621682977903"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682977904"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977904"><span class="hs-identifier hs-var">rhs1</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682977905"><span class="annot"><span class="annottext">[InAlt]
</span><a href="#local-6989586621682977905"><span class="hs-identifier hs-var">alts'</span></a></span></span><span class="hs-special">)</span><span>      </span><span class="hs-comment">-- Identity case</span><span>
</span><span id="line-2669"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">(InAlt -&gt; Bool) -&gt; [InAlt] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">InAlt -&gt; Bool
</span><a href="#local-6989586621682977906"><span class="hs-identifier hs-var">identity_alt</span></a></span><span> </span><span class="annot"><span class="annottext">[InAlt]
</span><a href="#local-6989586621682977903"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-2670"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Tick -&gt; SimplM ()
</span><a href="GHC.Core.Opt.Simplify.Monad.html#tick"><span class="hs-identifier hs-var">tick</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Tick
</span><a href="GHC.Core.Opt.Stats.html#CaseIdentity"><span class="hs-identifier hs-var">CaseIdentity</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977902"><span class="hs-identifier hs-var">case_bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2671"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; SimplM OutExpr
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreTickish] -&gt; OutExpr -&gt; OutExpr
</span><a href="GHC.Core.Utils.html#mkTicks"><span class="hs-identifier hs-var">mkTicks</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682977909"><span class="hs-identifier hs-var">ticks</span></a></span><span> </span><span class="annot"><span class="annottext">(OutExpr -&gt; OutExpr) -&gt; OutExpr -&gt; OutExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; OutExpr -&gt; OutExpr
forall {b} {b}. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="#local-6989586621682977910"><span class="hs-identifier hs-var">re_cast</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977901"><span class="hs-identifier hs-var">scrut</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977904"><span class="hs-identifier hs-var">rhs1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2672"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2673"></span><span>    </span><span id="local-6989586621682977909"><span class="annot"><span class="annottext">ticks :: [CoreTickish]
</span><a href="#local-6989586621682977909"><span class="hs-identifier hs-var hs-var">ticks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(InAlt -&gt; [CoreTickish]) -&gt; [InAlt] -&gt; [CoreTickish]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682977911"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977911"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(CoreTickish -&gt; Bool) -&gt; OutExpr -&gt; [CoreTickish]
forall b. (CoreTickish -&gt; Bool) -&gt; Expr b -&gt; [CoreTickish]
</span><a href="GHC.Core.Utils.html#stripTicksT"><span class="hs-identifier hs-var">stripTicksT</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977911"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[InAlt]
</span><a href="#local-6989586621682977905"><span class="hs-identifier hs-var">alts'</span></a></span><span>
</span><span id="line-2674"></span><span>    </span><span id="local-6989586621682977906"><span class="annot"><span class="annottext">identity_alt :: InAlt -&gt; Bool
</span><a href="#local-6989586621682977906"><span class="hs-identifier hs-var hs-var">identity_alt</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span id="local-6989586621682977913"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682977913"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span id="local-6989586621682977914"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977914"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621682977915"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977915"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; AltCon -&gt; [Id] -&gt; Bool
</span><a href="#local-6989586621682977916"><span class="hs-identifier hs-var">check_eq</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977915"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682977913"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977914"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-2675"></span><span>
</span><span id="line-2676"></span><span>    </span><span id="local-6989586621682977916"><span class="annot"><span class="annottext">check_eq :: OutExpr -&gt; AltCon -&gt; [Id] -&gt; Bool
</span><a href="#local-6989586621682977916"><span class="hs-identifier hs-var hs-var">check_eq</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682977917"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977917"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span id="local-6989586621682977918"><span class="annot"><span class="annottext">OutCoercion
</span><a href="#local-6989586621682977918"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682977919"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682977919"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span id="local-6989586621682977920"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977920"><span class="hs-identifier hs-var">args</span></a></span></span><span>        </span><span class="hs-comment">-- See Note [RHS casts]</span><span>
</span><span id="line-2677"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; [Id] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; TyCoVarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">OutCoercion -&gt; TyCoVarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfCo"><span class="hs-identifier hs-var">tyCoVarsOfCo</span></a></span><span> </span><span class="annot"><span class="annottext">OutCoercion
</span><a href="#local-6989586621682977918"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977920"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; AltCon -&gt; [Id] -&gt; Bool
</span><a href="#local-6989586621682977916"><span class="hs-identifier hs-var">check_eq</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977917"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682977919"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977920"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-2678"></span><span>    </span><span class="annot"><a href="#local-6989586621682977916"><span class="hs-identifier hs-var">check_eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621682977921"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682977921"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621682977922"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977922"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682977923"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682977923"><span class="hs-identifier hs-var">alt</span></a></span></span><span> </span><span id="local-6989586621682977924"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977924"><span class="hs-identifier hs-var">args</span></a></span></span><span>
</span><span id="line-2679"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682977921"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; AltCon -&gt; [Id] -&gt; Bool
</span><a href="#local-6989586621682977916"><span class="hs-identifier hs-var">check_eq</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977922"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682977923"><span class="hs-identifier hs-var">alt</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977924"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-2680"></span><span>
</span><span id="line-2681"></span><span>    </span><span class="annot"><a href="#local-6989586621682977916"><span class="hs-identifier hs-var">check_eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-type">Lit</span></a></span><span> </span><span id="local-6989586621682977925"><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621682977925"><span class="hs-identifier hs-var">lit</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#LitAlt"><span class="hs-identifier hs-type">LitAlt</span></a></span><span> </span><span id="local-6989586621682977927"><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621682977927"><span class="hs-identifier hs-var">lit'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><span class="hs-identifier">_</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621682977925"><span class="hs-identifier hs-var">lit</span></a></span><span> </span><span class="annot"><span class="annottext">Literal -&gt; Literal -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621682977927"><span class="hs-identifier hs-var">lit'</span></a></span><span>
</span><span id="line-2682"></span><span>    </span><span class="annot"><a href="#local-6989586621682977916"><span class="hs-identifier hs-var">check_eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682977928"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977928"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AltCon
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977928"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Id -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977902"><span class="hs-identifier hs-var">case_bndr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-2683"></span><span>    </span><span class="annot"><a href="#local-6989586621682977916"><span class="hs-identifier hs-var">check_eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682977929"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977929"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#DataAlt"><span class="hs-identifier hs-type">DataAlt</span></a></span><span> </span><span id="local-6989586621682977931"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682977931"><span class="hs-identifier hs-var">con</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682977932"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977932"><span class="hs-identifier hs-var">args</span></a></span></span><span>
</span><span id="line-2684"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[OutType] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[OutType]
</span><a href="#local-6989586621682977933"><span class="hs-identifier hs-var">arg_tys</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977932"><span class="hs-identifier hs-var">args</span></a></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977929"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Id -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; Id
</span><a href="GHC.Core.DataCon.html#dataConWorkId"><span class="hs-identifier hs-var">dataConWorkId</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682977931"><span class="hs-identifier hs-var">con</span></a></span><span>
</span><span id="line-2685"></span><span>                                             </span><span class="hs-comment">-- Optimisation only</span><span>
</span><span id="line-2686"></span><span>    </span><span class="annot"><a href="#local-6989586621682977916"><span class="hs-identifier hs-var">check_eq</span></a></span><span> </span><span id="local-6989586621682977934"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977934"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#DataAlt"><span class="hs-identifier hs-type">DataAlt</span></a></span><span> </span><span id="local-6989586621682977935"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682977935"><span class="hs-identifier hs-var">con</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682977936"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977936"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreTickish -&gt; Bool) -&gt; OutExpr -&gt; OutExpr -&gt; Bool
forall b. (CoreTickish -&gt; Bool) -&gt; Expr b -&gt; Expr b -&gt; Bool
</span><a href="GHC.Core.Utils.html#cheapEqExpr%27"><span class="hs-identifier hs-var">cheapEqExpr'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977934"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">(OutExpr -&gt; Bool) -&gt; OutExpr -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2687"></span><span>                                             </span><span class="annot"><span class="annottext">DataCon -&gt; [OutType] -&gt; [Id] -&gt; OutExpr
forall b. DataCon -&gt; [OutType] -&gt; [Id] -&gt; Expr b
</span><a href="GHC.Core.html#mkConApp2"><span class="hs-identifier hs-var">mkConApp2</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682977935"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">[OutType]
</span><a href="#local-6989586621682977933"><span class="hs-identifier hs-var">arg_tys</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977936"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-2688"></span><span>    </span><span class="annot"><a href="#local-6989586621682977916"><span class="hs-identifier hs-var">check_eq</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><span class="hs-identifier">_</span></span><span>          </span><span class="annot"><span class="annottext">AltCon
</span><span class="hs-identifier">_</span></span><span>             </span><span class="annot"><span class="annottext">[Id]
</span><span class="hs-identifier">_</span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-2689"></span><span>
</span><span id="line-2690"></span><span>    </span><span id="local-6989586621682977933"><span class="annot"><span class="annottext">arg_tys :: [OutType]
</span><a href="#local-6989586621682977933"><span class="hs-identifier hs-var hs-var">arg_tys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; OutType -&gt; [OutType]
OutType -&gt; [OutType]
</span><a href="GHC.Core.Type.html#tyConAppArgs"><span class="hs-identifier hs-var">tyConAppArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; OutType
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977902"><span class="hs-identifier hs-var">case_bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2691"></span><span>
</span><span id="line-2692"></span><span>        </span><span class="hs-comment">-- Note [RHS casts]</span><span>
</span><span id="line-2693"></span><span>        </span><span class="hs-comment">-- ~~~~~~~~~~~~~~~~</span><span>
</span><span id="line-2694"></span><span>        </span><span class="hs-comment">-- We've seen this:</span><span>
</span><span id="line-2695"></span><span>        </span><span class="hs-comment">--      case e of x { _ -&gt; x `cast` c }</span><span>
</span><span id="line-2696"></span><span>        </span><span class="hs-comment">-- And we definitely want to eliminate this case, to give</span><span>
</span><span id="line-2697"></span><span>        </span><span class="hs-comment">--      e `cast` c</span><span>
</span><span id="line-2698"></span><span>        </span><span class="hs-comment">-- So we throw away the cast from the RHS, and reconstruct</span><span>
</span><span id="line-2699"></span><span>        </span><span class="hs-comment">-- it at the other end.  All the RHS casts must be the same</span><span>
</span><span id="line-2700"></span><span>        </span><span class="hs-comment">-- if (all identity_alt alts) holds.</span><span>
</span><span id="line-2701"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-2702"></span><span>        </span><span class="hs-comment">-- Don't worry about nested casts, because the simplifier combines them</span><span>
</span><span id="line-2703"></span><span>
</span><span id="line-2704"></span><span>    </span><span id="local-6989586621682977910"><span class="annot"><span class="annottext">re_cast :: Expr b -&gt; Expr b -&gt; Expr b
</span><a href="#local-6989586621682977910"><span class="hs-identifier hs-var hs-var">re_cast</span></a></span></span><span> </span><span id="local-6989586621682977940"><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621682977940"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682977941"><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621682977941"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span id="local-6989586621682977942"><span class="annot"><span class="annottext">OutCoercion
</span><a href="#local-6989586621682977942"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr b -&gt; OutCoercion -&gt; Expr b
forall b. Expr b -&gt; OutCoercion -&gt; Expr b
</span><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-var">Cast</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr b -&gt; Expr b -&gt; Expr b
</span><a href="#local-6989586621682977910"><span class="hs-identifier hs-var">re_cast</span></a></span><span> </span><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621682977940"><span class="hs-identifier hs-var">scrut</span></a></span><span> </span><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621682977941"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OutCoercion
</span><a href="#local-6989586621682977942"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-2705"></span><span>    </span><span class="annot"><a href="#local-6989586621682977910"><span class="hs-identifier hs-var">re_cast</span></a></span><span> </span><span id="local-6989586621682977943"><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621682977943"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span class="annot"><span class="annottext">Expr b
</span><span class="hs-identifier">_</span></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621682977943"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-2706"></span><span>
</span><span id="line-2707"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#mkCase1"><span class="hs-identifier hs-var">mkCase1</span></a></span><span> </span><span id="local-6989586621682977944"><span class="annot"><span class="annottext">SimplMode
</span><a href="#local-6989586621682977944"><span class="hs-identifier hs-var">mode</span></a></span></span><span> </span><span id="local-6989586621682977945"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977945"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621682977946"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977946"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682977947"><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977947"><span class="hs-identifier hs-var">alts_ty</span></a></span></span><span> </span><span id="local-6989586621682977948"><span class="annot"><span class="annottext">[InAlt]
</span><a href="#local-6989586621682977948"><span class="hs-identifier hs-var">alts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplMode -&gt; OutExpr -&gt; Id -&gt; OutType -&gt; [InAlt] -&gt; SimplM OutExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#mkCase2"><span class="hs-identifier hs-var">mkCase2</span></a></span><span> </span><span class="annot"><span class="annottext">SimplMode
</span><a href="#local-6989586621682977944"><span class="hs-identifier hs-var">mode</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977945"><span class="hs-identifier hs-var">scrut</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977946"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977947"><span class="hs-identifier hs-var">alts_ty</span></a></span><span> </span><span class="annot"><span class="annottext">[InAlt]
</span><a href="#local-6989586621682977948"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-2708"></span><span>
</span><span id="line-2709"></span><span>
</span><span id="line-2710"></span><span class="hs-comment">--------------------------------------------------</span><span>
</span><span id="line-2711"></span><span class="hs-comment">--      2. Scrutinee Constant Folding</span><span>
</span><span id="line-2712"></span><span class="hs-comment">--         See Note [Scrutinee Constant Folding]</span><span>
</span><span id="line-2713"></span><span class="hs-comment">--------------------------------------------------</span><span>
</span><span id="line-2714"></span><span>
</span><span id="line-2715"></span><span id="mkCase2"><span class="annot"><span class="annottext">mkCase2 :: SimplMode -&gt; OutExpr -&gt; Id -&gt; OutType -&gt; [InAlt] -&gt; SimplM OutExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#mkCase2"><span class="hs-identifier hs-var hs-var">mkCase2</span></a></span></span><span> </span><span id="local-6989586621682977949"><span class="annot"><span class="annottext">SimplMode
</span><a href="#local-6989586621682977949"><span class="hs-identifier hs-var">mode</span></a></span></span><span> </span><span id="local-6989586621682977950"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977950"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621682977951"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977951"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682977952"><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977952"><span class="hs-identifier hs-var">alts_ty</span></a></span></span><span> </span><span id="local-6989586621682977953"><span class="annot"><span class="annottext">[InAlt]
</span><a href="#local-6989586621682977953"><span class="hs-identifier hs-var">alts</span></a></span></span><span>
</span><span id="line-2716"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-comment">-- See Note [Scrutinee Constant Folding]</span><span>
</span><span id="line-2717"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[InAlt]
</span><a href="#local-6989586621682977953"><span class="hs-identifier hs-var">alts</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2718"></span><span>      </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="GHC.Core.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><span class="hs-identifier">_</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isDeadBinder"><span class="hs-identifier hs-var">isDeadBinder</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977951"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="hs-comment">-- see wrinkle 1</span><span>
</span><span id="line-2719"></span><span>      </span><span class="annot"><span class="annottext">[InAlt]
</span><span class="hs-identifier">_</span></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-2720"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SimplMode -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Env.html#sm_case_folding"><span class="hs-identifier hs-var">sm_case_folding</span></a></span><span> </span><span class="annot"><span class="annottext">SimplMode
</span><a href="#local-6989586621682977949"><span class="hs-identifier hs-var">mode</span></a></span><span>
</span><span id="line-2721"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682977956"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977956"><span class="hs-identifier hs-var">scrut'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682977957"><span class="annot"><span class="annottext">AltCon -&gt; Maybe AltCon
</span><a href="#local-6989586621682977957"><span class="hs-identifier hs-var">tx_con</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682977958"><span class="annot"><span class="annottext">Id -&gt; OutExpr
</span><a href="#local-6989586621682977958"><span class="hs-identifier hs-var">mk_orig</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Platform
-&gt; OutExpr
-&gt; Maybe (OutExpr, AltCon -&gt; Maybe AltCon, Id -&gt; OutExpr)
</span><a href="GHC.Core.Opt.ConstantFold.html#caseRules"><span class="hs-identifier hs-var">caseRules</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplMode -&gt; Platform
</span><a href="GHC.Core.Opt.Simplify.Env.html#smPlatform"><span class="hs-identifier hs-var">smPlatform</span></a></span><span> </span><span class="annot"><span class="annottext">SimplMode
</span><a href="#local-6989586621682977949"><span class="hs-identifier hs-var">mode</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977950"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-2722"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682977961"><span class="annot"><a href="#local-6989586621682977961"><span class="hs-identifier hs-var">bndr'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FastString -&gt; OutType -&gt; OutType -&gt; SimplM Id
</span><a href="GHC.Core.Opt.Simplify.Monad.html#newId"><span class="hs-identifier hs-var">newId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; FastString
</span><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;lwild&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="GHC.Core.Type.html#ManyTy"><span class="hs-identifier hs-var">ManyTy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; OutExpr -&gt; OutType
OutExpr -&gt; OutType
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977956"><span class="hs-identifier hs-var">scrut'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2723"></span><span>
</span><span id="line-2724"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682977965"><span class="annot"><a href="#local-6989586621682977965"><span class="hs-identifier hs-var">alts'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Utils.Monad.html#mapMaybeM"><span class="hs-identifier hs-type">mapMaybeM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682977967"><span class="hs-identifier hs-type">tx_alt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977957"><span class="hs-identifier hs-type">tx_con</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977958"><span class="hs-identifier hs-type">mk_orig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977961"><span class="hs-identifier hs-type">bndr'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682977953"><span class="hs-identifier hs-type">alts</span></a></span><span>
</span><span id="line-2725"></span><span>                  </span><span class="hs-comment">-- mapMaybeM: discard unreachable alternatives</span><span>
</span><span id="line-2726"></span><span>                  </span><span class="hs-comment">-- See Note [Unreachable caseRules alternatives]</span><span>
</span><span id="line-2727"></span><span>                  </span><span class="hs-comment">-- in GHC.Core.Opt.ConstantFold</span><span>
</span><span id="line-2728"></span><span>
</span><span id="line-2729"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#mkCase3"><span class="hs-identifier hs-type">mkCase3</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977949"><span class="hs-identifier hs-type">mode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977956"><span class="hs-identifier hs-type">scrut'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977961"><span class="hs-identifier hs-type">bndr'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977952"><span class="hs-identifier hs-type">alts_ty</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-2730"></span><span>         </span><span class="annot"><a href="#local-6989586621682977968"><span class="hs-identifier hs-type">add_default</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682977969"><span class="hs-identifier hs-type">re_sort</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977965"><span class="hs-identifier hs-type">alts'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2731"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-2732"></span><span>
</span><span id="line-2733"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2734"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplMode -&gt; OutExpr -&gt; Id -&gt; OutType -&gt; [InAlt] -&gt; SimplM OutExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#mkCase3"><span class="hs-identifier hs-var">mkCase3</span></a></span><span> </span><span class="annot"><span class="annottext">SimplMode
</span><a href="#local-6989586621682977949"><span class="hs-identifier hs-var">mode</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977950"><span class="hs-identifier hs-var">scrut</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977951"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682977952"><span class="hs-identifier hs-var">alts_ty</span></a></span><span> </span><span class="annot"><span class="annottext">[InAlt]
</span><a href="#local-6989586621682977953"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-2735"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2736"></span><span>    </span><span class="hs-comment">-- We need to keep the correct association between the scrutinee and its</span><span>
</span><span id="line-2737"></span><span>    </span><span class="hs-comment">-- binder if the latter isn't dead. Hence we wrap rhs of alternatives with</span><span>
</span><span id="line-2738"></span><span>    </span><span class="hs-comment">-- &quot;let bndr = ... in&quot;:</span><span>
</span><span id="line-2739"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-2740"></span><span>    </span><span class="hs-comment">--     case v + 10 of y        =====&gt; case v of y'</span><span>
</span><span id="line-2741"></span><span>    </span><span class="hs-comment">--        20      -&gt; e1                 10      -&gt; let y = 20      in e1</span><span>
</span><span id="line-2742"></span><span>    </span><span class="hs-comment">--        DEFAULT -&gt; e2                 DEFAULT -&gt; let y = y' + 10 in e2</span><span>
</span><span id="line-2743"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-2744"></span><span>    </span><span class="hs-comment">-- This wrapping is done in tx_alt; we use mk_orig, returned by caseRules,</span><span>
</span><span id="line-2745"></span><span>    </span><span class="hs-comment">-- to construct an expression equivalent to the original one, for use</span><span>
</span><span id="line-2746"></span><span>    </span><span class="hs-comment">-- in the DEFAULT case</span><span>
</span><span id="line-2747"></span><span>
</span><span id="line-2748"></span><span>    </span><span class="annot"><a href="#local-6989586621682977967"><span class="hs-identifier hs-type">tx_alt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>
</span><span id="line-2749"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2750"></span><span>    </span><span id="local-6989586621682977967"><span class="annot"><span class="annottext">tx_alt :: (AltCon -&gt; Maybe AltCon)
-&gt; (Id -&gt; OutExpr) -&gt; Id -&gt; InAlt -&gt; SimplM (Maybe InAlt)
</span><a href="#local-6989586621682977967"><span class="hs-identifier hs-var hs-var">tx_alt</span></a></span></span><span> </span><span id="local-6989586621682977971"><span class="annot"><span class="annottext">AltCon -&gt; Maybe AltCon
</span><a href="#local-6989586621682977971"><span class="hs-identifier hs-var">tx_con</span></a></span></span><span> </span><span id="local-6989586621682977972"><span class="annot"><span class="annottext">Id -&gt; OutExpr
</span><a href="#local-6989586621682977972"><span class="hs-identifier hs-var">mk_orig</span></a></span></span><span> </span><span id="local-6989586621682977973"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977973"><span class="hs-identifier hs-var">new_bndr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span id="local-6989586621682977974"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682977974"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span id="local-6989586621682977975"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977975"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621682977976"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977976"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2751"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">AltCon -&gt; Maybe AltCon
</span><a href="#local-6989586621682977971"><span class="hs-identifier hs-var">tx_con</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682977974"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2752"></span><span>          </span><span class="annot"><span class="annottext">Maybe AltCon
</span><span class="hs-identifier hs-var">Nothing</span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe InAlt -&gt; SimplM (Maybe InAlt)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe InAlt
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-2753"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682977977"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682977977"><span class="hs-identifier hs-var">con'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682977978"><span class="annot"><a href="#local-6989586621682977978"><span class="hs-identifier hs-var">bs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Id -&gt; AltCon -&gt; SimplM [Id]
forall {m :: * -&gt; *}. MonadUnique m =&gt; Id -&gt; AltCon -&gt; m [Id]
</span><a href="#local-6989586621682977979"><span class="hs-identifier hs-var">mk_new_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977973"><span class="hs-identifier hs-var">new_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682977977"><span class="hs-identifier hs-var">con'</span></a></span><span>
</span><span id="line-2754"></span><span>                          </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977977"><span class="hs-identifier hs-type">con'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977978"><span class="hs-identifier hs-type">bs'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682977980"><span class="hs-identifier hs-type">rhs'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2755"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-2756"></span><span>        </span><span id="local-6989586621682977980"><span class="annot"><span class="annottext">rhs' :: OutExpr
</span><a href="#local-6989586621682977980"><span class="hs-identifier hs-var hs-var">rhs'</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isDeadBinder"><span class="hs-identifier hs-var">isDeadBinder</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977951"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977976"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-2757"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Id -&gt; OutExpr -&gt; OutExpr -&gt; OutExpr
Id -&gt; OutExpr -&gt; OutExpr -&gt; OutExpr
</span><a href="GHC.Core.Utils.html#bindNonRec"><span class="hs-identifier hs-var">bindNonRec</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977951"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977982"><span class="hs-identifier hs-var">orig_val</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682977976"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-2758"></span><span>
</span><span id="line-2759"></span><span>        </span><span id="local-6989586621682977982"><span class="annot"><span class="annottext">orig_val :: OutExpr
</span><a href="#local-6989586621682977982"><span class="hs-identifier hs-var hs-var">orig_val</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682977974"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2760"></span><span>                      </span><span class="annot"><span class="annottext">AltCon
</span><a href="GHC.Core.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Id -&gt; OutExpr
</span><a href="#local-6989586621682977972"><span class="hs-identifier hs-var">mk_orig</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977973"><span class="hs-identifier hs-var">new_bndr</span></a></span><span>
</span><span id="line-2761"></span><span>                      </span><span class="annot"><a href="GHC.Core.html#LitAlt"><span class="hs-identifier hs-type">LitAlt</span></a></span><span> </span><span id="local-6989586621682977983"><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621682977983"><span class="hs-identifier hs-var">l</span></a></span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Literal -&gt; OutExpr
forall b. Literal -&gt; Expr b
</span><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-var">Lit</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621682977983"><span class="hs-identifier hs-var">l</span></a></span><span>
</span><span id="line-2762"></span><span>                      </span><span class="annot"><a href="GHC.Core.html#DataAlt"><span class="hs-identifier hs-type">DataAlt</span></a></span><span> </span><span id="local-6989586621682977984"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682977984"><span class="hs-identifier hs-var">dc</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; [OutType] -&gt; [Id] -&gt; OutExpr
forall b. DataCon -&gt; [OutType] -&gt; [Id] -&gt; Expr b
</span><a href="GHC.Core.html#mkConApp2"><span class="hs-identifier hs-var">mkConApp2</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682977984"><span class="hs-identifier hs-var">dc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; OutType -&gt; [OutType]
OutType -&gt; [OutType]
</span><a href="GHC.Core.Type.html#tyConAppArgs"><span class="hs-identifier hs-var">tyConAppArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; OutType
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682977951"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682977975"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-2763"></span><span>
</span><span id="line-2764"></span><span>    </span><span id="local-6989586621682977979"><span class="annot"><span class="annottext">mk_new_bndrs :: Id -&gt; AltCon -&gt; m [Id]
</span><a href="#local-6989586621682977979"><span class="hs-identifier hs-var hs-var">mk_new_bndrs</span></a></span></span><span> </span><span id="local-6989586621682978002"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682978002"><span class="hs-identifier hs-var">new_bndr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#DataAlt"><span class="hs-identifier hs-type">DataAlt</span></a></span><span> </span><span id="local-6989586621682978003"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682978003"><span class="hs-identifier hs-var">dc</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2765"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; Bool
</span><a href="GHC.Core.DataCon.html#isNullaryRepDataCon"><span class="hs-identifier hs-var">isNullaryRepDataCon</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682978003"><span class="hs-identifier hs-var">dc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2766"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- For non-nullary data cons we must invent some fake binders</span><span>
</span><span id="line-2767"></span><span>        </span><span class="hs-comment">-- See Note [caseRules for dataToTag] in GHC.Core.Opt.ConstantFold</span><span>
</span><span id="line-2768"></span><span>        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682978004"><span class="annot"><a href="#local-6989586621682978004"><span class="hs-identifier hs-var">us</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m [Unique]
forall (m :: * -&gt; *). MonadUnique m =&gt; m [Unique]
</span><a href="GHC.Types.Unique.Supply.html#getUniquesM"><span class="hs-identifier hs-var">getUniquesM</span></a></span><span>
</span><span id="line-2769"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682978005"><span class="annot"><a href="#local-6989586621682978005"><span class="hs-identifier hs-var">ex_tvs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682978006"><span class="annot"><a href="#local-6989586621682978006"><span class="hs-identifier hs-var">arg_ids</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#dataConRepInstPat"><span class="hs-identifier hs-type">dataConRepInstPat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682978004"><span class="hs-identifier hs-type">us</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Id.html#idMult"><span class="hs-identifier hs-type">idMult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682978002"><span class="hs-identifier hs-type">new_bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682978003"><span class="hs-identifier hs-type">dc</span></a></span><span>
</span><span id="line-2770"></span><span>                                        </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Type.html#tyConAppArgs"><span class="hs-identifier hs-type">tyConAppArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-type">idType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682978002"><span class="hs-identifier hs-type">new_bndr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2771"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682978005"><span class="hs-identifier hs-type">ex_tvs</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621682978006"><span class="hs-identifier hs-type">arg_ids</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2772"></span><span>    </span><span class="annot"><a href="#local-6989586621682977979"><span class="hs-identifier hs-var">mk_new_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; m [Id]
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-2773"></span><span>
</span><span id="line-2774"></span><span>    </span><span class="annot"><a href="#local-6989586621682977969"><span class="hs-identifier hs-type">re_sort</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2775"></span><span>    </span><span class="hs-comment">-- Sort the alternatives to re-establish</span><span>
</span><span id="line-2776"></span><span>    </span><span class="hs-comment">-- GHC.Core Note [Case expression invariants]</span><span>
</span><span id="line-2777"></span><span>    </span><span id="local-6989586621682977969"><span class="annot"><span class="annottext">re_sort :: [InAlt] -&gt; [InAlt]
</span><a href="#local-6989586621682977969"><span class="hs-identifier hs-var hs-var">re_sort</span></a></span></span><span> </span><span id="local-6989586621682978008"><span class="annot"><span class="annottext">[InAlt]
</span><a href="#local-6989586621682978008"><span class="hs-identifier hs-var">alts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(InAlt -&gt; InAlt -&gt; Ordering) -&gt; [InAlt] -&gt; [InAlt]
forall a. (a -&gt; a -&gt; Ordering) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sortBy</span></span><span> </span><span class="annot"><span class="annottext">InAlt -&gt; InAlt -&gt; Ordering
forall a. Alt a -&gt; Alt a -&gt; Ordering
</span><a href="GHC.Core.html#cmpAlt"><span class="hs-identifier hs-var">cmpAlt</span></a></span><span> </span><span class="annot"><span class="annottext">[InAlt]
</span><a href="#local-6989586621682978008"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-2778"></span><span>
</span><span id="line-2779"></span><span>    </span><span class="annot"><a href="#local-6989586621682977968"><span class="hs-identifier hs-type">add_default</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2780"></span><span>    </span><span class="hs-comment">-- See Note [Literal cases]</span><span>
</span><span id="line-2781"></span><span>    </span><span id="local-6989586621682977968"><span class="annot"><span class="annottext">add_default :: [InAlt] -&gt; [InAlt]
</span><a href="#local-6989586621682977968"><span class="hs-identifier hs-var hs-var">add_default</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#LitAlt"><span class="hs-identifier hs-type">LitAlt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621682978010"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682978010"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621682978011"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682978011"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682978012"><span class="annot"><span class="annottext">[InAlt]
</span><a href="#local-6989586621682978012"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AltCon -&gt; [Id] -&gt; OutExpr -&gt; InAlt
forall b. AltCon -&gt; [b] -&gt; Expr b -&gt; Alt b
</span><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-var">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="GHC.Core.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682978010"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682978011"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">InAlt -&gt; [InAlt] -&gt; [InAlt]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[InAlt]
</span><a href="#local-6989586621682978012"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-2782"></span><span>    </span><span class="annot"><a href="#local-6989586621682977968"><span class="hs-identifier hs-var">add_default</span></a></span><span> </span><span id="local-6989586621682978013"><span class="annot"><span class="annottext">[InAlt]
</span><a href="#local-6989586621682978013"><span class="hs-identifier hs-var">alts</span></a></span></span><span>                            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[InAlt]
</span><a href="#local-6989586621682978013"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-2783"></span><span>
</span><span id="line-2784"></span><span class="hs-comment">{- Note [Literal cases]
~~~~~~~~~~~~~~~~~~~~~~~
If we have
  case tagToEnum (a &gt;# b) of
     False -&gt; e1
     True  -&gt; e2

then caseRules for TagToEnum will turn it into
  case tagToEnum (a &gt;# b) of
     0# -&gt; e1
     1# -&gt; e2

Since the case is exhaustive (all cases are) we can convert it to
  case tagToEnum (a &gt;# b) of
     DEFAULT -&gt; e1
     1#      -&gt; e2

This may generate slightly better code (although it should not, since
all cases are exhaustive) and/or optimise better.  I'm not certain that
it's necessary, but currently we do make this change.  We do it here,
NOT in the TagToEnum rules (see &quot;Beware&quot; in Note [caseRules for tagToEnum]
in GHC.Core.Opt.ConstantFold)
-}</span><span>
</span><span id="line-2807"></span><span>
</span><span id="line-2808"></span><span class="hs-comment">--------------------------------------------------</span><span>
</span><span id="line-2809"></span><span class="hs-comment">--      Catch-all</span><span>
</span><span id="line-2810"></span><span class="hs-comment">--------------------------------------------------</span><span>
</span><span id="line-2811"></span><span id="mkCase3"><span class="annot"><span class="annottext">mkCase3 :: SimplMode -&gt; OutExpr -&gt; Id -&gt; OutType -&gt; [InAlt] -&gt; SimplM OutExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#mkCase3"><span class="hs-identifier hs-var hs-var">mkCase3</span></a></span></span><span> </span><span id="local-6989586621682978014"><span class="annot"><span class="annottext">SimplMode
</span><a href="#local-6989586621682978014"><span class="hs-identifier hs-var">_mode</span></a></span></span><span> </span><span id="local-6989586621682978015"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682978015"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621682978016"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682978016"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682978017"><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682978017"><span class="hs-identifier hs-var">alts_ty</span></a></span></span><span> </span><span id="local-6989586621682978018"><span class="annot"><span class="annottext">[InAlt]
</span><a href="#local-6989586621682978018"><span class="hs-identifier hs-var">alts</span></a></span></span><span>
</span><span id="line-2812"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; SimplM OutExpr
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutExpr -&gt; Id -&gt; OutType -&gt; [InAlt] -&gt; OutExpr
forall b. Expr b -&gt; b -&gt; OutType -&gt; [Alt b] -&gt; Expr b
</span><a href="GHC.Core.html#Case"><span class="hs-identifier hs-var">Case</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621682978015"><span class="hs-identifier hs-var">scrut</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682978016"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">OutType
</span><a href="#local-6989586621682978017"><span class="hs-identifier hs-var">alts_ty</span></a></span><span> </span><span class="annot"><span class="annottext">[InAlt]
</span><a href="#local-6989586621682978018"><span class="hs-identifier hs-var">alts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2813"></span><span>
</span><span id="line-2814"></span><span class="hs-comment">-- See Note [Exitification] and Note [Do not inline exit join points] in</span><span>
</span><span id="line-2815"></span><span class="hs-comment">-- GHC.Core.Opt.Exitify</span><span>
</span><span id="line-2816"></span><span class="hs-comment">-- This lives here (and not in Id) because occurrence info is only valid on</span><span>
</span><span id="line-2817"></span><span class="hs-comment">-- InIds, so it's crucial that isExitJoinId is only called on freshly</span><span>
</span><span id="line-2818"></span><span class="hs-comment">-- occ-analysed code. It's not a generic function you can call anywhere.</span><span>
</span><span id="line-2819"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#isExitJoinId"><span class="hs-identifier hs-type">isExitJoinId</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-2820"></span><span id="isExitJoinId"><span class="annot"><span class="annottext">isExitJoinId :: Id -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#isExitJoinId"><span class="hs-identifier hs-var hs-var">isExitJoinId</span></a></span></span><span> </span><span id="local-6989586621682978019"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682978019"><span class="hs-identifier hs-var">id</span></a></span></span><span>
</span><span id="line-2821"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682978019"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-2822"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">OccInfo -&gt; Bool
</span><a href="GHC.Types.Basic.html#isOneOcc"><span class="hs-identifier hs-var">isOneOcc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; OccInfo
</span><a href="GHC.Types.Id.html#idOccInfo"><span class="hs-identifier hs-var">idOccInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682978019"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2823"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">OccInfo -&gt; InsideLam
</span><a href="GHC.Types.Basic.html#occ_in_lam"><span class="hs-identifier hs-var">occ_in_lam</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; OccInfo
</span><a href="GHC.Types.Id.html#idOccInfo"><span class="hs-identifier hs-var">idOccInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682978019"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">InsideLam -&gt; InsideLam -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">InsideLam
</span><a href="GHC.Types.Basic.html#IsInsideLam"><span class="hs-identifier hs-var">IsInsideLam</span></a></span><span>
</span><span id="line-2824"></span><span>
</span><span id="line-2825"></span><span class="hs-comment">{-
Note [Dead binders]
~~~~~~~~~~~~~~~~~~~~
Note that dead-ness is maintained by the simplifier, so that it is
accurate after simplification as well as before.

-}</span><span>
</span><span id="line-2832"></span></pre></body></html>