<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE TupleSections #-}</span><span>
</span><span id="line-2"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="GHC.Core.LateCC.TopLevelBinds.html"><span class="hs-identifier">GHC.Core.LateCC.TopLevelBinds</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-3"></span><span>
</span><span id="line-4"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.LateCC.Types.html"><span class="hs-identifier">GHC.Core.LateCC.Types</span></a></span><span>
</span><span id="line-7"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.LateCC.Utils.html"><span class="hs-identifier">GHC.Core.LateCC.Utils</span></a></span><span>
</span><span id="line-8"></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.html"><span class="hs-identifier">GHC.Core</span></a></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Monad.html"><span class="hs-identifier">GHC.Core.Opt.Monad</span></a></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.DynFlags.html"><span class="hs-identifier">GHC.Driver.DynFlags</span></a></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.html"><span class="hs-identifier">GHC.Types.Id</span></a></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.html"><span class="hs-identifier">GHC.Types.Name</span></a></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html"><span class="hs-identifier">GHC.Unit.Module.ModGuts</span></a></span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.Maybe.html"><span class="hs-identifier">Data.Maybe</span></a></span><span>
</span><span id="line-17"></span><span>
</span><span id="line-18"></span><span class="hs-comment">{- Note [Collecting late cost centres]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Usually cost centres defined by a module are collected
during tidy by collectCostCentres. However with `-fprof-late`
we insert cost centres after inlining. So we keep a list of
all the cost centres we inserted and combine that with the list
of cost centres found during tidy.

To avoid overhead when using -fprof-inline there is a flag to stop
us from collecting them here when we run this pass before tidy.

Note [Adding late cost centres to top level bindings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The basic idea is very simple. For a top level binder
`f = rhs` we compile it as if the user had written
`f = {-# SCC f #-} rhs`.

If we do this after unfoldings for `f` have been created this
doesn't impact core-level optimizations at all. If we do it
before the cost centre will be included in the unfolding and
might inhibit optimizations at the call site. For this reason
we provide flags for both approaches as they have different
tradeoffs.

To reduce overhead we ignore workfree bindings because they don't contribute
meaningfully to a performance profile. This reduces code size massively as it
allows us to allocate definitions like `val = Just 32` at compile time instead
of turning them into a CAF of the form `val = &lt;scc val&gt; let x = Just 32 in x` which
would be the alternative.

We make an exception for rhss with function types. This allows us to get
cost centres on eta-reduced definitions like `f = g`. By putting a tick onto
`f`s rhs we end up with

    f = \eta1 eta2 ... etan -&gt;
        &lt;scc f&gt; g eta1 ... etan

Which can make it easier to understand call graphs of an application.

We also don't add a cost centre for any binder that is a constructor
worker or wrapper. These will never meaningfully enrich the resulting
profile so we improve efficiency by omitting those.

-}</span><span>
</span><span id="line-62"></span><span>
</span><span id="line-63"></span><span class="hs-comment">-- | Add late cost centres directly to the 'ModGuts'. This is used inside the</span><span>
</span><span id="line-64"></span><span class="hs-comment">-- core pipeline with the -fprof-late-inline flag. It should not be used after</span><span>
</span><span id="line-65"></span><span class="hs-comment">-- tidy, since it does not manually track inserted cost centers. See</span><span>
</span><span id="line-66"></span><span class="hs-comment">-- Note [Collecting late cost centres].</span><span>
</span><span id="line-67"></span><span class="annot"><a href="GHC.Core.LateCC.TopLevelBinds.html#topLevelBindsCCMG"><span class="hs-identifier hs-type">topLevelBindsCCMG</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html#ModGuts"><span class="hs-identifier hs-type">ModGuts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Monad.html#CoreM"><span class="hs-identifier hs-type">CoreM</span></a></span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html#ModGuts"><span class="hs-identifier hs-type">ModGuts</span></a></span><span>
</span><span id="line-68"></span><span id="topLevelBindsCCMG"><span class="annot"><span class="annottext">topLevelBindsCCMG :: ModGuts -&gt; CoreM ModGuts
</span><a href="GHC.Core.LateCC.TopLevelBinds.html#topLevelBindsCCMG"><span class="hs-identifier hs-var hs-var">topLevelBindsCCMG</span></a></span></span><span> </span><span id="local-6989586621682976432"><span class="annot"><span class="annottext">ModGuts
</span><a href="#local-6989586621682976432"><span class="hs-identifier hs-var">guts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-69"></span><span>    </span><span id="local-6989586621682976433"><span class="annot"><a href="#local-6989586621682976433"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreM DynFlags
forall (m :: * -&gt; *). HasDynFlags m =&gt; m DynFlags
</span><a href="GHC.Driver.DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a></span><span>
</span><span id="line-70"></span><span>    </span><span class="hs-keyword">let</span><span>
</span><span id="line-71"></span><span>      </span><span id="local-6989586621682976435"><span class="annot"><a href="#local-6989586621682976435"><span class="hs-identifier hs-var hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-72"></span><span>        </span><span class="annot"><a href="GHC.Core.LateCC.Types.html#LateCCEnv"><span class="hs-identifier hs-type">LateCCEnv</span></a></span><span>
</span><span id="line-73"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lateCCEnv_module :: Module
</span><a href="GHC.Core.LateCC.Types.html#lateCCEnv_module"><span class="hs-identifier hs-var">lateCCEnv_module</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ModGuts -&gt; Module
</span><a href="GHC.Unit.Module.ModGuts.html#mg_module"><span class="hs-identifier hs-var">mg_module</span></a></span><span> </span><span class="annot"><span class="annottext">ModGuts
</span><a href="#local-6989586621682976432"><span class="hs-identifier hs-var">guts</span></a></span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span>            </span><span class="hs-comment">-- We don't use this for topLevelBindsCC, so Nothing is okay</span><span>
</span><span id="line-76"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lateCCEnv_file :: Maybe FastString
</span><a href="GHC.Core.LateCC.Types.html#lateCCEnv_file"><span class="hs-identifier hs-var">lateCCEnv_file</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe FastString
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-77"></span><span>
</span><span id="line-78"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lateCCEnv_countEntries :: Bool
</span><a href="GHC.Core.LateCC.Types.html#lateCCEnv_countEntries"><span class="hs-identifier hs-var">lateCCEnv_countEntries</span></a></span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GeneralFlag -&gt; DynFlags -&gt; Bool
</span><a href="GHC.Driver.DynFlags.html#gopt"><span class="hs-identifier hs-var">gopt</span></a></span><span> </span><span class="annot"><span class="annottext">GeneralFlag
</span><a href="GHC.Driver.Flags.html#Opt_ProfCountEntries"><span class="hs-identifier hs-var">Opt_ProfCountEntries</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621682976433"><span class="hs-identifier hs-var">dflags</span></a></span><span>
</span><span id="line-79"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lateCCEnv_collectCCs :: Bool
</span><a href="GHC.Core.LateCC.Types.html#lateCCEnv_collectCCs"><span class="hs-identifier hs-var">lateCCEnv_collectCCs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-80"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-81"></span><span>      </span><span id="local-6989586621682976444"><span class="annot"><a href="#local-6989586621682976444"><span class="hs-identifier hs-var hs-var">guts'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-82"></span><span>        </span><span class="annot"><span class="annottext">ModGuts
</span><a href="#local-6989586621682976432"><span class="hs-identifier hs-var">guts</span></a></span><span>
</span><span id="line-83"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html#mg_binds"><span class="hs-identifier hs-var">mg_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-84"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">fst</span></span><span>
</span><span id="line-85"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.LateCC.Utils.html#doLateCostCenters"><span class="hs-identifier hs-type">doLateCostCenters</span></a></span><span>
</span><span id="line-86"></span><span>                    </span><span class="annot"><a href="#local-6989586621682976435"><span class="hs-identifier hs-type">env</span></a></span><span>
</span><span id="line-87"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.LateCC.Types.html#initLateCCState"><span class="hs-identifier hs-type">initLateCCState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.LateCC.TopLevelBinds.html#topLevelBindsCC"><span class="hs-identifier hs-type">topLevelBindsCC</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">const</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">True</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html#mg_binds"><span class="hs-identifier hs-var">mg_binds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682976432"><span class="hs-identifier hs-type">guts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span>                </span><span class="hs-special">)</span><span>
</span><span id="line-91"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-92"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621682976444"><span class="hs-identifier hs-type">guts'</span></a></span><span>
</span><span id="line-93"></span><span>
</span><span id="line-94"></span><span class="hs-comment">-- | Insert cost centres on top-level bindings in the module, depending on</span><span>
</span><span id="line-95"></span><span class="hs-comment">-- whether or not they satisfy the given predicate.</span><span>
</span><span id="line-96"></span><span id="local-6989586621682976373"><span class="annot"><a href="GHC.Core.LateCC.TopLevelBinds.html#topLevelBindsCC"><span class="hs-identifier hs-type">topLevelBindsCC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.LateCC.Types.html#LateCCM"><span class="hs-identifier hs-type">LateCCM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682976373"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span></span><span>
</span><span id="line-97"></span><span id="topLevelBindsCC"><span class="annot"><span class="annottext">topLevelBindsCC :: forall s. (CoreExpr -&gt; Bool) -&gt; CoreBind -&gt; LateCCM s CoreBind
</span><a href="GHC.Core.LateCC.TopLevelBinds.html#topLevelBindsCC"><span class="hs-identifier hs-var hs-var">topLevelBindsCC</span></a></span></span><span> </span><span id="local-6989586621682976466"><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="#local-6989586621682976466"><span class="hs-identifier hs-var">pred</span></a></span></span><span> </span><span id="local-6989586621682976467"><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682976467"><span class="hs-identifier hs-var">core_bind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-98"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682976467"><span class="hs-identifier hs-var">core_bind</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-99"></span><span>      </span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span id="local-6989586621682976469"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682976469"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682976470"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682976470"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-100"></span><span>        </span><span class="annot"><span class="annottext">CoreBndr -&gt; CoreExpr -&gt; CoreBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682976469"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreBind)
-&gt; ReaderT LateCCEnv (State (LateCCState s)) CoreExpr
-&gt; LateCCM s CoreBind
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">CoreBndr
-&gt; CoreExpr -&gt; ReaderT LateCCEnv (State (LateCCState s)) CoreExpr
forall s. CoreBndr -&gt; CoreExpr -&gt; LateCCM s CoreExpr
</span><a href="#local-6989586621682976472"><span class="hs-identifier hs-var">doBndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682976469"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682976470"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-101"></span><span>      </span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span id="local-6989586621682976474"><span class="annot"><span class="annottext">[(CoreBndr, CoreExpr)]
</span><a href="#local-6989586621682976474"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-102"></span><span>        </span><span class="annot"><span class="annottext">[(CoreBndr, CoreExpr)] -&gt; CoreBind
forall b. [(b, Expr b)] -&gt; Bind b
</span><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-var">Rec</span></a></span><span> </span><span class="annot"><span class="annottext">([(CoreBndr, CoreExpr)] -&gt; CoreBind)
-&gt; ReaderT LateCCEnv (State (LateCCState s)) [(CoreBndr, CoreExpr)]
-&gt; LateCCM s CoreBind
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">((CoreBndr, CoreExpr)
 -&gt; ReaderT LateCCEnv (State (LateCCState s)) (CoreBndr, CoreExpr))
-&gt; [(CoreBndr, CoreExpr)]
-&gt; ReaderT LateCCEnv (State (LateCCState s)) [(CoreBndr, CoreExpr)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(CoreBndr, CoreExpr)
-&gt; ReaderT LateCCEnv (State (LateCCState s)) (CoreBndr, CoreExpr)
forall s. (CoreBndr, CoreExpr) -&gt; LateCCM s (CoreBndr, CoreExpr)
</span><a href="#local-6989586621682976476"><span class="hs-identifier hs-var">doPair</span></a></span><span> </span><span class="annot"><span class="annottext">[(CoreBndr, CoreExpr)]
</span><a href="#local-6989586621682976474"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-103"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-104"></span><span>    </span><span id="local-6989586621682976403"><span class="annot"><a href="#local-6989586621682976476"><span class="hs-identifier hs-type">doPair</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.LateCC.Types.html#LateCCM"><span class="hs-identifier hs-type">LateCCM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682976403"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-105"></span><span>    </span><span id="local-6989586621682976476"><span class="annot"><span class="annottext">doPair :: forall s. (CoreBndr, CoreExpr) -&gt; LateCCM s (CoreBndr, CoreExpr)
</span><a href="#local-6989586621682976476"><span class="hs-identifier hs-var hs-var">doPair</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682976480"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682976480"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682976481"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682976481"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682976480"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; (CoreBndr, CoreExpr))
-&gt; ReaderT LateCCEnv (State (LateCCState s)) CoreExpr
-&gt; ReaderT LateCCEnv (State (LateCCState s)) (CoreBndr, CoreExpr)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">CoreBndr
-&gt; CoreExpr -&gt; ReaderT LateCCEnv (State (LateCCState s)) CoreExpr
forall s. CoreBndr -&gt; CoreExpr -&gt; LateCCM s CoreExpr
</span><a href="#local-6989586621682976472"><span class="hs-identifier hs-var">doBndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682976480"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682976481"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-106"></span><span>
</span><span id="line-107"></span><span>    </span><span id="local-6989586621682976398"><span class="annot"><a href="#local-6989586621682976472"><span class="hs-identifier hs-type">doBndr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.LateCC.Types.html#LateCCM"><span class="hs-identifier hs-type">LateCCM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682976398"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span></span><span>
</span><span id="line-108"></span><span>    </span><span id="local-6989586621682976472"><span class="annot"><span class="annottext">doBndr :: forall s. CoreBndr -&gt; CoreExpr -&gt; LateCCM s CoreExpr
</span><a href="#local-6989586621682976472"><span class="hs-identifier hs-var hs-var">doBndr</span></a></span></span><span> </span><span id="local-6989586621682976486"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682976486"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682976487"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682976487"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-109"></span><span>      </span><span class="hs-comment">-- Not a constructor worker.</span><span>
</span><span id="line-110"></span><span>      </span><span class="hs-comment">-- Cost centres on constructor workers are pretty much useless so we don't emit them</span><span>
</span><span id="line-111"></span><span>      </span><span class="hs-comment">-- if we are looking at the rhs of a constructor binding.</span><span>
</span><span id="line-112"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Maybe DataCon -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isNothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Maybe DataCon
</span><a href="GHC.Types.Id.html#isDataConId_maybe"><span class="hs-identifier hs-var">isDataConId_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682976486"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-113"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="#local-6989586621682976466"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682976487"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-114"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; CoreExpr -&gt; LateCCM s CoreExpr
forall s. CoreBndr -&gt; CoreExpr -&gt; LateCCM s CoreExpr
</span><a href="#local-6989586621682976490"><span class="hs-identifier hs-var">addCC</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682976486"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682976487"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-115"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; LateCCM s CoreExpr
forall a. a -&gt; ReaderT LateCCEnv (State (LateCCState s)) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682976487"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-116"></span><span>
</span><span id="line-117"></span><span>    </span><span class="hs-comment">-- We want to put the cost centre below the lambda as we only care about</span><span>
</span><span id="line-118"></span><span>    </span><span class="hs-comment">-- executions of the RHS. Note that the lambdas might be hidden under ticks</span><span>
</span><span id="line-119"></span><span>    </span><span class="hs-comment">-- or casts. So look through these as well.</span><span>
</span><span id="line-120"></span><span>    </span><span id="local-6989586621682976491"><span class="annot"><a href="#local-6989586621682976490"><span class="hs-identifier hs-type">addCC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.LateCC.Types.html#LateCCM"><span class="hs-identifier hs-type">LateCCM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682976491"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span></span><span>
</span><span id="line-121"></span><span>    </span><span id="local-6989586621682976490"><span class="annot"><span class="annottext">addCC :: forall s. CoreBndr -&gt; CoreExpr -&gt; LateCCM s CoreExpr
</span><a href="#local-6989586621682976490"><span class="hs-identifier hs-var hs-var">addCC</span></a></span></span><span> </span><span id="local-6989586621682976502"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682976502"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682976504"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682976504"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span id="local-6989586621682976505"><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682976505"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoercionR -&gt; CoreExpr)
-&gt; ReaderT
     LateCCEnv
     (State (LateCCState s))
     (CoreExpr -&gt; CoercionR -&gt; CoreExpr)
forall a. a -&gt; ReaderT LateCCEnv (State (LateCCState s)) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoercionR -&gt; CoreExpr
forall b. Expr b -&gt; CoercionR -&gt; Expr b
</span><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-var">Cast</span></a></span><span> </span><span class="annot"><span class="annottext">ReaderT
  LateCCEnv
  (State (LateCCState s))
  (CoreExpr -&gt; CoercionR -&gt; CoreExpr)
-&gt; ReaderT LateCCEnv (State (LateCCState s)) CoreExpr
-&gt; ReaderT
     LateCCEnv (State (LateCCState s)) (CoercionR -&gt; CoreExpr)
forall a b.
ReaderT LateCCEnv (State (LateCCState s)) (a -&gt; b)
-&gt; ReaderT LateCCEnv (State (LateCCState s)) a
-&gt; ReaderT LateCCEnv (State (LateCCState s)) b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">CoreBndr
-&gt; CoreExpr -&gt; ReaderT LateCCEnv (State (LateCCState s)) CoreExpr
forall s. CoreBndr -&gt; CoreExpr -&gt; LateCCM s CoreExpr
</span><a href="#local-6989586621682976490"><span class="hs-identifier hs-var">addCC</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682976502"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682976504"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">ReaderT LateCCEnv (State (LateCCState s)) (CoercionR -&gt; CoreExpr)
-&gt; ReaderT LateCCEnv (State (LateCCState s)) CoercionR
-&gt; ReaderT LateCCEnv (State (LateCCState s)) CoreExpr
forall a b.
ReaderT LateCCEnv (State (LateCCState s)) (a -&gt; b)
-&gt; ReaderT LateCCEnv (State (LateCCState s)) a
-&gt; ReaderT LateCCEnv (State (LateCCState s)) b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">CoercionR -&gt; ReaderT LateCCEnv (State (LateCCState s)) CoercionR
forall a. a -&gt; ReaderT LateCCEnv (State (LateCCState s)) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682976505"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-122"></span><span>    </span><span class="annot"><a href="#local-6989586621682976490"><span class="hs-identifier hs-var">addCC</span></a></span><span> </span><span id="local-6989586621682976506"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682976506"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621682976508"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682976508"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621682976509"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682976509"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; CoreExpr -&gt; CoreExpr
forall b. CoreTickish -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-var">Tick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682976508"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr)
-&gt; ReaderT LateCCEnv (State (LateCCState s)) CoreExpr
-&gt; ReaderT LateCCEnv (State (LateCCState s)) CoreExpr
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">CoreBndr
-&gt; CoreExpr -&gt; ReaderT LateCCEnv (State (LateCCState s)) CoreExpr
forall s. CoreBndr -&gt; CoreExpr -&gt; LateCCM s CoreExpr
</span><a href="#local-6989586621682976490"><span class="hs-identifier hs-var">addCC</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682976506"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682976509"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-123"></span><span>    </span><span class="annot"><a href="#local-6989586621682976490"><span class="hs-identifier hs-var">addCC</span></a></span><span> </span><span id="local-6989586621682976510"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682976510"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621682976512"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682976512"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682976513"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682976513"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; CoreExpr -&gt; CoreExpr
forall b. b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-var">Lam</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682976512"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr)
-&gt; ReaderT LateCCEnv (State (LateCCState s)) CoreExpr
-&gt; ReaderT LateCCEnv (State (LateCCState s)) CoreExpr
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">CoreBndr
-&gt; CoreExpr -&gt; ReaderT LateCCEnv (State (LateCCState s)) CoreExpr
forall s. CoreBndr -&gt; CoreExpr -&gt; LateCCM s CoreExpr
</span><a href="#local-6989586621682976490"><span class="hs-identifier hs-var">addCC</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682976510"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682976513"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-124"></span><span>    </span><span class="annot"><a href="#local-6989586621682976490"><span class="hs-identifier hs-var">addCC</span></a></span><span> </span><span id="local-6989586621682976514"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682976514"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682976515"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682976515"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-125"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682976516"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621682976516"><span class="hs-identifier hs-var hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Name
</span><a href="GHC.Types.Id.html#idName"><span class="hs-identifier hs-var">idName</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682976514"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-126"></span><span>          </span><span id="local-6989586621682976518"><span class="annot"><span class="annottext">cc_loc :: SrcSpan
</span><a href="#local-6989586621682976518"><span class="hs-identifier hs-var hs-var">cc_loc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; SrcSpan
</span><a href="GHC.Types.Name.html#nameSrcSpan"><span class="hs-identifier hs-var">nameSrcSpan</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682976516"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-127"></span><span>          </span><span id="local-6989586621682976520"><span class="annot"><span class="annottext">cc_name :: FastString
</span><a href="#local-6989586621682976520"><span class="hs-identifier hs-var hs-var">cc_name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; FastString
forall a. NamedThing a =&gt; a -&gt; FastString
</span><a href="GHC.Types.Name.html#getOccFS"><span class="hs-identifier hs-var">getOccFS</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682976516"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-128"></span><span>      </span><span class="annot"><span class="annottext">FastString
-&gt; SrcSpan
-&gt; CoreExpr
-&gt; ReaderT LateCCEnv (State (LateCCState s)) CoreExpr
forall s. FastString -&gt; SrcSpan -&gt; CoreExpr -&gt; LateCCM s CoreExpr
</span><a href="GHC.Core.LateCC.Utils.html#insertCC"><span class="hs-identifier hs-var">insertCC</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621682976520"><span class="hs-identifier hs-var">cc_name</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621682976518"><span class="hs-identifier hs-var">cc_loc</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682976515"><span class="hs-identifier hs-var">rhs</span></a></span></pre></body></html>