<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DeriveFunctor       #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE GADTs               #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE TupleSections       #-}</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-comment">-- (c) The University of Glasgow 2006</span><span>
</span><span id="line-7"></span><span class="hs-comment">--</span><span>
</span><span id="line-8"></span><span class="hs-comment">-- FamInstEnv: Type checked family instance declarations</span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html"><span class="hs-identifier">GHC.Core.FamInstEnv</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-11"></span><span>        </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier">FamInst</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamFlavor"><span class="hs-identifier">FamFlavor</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#famInstAxiom"><span class="hs-identifier">famInstAxiom</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#famInstTyCon"><span class="hs-identifier">famInstTyCon</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#famInstRHS"><span class="hs-identifier">famInstRHS</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>        </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#famInstsRepTyCons"><span class="hs-identifier">famInstsRepTyCons</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#famInstRepTyCon_maybe"><span class="hs-identifier">famInstRepTyCon_maybe</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#dataFamInstRepTyCon"><span class="hs-identifier">dataFamInstRepTyCon</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>        </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#pprFamInst"><span class="hs-identifier">pprFamInst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#pprFamInsts"><span class="hs-identifier">pprFamInsts</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#orphNamesOfFamInst"><span class="hs-identifier">orphNamesOfFamInst</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>        </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#mkImportedFamInst"><span class="hs-identifier">mkImportedFamInst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#mkLocalFamInst"><span class="hs-identifier">mkLocalFamInst</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span>        </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier">FamInstEnvs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnv"><span class="hs-identifier">FamInstEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#emptyFamInstEnv"><span class="hs-identifier">emptyFamInstEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#emptyFamInstEnvs"><span class="hs-identifier">emptyFamInstEnvs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>        </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#unionFamInstEnv"><span class="hs-identifier">unionFamInstEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#extendFamInstEnv"><span class="hs-identifier">extendFamInstEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#extendFamInstEnvList"><span class="hs-identifier">extendFamInstEnvList</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>        </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#famInstEnvElts"><span class="hs-identifier">famInstEnvElts</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#famInstEnvSize"><span class="hs-identifier">famInstEnvSize</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#familyInstances"><span class="hs-identifier">familyInstances</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#familyNameInstances"><span class="hs-identifier">familyNameInstances</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>
</span><span id="line-20"></span><span>        </span><span class="annot"><span class="hs-comment">-- * CoAxioms</span></span><span>
</span><span id="line-21"></span><span>        </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#mkCoAxBranch"><span class="hs-identifier">mkCoAxBranch</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#mkBranchedCoAxiom"><span class="hs-identifier">mkBranchedCoAxiom</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#mkUnbranchedCoAxiom"><span class="hs-identifier">mkUnbranchedCoAxiom</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#mkSingleCoAxiom"><span class="hs-identifier">mkSingleCoAxiom</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>        </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#mkNewTypeCoAxiom"><span class="hs-identifier">mkNewTypeCoAxiom</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-23"></span><span>
</span><span id="line-24"></span><span>        </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstMatch"><span class="hs-identifier">FamInstMatch</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-25"></span><span>        </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#lookupFamInstEnv"><span class="hs-identifier">lookupFamInstEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#lookupFamInstEnvConflicts"><span class="hs-identifier">lookupFamInstEnvConflicts</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#lookupFamInstEnvByTyCon"><span class="hs-identifier">lookupFamInstEnvByTyCon</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-26"></span><span>
</span><span id="line-27"></span><span>        </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#isDominatedBy"><span class="hs-identifier">isDominatedBy</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#apartnessCheck"><span class="hs-identifier">apartnessCheck</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#compatibleBranches"><span class="hs-identifier">compatibleBranches</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-28"></span><span>
</span><span id="line-29"></span><span>        </span><span class="hs-comment">-- Injectivity</span><span>
</span><span id="line-30"></span><span>        </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#InjectivityCheckResult"><span class="hs-identifier">InjectivityCheckResult</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-31"></span><span>        </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#lookupFamInstEnvInjectivityConflicts"><span class="hs-identifier">lookupFamInstEnvInjectivityConflicts</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#injectiveBranches"><span class="hs-identifier">injectiveBranches</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-32"></span><span>
</span><span id="line-33"></span><span>        </span><span class="hs-comment">-- Normalisation</span><span>
</span><span id="line-34"></span><span>        </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#topNormaliseType"><span class="hs-identifier">topNormaliseType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#topNormaliseType_maybe"><span class="hs-identifier">topNormaliseType_maybe</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-35"></span><span>        </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#normaliseType"><span class="hs-identifier">normaliseType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#normaliseTcApp"><span class="hs-identifier">normaliseTcApp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-36"></span><span>        </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#topReduceTyFamApp_maybe"><span class="hs-identifier">topReduceTyFamApp_maybe</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#reduceTyFamApp_maybe"><span class="hs-identifier">reduceTyFamApp_maybe</span></a></span><span>
</span><span id="line-37"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-38"></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-40"></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.html"><span class="hs-identifier">GHC.Core</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.html#IsOrphan"><span class="hs-identifier">IsOrphan</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#chooseOrphanAnchor"><span class="hs-identifier">chooseOrphanAnchor</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html"><span class="hs-identifier">GHC.Core.Unify</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Type.html"><span class="hs-identifier">GHC.Core.Type</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Type</span></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html"><span class="hs-identifier">GHC.Core.TyCo.Rep</span></a></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Compare.html"><span class="hs-identifier">GHC.Core.TyCo.Compare</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Compare.html#eqType"><span class="hs-identifier">eqType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Compare.html#eqTypes"><span class="hs-identifier">eqTypes</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html"><span class="hs-identifier">GHC.Core.TyCon</span></a></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html"><span class="hs-identifier">GHC.Core.Coercion</span></a></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html"><span class="hs-identifier">GHC.Core.Coercion.Axiom</span></a></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html"><span class="hs-identifier">GHC.Core.Reduction</span></a></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.RoughMap.html"><span class="hs-identifier">GHC.Core.RoughMap</span></a></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.FVs.html"><span class="hs-identifier">GHC.Core.FVs</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.FVs.html#orphNamesOfAxiomLHS"><span class="hs-identifier">orphNamesOfAxiomLHS</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.Literals.html"><span class="hs-identifier">GHC.Builtin.Types.Literals</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.Literals.html#tryMatchFam"><span class="hs-identifier">tryMatchFam</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html"><span class="hs-identifier">GHC.Types.Var.Set</span></a></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html"><span class="hs-identifier">GHC.Types.Var.Env</span></a></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.html"><span class="hs-identifier">GHC.Types.Name</span></a></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.html"><span class="hs-identifier">GHC.Types.Var</span></a></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html"><span class="hs-identifier">GHC.Types.SrcLoc</span></a></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html"><span class="hs-identifier">GHC.Types.Name.Set</span></a></span><span>
</span><span id="line-61"></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-65"></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html"><span class="hs-identifier">GHC.Data.FastString</span></a></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Maybe.html"><span class="hs-identifier">GHC.Data.Maybe</span></a></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Bag.html"><span class="hs-identifier">GHC.Data.Bag</span></a></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.List.Infinite.html"><span class="hs-identifier">GHC.Data.List.Infinite</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.List.Infinite.html#Infinite"><span class="hs-identifier">Infinite</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="GHC.Data.List.Infinite.html"><span class="hs-identifier">GHC.Data.List.Infinite</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Inf</span></span><span>
</span><span id="line-71"></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">mapAccumL</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../array-0.5.8.0-9044/src/Data.Array.html"><span class="hs-identifier">Data.Array</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">Array</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">assocs</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
          Type checked family instance heads
*                                                                      *
************************************************************************

Note [FamInsts and CoAxioms]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
* CoAxioms and FamInsts are just like
  DFunIds  and ClsInsts

* A CoAxiom is a System-FC thing: it can relate any two types

* A FamInst is a Haskell source-language thing, corresponding
  to a type/data family instance declaration.
    - The FamInst contains a CoAxiom, which is the evidence
      for the instance

    - The LHS of the CoAxiom is always of form F ty1 .. tyn
      where F is a type family
-}</span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span class="hs-keyword">data</span><span> </span><span id="FamInst"><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-var">FamInst</span></a></span></span><span>  </span><span class="hs-comment">-- See Note [FamInsts and CoAxioms]</span><span>
</span><span id="line-100"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="FamInst"><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-var">FamInst</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="fi_axiom"><span class="annot"><span class="annottext">FamInst -&gt; CoAxiom Unbranched
</span><a href="GHC.Core.FamInstEnv.html#fi_axiom"><span class="hs-identifier hs-var hs-var">fi_axiom</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#Unbranched"><span class="hs-identifier hs-type">Unbranched</span></a></span><span> </span><span class="hs-comment">-- The new coercion axiom</span><span>
</span><span id="line-101"></span><span>                                              </span><span class="hs-comment">-- introduced by this family</span><span>
</span><span id="line-102"></span><span>                                              </span><span class="hs-comment">-- instance</span><span>
</span><span id="line-103"></span><span>                 </span><span class="hs-comment">-- INVARIANT: apart from freshening (see below)</span><span>
</span><span id="line-104"></span><span>                 </span><span class="hs-comment">--    fi_tvs = cab_tvs of the (single) axiom branch</span><span>
</span><span id="line-105"></span><span>                 </span><span class="hs-comment">--    fi_cvs = cab_cvs ...ditto...</span><span>
</span><span id="line-106"></span><span>                 </span><span class="hs-comment">--    fi_tys = cab_lhs ...ditto...</span><span>
</span><span id="line-107"></span><span>                 </span><span class="hs-comment">--    fi_rhs = cab_rhs ...ditto...</span><span>
</span><span id="line-108"></span><span>
</span><span id="line-109"></span><span>            </span><span class="hs-special">,</span><span> </span><span id="fi_flavor"><span class="annot"><span class="annottext">FamInst -&gt; FamFlavor
</span><a href="GHC.Core.FamInstEnv.html#fi_flavor"><span class="hs-identifier hs-var hs-var">fi_flavor</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamFlavor"><span class="hs-identifier hs-type">FamFlavor</span></a></span><span>
</span><span id="line-110"></span><span>
</span><span id="line-111"></span><span>            </span><span class="hs-comment">-- Everything below here is a redundant,</span><span>
</span><span id="line-112"></span><span>            </span><span class="hs-comment">-- cached version of the two things above</span><span>
</span><span id="line-113"></span><span>            </span><span class="hs-comment">-- except that the TyVars are freshened</span><span>
</span><span id="line-114"></span><span>            </span><span class="hs-special">,</span><span> </span><span id="fi_fam"><span class="annot"><span class="annottext">FamInst -&gt; Name
</span><a href="GHC.Core.FamInstEnv.html#fi_fam"><span class="hs-identifier hs-var hs-var">fi_fam</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span>          </span><span class="hs-comment">-- Family name</span><span>
</span><span id="line-115"></span><span>
</span><span id="line-116"></span><span>                </span><span class="hs-comment">-- Used for &quot;rough matching&quot;; same idea as for class instances</span><span>
</span><span id="line-117"></span><span>                </span><span class="hs-comment">-- See Note [Rough matching in class and family instances]</span><span>
</span><span id="line-118"></span><span>                </span><span class="hs-comment">-- in GHC.Core.Unify</span><span>
</span><span id="line-119"></span><span>            </span><span class="hs-special">,</span><span> </span><span id="fi_tcs"><span class="annot"><span class="annottext">FamInst -&gt; [RoughMatchTc]
</span><a href="GHC.Core.FamInstEnv.html#fi_tcs"><span class="hs-identifier hs-var hs-var">fi_tcs</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.RoughMap.html#RoughMatchTc"><span class="hs-identifier hs-type">RoughMatchTc</span></a></span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Top of type args</span><span>
</span><span id="line-120"></span><span>                </span><span class="hs-comment">-- INVARIANT: fi_tcs = roughMatchTcs fi_tys</span><span>
</span><span id="line-121"></span><span>
</span><span id="line-122"></span><span>            </span><span class="hs-comment">-- Used for &quot;proper matching&quot;; ditto</span><span>
</span><span id="line-123"></span><span>            </span><span class="hs-special">,</span><span> </span><span id="fi_tvs"><span class="annot"><span class="annottext">FamInst -&gt; [TyVar]
</span><a href="GHC.Core.FamInstEnv.html#fi_tvs"><span class="hs-identifier hs-var hs-var">fi_tvs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- Template tyvars for full match</span><span>
</span><span id="line-124"></span><span>            </span><span class="hs-special">,</span><span> </span><span id="fi_cvs"><span class="annot"><span class="annottext">FamInst -&gt; [TyVar]
</span><a href="GHC.Core.FamInstEnv.html#fi_cvs"><span class="hs-identifier hs-var hs-var">fi_cvs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a></span><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- Template covars for full match</span><span>
</span><span id="line-125"></span><span>                 </span><span class="hs-comment">-- Like ClsInsts, these variables are always fresh</span><span>
</span><span id="line-126"></span><span>                 </span><span class="hs-comment">-- See Note [Template tyvars are fresh] in GHC.Core.InstEnv</span><span>
</span><span id="line-127"></span><span>
</span><span id="line-128"></span><span>            </span><span class="hs-special">,</span><span> </span><span id="fi_tys"><span class="annot"><span class="annottext">FamInst -&gt; [Type]
</span><a href="GHC.Core.FamInstEnv.html#fi_tys"><span class="hs-identifier hs-var hs-var">fi_tys</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>       </span><span class="hs-comment">--   The LHS type patterns</span><span>
</span><span id="line-129"></span><span>            </span><span class="hs-comment">-- May be eta-reduced; see Note [Eta reduction for data families]</span><span>
</span><span id="line-130"></span><span>            </span><span class="hs-comment">-- in GHC.Core.Coercion.Axiom</span><span>
</span><span id="line-131"></span><span>
</span><span id="line-132"></span><span>            </span><span class="hs-special">,</span><span> </span><span id="fi_rhs"><span class="annot"><span class="annottext">FamInst -&gt; Type
</span><a href="GHC.Core.FamInstEnv.html#fi_rhs"><span class="hs-identifier hs-var hs-var">fi_rhs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>         </span><span class="hs-comment">--   the RHS, with its freshened vars</span><span>
</span><span id="line-133"></span><span>
</span><span id="line-134"></span><span>            </span><span class="hs-special">,</span><span> </span><span id="fi_orphan"><span class="annot"><span class="annottext">FamInst -&gt; IsOrphan
</span><a href="GHC.Core.FamInstEnv.html#fi_orphan"><span class="hs-identifier hs-var hs-var">fi_orphan</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#IsOrphan"><span class="hs-identifier hs-type">IsOrphan</span></a></span><span>
</span><span id="line-135"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-136"></span><span>
</span><span id="line-137"></span><span class="hs-keyword">data</span><span> </span><span id="FamFlavor"><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamFlavor"><span class="hs-identifier hs-var">FamFlavor</span></a></span></span><span>
</span><span id="line-138"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="SynFamilyInst"><span class="annot"><a href="GHC.Core.FamInstEnv.html#SynFamilyInst"><span class="hs-identifier hs-var">SynFamilyInst</span></a></span></span><span>         </span><span class="hs-comment">-- A synonym family</span><span>
</span><span id="line-139"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="DataFamilyInst"><span class="annot"><a href="GHC.Core.FamInstEnv.html#DataFamilyInst"><span class="hs-identifier hs-var">DataFamilyInst</span></a></span></span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span>  </span><span class="hs-comment">-- A data family, with its representation TyCon</span><span>
</span><span id="line-140"></span><span>
</span><span id="line-141"></span><span class="hs-comment">{-
Note [Arity of data families]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Data family instances might legitimately be over- or under-saturated.

Under-saturation has two potential causes:
 U1) Eta reduction. See Note [Eta reduction for data families] in
     GHC.Core.Coercion.Axiom.
 U2) When the user has specified a return kind instead of written out patterns.
     Example:

       data family Sing (a :: k)
       data instance Sing :: Bool -&gt; Type

     The data family tycon Sing has an arity of 2, the k and the a. But
     the data instance has only one pattern, Bool (standing in for k).
     This instance is equivalent to `data instance Sing (a :: Bool)`, but
     without the last pattern, we have an under-saturated data family instance.
     On its own, this example is not compelling enough to add support for
     under-saturation, but U1 makes this feature more compelling.

Over-saturation is also possible:
  O1) If the data family's return kind is a type variable (see also #12369),
      an instance might legitimately have more arguments than the family.
      Example:

        data family Fix :: (Type -&gt; k) -&gt; k
        data instance Fix f = MkFix1 (f (Fix f))
        data instance Fix f x = MkFix2 (f (Fix f x) x)

      In the first instance here, the k in the data family kind is chosen to
      be Type. In the second, it's (Type -&gt; Type).

      However, we require that any over-saturation is eta-reducible. That is,
      we require that any extra patterns be bare unrepeated type variables;
      see Note [Eta reduction for data families] in GHC.Core.Coercion.Axiom.
      Accordingly, the FamInst is never over-saturated.

Why can we allow such flexibility for data families but not for type families?
Because data families can be decomposed -- that is, they are generative and
injective. A Type family is neither and so always must be applied to all its
arguments.
-}</span><span>
</span><span id="line-184"></span><span>
</span><span id="line-185"></span><span class="hs-comment">-- Obtain the axiom of a family instance</span><span>
</span><span id="line-186"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#famInstAxiom"><span class="hs-identifier hs-type">famInstAxiom</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#Unbranched"><span class="hs-identifier hs-type">Unbranched</span></a></span><span>
</span><span id="line-187"></span><span id="famInstAxiom"><span class="annot"><span class="annottext">famInstAxiom :: FamInst -&gt; CoAxiom Unbranched
</span><a href="GHC.Core.FamInstEnv.html#famInstAxiom"><span class="hs-identifier hs-var hs-var">famInstAxiom</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FamInst -&gt; CoAxiom Unbranched
</span><a href="GHC.Core.FamInstEnv.html#fi_axiom"><span class="hs-identifier hs-var">fi_axiom</span></a></span><span>
</span><span id="line-188"></span><span>
</span><span id="line-189"></span><span class="hs-comment">-- Split the left-hand side of the FamInst</span><span>
</span><span id="line-190"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#famInstSplitLHS"><span class="hs-identifier hs-type">famInstSplitLHS</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span id="famInstSplitLHS"><span class="annot"><span class="annottext">famInstSplitLHS :: FamInst -&gt; (TyCon, [Type])
</span><a href="GHC.Core.FamInstEnv.html#famInstSplitLHS"><span class="hs-identifier hs-var hs-var">famInstSplitLHS</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fi_axiom :: FamInst -&gt; CoAxiom Unbranched
</span><a href="GHC.Core.FamInstEnv.html#fi_axiom"><span class="hs-identifier hs-var">fi_axiom</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668283"><span class="annot"><span class="annottext">CoAxiom Unbranched
</span><a href="#local-6989586621682668283"><span class="hs-identifier hs-var">axiom</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fi_tys :: FamInst -&gt; [Type]
</span><a href="GHC.Core.FamInstEnv.html#fi_tys"><span class="hs-identifier hs-var">fi_tys</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668284"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668284"><span class="hs-identifier hs-var">lhs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-192"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoAxiom Unbranched -&gt; TyCon
forall (br :: BranchFlag). CoAxiom br -&gt; TyCon
</span><a href="GHC.Core.Coercion.Axiom.html#coAxiomTyCon"><span class="hs-identifier hs-var">coAxiomTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiom Unbranched
</span><a href="#local-6989586621682668283"><span class="hs-identifier hs-var">axiom</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668284"><span class="hs-identifier hs-var">lhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-193"></span><span>
</span><span id="line-194"></span><span class="hs-comment">-- Get the RHS of the FamInst</span><span>
</span><span id="line-195"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#famInstRHS"><span class="hs-identifier hs-type">famInstRHS</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-196"></span><span id="famInstRHS"><span class="annot"><span class="annottext">famInstRHS :: FamInst -&gt; Type
</span><a href="GHC.Core.FamInstEnv.html#famInstRHS"><span class="hs-identifier hs-var hs-var">famInstRHS</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FamInst -&gt; Type
</span><a href="GHC.Core.FamInstEnv.html#fi_rhs"><span class="hs-identifier hs-var">fi_rhs</span></a></span><span>
</span><span id="line-197"></span><span>
</span><span id="line-198"></span><span class="hs-comment">-- Get the family TyCon of the FamInst</span><span>
</span><span id="line-199"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#famInstTyCon"><span class="hs-identifier hs-type">famInstTyCon</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span>
</span><span id="line-200"></span><span id="famInstTyCon"><span class="annot"><span class="annottext">famInstTyCon :: FamInst -&gt; TyCon
</span><a href="GHC.Core.FamInstEnv.html#famInstTyCon"><span class="hs-identifier hs-var hs-var">famInstTyCon</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoAxiom Unbranched -&gt; TyCon
forall (br :: BranchFlag). CoAxiom br -&gt; TyCon
</span><a href="GHC.Core.Coercion.Axiom.html#coAxiomTyCon"><span class="hs-identifier hs-var">coAxiomTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">(CoAxiom Unbranched -&gt; TyCon)
-&gt; (FamInst -&gt; CoAxiom Unbranched) -&gt; FamInst -&gt; TyCon
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">FamInst -&gt; CoAxiom Unbranched
</span><a href="GHC.Core.FamInstEnv.html#famInstAxiom"><span class="hs-identifier hs-var">famInstAxiom</span></a></span><span>
</span><span id="line-201"></span><span>
</span><span id="line-202"></span><span class="hs-comment">-- Return the representation TyCons introduced by data family instances, if any</span><span>
</span><span id="line-203"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#famInstsRepTyCons"><span class="hs-identifier hs-type">famInstsRepTyCons</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-204"></span><span id="famInstsRepTyCons"><span class="annot"><span class="annottext">famInstsRepTyCons :: [FamInst] -&gt; [TyCon]
</span><a href="GHC.Core.FamInstEnv.html#famInstsRepTyCons"><span class="hs-identifier hs-var hs-var">famInstsRepTyCons</span></a></span></span><span> </span><span id="local-6989586621682668287"><span class="annot"><span class="annottext">[FamInst]
</span><a href="#local-6989586621682668287"><span class="hs-identifier hs-var">fis</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668288"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fi_flavor :: FamInst -&gt; FamFlavor
</span><a href="GHC.Core.FamInstEnv.html#fi_flavor"><span class="hs-identifier hs-var">fi_flavor</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#DataFamilyInst"><span class="hs-identifier hs-type">DataFamilyInst</span></a></span><span> </span><span id="local-6989586621682668288"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668288"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[FamInst]
</span><a href="#local-6989586621682668287"><span class="hs-identifier hs-var">fis</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-205"></span><span>
</span><span id="line-206"></span><span class="hs-comment">-- Extracts the TyCon for this *data* (or newtype) instance</span><span>
</span><span id="line-207"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#famInstRepTyCon_maybe"><span class="hs-identifier hs-type">famInstRepTyCon_maybe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span>
</span><span id="line-208"></span><span id="famInstRepTyCon_maybe"><span class="annot"><span class="annottext">famInstRepTyCon_maybe :: FamInst -&gt; Maybe TyCon
</span><a href="GHC.Core.FamInstEnv.html#famInstRepTyCon_maybe"><span class="hs-identifier hs-var hs-var">famInstRepTyCon_maybe</span></a></span></span><span> </span><span id="local-6989586621682668289"><span class="annot"><span class="annottext">FamInst
</span><a href="#local-6989586621682668289"><span class="hs-identifier hs-var">fi</span></a></span></span><span>
</span><span id="line-209"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">FamInst -&gt; FamFlavor
</span><a href="GHC.Core.FamInstEnv.html#fi_flavor"><span class="hs-identifier hs-var">fi_flavor</span></a></span><span> </span><span class="annot"><span class="annottext">FamInst
</span><a href="#local-6989586621682668289"><span class="hs-identifier hs-var">fi</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-210"></span><span>       </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#DataFamilyInst"><span class="hs-identifier hs-type">DataFamilyInst</span></a></span><span> </span><span id="local-6989586621682668290"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668290"><span class="hs-identifier hs-var">tycon</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Maybe TyCon
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668290"><span class="hs-identifier hs-var">tycon</span></a></span><span>
</span><span id="line-211"></span><span>       </span><span class="annot"><span class="annottext">FamFlavor
</span><a href="GHC.Core.FamInstEnv.html#SynFamilyInst"><span class="hs-identifier hs-var">SynFamilyInst</span></a></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe TyCon
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-212"></span><span>
</span><span id="line-213"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#dataFamInstRepTyCon"><span class="hs-identifier hs-type">dataFamInstRepTyCon</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span>
</span><span id="line-214"></span><span id="dataFamInstRepTyCon"><span class="annot"><span class="annottext">dataFamInstRepTyCon :: FamInst -&gt; TyCon
</span><a href="GHC.Core.FamInstEnv.html#dataFamInstRepTyCon"><span class="hs-identifier hs-var hs-var">dataFamInstRepTyCon</span></a></span></span><span> </span><span id="local-6989586621682668291"><span class="annot"><span class="annottext">FamInst
</span><a href="#local-6989586621682668291"><span class="hs-identifier hs-var">fi</span></a></span></span><span>
</span><span id="line-215"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">FamInst -&gt; FamFlavor
</span><a href="GHC.Core.FamInstEnv.html#fi_flavor"><span class="hs-identifier hs-var">fi_flavor</span></a></span><span> </span><span class="annot"><span class="annottext">FamInst
</span><a href="#local-6989586621682668291"><span class="hs-identifier hs-var">fi</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-216"></span><span>       </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#DataFamilyInst"><span class="hs-identifier hs-type">DataFamilyInst</span></a></span><span> </span><span id="local-6989586621682668292"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668292"><span class="hs-identifier hs-var">tycon</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668292"><span class="hs-identifier hs-var">tycon</span></a></span><span>
</span><span id="line-217"></span><span>       </span><span class="annot"><span class="annottext">FamFlavor
</span><a href="GHC.Core.FamInstEnv.html#SynFamilyInst"><span class="hs-identifier hs-var">SynFamilyInst</span></a></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TyCon
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;dataFamInstRepTyCon&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FamInst -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">FamInst
</span><a href="#local-6989586621682668291"><span class="hs-identifier hs-var">fi</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-218"></span><span>
</span><span id="line-219"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#orphNamesOfFamInst"><span class="hs-identifier hs-type">orphNamesOfFamInst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html#NameSet"><span class="hs-identifier hs-type">NameSet</span></a></span><span>
</span><span id="line-220"></span><span id="orphNamesOfFamInst"><span class="annot"><span class="annottext">orphNamesOfFamInst :: FamInst -&gt; NameSet
</span><a href="GHC.Core.FamInstEnv.html#orphNamesOfFamInst"><span class="hs-identifier hs-var hs-var">orphNamesOfFamInst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fi_axiom :: FamInst -&gt; CoAxiom Unbranched
</span><a href="GHC.Core.FamInstEnv.html#fi_axiom"><span class="hs-identifier hs-var">fi_axiom</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668295"><span class="annot"><span class="annottext">CoAxiom Unbranched
</span><a href="#local-6989586621682668295"><span class="hs-identifier hs-var">ax</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoAxiom Unbranched -&gt; NameSet
forall (br :: BranchFlag). CoAxiom br -&gt; NameSet
</span><a href="GHC.Core.FVs.html#orphNamesOfAxiomLHS"><span class="hs-identifier hs-var">orphNamesOfAxiomLHS</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiom Unbranched
</span><a href="#local-6989586621682668295"><span class="hs-identifier hs-var">ax</span></a></span><span>
</span><span id="line-221"></span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Pretty printing
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-230"></span><span>
</span><span id="line-231"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621682668297"><span class="annot"><a href="GHC.Types.Name.html#NamedThing"><span class="hs-identifier hs-type">NamedThing</span></a></span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-232"></span><span>   </span><span id="local-6989586621682668302"><span class="annot"><span class="annottext">getName :: FamInst -&gt; Name
</span><a href="#local-6989586621682668302"><span class="hs-identifier hs-var hs-var hs-var">getName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoAxiom Unbranched -&gt; Name
forall (br :: BranchFlag). CoAxiom br -&gt; Name
</span><a href="GHC.Core.Coercion.Axiom.html#coAxiomName"><span class="hs-identifier hs-var">coAxiomName</span></a></span><span> </span><span class="annot"><span class="annottext">(CoAxiom Unbranched -&gt; Name)
-&gt; (FamInst -&gt; CoAxiom Unbranched) -&gt; FamInst -&gt; Name
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">FamInst -&gt; CoAxiom Unbranched
</span><a href="GHC.Core.FamInstEnv.html#fi_axiom"><span class="hs-identifier hs-var">fi_axiom</span></a></span><span>
</span><span id="line-233"></span><span>
</span><span id="line-234"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-235"></span><span>   </span><span id="local-6989586621682668307"><span class="annot"><span class="annottext">ppr :: FamInst -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FamInst -&gt; SDoc
</span><a href="GHC.Core.FamInstEnv.html#pprFamInst"><span class="hs-identifier hs-var">pprFamInst</span></a></span><span>
</span><span id="line-236"></span><span>
</span><span id="line-237"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#pprFamInst"><span class="hs-identifier hs-type">pprFamInst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span>
</span><span id="line-238"></span><span class="hs-comment">-- Prints the FamInst as a family instance declaration</span><span>
</span><span id="line-239"></span><span class="hs-comment">-- NB: This function, FamInstEnv.pprFamInst, is used only for internal,</span><span>
</span><span id="line-240"></span><span class="hs-comment">--     debug printing. See GHC.Types.TyThing.Ppr.pprFamInst for printing for the user</span><span>
</span><span id="line-241"></span><span id="pprFamInst"><span class="annot"><span class="annottext">pprFamInst :: FamInst -&gt; SDoc
</span><a href="GHC.Core.FamInstEnv.html#pprFamInst"><span class="hs-identifier hs-var hs-var">pprFamInst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fi_flavor :: FamInst -&gt; FamFlavor
</span><a href="GHC.Core.FamInstEnv.html#fi_flavor"><span class="hs-identifier hs-var">fi_flavor</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668308"><span class="annot"><span class="annottext">FamFlavor
</span><a href="#local-6989586621682668308"><span class="hs-identifier hs-var">flavor</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fi_axiom :: FamInst -&gt; CoAxiom Unbranched
</span><a href="GHC.Core.FamInstEnv.html#fi_axiom"><span class="hs-identifier hs-var">fi_axiom</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668309"><span class="annot"><span class="annottext">CoAxiom Unbranched
</span><a href="#local-6989586621682668309"><span class="hs-identifier hs-var">ax</span></a></span></span><span>
</span><span id="line-242"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fi_tvs :: FamInst -&gt; [TyVar]
</span><a href="GHC.Core.FamInstEnv.html#fi_tvs"><span class="hs-identifier hs-var">fi_tvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668310"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668310"><span class="hs-identifier hs-var">tvs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fi_tys :: FamInst -&gt; [Type]
</span><a href="GHC.Core.FamInstEnv.html#fi_tys"><span class="hs-identifier hs-var">fi_tys</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668311"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668311"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fi_rhs :: FamInst -&gt; Type
</span><a href="GHC.Core.FamInstEnv.html#fi_rhs"><span class="hs-identifier hs-var">fi_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668312"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668312"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-243"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; BranchIndex -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621682668314"><span class="hs-identifier hs-var">ppr_tc_sort</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;instance&quot;</span></span><span>
</span><span id="line-244"></span><span>             </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; CoAxBranch -&gt; SDoc
</span><a href="GHC.Core.Coercion.html#pprCoAxBranchUser"><span class="hs-identifier hs-var">pprCoAxBranchUser</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoAxiom Unbranched -&gt; TyCon
forall (br :: BranchFlag). CoAxiom br -&gt; TyCon
</span><a href="GHC.Core.Coercion.Axiom.html#coAxiomTyCon"><span class="hs-identifier hs-var">coAxiomTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiom Unbranched
</span><a href="#local-6989586621682668309"><span class="hs-identifier hs-var">ax</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoAxiom Unbranched -&gt; CoAxBranch
</span><a href="GHC.Core.Coercion.Axiom.html#coAxiomSingleBranch"><span class="hs-identifier hs-var">coAxiomSingleBranch</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiom Unbranched
</span><a href="#local-6989586621682668309"><span class="hs-identifier hs-var">ax</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-245"></span><span>       </span><span class="annot"><span class="annottext">BranchIndex
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsOutput doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#whenPprDebug"><span class="hs-identifier hs-var">whenPprDebug</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621682668320"><span class="hs-identifier hs-var">debug_stuff</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-247"></span><span>    </span><span id="local-6989586621682668314"><span class="annot"><span class="annottext">ppr_tc_sort :: SDoc
</span><a href="#local-6989586621682668314"><span class="hs-identifier hs-var hs-var">ppr_tc_sort</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">FamFlavor
</span><a href="#local-6989586621682668308"><span class="hs-identifier hs-var">flavor</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-248"></span><span>                     </span><span class="annot"><span class="annottext">FamFlavor
</span><a href="GHC.Core.FamInstEnv.html#SynFamilyInst"><span class="hs-identifier hs-var">SynFamilyInst</span></a></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;type&quot;</span></span><span>
</span><span id="line-249"></span><span>                     </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#DataFamilyInst"><span class="hs-identifier hs-type">DataFamilyInst</span></a></span><span> </span><span id="local-6989586621682668321"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668321"><span class="hs-identifier hs-var">tycon</span></a></span></span><span>
</span><span id="line-250"></span><span>                       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isDataTyCon"><span class="hs-identifier hs-var">isDataTyCon</span></a></span><span>     </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668321"><span class="hs-identifier hs-var">tycon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;data&quot;</span></span><span>
</span><span id="line-251"></span><span>                       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isNewTyCon"><span class="hs-identifier hs-var">isNewTyCon</span></a></span><span>      </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668321"><span class="hs-identifier hs-var">tycon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;newtype&quot;</span></span><span>
</span><span id="line-252"></span><span>                       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isAbstractTyCon"><span class="hs-identifier hs-var">isAbstractTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668321"><span class="hs-identifier hs-var">tycon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;data&quot;</span></span><span>
</span><span id="line-253"></span><span>                       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;WEIRD&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668321"><span class="hs-identifier hs-var">tycon</span></a></span><span>
</span><span id="line-254"></span><span>
</span><span id="line-255"></span><span>    </span><span id="local-6989586621682668320"><span class="annot"><span class="annottext">debug_stuff :: SDoc
</span><a href="#local-6989586621682668320"><span class="hs-identifier hs-var hs-var">debug_stuff</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Coercion axiom:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiom Unbranched -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiom Unbranched
</span><a href="#local-6989586621682668309"><span class="hs-identifier hs-var">ax</span></a></span><span>
</span><span id="line-256"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Tvs:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668310"><span class="hs-identifier hs-var">tvs</span></a></span><span>
</span><span id="line-257"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;LHS:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668311"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-258"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;RHS:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668312"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-259"></span><span>
</span><span id="line-260"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#pprFamInsts"><span class="hs-identifier hs-type">pprFamInsts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span>
</span><span id="line-261"></span><span id="pprFamInsts"><span class="annot"><span class="annottext">pprFamInsts :: [FamInst] -&gt; SDoc
</span><a href="GHC.Core.FamInstEnv.html#pprFamInsts"><span class="hs-identifier hs-var hs-var">pprFamInsts</span></a></span></span><span> </span><span id="local-6989586621682668326"><span class="annot"><span class="annottext">[FamInst]
</span><a href="#local-6989586621682668326"><span class="hs-identifier hs-var">finsts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(FamInst -&gt; SDoc) -&gt; [FamInst] -&gt; [SDoc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">FamInst -&gt; SDoc
</span><a href="GHC.Core.FamInstEnv.html#pprFamInst"><span class="hs-identifier hs-var">pprFamInst</span></a></span><span> </span><span class="annot"><span class="annottext">[FamInst]
</span><a href="#local-6989586621682668326"><span class="hs-identifier hs-var">finsts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-262"></span><span>
</span><span id="line-263"></span><span class="annot"><span class="hs-comment">{- *********************************************************************
*                                                                      *
                 Making FamInsts
*                                                                      *
********************************************************************* -}</span></span><span>
</span><span id="line-268"></span><span>
</span><span id="line-269"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#mkLocalFamInst"><span class="hs-identifier hs-type">mkLocalFamInst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamFlavor"><span class="hs-identifier hs-type">FamFlavor</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#Unbranched"><span class="hs-identifier hs-type">Unbranched</span></a></span><span>
</span><span id="line-270"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-271"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span>
</span><span id="line-272"></span><span id="mkLocalFamInst"><span class="annot"><span class="annottext">mkLocalFamInst :: FamFlavor
-&gt; CoAxiom Unbranched
-&gt; [TyVar]
-&gt; [TyVar]
-&gt; [Type]
-&gt; Type
-&gt; FamInst
</span><a href="GHC.Core.FamInstEnv.html#mkLocalFamInst"><span class="hs-identifier hs-var hs-var">mkLocalFamInst</span></a></span></span><span> </span><span id="local-6989586621682668327"><span class="annot"><span class="annottext">FamFlavor
</span><a href="#local-6989586621682668327"><span class="hs-identifier hs-var">flavor</span></a></span></span><span> </span><span id="local-6989586621682668328"><span class="annot"><span class="annottext">CoAxiom Unbranched
</span><a href="#local-6989586621682668328"><span class="hs-identifier hs-var">axiom</span></a></span></span><span> </span><span id="local-6989586621682668329"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668329"><span class="hs-identifier hs-var">tvs</span></a></span></span><span> </span><span id="local-6989586621682668330"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668330"><span class="hs-identifier hs-var">cvs</span></a></span></span><span> </span><span id="local-6989586621682668331"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668331"><span class="hs-identifier hs-var">lhs</span></a></span></span><span> </span><span id="local-6989586621682668332"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668332"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-273"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fi_fam :: Name
</span><a href="GHC.Core.FamInstEnv.html#fi_fam"><span class="hs-identifier hs-var">fi_fam</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682668333"><span class="hs-identifier hs-var">fam_tc_name</span></a></span><span>
</span><span id="line-274"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fi_flavor :: FamFlavor
</span><a href="GHC.Core.FamInstEnv.html#fi_flavor"><span class="hs-identifier hs-var">fi_flavor</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FamFlavor
</span><a href="#local-6989586621682668327"><span class="hs-identifier hs-var">flavor</span></a></span><span>
</span><span id="line-275"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fi_tcs :: [RoughMatchTc]
</span><a href="GHC.Core.FamInstEnv.html#fi_tcs"><span class="hs-identifier hs-var">fi_tcs</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; [RoughMatchTc]
</span><a href="GHC.Core.RoughMap.html#roughMatchTcs"><span class="hs-identifier hs-var">roughMatchTcs</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668331"><span class="hs-identifier hs-var">lhs</span></a></span><span>
</span><span id="line-276"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fi_tvs :: [TyVar]
</span><a href="GHC.Core.FamInstEnv.html#fi_tvs"><span class="hs-identifier hs-var">fi_tvs</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668329"><span class="hs-identifier hs-var">tvs</span></a></span><span>
</span><span id="line-277"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fi_cvs :: [TyVar]
</span><a href="GHC.Core.FamInstEnv.html#fi_cvs"><span class="hs-identifier hs-var">fi_cvs</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668330"><span class="hs-identifier hs-var">cvs</span></a></span><span>
</span><span id="line-278"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fi_tys :: [Type]
</span><a href="GHC.Core.FamInstEnv.html#fi_tys"><span class="hs-identifier hs-var">fi_tys</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668331"><span class="hs-identifier hs-var">lhs</span></a></span><span>
</span><span id="line-279"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fi_rhs :: Type
</span><a href="GHC.Core.FamInstEnv.html#fi_rhs"><span class="hs-identifier hs-var">fi_rhs</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668332"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-280"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fi_axiom :: CoAxiom Unbranched
</span><a href="GHC.Core.FamInstEnv.html#fi_axiom"><span class="hs-identifier hs-var">fi_axiom</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoAxiom Unbranched
</span><a href="#local-6989586621682668328"><span class="hs-identifier hs-var">axiom</span></a></span><span>
</span><span id="line-281"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fi_orphan :: IsOrphan
</span><a href="GHC.Core.FamInstEnv.html#fi_orphan"><span class="hs-identifier hs-var">fi_orphan</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NameSet -&gt; IsOrphan
</span><a href="GHC.Core.html#chooseOrphanAnchor"><span class="hs-identifier hs-var">chooseOrphanAnchor</span></a></span><span> </span><span class="annot"><span class="annottext">NameSet
</span><a href="#local-6989586621682668335"><span class="hs-identifier hs-var">orph_names</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-282"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-283"></span><span>    </span><span id="local-6989586621682668336"><span class="annot"><span class="annottext">mod :: Module
</span><a href="#local-6989586621682668336"><span class="hs-identifier hs-var hs-var">mod</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Module -&gt; Module
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Bool
</span><a href="GHC.Types.Name.html#isExternalName"><span class="hs-identifier hs-var">isExternalName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoAxiom Unbranched -&gt; Name
forall (br :: BranchFlag). CoAxiom br -&gt; Name
</span><a href="GHC.Core.Coercion.Axiom.html#coAxiomName"><span class="hs-identifier hs-var">coAxiomName</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiom Unbranched
</span><a href="#local-6989586621682668328"><span class="hs-identifier hs-var">axiom</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Module -&gt; Module) -&gt; Module -&gt; Module
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-284"></span><span>          </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Name -&gt; Module
Name -&gt; Module
</span><a href="GHC.Types.Name.html#nameModule"><span class="hs-identifier hs-var">nameModule</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoAxiom Unbranched -&gt; Name
forall (br :: BranchFlag). CoAxiom br -&gt; Name
</span><a href="GHC.Core.Coercion.Axiom.html#coAxiomName"><span class="hs-identifier hs-var">coAxiomName</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiom Unbranched
</span><a href="#local-6989586621682668328"><span class="hs-identifier hs-var">axiom</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-285"></span><span>    </span><span id="local-6989586621682668340"><span class="annot"><span class="annottext">is_local :: Name -&gt; Bool
</span><a href="#local-6989586621682668340"><span class="hs-identifier hs-var hs-var">is_local</span></a></span></span><span> </span><span id="local-6989586621682668341"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682668341"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Module -&gt; Name -&gt; Bool
</span><a href="GHC.Types.Name.html#nameIsLocalOrFrom"><span class="hs-identifier hs-var">nameIsLocalOrFrom</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682668336"><span class="hs-identifier hs-var">mod</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682668341"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-286"></span><span>
</span><span id="line-287"></span><span>    </span><span id="local-6989586621682668335"><span class="annot"><span class="annottext">orph_names :: NameSet
</span><a href="#local-6989586621682668335"><span class="hs-identifier hs-var hs-var">orph_names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Bool) -&gt; NameSet -&gt; NameSet
</span><a href="GHC.Types.Name.Set.html#filterNameSet"><span class="hs-identifier hs-var">filterNameSet</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Bool
</span><a href="#local-6989586621682668340"><span class="hs-identifier hs-var">is_local</span></a></span><span> </span><span class="annot"><span class="annottext">(NameSet -&gt; NameSet) -&gt; NameSet -&gt; NameSet
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-288"></span><span>                 </span><span class="annot"><span class="annottext">CoAxiom Unbranched -&gt; NameSet
forall (br :: BranchFlag). CoAxiom br -&gt; NameSet
</span><a href="GHC.Core.FVs.html#orphNamesOfAxiomLHS"><span class="hs-identifier hs-var">orphNamesOfAxiomLHS</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiom Unbranched
</span><a href="#local-6989586621682668328"><span class="hs-identifier hs-var">axiom</span></a></span><span> </span><span class="annot"><span class="annottext">NameSet -&gt; Name -&gt; NameSet
</span><a href="GHC.Types.Name.Set.html#extendNameSet"><span class="hs-operator hs-var">`extendNameSet`</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682668333"><span class="hs-identifier hs-var">fam_tc_name</span></a></span><span>
</span><span id="line-289"></span><span>
</span><span id="line-290"></span><span>    </span><span id="local-6989586621682668333"><span class="annot"><span class="annottext">fam_tc_name :: Name
</span><a href="#local-6989586621682668333"><span class="hs-identifier hs-var hs-var">fam_tc_name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Name
</span><a href="GHC.Core.TyCon.html#tyConName"><span class="hs-identifier hs-var">tyConName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoAxiom Unbranched -&gt; TyCon
forall (br :: BranchFlag). CoAxiom br -&gt; TyCon
</span><a href="GHC.Core.Coercion.Axiom.html#coAxiomTyCon"><span class="hs-identifier hs-var">coAxiomTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiom Unbranched
</span><a href="#local-6989586621682668328"><span class="hs-identifier hs-var">axiom</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-291"></span><span>
</span><span id="line-292"></span><span>
</span><span id="line-293"></span><span class="hs-comment">{-
Note [Lazy axiom match]
~~~~~~~~~~~~~~~~~~~~~~~
It is Vitally Important that mkImportedFamInst is *lazy* in its axiom
parameter. The axiom is loaded lazily, via a forkM, in GHC.IfaceToCore. Sometime
later, mkImportedFamInst is called using that axiom. However, the axiom
may itself depend on entities which are not yet loaded as of the time
of the mkImportedFamInst. Thus, if mkImportedFamInst eagerly looks at the
axiom, a dependency loop spontaneously appears and GHC hangs. The solution
is simply for mkImportedFamInst never, ever to look inside of the axiom
until everything else is good and ready to do so. We can assume that this
readiness has been achieved when some other code pulls on the axiom in the
FamInst. Thus, we pattern match on the axiom lazily (in the where clause,
not in the parameter list) and we assert the consistency of names there
also.
-}</span><span>
</span><span id="line-309"></span><span>
</span><span id="line-310"></span><span class="hs-comment">-- Make a family instance representation from the information found in an</span><span>
</span><span id="line-311"></span><span class="hs-comment">-- interface file.  In particular, we get the rough match info from the iface</span><span>
</span><span id="line-312"></span><span class="hs-comment">-- (instead of computing it here).</span><span>
</span><span id="line-313"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#mkImportedFamInst"><span class="hs-identifier hs-type">mkImportedFamInst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span>               </span><span class="hs-comment">-- Name of the family</span><span>
</span><span id="line-314"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.RoughMap.html#RoughMatchTc"><span class="hs-identifier hs-type">RoughMatchTc</span></a></span><span class="hs-special">]</span><span>     </span><span class="hs-comment">-- Rough match info</span><span>
</span><span id="line-315"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#Unbranched"><span class="hs-identifier hs-type">Unbranched</span></a></span><span> </span><span class="hs-comment">-- Axiom introduced</span><span>
</span><span id="line-316"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#IsOrphan"><span class="hs-identifier hs-type">IsOrphan</span></a></span><span>
</span><span id="line-317"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span>            </span><span class="hs-comment">-- Resulting family instance</span><span>
</span><span id="line-318"></span><span id="mkImportedFamInst"><span class="annot"><span class="annottext">mkImportedFamInst :: Name -&gt; [RoughMatchTc] -&gt; CoAxiom Unbranched -&gt; IsOrphan -&gt; FamInst
</span><a href="GHC.Core.FamInstEnv.html#mkImportedFamInst"><span class="hs-identifier hs-var hs-var">mkImportedFamInst</span></a></span></span><span> </span><span id="local-6989586621682668346"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682668346"><span class="hs-identifier hs-var">fam</span></a></span></span><span> </span><span id="local-6989586621682668347"><span class="annot"><span class="annottext">[RoughMatchTc]
</span><a href="#local-6989586621682668347"><span class="hs-identifier hs-var">mb_tcs</span></a></span></span><span> </span><span id="local-6989586621682668348"><span class="annot"><span class="annottext">CoAxiom Unbranched
</span><a href="#local-6989586621682668348"><span class="hs-identifier hs-var">axiom</span></a></span></span><span> </span><span id="local-6989586621682668349"><span class="annot"><span class="annottext">IsOrphan
</span><a href="#local-6989586621682668349"><span class="hs-identifier hs-var">orphan</span></a></span></span><span>
</span><span id="line-319"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-320"></span><span>      </span><span class="annot"><span class="annottext">fi_fam :: Name
</span><a href="GHC.Core.FamInstEnv.html#fi_fam"><span class="hs-identifier hs-var">fi_fam</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682668346"><span class="hs-identifier hs-var">fam</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-321"></span><span>      </span><span class="annot"><span class="annottext">fi_tcs :: [RoughMatchTc]
</span><a href="GHC.Core.FamInstEnv.html#fi_tcs"><span class="hs-identifier hs-var">fi_tcs</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[RoughMatchTc]
</span><a href="#local-6989586621682668347"><span class="hs-identifier hs-var">mb_tcs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-322"></span><span>      </span><span class="annot"><span class="annottext">fi_tvs :: [TyVar]
</span><a href="GHC.Core.FamInstEnv.html#fi_tvs"><span class="hs-identifier hs-var">fi_tvs</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668350"><span class="hs-identifier hs-var">tvs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-323"></span><span>      </span><span class="annot"><span class="annottext">fi_cvs :: [TyVar]
</span><a href="GHC.Core.FamInstEnv.html#fi_cvs"><span class="hs-identifier hs-var">fi_cvs</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668351"><span class="hs-identifier hs-var">cvs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-324"></span><span>      </span><span class="annot"><span class="annottext">fi_tys :: [Type]
</span><a href="GHC.Core.FamInstEnv.html#fi_tys"><span class="hs-identifier hs-var">fi_tys</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668352"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-325"></span><span>      </span><span class="annot"><span class="annottext">fi_rhs :: Type
</span><a href="GHC.Core.FamInstEnv.html#fi_rhs"><span class="hs-identifier hs-var">fi_rhs</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668353"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-326"></span><span>      </span><span class="annot"><span class="annottext">fi_axiom :: CoAxiom Unbranched
</span><a href="GHC.Core.FamInstEnv.html#fi_axiom"><span class="hs-identifier hs-var">fi_axiom</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoAxiom Unbranched
</span><a href="#local-6989586621682668348"><span class="hs-identifier hs-var">axiom</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-327"></span><span>      </span><span class="annot"><span class="annottext">fi_flavor :: FamFlavor
</span><a href="GHC.Core.FamInstEnv.html#fi_flavor"><span class="hs-identifier hs-var">fi_flavor</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FamFlavor
</span><a href="#local-6989586621682668354"><span class="hs-identifier hs-var">flavor</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-328"></span><span>      </span><span class="annot"><span class="annottext">fi_orphan :: IsOrphan
</span><a href="GHC.Core.FamInstEnv.html#fi_orphan"><span class="hs-identifier hs-var">fi_orphan</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IsOrphan
</span><a href="#local-6989586621682668349"><span class="hs-identifier hs-var">orphan</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-329"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-330"></span><span>     </span><span class="hs-comment">-- See Note [Lazy axiom match]</span><span>
</span><span id="line-331"></span><span>     </span><span class="hs-glyph">~</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cab_lhs :: CoAxBranch -&gt; [Type]
</span><a href="GHC.Core.Coercion.Axiom.html#cab_lhs"><span class="hs-identifier hs-var">cab_lhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668352"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668352"><span class="hs-identifier hs-var">tys</span></a></span></span><span>
</span><span id="line-332"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cab_tvs :: CoAxBranch -&gt; [TyVar]
</span><a href="GHC.Core.Coercion.Axiom.html#cab_tvs"><span class="hs-identifier hs-var">cab_tvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668350"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668350"><span class="hs-identifier hs-var">tvs</span></a></span></span><span>
</span><span id="line-333"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cab_cvs :: CoAxBranch -&gt; [TyVar]
</span><a href="GHC.Core.Coercion.Axiom.html#cab_cvs"><span class="hs-identifier hs-var">cab_cvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668351"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668351"><span class="hs-identifier hs-var">cvs</span></a></span></span><span>
</span><span id="line-334"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cab_rhs :: CoAxBranch -&gt; Type
</span><a href="GHC.Core.Coercion.Axiom.html#cab_rhs"><span class="hs-identifier hs-var">cab_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668353"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668353"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoAxiom Unbranched -&gt; CoAxBranch
</span><a href="GHC.Core.Coercion.Axiom.html#coAxiomSingleBranch"><span class="hs-identifier hs-var">coAxiomSingleBranch</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiom Unbranched
</span><a href="#local-6989586621682668348"><span class="hs-identifier hs-var">axiom</span></a></span><span>
</span><span id="line-335"></span><span>
</span><span id="line-336"></span><span>         </span><span class="hs-comment">-- Derive the flavor for an imported FamInst rather disgustingly</span><span>
</span><span id="line-337"></span><span>         </span><span class="hs-comment">-- Maybe we should store it in the IfaceFamInst?</span><span>
</span><span id="line-338"></span><span>     </span><span id="local-6989586621682668354"><span class="annot"><span class="annottext">flavor :: FamFlavor
</span><a href="#local-6989586621682668354"><span class="hs-identifier hs-var hs-var">flavor</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Maybe (TyCon, [Type])
Type -&gt; Maybe (TyCon, [Type])
</span><a href="GHC.Core.Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668353"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-339"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682668361"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668361"><span class="hs-identifier hs-var">tc</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-340"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682668362"><span class="annot"><span class="annottext">CoAxiom Unbranched
</span><a href="#local-6989586621682668362"><span class="hs-identifier hs-var">ax'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Maybe (CoAxiom Unbranched)
</span><a href="GHC.Core.TyCon.html#tyConFamilyCoercion_maybe"><span class="hs-identifier hs-var">tyConFamilyCoercion_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668361"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-341"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoAxiom Unbranched
</span><a href="#local-6989586621682668362"><span class="hs-identifier hs-var">ax'</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiom Unbranched -&gt; CoAxiom Unbranched -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">CoAxiom Unbranched
</span><a href="#local-6989586621682668348"><span class="hs-identifier hs-var">axiom</span></a></span><span>
</span><span id="line-342"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; FamFlavor
</span><a href="GHC.Core.FamInstEnv.html#DataFamilyInst"><span class="hs-identifier hs-var">DataFamilyInst</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668361"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-343"></span><span>                </span><span class="annot"><span class="annottext">Maybe (TyCon, [Type])
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FamFlavor
</span><a href="GHC.Core.FamInstEnv.html#SynFamilyInst"><span class="hs-identifier hs-var">SynFamilyInst</span></a></span><span>
</span><span id="line-344"></span><span>
</span><span id="line-345"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
                FamInstEnv
*                                                                      *
************************************************************************

Note [FamInstEnv]
~~~~~~~~~~~~~~~~~
A FamInstEnv is a RoughMap of instance heads. Specifically, the keys are formed
by the family name and the instance arguments. That is, an instance:

    type instance Fam (Maybe Int) a

would insert into the instance environment an instance with a key of the form

  [RM_KnownTc Fam, RM_KnownTc Maybe, RM_WildCard]

See Note [RoughMap] in GHC.Core.RoughMap.


The same FamInstEnv includes both 'data family' and 'type family' instances.
Type families are reduced during type inference, but not data families;
the user explains when to use a data family instance by using constructors
and pattern matching.

Nevertheless it is still useful to have data families in the FamInstEnv:

 - For finding overlaps and conflicts

 - For finding the representation type...see FamInstEnv.topNormaliseType
   and its call site in GHC.Core.Opt.Simplify.Iteration

 - In standalone deriving instance Eq (T [Int]) we need to find the
   representation type for T [Int]

Note [Varying number of patterns for data family axioms]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For data families, the number of patterns may vary between instances.
For example
   data family T a b
   data instance T Int a = T1 a | T2
   data instance T Bool [a] = T3 a

Then we get a data type for each instance, and an axiom:
   data TInt a = T1 a | T2
   data TBoolList a = T3 a

   axiom ax7   :: T Int ~ TInt   -- Eta-reduced
   axiom ax8 a :: T Bool [a] ~ TBoolList a

These two axioms for T, one with one pattern, one with two;
see Note [Eta reduction for data families] in GHC.Core.Coercion.Axiom

Note [FamInstEnv determinism]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We turn FamInstEnvs into a list in some places that don't directly affect
the ABI. That happens in family consistency checks and when producing output
for `:info`. Unfortunately that nondeterminism is nonlocal and it's hard
to tell what it affects without following a chain of functions. It's also
easy to accidentally make that nondeterminism affect the ABI. Furthermore
the envs should be relatively small, so it should be free to use deterministic
maps here. Testing with nofib and validate detected no difference between
UniqFM and UniqDFM.
See Note [Deterministic UniqFM].
-}</span><span>
</span><span id="line-411"></span><span>
</span><span id="line-412"></span><span class="hs-keyword">type</span><span> </span><span id="FamInstEnvs"><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-var">FamInstEnvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-413"></span><span>     </span><span class="hs-comment">-- External package inst-env, Home-package inst-env</span><span>
</span><span id="line-414"></span><span>
</span><span id="line-415"></span><span class="hs-keyword">data</span><span> </span><span id="FamInstEnv"><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-var">FamInstEnv</span></a></span></span><span>
</span><span id="line-416"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="FamIE"><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamIE"><span class="hs-identifier hs-var">FamIE</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-comment">-- The number of instances, used to choose the smaller environment</span><span>
</span><span id="line-417"></span><span>               </span><span class="hs-comment">-- when checking type family consistency of home modules.</span><span>
</span><span id="line-418"></span><span>          </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.RoughMap.html#RoughMap"><span class="hs-identifier hs-type">RoughMap</span></a></span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-419"></span><span>     </span><span class="hs-comment">-- See Note [FamInstEnv]</span><span>
</span><span id="line-420"></span><span>     </span><span class="hs-comment">-- See Note [FamInstEnv determinism]</span><span>
</span><span id="line-421"></span><span>
</span><span id="line-422"></span><span>
</span><span id="line-423"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-424"></span><span>  </span><span id="local-6989586621682668371"><span class="annot"><span class="annottext">ppr :: FamInstEnv -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamIE"><span class="hs-identifier hs-type">FamIE</span></a></span><span> </span><span class="annot"><span class="annottext">BranchIndex
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682668372"><span class="annot"><span class="annottext">RoughMap FamInst
</span><a href="#local-6989586621682668372"><span class="hs-identifier hs-var">fs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;FamIE&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(FamInst -&gt; SDoc) -&gt; [FamInst] -&gt; [SDoc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">FamInst -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">([FamInst] -&gt; [SDoc]) -&gt; [FamInst] -&gt; [SDoc]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RoughMap FamInst -&gt; [FamInst]
forall a. RoughMap a -&gt; [a]
</span><a href="GHC.Core.RoughMap.html#elemsRM"><span class="hs-identifier hs-var">elemsRM</span></a></span><span> </span><span class="annot"><span class="annottext">RoughMap FamInst
</span><a href="#local-6989586621682668372"><span class="hs-identifier hs-var">fs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-425"></span><span>
</span><span id="line-426"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#famInstEnvSize"><span class="hs-identifier hs-type">famInstEnvSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-427"></span><span id="famInstEnvSize"><span class="annot"><span class="annottext">famInstEnvSize :: FamInstEnv -&gt; BranchIndex
</span><a href="GHC.Core.FamInstEnv.html#famInstEnvSize"><span class="hs-identifier hs-var hs-var">famInstEnvSize</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamIE"><span class="hs-identifier hs-type">FamIE</span></a></span><span> </span><span id="local-6989586621682668374"><span class="annot"><span class="annottext">BranchIndex
</span><a href="#local-6989586621682668374"><span class="hs-identifier hs-var">sz</span></a></span></span><span> </span><span class="annot"><span class="annottext">RoughMap FamInst
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BranchIndex
</span><a href="#local-6989586621682668374"><span class="hs-identifier hs-var">sz</span></a></span><span>
</span><span id="line-428"></span><span>
</span><span id="line-429"></span><span class="hs-comment">-- | Create a 'FamInstEnv' from 'Name' indices.</span><span>
</span><span id="line-430"></span><span class="hs-comment">-- INVARIANTS:</span><span>
</span><span id="line-431"></span><span class="hs-comment">--  * The fs_tvs are distinct in each FamInst</span><span>
</span><span id="line-432"></span><span class="hs-comment">--      of a range value of the map (so we can safely unify them)</span><span>
</span><span id="line-433"></span><span>
</span><span id="line-434"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#emptyFamInstEnvs"><span class="hs-identifier hs-type">emptyFamInstEnvs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-435"></span><span id="emptyFamInstEnvs"><span class="annot"><span class="annottext">emptyFamInstEnvs :: (FamInstEnv, FamInstEnv)
</span><a href="GHC.Core.FamInstEnv.html#emptyFamInstEnvs"><span class="hs-identifier hs-var hs-var">emptyFamInstEnvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FamInstEnv
</span><a href="GHC.Core.FamInstEnv.html#emptyFamInstEnv"><span class="hs-identifier hs-var">emptyFamInstEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FamInstEnv
</span><a href="GHC.Core.FamInstEnv.html#emptyFamInstEnv"><span class="hs-identifier hs-var">emptyFamInstEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-436"></span><span>
</span><span id="line-437"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#emptyFamInstEnv"><span class="hs-identifier hs-type">emptyFamInstEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a></span><span>
</span><span id="line-438"></span><span id="emptyFamInstEnv"><span class="annot"><span class="annottext">emptyFamInstEnv :: FamInstEnv
</span><a href="GHC.Core.FamInstEnv.html#emptyFamInstEnv"><span class="hs-identifier hs-var hs-var">emptyFamInstEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BranchIndex -&gt; RoughMap FamInst -&gt; FamInstEnv
</span><a href="GHC.Core.FamInstEnv.html#FamIE"><span class="hs-identifier hs-var">FamIE</span></a></span><span> </span><span class="annot"><span class="annottext">BranchIndex
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">RoughMap FamInst
forall a. RoughMap a
</span><a href="GHC.Core.RoughMap.html#emptyRM"><span class="hs-identifier hs-var">emptyRM</span></a></span><span>
</span><span id="line-439"></span><span>
</span><span id="line-440"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#famInstEnvElts"><span class="hs-identifier hs-type">famInstEnvElts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-441"></span><span id="famInstEnvElts"><span class="annot"><span class="annottext">famInstEnvElts :: FamInstEnv -&gt; [FamInst]
</span><a href="GHC.Core.FamInstEnv.html#famInstEnvElts"><span class="hs-identifier hs-var hs-var">famInstEnvElts</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamIE"><span class="hs-identifier hs-type">FamIE</span></a></span><span> </span><span class="annot"><span class="annottext">BranchIndex
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682668376"><span class="annot"><span class="annottext">RoughMap FamInst
</span><a href="#local-6989586621682668376"><span class="hs-identifier hs-var">rm</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RoughMap FamInst -&gt; [FamInst]
forall a. RoughMap a -&gt; [a]
</span><a href="GHC.Core.RoughMap.html#elemsRM"><span class="hs-identifier hs-var">elemsRM</span></a></span><span> </span><span class="annot"><span class="annottext">RoughMap FamInst
</span><a href="#local-6989586621682668376"><span class="hs-identifier hs-var">rm</span></a></span><span>
</span><span id="line-442"></span><span>  </span><span class="hs-comment">-- See Note [FamInstEnv determinism]</span><span>
</span><span id="line-443"></span><span>
</span><span id="line-444"></span><span>  </span><span class="hs-comment">-- It's OK to use nonDetStrictFoldUDFM here since we're just computing the</span><span>
</span><span id="line-445"></span><span>  </span><span class="hs-comment">-- size.</span><span>
</span><span id="line-446"></span><span>
</span><span id="line-447"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#familyInstances"><span class="hs-identifier hs-type">familyInstances</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-448"></span><span id="familyInstances"><span class="annot"><span class="annottext">familyInstances :: (FamInstEnv, FamInstEnv) -&gt; TyCon -&gt; [FamInst]
</span><a href="GHC.Core.FamInstEnv.html#familyInstances"><span class="hs-identifier hs-var hs-var">familyInstances</span></a></span></span><span> </span><span id="local-6989586621682668377"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621682668377"><span class="hs-identifier hs-var">envs</span></a></span></span><span> </span><span id="local-6989586621682668378"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668378"><span class="hs-identifier hs-var">tc</span></a></span></span><span>
</span><span id="line-449"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv) -&gt; Name -&gt; [FamInst]
</span><a href="GHC.Core.FamInstEnv.html#familyNameInstances"><span class="hs-identifier hs-var">familyNameInstances</span></a></span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621682668377"><span class="hs-identifier hs-var">envs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Name
</span><a href="GHC.Core.TyCon.html#tyConName"><span class="hs-identifier hs-var">tyConName</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668378"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-450"></span><span>
</span><span id="line-451"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#familyNameInstances"><span class="hs-identifier hs-type">familyNameInstances</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-452"></span><span id="familyNameInstances"><span class="annot"><span class="annottext">familyNameInstances :: (FamInstEnv, FamInstEnv) -&gt; Name -&gt; [FamInst]
</span><a href="GHC.Core.FamInstEnv.html#familyNameInstances"><span class="hs-identifier hs-var hs-var">familyNameInstances</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682668379"><span class="annot"><span class="annottext">FamInstEnv
</span><a href="#local-6989586621682668379"><span class="hs-identifier hs-var">pkg_fie</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682668380"><span class="annot"><span class="annottext">FamInstEnv
</span><a href="#local-6989586621682668380"><span class="hs-identifier hs-var">home_fie</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682668381"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682668381"><span class="hs-identifier hs-var">fam</span></a></span></span><span>
</span><span id="line-453"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FamInstEnv -&gt; [FamInst]
</span><a href="#local-6989586621682668382"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span class="annot"><span class="annottext">FamInstEnv
</span><a href="#local-6989586621682668380"><span class="hs-identifier hs-var">home_fie</span></a></span><span> </span><span class="annot"><span class="annottext">[FamInst] -&gt; [FamInst] -&gt; [FamInst]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">FamInstEnv -&gt; [FamInst]
</span><a href="#local-6989586621682668382"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span class="annot"><span class="annottext">FamInstEnv
</span><a href="#local-6989586621682668379"><span class="hs-identifier hs-var">pkg_fie</span></a></span><span>
</span><span id="line-454"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-455"></span><span>    </span><span class="annot"><a href="#local-6989586621682668382"><span class="hs-identifier hs-type">get</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-456"></span><span>    </span><span id="local-6989586621682668382"><span class="annot"><span class="annottext">get :: FamInstEnv -&gt; [FamInst]
</span><a href="#local-6989586621682668382"><span class="hs-identifier hs-var hs-var">get</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamIE"><span class="hs-identifier hs-type">FamIE</span></a></span><span> </span><span class="annot"><span class="annottext">BranchIndex
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682668383"><span class="annot"><span class="annottext">RoughMap FamInst
</span><a href="#local-6989586621682668383"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[RoughMatchLookupTc] -&gt; RoughMap FamInst -&gt; [FamInst]
forall a. [RoughMatchLookupTc] -&gt; RoughMap a -&gt; [a]
</span><a href="GHC.Core.RoughMap.html#lookupRM"><span class="hs-identifier hs-var">lookupRM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Name -&gt; RoughMatchLookupTc
</span><a href="GHC.Core.RoughMap.html#RML_KnownTc"><span class="hs-identifier hs-var">RML_KnownTc</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682668381"><span class="hs-identifier hs-var">fam</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">RoughMap FamInst
</span><a href="#local-6989586621682668383"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-457"></span><span>
</span><span id="line-458"></span><span>
</span><span id="line-459"></span><span class="annot"><span class="hs-comment">-- | Makes no particular effort to detect conflicts.</span></span><span>
</span><span id="line-460"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#unionFamInstEnv"><span class="hs-identifier hs-type">unionFamInstEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a></span><span>
</span><span id="line-461"></span><span id="unionFamInstEnv"><span class="annot"><span class="annottext">unionFamInstEnv :: FamInstEnv -&gt; FamInstEnv -&gt; FamInstEnv
</span><a href="GHC.Core.FamInstEnv.html#unionFamInstEnv"><span class="hs-identifier hs-var hs-var">unionFamInstEnv</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamIE"><span class="hs-identifier hs-type">FamIE</span></a></span><span> </span><span id="local-6989586621682668386"><span class="annot"><span class="annottext">BranchIndex
</span><a href="#local-6989586621682668386"><span class="hs-identifier hs-var">sa</span></a></span></span><span> </span><span id="local-6989586621682668387"><span class="annot"><span class="annottext">RoughMap FamInst
</span><a href="#local-6989586621682668387"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamIE"><span class="hs-identifier hs-type">FamIE</span></a></span><span> </span><span id="local-6989586621682668388"><span class="annot"><span class="annottext">BranchIndex
</span><a href="#local-6989586621682668388"><span class="hs-identifier hs-var">sb</span></a></span></span><span> </span><span id="local-6989586621682668389"><span class="annot"><span class="annottext">RoughMap FamInst
</span><a href="#local-6989586621682668389"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BranchIndex -&gt; RoughMap FamInst -&gt; FamInstEnv
</span><a href="GHC.Core.FamInstEnv.html#FamIE"><span class="hs-identifier hs-var">FamIE</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BranchIndex
</span><a href="#local-6989586621682668386"><span class="hs-identifier hs-var">sa</span></a></span><span> </span><span class="annot"><span class="annottext">BranchIndex -&gt; BranchIndex -&gt; BranchIndex
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">BranchIndex
</span><a href="#local-6989586621682668388"><span class="hs-identifier hs-var">sb</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RoughMap FamInst
</span><a href="#local-6989586621682668387"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">RoughMap FamInst -&gt; RoughMap FamInst -&gt; RoughMap FamInst
forall a. RoughMap a -&gt; RoughMap a -&gt; RoughMap a
</span><a href="GHC.Core.RoughMap.html#unionRM"><span class="hs-operator hs-var">`unionRM`</span></a></span><span> </span><span class="annot"><span class="annottext">RoughMap FamInst
</span><a href="#local-6989586621682668389"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-462"></span><span>
</span><span id="line-463"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#extendFamInstEnvList"><span class="hs-identifier hs-type">extendFamInstEnvList</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a></span><span>
</span><span id="line-464"></span><span id="extendFamInstEnvList"><span class="annot"><span class="annottext">extendFamInstEnvList :: FamInstEnv -&gt; [FamInst] -&gt; FamInstEnv
</span><a href="GHC.Core.FamInstEnv.html#extendFamInstEnvList"><span class="hs-identifier hs-var hs-var">extendFamInstEnvList</span></a></span></span><span> </span><span id="local-6989586621682668392"><span class="annot"><span class="annottext">FamInstEnv
</span><a href="#local-6989586621682668392"><span class="hs-identifier hs-var">inst_env</span></a></span></span><span> </span><span id="local-6989586621682668393"><span class="annot"><span class="annottext">[FamInst]
</span><a href="#local-6989586621682668393"><span class="hs-identifier hs-var">fis</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FamInstEnv -&gt; FamInst -&gt; FamInstEnv)
-&gt; FamInstEnv -&gt; [FamInst] -&gt; FamInstEnv
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="annot"><span class="annottext">FamInstEnv -&gt; FamInst -&gt; FamInstEnv
</span><a href="GHC.Core.FamInstEnv.html#extendFamInstEnv"><span class="hs-identifier hs-var">extendFamInstEnv</span></a></span><span> </span><span class="annot"><span class="annottext">FamInstEnv
</span><a href="#local-6989586621682668392"><span class="hs-identifier hs-var">inst_env</span></a></span><span> </span><span class="annot"><span class="annottext">[FamInst]
</span><a href="#local-6989586621682668393"><span class="hs-identifier hs-var">fis</span></a></span><span>
</span><span id="line-465"></span><span>
</span><span id="line-466"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#extendFamInstEnv"><span class="hs-identifier hs-type">extendFamInstEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a></span><span>
</span><span id="line-467"></span><span id="extendFamInstEnv"><span class="annot"><span class="annottext">extendFamInstEnv :: FamInstEnv -&gt; FamInst -&gt; FamInstEnv
</span><a href="GHC.Core.FamInstEnv.html#extendFamInstEnv"><span class="hs-identifier hs-var hs-var">extendFamInstEnv</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamIE"><span class="hs-identifier hs-type">FamIE</span></a></span><span> </span><span id="local-6989586621682668395"><span class="annot"><span class="annottext">BranchIndex
</span><a href="#local-6989586621682668395"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621682668396"><span class="annot"><span class="annottext">RoughMap FamInst
</span><a href="#local-6989586621682668396"><span class="hs-identifier hs-var">inst_env</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-468"></span><span>                 </span><span id="local-6989586621682668397"><span class="annot"><span class="annottext">ins_item :: FamInst
</span><a href="#local-6989586621682668397"><span class="hs-identifier hs-var">ins_item</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">fi_fam :: FamInst -&gt; Name
</span><a href="GHC.Core.FamInstEnv.html#fi_fam"><span class="hs-identifier hs-var">fi_fam</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668398"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682668398"><span class="hs-identifier hs-var">cls_nm</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-469"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BranchIndex -&gt; RoughMap FamInst -&gt; FamInstEnv
</span><a href="GHC.Core.FamInstEnv.html#FamIE"><span class="hs-identifier hs-var">FamIE</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BranchIndex
</span><a href="#local-6989586621682668395"><span class="hs-identifier hs-var">s</span></a></span><span class="annot"><span class="annottext">BranchIndex -&gt; BranchIndex -&gt; BranchIndex
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span class="annot"><span class="annottext">BranchIndex
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(RoughMap FamInst -&gt; FamInstEnv) -&gt; RoughMap FamInst -&gt; FamInstEnv
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[RoughMatchTc] -&gt; FamInst -&gt; RoughMap FamInst -&gt; RoughMap FamInst
forall a. [RoughMatchTc] -&gt; a -&gt; RoughMap a -&gt; RoughMap a
</span><a href="GHC.Core.RoughMap.html#insertRM"><span class="hs-identifier hs-var">insertRM</span></a></span><span> </span><span class="annot"><span class="annottext">[RoughMatchTc]
</span><a href="#local-6989586621682668400"><span class="hs-identifier hs-var">rough_tmpl</span></a></span><span> </span><span class="annot"><span class="annottext">FamInst
</span><a href="#local-6989586621682668397"><span class="hs-identifier hs-var">ins_item</span></a></span><span> </span><span class="annot"><span class="annottext">RoughMap FamInst
</span><a href="#local-6989586621682668396"><span class="hs-identifier hs-var">inst_env</span></a></span><span>
</span><span id="line-470"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-471"></span><span>    </span><span id="local-6989586621682668400"><span class="annot"><span class="annottext">rough_tmpl :: [RoughMatchTc]
</span><a href="#local-6989586621682668400"><span class="hs-identifier hs-var hs-var">rough_tmpl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; RoughMatchTc
</span><a href="GHC.Core.RoughMap.html#RM_KnownTc"><span class="hs-identifier hs-var">RM_KnownTc</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682668398"><span class="hs-identifier hs-var">cls_nm</span></a></span><span> </span><span class="annot"><span class="annottext">RoughMatchTc -&gt; [RoughMatchTc] -&gt; [RoughMatchTc]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">FamInst -&gt; [RoughMatchTc]
</span><a href="GHC.Core.FamInstEnv.html#fi_tcs"><span class="hs-identifier hs-var">fi_tcs</span></a></span><span> </span><span class="annot"><span class="annottext">FamInst
</span><a href="#local-6989586621682668397"><span class="hs-identifier hs-var">ins_item</span></a></span><span>
</span><span id="line-472"></span><span>
</span><span id="line-473"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Compatibility
*                                                                      *
************************************************************************

Note [Apartness]
~~~~~~~~~~~~~~~~
In dealing with closed type families, we must be able to check that one type
will never reduce to another. This check is called /apartness/. The check
is always between a target (which may be an arbitrary type) and a pattern.
Here is how we do it:

apart(target, pattern) = not (unify(flatten(target), pattern))

where flatten (implemented in flattenTys, below) converts all type-family
applications into fresh variables. (See
Note [Flattening type-family applications when matching instances] in GHC.Core.Unify.)

Note [Compatibility]
~~~~~~~~~~~~~~~~~~~~
Two patterns are /compatible/ if either of the following conditions hold:
1) The patterns are apart.
2) The patterns unify with a substitution S, and their right hand sides
equal under that substitution.

For open type families, only compatible instances are allowed. For closed
type families, the story is slightly more complicated. Consider the following:

type family F a where
  F Int = Bool
  F a   = Int

g :: Show a =&gt; a -&gt; F a
g x = length (show x)

Should that type-check? No. We need to allow for the possibility that 'a'
might be Int and therefore 'F a' should be Bool. We can simplify 'F a' to Int
only when we can be sure that 'a' is not Int.

To achieve this, after finding a possible match within the equations, we have to
go back to all previous equations and check that, under the
substitution induced by the match, other branches are surely apart. (See
Note [Apartness].) This is similar to what happens with class
instance selection, when we need to guarantee that there is only a match and
no unifiers. The exact algorithm is different here because the
potentially-overlapping group is closed.

As another example, consider this:

type family G x where
  G Int = Bool
  G a   = Double

type family H y
-- no instances

Now, we want to simplify (G (H Char)). We can't, because (H Char) might later
simplify to be Int. So, (G (H Char)) is stuck, for now.

While everything above is quite sound, it isn't as expressive as we'd like.
Consider this:

type family J a where
  J Int = Int
  J a   = a

Can we simplify (J b) to b? Sure we can. Yes, the first equation matches if
b is instantiated with Int, but the RHSs coincide there, so it's all OK.

So, the rule is this: when looking up a branch in a closed type family, we
find a branch that matches the target, but then we make sure that the target
is apart from every previous *incompatible* branch. We don't check the
branches that are compatible with the matching branch, because they are either
irrelevant (clause 1 of compatible) or benign (clause 2 of compatible).

Note [Compatibility of eta-reduced axioms]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In newtype instances of data families we eta-reduce the axioms,
See Note [Eta reduction for data families] in GHC.Core.Coercion.Axiom. This means that
we sometimes need to test compatibility of two axioms that were eta-reduced to
different degrees, e.g.:


data family D a b c
newtype instance D a Int c = DInt (Maybe a)
  -- D a Int ~ Maybe
  -- lhs = [a, Int]
newtype instance D Bool Int Char = DIntChar Float
  -- D Bool Int Char ~ Float
  -- lhs = [Bool, Int, Char]

These are obviously incompatible. We could detect this by saturating
(eta-expanding) the shorter LHS with fresh tyvars until the lists are of
equal length, but instead we can just remove the tail of the longer list, as
those types will simply unify with the freshly introduced tyvars.

By doing this, in case the LHS are unifiable, the yielded substitution won't
mention the tyvars that appear in the tail we dropped off, and we might try
to test equality RHSes of different kinds, but that's fine since this case
occurs only for data families, where the RHS is a unique tycon and the equality
fails anyway.
-}</span><span>
</span><span id="line-577"></span><span>
</span><span id="line-578"></span><span class="hs-comment">-- See Note [Compatibility]</span><span>
</span><span id="line-579"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#compatibleBranches"><span class="hs-identifier hs-type">compatibleBranches</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-580"></span><span id="compatibleBranches"><span class="annot"><span class="annottext">compatibleBranches :: CoAxBranch -&gt; CoAxBranch -&gt; Bool
</span><a href="GHC.Core.FamInstEnv.html#compatibleBranches"><span class="hs-identifier hs-var hs-var">compatibleBranches</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cab_lhs :: CoAxBranch -&gt; [Type]
</span><a href="GHC.Core.Coercion.Axiom.html#cab_lhs"><span class="hs-identifier hs-var">cab_lhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668402"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668402"><span class="hs-identifier hs-var">lhs1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cab_rhs :: CoAxBranch -&gt; Type
</span><a href="GHC.Core.Coercion.Axiom.html#cab_rhs"><span class="hs-identifier hs-var">cab_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668403"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668403"><span class="hs-identifier hs-var">rhs1</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-581"></span><span>                   </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cab_lhs :: CoAxBranch -&gt; [Type]
</span><a href="GHC.Core.Coercion.Axiom.html#cab_lhs"><span class="hs-identifier hs-var">cab_lhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668404"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668404"><span class="hs-identifier hs-var">lhs2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cab_rhs :: CoAxBranch -&gt; Type
</span><a href="GHC.Core.Coercion.Axiom.html#cab_rhs"><span class="hs-identifier hs-var">cab_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668405"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668405"><span class="hs-identifier hs-var">rhs2</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-582"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">BindFun -&gt; [Type] -&gt; [Type] -&gt; UnifyResult
</span><a href="GHC.Core.Unify.html#tcUnifyTysFG"><span class="hs-identifier hs-var">tcUnifyTysFG</span></a></span><span> </span><span class="annot"><span class="annottext">BindFun
</span><a href="GHC.Core.Unify.html#alwaysBindFun"><span class="hs-identifier hs-var">alwaysBindFun</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668408"><span class="hs-identifier hs-var">commonlhs1</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668409"><span class="hs-identifier hs-var">commonlhs2</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-583"></span><span>      </span><span class="hs-comment">-- Here we need the cab_tvs of the two branches to be disinct.</span><span>
</span><span id="line-584"></span><span>      </span><span class="hs-comment">-- See Note [CoAxBranch type variables] in GHC.Core.Coercion.Axiom.</span><span>
</span><span id="line-585"></span><span>      </span><span class="annot"><span class="annottext">UnifyResult
</span><a href="GHC.Core.Unify.html#SurelyApart"><span class="hs-identifier hs-var">SurelyApart</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-586"></span><span>      </span><span class="annot"><a href="GHC.Core.Unify.html#MaybeApart"><span class="hs-identifier hs-type">MaybeApart</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-587"></span><span>      </span><span class="annot"><a href="GHC.Core.Unify.html#Unifiable"><span class="hs-identifier hs-type">Unifiable</span></a></span><span> </span><span id="local-6989586621682668413"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682668413"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Type -&gt; Type
Subst -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Subst.html#substTyAddInScope"><span class="hs-identifier hs-var">Type.substTyAddInScope</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682668413"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668403"><span class="hs-identifier hs-var">rhs1</span></a></span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Type -&gt; Type -&gt; Bool
Type -&gt; Type -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#eqType"><span class="hs-operator hs-var">`eqType`</span></a></span><span>
</span><span id="line-588"></span><span>                         </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Type -&gt; Type
Subst -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Subst.html#substTyAddInScope"><span class="hs-identifier hs-var">Type.substTyAddInScope</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682668413"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668405"><span class="hs-identifier hs-var">rhs2</span></a></span><span>
</span><span id="line-589"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-590"></span><span>     </span><span class="hs-special">(</span><span id="local-6989586621682668408"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668408"><span class="hs-identifier hs-var">commonlhs1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682668409"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668409"><span class="hs-identifier hs-var">commonlhs2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; [Type] -&gt; ([Type], [Type])
forall a b. [a] -&gt; [b] -&gt; ([a], [b])
</span><a href="GHC.Utils.Misc.html#zipAndUnzip"><span class="hs-identifier hs-var">zipAndUnzip</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668402"><span class="hs-identifier hs-var">lhs1</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668404"><span class="hs-identifier hs-var">lhs2</span></a></span><span>
</span><span id="line-591"></span><span>     </span><span class="hs-comment">-- See Note [Compatibility of eta-reduced axioms]</span><span>
</span><span id="line-592"></span><span>
</span><span id="line-593"></span><span class="annot"><span class="hs-comment">-- | Result of testing two type family equations for injectiviy.</span></span><span>
</span><span id="line-594"></span><span class="hs-keyword">data</span><span> </span><span id="InjectivityCheckResult"><span class="annot"><a href="GHC.Core.FamInstEnv.html#InjectivityCheckResult"><span class="hs-identifier hs-var">InjectivityCheckResult</span></a></span></span><span>
</span><span id="line-595"></span><span>   </span><span class="hs-glyph">=</span><span> </span><span id="InjectivityAccepted"><span class="annot"><a href="GHC.Core.FamInstEnv.html#InjectivityAccepted"><span class="hs-identifier hs-var">InjectivityAccepted</span></a></span></span><span>
</span><span id="line-596"></span><span>    </span><span class="hs-comment">-- ^ Either RHSs are distinct or unification of RHSs leads to unification of</span><span>
</span><span id="line-597"></span><span>    </span><span class="hs-comment">-- LHSs</span><span>
</span><span id="line-598"></span><span>   </span><span class="hs-glyph">|</span><span> </span><span id="InjectivityUnified"><span class="annot"><a href="GHC.Core.FamInstEnv.html#InjectivityUnified"><span class="hs-identifier hs-var">InjectivityUnified</span></a></span></span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span>
</span><span id="line-599"></span><span>    </span><span class="hs-comment">-- ^ RHSs unify but LHSs don't unify under that substitution.  Relevant for</span><span>
</span><span id="line-600"></span><span>    </span><span class="hs-comment">-- closed type families where equation after unification might be</span><span>
</span><span id="line-601"></span><span>    </span><span class="hs-comment">-- overlapped (in which case it is OK if they don't unify).  Constructor</span><span>
</span><span id="line-602"></span><span>    </span><span class="hs-comment">-- stores axioms after unification.</span><span>
</span><span id="line-603"></span><span>
</span><span id="line-604"></span><span class="annot"><span class="hs-comment">-- | Check whether two type family axioms don't violate injectivity annotation.</span></span><span>
</span><span id="line-605"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#injectiveBranches"><span class="hs-identifier hs-type">injectiveBranches</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span>
</span><span id="line-606"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#InjectivityCheckResult"><span class="hs-identifier hs-type">InjectivityCheckResult</span></a></span><span>
</span><span id="line-607"></span><span id="injectiveBranches"><span class="annot"><span class="annottext">injectiveBranches :: [Bool] -&gt; CoAxBranch -&gt; CoAxBranch -&gt; InjectivityCheckResult
</span><a href="GHC.Core.FamInstEnv.html#injectiveBranches"><span class="hs-identifier hs-var hs-var">injectiveBranches</span></a></span></span><span> </span><span id="local-6989586621682668418"><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621682668418"><span class="hs-identifier hs-var">injectivity</span></a></span></span><span>
</span><span id="line-608"></span><span>                  </span><span id="local-6989586621682668419"><span class="annot"><span class="annottext">ax1 :: CoAxBranch
</span><a href="#local-6989586621682668419"><span class="hs-identifier hs-var">ax1</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cab_tvs :: CoAxBranch -&gt; [TyVar]
</span><a href="GHC.Core.Coercion.Axiom.html#cab_tvs"><span class="hs-identifier hs-var">cab_tvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668420"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668420"><span class="hs-identifier hs-var">tvs1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cab_lhs :: CoAxBranch -&gt; [Type]
</span><a href="GHC.Core.Coercion.Axiom.html#cab_lhs"><span class="hs-identifier hs-var">cab_lhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668421"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668421"><span class="hs-identifier hs-var">lhs1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cab_rhs :: CoAxBranch -&gt; Type
</span><a href="GHC.Core.Coercion.Axiom.html#cab_rhs"><span class="hs-identifier hs-var">cab_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668422"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668422"><span class="hs-identifier hs-var">rhs1</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-609"></span><span>                  </span><span id="local-6989586621682668423"><span class="annot"><span class="annottext">ax2 :: CoAxBranch
</span><a href="#local-6989586621682668423"><span class="hs-identifier hs-var">ax2</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cab_tvs :: CoAxBranch -&gt; [TyVar]
</span><a href="GHC.Core.Coercion.Axiom.html#cab_tvs"><span class="hs-identifier hs-var">cab_tvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668424"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668424"><span class="hs-identifier hs-var">tvs2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cab_lhs :: CoAxBranch -&gt; [Type]
</span><a href="GHC.Core.Coercion.Axiom.html#cab_lhs"><span class="hs-identifier hs-var">cab_lhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668425"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668425"><span class="hs-identifier hs-var">lhs2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cab_rhs :: CoAxBranch -&gt; Type
</span><a href="GHC.Core.Coercion.Axiom.html#cab_rhs"><span class="hs-identifier hs-var">cab_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668426"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668426"><span class="hs-identifier hs-var">rhs2</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-610"></span><span>  </span><span class="hs-comment">-- See Note [Verifying injectivity annotation], case 1.</span><span>
</span><span id="line-611"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682668427"><span class="annot"><span class="annottext">getInjArgs :: [Type] -&gt; [Type]
</span><a href="#local-6989586621682668427"><span class="hs-identifier hs-var hs-var">getInjArgs</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Bool] -&gt; [Type] -&gt; [Type]
forall a. [Bool] -&gt; [a] -&gt; [a]
</span><a href="GHC.Utils.Misc.html#filterByList"><span class="hs-identifier hs-var">filterByList</span></a></span><span> </span><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621682668418"><span class="hs-identifier hs-var">injectivity</span></a></span><span>
</span><span id="line-612"></span><span>        </span><span id="local-6989586621682668429"><span class="annot"><span class="annottext">in_scope :: InScopeSet
</span><a href="#local-6989586621682668429"><span class="hs-identifier hs-var hs-var">in_scope</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#mkInScopeSetList"><span class="hs-identifier hs-var">mkInScopeSetList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668420"><span class="hs-identifier hs-var">tvs1</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; [TyVar] -&gt; [TyVar]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668424"><span class="hs-identifier hs-var">tvs2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-613"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; InScopeSet -&gt; Type -&gt; Type -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tcUnifyTyWithTFs"><span class="hs-identifier hs-var">tcUnifyTyWithTFs</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682668429"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668422"><span class="hs-identifier hs-var">rhs1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668426"><span class="hs-identifier hs-var">rhs2</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-comment">-- True = two-way pre-unification</span><span>
</span><span id="line-614"></span><span>       </span><span class="annot"><span class="annottext">Maybe Subst
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InjectivityCheckResult
</span><a href="GHC.Core.FamInstEnv.html#InjectivityAccepted"><span class="hs-identifier hs-var">InjectivityAccepted</span></a></span><span>
</span><span id="line-615"></span><span>         </span><span class="hs-comment">-- RHS are different, so equations are injective.</span><span>
</span><span id="line-616"></span><span>         </span><span class="hs-comment">-- This is case 1A from Note [Verifying injectivity annotation]</span><span>
</span><span id="line-617"></span><span>
</span><span id="line-618"></span><span>       </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682668432"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682668432"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-comment">-- RHS unify under a substitution</span><span>
</span><span id="line-619"></span><span>          </span><span class="hs-comment">-- If LHSs are equal under the substitution used for RHSs then this pair</span><span>
</span><span id="line-620"></span><span>          </span><span class="hs-comment">-- of equations does not violate injectivity annotation. If LHSs are not</span><span>
</span><span id="line-621"></span><span>          </span><span class="hs-comment">-- equal under that substitution then this pair of equations violates</span><span>
</span><span id="line-622"></span><span>          </span><span class="hs-comment">-- injectivity annotation, but for closed type families it still might</span><span>
</span><span id="line-623"></span><span>          </span><span class="hs-comment">-- be the case that one LHS after substitution is unreachable.</span><span>
</span><span id="line-624"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; [Type] -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#eqTypes"><span class="hs-identifier hs-var">eqTypes</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668433"><span class="hs-identifier hs-var">lhs1Subst</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668434"><span class="hs-identifier hs-var">lhs2Subst</span></a></span><span>  </span><span class="hs-comment">-- check case 1B1 from Note.</span><span>
</span><span id="line-625"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InjectivityCheckResult
</span><a href="GHC.Core.FamInstEnv.html#InjectivityAccepted"><span class="hs-identifier hs-var">InjectivityAccepted</span></a></span><span>
</span><span id="line-626"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-627"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CoAxBranch -&gt; CoAxBranch -&gt; InjectivityCheckResult
</span><a href="GHC.Core.FamInstEnv.html#InjectivityUnified"><span class="hs-identifier hs-var">InjectivityUnified</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621682668419"><span class="hs-identifier hs-var">ax1</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#cab_lhs"><span class="hs-identifier hs-var">cab_lhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#substTys"><span class="hs-identifier hs-type">Type.substTys</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668432"><span class="hs-identifier hs-type">subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668421"><span class="hs-identifier hs-type">lhs1</span></a></span><span>
</span><span id="line-628"></span><span>                                      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#cab_rhs"><span class="hs-identifier hs-var">cab_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#substTy"><span class="hs-identifier hs-type">Type.substTy</span></a></span><span>  </span><span class="annot"><a href="#local-6989586621682668432"><span class="hs-identifier hs-type">subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668422"><span class="hs-identifier hs-type">rhs1</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-629"></span><span>                                </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621682668423"><span class="hs-identifier hs-var">ax2</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#cab_lhs"><span class="hs-identifier hs-var">cab_lhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#substTys"><span class="hs-identifier hs-type">Type.substTys</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668432"><span class="hs-identifier hs-type">subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668425"><span class="hs-identifier hs-type">lhs2</span></a></span><span>
</span><span id="line-630"></span><span>                                      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#cab_rhs"><span class="hs-identifier hs-var">cab_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#substTy"><span class="hs-identifier hs-type">Type.substTy</span></a></span><span>  </span><span class="annot"><a href="#local-6989586621682668432"><span class="hs-identifier hs-type">subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668426"><span class="hs-identifier hs-type">rhs2</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-631"></span><span>                  </span><span class="hs-comment">-- Payload of InjectivityUnified used only for check 1B2, only</span><span>
</span><span id="line-632"></span><span>                  </span><span class="hs-comment">-- for closed type families</span><span>
</span><span id="line-633"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-634"></span><span>          </span><span id="local-6989586621682668433"><span class="annot"><span class="annottext">lhs1Subst :: [Type]
</span><a href="#local-6989586621682668433"><span class="hs-identifier hs-var hs-var">lhs1Subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; [Type] -&gt; [Type]
Subst -&gt; [Type] -&gt; [Type]
</span><a href="GHC.Core.TyCo.Subst.html#substTys"><span class="hs-identifier hs-var">Type.substTys</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682668432"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type] -&gt; [Type]
</span><a href="#local-6989586621682668427"><span class="hs-identifier hs-var">getInjArgs</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668421"><span class="hs-identifier hs-var">lhs1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-635"></span><span>          </span><span id="local-6989586621682668434"><span class="annot"><span class="annottext">lhs2Subst :: [Type]
</span><a href="#local-6989586621682668434"><span class="hs-identifier hs-var hs-var">lhs2Subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; [Type] -&gt; [Type]
Subst -&gt; [Type] -&gt; [Type]
</span><a href="GHC.Core.TyCo.Subst.html#substTys"><span class="hs-identifier hs-var">Type.substTys</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682668432"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type] -&gt; [Type]
</span><a href="#local-6989586621682668427"><span class="hs-identifier hs-var">getInjArgs</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668425"><span class="hs-identifier hs-var">lhs2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-636"></span><span>
</span><span id="line-637"></span><span class="hs-comment">-- takes a CoAxiom with unknown branch incompatibilities and computes</span><span>
</span><span id="line-638"></span><span class="hs-comment">-- the compatibilities</span><span>
</span><span id="line-639"></span><span class="hs-comment">-- See Note [Storing compatibility] in GHC.Core.Coercion.Axiom</span><span>
</span><span id="line-640"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#computeAxiomIncomps"><span class="hs-identifier hs-type">computeAxiomIncomps</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-641"></span><span id="computeAxiomIncomps"><span class="annot"><span class="annottext">computeAxiomIncomps :: [CoAxBranch] -&gt; [CoAxBranch]
</span><a href="GHC.Core.FamInstEnv.html#computeAxiomIncomps"><span class="hs-identifier hs-var hs-var">computeAxiomIncomps</span></a></span></span><span> </span><span id="local-6989586621682668438"><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="#local-6989586621682668438"><span class="hs-identifier hs-var">branches</span></a></span></span><span>
</span><span id="line-642"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([CoAxBranch], [CoAxBranch]) -&gt; [CoAxBranch]
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([CoAxBranch] -&gt; CoAxBranch -&gt; ([CoAxBranch], CoAxBranch))
-&gt; [CoAxBranch] -&gt; [CoAxBranch] -&gt; ([CoAxBranch], [CoAxBranch])
forall (t :: * -&gt; *) s a b.
Traversable t =&gt;
(s -&gt; a -&gt; (s, b)) -&gt; s -&gt; t a -&gt; (s, t b)
</span><span class="hs-identifier hs-var">mapAccumL</span></span><span> </span><span class="annot"><span class="annottext">[CoAxBranch] -&gt; CoAxBranch -&gt; ([CoAxBranch], CoAxBranch)
</span><a href="#local-6989586621682668440"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="#local-6989586621682668438"><span class="hs-identifier hs-var">branches</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-643"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-644"></span><span>    </span><span class="annot"><a href="#local-6989586621682668440"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-645"></span><span>    </span><span id="local-6989586621682668440"><span class="annot"><span class="annottext">go :: [CoAxBranch] -&gt; CoAxBranch -&gt; ([CoAxBranch], CoAxBranch)
</span><a href="#local-6989586621682668440"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621682668441"><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="#local-6989586621682668441"><span class="hs-identifier hs-var">prev_brs</span></a></span></span><span> </span><span id="local-6989586621682668442"><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621682668442"><span class="hs-identifier hs-var">cur_br</span></a></span></span><span>
</span><span id="line-646"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621682668443"><span class="hs-identifier hs-var">new_br</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxBranch -&gt; [CoAxBranch] -&gt; [CoAxBranch]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="#local-6989586621682668441"><span class="hs-identifier hs-var">prev_brs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621682668443"><span class="hs-identifier hs-var">new_br</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-647"></span><span>       </span><span class="hs-keyword">where</span><span>
</span><span id="line-648"></span><span>         </span><span id="local-6989586621682668443"><span class="annot"><span class="annottext">new_br :: CoAxBranch
</span><a href="#local-6989586621682668443"><span class="hs-identifier hs-var hs-var">new_br</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621682668442"><span class="hs-identifier hs-var">cur_br</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#cab_incomps"><span class="hs-identifier hs-var">cab_incomps</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682668445"><span class="hs-identifier hs-type">mk_incomps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668441"><span class="hs-identifier hs-type">prev_brs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668442"><span class="hs-identifier hs-type">cur_br</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-649"></span><span>
</span><span id="line-650"></span><span>    </span><span class="annot"><a href="#local-6989586621682668445"><span class="hs-identifier hs-type">mk_incomps</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-651"></span><span>    </span><span id="local-6989586621682668445"><span class="annot"><span class="annottext">mk_incomps :: [CoAxBranch] -&gt; CoAxBranch -&gt; [CoAxBranch]
</span><a href="#local-6989586621682668445"><span class="hs-identifier hs-var hs-var">mk_incomps</span></a></span></span><span> </span><span id="local-6989586621682668446"><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="#local-6989586621682668446"><span class="hs-identifier hs-var">prev_brs</span></a></span></span><span> </span><span id="local-6989586621682668447"><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621682668447"><span class="hs-identifier hs-var">cur_br</span></a></span></span><span>
</span><span id="line-652"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoAxBranch -&gt; Bool) -&gt; [CoAxBranch] -&gt; [CoAxBranch]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; (CoAxBranch -&gt; Bool) -&gt; CoAxBranch -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">CoAxBranch -&gt; CoAxBranch -&gt; Bool
</span><a href="GHC.Core.FamInstEnv.html#compatibleBranches"><span class="hs-identifier hs-var">compatibleBranches</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621682668447"><span class="hs-identifier hs-var">cur_br</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="#local-6989586621682668446"><span class="hs-identifier hs-var">prev_brs</span></a></span><span>
</span><span id="line-653"></span><span>
</span><span id="line-654"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
           Constructing axioms
    These functions are here because tidyType / tcUnifyTysFG
    are not available in GHC.Core.Coercion.Axiom

    Also computeAxiomIncomps is too sophisticated for CoAxiom
*                                                                      *
************************************************************************

Note [Tidy axioms when we build them]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Like types and classes, we build axioms fully quantified over all
their variables, and tidy them when we build them. For example,
we print out axioms and don't want to print stuff like
    F k k a b = ...
Instead we must tidy those kind variables.  See #7524.

We could instead tidy when we print, but that makes it harder to get
things like injectivity errors to come out right. Danger of
     Type family equation violates injectivity annotation.
     Kind variable &#8216;k&#8217; cannot be inferred from the right-hand side.
     In the type family equation:
        PolyKindVars @[k1] @[k2] ('[] @k1) = '[] @k2

Note [Always number wildcard types in CoAxBranch]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider the following example (from the DataFamilyInstanceLHS test case):

  data family Sing (a :: k)
  data instance Sing (_ :: MyKind) where
      SingA :: Sing A
      SingB :: Sing B

If we're not careful during tidying, then when this program is compiled with
-ddump-types, we'll get the following information:

  COERCION AXIOMS
    axiom DataFamilyInstanceLHS.D:R:SingMyKind_0 ::
      Sing _ = DataFamilyInstanceLHS.R:SingMyKind_ _

It's misleading to have a wildcard type appearing on the RHS like
that. To avoid this issue, when building a CoAxiom (which is what eventually
gets printed above), we tidy all the variables in an env that already contains
'_'. Thus, any variable named '_' will be renamed, giving us the nicer output
here:

  COERCION AXIOMS
    axiom DataFamilyInstanceLHS.D:R:SingMyKind_0 ::
      Sing _1 = DataFamilyInstanceLHS.R:SingMyKind_ _1

Which is at least legal syntax.

See also Note [CoAxBranch type variables] in GHC.Core.Coercion.Axiom; note that we
are tidying (changing OccNames only), not freshening, in accordance with
that Note.
-}</span><span>
</span><span id="line-712"></span><span>
</span><span id="line-713"></span><span class="hs-comment">-- all axiom roles are Nominal, as this is only used with type families</span><span>
</span><span id="line-714"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#mkCoAxBranch"><span class="hs-identifier hs-type">mkCoAxBranch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- original, possibly stale, tyvars</span><span>
</span><span id="line-715"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- Extra eta tyvars</span><span>
</span><span id="line-716"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- possibly stale covars</span><span>
</span><span id="line-717"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- LHS patterns</span><span>
</span><span id="line-718"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>    </span><span class="hs-comment">-- RHS</span><span>
</span><span id="line-719"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-720"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html#SrcSpan"><span class="hs-identifier hs-type">SrcSpan</span></a></span><span>
</span><span id="line-721"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span>
</span><span id="line-722"></span><span id="mkCoAxBranch"><span class="annot"><span class="annottext">mkCoAxBranch :: [TyVar]
-&gt; [TyVar]
-&gt; [TyVar]
-&gt; [Type]
-&gt; Type
-&gt; [Role]
-&gt; SrcSpan
-&gt; CoAxBranch
</span><a href="GHC.Core.FamInstEnv.html#mkCoAxBranch"><span class="hs-identifier hs-var hs-var">mkCoAxBranch</span></a></span></span><span> </span><span id="local-6989586621682668449"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668449"><span class="hs-identifier hs-var">tvs</span></a></span></span><span> </span><span id="local-6989586621682668450"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668450"><span class="hs-identifier hs-var">eta_tvs</span></a></span></span><span> </span><span id="local-6989586621682668451"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668451"><span class="hs-identifier hs-var">cvs</span></a></span></span><span> </span><span id="local-6989586621682668452"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668452"><span class="hs-identifier hs-var">lhs</span></a></span></span><span> </span><span id="local-6989586621682668453"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668453"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span id="local-6989586621682668454"><span class="annot"><span class="annottext">[Role]
</span><a href="#local-6989586621682668454"><span class="hs-identifier hs-var">roles</span></a></span></span><span> </span><span id="local-6989586621682668455"><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621682668455"><span class="hs-identifier hs-var">loc</span></a></span></span><span>
</span><span id="line-723"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cab_tvs :: [TyVar]
</span><a href="GHC.Core.Coercion.Axiom.html#cab_tvs"><span class="hs-identifier hs-var">cab_tvs</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668456"><span class="hs-identifier hs-var">tvs'</span></a></span><span>
</span><span id="line-724"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cab_eta_tvs :: [TyVar]
</span><a href="GHC.Core.Coercion.Axiom.html#cab_eta_tvs"><span class="hs-identifier hs-var">cab_eta_tvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668458"><span class="hs-identifier hs-var">eta_tvs'</span></a></span><span>
</span><span id="line-725"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cab_cvs :: [TyVar]
</span><a href="GHC.Core.Coercion.Axiom.html#cab_cvs"><span class="hs-identifier hs-var">cab_cvs</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668459"><span class="hs-identifier hs-var">cvs'</span></a></span><span>
</span><span id="line-726"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cab_lhs :: [Type]
</span><a href="GHC.Core.Coercion.Axiom.html#cab_lhs"><span class="hs-identifier hs-var">cab_lhs</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TidyEnv -&gt; [Type] -&gt; [Type]
</span><a href="GHC.Core.TyCo.Tidy.html#tidyTypes"><span class="hs-identifier hs-var">tidyTypes</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621682668461"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668452"><span class="hs-identifier hs-var">lhs</span></a></span><span>
</span><span id="line-727"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cab_roles :: [Role]
</span><a href="GHC.Core.Coercion.Axiom.html#cab_roles"><span class="hs-identifier hs-var">cab_roles</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Role]
</span><a href="#local-6989586621682668454"><span class="hs-identifier hs-var">roles</span></a></span><span>
</span><span id="line-728"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cab_rhs :: Type
</span><a href="GHC.Core.Coercion.Axiom.html#cab_rhs"><span class="hs-identifier hs-var">cab_rhs</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TidyEnv -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Tidy.html#tidyType"><span class="hs-identifier hs-var">tidyType</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621682668461"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668453"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-729"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cab_loc :: SrcSpan
</span><a href="GHC.Core.Coercion.Axiom.html#cab_loc"><span class="hs-identifier hs-var">cab_loc</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621682668455"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-730"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cab_incomps :: [CoAxBranch]
</span><a href="GHC.Core.Coercion.Axiom.html#cab_incomps"><span class="hs-identifier hs-var">cab_incomps</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="GHC.Core.Coercion.Axiom.html#placeHolderIncomps"><span class="hs-identifier hs-var">placeHolderIncomps</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-731"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-732"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682668466"><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621682668466"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682668456"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668456"><span class="hs-identifier hs-var">tvs'</span></a></span></span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TidyEnv -&gt; [TyVar] -&gt; (TidyEnv, [TyVar])
</span><a href="GHC.Core.TyCo.Tidy.html#tidyVarBndrs"><span class="hs-identifier hs-var">tidyVarBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621682668468"><span class="hs-identifier hs-var">init_tidy_env</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668449"><span class="hs-identifier hs-var">tvs</span></a></span><span>
</span><span id="line-733"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682668469"><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621682668469"><span class="hs-identifier hs-var">env2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682668458"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668458"><span class="hs-identifier hs-var">eta_tvs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TidyEnv -&gt; [TyVar] -&gt; (TidyEnv, [TyVar])
</span><a href="GHC.Core.TyCo.Tidy.html#tidyVarBndrs"><span class="hs-identifier hs-var">tidyVarBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621682668466"><span class="hs-identifier hs-var">env1</span></a></span><span>          </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668450"><span class="hs-identifier hs-var">eta_tvs</span></a></span><span>
</span><span id="line-734"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682668461"><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621682668461"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">,</span><span>  </span><span id="local-6989586621682668459"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668459"><span class="hs-identifier hs-var">cvs'</span></a></span></span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TidyEnv -&gt; [TyVar] -&gt; (TidyEnv, [TyVar])
</span><a href="GHC.Core.TyCo.Tidy.html#tidyVarBndrs"><span class="hs-identifier hs-var">tidyVarBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621682668469"><span class="hs-identifier hs-var">env2</span></a></span><span>          </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668451"><span class="hs-identifier hs-var">cvs</span></a></span><span>
</span><span id="line-735"></span><span>    </span><span class="hs-comment">-- See Note [Tidy axioms when we build them]</span><span>
</span><span id="line-736"></span><span>    </span><span class="hs-comment">-- See also Note [CoAxBranch type variables] in GHC.Core.Coercion.Axiom</span><span>
</span><span id="line-737"></span><span>
</span><span id="line-738"></span><span>    </span><span id="local-6989586621682668470"><span class="annot"><span class="annottext">init_occ_env :: TidyOccEnv
</span><a href="#local-6989586621682668470"><span class="hs-identifier hs-var hs-var">init_occ_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[OccName] -&gt; TidyOccEnv
</span><a href="GHC.Types.Name.Occurrence.html#initTidyOccEnv"><span class="hs-identifier hs-var">initTidyOccEnv</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">FastString -&gt; OccName
</span><a href="GHC.Types.Name.Occurrence.html#mkTyVarOccFS"><span class="hs-identifier hs-var">mkTyVarOccFS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; FastString
</span><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_&quot;</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-739"></span><span>    </span><span id="local-6989586621682668468"><span class="annot"><span class="annottext">init_tidy_env :: TidyEnv
</span><a href="#local-6989586621682668468"><span class="hs-identifier hs-var hs-var">init_tidy_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TidyOccEnv -&gt; TidyEnv
</span><a href="GHC.Types.Var.Env.html#mkEmptyTidyEnv"><span class="hs-identifier hs-var">mkEmptyTidyEnv</span></a></span><span> </span><span class="annot"><span class="annottext">TidyOccEnv
</span><a href="#local-6989586621682668470"><span class="hs-identifier hs-var">init_occ_env</span></a></span><span>
</span><span id="line-740"></span><span>    </span><span class="hs-comment">-- See Note [Always number wildcard types in CoAxBranch]</span><span>
</span><span id="line-741"></span><span>
</span><span id="line-742"></span><span class="hs-comment">-- all of the following code is here to avoid mutual dependencies with</span><span>
</span><span id="line-743"></span><span class="hs-comment">-- Coercion</span><span>
</span><span id="line-744"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#mkBranchedCoAxiom"><span class="hs-identifier hs-type">mkBranchedCoAxiom</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#Branched"><span class="hs-identifier hs-type">Branched</span></a></span><span>
</span><span id="line-745"></span><span id="mkBranchedCoAxiom"><span class="annot"><span class="annottext">mkBranchedCoAxiom :: Name -&gt; TyCon -&gt; [CoAxBranch] -&gt; CoAxiom Branched
</span><a href="GHC.Core.FamInstEnv.html#mkBranchedCoAxiom"><span class="hs-identifier hs-var hs-var">mkBranchedCoAxiom</span></a></span></span><span> </span><span id="local-6989586621682668475"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682668475"><span class="hs-identifier hs-var">ax_name</span></a></span></span><span> </span><span id="local-6989586621682668476"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668476"><span class="hs-identifier hs-var">fam_tc</span></a></span></span><span> </span><span id="local-6989586621682668477"><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="#local-6989586621682668477"><span class="hs-identifier hs-var">branches</span></a></span></span><span>
</span><span id="line-746"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">co_ax_unique :: Unique
</span><a href="GHC.Core.Coercion.Axiom.html#co_ax_unique"><span class="hs-identifier hs-var">co_ax_unique</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Unique
</span><a href="GHC.Types.Name.html#nameUnique"><span class="hs-identifier hs-var">nameUnique</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682668475"><span class="hs-identifier hs-var">ax_name</span></a></span><span>
</span><span id="line-747"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">co_ax_name :: Name
</span><a href="GHC.Core.Coercion.Axiom.html#co_ax_name"><span class="hs-identifier hs-var">co_ax_name</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682668475"><span class="hs-identifier hs-var">ax_name</span></a></span><span>
</span><span id="line-748"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">co_ax_tc :: TyCon
</span><a href="GHC.Core.Coercion.Axiom.html#co_ax_tc"><span class="hs-identifier hs-var">co_ax_tc</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668476"><span class="hs-identifier hs-var">fam_tc</span></a></span><span>
</span><span id="line-749"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">co_ax_role :: Role
</span><a href="GHC.Core.Coercion.Axiom.html#co_ax_role"><span class="hs-identifier hs-var">co_ax_role</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span>
</span><span id="line-750"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">co_ax_implicit :: Bool
</span><a href="GHC.Core.Coercion.Axiom.html#co_ax_implicit"><span class="hs-identifier hs-var">co_ax_implicit</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-751"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">co_ax_branches :: Branches Branched
</span><a href="GHC.Core.Coercion.Axiom.html#co_ax_branches"><span class="hs-identifier hs-var">co_ax_branches</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CoAxBranch] -&gt; Branches Branched
</span><a href="GHC.Core.Coercion.Axiom.html#manyBranches"><span class="hs-identifier hs-var">manyBranches</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoAxBranch] -&gt; [CoAxBranch]
</span><a href="GHC.Core.FamInstEnv.html#computeAxiomIncomps"><span class="hs-identifier hs-var">computeAxiomIncomps</span></a></span><span> </span><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="#local-6989586621682668477"><span class="hs-identifier hs-var">branches</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-752"></span><span>
</span><span id="line-753"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#mkUnbranchedCoAxiom"><span class="hs-identifier hs-type">mkUnbranchedCoAxiom</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#Unbranched"><span class="hs-identifier hs-type">Unbranched</span></a></span><span>
</span><span id="line-754"></span><span id="mkUnbranchedCoAxiom"><span class="annot"><span class="annottext">mkUnbranchedCoAxiom :: Name -&gt; TyCon -&gt; CoAxBranch -&gt; CoAxiom Unbranched
</span><a href="GHC.Core.FamInstEnv.html#mkUnbranchedCoAxiom"><span class="hs-identifier hs-var hs-var">mkUnbranchedCoAxiom</span></a></span></span><span> </span><span id="local-6989586621682668488"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682668488"><span class="hs-identifier hs-var">ax_name</span></a></span></span><span> </span><span id="local-6989586621682668489"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668489"><span class="hs-identifier hs-var">fam_tc</span></a></span></span><span> </span><span id="local-6989586621682668490"><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621682668490"><span class="hs-identifier hs-var">branch</span></a></span></span><span>
</span><span id="line-755"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">co_ax_unique :: Unique
</span><a href="GHC.Core.Coercion.Axiom.html#co_ax_unique"><span class="hs-identifier hs-var">co_ax_unique</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Unique
</span><a href="GHC.Types.Name.html#nameUnique"><span class="hs-identifier hs-var">nameUnique</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682668488"><span class="hs-identifier hs-var">ax_name</span></a></span><span>
</span><span id="line-756"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">co_ax_name :: Name
</span><a href="GHC.Core.Coercion.Axiom.html#co_ax_name"><span class="hs-identifier hs-var">co_ax_name</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682668488"><span class="hs-identifier hs-var">ax_name</span></a></span><span>
</span><span id="line-757"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">co_ax_tc :: TyCon
</span><a href="GHC.Core.Coercion.Axiom.html#co_ax_tc"><span class="hs-identifier hs-var">co_ax_tc</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668489"><span class="hs-identifier hs-var">fam_tc</span></a></span><span>
</span><span id="line-758"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">co_ax_role :: Role
</span><a href="GHC.Core.Coercion.Axiom.html#co_ax_role"><span class="hs-identifier hs-var">co_ax_role</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span>
</span><span id="line-759"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">co_ax_implicit :: Bool
</span><a href="GHC.Core.Coercion.Axiom.html#co_ax_implicit"><span class="hs-identifier hs-var">co_ax_implicit</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-760"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">co_ax_branches :: Branches Unbranched
</span><a href="GHC.Core.Coercion.Axiom.html#co_ax_branches"><span class="hs-identifier hs-var">co_ax_branches</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoAxBranch -&gt; Branches Unbranched
</span><a href="GHC.Core.Coercion.Axiom.html#unbranched"><span class="hs-identifier hs-var">unbranched</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621682668490"><span class="hs-identifier hs-var">branch</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#cab_incomps"><span class="hs-identifier hs-var">cab_incomps</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-761"></span><span>
</span><span id="line-762"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#mkSingleCoAxiom"><span class="hs-identifier hs-type">mkSingleCoAxiom</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span>
</span><span id="line-763"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-764"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-765"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#Unbranched"><span class="hs-identifier hs-type">Unbranched</span></a></span><span>
</span><span id="line-766"></span><span class="hs-comment">-- Make a single-branch CoAxiom, including making the branch itself</span><span>
</span><span id="line-767"></span><span class="hs-comment">-- Used for both type family (Nominal) and data family (Representational)</span><span>
</span><span id="line-768"></span><span class="hs-comment">-- axioms, hence passing in the Role</span><span>
</span><span id="line-769"></span><span id="mkSingleCoAxiom"><span class="annot"><span class="annottext">mkSingleCoAxiom :: Role
-&gt; Name
-&gt; [TyVar]
-&gt; [TyVar]
-&gt; [TyVar]
-&gt; TyCon
-&gt; [Type]
-&gt; Type
-&gt; CoAxiom Unbranched
</span><a href="GHC.Core.FamInstEnv.html#mkSingleCoAxiom"><span class="hs-identifier hs-var hs-var">mkSingleCoAxiom</span></a></span></span><span> </span><span id="local-6989586621682668492"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682668492"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span id="local-6989586621682668493"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682668493"><span class="hs-identifier hs-var">ax_name</span></a></span></span><span> </span><span id="local-6989586621682668494"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668494"><span class="hs-identifier hs-var">tvs</span></a></span></span><span> </span><span id="local-6989586621682668495"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668495"><span class="hs-identifier hs-var">eta_tvs</span></a></span></span><span> </span><span id="local-6989586621682668496"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668496"><span class="hs-identifier hs-var">cvs</span></a></span></span><span> </span><span id="local-6989586621682668497"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668497"><span class="hs-identifier hs-var">fam_tc</span></a></span></span><span> </span><span id="local-6989586621682668498"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668498"><span class="hs-identifier hs-var">lhs_tys</span></a></span></span><span> </span><span id="local-6989586621682668499"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668499"><span class="hs-identifier hs-var">rhs_ty</span></a></span></span><span>
</span><span id="line-770"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">co_ax_unique :: Unique
</span><a href="GHC.Core.Coercion.Axiom.html#co_ax_unique"><span class="hs-identifier hs-var">co_ax_unique</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Unique
</span><a href="GHC.Types.Name.html#nameUnique"><span class="hs-identifier hs-var">nameUnique</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682668493"><span class="hs-identifier hs-var">ax_name</span></a></span><span>
</span><span id="line-771"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">co_ax_name :: Name
</span><a href="GHC.Core.Coercion.Axiom.html#co_ax_name"><span class="hs-identifier hs-var">co_ax_name</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682668493"><span class="hs-identifier hs-var">ax_name</span></a></span><span>
</span><span id="line-772"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">co_ax_tc :: TyCon
</span><a href="GHC.Core.Coercion.Axiom.html#co_ax_tc"><span class="hs-identifier hs-var">co_ax_tc</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668497"><span class="hs-identifier hs-var">fam_tc</span></a></span><span>
</span><span id="line-773"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">co_ax_role :: Role
</span><a href="GHC.Core.Coercion.Axiom.html#co_ax_role"><span class="hs-identifier hs-var">co_ax_role</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682668492"><span class="hs-keyword hs-var">role</span></a></span><span>
</span><span id="line-774"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">co_ax_implicit :: Bool
</span><a href="GHC.Core.Coercion.Axiom.html#co_ax_implicit"><span class="hs-identifier hs-var">co_ax_implicit</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-775"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">co_ax_branches :: Branches Unbranched
</span><a href="GHC.Core.Coercion.Axiom.html#co_ax_branches"><span class="hs-identifier hs-var">co_ax_branches</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoAxBranch -&gt; Branches Unbranched
</span><a href="GHC.Core.Coercion.Axiom.html#unbranched"><span class="hs-identifier hs-var">unbranched</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621682668500"><span class="hs-identifier hs-var">branch</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#cab_incomps"><span class="hs-identifier hs-var">cab_incomps</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-776"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-777"></span><span>    </span><span id="local-6989586621682668500"><span class="annot"><span class="annottext">branch :: CoAxBranch
</span><a href="#local-6989586621682668500"><span class="hs-identifier hs-var hs-var">branch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar]
-&gt; [TyVar]
-&gt; [TyVar]
-&gt; [Type]
-&gt; Type
-&gt; [Role]
-&gt; SrcSpan
-&gt; CoAxBranch
</span><a href="GHC.Core.FamInstEnv.html#mkCoAxBranch"><span class="hs-identifier hs-var">mkCoAxBranch</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668494"><span class="hs-identifier hs-var">tvs</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668495"><span class="hs-identifier hs-var">eta_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668496"><span class="hs-identifier hs-var">cvs</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668498"><span class="hs-identifier hs-var">lhs_tys</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668499"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span>
</span><span id="line-778"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TyVar -&gt; Role) -&gt; [TyVar] -&gt; [Role]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; TyVar -&gt; Role
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668494"><span class="hs-identifier hs-var">tvs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-779"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; SrcSpan
forall a. NamedThing a =&gt; a -&gt; SrcSpan
</span><a href="GHC.Types.Name.html#getSrcSpan"><span class="hs-identifier hs-var">getSrcSpan</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682668493"><span class="hs-identifier hs-var">ax_name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-780"></span><span>
</span><span id="line-781"></span><span class="hs-comment">-- | Create a coercion constructor (axiom) suitable for the given</span><span>
</span><span id="line-782"></span><span class="hs-comment">--   newtype 'TyCon'. The 'Name' should be that of a new coercion</span><span>
</span><span id="line-783"></span><span class="hs-comment">--   'CoAxiom', the 'TyVar's the arguments expected by the @newtype@ and</span><span>
</span><span id="line-784"></span><span class="hs-comment">--   the type the appropriate right hand side of the @newtype@, with</span><span>
</span><span id="line-785"></span><span class="hs-comment">--   the free variables a subset of those 'TyVar's.</span><span>
</span><span id="line-786"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#mkNewTypeCoAxiom"><span class="hs-identifier hs-type">mkNewTypeCoAxiom</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#Unbranched"><span class="hs-identifier hs-type">Unbranched</span></a></span><span>
</span><span id="line-787"></span><span id="mkNewTypeCoAxiom"><span class="annot"><span class="annottext">mkNewTypeCoAxiom :: Name -&gt; TyCon -&gt; [TyVar] -&gt; [Role] -&gt; Type -&gt; CoAxiom Unbranched
</span><a href="GHC.Core.FamInstEnv.html#mkNewTypeCoAxiom"><span class="hs-identifier hs-var hs-var">mkNewTypeCoAxiom</span></a></span></span><span> </span><span id="local-6989586621682668503"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682668503"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621682668504"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668504"><span class="hs-identifier hs-var">tycon</span></a></span></span><span> </span><span id="local-6989586621682668505"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668505"><span class="hs-identifier hs-var">tvs</span></a></span></span><span> </span><span id="local-6989586621682668506"><span class="annot"><span class="annottext">[Role]
</span><a href="#local-6989586621682668506"><span class="hs-identifier hs-var">roles</span></a></span></span><span> </span><span id="local-6989586621682668507"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668507"><span class="hs-identifier hs-var">rhs_ty</span></a></span></span><span>
</span><span id="line-788"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">co_ax_unique :: Unique
</span><a href="GHC.Core.Coercion.Axiom.html#co_ax_unique"><span class="hs-identifier hs-var">co_ax_unique</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Unique
</span><a href="GHC.Types.Name.html#nameUnique"><span class="hs-identifier hs-var">nameUnique</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682668503"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-789"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">co_ax_name :: Name
</span><a href="GHC.Core.Coercion.Axiom.html#co_ax_name"><span class="hs-identifier hs-var">co_ax_name</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682668503"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-790"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">co_ax_implicit :: Bool
</span><a href="GHC.Core.Coercion.Axiom.html#co_ax_implicit"><span class="hs-identifier hs-var">co_ax_implicit</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>  </span><span class="hs-comment">-- See Note [Implicit axioms] in GHC.Core.TyCon</span><span>
</span><span id="line-791"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">co_ax_role :: Role
</span><a href="GHC.Core.Coercion.Axiom.html#co_ax_role"><span class="hs-identifier hs-var">co_ax_role</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Representational"><span class="hs-identifier hs-var">Representational</span></a></span><span>
</span><span id="line-792"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">co_ax_tc :: TyCon
</span><a href="GHC.Core.Coercion.Axiom.html#co_ax_tc"><span class="hs-identifier hs-var">co_ax_tc</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668504"><span class="hs-identifier hs-var">tycon</span></a></span><span>
</span><span id="line-793"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">co_ax_branches :: Branches Unbranched
</span><a href="GHC.Core.Coercion.Axiom.html#co_ax_branches"><span class="hs-identifier hs-var">co_ax_branches</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoAxBranch -&gt; Branches Unbranched
</span><a href="GHC.Core.Coercion.Axiom.html#unbranched"><span class="hs-identifier hs-var">unbranched</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621682668509"><span class="hs-identifier hs-var">branch</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#cab_incomps"><span class="hs-identifier hs-var">cab_incomps</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-794"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-795"></span><span>    </span><span id="local-6989586621682668509"><span class="annot"><span class="annottext">branch :: CoAxBranch
</span><a href="#local-6989586621682668509"><span class="hs-identifier hs-var hs-var">branch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar]
-&gt; [TyVar]
-&gt; [TyVar]
-&gt; [Type]
-&gt; Type
-&gt; [Role]
-&gt; SrcSpan
-&gt; CoAxBranch
</span><a href="GHC.Core.FamInstEnv.html#mkCoAxBranch"><span class="hs-identifier hs-var">mkCoAxBranch</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668505"><span class="hs-identifier hs-var">tvs</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TyVar] -&gt; [Type]
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTys"><span class="hs-identifier hs-var">mkTyVarTys</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668505"><span class="hs-identifier hs-var">tvs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668507"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span>
</span><span id="line-796"></span><span>                          </span><span class="annot"><span class="annottext">[Role]
</span><a href="#local-6989586621682668506"><span class="hs-identifier hs-var">roles</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; SrcSpan
forall a. NamedThing a =&gt; a -&gt; SrcSpan
</span><a href="GHC.Types.Name.html#getSrcSpan"><span class="hs-identifier hs-var">getSrcSpan</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682668503"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-797"></span><span>
</span><span id="line-798"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Looking up a family instance
*                                                                      *
************************************************************************

@lookupFamInstEnv@ looks up in a @FamInstEnv@, using a one-way match.
Multiple matches are only possible in case of type families (not data
families), and then, it doesn't matter which match we choose (as the
instances are guaranteed confluent).

We return the matching family instances and the type instance at which it
matches.  For example, if we lookup 'T [Int]' and have a family instance

  data instance T [a] = ..

desugared to

  data :R42T a = ..
  coe :Co:R42T a :: T [a] ~ :R42T a

we return the matching instance '(FamInst{.., fi_tycon = :R42T}, Int)'.
-}</span><span>
</span><span id="line-822"></span><span>
</span><span id="line-823"></span><span class="hs-comment">-- when matching a type family application, we get a FamInst,</span><span>
</span><span id="line-824"></span><span class="hs-comment">-- and the list of types the axiom should be applied to</span><span>
</span><span id="line-825"></span><span class="hs-keyword">data</span><span> </span><span id="FamInstMatch"><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstMatch"><span class="hs-identifier hs-var">FamInstMatch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="FamInstMatch"><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstMatch"><span class="hs-identifier hs-var">FamInstMatch</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="fim_instance"><span class="annot"><span class="annottext">FamInstMatch -&gt; FamInst
</span><a href="GHC.Core.FamInstEnv.html#fim_instance"><span class="hs-identifier hs-var hs-var">fim_instance</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span>
</span><span id="line-826"></span><span>                                 </span><span class="hs-special">,</span><span> </span><span id="fim_tys"><span class="annot"><span class="annottext">FamInstMatch -&gt; [Type]
</span><a href="GHC.Core.FamInstEnv.html#fim_tys"><span class="hs-identifier hs-var hs-var">fim_tys</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-827"></span><span>                                 </span><span class="hs-special">,</span><span> </span><span id="fim_cos"><span class="annot"><span class="annottext">FamInstMatch -&gt; [Coercion]
</span><a href="GHC.Core.FamInstEnv.html#fim_cos"><span class="hs-identifier hs-var hs-var">fim_cos</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-828"></span><span>                                 </span><span class="hs-special">}</span><span>
</span><span id="line-829"></span><span>  </span><span class="hs-comment">-- See Note [Over-saturated matches]</span><span>
</span><span id="line-830"></span><span>
</span><span id="line-831"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstMatch"><span class="hs-identifier hs-type">FamInstMatch</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-832"></span><span>  </span><span id="local-6989586621682668527"><span class="annot"><span class="annottext">ppr :: FamInstMatch -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstMatch"><span class="hs-identifier hs-type">FamInstMatch</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fim_instance :: FamInstMatch -&gt; FamInst
</span><a href="GHC.Core.FamInstEnv.html#fim_instance"><span class="hs-identifier hs-var">fim_instance</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668528"><span class="annot"><span class="annottext">FamInst
</span><a href="#local-6989586621682668528"><span class="hs-identifier hs-var">inst</span></a></span></span><span>
</span><span id="line-833"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fim_tys :: FamInstMatch -&gt; [Type]
</span><a href="GHC.Core.FamInstEnv.html#fim_tys"><span class="hs-identifier hs-var">fim_tys</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668529"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668529"><span class="hs-identifier hs-var">tys</span></a></span></span><span>
</span><span id="line-834"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fim_cos :: FamInstMatch -&gt; [Coercion]
</span><a href="GHC.Core.FamInstEnv.html#fim_cos"><span class="hs-identifier hs-var">fim_cos</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668530"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682668530"><span class="hs-identifier hs-var">cos</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-835"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;match with&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FamInst -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">FamInst
</span><a href="#local-6989586621682668528"><span class="hs-identifier hs-var">inst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668529"><span class="hs-identifier hs-var">tys</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682668530"><span class="hs-identifier hs-var">cos</span></a></span><span>
</span><span id="line-836"></span><span>
</span><span id="line-837"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#lookupFamInstEnvByTyCon"><span class="hs-identifier hs-type">lookupFamInstEnvByTyCon</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-838"></span><span id="lookupFamInstEnvByTyCon"><span class="annot"><span class="annottext">lookupFamInstEnvByTyCon :: (FamInstEnv, FamInstEnv) -&gt; TyCon -&gt; [FamInst]
</span><a href="GHC.Core.FamInstEnv.html#lookupFamInstEnvByTyCon"><span class="hs-identifier hs-var hs-var">lookupFamInstEnvByTyCon</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682668532"><span class="annot"><span class="annottext">FamInstEnv
</span><a href="#local-6989586621682668532"><span class="hs-identifier hs-var">pkg_ie</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682668533"><span class="annot"><span class="annottext">FamInstEnv
</span><a href="#local-6989586621682668533"><span class="hs-identifier hs-var">home_ie</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682668534"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668534"><span class="hs-identifier hs-var">fam_tc</span></a></span></span><span>
</span><span id="line-839"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FamInstEnv -&gt; [FamInst]
</span><a href="#local-6989586621682668535"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span class="annot"><span class="annottext">FamInstEnv
</span><a href="#local-6989586621682668532"><span class="hs-identifier hs-var">pkg_ie</span></a></span><span> </span><span class="annot"><span class="annottext">[FamInst] -&gt; [FamInst] -&gt; [FamInst]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">FamInstEnv -&gt; [FamInst]
</span><a href="#local-6989586621682668535"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span class="annot"><span class="annottext">FamInstEnv
</span><a href="#local-6989586621682668533"><span class="hs-identifier hs-var">home_ie</span></a></span><span>
</span><span id="line-840"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-841"></span><span>    </span><span id="local-6989586621682668535"><span class="annot"><span class="annottext">get :: FamInstEnv -&gt; [FamInst]
</span><a href="#local-6989586621682668535"><span class="hs-identifier hs-var hs-var">get</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamIE"><span class="hs-identifier hs-type">FamIE</span></a></span><span> </span><span class="annot"><span class="annottext">BranchIndex
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682668536"><span class="annot"><span class="annottext">RoughMap FamInst
</span><a href="#local-6989586621682668536"><span class="hs-identifier hs-var">rm</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[RoughMatchLookupTc] -&gt; RoughMap FamInst -&gt; [FamInst]
forall a. [RoughMatchLookupTc] -&gt; RoughMap a -&gt; [a]
</span><a href="GHC.Core.RoughMap.html#lookupRM"><span class="hs-identifier hs-var">lookupRM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Name -&gt; RoughMatchLookupTc
</span><a href="GHC.Core.RoughMap.html#RML_KnownTc"><span class="hs-identifier hs-var">RML_KnownTc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Name
</span><a href="GHC.Core.TyCon.html#tyConName"><span class="hs-identifier hs-var">tyConName</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668534"><span class="hs-identifier hs-var">fam_tc</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">RoughMap FamInst
</span><a href="#local-6989586621682668536"><span class="hs-identifier hs-var">rm</span></a></span><span>
</span><span id="line-842"></span><span>
</span><span id="line-843"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#lookupFamInstEnv"><span class="hs-identifier hs-type">lookupFamInstEnv</span></a></span><span>
</span><span id="line-844"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a></span><span>
</span><span id="line-845"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>          </span><span class="hs-comment">-- What we are looking for</span><span>
</span><span id="line-846"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstMatch"><span class="hs-identifier hs-type">FamInstMatch</span></a></span><span class="hs-special">]</span><span>           </span><span class="hs-comment">-- Successful matches</span><span>
</span><span id="line-847"></span><span class="hs-comment">-- Precondition: the tycon is saturated (or over-saturated)</span><span>
</span><span id="line-848"></span><span>
</span><span id="line-849"></span><span id="lookupFamInstEnv"><span class="annot"><span class="annottext">lookupFamInstEnv :: (FamInstEnv, FamInstEnv) -&gt; TyCon -&gt; [Type] -&gt; [FamInstMatch]
</span><a href="GHC.Core.FamInstEnv.html#lookupFamInstEnv"><span class="hs-identifier hs-var hs-var">lookupFamInstEnv</span></a></span></span><span>
</span><span id="line-850"></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FamInstLookupMode FamInstMatch
-&gt; (FamInstEnv, FamInstEnv) -&gt; TyCon -&gt; [Type] -&gt; [FamInstMatch]
forall a.
FamInstLookupMode a
-&gt; (FamInstEnv, FamInstEnv) -&gt; TyCon -&gt; [Type] -&gt; [a]
</span><a href="GHC.Core.FamInstEnv.html#lookup_fam_inst_env"><span class="hs-identifier hs-var">lookup_fam_inst_env</span></a></span><span> </span><span class="annot"><span class="annottext">FamInstLookupMode FamInstMatch
</span><a href="GHC.Core.FamInstEnv.html#WantMatches"><span class="hs-identifier hs-var">WantMatches</span></a></span><span>
</span><span id="line-851"></span><span>
</span><span id="line-852"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#lookupFamInstEnvConflicts"><span class="hs-identifier hs-type">lookupFamInstEnvConflicts</span></a></span><span>
</span><span id="line-853"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a></span><span>
</span><span id="line-854"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span>          </span><span class="hs-comment">-- Putative new instance</span><span>
</span><span id="line-855"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- Conflicting matches (don't look at the fim_tys field)</span><span>
</span><span id="line-856"></span><span class="hs-comment">-- E.g. when we are about to add</span><span>
</span><span id="line-857"></span><span class="hs-comment">--    f : type instance F [a] = a-&gt;a</span><span>
</span><span id="line-858"></span><span class="hs-comment">-- we do (lookupFamInstConflicts f [b])</span><span>
</span><span id="line-859"></span><span class="hs-comment">-- to find conflicting matches</span><span>
</span><span id="line-860"></span><span class="hs-comment">--</span><span>
</span><span id="line-861"></span><span class="hs-comment">-- Precondition: the tycon is saturated (or over-saturated)</span><span>
</span><span id="line-862"></span><span>
</span><span id="line-863"></span><span id="lookupFamInstEnvConflicts"><span class="annot"><span class="annottext">lookupFamInstEnvConflicts :: (FamInstEnv, FamInstEnv) -&gt; FamInst -&gt; [FamInst]
</span><a href="GHC.Core.FamInstEnv.html#lookupFamInstEnvConflicts"><span class="hs-identifier hs-var hs-var">lookupFamInstEnvConflicts</span></a></span></span><span> </span><span id="local-6989586621682668539"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621682668539"><span class="hs-identifier hs-var">envs</span></a></span></span><span> </span><span id="local-6989586621682668540"><span class="annot"><span class="annottext">FamInst
</span><a href="#local-6989586621682668540"><span class="hs-identifier hs-var">fam_inst</span></a></span></span><span>
</span><span id="line-864"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FamInstLookupMode FamInst
-&gt; (FamInstEnv, FamInstEnv) -&gt; TyCon -&gt; [Type] -&gt; [FamInst]
forall a.
FamInstLookupMode a
-&gt; (FamInstEnv, FamInstEnv) -&gt; TyCon -&gt; [Type] -&gt; [a]
</span><a href="GHC.Core.FamInstEnv.html#lookup_fam_inst_env"><span class="hs-identifier hs-var">lookup_fam_inst_env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FamInst -&gt; FamInstLookupMode FamInst
</span><a href="GHC.Core.FamInstEnv.html#WantConflicts"><span class="hs-identifier hs-var">WantConflicts</span></a></span><span> </span><span class="annot"><span class="annottext">FamInst
</span><a href="#local-6989586621682668540"><span class="hs-identifier hs-var">fam_inst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621682668539"><span class="hs-identifier hs-var">envs</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668542"><span class="hs-identifier hs-var">fam</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668543"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-865"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-866"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682668542"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668542"><span class="hs-identifier hs-var">fam</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682668543"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668543"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FamInst -&gt; (TyCon, [Type])
</span><a href="GHC.Core.FamInstEnv.html#famInstSplitLHS"><span class="hs-identifier hs-var">famInstSplitLHS</span></a></span><span> </span><span class="annot"><span class="annottext">FamInst
</span><a href="#local-6989586621682668540"><span class="hs-identifier hs-var">fam_inst</span></a></span><span>
</span><span id="line-867"></span><span>
</span><span id="line-868"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-869"></span><span class="hs-comment">--                 Type family injectivity checking bits                      --</span><span>
</span><span id="line-870"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-871"></span><span>
</span><span id="line-872"></span><span class="hs-comment">{- Note [Verifying injectivity annotation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Injectivity means that the RHS of a type family uniquely determines the LHS (see
Note [Type inference for type families with injectivity]).  The user informs us about
injectivity using an injectivity annotation and it is GHC's task to verify that
this annotation is correct w.r.t. type family equations. Whenever we see a new
equation of a type family we need to make sure that adding this equation to the
already known equations of a type family does not violate the injectivity annotation
supplied by the user (see Note [Injectivity annotation]).  Of course if the type
family has no injectivity annotation then no check is required.  But if a type
family has injectivity annotation we need to make sure that the following
conditions hold:

1. For each pair of *different* equations of a type family, one of the following
   conditions holds:

   A:  RHSs are different. (Check done in GHC.Core.FamInstEnv.injectiveBranches)

   B1: OPEN TYPE FAMILIES: If the RHSs can be unified under some substitution
       then it must be possible to unify the LHSs under the same substitution.
       Example:

          type family FunnyId a = r | r -&gt; a
          type instance FunnyId Int = Int
          type instance FunnyId a = a

       RHSs of these two equations unify under [ a |-&gt; Int ] substitution.
       Under this substitution LHSs are equal therefore these equations don't
       violate injectivity annotation. (Check done in GHC.Core.FamInstEnv.injectiveBranches)

   B2: CLOSED TYPE FAMILIES: If the RHSs can be unified under some
       substitution then either the LHSs unify under the same substitution or
       the LHS of the latter equation is overlapped by earlier equations.
       Example 1:

          type family SwapIntChar a = r | r -&gt; a where
              SwapIntChar Int  = Char
              SwapIntChar Char = Int
              SwapIntChar a    = a

       Say we are checking the last two equations. RHSs unify under [ a |-&gt;
       Int ] substitution but LHSs don't. So we apply the substitution to LHS
       of last equation and check whether it is overlapped by any of previous
       equations. Since it is overlapped by the first equation we conclude
       that pair of last two equations does not violate injectivity
       annotation. (Check done in GHC.Tc.Validity.checkValidCoAxiom#gather_conflicts)

   A special case of B is when RHSs unify with an empty substitution ie. they
   are identical.

   If any of the above two conditions holds we conclude that the pair of
   equations does not violate injectivity annotation. But if we find a pair
   of equations where neither of the above holds we report that this pair
   violates injectivity annotation because for a given RHS we don't have a
   unique LHS. (Note that (B) actually implies (A).)

   Note that we only take into account these LHS patterns that were declared
   as injective.

2. If an RHS of a type family equation is a bare type variable then
   all LHS variables (including implicit kind variables) also have to be bare.
   In other words, this has to be a sole equation of that type family and it has
   to cover all possible patterns.  So for example this definition will be
   rejected:

      type family W1 a = r | r -&gt; a
      type instance W1 [a] = a

   If it were accepted we could call `W1 [W1 Int]`, which would reduce to
   `W1 Int` and then by injectivity we could conclude that `[W1 Int] ~ Int`,
   which is bogus. Checked FamInst.bareTvInRHSViolated.

3. If the RHS of a type family equation is a type family application then the type
   family is rejected as not injective. This is checked by FamInst.isTFHeaded.

4. If a LHS type variable that is declared as injective is not mentioned in an
   injective position in the RHS then the type family is rejected as not
   injective.  &quot;Injective position&quot; means either an argument to a type
   constructor or argument to a type family on injective position.
   There are subtleties here. See Note [Coverage condition for injective type families]
   in GHC.Tc.Instance.Family.

Check (1) must be done for all family instances (transitively) imported. Other
checks (2-4) should be done just for locally written equations, as they are checks
involving just a single equation, not about interactions. Doing the other checks for
imported equations led to #17405, as the behavior of check (4) depends on
-XUndecidableInstances (see Note [Coverage condition for injective type families] in
FamInst), which may vary between modules.

See also Note [Injective type families] in GHC.Core.TyCon
-}</span><span>
</span><span id="line-963"></span><span>
</span><span id="line-964"></span><span>
</span><span id="line-965"></span><span class="hs-comment">-- | Check whether an open type family equation can be added to already existing</span><span>
</span><span id="line-966"></span><span class="hs-comment">-- instance environment without causing conflicts with supplied injectivity</span><span>
</span><span id="line-967"></span><span class="hs-comment">-- annotations.  Returns list of conflicting axioms (type instance</span><span>
</span><span id="line-968"></span><span class="hs-comment">-- declarations).</span><span>
</span><span id="line-969"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#lookupFamInstEnvInjectivityConflicts"><span class="hs-identifier hs-type">lookupFamInstEnvInjectivityConflicts</span></a></span><span>
</span><span id="line-970"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">]</span><span>         </span><span class="hs-comment">-- injectivity annotation for this type family instance</span><span>
</span><span id="line-971"></span><span>                      </span><span class="hs-comment">-- INVARIANT: list contains at least one True value</span><span>
</span><span id="line-972"></span><span>    </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a></span><span>   </span><span class="hs-comment">-- all type instances seen so far</span><span>
</span><span id="line-973"></span><span>    </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span>       </span><span class="hs-comment">-- new type instance that we're checking</span><span>
</span><span id="line-974"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- conflicting instance declarations</span><span>
</span><span id="line-975"></span><span id="lookupFamInstEnvInjectivityConflicts"><span class="annot"><span class="annottext">lookupFamInstEnvInjectivityConflicts :: [Bool] -&gt; (FamInstEnv, FamInstEnv) -&gt; FamInst -&gt; [CoAxBranch]
</span><a href="GHC.Core.FamInstEnv.html#lookupFamInstEnvInjectivityConflicts"><span class="hs-identifier hs-var hs-var">lookupFamInstEnvInjectivityConflicts</span></a></span></span><span> </span><span id="local-6989586621682668544"><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621682668544"><span class="hs-identifier hs-var">injList</span></a></span></span><span> </span><span id="local-6989586621682668545"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621682668545"><span class="hs-identifier hs-var">fam_inst_envs</span></a></span></span><span>
</span><span id="line-976"></span><span>                             </span><span id="local-6989586621682668546"><span class="annot"><span class="annottext">fam_inst :: FamInst
</span><a href="#local-6989586621682668546"><span class="hs-identifier hs-var">fam_inst</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fi_axiom :: FamInst -&gt; CoAxiom Unbranched
</span><a href="GHC.Core.FamInstEnv.html#fi_axiom"><span class="hs-identifier hs-var">fi_axiom</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668547"><span class="annot"><span class="annottext">CoAxiom Unbranched
</span><a href="#local-6989586621682668547"><span class="hs-identifier hs-var">new_axiom</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-977"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isOpenFamilyTyCon"><span class="hs-identifier hs-var">isOpenFamilyTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668549"><span class="hs-identifier hs-var">fam</span></a></span><span>
</span><span id="line-978"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-979"></span><span>
</span><span id="line-980"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-981"></span><span>  </span><span class="hs-comment">-- See Note [Verifying injectivity annotation]. This function implements</span><span>
</span><span id="line-982"></span><span>  </span><span class="hs-comment">-- check (1.B1) for open type families described there.</span><span>
</span><span id="line-983"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FamInst -&gt; CoAxBranch) -&gt; [FamInst] -&gt; [CoAxBranch]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoAxiom Unbranched -&gt; CoAxBranch
</span><a href="GHC.Core.Coercion.Axiom.html#coAxiomSingleBranch"><span class="hs-identifier hs-var">coAxiomSingleBranch</span></a></span><span> </span><span class="annot"><span class="annottext">(CoAxiom Unbranched -&gt; CoAxBranch)
-&gt; (FamInst -&gt; CoAxiom Unbranched) -&gt; FamInst -&gt; CoAxBranch
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">FamInst -&gt; CoAxiom Unbranched
</span><a href="GHC.Core.FamInstEnv.html#fi_axiom"><span class="hs-identifier hs-var">fi_axiom</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([FamInst] -&gt; [CoAxBranch]) -&gt; [FamInst] -&gt; [CoAxBranch]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-984"></span><span>    </span><span class="annot"><span class="annottext">(FamInst -&gt; Bool) -&gt; [FamInst] -&gt; [FamInst]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="annot"><span class="annottext">FamInst -&gt; Bool
</span><a href="#local-6989586621682668550"><span class="hs-identifier hs-var">isInjConflict</span></a></span><span> </span><span class="annot"><span class="annottext">([FamInst] -&gt; [FamInst]) -&gt; [FamInst] -&gt; [FamInst]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-985"></span><span>    </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv) -&gt; TyCon -&gt; [FamInst]
</span><a href="GHC.Core.FamInstEnv.html#familyInstances"><span class="hs-identifier hs-var">familyInstances</span></a></span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621682668545"><span class="hs-identifier hs-var">fam_inst_envs</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668549"><span class="hs-identifier hs-var">fam</span></a></span><span>
</span><span id="line-986"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-987"></span><span>      </span><span id="local-6989586621682668549"><span class="annot"><span class="annottext">fam :: TyCon
</span><a href="#local-6989586621682668549"><span class="hs-identifier hs-var hs-var">fam</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FamInst -&gt; TyCon
</span><a href="GHC.Core.FamInstEnv.html#famInstTyCon"><span class="hs-identifier hs-var">famInstTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">FamInst
</span><a href="#local-6989586621682668546"><span class="hs-identifier hs-var">fam_inst</span></a></span><span>
</span><span id="line-988"></span><span>      </span><span id="local-6989586621682668551"><span class="annot"><span class="annottext">new_branch :: CoAxBranch
</span><a href="#local-6989586621682668551"><span class="hs-identifier hs-var hs-var">new_branch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoAxiom Unbranched -&gt; CoAxBranch
</span><a href="GHC.Core.Coercion.Axiom.html#coAxiomSingleBranch"><span class="hs-identifier hs-var">coAxiomSingleBranch</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiom Unbranched
</span><a href="#local-6989586621682668547"><span class="hs-identifier hs-var">new_axiom</span></a></span><span>
</span><span id="line-989"></span><span>
</span><span id="line-990"></span><span>      </span><span class="hs-comment">-- filtering function used by `lookup_inj_fam_conflicts` to check whether</span><span>
</span><span id="line-991"></span><span>      </span><span class="hs-comment">-- a pair of equations conflicts with the injectivity annotation.</span><span>
</span><span id="line-992"></span><span>      </span><span id="local-6989586621682668550"><span class="annot"><span class="annottext">isInjConflict :: FamInst -&gt; Bool
</span><a href="#local-6989586621682668550"><span class="hs-identifier hs-var hs-var">isInjConflict</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fi_axiom :: FamInst -&gt; CoAxiom Unbranched
</span><a href="GHC.Core.FamInstEnv.html#fi_axiom"><span class="hs-identifier hs-var">fi_axiom</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668552"><span class="annot"><span class="annottext">CoAxiom Unbranched
</span><a href="#local-6989586621682668552"><span class="hs-identifier hs-var">old_axiom</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-993"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">InjectivityCheckResult
</span><a href="GHC.Core.FamInstEnv.html#InjectivityAccepted"><span class="hs-identifier hs-var">InjectivityAccepted</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-994"></span><span>            </span><span class="annot"><span class="annottext">[Bool] -&gt; CoAxBranch -&gt; CoAxBranch -&gt; InjectivityCheckResult
</span><a href="GHC.Core.FamInstEnv.html#injectiveBranches"><span class="hs-identifier hs-var">injectiveBranches</span></a></span><span> </span><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621682668544"><span class="hs-identifier hs-var">injList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoAxiom Unbranched -&gt; CoAxBranch
</span><a href="GHC.Core.Coercion.Axiom.html#coAxiomSingleBranch"><span class="hs-identifier hs-var">coAxiomSingleBranch</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiom Unbranched
</span><a href="#local-6989586621682668552"><span class="hs-identifier hs-var">old_axiom</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621682668551"><span class="hs-identifier hs-var">new_branch</span></a></span><span>
</span><span id="line-995"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-comment">-- no conflict</span><span>
</span><span id="line-996"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-997"></span><span>
</span><span id="line-998"></span><span>
</span><span id="line-999"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-1000"></span><span class="hs-comment">--                    Type family overlap checking bits                       --</span><span>
</span><span id="line-1001"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-1002"></span><span>
</span><span id="line-1003"></span><span class="hs-comment">{-
Note [Family instance overlap conflicts]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
- In the case of data family instances, any overlap is fundamentally a
  conflict (as these instances imply injective type mappings).

- In the case of type family instances, overlap is admitted as long as
  the right-hand sides of the overlapping rules coincide under the
  overlap substitution.  eg
       type instance F a Int = a
       type instance F Int b = b
  These two overlap on (F Int Int) but then both RHSs are Int,
  so all is well. We require that they are syntactically equal;
  anything else would be difficult to test for at this stage.
-}</span><span>
</span><span id="line-1018"></span><span>
</span><span id="line-1019"></span><span class="hs-comment">------------------------------------------------------------</span><span>
</span><span id="line-1020"></span><span class="hs-comment">-- Might be a one-way match or a unifier</span><span>
</span><span id="line-1021"></span><span class="hs-keyword">data</span><span> </span><span id="FamInstLookupMode"><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstLookupMode"><span class="hs-identifier hs-var">FamInstLookupMode</span></a></span></span><span> </span><span id="local-6989586621682668553"><span class="annot"><a href="#local-6989586621682668553"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1022"></span><span>  </span><span class="hs-comment">-- The FamInst we are trying to find conflicts against</span><span>
</span><span id="line-1023"></span><span>  </span><span id="WantConflicts"><span class="annot"><a href="GHC.Core.FamInstEnv.html#WantConflicts"><span class="hs-identifier hs-var">WantConflicts</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstLookupMode"><span class="hs-identifier hs-type">FamInstLookupMode</span></a></span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span>
</span><span id="line-1024"></span><span>  </span><span id="WantMatches"><span class="annot"><a href="GHC.Core.FamInstEnv.html#WantMatches"><span class="hs-identifier hs-var">WantMatches</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstLookupMode"><span class="hs-identifier hs-type">FamInstLookupMode</span></a></span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstMatch"><span class="hs-identifier hs-type">FamInstMatch</span></a></span><span>
</span><span id="line-1025"></span><span>
</span><span id="line-1026"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#lookup_fam_inst_env%27"><span class="hs-identifier hs-type">lookup_fam_inst_env'</span></a></span><span>          </span><span class="hs-comment">-- The worker, local to this module</span><span>
</span><span id="line-1027"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621682667988"><span class="annot"><a href="#local-6989586621682667988"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstLookupMode"><span class="hs-identifier hs-type">FamInstLookupMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682667988"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1028"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a></span><span>
</span><span id="line-1029"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>        </span><span class="hs-comment">-- What we are looking for</span><span>
</span><span id="line-1030"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621682667988"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1031"></span><span id="lookup_fam_inst_env%27"><span class="annot"><span class="annottext">lookup_fam_inst_env' :: forall a.
FamInstLookupMode a -&gt; FamInstEnv -&gt; TyCon -&gt; [Type] -&gt; [a]
</span><a href="GHC.Core.FamInstEnv.html#lookup_fam_inst_env%27"><span class="hs-identifier hs-var hs-var">lookup_fam_inst_env'</span></a></span></span><span> </span><span id="local-6989586621682668562"><span class="annot"><span class="annottext">FamInstLookupMode a
</span><a href="#local-6989586621682668562"><span class="hs-identifier hs-var">lookup_mode</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamIE"><span class="hs-identifier hs-type">FamIE</span></a></span><span> </span><span class="annot"><span class="annottext">BranchIndex
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682668563"><span class="annot"><span class="annottext">RoughMap FamInst
</span><a href="#local-6989586621682668563"><span class="hs-identifier hs-var">ie</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682668564"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668564"><span class="hs-identifier hs-var">fam</span></a></span></span><span> </span><span id="local-6989586621682668565"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668565"><span class="hs-identifier hs-var">match_tys</span></a></span></span><span>
</span><span id="line-1032"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isOpenFamilyTyCon"><span class="hs-identifier hs-var">isOpenFamilyTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668564"><span class="hs-identifier hs-var">fam</span></a></span><span>
</span><span id="line-1033"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682668566"><span class="annot"><span class="annottext">xs :: [FamInst]
</span><a href="#local-6989586621682668566"><span class="hs-identifier hs-var hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Bag FamInst, [FamInst]) -&gt; [FamInst]
</span><a href="#local-6989586621682668567"><span class="hs-identifier hs-var">rm_fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[RoughMatchLookupTc]
-&gt; RoughMap FamInst -&gt; (Bag FamInst, [FamInst])
forall a. [RoughMatchLookupTc] -&gt; RoughMap a -&gt; (Bag a, [a])
</span><a href="GHC.Core.RoughMap.html#lookupRM%27"><span class="hs-identifier hs-var">lookupRM'</span></a></span><span> </span><span class="annot"><span class="annottext">[RoughMatchLookupTc]
</span><a href="#local-6989586621682668569"><span class="hs-identifier hs-var">rough_tmpl</span></a></span><span> </span><span class="annot"><span class="annottext">RoughMap FamInst
</span><a href="#local-6989586621682668563"><span class="hs-identifier hs-var">ie</span></a></span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- The common case</span><span>
</span><span id="line-1034"></span><span>    </span><span class="hs-comment">-- Avoid doing any of the allocation below if there are no instances to look at.</span><span>
</span><span id="line-1035"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[FamInst] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[FamInst]
</span><a href="#local-6989586621682668566"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-1036"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FamInst -&gt; Maybe a) -&gt; [FamInst] -&gt; [a]
forall (f :: * -&gt; *) a b.
Foldable f =&gt;
(a -&gt; Maybe b) -&gt; f a -&gt; [b]
</span><a href="GHC.Utils.Misc.html#mapMaybe%27"><span class="hs-identifier hs-var">mapMaybe'</span></a></span><span> </span><span class="annot"><span class="annottext">FamInst -&gt; Maybe a
</span><a href="#local-6989586621682668572"><span class="hs-identifier hs-var">check_fun</span></a></span><span> </span><span class="annot"><span class="annottext">[FamInst]
</span><a href="#local-6989586621682668566"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-1037"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1038"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1039"></span><span>    </span><span class="annot"><a href="#local-6989586621682668569"><span class="hs-identifier hs-type">rough_tmpl</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.RoughMap.html#RoughMatchLookupTc"><span class="hs-identifier hs-type">RoughMatchLookupTc</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1040"></span><span>    </span><span id="local-6989586621682668569"><span class="annot"><span class="annottext">rough_tmpl :: [RoughMatchLookupTc]
</span><a href="#local-6989586621682668569"><span class="hs-identifier hs-var hs-var">rough_tmpl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; RoughMatchLookupTc
</span><a href="GHC.Core.RoughMap.html#RML_KnownTc"><span class="hs-identifier hs-var">RML_KnownTc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Name
</span><a href="GHC.Core.TyCon.html#tyConName"><span class="hs-identifier hs-var">tyConName</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668564"><span class="hs-identifier hs-var">fam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">RoughMatchLookupTc -&gt; [RoughMatchLookupTc] -&gt; [RoughMatchLookupTc]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; RoughMatchLookupTc) -&gt; [Type] -&gt; [RoughMatchLookupTc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; RoughMatchLookupTc
</span><a href="GHC.Core.RoughMap.html#typeToRoughMatchLookupTc"><span class="hs-identifier hs-var">typeToRoughMatchLookupTc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668565"><span class="hs-identifier hs-var">match_tys</span></a></span><span>
</span><span id="line-1041"></span><span>
</span><span id="line-1042"></span><span>    </span><span class="annot"><a href="#local-6989586621682668567"><span class="hs-identifier hs-type">rm_fun</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a></span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1043"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682668567"><span class="annot"><span class="annottext">(Bag FamInst, [FamInst]) -&gt; [FamInst]
</span><a href="#local-6989586621682668567"><span class="hs-identifier hs-var">rm_fun</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682668572"><span class="annot"><span class="annottext">FamInst -&gt; Maybe a
</span><a href="#local-6989586621682668572"><span class="hs-identifier hs-var">check_fun</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">FamInstLookupMode a
</span><a href="#local-6989586621682668562"><span class="hs-identifier hs-var">lookup_mode</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1044"></span><span>                            </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#WantConflicts"><span class="hs-identifier hs-type">WantConflicts</span></a></span><span> </span><span id="local-6989586621682668575"><span class="annot"><span class="annottext">FamInst
</span><a href="#local-6989586621682668575"><span class="hs-identifier hs-var">fam_inst</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Bag FamInst, [FamInst]) -&gt; [FamInst]
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FamInst -&gt; FamInst -&gt; Maybe FamInst
</span><a href="#local-6989586621682668576"><span class="hs-identifier hs-var">unify_fun</span></a></span><span> </span><span class="annot"><span class="annottext">FamInst
</span><a href="#local-6989586621682668575"><span class="hs-identifier hs-var">fam_inst</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1045"></span><span>                            </span><span class="annot"><span class="annottext">FamInstLookupMode a
</span><a href="GHC.Core.FamInstEnv.html#WantMatches"><span class="hs-identifier hs-var">WantMatches</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bag FamInst -&gt; [FamInst]
forall a. Bag a -&gt; [a]
</span><a href="GHC.Data.Bag.html#bagToList"><span class="hs-identifier hs-var">bagToList</span></a></span><span> </span><span class="annot"><span class="annottext">(Bag FamInst -&gt; [FamInst])
-&gt; ((Bag FamInst, [FamInst]) -&gt; Bag FamInst)
-&gt; (Bag FamInst, [FamInst])
-&gt; [FamInst]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Bag FamInst, [FamInst]) -&gt; Bag FamInst
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FamInst -&gt; Maybe a
FamInst -&gt; Maybe FamInstMatch
</span><a href="#local-6989586621682668580"><span class="hs-identifier hs-var">match_fun</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1046"></span><span>
</span><span id="line-1047"></span><span>    </span><span class="hs-comment">-- Function used for finding unifiers</span><span>
</span><span id="line-1048"></span><span>    </span><span id="local-6989586621682668576"><span class="annot"><span class="annottext">unify_fun :: FamInst -&gt; FamInst -&gt; Maybe FamInst
</span><a href="#local-6989586621682668576"><span class="hs-identifier hs-var hs-var">unify_fun</span></a></span></span><span> </span><span id="local-6989586621682668592"><span class="annot"><span class="annottext">FamInst
</span><a href="#local-6989586621682668592"><span class="hs-identifier hs-var">orig_fam_inst</span></a></span></span><span> </span><span id="local-6989586621682668593"><span class="annot"><span class="annottext">item :: FamInst
</span><a href="#local-6989586621682668593"><span class="hs-identifier hs-var">item</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fi_axiom :: FamInst -&gt; CoAxiom Unbranched
</span><a href="GHC.Core.FamInstEnv.html#fi_axiom"><span class="hs-identifier hs-var">fi_axiom</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668594"><span class="annot"><span class="annottext">CoAxiom Unbranched
</span><a href="#local-6989586621682668594"><span class="hs-identifier hs-var">old_axiom</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fi_tys :: FamInst -&gt; [Type]
</span><a href="GHC.Core.FamInstEnv.html#fi_tys"><span class="hs-identifier hs-var">fi_tys</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668595"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668595"><span class="hs-identifier hs-var">tpl_tys</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fi_tvs :: FamInst -&gt; [TyVar]
</span><a href="GHC.Core.FamInstEnv.html#fi_tvs"><span class="hs-identifier hs-var">fi_tvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668596"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668596"><span class="hs-identifier hs-var">tpl_tvs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1049"></span><span>
</span><span id="line-1050"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; Maybe FamInst -&gt; Maybe FamInst
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type] -&gt; TyCoVarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tyCoVarsOfTypes</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668599"><span class="hs-identifier hs-var">tys</span></a></span><span> </span><span class="annot"><span class="annottext">TyCoVarSet -&gt; TyCoVarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#disjointVarSet"><span class="hs-operator hs-var">`disjointVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; TyCoVarSet
</span><a href="GHC.Types.Var.Set.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668596"><span class="hs-identifier hs-var">tpl_tvs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1051"></span><span>                   </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668602"><span class="hs-identifier hs-var">fam</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668599"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-1052"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TyVar] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668596"><span class="hs-identifier hs-var">tpl_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668595"><span class="hs-identifier hs-var">tpl_tys</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe FamInst -&gt; Maybe FamInst) -&gt; Maybe FamInst -&gt; Maybe FamInst
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1053"></span><span>                </span><span class="hs-comment">-- Unification will break badly if the variables overlap</span><span>
</span><span id="line-1054"></span><span>                </span><span class="hs-comment">-- They shouldn't because we allocate separate uniques for them</span><span>
</span><span id="line-1055"></span><span>         </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">CoAxBranch -&gt; CoAxBranch -&gt; Bool
</span><a href="GHC.Core.FamInstEnv.html#compatibleBranches"><span class="hs-identifier hs-var">compatibleBranches</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoAxiom Unbranched -&gt; CoAxBranch
</span><a href="GHC.Core.Coercion.Axiom.html#coAxiomSingleBranch"><span class="hs-identifier hs-var">coAxiomSingleBranch</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiom Unbranched
</span><a href="#local-6989586621682668594"><span class="hs-identifier hs-var">old_axiom</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621682668604"><span class="hs-identifier hs-var">new_branch</span></a></span><span>
</span><span id="line-1056"></span><span>           </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Maybe FamInst
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1057"></span><span>           </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">FamInst -&gt; Maybe FamInst
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">FamInst
</span><a href="#local-6989586621682668593"><span class="hs-identifier hs-var">item</span></a></span><span>
</span><span id="line-1058"></span><span>      </span><span class="hs-comment">-- See Note [Family instance overlap conflicts]</span><span>
</span><span id="line-1059"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-1060"></span><span>        </span><span id="local-6989586621682668604"><span class="annot"><span class="annottext">new_branch :: CoAxBranch
</span><a href="#local-6989586621682668604"><span class="hs-identifier hs-var hs-var">new_branch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoAxiom Unbranched -&gt; CoAxBranch
</span><a href="GHC.Core.Coercion.Axiom.html#coAxiomSingleBranch"><span class="hs-identifier hs-var">coAxiomSingleBranch</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FamInst -&gt; CoAxiom Unbranched
</span><a href="GHC.Core.FamInstEnv.html#famInstAxiom"><span class="hs-identifier hs-var">famInstAxiom</span></a></span><span> </span><span class="annot"><span class="annottext">FamInst
</span><a href="#local-6989586621682668592"><span class="hs-identifier hs-var">orig_fam_inst</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1061"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621682668602"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668602"><span class="hs-identifier hs-var">fam</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682668599"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668599"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FamInst -&gt; (TyCon, [Type])
</span><a href="GHC.Core.FamInstEnv.html#famInstSplitLHS"><span class="hs-identifier hs-var">famInstSplitLHS</span></a></span><span> </span><span class="annot"><span class="annottext">FamInst
</span><a href="#local-6989586621682668592"><span class="hs-identifier hs-var">orig_fam_inst</span></a></span><span>
</span><span id="line-1062"></span><span>
</span><span id="line-1063"></span><span>    </span><span class="hs-comment">-- Function used for checking matches</span><span>
</span><span id="line-1064"></span><span>    </span><span id="local-6989586621682668580"><span class="annot"><span class="annottext">match_fun :: FamInst -&gt; Maybe FamInstMatch
</span><a href="#local-6989586621682668580"><span class="hs-identifier hs-var hs-var">match_fun</span></a></span></span><span> </span><span id="local-6989586621682668605"><span class="annot"><span class="annottext">item :: FamInst
</span><a href="#local-6989586621682668605"><span class="hs-identifier hs-var">item</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fi_tvs :: FamInst -&gt; [TyVar]
</span><a href="GHC.Core.FamInstEnv.html#fi_tvs"><span class="hs-identifier hs-var">fi_tvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668606"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668606"><span class="hs-identifier hs-var">tpl_tvs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fi_cvs :: FamInst -&gt; [TyVar]
</span><a href="GHC.Core.FamInstEnv.html#fi_cvs"><span class="hs-identifier hs-var">fi_cvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668607"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668607"><span class="hs-identifier hs-var">tpl_cvs</span></a></span></span><span>
</span><span id="line-1065"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fi_tys :: FamInst -&gt; [Type]
</span><a href="GHC.Core.FamInstEnv.html#fi_tys"><span class="hs-identifier hs-var">fi_tys</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668608"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668608"><span class="hs-identifier hs-var">tpl_tys</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-keyword">do</span><span>
</span><span id="line-1066"></span><span>      </span><span id="local-6989586621682668609"><span class="annot"><a href="#local-6989586621682668609"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; [Type] -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tcMatchTys"><span class="hs-identifier hs-var">tcMatchTys</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668608"><span class="hs-identifier hs-var">tpl_tys</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668611"><span class="hs-identifier hs-var">match_tys1</span></a></span><span>
</span><span id="line-1067"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstMatch"><span class="hs-identifier hs-type">FamInstMatch</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#fim_instance"><span class="hs-identifier hs-var">fim_instance</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682668605"><span class="hs-identifier hs-type">item</span></a></span><span>
</span><span id="line-1068"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#fim_tys"><span class="hs-identifier hs-var">fim_tys</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#substTyVars"><span class="hs-identifier hs-type">substTyVars</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668609"><span class="hs-identifier hs-type">subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668606"><span class="hs-identifier hs-type">tpl_tvs</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#chkAppend"><span class="hs-operator hs-type">`chkAppend`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668614"><span class="hs-identifier hs-type">match_tys2</span></a></span><span>
</span><span id="line-1069"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#fim_cos"><span class="hs-identifier hs-var">fim_cos</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-type">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">isJust</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#lookupCoVar"><span class="hs-identifier hs-type">lookupCoVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668609"><span class="hs-identifier hs-type">subst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682668607"><span class="hs-identifier hs-type">tpl_cvs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-1070"></span><span>                                               </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#substCoVars"><span class="hs-identifier hs-type">substCoVars</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668609"><span class="hs-identifier hs-type">subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668607"><span class="hs-identifier hs-type">tpl_cvs</span></a></span><span>
</span><span id="line-1071"></span><span>                             </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1072"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-1073"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621682668611"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668611"><span class="hs-identifier hs-var">match_tys1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682668614"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668614"><span class="hs-identifier hs-var">match_tys2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; ([Type], [Type])
</span><a href="#local-6989586621682668619"><span class="hs-identifier hs-var">split_tys</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668608"><span class="hs-identifier hs-var">tpl_tys</span></a></span><span>
</span><span id="line-1074"></span><span>
</span><span id="line-1075"></span><span>    </span><span class="hs-comment">-- Precondition: the tycon is saturated (or over-saturated)</span><span>
</span><span id="line-1076"></span><span>
</span><span id="line-1077"></span><span>    </span><span class="hs-comment">-- Deal with over-saturation</span><span>
</span><span id="line-1078"></span><span>    </span><span class="hs-comment">-- See Note [Over-saturated matches]</span><span>
</span><span id="line-1079"></span><span>    </span><span id="local-6989586621682668619"><span class="annot"><span class="annottext">split_tys :: [Type] -&gt; ([Type], [Type])
</span><a href="#local-6989586621682668619"><span class="hs-identifier hs-var hs-var">split_tys</span></a></span></span><span> </span><span id="local-6989586621682668620"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668620"><span class="hs-identifier hs-var">tpl_tys</span></a></span></span><span>
</span><span id="line-1080"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isTypeFamilyTyCon"><span class="hs-identifier hs-var">isTypeFamilyTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668564"><span class="hs-identifier hs-var">fam</span></a></span><span>
</span><span id="line-1081"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([Type], [Type])
</span><a href="#local-6989586621682668622"><span class="hs-identifier hs-var">pre_rough_split_tys</span></a></span><span>
</span><span id="line-1082"></span><span>
</span><span id="line-1083"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1084"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682668623"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668623"><span class="hs-identifier hs-var">match_tys1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682668624"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668624"><span class="hs-identifier hs-var">match_tys2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; [Type] -&gt; ([Type], [Type])
forall b a. [b] -&gt; [a] -&gt; ([a], [a])
</span><a href="GHC.Utils.Misc.html#splitAtList"><span class="hs-identifier hs-var">splitAtList</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668620"><span class="hs-identifier hs-var">tpl_tys</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668565"><span class="hs-identifier hs-var">match_tys</span></a></span><span>
</span><span id="line-1085"></span><span>        </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668623"><span class="hs-identifier hs-var">match_tys1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668624"><span class="hs-identifier hs-var">match_tys2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1086"></span><span>
</span><span id="line-1087"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682668626"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668626"><span class="hs-identifier hs-var">pre_match_tys1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682668627"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668627"><span class="hs-identifier hs-var">pre_match_tys2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BranchIndex -&gt; [Type] -&gt; ([Type], [Type])
forall a. BranchIndex -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; BranchIndex
</span><a href="GHC.Core.TyCon.html#tyConArity"><span class="hs-identifier hs-var">tyConArity</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668564"><span class="hs-identifier hs-var">fam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668565"><span class="hs-identifier hs-var">match_tys</span></a></span><span>
</span><span id="line-1088"></span><span>    </span><span id="local-6989586621682668622"><span class="annot"><span class="annottext">pre_rough_split_tys :: ([Type], [Type])
</span><a href="#local-6989586621682668622"><span class="hs-identifier hs-var hs-var">pre_rough_split_tys</span></a></span></span><span>
</span><span id="line-1089"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668626"><span class="hs-identifier hs-var">pre_match_tys1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668627"><span class="hs-identifier hs-var">pre_match_tys2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1090"></span><span>
</span><span id="line-1091"></span><span id="local-6989586621682667987"><span class="annot"><a href="GHC.Core.FamInstEnv.html#lookup_fam_inst_env"><span class="hs-identifier hs-type">lookup_fam_inst_env</span></a></span><span>           </span><span class="hs-comment">-- The worker, local to this module</span><span>
</span><span id="line-1092"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstLookupMode"><span class="hs-identifier hs-type">FamInstLookupMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682667987"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1093"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a></span><span>
</span><span id="line-1094"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>        </span><span class="hs-comment">-- What we are looking for</span><span>
</span><span id="line-1095"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621682667987"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span></span><span>         </span><span class="hs-comment">-- Successful matches</span><span>
</span><span id="line-1096"></span><span>
</span><span id="line-1097"></span><span class="hs-comment">-- Precondition: the tycon is saturated (or over-saturated)</span><span>
</span><span id="line-1098"></span><span>
</span><span id="line-1099"></span><span id="lookup_fam_inst_env"><span class="annot"><span class="annottext">lookup_fam_inst_env :: forall a.
FamInstLookupMode a
-&gt; (FamInstEnv, FamInstEnv) -&gt; TyCon -&gt; [Type] -&gt; [a]
</span><a href="GHC.Core.FamInstEnv.html#lookup_fam_inst_env"><span class="hs-identifier hs-var hs-var">lookup_fam_inst_env</span></a></span></span><span> </span><span id="local-6989586621682668630"><span class="annot"><span class="annottext">FamInstLookupMode a
</span><a href="#local-6989586621682668630"><span class="hs-identifier hs-var">match_fun</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682668631"><span class="annot"><span class="annottext">FamInstEnv
</span><a href="#local-6989586621682668631"><span class="hs-identifier hs-var">pkg_ie</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682668632"><span class="annot"><span class="annottext">FamInstEnv
</span><a href="#local-6989586621682668632"><span class="hs-identifier hs-var">home_ie</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682668633"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668633"><span class="hs-identifier hs-var">fam</span></a></span></span><span> </span><span id="local-6989586621682668634"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668634"><span class="hs-identifier hs-var">tys</span></a></span></span><span>
</span><span id="line-1100"></span><span>  </span><span class="hs-glyph">=</span><span>  </span><span class="annot"><span class="annottext">FamInstLookupMode a -&gt; FamInstEnv -&gt; TyCon -&gt; [Type] -&gt; [a]
forall a.
FamInstLookupMode a -&gt; FamInstEnv -&gt; TyCon -&gt; [Type] -&gt; [a]
</span><a href="GHC.Core.FamInstEnv.html#lookup_fam_inst_env%27"><span class="hs-identifier hs-var">lookup_fam_inst_env'</span></a></span><span> </span><span class="annot"><span class="annottext">FamInstLookupMode a
</span><a href="#local-6989586621682668630"><span class="hs-identifier hs-var">match_fun</span></a></span><span> </span><span class="annot"><span class="annottext">FamInstEnv
</span><a href="#local-6989586621682668632"><span class="hs-identifier hs-var">home_ie</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668633"><span class="hs-identifier hs-var">fam</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668634"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-1101"></span><span>  </span><span class="annot"><span class="annottext">[a] -&gt; [a] -&gt; [a]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">FamInstLookupMode a -&gt; FamInstEnv -&gt; TyCon -&gt; [Type] -&gt; [a]
forall a.
FamInstLookupMode a -&gt; FamInstEnv -&gt; TyCon -&gt; [Type] -&gt; [a]
</span><a href="GHC.Core.FamInstEnv.html#lookup_fam_inst_env%27"><span class="hs-identifier hs-var">lookup_fam_inst_env'</span></a></span><span> </span><span class="annot"><span class="annottext">FamInstLookupMode a
</span><a href="#local-6989586621682668630"><span class="hs-identifier hs-var">match_fun</span></a></span><span> </span><span class="annot"><span class="annottext">FamInstEnv
</span><a href="#local-6989586621682668631"><span class="hs-identifier hs-var">pkg_ie</span></a></span><span>  </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668633"><span class="hs-identifier hs-var">fam</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668634"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-1102"></span><span>
</span><span id="line-1103"></span><span class="hs-comment">{-
Note [Over-saturated matches]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It's ok to look up an over-saturated type constructor.  E.g.
     type family F a :: * -&gt; *
     type instance F (a,b) = Either (a-&gt;b)

The type instance gives rise to a newtype TyCon (at a higher kind
which you can't do in Haskell!):
     newtype FPair a b = FP (Either (a-&gt;b))

Then looking up (F (Int,Bool) Char) will return a FamInstMatch
     (FPair, [Int,Bool,Char])
The &quot;extra&quot; type argument [Char] just stays on the end.

We handle data families and type families separately here:

 * For type families, all instances of a type family must have the
   same arity, so we can precompute the split between the match_tys
   and the overflow tys. This is done in pre_rough_split_tys.

 * For data family instances, though, we need to re-split for each
   instance, because the breakdown might be different for each
   instance.  Why?  Because of eta reduction; see
   Note [Eta reduction for data families] in GHC.Core.Coercion.Axiom.
-}</span><span>
</span><span id="line-1129"></span><span>
</span><span id="line-1130"></span><span class="hs-comment">-- checks if one LHS is dominated by a list of other branches</span><span>
</span><span id="line-1131"></span><span class="hs-comment">-- in other words, if an application would match the first LHS, it is guaranteed</span><span>
</span><span id="line-1132"></span><span class="hs-comment">-- to match at least one of the others. The RHSs are ignored.</span><span>
</span><span id="line-1133"></span><span class="hs-comment">-- This algorithm is conservative:</span><span>
</span><span id="line-1134"></span><span class="hs-comment">--   True -&gt; the LHS is definitely covered by the others</span><span>
</span><span id="line-1135"></span><span class="hs-comment">--   False -&gt; no information</span><span>
</span><span id="line-1136"></span><span class="hs-comment">-- It is currently (Oct 2012) used only for generating errors for</span><span>
</span><span id="line-1137"></span><span class="hs-comment">-- inaccessible branches. If these errors go unreported, no harm done.</span><span>
</span><span id="line-1138"></span><span class="hs-comment">-- This is defined here to avoid a dependency from CoAxiom to Unify</span><span>
</span><span id="line-1139"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#isDominatedBy"><span class="hs-identifier hs-type">isDominatedBy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1140"></span><span id="isDominatedBy"><span class="annot"><span class="annottext">isDominatedBy :: CoAxBranch -&gt; [CoAxBranch] -&gt; Bool
</span><a href="GHC.Core.FamInstEnv.html#isDominatedBy"><span class="hs-identifier hs-var hs-var">isDominatedBy</span></a></span></span><span> </span><span id="local-6989586621682668635"><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621682668635"><span class="hs-identifier hs-var">branch</span></a></span></span><span> </span><span id="local-6989586621682668636"><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="#local-6989586621682668636"><span class="hs-identifier hs-var">branches</span></a></span></span><span>
</span><span id="line-1141"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Bool] -&gt; Bool
forall (t :: * -&gt; *). Foldable t =&gt; t Bool -&gt; Bool
</span><span class="hs-identifier hs-var">or</span></span><span> </span><span class="annot"><span class="annottext">([Bool] -&gt; Bool) -&gt; [Bool] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(CoAxBranch -&gt; Bool) -&gt; [CoAxBranch] -&gt; [Bool]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">CoAxBranch -&gt; Bool
</span><a href="#local-6989586621682668638"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="#local-6989586621682668636"><span class="hs-identifier hs-var">branches</span></a></span><span>
</span><span id="line-1142"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1143"></span><span>      </span><span id="local-6989586621682668639"><span class="annot"><span class="annottext">lhs :: [Type]
</span><a href="#local-6989586621682668639"><span class="hs-identifier hs-var hs-var">lhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoAxBranch -&gt; [Type]
</span><a href="GHC.Core.Coercion.Axiom.html#coAxBranchLHS"><span class="hs-identifier hs-var">coAxBranchLHS</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621682668635"><span class="hs-identifier hs-var">branch</span></a></span><span>
</span><span id="line-1144"></span><span>      </span><span id="local-6989586621682668638"><span class="annot"><span class="annottext">match :: CoAxBranch -&gt; Bool
</span><a href="#local-6989586621682668638"><span class="hs-identifier hs-var hs-var">match</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cab_lhs :: CoAxBranch -&gt; [Type]
</span><a href="GHC.Core.Coercion.Axiom.html#cab_lhs"><span class="hs-identifier hs-var">cab_lhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668641"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668641"><span class="hs-identifier hs-var">tys</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1145"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Subst -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Subst -&gt; Bool) -&gt; Maybe Subst -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; [Type] -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tcMatchTys"><span class="hs-identifier hs-var">tcMatchTys</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668641"><span class="hs-identifier hs-var">tys</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668639"><span class="hs-identifier hs-var">lhs</span></a></span><span>
</span><span id="line-1146"></span><span>
</span><span id="line-1147"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Choosing an axiom application
*                                                                      *
************************************************************************

The lookupFamInstEnv function does a nice job for *open* type families,
but we also need to handle closed ones when normalising a type:
-}</span><span>
</span><span id="line-1157"></span><span>
</span><span id="line-1158"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#reduceTyFamApp_maybe"><span class="hs-identifier hs-type">reduceTyFamApp_maybe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a></span><span>
</span><span id="line-1159"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span>              </span><span class="hs-comment">-- Desired role of result coercion</span><span>
</span><span id="line-1160"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1161"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span>
</span><span id="line-1162"></span><span class="hs-comment">-- Attempt to do a *one-step* reduction of a type-family application</span><span>
</span><span id="line-1163"></span><span class="hs-comment">--    but *not* newtypes</span><span>
</span><span id="line-1164"></span><span class="hs-comment">-- Works on type-synonym families always; data-families only if</span><span>
</span><span id="line-1165"></span><span class="hs-comment">--     the role we seek is representational</span><span>
</span><span id="line-1166"></span><span class="hs-comment">-- It does *not* normalise the type arguments first, so this may not</span><span>
</span><span id="line-1167"></span><span class="hs-comment">--     go as far as you want. If you want normalised type arguments,</span><span>
</span><span id="line-1168"></span><span class="hs-comment">--     use topReduceTyFamApp_maybe</span><span>
</span><span id="line-1169"></span><span class="hs-comment">--</span><span>
</span><span id="line-1170"></span><span class="hs-comment">-- The TyCon can be oversaturated.</span><span>
</span><span id="line-1171"></span><span class="hs-comment">-- Works on both open and closed families</span><span>
</span><span id="line-1172"></span><span class="hs-comment">--</span><span>
</span><span id="line-1173"></span><span class="hs-comment">-- Always returns a *homogeneous* coercion -- type family reductions are always</span><span>
</span><span id="line-1174"></span><span class="hs-comment">-- homogeneous</span><span>
</span><span id="line-1175"></span><span id="reduceTyFamApp_maybe"><span class="annot"><span class="annottext">reduceTyFamApp_maybe :: (FamInstEnv, FamInstEnv)
-&gt; Role -&gt; TyCon -&gt; [Type] -&gt; Maybe Reduction
</span><a href="GHC.Core.FamInstEnv.html#reduceTyFamApp_maybe"><span class="hs-identifier hs-var hs-var">reduceTyFamApp_maybe</span></a></span></span><span> </span><span id="local-6989586621682668642"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621682668642"><span class="hs-identifier hs-var">envs</span></a></span></span><span> </span><span id="local-6989586621682668643"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682668643"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span id="local-6989586621682668644"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668644"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621682668645"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668645"><span class="hs-identifier hs-var">tys</span></a></span></span><span>
</span><span id="line-1176"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Phantom"><span class="hs-identifier hs-var">Phantom</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682668643"><span class="hs-keyword hs-var">role</span></a></span><span>
</span><span id="line-1177"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Reduction
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1178"></span><span>
</span><span id="line-1179"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682668643"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1180"></span><span>      </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Representational"><span class="hs-identifier hs-var">Representational</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isOpenFamilyTyCon"><span class="hs-identifier hs-var">isOpenFamilyTyCon</span></a></span><span>     </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668644"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-1181"></span><span>      </span><span class="annot"><span class="annottext">Role
</span><span class="hs-identifier">_</span></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isOpenTypeFamilyTyCon"><span class="hs-identifier hs-var">isOpenTypeFamilyTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668644"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-1182"></span><span>       </span><span class="hs-comment">-- If we seek a representational coercion</span><span>
</span><span id="line-1183"></span><span>       </span><span class="hs-comment">-- (e.g. the call in topNormaliseType_maybe) then we can</span><span>
</span><span id="line-1184"></span><span>       </span><span class="hs-comment">-- unwrap data families as well as type-synonym families;</span><span>
</span><span id="line-1185"></span><span>       </span><span class="hs-comment">-- otherwise only type-synonym families</span><span>
</span><span id="line-1186"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstMatch"><span class="hs-identifier hs-type">FamInstMatch</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fim_instance :: FamInstMatch -&gt; FamInst
</span><a href="GHC.Core.FamInstEnv.html#fim_instance"><span class="hs-identifier hs-var">fim_instance</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fi_axiom :: FamInst -&gt; CoAxiom Unbranched
</span><a href="GHC.Core.FamInstEnv.html#fi_axiom"><span class="hs-identifier hs-var">fi_axiom</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668648"><span class="annot"><span class="annottext">CoAxiom Unbranched
</span><a href="#local-6989586621682668648"><span class="hs-identifier hs-var">ax</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1187"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fim_tys :: FamInstMatch -&gt; [Type]
</span><a href="GHC.Core.FamInstEnv.html#fim_tys"><span class="hs-identifier hs-var">fim_tys</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668649"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668649"><span class="hs-identifier hs-var">inst_tys</span></a></span></span><span>
</span><span id="line-1188"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fim_cos :: FamInstMatch -&gt; [Coercion]
</span><a href="GHC.Core.FamInstEnv.html#fim_cos"><span class="hs-identifier hs-var">fim_cos</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668650"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682668650"><span class="hs-identifier hs-var">inst_cos</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[FamInstMatch]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv) -&gt; TyCon -&gt; [Type] -&gt; [FamInstMatch]
</span><a href="GHC.Core.FamInstEnv.html#lookupFamInstEnv"><span class="hs-identifier hs-var">lookupFamInstEnv</span></a></span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621682668642"><span class="hs-identifier hs-var">envs</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668644"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668645"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-1189"></span><span>      </span><span class="hs-comment">-- NB: Allow multiple matches because of compatible overlap</span><span>
</span><span id="line-1190"></span><span>
</span><span id="line-1191"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682668651"><span class="annot"><span class="annottext">co :: Coercion
</span><a href="#local-6989586621682668651"><span class="hs-identifier hs-var hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role -&gt; CoAxiom Unbranched -&gt; [Type] -&gt; [Coercion] -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkUnbranchedAxInstCo"><span class="hs-identifier hs-var">mkUnbranchedAxInstCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682668643"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiom Unbranched
</span><a href="#local-6989586621682668648"><span class="hs-identifier hs-var">ax</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668649"><span class="hs-identifier hs-var">inst_tys</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682668650"><span class="hs-identifier hs-var">inst_cos</span></a></span><span>
</span><span id="line-1192"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; Maybe Reduction
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Reduction -&gt; Maybe Reduction) -&gt; Reduction -&gt; Maybe Reduction
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#coercionRedn"><span class="hs-identifier hs-var">coercionRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682668651"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1193"></span><span>
</span><span id="line-1194"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682668654"><span class="annot"><span class="annottext">CoAxiom Branched
</span><a href="#local-6989586621682668654"><span class="hs-identifier hs-var">ax</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Maybe (CoAxiom Branched)
</span><a href="GHC.Core.TyCon.html#isClosedSynFamilyTyConWithAxiom_maybe"><span class="hs-identifier hs-var">isClosedSynFamilyTyConWithAxiom_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668644"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-1195"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682668656"><span class="annot"><span class="annottext">BranchIndex
</span><a href="#local-6989586621682668656"><span class="hs-identifier hs-var">ind</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682668657"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668657"><span class="hs-identifier hs-var">inst_tys</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682668658"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682668658"><span class="hs-identifier hs-var">inst_cos</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoAxiom Branched
-&gt; [Type] -&gt; Maybe (BranchIndex, [Type], [Coercion])
</span><a href="GHC.Core.FamInstEnv.html#chooseBranch"><span class="hs-identifier hs-var">chooseBranch</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiom Branched
</span><a href="#local-6989586621682668654"><span class="hs-identifier hs-var">ax</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668645"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-1196"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682668660"><span class="annot"><span class="annottext">co :: Coercion
</span><a href="#local-6989586621682668660"><span class="hs-identifier hs-var hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role -&gt; CoAxiomRule -&gt; [Type] -&gt; [Coercion] -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkAxInstCo"><span class="hs-identifier hs-var">mkAxInstCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682668643"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoAxiom Branched -&gt; BranchIndex -&gt; CoAxiomRule
</span><a href="GHC.Core.Coercion.Axiom.html#BranchedAxiom"><span class="hs-identifier hs-var">BranchedAxiom</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiom Branched
</span><a href="#local-6989586621682668654"><span class="hs-identifier hs-var">ax</span></a></span><span> </span><span class="annot"><span class="annottext">BranchIndex
</span><a href="#local-6989586621682668656"><span class="hs-identifier hs-var">ind</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668657"><span class="hs-identifier hs-var">inst_tys</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682668658"><span class="hs-identifier hs-var">inst_cos</span></a></span><span>
</span><span id="line-1197"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; Maybe Reduction
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Reduction -&gt; Maybe Reduction) -&gt; Reduction -&gt; Maybe Reduction
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#coercionRedn"><span class="hs-identifier hs-var">coercionRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682668660"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1198"></span><span>
</span><span id="line-1199"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682668663"><span class="annot"><span class="annottext">BuiltInSynFamily
</span><a href="#local-6989586621682668663"><span class="hs-identifier hs-var">builtin_fam</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Maybe BuiltInSynFamily
</span><a href="GHC.Core.TyCon.html#isBuiltInSynFamTyCon_maybe"><span class="hs-identifier hs-var">isBuiltInSynFamTyCon_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668644"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-1200"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682668665"><span class="annot"><span class="annottext">CoAxiomRule
</span><a href="#local-6989586621682668665"><span class="hs-identifier hs-var">rewrite</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682668666"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668666"><span class="hs-identifier hs-var">ts</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682668667"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668667"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BuiltInSynFamily -&gt; [Type] -&gt; Maybe (CoAxiomRule, [Type], Type)
</span><a href="GHC.Builtin.Types.Literals.html#tryMatchFam"><span class="hs-identifier hs-var">tryMatchFam</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltInSynFamily
</span><a href="#local-6989586621682668663"><span class="hs-identifier hs-var">builtin_fam</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668645"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-1201"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682668668"><span class="annot"><span class="annottext">co :: Coercion
</span><a href="#local-6989586621682668668"><span class="hs-identifier hs-var hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoAxiomRule -&gt; [Coercion] -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkAxiomCo"><span class="hs-identifier hs-var">mkAxiomCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiomRule
</span><a href="#local-6989586621682668665"><span class="hs-identifier hs-var">rewrite</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Type -&gt; Coercion) -&gt; [Type] -&gt; [Coercion]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668666"><span class="hs-identifier hs-var">ts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1202"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; Maybe Reduction
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Reduction -&gt; Maybe Reduction) -&gt; Reduction -&gt; Maybe Reduction
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Type -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkReduction"><span class="hs-identifier hs-var">mkReduction</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682668668"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668667"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1203"></span><span>
</span><span id="line-1204"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1205"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Reduction
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1206"></span><span>
</span><span id="line-1207"></span><span class="hs-comment">-- The axiom can be oversaturated. (Closed families only.)</span><span>
</span><span id="line-1208"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#chooseBranch"><span class="hs-identifier hs-type">chooseBranch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#Branched"><span class="hs-identifier hs-type">Branched</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1209"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#BranchIndex"><span class="hs-identifier hs-type">BranchIndex</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- found match, with args</span><span>
</span><span id="line-1210"></span><span id="chooseBranch"><span class="annot"><span class="annottext">chooseBranch :: CoAxiom Branched
-&gt; [Type] -&gt; Maybe (BranchIndex, [Type], [Coercion])
</span><a href="GHC.Core.FamInstEnv.html#chooseBranch"><span class="hs-identifier hs-var hs-var">chooseBranch</span></a></span></span><span> </span><span id="local-6989586621682668672"><span class="annot"><span class="annottext">CoAxiom Branched
</span><a href="#local-6989586621682668672"><span class="hs-identifier hs-var">axiom</span></a></span></span><span> </span><span id="local-6989586621682668673"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668673"><span class="hs-identifier hs-var">tys</span></a></span></span><span>
</span><span id="line-1211"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682668674"><span class="annot"><span class="annottext">num_pats :: BranchIndex
</span><a href="#local-6989586621682668674"><span class="hs-identifier hs-var hs-var hs-var">num_pats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoAxiom Branched -&gt; BranchIndex
forall (br :: BranchFlag). CoAxiom br -&gt; BranchIndex
</span><a href="GHC.Core.Coercion.Axiom.html#coAxiomNumPats"><span class="hs-identifier hs-var">coAxiomNumPats</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiom Branched
</span><a href="#local-6989586621682668672"><span class="hs-identifier hs-var">axiom</span></a></span><span>
</span><span id="line-1212"></span><span>             </span><span class="hs-special">(</span><span id="local-6989586621682668676"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668676"><span class="hs-identifier hs-var hs-var">target_tys</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682668677"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668677"><span class="hs-identifier hs-var hs-var">extra_tys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BranchIndex -&gt; [Type] -&gt; ([Type], [Type])
forall a. BranchIndex -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="annot"><span class="annottext">BranchIndex
</span><a href="#local-6989586621682668674"><span class="hs-identifier hs-var">num_pats</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668673"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-1213"></span><span>             </span><span id="local-6989586621682668678"><span class="annot"><span class="annottext">branches :: Branches Branched
</span><a href="#local-6989586621682668678"><span class="hs-identifier hs-var hs-var hs-var">branches</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoAxiom Branched -&gt; Branches Branched
forall (br :: BranchFlag). CoAxiom br -&gt; Branches br
</span><a href="GHC.Core.Coercion.Axiom.html#coAxiomBranches"><span class="hs-identifier hs-var">coAxiomBranches</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiom Branched
</span><a href="#local-6989586621682668672"><span class="hs-identifier hs-var">axiom</span></a></span><span>
</span><span id="line-1214"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682668680"><span class="annot"><a href="#local-6989586621682668680"><span class="hs-identifier hs-var">ind</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682668681"><span class="annot"><a href="#local-6989586621682668681"><span class="hs-identifier hs-var">inst_tys</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682668682"><span class="annot"><a href="#local-6989586621682668682"><span class="hs-identifier hs-var">inst_cos</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1215"></span><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Array BranchIndex CoAxBranch
-&gt; [Type] -&gt; Maybe (BranchIndex, [Type], [Coercion])
</span><a href="GHC.Core.FamInstEnv.html#findBranch"><span class="hs-identifier hs-var">findBranch</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Branches Branched -&gt; Array BranchIndex CoAxBranch
forall (br :: BranchFlag).
Branches br -&gt; Array BranchIndex CoAxBranch
</span><a href="GHC.Core.Coercion.Axiom.html#unMkBranches"><span class="hs-identifier hs-var">unMkBranches</span></a></span><span> </span><span class="annot"><span class="annottext">Branches Branched
</span><a href="#local-6989586621682668678"><span class="hs-identifier hs-var">branches</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668676"><span class="hs-identifier hs-var">target_tys</span></a></span><span>
</span><span id="line-1216"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="#local-6989586621682668680"><span class="hs-identifier hs-type">ind</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682668681"><span class="hs-identifier hs-type">inst_tys</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#chkAppend"><span class="hs-operator hs-type">`chkAppend`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668677"><span class="hs-identifier hs-type">extra_tys</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682668682"><span class="hs-identifier hs-type">inst_cos</span></a></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1217"></span><span>
</span><span id="line-1218"></span><span class="hs-comment">-- The axiom must *not* be oversaturated</span><span>
</span><span id="line-1219"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#findBranch"><span class="hs-identifier hs-type">findBranch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Array</span></span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#BranchIndex"><span class="hs-identifier hs-type">BranchIndex</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span>
</span><span id="line-1220"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1221"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#BranchIndex"><span class="hs-identifier hs-type">BranchIndex</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1222"></span><span>    </span><span class="hs-comment">-- coercions relate requested types to returned axiom LHS at role N</span><span>
</span><span id="line-1223"></span><span id="findBranch"><span class="annot"><span class="annottext">findBranch :: Array BranchIndex CoAxBranch
-&gt; [Type] -&gt; Maybe (BranchIndex, [Type], [Coercion])
</span><a href="GHC.Core.FamInstEnv.html#findBranch"><span class="hs-identifier hs-var hs-var">findBranch</span></a></span></span><span> </span><span id="local-6989586621682668685"><span class="annot"><span class="annottext">Array BranchIndex CoAxBranch
</span><a href="#local-6989586621682668685"><span class="hs-identifier hs-var">branches</span></a></span></span><span> </span><span id="local-6989586621682668686"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668686"><span class="hs-identifier hs-var">target_tys</span></a></span></span><span>
</span><span id="line-1224"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((BranchIndex, CoAxBranch)
 -&gt; Maybe (BranchIndex, [Type], [Coercion])
 -&gt; Maybe (BranchIndex, [Type], [Coercion]))
-&gt; Maybe (BranchIndex, [Type], [Coercion])
-&gt; [(BranchIndex, CoAxBranch)]
-&gt; Maybe (BranchIndex, [Type], [Coercion])
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="annot"><span class="annottext">(BranchIndex, CoAxBranch)
-&gt; Maybe (BranchIndex, [Type], [Coercion])
-&gt; Maybe (BranchIndex, [Type], [Coercion])
</span><a href="#local-6989586621682668688"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (BranchIndex, [Type], [Coercion])
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Array BranchIndex CoAxBranch -&gt; [(BranchIndex, CoAxBranch)]
forall i e. Ix i =&gt; Array i e -&gt; [(i, e)]
</span><span class="hs-identifier hs-var">assocs</span></span><span> </span><span class="annot"><span class="annottext">Array BranchIndex CoAxBranch
</span><a href="#local-6989586621682668685"><span class="hs-identifier hs-var">branches</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1225"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1226"></span><span>    </span><span class="annot"><a href="#local-6989586621682668688"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#BranchIndex"><span class="hs-identifier hs-type">BranchIndex</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1227"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#BranchIndex"><span class="hs-identifier hs-type">BranchIndex</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1228"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#BranchIndex"><span class="hs-identifier hs-type">BranchIndex</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1229"></span><span>    </span><span id="local-6989586621682668688"><span class="annot"><span class="annottext">go :: (BranchIndex, CoAxBranch)
-&gt; Maybe (BranchIndex, [Type], [Coercion])
-&gt; Maybe (BranchIndex, [Type], [Coercion])
</span><a href="#local-6989586621682668688"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682668689"><span class="annot"><span class="annottext">BranchIndex
</span><a href="#local-6989586621682668689"><span class="hs-identifier hs-var">index</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682668690"><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621682668690"><span class="hs-identifier hs-var">branch</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682668691"><span class="annot"><span class="annottext">Maybe (BranchIndex, [Type], [Coercion])
</span><a href="#local-6989586621682668691"><span class="hs-identifier hs-var">other</span></a></span></span><span>
</span><span id="line-1230"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cab_tvs :: CoAxBranch -&gt; [TyVar]
</span><a href="GHC.Core.Coercion.Axiom.html#cab_tvs"><span class="hs-identifier hs-var">cab_tvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668692"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668692"><span class="hs-identifier hs-var">tpl_tvs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cab_cvs :: CoAxBranch -&gt; [TyVar]
</span><a href="GHC.Core.Coercion.Axiom.html#cab_cvs"><span class="hs-identifier hs-var">cab_cvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668693"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668693"><span class="hs-identifier hs-var">tpl_cvs</span></a></span></span><span>
</span><span id="line-1231"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cab_lhs :: CoAxBranch -&gt; [Type]
</span><a href="GHC.Core.Coercion.Axiom.html#cab_lhs"><span class="hs-identifier hs-var">cab_lhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668694"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668694"><span class="hs-identifier hs-var">tpl_lhs</span></a></span></span><span>
</span><span id="line-1232"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cab_incomps :: CoAxBranch -&gt; [CoAxBranch]
</span><a href="GHC.Core.Coercion.Axiom.html#cab_incomps"><span class="hs-identifier hs-var">cab_incomps</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668695"><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="#local-6989586621682668695"><span class="hs-identifier hs-var">incomps</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621682668690"><span class="hs-identifier hs-var">branch</span></a></span><span>
</span><span id="line-1233"></span><span>            </span><span id="local-6989586621682668696"><span class="annot"><span class="annottext">in_scope :: InScopeSet
</span><a href="#local-6989586621682668696"><span class="hs-identifier hs-var hs-var">in_scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCoVarSet -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#mkInScopeSet"><span class="hs-identifier hs-var">mkInScopeSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TyCoVarSet] -&gt; TyCoVarSet
</span><a href="GHC.Types.Var.Set.html#unionVarSets"><span class="hs-identifier hs-var">unionVarSets</span></a></span><span> </span><span class="annot"><span class="annottext">([TyCoVarSet] -&gt; TyCoVarSet) -&gt; [TyCoVarSet] -&gt; TyCoVarSet
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1234"></span><span>                            </span><span class="annot"><span class="annottext">(CoAxBranch -&gt; TyCoVarSet) -&gt; [CoAxBranch] -&gt; [TyCoVarSet]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type] -&gt; TyCoVarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tyCoVarsOfTypes</span></a></span><span> </span><span class="annot"><span class="annottext">([Type] -&gt; TyCoVarSet)
-&gt; (CoAxBranch -&gt; [Type]) -&gt; CoAxBranch -&gt; TyCoVarSet
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">CoAxBranch -&gt; [Type]
</span><a href="GHC.Core.Coercion.Axiom.html#coAxBranchLHS"><span class="hs-identifier hs-var">coAxBranchLHS</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="#local-6989586621682668695"><span class="hs-identifier hs-var">incomps</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1235"></span><span>            </span><span class="hs-comment">-- See Note [Flattening type-family applications when matching instances]</span><span>
</span><span id="line-1236"></span><span>            </span><span class="hs-comment">-- in GHC.Core.Unify</span><span>
</span><span id="line-1237"></span><span>            </span><span id="local-6989586621682668699"><span class="annot"><span class="annottext">flattened_target :: [Type]
</span><a href="#local-6989586621682668699"><span class="hs-identifier hs-var hs-var">flattened_target</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; [Type] -&gt; [Type]
</span><a href="GHC.Core.Unify.html#flattenTys"><span class="hs-identifier hs-var">flattenTys</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682668696"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668686"><span class="hs-identifier hs-var">target_tys</span></a></span><span>
</span><span id="line-1238"></span><span>        </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; [Type] -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tcMatchTys"><span class="hs-identifier hs-var">tcMatchTys</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668694"><span class="hs-identifier hs-var">tpl_lhs</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668686"><span class="hs-identifier hs-var">target_tys</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1239"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682668701"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682668701"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-comment">-- matching worked. now, check for apartness.</span><span>
</span><span id="line-1240"></span><span>          </span><span class="hs-glyph">|</span><span>  </span><span class="annot"><span class="annottext">[Type] -&gt; CoAxBranch -&gt; Bool
</span><a href="GHC.Core.FamInstEnv.html#apartnessCheck"><span class="hs-identifier hs-var">apartnessCheck</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668699"><span class="hs-identifier hs-var">flattened_target</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621682668690"><span class="hs-identifier hs-var">branch</span></a></span><span>
</span><span id="line-1241"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- matching worked &amp; we're apart from all incompatible branches.</span><span>
</span><span id="line-1242"></span><span>             </span><span class="hs-comment">-- success</span><span>
</span><span id="line-1243"></span><span>             </span><span class="annot"><span class="annottext">Bool
-&gt; Maybe (BranchIndex, [Type], [Coercion])
-&gt; Maybe (BranchIndex, [Type], [Coercion])
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TyVar -&gt; Bool) -&gt; [TyVar] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Coercion -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Coercion -&gt; Bool)
-&gt; (TyVar -&gt; Maybe Coercion) -&gt; TyVar -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Subst -&gt; TyVar -&gt; Maybe Coercion
</span><a href="GHC.Core.TyCo.Subst.html#lookupCoVar"><span class="hs-identifier hs-var">lookupCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682668701"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668693"><span class="hs-identifier hs-var">tpl_cvs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe (BranchIndex, [Type], [Coercion])
 -&gt; Maybe (BranchIndex, [Type], [Coercion]))
-&gt; Maybe (BranchIndex, [Type], [Coercion])
-&gt; Maybe (BranchIndex, [Type], [Coercion])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1244"></span><span>             </span><span class="annot"><span class="annottext">(BranchIndex, [Type], [Coercion])
-&gt; Maybe (BranchIndex, [Type], [Coercion])
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BranchIndex
</span><a href="#local-6989586621682668689"><span class="hs-identifier hs-var">index</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; [TyVar] -&gt; [Type]
</span><a href="GHC.Core.TyCo.Subst.html#substTyVars"><span class="hs-identifier hs-var">substTyVars</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682668701"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668692"><span class="hs-identifier hs-var">tpl_tvs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; [TyVar] -&gt; [Coercion]
</span><a href="GHC.Core.TyCo.Subst.html#substCoVars"><span class="hs-identifier hs-var">substCoVars</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682668701"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682668693"><span class="hs-identifier hs-var">tpl_cvs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1245"></span><span>
</span><span id="line-1246"></span><span>        </span><span class="hs-comment">-- failure. keep looking</span><span>
</span><span id="line-1247"></span><span>        </span><span class="annot"><span class="annottext">Maybe Subst
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (BranchIndex, [Type], [Coercion])
</span><a href="#local-6989586621682668691"><span class="hs-identifier hs-var">other</span></a></span><span>
</span><span id="line-1248"></span><span>
</span><span id="line-1249"></span><span class="hs-comment">-- | Do an apartness check, as described in the &quot;Closed Type Families&quot; paper</span><span>
</span><span id="line-1250"></span><span class="hs-comment">-- (POPL '14). This should be used when determining if an equation</span><span>
</span><span id="line-1251"></span><span class="hs-comment">-- ('CoAxBranch') of a closed type family can be used to reduce a certain target</span><span>
</span><span id="line-1252"></span><span class="hs-comment">-- type family application.</span><span>
</span><span id="line-1253"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#apartnessCheck"><span class="hs-identifier hs-type">apartnessCheck</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1254"></span><span>  </span><span class="hs-comment">-- ^ /flattened/ target arguments. Make sure they're flattened! See</span><span>
</span><span id="line-1255"></span><span>  </span><span class="hs-comment">-- Note [Flattening type-family applications when matching instances]</span><span>
</span><span id="line-1256"></span><span>  </span><span class="hs-comment">-- in GHC.Core.Unify.</span><span>
</span><span id="line-1257"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span> </span><span class="hs-comment">-- ^ the candidate equation we wish to use</span><span>
</span><span id="line-1258"></span><span>                             </span><span class="hs-comment">-- Precondition: this matches the target</span><span>
</span><span id="line-1259"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>       </span><span class="annot"><span class="hs-comment">-- ^ True &lt;=&gt; equation can fire</span></span><span>
</span><span id="line-1260"></span><span id="apartnessCheck"><span class="annot"><span class="annottext">apartnessCheck :: [Type] -&gt; CoAxBranch -&gt; Bool
</span><a href="GHC.Core.FamInstEnv.html#apartnessCheck"><span class="hs-identifier hs-var hs-var">apartnessCheck</span></a></span></span><span> </span><span id="local-6989586621682668702"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668702"><span class="hs-identifier hs-var">flattened_target</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cab_incomps :: CoAxBranch -&gt; [CoAxBranch]
</span><a href="GHC.Core.Coercion.Axiom.html#cab_incomps"><span class="hs-identifier hs-var">cab_incomps</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668703"><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="#local-6989586621682668703"><span class="hs-identifier hs-var">incomps</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1261"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoAxBranch -&gt; Bool) -&gt; [CoAxBranch] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UnifyResult -&gt; Bool
forall {a}. UnifyResultM a -&gt; Bool
</span><a href="#local-6989586621682668704"><span class="hs-identifier hs-var">isSurelyApart</span></a></span><span>
</span><span id="line-1262"></span><span>         </span><span class="annot"><span class="annottext">(UnifyResult -&gt; Bool)
-&gt; (CoAxBranch -&gt; UnifyResult) -&gt; CoAxBranch -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">BindFun -&gt; [Type] -&gt; [Type] -&gt; UnifyResult
</span><a href="GHC.Core.Unify.html#tcUnifyTysFG"><span class="hs-identifier hs-var">tcUnifyTysFG</span></a></span><span> </span><span class="annot"><span class="annottext">BindFun
</span><a href="GHC.Core.Unify.html#alwaysBindFun"><span class="hs-identifier hs-var">alwaysBindFun</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668702"><span class="hs-identifier hs-var">flattened_target</span></a></span><span>
</span><span id="line-1263"></span><span>         </span><span class="annot"><span class="annottext">([Type] -&gt; UnifyResult)
-&gt; (CoAxBranch -&gt; [Type]) -&gt; CoAxBranch -&gt; UnifyResult
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">CoAxBranch -&gt; [Type]
</span><a href="GHC.Core.Coercion.Axiom.html#coAxBranchLHS"><span class="hs-identifier hs-var">coAxBranchLHS</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="#local-6989586621682668703"><span class="hs-identifier hs-var">incomps</span></a></span><span>
</span><span id="line-1264"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1265"></span><span>    </span><span id="local-6989586621682668704"><span class="annot"><span class="annottext">isSurelyApart :: UnifyResultM a -&gt; Bool
</span><a href="#local-6989586621682668704"><span class="hs-identifier hs-var hs-var">isSurelyApart</span></a></span></span><span> </span><span class="annot"><span class="annottext">UnifyResultM a
</span><a href="GHC.Core.Unify.html#SurelyApart"><span class="hs-identifier hs-var">SurelyApart</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1266"></span><span>    </span><span class="annot"><a href="#local-6989586621682668704"><span class="hs-identifier hs-var">isSurelyApart</span></a></span><span> </span><span class="annot"><span class="annottext">UnifyResultM a
</span><span class="hs-identifier">_</span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1267"></span><span>
</span><span id="line-1268"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Looking up a family instance
*                                                                      *
************************************************************************

Note [Normalising types]
~~~~~~~~~~~~~~~~~~~~~~~~
The topNormaliseType function removes all occurrences of type families
and newtypes from the top-level structure of a type. normaliseTcApp does
the type family lookup and is fairly straightforward. normaliseType is
a little more involved.

The complication comes from the fact that a type family might be used in the
kind of a variable bound in a forall. We wish to remove this type family
application, but that means coming up with a fresh variable (with the new
kind). Thus, we need a substitution to be built up as we recur through the
type. However, an ordinary TCvSubst just won't do: when we hit a type variable
whose kind has changed during normalisation, we need both the new type
variable *and* the coercion. We could conjure up a new VarEnv with just this
property, but a usable substitution environment already exists:
LiftingContexts from the liftCoSubst family of functions, defined in GHC.Core.Coercion.
A LiftingContext maps a type variable to a coercion and a coercion variable to
a pair of coercions. Let's ignore coercion variables for now. Because the
coercion a type variable maps to contains the destination type (via
coercionKind), we don't need to store that destination type separately. Thus,
a LiftingContext has what we need: a map from type variables to (Coercion,
Type) pairs.

We also benefit because we can piggyback on the liftCoSubstVarBndr function to
deal with binders. However, I had to modify that function to work with this
application. Thus, we now have liftCoSubstVarBndrUsing, which takes
a function used to process the kind of the binder. We don't wish
to lift the kind, but instead normalise it. So, we pass in a callback function
that processes the kind of the binder.

After that brilliant explanation of all this, I'm sure you've forgotten the
dangling reference to coercion variables. What do we do with those? Nothing at
all. The point of normalising types is to remove type family applications, but
there's no sense in removing these from coercions. We would just get back a
new coercion witnessing the equality between the same types as the original
coercion. Because coercions are irrelevant anyway, there is no point in doing
this. So, whenever we encounter a coercion, we just say that it won't change.
That's what the CoercionTy case is doing within normalise_type.

Note [Normalisation and type synonyms]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We need to be a bit careful about normalising in the presence of type
synonyms (#13035).  Suppose S is a type synonym, and we have
   S t1 t2
If S is family-free (on its RHS) we can just normalise t1 and t2 and
reconstruct (S t1' t2').   Expanding S could not reveal any new redexes
because type families are saturated.

But if S has a type family on its RHS we expand /before/ normalising
the args t1, t2.  If we normalise t1, t2 first, we'll re-normalise them
after expansion, and that can lead to /exponential/ behaviour; see #13035.

Notice, though, that expanding first can in principle duplicate t1,t2,
which might contain redexes. I'm sure you could conjure up an exponential
case by that route too, but it hasn't happened in practice yet!
-}</span><span>
</span><span id="line-1331"></span><span>
</span><span id="line-1332"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#topNormaliseType"><span class="hs-identifier hs-type">topNormaliseType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-1333"></span><span id="topNormaliseType"><span class="annot"><span class="annottext">topNormaliseType :: (FamInstEnv, FamInstEnv) -&gt; Type -&gt; Type
</span><a href="GHC.Core.FamInstEnv.html#topNormaliseType"><span class="hs-identifier hs-var hs-var">topNormaliseType</span></a></span></span><span> </span><span id="local-6989586621682668705"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621682668705"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682668706"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668706"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-1334"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv) -&gt; Type -&gt; Maybe Reduction
</span><a href="GHC.Core.FamInstEnv.html#topNormaliseType_maybe"><span class="hs-identifier hs-var">topNormaliseType_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621682668705"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668706"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1335"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682668707"><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682668707"><span class="hs-identifier hs-var">redn</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; Type
</span><a href="GHC.Core.Reduction.html#reductionReducedType"><span class="hs-identifier hs-var">reductionReducedType</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682668707"><span class="hs-identifier hs-var">redn</span></a></span><span>
</span><span id="line-1336"></span><span>      </span><span class="annot"><span class="annottext">Maybe Reduction
</span><span class="hs-identifier hs-var">Nothing</span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668706"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1337"></span><span>
</span><span id="line-1338"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#topNormaliseType_maybe"><span class="hs-identifier hs-type">topNormaliseType_maybe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span>
</span><span id="line-1339"></span><span>
</span><span id="line-1340"></span><span class="hs-comment">-- ^ Get rid of *outermost* (or toplevel)</span><span>
</span><span id="line-1341"></span><span class="hs-comment">--      * type function redex</span><span>
</span><span id="line-1342"></span><span class="hs-comment">--      * data family redex</span><span>
</span><span id="line-1343"></span><span class="hs-comment">--      * newtypes</span><span>
</span><span id="line-1344"></span><span class="hs-comment">-- returning an appropriate Representational coercion.  Specifically, if</span><span>
</span><span id="line-1345"></span><span class="hs-comment">--   topNormaliseType_maybe env ty = Just (co, ty')</span><span>
</span><span id="line-1346"></span><span class="hs-comment">-- then</span><span>
</span><span id="line-1347"></span><span class="hs-comment">--   (a) co :: ty ~R ty'</span><span>
</span><span id="line-1348"></span><span class="hs-comment">--   (b) ty' is not a newtype, and is not a type-family or data-family redex</span><span>
</span><span id="line-1349"></span><span class="hs-comment">--</span><span>
</span><span id="line-1350"></span><span class="hs-comment">-- However, ty' can be something like (Maybe (F ty)), where</span><span>
</span><span id="line-1351"></span><span class="hs-comment">-- (F ty) is a redex.</span><span>
</span><span id="line-1352"></span><span class="hs-comment">--</span><span>
</span><span id="line-1353"></span><span class="hs-comment">-- Always operates homogeneously: the returned type has the same kind as the</span><span>
</span><span id="line-1354"></span><span class="hs-comment">-- original type, and the returned coercion is always homogeneous.</span><span>
</span><span id="line-1355"></span><span id="topNormaliseType_maybe"><span class="annot"><span class="annottext">topNormaliseType_maybe :: (FamInstEnv, FamInstEnv) -&gt; Type -&gt; Maybe Reduction
</span><a href="GHC.Core.FamInstEnv.html#topNormaliseType_maybe"><span class="hs-identifier hs-var hs-var">topNormaliseType_maybe</span></a></span></span><span> </span><span id="local-6989586621682668709"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621682668709"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682668710"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668710"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-1356"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621682668711"><span class="annot"><a href="#local-6989586621682668711"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682668712"><span class="annot"><a href="#local-6989586621682668712"><span class="hs-identifier hs-var">mkind_co</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621682668713"><span class="annot"><a href="#local-6989586621682668713"><span class="hs-identifier hs-var">nty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">NormaliseStepper (Coercion, MCoercionN)
-&gt; ((Coercion, MCoercionN)
    -&gt; (Coercion, MCoercionN) -&gt; (Coercion, MCoercionN))
-&gt; Type
-&gt; Maybe ((Coercion, MCoercionN), Type)
forall ev.
NormaliseStepper ev -&gt; (ev -&gt; ev -&gt; ev) -&gt; Type -&gt; Maybe (ev, Type)
</span><a href="GHC.Core.Coercion.html#topNormaliseTypeX"><span class="hs-identifier hs-var">topNormaliseTypeX</span></a></span><span> </span><span class="annot"><span class="annottext">NormaliseStepper (Coercion, MCoercionN)
</span><a href="#local-6989586621682668715"><span class="hs-identifier hs-var">stepper</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion, MCoercionN)
-&gt; (Coercion, MCoercionN) -&gt; (Coercion, MCoercionN)
</span><a href="#local-6989586621682668716"><span class="hs-identifier hs-var">combine</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668710"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1357"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682668717"><span class="annot"><a href="#local-6989586621682668717"><span class="hs-identifier hs-var hs-var">hredn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; MCoercionN -&gt; HetReduction
</span><a href="GHC.Core.Reduction.html#mkHetReduction"><span class="hs-identifier hs-var">mkHetReduction</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; Type -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkReduction"><span class="hs-identifier hs-var">mkReduction</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682668711"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668713"><span class="hs-identifier hs-var">nty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">MCoercionN
</span><a href="#local-6989586621682668712"><span class="hs-identifier hs-var">mkind_co</span></a></span><span>
</span><span id="line-1358"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#homogeniseHetRedn"><span class="hs-identifier hs-type">homogeniseHetRedn</span></a></span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Representational"><span class="hs-identifier hs-type">Representational</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668717"><span class="hs-identifier hs-type">hredn</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1359"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1360"></span><span>    </span><span id="local-6989586621682668715"><span class="annot"><span class="annottext">stepper :: NormaliseStepper (Coercion, MCoercionN)
</span><a href="#local-6989586621682668715"><span class="hs-identifier hs-var hs-var">stepper</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NormaliseStepper (Coercion, MCoercionN)
</span><a href="#local-6989586621682668720"><span class="hs-identifier hs-var">unwrapNewTypeStepper'</span></a></span><span> </span><span class="annot"><span class="annottext">NormaliseStepper (Coercion, MCoercionN)
-&gt; NormaliseStepper (Coercion, MCoercionN)
-&gt; NormaliseStepper (Coercion, MCoercionN)
forall ev.
NormaliseStepper ev -&gt; NormaliseStepper ev -&gt; NormaliseStepper ev
</span><a href="GHC.Core.Coercion.html#composeSteppers"><span class="hs-operator hs-var">`composeSteppers`</span></a></span><span> </span><span class="annot"><span class="annottext">NormaliseStepper (Coercion, MCoercionN)
</span><a href="#local-6989586621682668722"><span class="hs-identifier hs-var">tyFamStepper</span></a></span><span>
</span><span id="line-1361"></span><span>
</span><span id="line-1362"></span><span>    </span><span id="local-6989586621682668716"><span class="annot"><span class="annottext">combine :: (Coercion, MCoercionN)
-&gt; (Coercion, MCoercionN) -&gt; (Coercion, MCoercionN)
</span><a href="#local-6989586621682668716"><span class="hs-identifier hs-var hs-var">combine</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682668724"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682668724"><span class="hs-identifier hs-var">c1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682668725"><span class="annot"><span class="annottext">MCoercionN
</span><a href="#local-6989586621682668725"><span class="hs-identifier hs-var">mc1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682668726"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682668726"><span class="hs-identifier hs-var">c2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682668727"><span class="annot"><span class="annottext">MCoercionN
</span><a href="#local-6989586621682668727"><span class="hs-identifier hs-var">mc2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682668724"><span class="hs-identifier hs-var">c1</span></a></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Coercion -&gt; Coercion
Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkTransCo"><span class="hs-operator hs-var">`mkTransCo`</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682668726"><span class="hs-identifier hs-var">c2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MCoercionN
</span><a href="#local-6989586621682668725"><span class="hs-identifier hs-var">mc1</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercionN -&gt; MCoercionN -&gt; MCoercionN
</span><a href="GHC.Core.Coercion.html#mkTransMCo"><span class="hs-operator hs-var">`mkTransMCo`</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercionN
</span><a href="#local-6989586621682668727"><span class="hs-identifier hs-var">mc2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1363"></span><span>
</span><span id="line-1364"></span><span>    </span><span class="annot"><a href="#local-6989586621682668720"><span class="hs-identifier hs-type">unwrapNewTypeStepper'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#NormaliseStepper"><span class="hs-identifier hs-type">NormaliseStepper</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCoercionN"><span class="hs-identifier hs-type">MCoercionN</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1365"></span><span>    </span><span id="local-6989586621682668720"><span class="annot"><span class="annottext">unwrapNewTypeStepper' :: NormaliseStepper (Coercion, MCoercionN)
</span><a href="#local-6989586621682668720"><span class="hs-identifier hs-var hs-var">unwrapNewTypeStepper'</span></a></span></span><span> </span><span id="local-6989586621682668730"><span class="annot"><span class="annottext">RecTcChecker
</span><a href="#local-6989586621682668730"><span class="hs-identifier hs-var">rec_nts</span></a></span></span><span> </span><span id="local-6989586621682668731"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668731"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621682668732"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668732"><span class="hs-identifier hs-var">tys</span></a></span></span><span>
</span><span id="line-1366"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MCoercionN
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; (Coercion, MCoercionN))
-&gt; NormaliseStepResult Coercion
-&gt; NormaliseStepResult (Coercion, MCoercionN)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">NormaliseStepper Coercion
</span><a href="GHC.Core.Coercion.html#unwrapNewTypeStepper"><span class="hs-identifier hs-var">unwrapNewTypeStepper</span></a></span><span> </span><span class="annot"><span class="annottext">RecTcChecker
</span><a href="#local-6989586621682668730"><span class="hs-identifier hs-var">rec_nts</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668731"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668732"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-1367"></span><span>
</span><span id="line-1368"></span><span>      </span><span class="hs-comment">-- second coercion below is the kind coercion relating the original type's kind</span><span>
</span><span id="line-1369"></span><span>      </span><span class="hs-comment">-- to the normalised type's kind</span><span>
</span><span id="line-1370"></span><span>    </span><span class="annot"><a href="#local-6989586621682668722"><span class="hs-identifier hs-type">tyFamStepper</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#NormaliseStepper"><span class="hs-identifier hs-type">NormaliseStepper</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCoercionN"><span class="hs-identifier hs-type">MCoercionN</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1371"></span><span>    </span><span id="local-6989586621682668722"><span class="annot"><span class="annottext">tyFamStepper :: NormaliseStepper (Coercion, MCoercionN)
</span><a href="#local-6989586621682668722"><span class="hs-identifier hs-var hs-var">tyFamStepper</span></a></span></span><span> </span><span id="local-6989586621682668736"><span class="annot"><span class="annottext">RecTcChecker
</span><a href="#local-6989586621682668736"><span class="hs-identifier hs-var">rec_nts</span></a></span></span><span> </span><span id="local-6989586621682668737"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668737"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621682668738"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668738"><span class="hs-identifier hs-var">tys</span></a></span></span><span>  </span><span class="hs-comment">-- Try to step a type/data family</span><span>
</span><span id="line-1372"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv) -&gt; TyCon -&gt; [Type] -&gt; Maybe HetReduction
</span><a href="GHC.Core.FamInstEnv.html#topReduceTyFamApp_maybe"><span class="hs-identifier hs-var">topReduceTyFamApp_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621682668709"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668737"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668738"><span class="hs-identifier hs-var">tys</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1373"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Reduction.html#HetReduction"><span class="hs-identifier hs-type">HetReduction</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span> </span><span id="local-6989586621682668741"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682668741"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span id="local-6989586621682668742"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668742"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682668743"><span class="annot"><span class="annottext">MCoercionN
</span><a href="#local-6989586621682668743"><span class="hs-identifier hs-var">res_co</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1374"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RecTcChecker
-&gt; Type
-&gt; (Coercion, MCoercionN)
-&gt; NormaliseStepResult (Coercion, MCoercionN)
forall ev. RecTcChecker -&gt; Type -&gt; ev -&gt; NormaliseStepResult ev
</span><a href="GHC.Core.Coercion.html#NS_Step"><span class="hs-identifier hs-var">NS_Step</span></a></span><span> </span><span class="annot"><span class="annottext">RecTcChecker
</span><a href="#local-6989586621682668736"><span class="hs-identifier hs-var">rec_nts</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668742"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682668741"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MCoercionN
</span><a href="#local-6989586621682668743"><span class="hs-identifier hs-var">res_co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1375"></span><span>          </span><span class="annot"><span class="annottext">Maybe HetReduction
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">NormaliseStepResult (Coercion, MCoercionN)
forall ev. NormaliseStepResult ev
</span><a href="GHC.Core.Coercion.html#NS_Done"><span class="hs-identifier hs-var">NS_Done</span></a></span><span>
</span><span id="line-1376"></span><span>
</span><span id="line-1377"></span><span class="hs-comment">---------------</span><span>
</span><span id="line-1378"></span><span class="hs-comment">-- | Try to simplify a type-family application, by *one* step</span><span>
</span><span id="line-1379"></span><span class="hs-comment">-- If topReduceTyFamApp_maybe env r F tys = Just (HetReduction (Reduction co rhs) res_co)</span><span>
</span><span id="line-1380"></span><span class="hs-comment">-- then    co     :: F tys ~R# rhs</span><span>
</span><span id="line-1381"></span><span class="hs-comment">--         res_co :: typeKind(F tys) ~ typeKind(rhs)</span><span>
</span><span id="line-1382"></span><span class="hs-comment">-- Type families and data families; always Representational role</span><span>
</span><span id="line-1383"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#topReduceTyFamApp_maybe"><span class="hs-identifier hs-type">topReduceTyFamApp_maybe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1384"></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#HetReduction"><span class="hs-identifier hs-type">HetReduction</span></a></span><span>
</span><span id="line-1385"></span><span id="topReduceTyFamApp_maybe"><span class="annot"><span class="annottext">topReduceTyFamApp_maybe :: (FamInstEnv, FamInstEnv) -&gt; TyCon -&gt; [Type] -&gt; Maybe HetReduction
</span><a href="GHC.Core.FamInstEnv.html#topReduceTyFamApp_maybe"><span class="hs-identifier hs-var hs-var">topReduceTyFamApp_maybe</span></a></span></span><span> </span><span id="local-6989586621682668746"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621682668746"><span class="hs-identifier hs-var">envs</span></a></span></span><span> </span><span id="local-6989586621682668747"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668747"><span class="hs-identifier hs-var">fam_tc</span></a></span></span><span> </span><span id="local-6989586621682668748"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668748"><span class="hs-identifier hs-var">arg_tys</span></a></span></span><span>
</span><span id="line-1386"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isFamilyTyCon"><span class="hs-identifier hs-var">isFamilyTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668747"><span class="hs-identifier hs-var">fam_tc</span></a></span><span>   </span><span class="hs-comment">-- type families and data families</span><span>
</span><span id="line-1387"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682668750"><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682668750"><span class="hs-identifier hs-var">redn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
-&gt; Role -&gt; TyCon -&gt; [Type] -&gt; Maybe Reduction
</span><a href="GHC.Core.FamInstEnv.html#reduceTyFamApp_maybe"><span class="hs-identifier hs-var">reduceTyFamApp_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621682668746"><span class="hs-identifier hs-var">envs</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682668751"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668747"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668752"><span class="hs-identifier hs-var">ntys</span></a></span><span>
</span><span id="line-1388"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HetReduction -&gt; Maybe HetReduction
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(HetReduction -&gt; Maybe HetReduction)
-&gt; HetReduction -&gt; Maybe HetReduction
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1389"></span><span>      </span><span class="annot"><span class="annottext">Reduction -&gt; MCoercionN -&gt; HetReduction
</span><a href="GHC.Core.Reduction.html#mkHetReduction"><span class="hs-identifier hs-var">mkHetReduction</span></a></span><span>
</span><span id="line-1390"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Role -&gt; TyCon -&gt; [Coercion] -&gt; Coercion
Role -&gt; TyCon -&gt; [Coercion] -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-var">mkTyConAppCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682668751"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668747"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682668754"><span class="hs-identifier hs-var">args_cos</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Reduction -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkTransRedn"><span class="hs-operator hs-var">`mkTransRedn`</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682668750"><span class="hs-identifier hs-var">redn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1391"></span><span>        </span><span class="annot"><span class="annottext">MCoercionN
</span><a href="#local-6989586621682668756"><span class="hs-identifier hs-var">res_co</span></a></span><span>
</span><span id="line-1392"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1393"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe HetReduction
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1394"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1395"></span><span>    </span><span id="local-6989586621682668751"><span class="annot"><span class="annottext">role :: Role
</span><a href="#local-6989586621682668751"><span class="hs-keyword hs-var hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Representational"><span class="hs-identifier hs-var">Representational</span></a></span><span>
</span><span id="line-1396"></span><span>    </span><span class="annot"><a href="GHC.Core.Reduction.html#ArgsReductions"><span class="hs-identifier hs-type">ArgsReductions</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Reduction.html#Reductions"><span class="hs-identifier hs-type">Reductions</span></a></span><span> </span><span id="local-6989586621682668754"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682668754"><span class="hs-identifier hs-var">args_cos</span></a></span></span><span> </span><span id="local-6989586621682668752"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668752"><span class="hs-identifier hs-var">ntys</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682668756"><span class="annot"><span class="annottext">MCoercionN
</span><a href="#local-6989586621682668756"><span class="hs-identifier hs-var">res_co</span></a></span></span><span>
</span><span id="line-1397"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
-&gt; Role -&gt; TyCoVarSet -&gt; NormM ArgsReductions -&gt; ArgsReductions
forall a.
(FamInstEnv, FamInstEnv) -&gt; Role -&gt; TyCoVarSet -&gt; NormM a -&gt; a
</span><a href="GHC.Core.FamInstEnv.html#initNormM"><span class="hs-identifier hs-var">initNormM</span></a></span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621682668746"><span class="hs-identifier hs-var">envs</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682668751"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type] -&gt; TyCoVarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tyCoVarsOfTypes</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668748"><span class="hs-identifier hs-var">arg_tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1398"></span><span>      </span><span class="annot"><span class="annottext">(NormM ArgsReductions -&gt; ArgsReductions)
-&gt; NormM ArgsReductions -&gt; ArgsReductions
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; NormM ArgsReductions
</span><a href="GHC.Core.FamInstEnv.html#normalise_tc_args"><span class="hs-identifier hs-var">normalise_tc_args</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668747"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668748"><span class="hs-identifier hs-var">arg_tys</span></a></span><span>
</span><span id="line-1399"></span><span>
</span><span id="line-1400"></span><span class="hs-comment">---------------</span><span>
</span><span id="line-1401"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#normaliseType"><span class="hs-identifier hs-type">normaliseType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a></span><span>
</span><span id="line-1402"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span>  </span><span class="hs-comment">-- desired role of coercion</span><span>
</span><span id="line-1403"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span>
</span><span id="line-1404"></span><span id="normaliseType"><span class="annot"><span class="annottext">normaliseType :: (FamInstEnv, FamInstEnv) -&gt; Role -&gt; Type -&gt; Reduction
</span><a href="GHC.Core.FamInstEnv.html#normaliseType"><span class="hs-identifier hs-var hs-var">normaliseType</span></a></span></span><span> </span><span id="local-6989586621682668761"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621682668761"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682668762"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682668762"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span id="local-6989586621682668763"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668763"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-1405"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
-&gt; Role -&gt; TyCoVarSet -&gt; NormM Reduction -&gt; Reduction
forall a.
(FamInstEnv, FamInstEnv) -&gt; Role -&gt; TyCoVarSet -&gt; NormM a -&gt; a
</span><a href="GHC.Core.FamInstEnv.html#initNormM"><span class="hs-identifier hs-var">initNormM</span></a></span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621682668761"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682668762"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; TyCoVarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668763"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(NormM Reduction -&gt; Reduction) -&gt; NormM Reduction -&gt; Reduction
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; NormM Reduction
</span><a href="GHC.Core.FamInstEnv.html#normalise_type"><span class="hs-identifier hs-var">normalise_type</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668763"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1406"></span><span>
</span><span id="line-1407"></span><span class="hs-comment">---------------</span><span>
</span><span id="line-1408"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#normaliseTcApp"><span class="hs-identifier hs-type">normaliseTcApp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span>
</span><span id="line-1409"></span><span class="hs-comment">-- See comments on normaliseType for the arguments of this function</span><span>
</span><span id="line-1410"></span><span id="normaliseTcApp"><span class="annot"><span class="annottext">normaliseTcApp :: (FamInstEnv, FamInstEnv) -&gt; Role -&gt; TyCon -&gt; [Type] -&gt; Reduction
</span><a href="GHC.Core.FamInstEnv.html#normaliseTcApp"><span class="hs-identifier hs-var hs-var">normaliseTcApp</span></a></span></span><span> </span><span id="local-6989586621682668766"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621682668766"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682668767"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682668767"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span id="local-6989586621682668768"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668768"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621682668769"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668769"><span class="hs-identifier hs-var">tys</span></a></span></span><span>
</span><span id="line-1411"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
-&gt; Role -&gt; TyCoVarSet -&gt; NormM Reduction -&gt; Reduction
forall a.
(FamInstEnv, FamInstEnv) -&gt; Role -&gt; TyCoVarSet -&gt; NormM a -&gt; a
</span><a href="GHC.Core.FamInstEnv.html#initNormM"><span class="hs-identifier hs-var">initNormM</span></a></span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621682668766"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682668767"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type] -&gt; TyCoVarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tyCoVarsOfTypes</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668769"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(NormM Reduction -&gt; Reduction) -&gt; NormM Reduction -&gt; Reduction
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1412"></span><span>    </span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; NormM Reduction
</span><a href="GHC.Core.FamInstEnv.html#normalise_tc_app"><span class="hs-identifier hs-var">normalise_tc_app</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668768"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668769"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-1413"></span><span>
</span><span id="line-1414"></span><span class="hs-comment">-------------------------------------------------------</span><span>
</span><span id="line-1415"></span><span class="hs-comment">--        Functions that work in the NormM monad</span><span>
</span><span id="line-1416"></span><span class="hs-comment">-------------------------------------------------------</span><span>
</span><span id="line-1417"></span><span>
</span><span id="line-1418"></span><span class="hs-comment">-- See Note [Normalising types] about the LiftingContext</span><span>
</span><span id="line-1419"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#normalise_tc_app"><span class="hs-identifier hs-type">normalise_tc_app</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span>
</span><span id="line-1420"></span><span id="normalise_tc_app"><span class="annot"><span class="annottext">normalise_tc_app :: TyCon -&gt; [Type] -&gt; NormM Reduction
</span><a href="GHC.Core.FamInstEnv.html#normalise_tc_app"><span class="hs-identifier hs-var hs-var">normalise_tc_app</span></a></span></span><span> </span><span id="local-6989586621682668771"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668771"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621682668772"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668772"><span class="hs-identifier hs-var">tys</span></a></span></span><span>
</span><span id="line-1421"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#ExpandsSyn"><span class="hs-identifier hs-type">ExpandsSyn</span></a></span><span> </span><span id="local-6989586621682668774"><span class="annot"><span class="annottext">[(TyVar, Type)]
</span><a href="#local-6989586621682668774"><span class="hs-identifier hs-var">tenv</span></a></span></span><span> </span><span id="local-6989586621682668775"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668775"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span id="local-6989586621682668776"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668776"><span class="hs-identifier hs-var">tys'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; ExpandSynResult Type
forall tyco. TyCon -&gt; [tyco] -&gt; ExpandSynResult tyco
</span><a href="GHC.Core.TyCon.html#expandSynTyCon_maybe"><span class="hs-identifier hs-var">expandSynTyCon_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668771"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668772"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-1422"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isFamFreeTyCon"><span class="hs-identifier hs-var">isFamFreeTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668771"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Expand and try again</span><span>
</span><span id="line-1423"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- A synonym with type families in the RHS</span><span>
</span><span id="line-1424"></span><span>    </span><span class="hs-comment">-- Expand and try again</span><span>
</span><span id="line-1425"></span><span>    </span><span class="hs-comment">-- See Note [Normalisation and type synonyms]</span><span>
</span><span id="line-1426"></span><span>    </span><span class="annot"><span class="annottext">Type -&gt; NormM Reduction
</span><a href="GHC.Core.FamInstEnv.html#normalise_type"><span class="hs-identifier hs-var">normalise_type</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; [Type] -&gt; Type
</span><a href="GHC.Core.Type.html#mkAppTys"><span class="hs-identifier hs-var">mkAppTys</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Type -&gt; Type
Subst -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Subst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(TyVar, Type)] -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#mkTvSubstPrs"><span class="hs-identifier hs-var">mkTvSubstPrs</span></a></span><span> </span><span class="annot"><span class="annottext">[(TyVar, Type)]
</span><a href="#local-6989586621682668774"><span class="hs-identifier hs-var">tenv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668775"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668776"><span class="hs-identifier hs-var">tys'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1427"></span><span>
</span><span id="line-1428"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isFamilyTyCon"><span class="hs-identifier hs-var">isFamilyTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668771"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-1429"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- A type-family application</span><span>
</span><span id="line-1430"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682668781"><span class="annot"><a href="#local-6989586621682668781"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">NormM (FamInstEnv, FamInstEnv)
</span><a href="GHC.Core.FamInstEnv.html#getEnv"><span class="hs-identifier hs-var">getEnv</span></a></span><span>
</span><span id="line-1431"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682668783"><span class="annot"><a href="#local-6989586621682668783"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#getRole"><span class="hs-identifier hs-type">getRole</span></a></span><span>
</span><span id="line-1432"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#ArgsReductions"><span class="hs-identifier hs-type">ArgsReductions</span></a></span><span> </span><span id="local-6989586621682668785"><span class="annot"><a href="#local-6989586621682668785"><span class="hs-identifier hs-var">redns</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Reduction.html#Reductions"><span class="hs-identifier hs-type">Reductions</span></a></span><span> </span><span id="local-6989586621682668786"><span class="annot"><a href="#local-6989586621682668786"><span class="hs-identifier hs-var">args_cos</span></a></span></span><span> </span><span id="local-6989586621682668787"><span class="annot"><a href="#local-6989586621682668787"><span class="hs-identifier hs-var">ntys</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682668788"><span class="annot"><a href="#local-6989586621682668788"><span class="hs-identifier hs-var">res_co</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#normalise_tc_args"><span class="hs-identifier hs-type">normalise_tc_args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668771"><span class="hs-identifier hs-type">tc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668772"><span class="hs-identifier hs-type">tys</span></a></span><span>
</span><span id="line-1433"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#reduceTyFamApp_maybe"><span class="hs-identifier hs-type">reduceTyFamApp_maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668781"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668783"><span class="hs-keyword hs-type">role</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668771"><span class="hs-identifier hs-type">tc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668787"><span class="hs-identifier hs-type">ntys</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1434"></span><span>           </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682668789"><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682668789"><span class="hs-identifier hs-var">redn1</span></a></span></span><span>
</span><span id="line-1435"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682668790"><span class="annot"><a href="#local-6989586621682668790"><span class="hs-identifier hs-var">redn2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; NormM Reduction
</span><a href="GHC.Core.FamInstEnv.html#normalise_reduction"><span class="hs-identifier hs-var">normalise_reduction</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682668789"><span class="hs-identifier hs-var">redn1</span></a></span><span>
</span><span id="line-1436"></span><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682668792"><span class="annot"><a href="#local-6989586621682668792"><span class="hs-identifier hs-var hs-var">redn3</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Role -&gt; TyCon -&gt; [Coercion] -&gt; Coercion
Role -&gt; TyCon -&gt; [Coercion] -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-var">mkTyConAppCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682668783"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668771"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682668786"><span class="hs-identifier hs-var">args_cos</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Reduction -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkTransRedn"><span class="hs-operator hs-var">`mkTransRedn`</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682668790"><span class="hs-identifier hs-var">redn2</span></a></span><span>
</span><span id="line-1437"></span><span>                   </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621682668793"><span class="hs-identifier hs-type">assemble_result</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668783"><span class="hs-keyword hs-type">role</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668792"><span class="hs-identifier hs-type">redn3</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668788"><span class="hs-identifier hs-type">res_co</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1438"></span><span>           </span><span class="annot"><span class="annottext">Maybe Reduction
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- No unique matching family instance exists;</span><span>
</span><span id="line-1439"></span><span>                </span><span class="hs-comment">-- we do not do anything</span><span>
</span><span id="line-1440"></span><span>                </span><span class="annot"><span class="annottext">Reduction -&gt; NormM Reduction
forall a. a -&gt; NormM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Reduction -&gt; NormM Reduction) -&gt; Reduction -&gt; NormM Reduction
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1441"></span><span>                  </span><span class="annot"><span class="annottext">Role -&gt; Reduction -&gt; MCoercionN -&gt; Reduction
</span><a href="#local-6989586621682668793"><span class="hs-identifier hs-var">assemble_result</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682668783"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; TyCon -&gt; Reductions -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkTyConAppRedn"><span class="hs-identifier hs-var">mkTyConAppRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682668783"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668771"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">Reductions
</span><a href="#local-6989586621682668785"><span class="hs-identifier hs-var">redns</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">MCoercionN
</span><a href="#local-6989586621682668788"><span class="hs-identifier hs-var">res_co</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1442"></span><span>
</span><span id="line-1443"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1444"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- A synonym with no type families in the RHS; or data type etc</span><span>
</span><span id="line-1445"></span><span>    </span><span class="hs-comment">-- Just normalise the arguments and rebuild</span><span>
</span><span id="line-1446"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#ArgsReductions"><span class="hs-identifier hs-type">ArgsReductions</span></a></span><span> </span><span id="local-6989586621682668795"><span class="annot"><a href="#local-6989586621682668795"><span class="hs-identifier hs-var">redns</span></a></span></span><span> </span><span id="local-6989586621682668796"><span class="annot"><a href="#local-6989586621682668796"><span class="hs-identifier hs-var">res_co</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; NormM ArgsReductions
</span><a href="GHC.Core.FamInstEnv.html#normalise_tc_args"><span class="hs-identifier hs-var">normalise_tc_args</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668771"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668772"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-1447"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682668797"><span class="annot"><a href="#local-6989586621682668797"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#getRole"><span class="hs-identifier hs-type">getRole</span></a></span><span>
</span><span id="line-1448"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-1449"></span><span>            </span><span class="annot"><a href="#local-6989586621682668793"><span class="hs-identifier hs-type">assemble_result</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668797"><span class="hs-keyword hs-type">role</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Reduction.html#mkTyConAppRedn"><span class="hs-identifier hs-type">mkTyConAppRedn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668797"><span class="hs-keyword hs-type">role</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668771"><span class="hs-identifier hs-type">tc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668795"><span class="hs-identifier hs-type">redns</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682668796"><span class="hs-identifier hs-type">res_co</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1450"></span><span>
</span><span id="line-1451"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1452"></span><span>    </span><span class="annot"><a href="#local-6989586621682668793"><span class="hs-identifier hs-type">assemble_result</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span>       </span><span class="hs-comment">-- r, ambient role in NormM monad</span><span>
</span><span id="line-1453"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span>  </span><span class="hs-comment">-- orig_ty ~r nty, possibly heterogeneous (nty possibly of changed kind)</span><span>
</span><span id="line-1454"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCoercionN"><span class="hs-identifier hs-type">MCoercionN</span></a></span><span> </span><span class="hs-comment">-- typeKind(orig_ty) ~N typeKind(nty)</span><span>
</span><span id="line-1455"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span>  </span><span class="hs-comment">-- orig_ty ~r nty_casted</span><span>
</span><span id="line-1456"></span><span>                                  </span><span class="hs-comment">-- where nty_casted has same kind as orig_ty</span><span>
</span><span id="line-1457"></span><span>    </span><span id="local-6989586621682668793"><span class="annot"><span class="annottext">assemble_result :: Role -&gt; Reduction -&gt; MCoercionN -&gt; Reduction
</span><a href="#local-6989586621682668793"><span class="hs-identifier hs-var hs-var">assemble_result</span></a></span></span><span> </span><span id="local-6989586621682668798"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682668798"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621682668799"><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682668799"><span class="hs-identifier hs-var">redn</span></a></span></span><span> </span><span id="local-6989586621682668800"><span class="annot"><span class="annottext">MCoercionN
</span><a href="#local-6989586621682668800"><span class="hs-identifier hs-var">kind_co</span></a></span></span><span>
</span><span id="line-1458"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role -&gt; Reduction -&gt; MCoercionN -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkCoherenceRightMRedn"><span class="hs-identifier hs-var">mkCoherenceRightMRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682668798"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682668799"><span class="hs-identifier hs-var">redn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MCoercionN -&gt; MCoercionN
</span><a href="GHC.Core.Coercion.html#mkSymMCo"><span class="hs-identifier hs-var">mkSymMCo</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercionN
</span><a href="#local-6989586621682668800"><span class="hs-identifier hs-var">kind_co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1459"></span><span>
</span><span id="line-1460"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#normalise_tc_args"><span class="hs-identifier hs-type">normalise_tc_args</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#ArgsReductions"><span class="hs-identifier hs-type">ArgsReductions</span></a></span><span>
</span><span id="line-1461"></span><span id="normalise_tc_args"><span class="annot"><span class="annottext">normalise_tc_args :: TyCon -&gt; [Type] -&gt; NormM ArgsReductions
</span><a href="GHC.Core.FamInstEnv.html#normalise_tc_args"><span class="hs-identifier hs-var hs-var">normalise_tc_args</span></a></span></span><span> </span><span id="local-6989586621682668803"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668803"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621682668804"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668804"><span class="hs-identifier hs-var">tys</span></a></span></span><span>
</span><span id="line-1462"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682668805"><span class="annot"><a href="#local-6989586621682668805"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">NormM Role
</span><a href="GHC.Core.FamInstEnv.html#getRole"><span class="hs-identifier hs-var">getRole</span></a></span><span>
</span><span id="line-1463"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#normalise_args"><span class="hs-identifier hs-type">normalise_args</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCon.html#tyConKind"><span class="hs-identifier hs-var">tyConKind</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668803"><span class="hs-identifier hs-type">tc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.html#tyConRolesX"><span class="hs-identifier hs-type">tyConRolesX</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668805"><span class="hs-keyword hs-type">role</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668803"><span class="hs-identifier hs-type">tc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682668804"><span class="hs-identifier hs-type">tys</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1464"></span><span>
</span><span id="line-1465"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#normalise_type"><span class="hs-identifier hs-type">normalise_type</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span>
</span><span id="line-1466"></span><span class="hs-comment">-- Normalise the input type, by eliminating *all* type-function redexes</span><span>
</span><span id="line-1467"></span><span class="hs-comment">-- but *not* newtypes (which are visible to the programmer)</span><span>
</span><span id="line-1468"></span><span class="hs-comment">-- Returns with Refl if nothing happens</span><span>
</span><span id="line-1469"></span><span class="hs-comment">-- Does nothing to newtypes</span><span>
</span><span id="line-1470"></span><span class="hs-comment">-- The returned coercion *must* be *homogeneous*</span><span>
</span><span id="line-1471"></span><span class="hs-comment">-- See Note [Normalising types]</span><span>
</span><span id="line-1472"></span><span class="hs-comment">-- Try not to disturb type synonyms if possible</span><span>
</span><span id="line-1473"></span><span>
</span><span id="line-1474"></span><span id="normalise_type"><span class="annot"><span class="annottext">normalise_type :: Type -&gt; NormM Reduction
</span><a href="GHC.Core.FamInstEnv.html#normalise_type"><span class="hs-identifier hs-var hs-var">normalise_type</span></a></span></span><span> </span><span id="local-6989586621682668809"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668809"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-1475"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; NormM Reduction
</span><a href="#local-6989586621682668810"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668809"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1476"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1477"></span><span>    </span><span class="annot"><a href="#local-6989586621682668810"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span>
</span><span id="line-1478"></span><span>    </span><span id="local-6989586621682668810"><span class="annot"><span class="annottext">go :: Type -&gt; NormM Reduction
</span><a href="#local-6989586621682668810"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyConApp"><span class="hs-identifier hs-type">TyConApp</span></a></span><span> </span><span id="local-6989586621682668812"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668812"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621682668813"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668813"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; NormM Reduction
</span><a href="GHC.Core.FamInstEnv.html#normalise_tc_app"><span class="hs-identifier hs-var">normalise_tc_app</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668812"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668813"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-1479"></span><span>    </span><span class="annot"><a href="#local-6989586621682668810"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682668814"><span class="annot"><span class="annottext">ty :: Type
</span><a href="#local-6989586621682668814"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#LitTy"><span class="hs-identifier hs-type">LitTy</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1480"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682668816"><span class="annot"><a href="#local-6989586621682668816"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">NormM Role
</span><a href="GHC.Core.FamInstEnv.html#getRole"><span class="hs-identifier hs-var">getRole</span></a></span><span>
</span><span id="line-1481"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#mkReflRedn"><span class="hs-identifier hs-type">mkReflRedn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668816"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668814"><span class="hs-identifier hs-type">ty</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1482"></span><span>    </span><span class="annot"><a href="#local-6989586621682668810"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#AppTy"><span class="hs-identifier hs-type">AppTy</span></a></span><span> </span><span id="local-6989586621682668819"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668819"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621682668820"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668820"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; [Type] -&gt; NormM Reduction
</span><a href="#local-6989586621682668821"><span class="hs-identifier hs-var">go_app_tys</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668819"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668820"><span class="hs-identifier hs-var">ty2</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1483"></span><span>
</span><span id="line-1484"></span><span>    </span><span class="annot"><a href="#local-6989586621682668810"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#FunTy"><span class="hs-identifier hs-type">FunTy</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ft_af :: Type -&gt; FunTyFlag
</span><a href="GHC.Core.TyCo.Rep.html#ft_af"><span class="hs-identifier hs-var">ft_af</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668824"><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621682668824"><span class="hs-identifier hs-var">vis</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_mult :: Type -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#ft_mult"><span class="hs-identifier hs-var">ft_mult</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668826"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668826"><span class="hs-identifier hs-var">w</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_arg :: Type -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#ft_arg"><span class="hs-identifier hs-var">ft_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668828"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668828"><span class="hs-identifier hs-var">ty1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_res :: Type -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#ft_res"><span class="hs-identifier hs-var">ft_res</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682668830"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668830"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1485"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682668831"><span class="annot"><a href="#local-6989586621682668831"><span class="hs-identifier hs-var">arg_redn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; NormM Reduction
</span><a href="#local-6989586621682668810"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668828"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-1486"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682668832"><span class="annot"><a href="#local-6989586621682668832"><span class="hs-identifier hs-var">res_redn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621682668810"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668830"><span class="hs-identifier hs-type">ty2</span></a></span><span>
</span><span id="line-1487"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682668833"><span class="annot"><a href="#local-6989586621682668833"><span class="hs-identifier hs-var">w_redn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#withRole"><span class="hs-identifier hs-type">withRole</span></a></span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-type">Nominal</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621682668810"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668826"><span class="hs-identifier hs-type">w</span></a></span><span>
</span><span id="line-1488"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682668835"><span class="annot"><a href="#local-6989586621682668835"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#getRole"><span class="hs-identifier hs-type">getRole</span></a></span><span>
</span><span id="line-1489"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#mkFunRedn"><span class="hs-identifier hs-type">mkFunRedn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668835"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668824"><span class="hs-identifier hs-type">vis</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668833"><span class="hs-identifier hs-type">w_redn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668831"><span class="hs-identifier hs-type">arg_redn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668832"><span class="hs-identifier hs-type">res_redn</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1490"></span><span>    </span><span class="annot"><a href="#local-6989586621682668810"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ForAllTy"><span class="hs-identifier hs-type">ForAllTy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Bndr"><span class="hs-identifier hs-type">Bndr</span></a></span><span> </span><span id="local-6989586621682668839"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682668839"><span class="hs-identifier hs-var">tcvar</span></a></span></span><span> </span><span id="local-6989586621682668840"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682668840"><span class="hs-identifier hs-var">vis</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682668841"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668841"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1491"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682668842"><span class="annot"><a href="#local-6989586621682668842"><span class="hs-identifier hs-var">lc'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682668843"><span class="annot"><a href="#local-6989586621682668843"><span class="hs-identifier hs-var">tv'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682668844"><span class="annot"><a href="#local-6989586621682668844"><span class="hs-identifier hs-var">k_redn</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; NormM (LiftingContext, TyVar, Reduction)
</span><a href="GHC.Core.FamInstEnv.html#normalise_var_bndr"><span class="hs-identifier hs-var">normalise_var_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682668839"><span class="hs-identifier hs-var">tcvar</span></a></span><span>
</span><span id="line-1492"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682668846"><span class="annot"><a href="#local-6989586621682668846"><span class="hs-identifier hs-var">redn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#withLC"><span class="hs-identifier hs-type">withLC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668842"><span class="hs-identifier hs-type">lc'</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#normalise_type"><span class="hs-identifier hs-type">normalise_type</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668841"><span class="hs-identifier hs-type">ty</span></a></span><span>
</span><span id="line-1493"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#mkForAllRedn"><span class="hs-identifier hs-type">mkForAllRedn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668840"><span class="hs-identifier hs-type">vis</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668843"><span class="hs-identifier hs-type">tv'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668844"><span class="hs-identifier hs-type">k_redn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668846"><span class="hs-identifier hs-type">redn</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1494"></span><span>    </span><span class="annot"><a href="#local-6989586621682668810"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyVarTy"><span class="hs-identifier hs-type">TyVarTy</span></a></span><span> </span><span id="local-6989586621682668850"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682668850"><span class="hs-identifier hs-var">tv</span></a></span></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; NormM Reduction
</span><a href="GHC.Core.FamInstEnv.html#normalise_tyvar"><span class="hs-identifier hs-var">normalise_tyvar</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682668850"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-1495"></span><span>    </span><span class="annot"><a href="#local-6989586621682668810"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CastTy"><span class="hs-identifier hs-type">CastTy</span></a></span><span> </span><span id="local-6989586621682668853"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668853"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621682668854"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682668854"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1496"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682668855"><span class="annot"><a href="#local-6989586621682668855"><span class="hs-identifier hs-var">redn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; NormM Reduction
</span><a href="#local-6989586621682668810"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668853"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1497"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682668856"><span class="annot"><a href="#local-6989586621682668856"><span class="hs-identifier hs-var">lc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#getLC"><span class="hs-identifier hs-type">getLC</span></a></span><span>
</span><span id="line-1498"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682668858"><span class="annot"><a href="#local-6989586621682668858"><span class="hs-identifier hs-var hs-var">co'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#substRightCo"><span class="hs-identifier hs-var">substRightCo</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682668856"><span class="hs-identifier hs-var">lc</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682668854"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1499"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#mkCastRedn2"><span class="hs-identifier hs-type">mkCastRedn2</span></a></span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-type">Nominal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668853"><span class="hs-identifier hs-type">ty</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668854"><span class="hs-identifier hs-type">co</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668855"><span class="hs-identifier hs-type">redn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668858"><span class="hs-identifier hs-type">co'</span></a></span><span>
</span><span id="line-1500"></span><span>             </span><span class="hs-comment">--       ^^^^^^^^^^^ uses castCoercionKind2</span><span>
</span><span id="line-1501"></span><span>           </span><span class="hs-special">}</span><span>
</span><span id="line-1502"></span><span>    </span><span class="annot"><a href="#local-6989586621682668810"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionTy"><span class="hs-identifier hs-type">CoercionTy</span></a></span><span> </span><span id="local-6989586621682668862"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682668862"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1503"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682668863"><span class="annot"><a href="#local-6989586621682668863"><span class="hs-identifier hs-var">lc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">NormM LiftingContext
</span><a href="GHC.Core.FamInstEnv.html#getLC"><span class="hs-identifier hs-var">getLC</span></a></span><span>
</span><span id="line-1504"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682668864"><span class="annot"><a href="#local-6989586621682668864"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#getRole"><span class="hs-identifier hs-type">getRole</span></a></span><span>
</span><span id="line-1505"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682668865"><span class="annot"><a href="#local-6989586621682668865"><span class="hs-identifier hs-var hs-var">kco</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Role -&gt; LiftingContext -&gt; Type -&gt; Coercion
Role -&gt; LiftingContext -&gt; Type -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#liftCoSubst"><span class="hs-identifier hs-var">liftCoSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682668863"><span class="hs-identifier hs-var">lc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; Type
</span><a href="GHC.Core.Coercion.html#coercionType"><span class="hs-identifier hs-var">coercionType</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682668862"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1506"></span><span>                 </span><span id="local-6989586621682668868"><span class="annot"><a href="#local-6989586621682668868"><span class="hs-identifier hs-var hs-var">co'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#substRightCo"><span class="hs-identifier hs-var">substRightCo</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682668863"><span class="hs-identifier hs-var">lc</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682668862"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1507"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#mkProofIrrelRedn"><span class="hs-identifier hs-type">mkProofIrrelRedn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668864"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668865"><span class="hs-identifier hs-type">kco</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668862"><span class="hs-identifier hs-type">co</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668868"><span class="hs-identifier hs-type">co'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1508"></span><span>
</span><span id="line-1509"></span><span>    </span><span class="annot"><a href="#local-6989586621682668821"><span class="hs-identifier hs-type">go_app_tys</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>   </span><span class="hs-comment">-- function</span><span>
</span><span id="line-1510"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- args</span><span>
</span><span id="line-1511"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span>
</span><span id="line-1512"></span><span>    </span><span class="hs-comment">-- cf. GHC.Tc.Solver.Rewrite.rewrite_app_ty_args</span><span>
</span><span id="line-1513"></span><span>    </span><span id="local-6989586621682668821"><span class="annot"><span class="annottext">go_app_tys :: Type -&gt; [Type] -&gt; NormM Reduction
</span><a href="#local-6989586621682668821"><span class="hs-identifier hs-var hs-var">go_app_tys</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#AppTy"><span class="hs-identifier hs-type">AppTy</span></a></span><span> </span><span id="local-6989586621682668870"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668870"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621682668871"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668871"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682668872"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668872"><span class="hs-identifier hs-var">tys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; [Type] -&gt; NormM Reduction
</span><a href="#local-6989586621682668821"><span class="hs-identifier hs-var">go_app_tys</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668870"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668871"><span class="hs-identifier hs-var">ty2</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; [Type] -&gt; [Type]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668872"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1514"></span><span>    </span><span class="annot"><a href="#local-6989586621682668821"><span class="hs-identifier hs-var">go_app_tys</span></a></span><span> </span><span id="local-6989586621682668873"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668873"><span class="hs-identifier hs-var">fun_ty</span></a></span></span><span> </span><span id="local-6989586621682668874"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668874"><span class="hs-identifier hs-var">arg_tys</span></a></span></span><span>
</span><span id="line-1515"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682668875"><span class="annot"><a href="#local-6989586621682668875"><span class="hs-identifier hs-var">fun_redn</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span> </span><span id="local-6989586621682668876"><span class="annot"><a href="#local-6989586621682668876"><span class="hs-identifier hs-var">fun_co</span></a></span></span><span> </span><span id="local-6989586621682668877"><span class="annot"><a href="#local-6989586621682668877"><span class="hs-identifier hs-var">nfun</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; NormM Reduction
</span><a href="#local-6989586621682668810"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668873"><span class="hs-identifier hs-var">fun_ty</span></a></span><span>
</span><span id="line-1516"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="GHC.Core.Type.html#tcSplitTyConApp_maybe"><span class="hs-identifier hs-type">tcSplitTyConApp_maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668877"><span class="hs-identifier hs-type">nfun</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1517"></span><span>               </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682668879"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668879"><span class="hs-identifier hs-var">tc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682668880"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668880"><span class="hs-identifier hs-var">xis</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1518"></span><span>                 </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682668881"><span class="annot"><a href="#local-6989586621682668881"><span class="hs-identifier hs-var">redn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; NormM Reduction
</span><a href="#local-6989586621682668810"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; Type
</span><a href="GHC.Core.Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682668879"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668880"><span class="hs-identifier hs-var">xis</span></a></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; [Type] -&gt; [Type]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668874"><span class="hs-identifier hs-var">arg_tys</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1519"></span><span>                   </span><span class="hs-comment">-- rewrite_app_ty_args avoids redundantly processing the xis,</span><span>
</span><span id="line-1520"></span><span>                   </span><span class="hs-comment">-- but that's a much more performance-sensitive function.</span><span>
</span><span id="line-1521"></span><span>                   </span><span class="hs-comment">-- This type normalisation is not called in a loop.</span><span>
</span><span id="line-1522"></span><span>                    </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-1523"></span><span>                        </span><span class="annot"><a href="GHC.Core.Coercion.html#mkAppCos"><span class="hs-identifier hs-type">mkAppCos</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668876"><span class="hs-identifier hs-type">fun_co</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">map</span></span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-type">mkNomReflCo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668874"><span class="hs-identifier hs-type">arg_tys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#mkTransRedn"><span class="hs-operator hs-type">`mkTransRedn`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668881"><span class="hs-identifier hs-type">redn</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1524"></span><span>               </span><span class="annot"><span class="annottext">Maybe (TyCon, [Type])
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1525"></span><span>                 </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#ArgsReductions"><span class="hs-identifier hs-type">ArgsReductions</span></a></span><span> </span><span id="local-6989586621682668884"><span class="annot"><a href="#local-6989586621682668884"><span class="hs-identifier hs-var">redns</span></a></span></span><span> </span><span id="local-6989586621682668885"><span class="annot"><a href="#local-6989586621682668885"><span class="hs-identifier hs-var">res_co</span></a></span></span><span>
</span><span id="line-1526"></span><span>                        </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Infinite Role -&gt; [Type] -&gt; NormM ArgsReductions
</span><a href="GHC.Core.FamInstEnv.html#normalise_args"><span class="hs-identifier hs-var">normalise_args</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Type
Type -&gt; Type
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668877"><span class="hs-identifier hs-var">nfun</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1527"></span><span>                                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; Infinite Role
forall a. a -&gt; Infinite a
</span><a href="GHC.Data.List.Infinite.html#repeat"><span class="hs-identifier hs-var">Inf.repeat</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1528"></span><span>                                          </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668874"><span class="hs-identifier hs-var">arg_tys</span></a></span><span>
</span><span id="line-1529"></span><span>                    </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682668888"><span class="annot"><a href="#local-6989586621682668888"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#getRole"><span class="hs-identifier hs-type">getRole</span></a></span><span>
</span><span id="line-1530"></span><span>                    </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-1531"></span><span>                        </span><span class="annot"><a href="GHC.Core.Reduction.html#mkCoherenceRightMRedn"><span class="hs-identifier hs-type">mkCoherenceRightMRedn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668888"><span class="hs-keyword hs-type">role</span></a></span><span>
</span><span id="line-1532"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Reduction.html#mkAppRedns"><span class="hs-identifier hs-type">mkAppRedns</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668875"><span class="hs-identifier hs-type">fun_redn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668884"><span class="hs-identifier hs-type">redns</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1533"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.html#mkSymMCo"><span class="hs-identifier hs-type">mkSymMCo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668885"><span class="hs-identifier hs-type">res_co</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1534"></span><span>
</span><span id="line-1535"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#normalise_args"><span class="hs-identifier hs-type">normalise_args</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Kind"><span class="hs-identifier hs-type">Kind</span></a></span><span>    </span><span class="hs-comment">-- of the function</span><span>
</span><span id="line-1536"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Data.List.Infinite.html#Infinite"><span class="hs-identifier hs-type">Infinite</span></a></span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span>  </span><span class="hs-comment">-- roles at which to normalise args</span><span>
</span><span id="line-1537"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- args</span><span>
</span><span id="line-1538"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#ArgsReductions"><span class="hs-identifier hs-type">ArgsReductions</span></a></span><span>
</span><span id="line-1539"></span><span class="hs-comment">-- returns ArgsReductions (Reductions cos xis) res_co,</span><span>
</span><span id="line-1540"></span><span class="hs-comment">-- where each xi is the normalised version of the corresponding type,</span><span>
</span><span id="line-1541"></span><span class="hs-comment">-- each co is orig_arg ~ xi, and res_co :: kind(f orig_args) ~ kind(f xis).</span><span>
</span><span id="line-1542"></span><span class="hs-comment">-- NB: The xis might *not* have the same kinds as the input types,</span><span>
</span><span id="line-1543"></span><span class="hs-comment">-- but the resulting application *will* be well-kinded</span><span>
</span><span id="line-1544"></span><span class="hs-comment">-- cf. GHC.Tc.Solver.Rewrite.rewrite_args_slow</span><span>
</span><span id="line-1545"></span><span id="normalise_args"><span class="annot"><span class="annottext">normalise_args :: Type -&gt; Infinite Role -&gt; [Type] -&gt; NormM ArgsReductions
</span><a href="GHC.Core.FamInstEnv.html#normalise_args"><span class="hs-identifier hs-var hs-var">normalise_args</span></a></span></span><span> </span><span id="local-6989586621682668891"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668891"><span class="hs-identifier hs-var">fun_ki</span></a></span></span><span> </span><span id="local-6989586621682668892"><span class="annot"><span class="annottext">Infinite Role
</span><a href="#local-6989586621682668892"><span class="hs-identifier hs-var">roles</span></a></span></span><span> </span><span id="local-6989586621682668893"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668893"><span class="hs-identifier hs-var">args</span></a></span></span><span>
</span><span id="line-1546"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682668894"><span class="annot"><a href="#local-6989586621682668894"><span class="hs-identifier hs-var">normed_args</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Role -&gt; Type -&gt; NormM Reduction)
-&gt; [Role] -&gt; [Type] -&gt; NormM [Reduction]
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><span class="hs-identifier hs-var">zipWithM</span></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Type -&gt; NormM Reduction
</span><a href="#local-6989586621682668896"><span class="hs-identifier hs-var">normalise1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Infinite Role -&gt; [Role]
forall a. Infinite a -&gt; [a]
</span><a href="GHC.Data.List.Infinite.html#toList"><span class="hs-identifier hs-var">Inf.toList</span></a></span><span> </span><span class="annot"><span class="annottext">Infinite Role
</span><a href="#local-6989586621682668892"><span class="hs-identifier hs-var">roles</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668893"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-1547"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#simplifyArgsWorker"><span class="hs-identifier hs-type">simplifyArgsWorker</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668899"><span class="hs-identifier hs-type">ki_binders</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668900"><span class="hs-identifier hs-type">inner_ki</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668901"><span class="hs-identifier hs-type">fvs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668892"><span class="hs-identifier hs-type">roles</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668894"><span class="hs-identifier hs-type">normed_args</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1548"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1549"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682668899"><span class="annot"><span class="annottext">[PiTyBinder]
</span><a href="#local-6989586621682668899"><span class="hs-identifier hs-var">ki_binders</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682668900"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668900"><span class="hs-identifier hs-var">inner_ki</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; ([PiTyBinder], Type)
</span><a href="GHC.Core.Type.html#splitPiTys"><span class="hs-identifier hs-var">splitPiTys</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668891"><span class="hs-identifier hs-var">fun_ki</span></a></span><span>
</span><span id="line-1550"></span><span>    </span><span id="local-6989586621682668901"><span class="annot"><span class="annottext">fvs :: TyCoVarSet
</span><a href="#local-6989586621682668901"><span class="hs-identifier hs-var hs-var">fvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; TyCoVarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tyCoVarsOfTypes</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682668893"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-1551"></span><span>
</span><span id="line-1552"></span><span>    </span><span id="local-6989586621682668896"><span class="annot"><span class="annottext">normalise1 :: Role -&gt; Type -&gt; NormM Reduction
</span><a href="#local-6989586621682668896"><span class="hs-identifier hs-var hs-var">normalise1</span></a></span></span><span> </span><span id="local-6989586621682668903"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682668903"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span id="local-6989586621682668904"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668904"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-1553"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role -&gt; NormM Reduction -&gt; NormM Reduction
forall a. Role -&gt; NormM a -&gt; NormM a
</span><a href="GHC.Core.FamInstEnv.html#withRole"><span class="hs-identifier hs-var">withRole</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682668903"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">(NormM Reduction -&gt; NormM Reduction)
-&gt; NormM Reduction -&gt; NormM Reduction
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; NormM Reduction
</span><a href="GHC.Core.FamInstEnv.html#normalise_type"><span class="hs-identifier hs-var">normalise_type</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668904"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1554"></span><span>
</span><span id="line-1555"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#normalise_tyvar"><span class="hs-identifier hs-type">normalise_tyvar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span>
</span><span id="line-1556"></span><span id="normalise_tyvar"><span class="annot"><span class="annottext">normalise_tyvar :: TyVar -&gt; NormM Reduction
</span><a href="GHC.Core.FamInstEnv.html#normalise_tyvar"><span class="hs-identifier hs-var hs-var">normalise_tyvar</span></a></span></span><span> </span><span id="local-6989586621682668905"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682668905"><span class="hs-identifier hs-var">tv</span></a></span></span><span>
</span><span id="line-1557"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; NormM Reduction -&gt; NormM Reduction
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682668905"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(NormM Reduction -&gt; NormM Reduction)
-&gt; NormM Reduction -&gt; NormM Reduction
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1558"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682668907"><span class="annot"><a href="#local-6989586621682668907"><span class="hs-identifier hs-var">lc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">NormM LiftingContext
</span><a href="GHC.Core.FamInstEnv.html#getLC"><span class="hs-identifier hs-var">getLC</span></a></span><span>
</span><span id="line-1559"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682668908"><span class="annot"><a href="#local-6989586621682668908"><span class="hs-identifier hs-var">r</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#getRole"><span class="hs-identifier hs-type">getRole</span></a></span><span>
</span><span id="line-1560"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#liftCoSubstTyVar"><span class="hs-identifier hs-type">liftCoSubstTyVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668907"><span class="hs-identifier hs-type">lc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668908"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668905"><span class="hs-identifier hs-type">tv</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1561"></span><span>           </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682668910"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682668910"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#coercionRedn"><span class="hs-identifier hs-var">coercionRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682668910"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1562"></span><span>           </span><span class="annot"><span class="annottext">Maybe Coercion
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Role -&gt; Type -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkReflRedn"><span class="hs-identifier hs-var">mkReflRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682668908"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682668905"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1563"></span><span>
</span><span id="line-1564"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#normalise_reduction"><span class="hs-identifier hs-type">normalise_reduction</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span>
</span><span id="line-1565"></span><span id="normalise_reduction"><span class="annot"><span class="annottext">normalise_reduction :: Reduction -&gt; NormM Reduction
</span><a href="GHC.Core.FamInstEnv.html#normalise_reduction"><span class="hs-identifier hs-var hs-var">normalise_reduction</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span> </span><span id="local-6989586621682668912"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682668912"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span id="local-6989586621682668913"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668913"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1566"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682668914"><span class="annot"><a href="#local-6989586621682668914"><span class="hs-identifier hs-var">redn'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; NormM Reduction
</span><a href="GHC.Core.FamInstEnv.html#normalise_type"><span class="hs-identifier hs-var">normalise_type</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668913"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1567"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621682668912"><span class="hs-identifier hs-type">co</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#mkTransRedn"><span class="hs-operator hs-type">`mkTransRedn`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668914"><span class="hs-identifier hs-type">redn'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1568"></span><span>
</span><span id="line-1569"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#normalise_var_bndr"><span class="hs-identifier hs-type">normalise_var_bndr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1570"></span><span id="normalise_var_bndr"><span class="annot"><span class="annottext">normalise_var_bndr :: TyVar -&gt; NormM (LiftingContext, TyVar, Reduction)
</span><a href="GHC.Core.FamInstEnv.html#normalise_var_bndr"><span class="hs-identifier hs-var hs-var">normalise_var_bndr</span></a></span></span><span> </span><span id="local-6989586621682668916"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682668916"><span class="hs-identifier hs-var">tcvar</span></a></span></span><span>
</span><span id="line-1571"></span><span>  </span><span class="hs-comment">-- works for both tvar and covar</span><span>
</span><span id="line-1572"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682668917"><span class="annot"><a href="#local-6989586621682668917"><span class="hs-identifier hs-var">lc1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">NormM LiftingContext
</span><a href="GHC.Core.FamInstEnv.html#getLC"><span class="hs-identifier hs-var">getLC</span></a></span><span>
</span><span id="line-1573"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682668918"><span class="annot"><a href="#local-6989586621682668918"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#getEnv"><span class="hs-identifier hs-type">getEnv</span></a></span><span>
</span><span id="line-1574"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682668919"><span class="annot"><a href="#local-6989586621682668919"><span class="hs-identifier hs-var hs-var">callback</span></a></span></span><span> </span><span id="local-6989586621682668920"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682668920"><span class="hs-identifier hs-var">lc</span></a></span></span><span> </span><span id="local-6989586621682668921"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668921"><span class="hs-identifier hs-var">ki</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NormM Reduction
-&gt; (FamInstEnv, FamInstEnv) -&gt; LiftingContext -&gt; Role -&gt; Reduction
forall a.
NormM a -&gt; (FamInstEnv, FamInstEnv) -&gt; LiftingContext -&gt; Role -&gt; a
</span><a href="GHC.Core.FamInstEnv.html#runNormM"><span class="hs-identifier hs-var">runNormM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; NormM Reduction
</span><a href="GHC.Core.FamInstEnv.html#normalise_type"><span class="hs-identifier hs-var">normalise_type</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682668921"><span class="hs-identifier hs-var">ki</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621682668918"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682668920"><span class="hs-identifier hs-var">lc</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span>
</span><span id="line-1575"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#liftCoSubstVarBndrUsing"><span class="hs-identifier hs-type">liftCoSubstVarBndrUsing</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#reductionCoercion"><span class="hs-identifier hs-var">reductionCoercion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668919"><span class="hs-identifier hs-type">callback</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668917"><span class="hs-identifier hs-type">lc1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668916"><span class="hs-identifier hs-type">tcvar</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1576"></span><span>
</span><span id="line-1577"></span><span class="hs-comment">-- | a monad for the normalisation functions, reading 'FamInstEnvs',</span><span>
</span><span id="line-1578"></span><span class="hs-comment">-- a 'LiftingContext', and a 'Role'.</span><span>
</span><span id="line-1579"></span><span class="hs-keyword">newtype</span><span> </span><span id="NormM"><span class="annot"><a href="GHC.Core.FamInstEnv.html#NormM"><span class="hs-identifier hs-var">NormM</span></a></span></span><span> </span><span id="local-6989586621682668053"><span class="annot"><a href="#local-6989586621682668053"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="NormM"><span class="annot"><a href="GHC.Core.FamInstEnv.html#NormM"><span class="hs-identifier hs-var">NormM</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="runNormM"><span class="annot"><span class="annottext">forall a.
NormM a -&gt; (FamInstEnv, FamInstEnv) -&gt; LiftingContext -&gt; Role -&gt; a
</span><a href="GHC.Core.FamInstEnv.html#runNormM"><span class="hs-identifier hs-var hs-var">runNormM</span></a></span></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1580"></span><span>                            </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621682668053"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1581"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682668927"><span id="local-6989586621682668929"><span class="annot"><span class="annottext">(forall a b. (a -&gt; b) -&gt; NormM a -&gt; NormM b)
-&gt; (forall a b. a -&gt; NormM b -&gt; NormM a) -&gt; Functor NormM
forall a b. a -&gt; NormM b -&gt; NormM a
forall a b. (a -&gt; b) -&gt; NormM a -&gt; NormM b
forall (f :: * -&gt; *).
(forall a b. (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b. a -&gt; f b -&gt; f a) -&gt; Functor f
$cfmap :: forall a b. (a -&gt; b) -&gt; NormM a -&gt; NormM b
fmap :: forall a b. (a -&gt; b) -&gt; NormM a -&gt; NormM b
$c&lt;$ :: forall a b. a -&gt; NormM b -&gt; NormM a
&lt;$ :: forall a b. a -&gt; NormM b -&gt; NormM a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Functor</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-1582"></span><span>
</span><span id="line-1583"></span><span id="local-6989586621682668036"><span class="annot"><a href="GHC.Core.FamInstEnv.html#initNormM"><span class="hs-identifier hs-type">initNormM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span>
</span><span id="line-1584"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#TyCoVarSet"><span class="hs-identifier hs-type">TyCoVarSet</span></a></span><span>   </span><span class="hs-comment">-- the in-scope variables</span><span>
</span><span id="line-1585"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668036"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621682668036"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-1586"></span><span id="initNormM"><span class="annot"><span class="annottext">initNormM :: forall a.
(FamInstEnv, FamInstEnv) -&gt; Role -&gt; TyCoVarSet -&gt; NormM a -&gt; a
</span><a href="GHC.Core.FamInstEnv.html#initNormM"><span class="hs-identifier hs-var hs-var">initNormM</span></a></span></span><span> </span><span id="local-6989586621682668933"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621682668933"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682668934"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682668934"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span id="local-6989586621682668935"><span class="annot"><span class="annottext">TyCoVarSet
</span><a href="#local-6989586621682668935"><span class="hs-identifier hs-var">vars</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a></span><span> </span><span id="local-6989586621682668936"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv) -&gt; LiftingContext -&gt; Role -&gt; a
</span><a href="#local-6989586621682668936"><span class="hs-identifier hs-var">thing_inside</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1587"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv) -&gt; LiftingContext -&gt; Role -&gt; a
</span><a href="#local-6989586621682668936"><span class="hs-identifier hs-var">thing_inside</span></a></span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621682668933"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682668937"><span class="hs-identifier hs-var">lc</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682668934"><span class="hs-keyword hs-var">role</span></a></span><span>
</span><span id="line-1588"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1589"></span><span>    </span><span id="local-6989586621682668938"><span class="annot"><span class="annottext">in_scope :: InScopeSet
</span><a href="#local-6989586621682668938"><span class="hs-identifier hs-var hs-var">in_scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCoVarSet -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#mkInScopeSet"><span class="hs-identifier hs-var">mkInScopeSet</span></a></span><span> </span><span class="annot"><span class="annottext">TyCoVarSet
</span><a href="#local-6989586621682668935"><span class="hs-identifier hs-var">vars</span></a></span><span>
</span><span id="line-1590"></span><span>    </span><span id="local-6989586621682668937"><span class="annot"><span class="annottext">lc :: LiftingContext
</span><a href="#local-6989586621682668937"><span class="hs-identifier hs-var hs-var">lc</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; LiftingContext
</span><a href="GHC.Core.Coercion.html#emptyLiftingContext"><span class="hs-identifier hs-var">emptyLiftingContext</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682668938"><span class="hs-identifier hs-var">in_scope</span></a></span><span>
</span><span id="line-1591"></span><span>
</span><span id="line-1592"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#getRole"><span class="hs-identifier hs-type">getRole</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a></span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span>
</span><span id="line-1593"></span><span id="getRole"><span class="annot"><span class="annottext">getRole :: NormM Role
</span><a href="GHC.Core.FamInstEnv.html#getRole"><span class="hs-identifier hs-var hs-var">getRole</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((FamInstEnv, FamInstEnv) -&gt; LiftingContext -&gt; Role -&gt; Role)
-&gt; NormM Role
forall a.
((FamInstEnv, FamInstEnv) -&gt; LiftingContext -&gt; Role -&gt; a)
-&gt; NormM a
</span><a href="GHC.Core.FamInstEnv.html#NormM"><span class="hs-identifier hs-var">NormM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682668940"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682668940"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682668940"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1594"></span><span>
</span><span id="line-1595"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#getLC"><span class="hs-identifier hs-type">getLC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a></span><span>
</span><span id="line-1596"></span><span id="getLC"><span class="annot"><span class="annottext">getLC :: NormM LiftingContext
</span><a href="GHC.Core.FamInstEnv.html#getLC"><span class="hs-identifier hs-var hs-var">getLC</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((FamInstEnv, FamInstEnv)
 -&gt; LiftingContext -&gt; Role -&gt; LiftingContext)
-&gt; NormM LiftingContext
forall a.
((FamInstEnv, FamInstEnv) -&gt; LiftingContext -&gt; Role -&gt; a)
-&gt; NormM a
</span><a href="GHC.Core.FamInstEnv.html#NormM"><span class="hs-identifier hs-var">NormM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682668941"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682668941"><span class="hs-identifier hs-var">lc</span></a></span></span><span> </span><span class="annot"><span class="annottext">Role
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682668941"><span class="hs-identifier hs-var">lc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1597"></span><span>
</span><span id="line-1598"></span><span class="annot"><a href="GHC.Core.FamInstEnv.html#getEnv"><span class="hs-identifier hs-type">getEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a></span><span>
</span><span id="line-1599"></span><span id="getEnv"><span class="annot"><span class="annottext">getEnv :: NormM (FamInstEnv, FamInstEnv)
</span><a href="GHC.Core.FamInstEnv.html#getEnv"><span class="hs-identifier hs-var hs-var">getEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((FamInstEnv, FamInstEnv)
 -&gt; LiftingContext -&gt; Role -&gt; (FamInstEnv, FamInstEnv))
-&gt; NormM (FamInstEnv, FamInstEnv)
forall a.
((FamInstEnv, FamInstEnv) -&gt; LiftingContext -&gt; Role -&gt; a)
-&gt; NormM a
</span><a href="GHC.Core.FamInstEnv.html#NormM"><span class="hs-identifier hs-var">NormM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621682668942"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621682668942"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621682668942"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1600"></span><span>
</span><span id="line-1601"></span><span id="local-6989586621682668041"><span class="annot"><a href="GHC.Core.FamInstEnv.html#withRole"><span class="hs-identifier hs-type">withRole</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668041"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668041"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-1602"></span><span id="withRole"><span class="annot"><span class="annottext">withRole :: forall a. Role -&gt; NormM a -&gt; NormM a
</span><a href="GHC.Core.FamInstEnv.html#withRole"><span class="hs-identifier hs-var hs-var">withRole</span></a></span></span><span> </span><span id="local-6989586621682668943"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682668943"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621682668944"><span class="annot"><span class="annottext">NormM a
</span><a href="#local-6989586621682668944"><span class="hs-identifier hs-var">thing</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((FamInstEnv, FamInstEnv) -&gt; LiftingContext -&gt; Role -&gt; a)
-&gt; NormM a
forall a.
((FamInstEnv, FamInstEnv) -&gt; LiftingContext -&gt; Role -&gt; a)
-&gt; NormM a
</span><a href="GHC.Core.FamInstEnv.html#NormM"><span class="hs-identifier hs-var">NormM</span></a></span><span> </span><span class="annot"><span class="annottext">(((FamInstEnv, FamInstEnv) -&gt; LiftingContext -&gt; Role -&gt; a)
 -&gt; NormM a)
-&gt; ((FamInstEnv, FamInstEnv) -&gt; LiftingContext -&gt; Role -&gt; a)
-&gt; NormM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621682668945"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621682668945"><span class="hs-identifier hs-var">envs</span></a></span></span><span> </span><span id="local-6989586621682668946"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682668946"><span class="hs-identifier hs-var">lc</span></a></span></span><span> </span><span id="local-6989586621682668947"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682668947"><span class="hs-identifier hs-var">_old_r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">NormM a -&gt; (FamInstEnv, FamInstEnv) -&gt; LiftingContext -&gt; Role -&gt; a
forall a.
NormM a -&gt; (FamInstEnv, FamInstEnv) -&gt; LiftingContext -&gt; Role -&gt; a
</span><a href="GHC.Core.FamInstEnv.html#runNormM"><span class="hs-identifier hs-var">runNormM</span></a></span><span> </span><span class="annot"><span class="annottext">NormM a
</span><a href="#local-6989586621682668944"><span class="hs-identifier hs-var">thing</span></a></span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621682668945"><span class="hs-identifier hs-var">envs</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682668946"><span class="hs-identifier hs-var">lc</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682668943"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-1603"></span><span>
</span><span id="line-1604"></span><span id="local-6989586621682668045"><span class="annot"><a href="GHC.Core.FamInstEnv.html#withLC"><span class="hs-identifier hs-type">withLC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668045"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682668045"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-1605"></span><span id="withLC"><span class="annot"><span class="annottext">withLC :: forall a. LiftingContext -&gt; NormM a -&gt; NormM a
</span><a href="GHC.Core.FamInstEnv.html#withLC"><span class="hs-identifier hs-var hs-var">withLC</span></a></span></span><span> </span><span id="local-6989586621682668948"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682668948"><span class="hs-identifier hs-var">lc</span></a></span></span><span> </span><span id="local-6989586621682668949"><span class="annot"><span class="annottext">NormM a
</span><a href="#local-6989586621682668949"><span class="hs-identifier hs-var">thing</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((FamInstEnv, FamInstEnv) -&gt; LiftingContext -&gt; Role -&gt; a)
-&gt; NormM a
forall a.
((FamInstEnv, FamInstEnv) -&gt; LiftingContext -&gt; Role -&gt; a)
-&gt; NormM a
</span><a href="GHC.Core.FamInstEnv.html#NormM"><span class="hs-identifier hs-var">NormM</span></a></span><span> </span><span class="annot"><span class="annottext">(((FamInstEnv, FamInstEnv) -&gt; LiftingContext -&gt; Role -&gt; a)
 -&gt; NormM a)
-&gt; ((FamInstEnv, FamInstEnv) -&gt; LiftingContext -&gt; Role -&gt; a)
-&gt; NormM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621682668950"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621682668950"><span class="hs-identifier hs-var">envs</span></a></span></span><span> </span><span id="local-6989586621682668951"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682668951"><span class="hs-identifier hs-var">_old_lc</span></a></span></span><span> </span><span id="local-6989586621682668952"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682668952"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">NormM a -&gt; (FamInstEnv, FamInstEnv) -&gt; LiftingContext -&gt; Role -&gt; a
forall a.
NormM a -&gt; (FamInstEnv, FamInstEnv) -&gt; LiftingContext -&gt; Role -&gt; a
</span><a href="GHC.Core.FamInstEnv.html#runNormM"><span class="hs-identifier hs-var">runNormM</span></a></span><span> </span><span class="annot"><span class="annottext">NormM a
</span><a href="#local-6989586621682668949"><span class="hs-identifier hs-var">thing</span></a></span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621682668950"><span class="hs-identifier hs-var">envs</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682668948"><span class="hs-identifier hs-var">lc</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682668952"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-1606"></span><span>
</span><span id="line-1607"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621682668957"><span id="local-6989586621682668960"><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1608"></span><span>  </span><span id="local-6989586621682668963"><span class="annot"><span class="annottext">NormM a
</span><a href="#local-6989586621682668963"><span class="hs-identifier hs-var">ma</span></a></span></span><span> </span><span id="local-6989586621682668964"><span class="annot"><span class="annottext">&gt;&gt;= :: forall a b. NormM a -&gt; (a -&gt; NormM b) -&gt; NormM b
</span><span class="hs-operator hs-var hs-var hs-var">&gt;&gt;=</span></span></span><span> </span><span id="local-6989586621682668965"><span class="annot"><span class="annottext">a -&gt; NormM b
</span><a href="#local-6989586621682668965"><span class="hs-identifier hs-var">fmb</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((FamInstEnv, FamInstEnv) -&gt; LiftingContext -&gt; Role -&gt; b)
-&gt; NormM b
forall a.
((FamInstEnv, FamInstEnv) -&gt; LiftingContext -&gt; Role -&gt; a)
-&gt; NormM a
</span><a href="GHC.Core.FamInstEnv.html#NormM"><span class="hs-identifier hs-var">NormM</span></a></span><span> </span><span class="annot"><span class="annottext">(((FamInstEnv, FamInstEnv) -&gt; LiftingContext -&gt; Role -&gt; b)
 -&gt; NormM b)
-&gt; ((FamInstEnv, FamInstEnv) -&gt; LiftingContext -&gt; Role -&gt; b)
-&gt; NormM b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682668966"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621682668966"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682668967"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682668967"><span class="hs-identifier hs-var">lc</span></a></span></span><span> </span><span id="local-6989586621682668968"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682668968"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1609"></span><span>               </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682668969"><span class="annot"><span class="annottext">a :: a
</span><a href="#local-6989586621682668969"><span class="hs-identifier hs-var hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NormM a -&gt; (FamInstEnv, FamInstEnv) -&gt; LiftingContext -&gt; Role -&gt; a
forall a.
NormM a -&gt; (FamInstEnv, FamInstEnv) -&gt; LiftingContext -&gt; Role -&gt; a
</span><a href="GHC.Core.FamInstEnv.html#runNormM"><span class="hs-identifier hs-var">runNormM</span></a></span><span> </span><span class="annot"><span class="annottext">NormM a
</span><a href="#local-6989586621682668963"><span class="hs-identifier hs-var">ma</span></a></span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621682668966"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682668967"><span class="hs-identifier hs-var">lc</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682668968"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-1610"></span><span>               </span><span class="annot"><span class="annottext">NormM b -&gt; (FamInstEnv, FamInstEnv) -&gt; LiftingContext -&gt; Role -&gt; b
forall a.
NormM a -&gt; (FamInstEnv, FamInstEnv) -&gt; LiftingContext -&gt; Role -&gt; a
</span><a href="GHC.Core.FamInstEnv.html#runNormM"><span class="hs-identifier hs-var">runNormM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; NormM b
</span><a href="#local-6989586621682668965"><span class="hs-identifier hs-var">fmb</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682668969"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621682668966"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682668967"><span class="hs-identifier hs-var">lc</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682668968"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-1611"></span><span>
</span><span id="line-1612"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621682668975"><span id="local-6989586621682668978"><span id="local-6989586621682668981"><span class="annot"><span class="hs-identifier hs-type">Applicative</span></span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1613"></span><span>  </span><span id="local-6989586621682668984"><span class="annot"><span class="annottext">pure :: forall a. a -&gt; NormM a
</span><span class="hs-identifier hs-var hs-var hs-var">pure</span></span></span><span> </span><span id="local-6989586621682668985"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682668985"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((FamInstEnv, FamInstEnv) -&gt; LiftingContext -&gt; Role -&gt; a)
-&gt; NormM a
forall a.
((FamInstEnv, FamInstEnv) -&gt; LiftingContext -&gt; Role -&gt; a)
-&gt; NormM a
</span><a href="GHC.Core.FamInstEnv.html#NormM"><span class="hs-identifier hs-var">NormM</span></a></span><span> </span><span class="annot"><span class="annottext">(((FamInstEnv, FamInstEnv) -&gt; LiftingContext -&gt; Role -&gt; a)
 -&gt; NormM a)
-&gt; ((FamInstEnv, FamInstEnv) -&gt; LiftingContext -&gt; Role -&gt; a)
-&gt; NormM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682668985"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1614"></span><span>  </span><span id="local-6989586621682668987"><span class="annot"><span class="annottext">&lt;*&gt; :: forall a b. NormM (a -&gt; b) -&gt; NormM a -&gt; NormM b
</span><span class="hs-operator hs-var hs-var hs-var">(&lt;*&gt;)</span></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NormM (a -&gt; b) -&gt; NormM a -&gt; NormM b
forall (m :: * -&gt; *) a b. Monad m =&gt; m (a -&gt; b) -&gt; m a -&gt; m b
</span><span class="hs-identifier hs-var">ap</span></span><span>
</span><span id="line-1615"></span></pre></body></html>