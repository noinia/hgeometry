<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE MultiWayIf #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE ParallelListComp #-}</span><span>
</span><span id="line-3"></span><span>
</span><span id="line-4"></span><span class="hs-comment">-- | Checking for representation-polymorphism using the Concrete mechanism.</span><span>
</span><span id="line-5"></span><span class="hs-comment">--</span><span>
</span><span id="line-6"></span><span class="hs-comment">-- This module contains the logic for enforcing the representation-polymorphism</span><span>
</span><span id="line-7"></span><span class="hs-comment">-- invariants by way of emitting constraints.</span><span>
</span><span id="line-8"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Concrete.html"><span class="hs-identifier">GHC.Tc.Utils.Concrete</span></a></span><span>
</span><span id="line-9"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-comment">-- * Ensuring that a type has a fixed runtime representation</span></span><span>
</span><span id="line-10"></span><span>    </span><span class="annot"><a href="GHC.Tc.Utils.Concrete.html#hasFixedRuntimeRep"><span class="hs-identifier">hasFixedRuntimeRep</span></a></span><span>
</span><span id="line-11"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Concrete.html#hasFixedRuntimeRep_syntactic"><span class="hs-identifier">hasFixedRuntimeRep_syntactic</span></a></span><span>
</span><span id="line-12"></span><span>
</span><span id="line-13"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Concrete.html#unifyConcrete"><span class="hs-identifier">unifyConcrete</span></a></span><span>
</span><span id="line-14"></span><span>
</span><span id="line-15"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Concrete.html#idConcreteTvs"><span class="hs-identifier">idConcreteTvs</span></a></span><span>
</span><span id="line-16"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-18"></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-20"></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html"><span class="hs-identifier">GHC.Builtin.Names</span></a></span><span>       </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html#unsafeCoercePrimName"><span class="hs-identifier">unsafeCoercePrimName</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.html"><span class="hs-identifier">GHC.Builtin.Types</span></a></span><span>       </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.html#liftedTypeKindTyCon"><span class="hs-identifier">liftedTypeKindTyCon</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.html#unliftedTypeKindTyCon"><span class="hs-identifier">unliftedTypeKindTyCon</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html"><span class="hs-identifier">GHC.Core.Coercion</span></a></span><span>       </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#coToMCo"><span class="hs-identifier">coToMCo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#mkCastTyMCo"><span class="hs-identifier">mkCastTyMCo</span></a></span><span>
</span><span id="line-25"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#mkGReflRightMCo"><span class="hs-identifier">mkGReflRightMCo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier">mkNomReflCo</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html"><span class="hs-identifier">GHC.Core.TyCo.Rep</span></a></span><span>       </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier">Type</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCoercion"><span class="hs-identifier">MCoercion</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html"><span class="hs-identifier">GHC.Core.TyCon</span></a></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#isConcreteTyCon"><span class="hs-identifier">isConcreteTyCon</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Type.html"><span class="hs-identifier">GHC.Core.Type</span></a></span><span>           </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Type.html#isConcreteType"><span class="hs-identifier">isConcreteType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier">typeKind</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#mkFunTy"><span class="hs-identifier">mkFunTy</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html"><span class="hs-identifier">GHC.Tc.Types.Constraint</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#NotConcreteError"><span class="hs-identifier">NotConcreteError</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#NotConcreteReason"><span class="hs-identifier">NotConcreteReason</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html"><span class="hs-identifier">GHC.Tc.Types.Evidence</span></a></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Role"><span class="hs-identifier">Role</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#TcCoercionN"><span class="hs-identifier">TcCoercionN</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#TcMCoercionN"><span class="hs-identifier">TcMCoercionN</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html"><span class="hs-identifier">GHC.Tc.Types.Origin</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html"><span class="hs-identifier">GHC.Tc.Utils.Monad</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html"><span class="hs-identifier">GHC.Tc.Utils.TcType</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html"><span class="hs-identifier">GHC.Tc.Utils.TcMType</span></a></span><span>
</span><span id="line-36"></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html"><span class="hs-identifier">GHC.Types.Basic</span></a></span><span>         </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TypeOrKind"><span class="hs-identifier">TypeOrKind</span></a></span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Basic.html#KindLevel"><span class="hs-identifier">KindLevel</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.html"><span class="hs-identifier">GHC.Types.Id</span></a></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.Info.html"><span class="hs-identifier">GHC.Types.Id.Info</span></a></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.html"><span class="hs-identifier">GHC.Types.Name</span></a></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.Env.html"><span class="hs-identifier">GHC.Types.Name.Env</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.html"><span class="hs-identifier">GHC.Types.Var</span></a></span><span>           </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#tyVarKind"><span class="hs-identifier">tyVarKind</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#tyVarName"><span class="hs-identifier">tyVarName</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier">HasDebugCallStack</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html"><span class="hs-identifier">GHC.Data.FastString</span></a></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html#FastString"><span class="hs-identifier">FastString</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier">fsLit</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">void</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.Functor.html"><span class="hs-identifier">Data.Functor</span></a></span><span>       </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-operator">($&gt;)</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.List.NonEmpty.html"><span class="hs-identifier">Data.List.NonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">NonEmpty</span></span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">(:|)</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../transformers-0.6.1.2-38b1/src/Control.Monad.Trans.Class.html"><span class="hs-identifier">Control.Monad.Trans.Class</span></a></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../transformers-0.6.1.2-38b1/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier">lift</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../transformers-0.6.1.2-38b1/src/Control.Monad.Trans.Writer.CPS.html"><span class="hs-identifier">Control.Monad.Trans.Writer.CPS</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../transformers-0.6.1.2-38b1/src/Control.Monad.Trans.Writer.CPS.html#WriterT"><span class="hs-identifier">WriterT</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../transformers-0.6.1.2-38b1/src/Control.Monad.Trans.Writer.CPS.html#runWriterT"><span class="hs-identifier">runWriterT</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../transformers-0.6.1.2-38b1/src/Control.Monad.Trans.Writer.CPS.html#tell"><span class="hs-identifier">tell</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span>
</span><span id="line-56"></span><span class="hs-comment">{- Note [Concrete overview]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
GHC ensures that certain types have a fixed runtime representation in the
typechecker, by emitting certain constraints.
Emitting constraints to be solved later allows us to accept more programs:
if we directly inspected the type (using e.g. `typePrimRep`), we might not
have enough information available (e.g. if the type has kind `TYPE r` for
a metavariable `r` which has not yet been filled in.)

We give here an overview of the various moving parts, to serve
as a central point of reference for this topic.

  * Representation polymorphism
    Note [Representation polymorphism invariants] in GHC.Core
    Note [Representation polymorphism checking]

    The first note explains why we require that certain types have
    a fixed runtime representation.

    The second note details why we sometimes need a constraint to
    perform such checks in the typechecker: we might not know immediately
    whether a type has a fixed runtime representation. For example, we might
    need further unification to take place before being able to decide.
    So, instead of checking immediately, we emit a constraint.

  * What does it mean for a type to be concrete?
    Note [Concrete types] explains what it means for a type to be concrete.

    To compute which representation to use for a type, `typePrimRep` expects
    its kind to be concrete: something specific like `BoxedRep Lifted` or
    `IntRep`; certainly not a type involving type variables or type families.

  * What constraints do we emit?
    Note [The Concrete mechanism]

    Instead of simply checking that a type `ty` is concrete (i.e. computing
    'isConcreteType`), we emit an equality constraint:

       co :: ty ~# concrete_ty

    where 'concrete_ty' is a concrete metavariable: a metavariable whose 'MetaInfo'
    is 'ConcreteTv', signifying that it can only be unified with a concrete type.

    The Note explains that this allows us to accept more programs. The Note
    also explains that the implementation is happening in two phases
    (PHASE 1 and PHASE 2).
    In PHASE 1 (the current implementation) we only allow trivial evidence
    of the form `co = Refl`.

  * Fixed runtime representation vs fixed RuntimeRep
    Note [Fixed RuntimeRep]

    We currently enforce the representation-polymorphism invariants by checking
    that binders and function arguments have a &quot;fixed RuntimeRep&quot;.

    This is slightly less general than we might like, as this rules out
    types with kind `TYPE (BoxedRep l)`: we know that this will be represented
    by a pointer, which should be enough to go on in many situations.

  * When do we emit these constraints?
    Note [hasFixedRuntimeRep]

    We introduce constraints to satisfy the representation-polymorphism
    invariants outlined in Note [Representation polymorphism invariants] in GHC.Core,
    which mostly amounts to the following two cases:

      - checking that a binder has a fixed runtime representation,
      - checking that a function argument has a fixed runtime representation.

    The Note explains precisely how and where these constraints are emitted.

  * Reporting unsolved constraints
    Note [Reporting representation-polymorphism errors] in GHC.Tc.Types.Origin

    When we emit a constraint to enforce a fixed representation, we also provide
    a 'FixedRuntimeRepOrigin' which gives context about the check being done.
    This origin gets reported to the user if we end up with such an an unsolved Wanted constraint.

Note [Representation polymorphism checking]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
According to the &quot;Levity Polymorphism&quot; paper (PLDI '17),
there are two places in which we must know that a type has a
fixed runtime representation, as explained in
  Note [Representation polymorphism invariants] in GHC.Core:

  I1. the type of a bound term-level variable,
  I2. the type of an argument to a function.

The paper explains the restrictions more fully, but briefly:
expressions in these contexts need to be stored in registers, and it's
hard (read: impossible) to store something that does not have a
fixed runtime representation.

In practice, we enforce these types to have a /fixed RuntimeRep/, which is slightly
stronger, as explained in Note [Fixed RuntimeRep].

There are two different ways we check whether a given type
has a fixed runtime representation, both in the typechecker:

  1. When typechecking type declarations (e.g. datatypes, typeclass, pattern synonyms),
     under the GHC.Tc.TyCl module hierarchy.
     In these situations, we can immediately reject bad representation polymorphism.

     For instance, the following datatype declaration

       data Foo (r :: RuntimeRep) (a :: TYPE r) = Foo a

     is rejected in GHC.Tc.TyCl.checkValidDataCon upon seeing that the type 'a'
     is representation-polymorphic.

     Such checks are done using `GHC.Tc.Utils.TcMType.checkTypeHasFixedRuntimeRep`,
     with `GHC.Tc.Errors.Types.FixedRuntimeRepProvenance` describing the different
     contexts in which bad representation polymorphism can occur while validity checking.

  2. When typechecking value-level declarations (functions, expressions, patterns, ...),
     under the GHC.Tc.Gen module hierarchy.
     In these situations, the typechecker might need to do some work to figure out
     whether a type has a fixed runtime representation or not. For instance,
     GHC might introduce a metavariable (rr :: RuntimeRep), which is only later
     (through constraint solving) discovered to be equal to FloatRep.

     This is handled by the Concrete mechanism outlined in
     Note [The Concrete mechanism] in GHC.Tc.Utils.Concrete.
     See Note [Concrete overview] in GHC.Tc.Utils.Concrete for an overview
     of the various moving parts.

Note [Concrete types]
~~~~~~~~~~~~~~~~~~~~~
Definition: a type is /concrete/ iff it is:
            - a concrete type constructor (as defined below), or
            - a concrete type variable (see Note [ConcreteTv] below), or
            - an application of a concrete type to another concrete type
GHC.Core.Type.isConcreteType checks whether a type meets this definition.

Definition: a /concrete type constructor/ is defined by
            - a promoted data constructor
            - a class, data type or newtype
            - a primitive type like Array# or Int#
            - an abstract type as defined in a Backpack signature file
              (see Note [Synonyms implement abstract data] in GHC.Tc.Module)
            In particular, type and data families are not concrete.
GHC.Core.TyCon.isConcreteTyCon checks whether a TyCon meets this definition.

Examples of concrete types:
   Lifted, BoxedRep Lifted, TYPE (BoxedRep Lifted) are all concrete
Examples of non-concrete types
   F Int, TYPE (F Int), TYPE r, a[sk]
   NB: (F Int) is not concrete because F is a type function

The recursive definition of concreteness entails the following property:

Concrete Congruence Property (CCP)
  All sub-trees of a concrete type tree are concrete.

The following property also holds due to the invariant that the kind of a
concrete metavariable is itself concrete (see Note [ConcreteTv]):

Concrete Kinds Property (CKP)
  The kind of a concrete type is concrete.

Note [ConcreteTv]
~~~~~~~~~~~~~~~~~
A concrete metavariable is a metavariable whose 'MetaInfo' is 'ConcreteTv'.
Similar to 'TyVarTv's which are type variables which can only be unified with
other type variables, a 'ConcreteTv' type variable is a type variable which can
only be unified with a concrete type (in the sense of Note [Concrete types]).

INVARIANT: the kind of a concrete metavariable is concrete.

This invariant is upheld at the time of creation of a new concrete metavariable.

Concrete metavariables are useful for representation-polymorphism checks:
they allow us to refer to a type whose representation is not yet known but will
be figured out by the typechecker (see Note [The Concrete mechanism]).

Note [The Concrete mechanism]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
To check (ty :: ki) has a fixed runtime representation, we proceed as follows:

  - Create a new concrete metavariable `concrete_tv`, i.e. a metavariable
    with 'ConcreteTv' 'MetaInfo' (see Note [ConcreteTv]).

  - Emit an equality constraint:

      ki ~# concrete_tv

    The origin for such an equality constraint uses
    `GHC.Tc.Types.Origin.FixedRuntimeRepOrigin`, so that we can report the
    appropriate representation-polymorphism error if any such constraint
    goes unsolved.

To solve `ki ~# concrete_ki`, we must unify `concrete_tv := concrete_ki`,
where `concrete_ki` is some concrete type. We can then compute `kindPrimRep`
on `concrete_ki` to compute the representation: this means `ty` indeed
has a fixed runtime representation.

-------------------------
-- PHASE 1 and PHASE 2 --
-------------------------

The Concrete mechanism is being implemented in two separate phases.

In PHASE 1, we enforce that we only solve the emitted constraints
`co :: ki ~# concrete_tv` with `Refl`. This forbids any program
which requires type family evaluation in order to determine that a 'RuntimeRep'
is fixed.
To achieve this, instead of creating a new concrete metavariable, we directly
ensure that 'ki' is concrete, using 'makeTypeConcrete'. If it fails, then
we report an error (even though rewriting might have allowed us to proceed).

In PHASE 2, we lift this restriction. This means we replace a call to
`hasFixedRuntimeRep_syntactic` with a call to `hasFixedRuntimeRep`, and insert the
obtained coercion in the typechecked result. To illustrate what this entails,
recall that the code generator needs to be able to compute 'PrimRep's, so that it
can put function arguments in the correct registers, etc.
As a result, we must insert additional casts in Core to ensure that no type family
reduction is needed to be able to compute 'PrimRep's. For example, the Core

  f = /\ ( a :: F Int ). \ ( x :: a ). some_expression

is problematic when 'F' is a type family: we don't know what runtime representation to use
for 'x', so we can't compile this function (we can't evaluate type family applications
after we are done with typechecking). Instead, we ensure the 'RuntimeRep' is always
explicitly visible:

  f = /\ ( a :: F Int ). \ ( x :: ( a |&gt; kco ) ). some_expression

where 'kco' is the appropriate coercion; for example if `F Int = TYPE Int#`
this would be:

  kco :: F Int ~# TYPE Int#

As `( a |&gt; kco ) :: TYPE Int#`, the code generator knows to use a machine-sized
integer register for `x`, and all is good again.

Because we can convert calls from hasFixedRuntimeRep_syntactic to
hasFixedRuntimeRep one at a time, we can migrate from PHASE 1 to PHASE 2
incrementally.

Example test cases that require PHASE 2: T13105, T17021, T20363b.

Note [Fixed RuntimeRep]
~~~~~~~~~~~~~~~~~~~~~~~
Definitions:

  FRR.

    The type `ty :: ki` has a /syntactically fixed RuntimeRep/
    (we also say that `ty` is an `FRRType`)
      &lt;=&gt;
    the kind `ki` is concrete (in the sense of Note [Concrete types])
      &lt;=&gt;
    `typePrimRep ty` (= `kindPrimRep ki`) does not crash
    (assuming that typechecking succeeded, so that all metavariables
    in `ty` have been filled)

  Fixed RuntimeRep.

    The type `ty :: ki` has a /fixed RuntimeRep/
      &lt;=&gt;
    there exists an FRR type `ty'` with `ty ~# ty'`
      &lt;=&gt;
    there exists a concrete type `concrete_ki` such that
    `ki ~ concrete_ki`

These definitions are crafted to be useful to satisfy the invariants of
Core; see Note [Representation polymorphism invariants] in GHC.Core.

Notice that &quot;fixed RuntimeRep&quot; means (for now anyway) that
  * we know the runtime representation, and
  * we know the levity.

For example (ty :: TYPE (BoxedRep l)), where `l` is a levity variable
is /not/ &quot;fixed RuntimeRep&quot;, even though it is always represented by
a heap pointer, because we don't know the levity.  In due course we
will want to make finer distinctions, as explained in the paper
Kinds are Calling Conventions [ICFP'20], but this suffices for now.

Note [hasFixedRuntimeRep]
~~~~~~~~~~~~~~~~~~~~~~~~~
The 'hasFixedRuntimeRep' function is responsible for taking a type 'ty'
and emitting a constraint to ensure that 'ty' has a fixed `RuntimeRep`,
as outlined in Note [The Concrete mechanism].

To do so, we compute the kind 'ki' of 'ty', create a new concrete metavariable
`concrete_tv` of kind `ki`, and emit a constraint `ki ~# concrete_tv`,
which will only be solved if we can prove that 'ty' indeed has a fixed RuntimeRep.

If we can solve the equality constraint, i.e. produce a coercion
`kco :: ki ~# concrete_tv`, then 'hasFixedRuntimeRep' returns the coercion

  co = GRefl ty kco :: ty ~# ty |&gt; kco

The RHS of the coercion `co` is `ty |&gt; kco`. The kind of this type is
concrete (by construction), which means that `ty |&gt; kco` is an FRRType
in the sense of Note [Fixed RuntimeRep], so that we can directely compute
its runtime representation using `typePrimRep`.

  [Wrinkle: Typed Template Haskell]
    We don't perform any checks when type-checking a typed Template Haskell quote:
    we want to allow representation polymorphic quotes, as long as they are
    monomorphised at splice site.

    Example:

      Module1

        repPolyId :: forall r (a :: TYPE r). CodeQ (a -&gt; a)
        repPolyId = [|| \ x -&gt; x ||]

      Module2

        import Module1

        id1 :: Int -&gt; Int
        id1 = $$repPolyId

        id2 :: Int# -&gt; Int#
        id2 = $$repPolyId

    We implement this skip by inspecting the TH stage in `hasFixedRuntimeRep`.

    A better solution would be to use 'CodeC' constraints, as in the paper
      &quot;Staging With Class&quot;, POPL 2022
        by Ningning Xie, Matthew Pickering, Andres L&#246;h, Nicolas Wu, Jeremy Yallop, Meng Wang
    but for the moment, as we will typecheck again when splicing,
    this shouldn't cause any problems in practice.  See ticket #18170.

    Test case: rep-poly/T18170a.


Note [Representation-polymorphic Ids with no binding]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We cannot have representation-polymorphic or levity-polymorphic
function arguments. See Note [Representation polymorphism invariants]
in GHC.Core.  That is checked in 'GHC.Tc.Gen.App.tcInstFun', see the call
to 'matchActualFunTy', which performs the representation-polymorphism
check.

However, some special Ids have representation-polymorphic argument
types. These are all GHC built-ins or data constructors. They have no binding;
instead they have compulsory unfoldings. Specifically, these Ids are:

1. Some wired-in Ids, such as coerce, oneShot and unsafeCoerce# (which is only
   partly wired-in),
2. Representation-polymorphic primops, such as raise#.
3. Representation-polymorphic data constructors: unboxed tuples
   and unboxed sums.
4. Newtype constructors with `UnliftedNewtypes` which have
   a representation-polymorphic argument.

For (1) consider
  badId :: forall r (a :: TYPE r). a -&gt; a
  badId = unsafeCoerce# @r @r @a @a

The (partly) wired-in function
  unsafeCoerce# :: forall (r1 :: RuntimeRep) (r2 :: RuntimeRep)
                   (a :: TYPE r1) (b :: TYPE r2).
                   a -&gt; b
has a convenient but representation-polymorphic type. It has no
binding; instead it has a compulsory unfolding, after which we
would have
  badId = /\r /\(a :: TYPE r). \(x::a). ...body of unsafeCorece#...
And this is no good because of that rep-poly \(x::a).  So we want
to reject this.

On the other hand
  goodId :: forall (a :: Type). a -&gt; a
  goodId = unsafeCoerce# @LiftedRep @LiftedRep @a @a

is absolutely fine, because after we inline the unfolding, the \(x::a)
is representation-monomorphic.

Test cases: T14561, RepPolyWrappedVar2.

For primops (2) and unboxed tuples/sums (3), the situation is similar;
they are eta-expanded in CorePrep to be saturated, and that eta-expansion
must not add a representation-polymorphic lambda.

Test cases: T14561b, RepPolyWrappedVar, UnliftedNewtypesCoerceFail.

The Note [Representation-polymorphism checking built-ins] explains how we handle
cases (1) (2) and (3).

For (4), consider a representation-polymorphic newtype with
UnliftedNewtypes:

  type Id :: forall r. TYPE r -&gt; TYPE r
  newtype Id a where { MkId :: a }

  bad :: forall r (a :: TYPE r). a -&gt; Id a
  bad = MkId @r @a             -- Want to reject

  good :: forall (a :: Type). a -&gt; Id a
  good = MkId @LiftedRep @a   -- Want to accept

Test cases: T18481, UnliftedNewtypesLevityBinder

(4) is handled differently than (1) (2) and (3);
see Note [Eta-expanding rep-poly unlifted newtypes].

Note [Representation-polymorphism checking built-ins]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Some primops and wired-in functions are representation-polymorphic, but must
only be instantiated at particular, concrete representations.
There are three cases, all for `hasNoBinding` Ids:

* Wired-in Ids.  For example, `seq`
  is a wired-in Id, defined in GHC.Types.Id.Make.seqId, with this type:

  seq :: forall {r} a (b :: TYPE r). a -&gt; b -&gt; b

  It is more like a macro than a regular Id: it has /compulsory/ unfolding, so
  we inline it at every call site.  At those call sites we should instantiate
  `r` with a concrete RuntimeRep, so that the lambda has a concrete representation.
  So somehow the type checker has to ensure that `seq` is called with a concrete
  instantiation for `r`.

  NB: unsafeCoerce# is not quite wired-in (see Note [Wiring in unsafeCoerce#] in GHC.HsToCore),
  but it gets a similar treatment.

* PrimOps. Some representation-polymorphic primops must be called at a concrete
  type.  For example:

  catch# :: forall {r} {l} (k :: TYPE r) (w :: TYPE (BoxedRep l)).
              (State# RealWorld -&gt; (# State# RealWorld, k #) )
           -&gt; (w -&gt; State# RealWorld -&gt; (# State# RealWorld, k #) )
           -&gt; State# RealWorld -&gt; (# State# RealWorld, k #)

  This primop pushes a &quot;catch frame&quot; on the stack, which must &quot;know&quot;
  the return convention of `k`.  So `k` must be concrete, so we know
  what kind of catch-frame to push. (See #21868 for more details.

  So again we want to ensure that `r` is instantiated with a concrete RuntimeRep.

* Unboxed-tuple data constructors.  Consider the unboxed pair data constructor:

  (#,#) :: forall {r1} {r2} (a :: TYPE r1) (b :: TYPE r2). a -&gt; b -&gt; (# a, b #)

  Again, we need concrete `r1` and `r2`. For example, we want to reject

    f :: forall r (a :: TYPE r). a -&gt; (# Int, a #)
    f = (#,#) 3

As pointed out in #21906; we see here that it is not enough to simply check
the representation of the argument types, as for example &quot;k :: TYPE r&quot; in the
type of catch# occurs in negative position but not directly as the type of
an argument.

NB: we specifically *DO NOT* handle representation-polymorphic unlifted newtypes
with this mechanism. See Note [Eta-expanding rep-poly unlifted newtypes] for an
overview of representation-polymorphism checks for those.

To achieve this goal, for these these three kinds of `hasNoBinding` functions:

* We identify the quantified variable `r` as a &quot;concrete quantifier&quot;

* When instantiating a concrete quantifier, such as `r`, at a call site, we
  instantiate with a ConcreteTv meta-tyvar, `r0[conc]`.
  See Note [ConcreteTv] in GHC.Tc.Utils.Concrete.

Now the type checker will ensure that `r0` is instantiated with a concrete
RuntimeRep.

Here are the moving parts:

* In the IdDetails of an Id, we record a mapping from type variable name
  to concreteness information, in the form of a ConcreteTvOrigin.
  See 'idDetailsConcreteTvs'.

  The ConcreteTvOrigin is used to determine which error message to show
  to the user if the type variable gets instantiated to a non-concrete type;
  this is slightly more granular than simply storing a set of type variable names.

* The domain of this NameEnv is the outer forall'd TyVars of that
  Id's type.  (A bit yukky because it means that alpha-renaming that type
  would be invalid.  But we never do that.)  So `seq` has
    Type:       forall {r} a (b :: TYPE r). a -&gt; b -&gt; b
    IdDetails:  RepPolyId [ r :-&gt; ConcreteFRR (FixedRuntimeRepOrigin b (..)) ]

* When instantiating the type of an Id at a call site, at the call to
  GHC.Tc.Utils.Instantiate.instantiateSigma in GHC.Tc.Gen.App.tcInstFun,
  create ConcreteTv metavariables (instead of TauTvs) based on the
  ConcreteTyVars stored in the IdDetails of the Id.

Note that the /only/ place that one of these restricted rep-poly Ids can enter
typechecking is in `tcInferId`, and all the interesting cases then land
in `tcInstFun` where we take care to instantantiate those concrete
type variables correctly.

  Design alternative: in some ways, it would be more kosher for the concrete-ness
  to be stored in the /type/, thus  forall (r[conc] :: RuntimeRep). ty.
  But that pollutes Type for a very narrow use-case; so instead we adopt the
  more ad-hoc solution described above.

Examples:

  ok :: forall (a :: Type) (b :: Type). a -&gt; b -&gt; b
  ok = seq

  bad :: forall s (b :: TYPE s). Int -&gt; b -&gt; b
  bad x = seq x

    Here we will instantiate the RuntimeRep skolem variable r from the type
    of seq to a concrete metavariable rr[conc].
    For 'ok' we will unify rr := LiftedRep, and for 'bad' we will fail to
    solve rr[conc] ~# s[sk] and report a representation-polymorphism error to
    the user.

  type RR :: RuntimeRep
  type family RR where { RR = IntRep }

  tricky1, tricky2 :: forall (b :: TYPE RR). Int -&gt; b -&gt; b
  tricky1 = seq
  tricky2 = seq @RR

    'tricky1' proceeds as above: we instantiate r |-&gt; rr[conc], get a Wanted
    rr[conc] ~# RR, which we solve by rewriting the type family.

    For 'tricky2', we again create a fresh ConcreteTv metavariable rr[conc],
    and we then proceed as if the user had written &quot;seq @rr&quot;, but adding an
    additional [W] rr ~ RR to the constraint solving context.

[Wrinkle: VTA]

  We must also handle the case when the user has instantiated the type variables
  themselves, with a visible type application. We do this in GHC.Tc.Gen.App.tcVTA.

  For example:

    type F :: Type -&gt; RuntimeRep
    type family F a where { F Bool = IntRep }

    foo = (# , #) @(F Bool) @FloatRep

  We want to accept &quot;foo&quot; even though &quot;F Bool&quot; is not a concrete RuntimeRep.
  We proceed as follows (see tcVTA):

    - create a fresh concrete metavariable kappa,
    - emit [W] F Bool ~ kappa[conc]
    - pretend the user wrote (#,#) @kappa.

  The solver will then unify kappa := IntRep, after rewriting the type family
  application on the LHS of the Wanted.

  Note that this is a bit of a corner case: only a few built-ins, such as
  unsafeCoerce# and unboxed tuples, have specified (not inferred) RuntimeRep
  quantified variables which can be instantiated by the user with a
  visible type application.
  For example,

    coerce :: forall {r :: RuntimeRep} (a :: TYPE r) (b :: TYPE r)
           .  Coercible a b =&gt; a -&gt; b

  does not allow the RuntimeRep argument to be specified by a visible type
  application.
-}</span><span>
</span><span id="line-613"></span><span>
</span><span id="line-614"></span><span class="hs-comment">-- | Given a type @ty :: ki@, this function ensures that @ty@</span><span>
</span><span id="line-615"></span><span class="hs-comment">-- has a __fixed__ 'RuntimeRep', by emitting a new equality constraint</span><span>
</span><span id="line-616"></span><span class="hs-comment">-- @ki ~ concrete_tv@ for a concrete metavariable @concrete_tv@.</span><span>
</span><span id="line-617"></span><span class="hs-comment">--</span><span>
</span><span id="line-618"></span><span class="hs-comment">-- Returns a coercion @co :: ty ~# concrete_ty@ as evidence.</span><span>
</span><span id="line-619"></span><span class="hs-comment">-- If @ty@ obviously has a fixed 'RuntimeRep', e.g @ki = IntRep@,</span><span>
</span><span id="line-620"></span><span class="hs-comment">-- then this function immediately returns 'MRefl',</span><span>
</span><span id="line-621"></span><span class="hs-comment">-- without emitting any constraints.</span><span>
</span><span id="line-622"></span><span class="annot"><a href="GHC.Tc.Utils.Concrete.html#hasFixedRuntimeRep"><span class="hs-identifier hs-type">hasFixedRuntimeRep</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span>
</span><span id="line-623"></span><span>                   </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#FixedRuntimeRepContext"><span class="hs-identifier hs-type">FixedRuntimeRepContext</span></a></span><span>
</span><span id="line-624"></span><span>                        </span><span class="hs-comment">-- ^ Context to be reported to the user</span><span>
</span><span id="line-625"></span><span>                        </span><span class="hs-comment">-- if the type ends up not having a fixed</span><span>
</span><span id="line-626"></span><span>                        </span><span class="hs-comment">-- 'RuntimeRep'.</span><span>
</span><span id="line-627"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>
</span><span id="line-628"></span><span>                        </span><span class="annot"><span class="hs-comment">-- ^ The type to check (we only look at its kind).</span></span><span>
</span><span id="line-629"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#TcCoercionN"><span class="hs-identifier hs-type">TcCoercionN</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcTypeFRR"><span class="hs-identifier hs-type">TcTypeFRR</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-630"></span><span>                        </span><span class="hs-comment">-- ^ @(co, ty')@ where @ty' :: ki'@,</span><span>
</span><span id="line-631"></span><span>                        </span><span class="hs-comment">-- @ki@ is concrete, and @co :: ty ~# ty'@.</span><span>
</span><span id="line-632"></span><span>                        </span><span class="hs-comment">-- That is, @ty'@ has a syntactically fixed RuntimeRep</span><span>
</span><span id="line-633"></span><span>                        </span><span class="hs-comment">-- in the sense of Note [Fixed RuntimeRep].</span><span>
</span><span id="line-634"></span><span id="hasFixedRuntimeRep"><span class="annot"><span class="annottext">hasFixedRuntimeRep :: HasDebugCallStack =&gt;
FixedRuntimeRepContext -&gt; TcType -&gt; TcM (TcCoercionN, TcType)
</span><a href="GHC.Tc.Utils.Concrete.html#hasFixedRuntimeRep"><span class="hs-identifier hs-var hs-var">hasFixedRuntimeRep</span></a></span></span><span> </span><span id="local-6989586621683015565"><span class="annot"><span class="annottext">FixedRuntimeRepContext
</span><a href="#local-6989586621683015565"><span class="hs-identifier hs-var">frr_ctxt</span></a></span></span><span> </span><span id="local-6989586621683015566"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015566"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-635"></span><span>  </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
(FixedRuntimeRepOrigin -&gt; TcType -&gt; TcM TcMCoercionN)
-&gt; FixedRuntimeRepContext -&gt; TcType -&gt; TcM (TcCoercionN, TcType)
(FixedRuntimeRepOrigin -&gt; TcType -&gt; TcM TcMCoercionN)
-&gt; FixedRuntimeRepContext -&gt; TcType -&gt; TcM (TcCoercionN, TcType)
</span><a href="GHC.Tc.Utils.Concrete.html#checkFRR_with"><span class="hs-identifier hs-var">checkFRR_with</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
FastString -&gt; ConcreteTvOrigin -&gt; TcType -&gt; TcM TcMCoercionN
FastString -&gt; ConcreteTvOrigin -&gt; TcType -&gt; TcM TcMCoercionN
</span><a href="GHC.Tc.Utils.Concrete.html#unifyConcrete"><span class="hs-identifier hs-var">unifyConcrete</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; FastString
</span><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;cx&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ConcreteTvOrigin -&gt; TcType -&gt; TcM TcMCoercionN)
-&gt; (FixedRuntimeRepOrigin -&gt; ConcreteTvOrigin)
-&gt; FixedRuntimeRepOrigin
-&gt; TcType
-&gt; TcM TcMCoercionN
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">FixedRuntimeRepOrigin -&gt; ConcreteTvOrigin
</span><a href="GHC.Tc.Utils.TcType.html#ConcreteFRR"><span class="hs-identifier hs-var">ConcreteFRR</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">FixedRuntimeRepContext
</span><a href="#local-6989586621683015565"><span class="hs-identifier hs-var">frr_ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015566"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-636"></span><span>
</span><span id="line-637"></span><span class="hs-comment">-- | Like 'hasFixedRuntimeRep', but we perform an eager syntactic check.</span><span>
</span><span id="line-638"></span><span class="hs-comment">--</span><span>
</span><span id="line-639"></span><span class="hs-comment">-- Throws an error in the 'TcM' monad if the check fails.</span><span>
</span><span id="line-640"></span><span class="hs-comment">--</span><span>
</span><span id="line-641"></span><span class="hs-comment">-- This is useful if we are not actually going to use the coercion returned</span><span>
</span><span id="line-642"></span><span class="hs-comment">-- from 'hasFixedRuntimeRep'; it would generally be unsound to allow a non-reflexive</span><span>
</span><span id="line-643"></span><span class="hs-comment">-- coercion but not actually make use of it in a cast.</span><span>
</span><span id="line-644"></span><span class="hs-comment">--</span><span>
</span><span id="line-645"></span><span class="hs-comment">-- The goal is to eliminate all uses of this function and replace them with</span><span>
</span><span id="line-646"></span><span class="hs-comment">-- 'hasFixedRuntimeRep', making use of the returned coercion. This is what</span><span>
</span><span id="line-647"></span><span class="hs-comment">-- is meant by going from PHASE 1 to PHASE 2, in Note [The Concrete mechanism].</span><span>
</span><span id="line-648"></span><span class="annot"><a href="GHC.Tc.Utils.Concrete.html#hasFixedRuntimeRep_syntactic"><span class="hs-identifier hs-type">hasFixedRuntimeRep_syntactic</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span>
</span><span id="line-649"></span><span>                             </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#FixedRuntimeRepContext"><span class="hs-identifier hs-type">FixedRuntimeRepContext</span></a></span><span>
</span><span id="line-650"></span><span>                                  </span><span class="hs-comment">-- ^ Context to be reported to the user</span><span>
</span><span id="line-651"></span><span>                                  </span><span class="hs-comment">-- if the type does not have a syntactically</span><span>
</span><span id="line-652"></span><span>                                  </span><span class="hs-comment">-- fixed 'RuntimeRep'.</span><span>
</span><span id="line-653"></span><span>                             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>
</span><span id="line-654"></span><span>                                  </span><span class="annot"><span class="hs-comment">-- ^ The type to check (we only look at its kind).</span></span><span>
</span><span id="line-655"></span><span>                             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-656"></span><span id="hasFixedRuntimeRep_syntactic"><span class="annot"><span class="annottext">hasFixedRuntimeRep_syntactic :: HasDebugCallStack =&gt; FixedRuntimeRepContext -&gt; TcType -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Concrete.html#hasFixedRuntimeRep_syntactic"><span class="hs-identifier hs-var hs-var">hasFixedRuntimeRep_syntactic</span></a></span></span><span> </span><span id="local-6989586621683015575"><span class="annot"><span class="annottext">FixedRuntimeRepContext
</span><a href="#local-6989586621683015575"><span class="hs-identifier hs-var">frr_ctxt</span></a></span></span><span> </span><span id="local-6989586621683015576"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015576"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-657"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcM (TcCoercionN, TcType) -&gt; TcM ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(TcM (TcCoercionN, TcType) -&gt; TcM ())
-&gt; TcM (TcCoercionN, TcType) -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
(FixedRuntimeRepOrigin -&gt; TcType -&gt; TcM TcMCoercionN)
-&gt; FixedRuntimeRepContext -&gt; TcType -&gt; TcM (TcCoercionN, TcType)
(FixedRuntimeRepOrigin -&gt; TcType -&gt; TcM TcMCoercionN)
-&gt; FixedRuntimeRepContext -&gt; TcType -&gt; TcM (TcCoercionN, TcType)
</span><a href="GHC.Tc.Utils.Concrete.html#checkFRR_with"><span class="hs-identifier hs-var">checkFRR_with</span></a></span><span> </span><span class="annot"><span class="annottext">FixedRuntimeRepOrigin -&gt; TcType -&gt; TcM TcMCoercionN
</span><a href="#local-6989586621683015577"><span class="hs-identifier hs-var">ensure_conc</span></a></span><span> </span><span class="annot"><span class="annottext">FixedRuntimeRepContext
</span><a href="#local-6989586621683015575"><span class="hs-identifier hs-var">frr_ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015576"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-658"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-659"></span><span>      </span><span class="annot"><a href="#local-6989586621683015577"><span class="hs-identifier hs-type">ensure_conc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#FixedRuntimeRepOrigin"><span class="hs-identifier hs-type">FixedRuntimeRepOrigin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcKind"><span class="hs-identifier hs-type">TcKind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#TcMCoercionN"><span class="hs-identifier hs-type">TcMCoercionN</span></a></span><span>
</span><span id="line-660"></span><span>      </span><span id="local-6989586621683015577"><span class="annot"><span class="annottext">ensure_conc :: FixedRuntimeRepOrigin -&gt; TcType -&gt; TcM TcMCoercionN
</span><a href="#local-6989586621683015577"><span class="hs-identifier hs-var hs-var">ensure_conc</span></a></span></span><span> </span><span id="local-6989586621683015579"><span class="annot"><span class="annottext">FixedRuntimeRepOrigin
</span><a href="#local-6989586621683015579"><span class="hs-identifier hs-var">frr_orig</span></a></span></span><span> </span><span id="local-6989586621683015580"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015580"><span class="hs-identifier hs-var">ki</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; FixedRuntimeRepOrigin -&gt; TcType -&gt; TcM TcType
FixedRuntimeRepOrigin -&gt; TcType -&gt; TcM TcType
</span><a href="GHC.Tc.Utils.Concrete.html#ensureConcrete"><span class="hs-identifier hs-var">ensureConcrete</span></a></span><span> </span><span class="annot"><span class="annottext">FixedRuntimeRepOrigin
</span><a href="#local-6989586621683015579"><span class="hs-identifier hs-var">frr_orig</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015580"><span class="hs-identifier hs-var">ki</span></a></span><span> </span><span class="annot"><span class="annottext">TcM TcType -&gt; TcMCoercionN -&gt; TcM TcMCoercionN
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; b -&gt; f b
</span><span class="hs-operator hs-var">$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TcMCoercionN
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span>
</span><span id="line-661"></span><span>
</span><span id="line-662"></span><span class="hs-comment">-- | Internal function to check whether the given type has a fixed 'RuntimeRep'.</span><span>
</span><span id="line-663"></span><span class="hs-comment">--</span><span>
</span><span id="line-664"></span><span class="hs-comment">-- Use 'hasFixedRuntimeRep' to allow rewriting, or 'hasFixedRuntimeRep_syntactic'</span><span>
</span><span id="line-665"></span><span class="hs-comment">-- to perform a syntactic check.</span><span>
</span><span id="line-666"></span><span class="annot"><a href="GHC.Tc.Utils.Concrete.html#checkFRR_with"><span class="hs-identifier hs-type">checkFRR_with</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span>
</span><span id="line-667"></span><span>              </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#FixedRuntimeRepOrigin"><span class="hs-identifier hs-type">FixedRuntimeRepOrigin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcKind"><span class="hs-identifier hs-type">TcKind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#TcMCoercionN"><span class="hs-identifier hs-type">TcMCoercionN</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-668"></span><span>                   </span><span class="annot"><span class="hs-comment">-- ^ The check to perform on the kind.</span></span><span>
</span><span id="line-669"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#FixedRuntimeRepContext"><span class="hs-identifier hs-type">FixedRuntimeRepContext</span></a></span><span>
</span><span id="line-670"></span><span>                   </span><span class="hs-comment">-- ^ The context which required a fixed 'RuntimeRep',</span><span>
</span><span id="line-671"></span><span>                   </span><span class="hs-comment">-- e.g. an application, a lambda abstraction, ...</span><span>
</span><span id="line-672"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>
</span><span id="line-673"></span><span>                   </span><span class="annot"><span class="hs-comment">-- ^ The type @ty@ to check (the check itself only looks at its kind).</span></span><span>
</span><span id="line-674"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#TcCoercionN"><span class="hs-identifier hs-type">TcCoercionN</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcTypeFRR"><span class="hs-identifier hs-type">TcTypeFRR</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-675"></span><span>                  </span><span class="hs-comment">-- ^ Returns @(co, frr_ty)@ with @co :: ty ~# frr_ty@</span><span>
</span><span id="line-676"></span><span>                  </span><span class="hs-comment">-- and @frr_@ty has a fixed 'RuntimeRep'.</span><span>
</span><span id="line-677"></span><span id="checkFRR_with"><span class="annot"><span class="annottext">checkFRR_with :: HasDebugCallStack =&gt;
(FixedRuntimeRepOrigin -&gt; TcType -&gt; TcM TcMCoercionN)
-&gt; FixedRuntimeRepContext -&gt; TcType -&gt; TcM (TcCoercionN, TcType)
</span><a href="GHC.Tc.Utils.Concrete.html#checkFRR_with"><span class="hs-identifier hs-var hs-var">checkFRR_with</span></a></span></span><span> </span><span id="local-6989586621683015592"><span class="annot"><span class="annottext">FixedRuntimeRepOrigin -&gt; TcType -&gt; TcM TcMCoercionN
</span><a href="#local-6989586621683015592"><span class="hs-identifier hs-var">check_kind</span></a></span></span><span> </span><span id="local-6989586621683015593"><span class="annot"><span class="annottext">FixedRuntimeRepContext
</span><a href="#local-6989586621683015593"><span class="hs-identifier hs-var">frr_ctxt</span></a></span></span><span> </span><span id="local-6989586621683015594"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015594"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-678"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683015595"><span class="annot"><a href="#local-6989586621683015595"><span class="hs-identifier hs-var">th_stage</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM ThStage
</span><a href="GHC.Tc.Utils.Monad.html#getStage"><span class="hs-identifier hs-var">getStage</span></a></span><span>
</span><span id="line-679"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span>
</span><span id="line-680"></span><span>          </span><span class="hs-comment">-- Shortcut: check for 'Type' and 'UnliftedType' type synonyms.</span><span>
</span><span id="line-681"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyConApp"><span class="hs-identifier hs-type">TyConApp</span></a></span><span> </span><span id="local-6989586621683015598"><span class="annot"><a href="#local-6989586621683015598"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621683015599"><span class="hs-identifier hs-type">ki</span></a></span><span>
</span><span id="line-682"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683015598"><span class="hs-identifier hs-type">tc</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">==</span></span><span> </span><span class="annot"><a href="GHC.Builtin.Types.html#liftedTypeKindTyCon"><span class="hs-identifier hs-type">liftedTypeKindTyCon</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">||</span></span><span> </span><span class="annot"><a href="#local-6989586621683015598"><span class="hs-identifier hs-type">tc</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">==</span></span><span> </span><span class="annot"><a href="GHC.Builtin.Types.html#unliftedTypeKindTyCon"><span class="hs-identifier hs-type">unliftedTypeKindTyCon</span></a></span><span>
</span><span id="line-683"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683015601"><span class="hs-identifier hs-type">refl</span></a></span><span>
</span><span id="line-684"></span><span>
</span><span id="line-685"></span><span>          </span><span class="hs-comment">-- See [Wrinkle: Typed Template Haskell] in Note [hasFixedRuntimeRep].</span><span>
</span><span id="line-686"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TH.html#Brack"><span class="hs-identifier hs-type">Brack</span></a></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.TH.html#TcPending"><span class="hs-identifier hs-type">TcPending</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621683015595"><span class="hs-identifier hs-type">th_stage</span></a></span><span>
</span><span id="line-687"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683015601"><span class="hs-identifier hs-type">refl</span></a></span><span>
</span><span id="line-688"></span><span>
</span><span id="line-689"></span><span>          </span><span class="hs-comment">-- Otherwise: ensure that the kind 'ki' of 'ty' is concrete.</span><span>
</span><span id="line-690"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">otherwise</span></span><span>
</span><span id="line-691"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683015604"><span class="annot"><a href="#local-6989586621683015604"><span class="hs-identifier hs-var">kco</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621683015592"><span class="hs-identifier hs-type">check_kind</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683015605"><span class="hs-identifier hs-type">frr_orig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683015599"><span class="hs-identifier hs-type">ki</span></a></span><span>
</span><span id="line-692"></span><span>                </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#mkGReflRightMCo"><span class="hs-identifier hs-type">mkGReflRightMCo</span></a></span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-type">Nominal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683015594"><span class="hs-identifier hs-type">ty</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683015604"><span class="hs-identifier hs-type">kco</span></a></span><span>
</span><span id="line-693"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#mkCastTyMCo"><span class="hs-identifier hs-type">mkCastTyMCo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683015594"><span class="hs-identifier hs-type">ty</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683015604"><span class="hs-identifier hs-type">kco</span></a></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-694"></span><span>
</span><span id="line-695"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-696"></span><span>    </span><span class="annot"><a href="#local-6989586621683015601"><span class="hs-identifier hs-type">refl</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#TcCoercionN"><span class="hs-identifier hs-type">TcCoercionN</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-697"></span><span>    </span><span id="local-6989586621683015601"><span class="annot"><span class="annottext">refl :: (TcCoercionN, TcType)
</span><a href="#local-6989586621683015601"><span class="hs-identifier hs-var hs-var">refl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; TcCoercionN
</span><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015594"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015594"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-698"></span><span>    </span><span class="annot"><a href="#local-6989586621683015599"><span class="hs-identifier hs-type">ki</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcKind"><span class="hs-identifier hs-type">TcKind</span></a></span><span>
</span><span id="line-699"></span><span>    </span><span id="local-6989586621683015599"><span class="annot"><span class="annottext">ki :: TcType
</span><a href="#local-6989586621683015599"><span class="hs-identifier hs-var hs-var">ki</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; TcType -&gt; TcType
TcType -&gt; TcType
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015594"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-700"></span><span>    </span><span class="annot"><a href="#local-6989586621683015605"><span class="hs-identifier hs-type">frr_orig</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#FixedRuntimeRepOrigin"><span class="hs-identifier hs-type">FixedRuntimeRepOrigin</span></a></span><span>
</span><span id="line-701"></span><span>    </span><span id="local-6989586621683015605"><span class="annot"><span class="annottext">frr_orig :: FixedRuntimeRepOrigin
</span><a href="#local-6989586621683015605"><span class="hs-identifier hs-var hs-var">frr_orig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#FixedRuntimeRepOrigin"><span class="hs-identifier hs-type">FixedRuntimeRepOrigin</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">frr_type :: TcType
</span><a href="GHC.Tc.Types.Origin.html#frr_type"><span class="hs-identifier hs-var">frr_type</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015594"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">frr_context :: FixedRuntimeRepContext
</span><a href="GHC.Tc.Types.Origin.html#frr_context"><span class="hs-identifier hs-var">frr_context</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FixedRuntimeRepContext
</span><a href="#local-6989586621683015593"><span class="hs-identifier hs-var">frr_ctxt</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-702"></span><span>
</span><span id="line-703"></span><span class="hs-comment">-- | Ensure that the given type @ty@ can unify with a concrete type,</span><span>
</span><span id="line-704"></span><span class="hs-comment">-- in the sense of Note [Concrete types].</span><span>
</span><span id="line-705"></span><span class="hs-comment">--</span><span>
</span><span id="line-706"></span><span class="hs-comment">-- Returns a coercion @co :: ty ~# conc_ty@, where @conc_ty@ is</span><span>
</span><span id="line-707"></span><span class="hs-comment">-- concrete.</span><span>
</span><span id="line-708"></span><span class="hs-comment">--</span><span>
</span><span id="line-709"></span><span class="hs-comment">-- If the type is already syntactically concrete, this</span><span>
</span><span id="line-710"></span><span class="hs-comment">-- immediately returns a reflexive coercion. Otherwise,</span><span>
</span><span id="line-711"></span><span class="hs-comment">-- it creates a new concrete metavariable @concrete_tv@</span><span>
</span><span id="line-712"></span><span class="hs-comment">-- and emits an equality constraint @ty ~# concrete_tv@,</span><span>
</span><span id="line-713"></span><span class="hs-comment">-- to be handled by the constraint solver.</span><span>
</span><span id="line-714"></span><span class="hs-comment">--</span><span>
</span><span id="line-715"></span><span class="hs-comment">-- Invariant: the kind of the supplied type must be concrete.</span><span>
</span><span id="line-716"></span><span class="hs-comment">--</span><span>
</span><span id="line-717"></span><span class="hs-comment">-- We assume the provided type is already at the kind-level</span><span>
</span><span id="line-718"></span><span class="hs-comment">-- (this only matters for error messages).</span><span>
</span><span id="line-719"></span><span class="annot"><a href="GHC.Tc.Utils.Concrete.html#unifyConcrete"><span class="hs-identifier hs-type">unifyConcrete</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span>
</span><span id="line-720"></span><span>              </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#ConcreteTvOrigin"><span class="hs-identifier hs-type">ConcreteTvOrigin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#TcMCoercionN"><span class="hs-identifier hs-type">TcMCoercionN</span></a></span><span>
</span><span id="line-721"></span><span id="unifyConcrete"><span class="annot"><span class="annottext">unifyConcrete :: HasDebugCallStack =&gt;
FastString -&gt; ConcreteTvOrigin -&gt; TcType -&gt; TcM TcMCoercionN
</span><a href="GHC.Tc.Utils.Concrete.html#unifyConcrete"><span class="hs-identifier hs-var hs-var">unifyConcrete</span></a></span></span><span> </span><span id="local-6989586621683015617"><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683015617"><span class="hs-identifier hs-var">occ_fs</span></a></span></span><span> </span><span id="local-6989586621683015618"><span class="annot"><span class="annottext">ConcreteTvOrigin
</span><a href="#local-6989586621683015618"><span class="hs-identifier hs-var">conc_orig</span></a></span></span><span> </span><span id="local-6989586621683015619"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015619"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-722"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683015620"><span class="annot"><a href="#local-6989586621683015620"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683015621"><span class="annot"><a href="#local-6989586621683015621"><span class="hs-identifier hs-var">errs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ConcreteTvOrigin -&gt; TcType -&gt; TcM (TcType, [NotConcreteReason])
</span><a href="GHC.Tc.Utils.Concrete.html#makeTypeConcrete"><span class="hs-identifier hs-var">makeTypeConcrete</span></a></span><span> </span><span class="annot"><span class="annottext">ConcreteTvOrigin
</span><a href="#local-6989586621683015618"><span class="hs-identifier hs-var">conc_orig</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015619"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-723"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683015621"><span class="hs-identifier hs-type">errs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-724"></span><span>           </span><span class="hs-comment">-- We were able to make the type fully concrete.</span><span>
</span><span id="line-725"></span><span>         </span><span class="hs-special">{</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcMCoercionN -&gt; TcM TcMCoercionN
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">TcMCoercionN
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span>
</span><span id="line-726"></span><span>           </span><span class="hs-comment">-- The type could not be made concrete; perhaps it contains</span><span>
</span><span id="line-727"></span><span>           </span><span class="hs-comment">-- a skolem type variable, a type family application, ...</span><span>
</span><span id="line-728"></span><span>           </span><span class="hs-comment">--</span><span>
</span><span id="line-729"></span><span>           </span><span class="hs-comment">-- Create a new ConcreteTv metavariable @concrete_tv@</span><span>
</span><span id="line-730"></span><span>           </span><span class="hs-comment">-- and unify @ty ~# concrete_tv@.</span><span>
</span><span id="line-731"></span><span>         </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">[NotConcreteReason]
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-732"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683015623"><span class="annot"><a href="#local-6989586621683015623"><span class="hs-identifier hs-var">conc_tv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
ConcreteTvOrigin -&gt; FastString -&gt; TcType -&gt; TcM Var
ConcreteTvOrigin -&gt; FastString -&gt; TcType -&gt; TcM Var
</span><a href="GHC.Tc.Utils.TcMType.html#newConcreteTyVar"><span class="hs-identifier hs-var">newConcreteTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConcreteTvOrigin
</span><a href="#local-6989586621683015618"><span class="hs-identifier hs-var">conc_orig</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683015617"><span class="hs-identifier hs-var">occ_fs</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015625"><span class="hs-identifier hs-var">ki</span></a></span><span>
</span><span id="line-733"></span><span>           </span><span class="hs-comment">-- NB: newConcreteTyVar asserts that 'ki' is concrete.</span><span>
</span><span id="line-734"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#coToMCo"><span class="hs-identifier hs-type">coToMCo</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#emitWantedEq"><span class="hs-identifier hs-type">emitWantedEq</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683015628"><span class="hs-identifier hs-type">orig</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#KindLevel"><span class="hs-identifier hs-type">KindLevel</span></a></span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-type">Nominal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683015620"><span class="hs-identifier hs-type">ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-type">mkTyVarTy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683015623"><span class="hs-identifier hs-type">conc_tv</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-735"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-736"></span><span>    </span><span class="annot"><a href="#local-6989586621683015625"><span class="hs-identifier hs-type">ki</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcKind"><span class="hs-identifier hs-type">TcKind</span></a></span><span>
</span><span id="line-737"></span><span>    </span><span id="local-6989586621683015625"><span class="annot"><span class="annottext">ki :: TcType
</span><a href="#local-6989586621683015625"><span class="hs-identifier hs-var hs-var">ki</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; TcType -&gt; TcType
TcType -&gt; TcType
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015619"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-738"></span><span>    </span><span class="annot"><a href="#local-6989586621683015628"><span class="hs-identifier hs-type">orig</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a></span><span>
</span><span id="line-739"></span><span>    </span><span id="local-6989586621683015628"><span class="annot"><span class="annottext">orig :: CtOrigin
</span><a href="#local-6989586621683015628"><span class="hs-identifier hs-var hs-var">orig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ConcreteTvOrigin
</span><a href="#local-6989586621683015618"><span class="hs-identifier hs-var">conc_orig</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-740"></span><span>      </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#ConcreteFRR"><span class="hs-identifier hs-type">ConcreteFRR</span></a></span><span> </span><span id="local-6989586621683015630"><span class="annot"><span class="annottext">FixedRuntimeRepOrigin
</span><a href="#local-6989586621683015630"><span class="hs-identifier hs-var">frr_orig</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FixedRuntimeRepOrigin -&gt; CtOrigin
</span><a href="GHC.Tc.Types.Origin.html#FRROrigin"><span class="hs-identifier hs-var">FRROrigin</span></a></span><span> </span><span class="annot"><span class="annottext">FixedRuntimeRepOrigin
</span><a href="#local-6989586621683015630"><span class="hs-identifier hs-var">frr_orig</span></a></span><span>
</span><span id="line-741"></span><span>
</span><span id="line-742"></span><span class="hs-comment">-- | Ensure that the given type is concrete.</span><span>
</span><span id="line-743"></span><span class="hs-comment">--</span><span>
</span><span id="line-744"></span><span class="hs-comment">-- This is an eager syntactic check, and never defers</span><span>
</span><span id="line-745"></span><span class="hs-comment">-- any work to the constraint solver.</span><span>
</span><span id="line-746"></span><span class="hs-comment">--</span><span>
</span><span id="line-747"></span><span class="hs-comment">-- Invariant: the kind of the supplied type must be concrete.</span><span>
</span><span id="line-748"></span><span class="hs-comment">-- Invariant: the output type is equal to the input type,</span><span>
</span><span id="line-749"></span><span class="hs-comment">--            up to zonking.</span><span>
</span><span id="line-750"></span><span class="hs-comment">--</span><span>
</span><span id="line-751"></span><span class="hs-comment">-- We assume the provided type is already at the kind-level</span><span>
</span><span id="line-752"></span><span class="hs-comment">-- (this only matters for error messages).</span><span>
</span><span id="line-753"></span><span class="annot"><a href="GHC.Tc.Utils.Concrete.html#ensureConcrete"><span class="hs-identifier hs-type">ensureConcrete</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span>
</span><span id="line-754"></span><span>               </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#FixedRuntimeRepOrigin"><span class="hs-identifier hs-type">FixedRuntimeRepOrigin</span></a></span><span>
</span><span id="line-755"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>
</span><span id="line-756"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>
</span><span id="line-757"></span><span id="ensureConcrete"><span class="annot"><span class="annottext">ensureConcrete :: HasDebugCallStack =&gt; FixedRuntimeRepOrigin -&gt; TcType -&gt; TcM TcType
</span><a href="GHC.Tc.Utils.Concrete.html#ensureConcrete"><span class="hs-identifier hs-var hs-var">ensureConcrete</span></a></span></span><span> </span><span id="local-6989586621683015657"><span class="annot"><span class="annottext">FixedRuntimeRepOrigin
</span><a href="#local-6989586621683015657"><span class="hs-identifier hs-var">frr_orig</span></a></span></span><span> </span><span id="local-6989586621683015658"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015658"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-758"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ensureConcrete {&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FixedRuntimeRepOrigin -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">FixedRuntimeRepOrigin
</span><a href="#local-6989586621683015657"><span class="hs-identifier hs-var">frr_orig</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015658"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-759"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683015662"><span class="annot"><a href="#local-6989586621683015662"><span class="hs-identifier hs-var">ty'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683015663"><span class="annot"><a href="#local-6989586621683015663"><span class="hs-identifier hs-var">errs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ConcreteTvOrigin -&gt; TcType -&gt; TcM (TcType, [NotConcreteReason])
</span><a href="GHC.Tc.Utils.Concrete.html#makeTypeConcrete"><span class="hs-identifier hs-var">makeTypeConcrete</span></a></span><span> </span><span class="annot"><span class="annottext">ConcreteTvOrigin
</span><a href="#local-6989586621683015664"><span class="hs-identifier hs-var">conc_orig</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015658"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-760"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683015663"><span class="hs-identifier hs-type">errs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-761"></span><span>          </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683015665"><span class="annot"><span class="annottext">NotConcreteReason
</span><a href="#local-6989586621683015665"><span class="hs-identifier hs-var">err</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621683015666"><span class="annot"><span class="annottext">[NotConcreteReason]
</span><a href="#local-6989586621683015666"><span class="hs-identifier hs-var">errs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-762"></span><span>              </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ensureConcrete } failure&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcM ()) -&gt; SDoc -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-763"></span><span>                     </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ty:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015658"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-764"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ty':&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015662"><span class="hs-identifier hs-var">ty'</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-765"></span><span>                 </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683015670"><span class="annot"><a href="#local-6989586621683015670"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtOrigin -&gt; Maybe TypeOrKind -&gt; TcM CtLoc
</span><a href="GHC.Tc.Utils.Monad.html#getCtLocM"><span class="hs-identifier hs-var">getCtLocM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FixedRuntimeRepOrigin -&gt; CtOrigin
</span><a href="GHC.Tc.Types.Origin.html#FRROrigin"><span class="hs-identifier hs-var">FRROrigin</span></a></span><span> </span><span class="annot"><span class="annottext">FixedRuntimeRepOrigin
</span><a href="#local-6989586621683015657"><span class="hs-identifier hs-var">frr_orig</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeOrKind -&gt; Maybe TypeOrKind
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">TypeOrKind
</span><a href="GHC.Types.Basic.html#KindLevel"><span class="hs-identifier hs-var">KindLevel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-766"></span><span>                 </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#emitNotConcreteError"><span class="hs-identifier hs-type">emitNotConcreteError</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-767"></span><span>                     </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#NCE_FRR"><span class="hs-identifier hs-type">NCE_FRR</span></a></span><span>
</span><span id="line-768"></span><span>                       </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#nce_loc"><span class="hs-identifier hs-var">nce_loc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683015670"><span class="hs-identifier hs-type">loc</span></a></span><span>
</span><span id="line-769"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#nce_frr_origin"><span class="hs-identifier hs-var">nce_frr_origin</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683015657"><span class="hs-identifier hs-type">frr_orig</span></a></span><span>
</span><span id="line-770"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#nce_reasons"><span class="hs-identifier hs-var">nce_reasons</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683015665"><span class="hs-identifier hs-type">err</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">:|</span></span><span> </span><span class="annot"><a href="#local-6989586621683015666"><span class="hs-identifier hs-type">errs</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-771"></span><span>                 </span><span class="hs-special">}</span><span>
</span><span id="line-772"></span><span>          </span><span class="hs-special">;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-773"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ensureConcrete } success&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcM ()) -&gt; SDoc -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-774"></span><span>                </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ty: &quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015658"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-775"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ty':&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015662"><span class="hs-identifier hs-var">ty'</span></a></span><span> </span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-776"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683015662"><span class="hs-identifier hs-type">ty'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-777"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-778"></span><span>    </span><span class="annot"><a href="#local-6989586621683015664"><span class="hs-identifier hs-type">conc_orig</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#ConcreteTvOrigin"><span class="hs-identifier hs-type">ConcreteTvOrigin</span></a></span><span>
</span><span id="line-779"></span><span>    </span><span id="local-6989586621683015664"><span class="annot"><span class="annottext">conc_orig :: ConcreteTvOrigin
</span><a href="#local-6989586621683015664"><span class="hs-identifier hs-var hs-var">conc_orig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FixedRuntimeRepOrigin -&gt; ConcreteTvOrigin
</span><a href="GHC.Tc.Utils.TcType.html#ConcreteFRR"><span class="hs-identifier hs-var">ConcreteFRR</span></a></span><span> </span><span class="annot"><span class="annottext">FixedRuntimeRepOrigin
</span><a href="#local-6989586621683015657"><span class="hs-identifier hs-var">frr_orig</span></a></span><span>
</span><span id="line-780"></span><span>
</span><span id="line-781"></span><span class="annot"><span class="hs-comment">{-***********************************************************************
%*                                                                      *
                    Making a type concrete
%*                                                                      *
%************************************************************************

Note [Unifying concrete metavariables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Unifying concrete metavariables (as defined in Note [ConcreteTv]) is not
an all-or-nothing affair as it is for other sorts of metavariables.

Consider the following unification problem in which all metavariables
are unfilled (and ignoring any TcLevel considerations):

  alpha[conc] ~# TYPE (TupleRep '[ beta[conc], IntRep, gamma[tau] ])

We can't immediately unify `alpha` with the RHS, because the RHS is not
a concrete type (in the sense of Note [Concrete types]). Instead, we
proceed as follows:

  - create a fresh concrete metavariable variable `gamma'[conc]`,
  - write gamma[tau] := gamma'[conc],
  - write alpha[conc] := TYPE (TupleRep '[ beta[conc], IntRep, gamma'[conc] ]).

Thus, in general, to unify `alpha[conc] ~# rhs`, we first try to turn
`rhs` into a concrete type (see the 'makeTypeConcrete' function).
If this succeeds, resulting in a concrete type `rhs'`, we simply fill
`alpha[conc] := rhs'`. If it fails, then syntactic unification fails.

Example 1:

    alpha[conc] ~# TYPE (TupleRep '[ beta[conc], IntRep, gamma[tau] ])

  We proceed by filling metavariables:

    gamma[tau] := gamma[conc]
    alpha[conc] := TYPE (TupleRep '[ beta[conc], IntRep, gamma[conc] ])

  This successfully unifies alpha.

Example 2:

  For a type family `F :: Type -&gt; Type`:

    delta[conc] ~# TYPE (SumRep '[ zeta[tau], a[sk], F omega[tau] ])

  We write zeta[tau] := zeta[conc], and then fail, providing the following
  two reasons:

    - `a[sk]` is not a concrete type variable, so the overall type
      cannot be concrete
    - `F` is not a concrete type constructor, in the sense of
       Note [Concrete types]. So we keep it as is; in particular,
       we /should not/ try to make its argument `omega[tau]` into
       a ConcreteTv.

  Note that making zeta concrete allows us to propagate information.
  For example, after more typechecking, we might try to unify
  `zeta ~# rr[sk]`. If we made zeta a ConcreteTv, we will report
  this unsolved equality using the 'ConcreteTvOrigin' stored in zeta[conc].
  This allows us to report ALL the problems in a representation-polymorphism
  check (instead of only a non-empty subset).
-}</span></span><span>
</span><span id="line-844"></span><span>
</span><span id="line-845"></span><span class="hs-comment">-- | Try to turn the provided type into a concrete type, by ensuring</span><span>
</span><span id="line-846"></span><span class="hs-comment">-- unfilled metavariables are appropriately marked as concrete.</span><span>
</span><span id="line-847"></span><span class="hs-comment">--</span><span>
</span><span id="line-848"></span><span class="hs-comment">-- Returns a zonked type which is &quot;as concrete as possible&quot;, and</span><span>
</span><span id="line-849"></span><span class="hs-comment">-- a list of problems encountered when trying to make it concrete.</span><span>
</span><span id="line-850"></span><span class="hs-comment">--</span><span>
</span><span id="line-851"></span><span class="hs-comment">-- INVARIANT: the returned type is equal to the input type, up to zonking.</span><span>
</span><span id="line-852"></span><span class="hs-comment">-- INVARIANT: if this function returns an empty list of 'NotConcreteReasons',</span><span>
</span><span id="line-853"></span><span class="hs-comment">-- then the returned type is concrete, in the sense of Note [Concrete types].</span><span>
</span><span id="line-854"></span><span class="annot"><a href="GHC.Tc.Utils.Concrete.html#makeTypeConcrete"><span class="hs-identifier hs-type">makeTypeConcrete</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#ConcreteTvOrigin"><span class="hs-identifier hs-type">ConcreteTvOrigin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#NotConcreteReason"><span class="hs-identifier hs-type">NotConcreteReason</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-855"></span><span class="hs-comment">-- TODO: it could be worthwhile to return enough information to continue solving.</span><span>
</span><span id="line-856"></span><span class="hs-comment">-- Consider unifying `alpha[conc] ~# TupleRep '[ beta[tau], F Int ]` for</span><span>
</span><span id="line-857"></span><span class="hs-comment">-- a type family 'F'.</span><span>
</span><span id="line-858"></span><span class="hs-comment">-- This function will concretise `beta[tau] := beta[conc]` and return</span><span>
</span><span id="line-859"></span><span class="hs-comment">-- that `TupleRep '[ beta[conc], F Int ]` is not concrete because of the</span><span>
</span><span id="line-860"></span><span class="hs-comment">-- type family application `F Int`. But we could decompose by setting</span><span>
</span><span id="line-861"></span><span class="hs-comment">-- alpha := TupleRep '[ beta, gamma[conc] ] and emitting `[W] gamma[conc] ~ F Int`.</span><span>
</span><span id="line-862"></span><span id="makeTypeConcrete"><span class="annot"><span class="annottext">makeTypeConcrete :: ConcreteTvOrigin -&gt; TcType -&gt; TcM (TcType, [NotConcreteReason])
</span><a href="GHC.Tc.Utils.Concrete.html#makeTypeConcrete"><span class="hs-identifier hs-var hs-var">makeTypeConcrete</span></a></span></span><span> </span><span id="local-6989586621683015677"><span class="annot"><span class="annottext">ConcreteTvOrigin
</span><a href="#local-6989586621683015677"><span class="hs-identifier hs-var">conc_orig</span></a></span></span><span> </span><span id="local-6989586621683015678"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015678"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-863"></span><span>  </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683015679"><span class="annot"><a href="#local-6989586621683015679"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621683015680"><span class="annot"><a href="#local-6989586621683015680"><span class="hs-identifier hs-var">ty'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WriterT [NotConcreteReason] TcM TcType
-&gt; TcM (TcType, [NotConcreteReason])
forall w (m :: * -&gt; *) a. Monoid w =&gt; WriterT w m a -&gt; m (a, w)
</span><a href="../../transformers-0.6.1.2-38b1/src/Control.Monad.Trans.Writer.CPS.html#runWriterT"><span class="hs-identifier hs-var">runWriterT</span></a></span><span> </span><span class="annot"><span class="annottext">(WriterT [NotConcreteReason] TcM TcType
 -&gt; TcM (TcType, [NotConcreteReason]))
-&gt; WriterT [NotConcreteReason] TcM TcType
-&gt; TcM (TcType, [NotConcreteReason])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; WriterT [NotConcreteReason] TcM TcType
</span><a href="#local-6989586621683015681"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015678"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-864"></span><span>     </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;makeTypeConcrete&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-865"></span><span>        </span><span class="annot"><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-type">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;ty:&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683015678"><span class="hs-identifier hs-type">ty</span></a></span><span>
</span><span id="line-866"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;ty':&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683015680"><span class="hs-identifier hs-type">ty'</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-867"></span><span>     </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683015679"><span class="hs-identifier hs-type">res</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-868"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-869"></span><span>    </span><span class="annot"><a href="#local-6989586621683015681"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../transformers-0.6.1.2-38b1/src/Control.Monad.Trans.Writer.CPS.html#WriterT"><span class="hs-identifier hs-type">WriterT</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#NotConcreteReason"><span class="hs-identifier hs-type">NotConcreteReason</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>
</span><span id="line-870"></span><span>    </span><span id="local-6989586621683015681"><span class="annot"><span class="annottext">go :: TcType -&gt; WriterT [NotConcreteReason] TcM TcType
</span><a href="#local-6989586621683015681"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621683015682"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015682"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-871"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683015683"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015683"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe TcType
</span><a href="GHC.Core.Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015682"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-872"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; WriterT [NotConcreteReason] TcM TcType
</span><a href="#local-6989586621683015681"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015683"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-873"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="GHC.Core.Type.html#isConcreteType"><span class="hs-identifier hs-var">isConcreteType</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015682"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-874"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; WriterT [NotConcreteReason] TcM TcType
forall a. a -&gt; WriterT [NotConcreteReason] TcM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015682"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-875"></span><span>    </span><span class="annot"><a href="#local-6989586621683015681"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683015685"><span class="annot"><span class="annottext">ty :: TcType
</span><a href="#local-6989586621683015685"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyVarTy"><span class="hs-identifier hs-type">TyVarTy</span></a></span><span> </span><span id="local-6989586621683015687"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683015687"><span class="hs-identifier hs-var">tv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- not a ConcreteTv (already handled above)</span><span>
</span><span id="line-876"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683015688"><span class="annot"><a href="#local-6989586621683015688"><span class="hs-identifier hs-var">mb_filled</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IOEnv (Env TcGblEnv TcLclEnv) (Maybe TcType)
-&gt; WriterT [NotConcreteReason] TcM (Maybe TcType)
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; WriterT [NotConcreteReason] m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="../../transformers-0.6.1.2-38b1/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(IOEnv (Env TcGblEnv TcLclEnv) (Maybe TcType)
 -&gt; WriterT [NotConcreteReason] TcM (Maybe TcType))
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (Maybe TcType)
-&gt; WriterT [NotConcreteReason] TcM (Maybe TcType)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Var -&gt; IOEnv (Env TcGblEnv TcLclEnv) (Maybe TcType)
</span><a href="GHC.Tc.Utils.TcMType.html#isFilledMetaTyVar_maybe"><span class="hs-identifier hs-var">isFilledMetaTyVar_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683015687"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-877"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683015688"><span class="hs-identifier hs-type">mb_filled</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-878"></span><span>           </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683015690"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015690"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; WriterT [NotConcreteReason] TcM TcType
</span><a href="#local-6989586621683015681"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015690"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-879"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Maybe TcType
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-880"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isMetaTyVar"><span class="hs-identifier hs-var">isMetaTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683015687"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-881"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MetaInfo
</span><a href="GHC.Tc.Utils.TcType.html#TauTv"><span class="hs-identifier hs-var">TauTv</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Var -&gt; MetaInfo
</span><a href="GHC.Tc.Utils.TcType.html#metaTyVarInfo"><span class="hs-identifier hs-var">metaTyVarInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683015687"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-882"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- Change the MetaInfo to ConcreteTv, but retain the TcLevel</span><span>
</span><span id="line-883"></span><span>               </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683015694"><span class="annot"><a href="#local-6989586621683015694"><span class="hs-identifier hs-var">kind</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; WriterT [NotConcreteReason] TcM TcType
</span><a href="#local-6989586621683015681"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; TcType
</span><a href="GHC.Types.Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683015687"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-884"></span><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683015695"><span class="annot"><a href="#local-6989586621683015695"><span class="hs-identifier hs-var hs-var">occ_fs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccName -&gt; FastString
</span><a href="GHC.Types.Name.Occurrence.html#occNameFS"><span class="hs-identifier hs-var">occNameFS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; OccName
forall a. NamedThing a =&gt; a -&gt; OccName
</span><a href="GHC.Types.Name.html#getOccName"><span class="hs-identifier hs-var">getOccName</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683015687"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-885"></span><span>                        </span><span class="hs-comment">-- occ_fs: preserve the occurrence name of the original tyvar</span><span>
</span><span id="line-886"></span><span>                        </span><span class="hs-comment">-- This helps in error messages</span><span>
</span><span id="line-887"></span><span>                  </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="../../transformers-0.6.1.2-38b1/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-type">lift</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-888"></span><span>                    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683015698"><span class="annot"><a href="#local-6989586621683015698"><span class="hs-identifier hs-var">conc_tv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#setTcLevel"><span class="hs-identifier hs-type">setTcLevel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#tcTyVarLevel"><span class="hs-identifier hs-type">tcTyVarLevel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683015687"><span class="hs-identifier hs-type">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-889"></span><span>                                    </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#newConcreteTyVar"><span class="hs-identifier hs-type">newConcreteTyVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683015677"><span class="hs-identifier hs-type">conc_orig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683015695"><span class="hs-identifier hs-type">occ_fs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683015694"><span class="hs-identifier hs-type">kind</span></a></span><span>
</span><span id="line-890"></span><span>                       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683015701"><span class="annot"><a href="#local-6989586621683015701"><span class="hs-identifier hs-var hs-var">conc_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683015698"><span class="hs-identifier hs-var">conc_tv</span></a></span><span>
</span><span id="line-891"></span><span>                       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#liftZonkM"><span class="hs-identifier hs-type">liftZonkM</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Tc.Zonk.TcType.html#writeMetaTyVar"><span class="hs-identifier hs-type">writeMetaTyVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683015687"><span class="hs-identifier hs-type">tv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683015701"><span class="hs-identifier hs-type">conc_ty</span></a></span><span>
</span><span id="line-892"></span><span>                       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683015701"><span class="hs-identifier hs-type">conc_ty</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-893"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-894"></span><span>               </span><span class="hs-comment">-- Don't attempt to make other type variables concrete</span><span>
</span><span id="line-895"></span><span>               </span><span class="hs-comment">-- (e.g. SkolemTv, TyVarTv, CycleBreakerTv, RuntimeUnkTv).</span><span>
</span><span id="line-896"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcType
-&gt; NotConcreteReason -&gt; WriterT [NotConcreteReason] TcM TcType
</span><a href="#local-6989586621683015704"><span class="hs-identifier hs-var">bale_out</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015685"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; NotConcreteReason
</span><a href="GHC.Tc.Types.Constraint.html#NonConcretisableTyVar"><span class="hs-identifier hs-var">NonConcretisableTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683015687"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-897"></span><span>    </span><span class="annot"><a href="#local-6989586621683015681"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683015706"><span class="annot"><span class="annottext">ty :: TcType
</span><a href="#local-6989586621683015706"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyConApp"><span class="hs-identifier hs-type">TyConApp</span></a></span><span> </span><span id="local-6989586621683015707"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683015707"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621683015708"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683015708"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-898"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isConcreteTyCon"><span class="hs-identifier hs-var">isConcreteTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683015707"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-899"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [TcType] -&gt; TcType
</span><a href="GHC.Core.Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683015707"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">([TcType] -&gt; TcType)
-&gt; WriterT [NotConcreteReason] TcM [TcType]
-&gt; WriterT [NotConcreteReason] TcM TcType
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(TcType -&gt; WriterT [NotConcreteReason] TcM TcType)
-&gt; [TcType] -&gt; WriterT [NotConcreteReason] TcM [TcType]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; WriterT [NotConcreteReason] TcM TcType
</span><a href="#local-6989586621683015681"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683015708"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-900"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-901"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType
-&gt; NotConcreteReason -&gt; WriterT [NotConcreteReason] TcM TcType
</span><a href="#local-6989586621683015704"><span class="hs-identifier hs-var">bale_out</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015706"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [TcType] -&gt; NotConcreteReason
</span><a href="GHC.Tc.Types.Constraint.html#NonConcreteTyCon"><span class="hs-identifier hs-var">NonConcreteTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683015707"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683015708"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-902"></span><span>    </span><span class="annot"><a href="#local-6989586621683015681"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#FunTy"><span class="hs-identifier hs-type">FunTy</span></a></span><span> </span><span id="local-6989586621683015713"><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683015713"><span class="hs-identifier hs-var">af</span></a></span></span><span> </span><span id="local-6989586621683015714"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015714"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621683015715"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015715"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683015716"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015716"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-903"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683015717"><span class="annot"><a href="#local-6989586621683015717"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; WriterT [NotConcreteReason] TcM TcType
</span><a href="#local-6989586621683015681"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015714"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-904"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683015718"><span class="annot"><a href="#local-6989586621683015718"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621683015681"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683015715"><span class="hs-identifier hs-type">ty1</span></a></span><span>
</span><span id="line-905"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683015719"><span class="annot"><a href="#local-6989586621683015719"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621683015681"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683015716"><span class="hs-identifier hs-type">ty2</span></a></span><span>
</span><span id="line-906"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#mkFunTy"><span class="hs-identifier hs-type">mkFunTy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683015713"><span class="hs-identifier hs-type">af</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683015717"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683015718"><span class="hs-identifier hs-type">ty1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683015719"><span class="hs-identifier hs-type">ty2</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-907"></span><span>    </span><span class="annot"><a href="#local-6989586621683015681"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#AppTy"><span class="hs-identifier hs-type">AppTy</span></a></span><span> </span><span id="local-6989586621683015721"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015721"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683015722"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015722"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-908"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683015723"><span class="annot"><a href="#local-6989586621683015723"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; WriterT [NotConcreteReason] TcM TcType
</span><a href="#local-6989586621683015681"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015721"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-909"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683015724"><span class="annot"><a href="#local-6989586621683015724"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621683015681"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683015722"><span class="hs-identifier hs-type">ty2</span></a></span><span>
</span><span id="line-910"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Core.Type.html#mkAppTy"><span class="hs-identifier hs-type">mkAppTy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683015723"><span class="hs-identifier hs-type">ty1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683015724"><span class="hs-identifier hs-type">ty2</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-911"></span><span>    </span><span class="annot"><a href="#local-6989586621683015681"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683015726"><span class="annot"><span class="annottext">ty :: TcType
</span><a href="#local-6989586621683015726"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#LitTy"><span class="hs-identifier hs-type">LitTy</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-912"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; WriterT [NotConcreteReason] TcM TcType
forall a. a -&gt; WriterT [NotConcreteReason] TcM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015726"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-913"></span><span>    </span><span class="annot"><a href="#local-6989586621683015681"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683015728"><span class="annot"><span class="annottext">ty :: TcType
</span><a href="#local-6989586621683015728"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CastTy"><span class="hs-identifier hs-type">CastTy</span></a></span><span> </span><span id="local-6989586621683015730"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015730"><span class="hs-identifier hs-var">cast_ty</span></a></span></span><span> </span><span id="local-6989586621683015731"><span class="annot"><span class="annottext">TcCoercionN
</span><a href="#local-6989586621683015731"><span class="hs-identifier hs-var">kco</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-914"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType
-&gt; NotConcreteReason -&gt; WriterT [NotConcreteReason] TcM TcType
</span><a href="#local-6989586621683015704"><span class="hs-identifier hs-var">bale_out</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015728"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; TcCoercionN -&gt; NotConcreteReason
</span><a href="GHC.Tc.Types.Constraint.html#ContainsCast"><span class="hs-identifier hs-var">ContainsCast</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015730"><span class="hs-identifier hs-var">cast_ty</span></a></span><span> </span><span class="annot"><span class="annottext">TcCoercionN
</span><a href="#local-6989586621683015731"><span class="hs-identifier hs-var">kco</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-915"></span><span>    </span><span class="annot"><a href="#local-6989586621683015681"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683015733"><span class="annot"><span class="annottext">ty :: TcType
</span><a href="#local-6989586621683015733"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ForAllTy"><span class="hs-identifier hs-type">ForAllTy</span></a></span><span> </span><span id="local-6989586621683015735"><span class="annot"><span class="annottext">ForAllTyBinder
</span><a href="#local-6989586621683015735"><span class="hs-identifier hs-var">tcv</span></a></span></span><span> </span><span id="local-6989586621683015736"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015736"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-916"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType
-&gt; NotConcreteReason -&gt; WriterT [NotConcreteReason] TcM TcType
</span><a href="#local-6989586621683015704"><span class="hs-identifier hs-var">bale_out</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015733"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ForAllTyBinder -&gt; TcType -&gt; NotConcreteReason
</span><a href="GHC.Tc.Types.Constraint.html#ContainsForall"><span class="hs-identifier hs-var">ContainsForall</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyBinder
</span><a href="#local-6989586621683015735"><span class="hs-identifier hs-var">tcv</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015736"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-917"></span><span>    </span><span class="annot"><a href="#local-6989586621683015681"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683015738"><span class="annot"><span class="annottext">ty :: TcType
</span><a href="#local-6989586621683015738"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionTy"><span class="hs-identifier hs-type">CoercionTy</span></a></span><span> </span><span id="local-6989586621683015740"><span class="annot"><span class="annottext">TcCoercionN
</span><a href="#local-6989586621683015740"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-918"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType
-&gt; NotConcreteReason -&gt; WriterT [NotConcreteReason] TcM TcType
</span><a href="#local-6989586621683015704"><span class="hs-identifier hs-var">bale_out</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015738"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcCoercionN -&gt; NotConcreteReason
</span><a href="GHC.Tc.Types.Constraint.html#ContainsCoercionTy"><span class="hs-identifier hs-var">ContainsCoercionTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcCoercionN
</span><a href="#local-6989586621683015740"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-919"></span><span>
</span><span id="line-920"></span><span>    </span><span class="annot"><a href="#local-6989586621683015704"><span class="hs-identifier hs-type">bale_out</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#NotConcreteReason"><span class="hs-identifier hs-type">NotConcreteReason</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../transformers-0.6.1.2-38b1/src/Control.Monad.Trans.Writer.CPS.html#WriterT"><span class="hs-identifier hs-type">WriterT</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#NotConcreteReason"><span class="hs-identifier hs-type">NotConcreteReason</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>
</span><span id="line-921"></span><span>    </span><span id="local-6989586621683015704"><span class="annot"><span class="annottext">bale_out :: TcType
-&gt; NotConcreteReason -&gt; WriterT [NotConcreteReason] TcM TcType
</span><a href="#local-6989586621683015704"><span class="hs-identifier hs-var hs-var">bale_out</span></a></span></span><span> </span><span id="local-6989586621683015742"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015742"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621683015743"><span class="annot"><span class="annottext">NotConcreteReason
</span><a href="#local-6989586621683015743"><span class="hs-identifier hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">[NotConcreteReason] -&gt; WriterT [NotConcreteReason] TcM ()
forall w (m :: * -&gt; *). (Monoid w, Monad m) =&gt; w -&gt; WriterT w m ()
</span><a href="../../transformers-0.6.1.2-38b1/src/Control.Monad.Trans.Writer.CPS.html#tell"><span class="hs-identifier hs-var">tell</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">NotConcreteReason
</span><a href="#local-6989586621683015743"><span class="hs-identifier hs-var">reason</span></a></span><span class="hs-special">]</span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; WriterT [NotConcreteReason] TcM TcType
forall a. a -&gt; WriterT [NotConcreteReason] TcM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683015742"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-922"></span><span>
</span><span id="line-923"></span><span class="annot"><span class="hs-comment">{-***********************************************************************
%*                                                                      *
                   Concrete type variables of Ids
%*                                                                      *
%**********************************************************************-}</span></span><span>
</span><span id="line-928"></span><span>
</span><span id="line-929"></span><span class="hs-comment">-- | Which type variables of this 'Id' must be concrete when instantiated?</span><span>
</span><span id="line-930"></span><span class="hs-comment">--</span><span>
</span><span id="line-931"></span><span class="hs-comment">-- See Note [Representation-polymorphism checking built-ins]</span><span>
</span><span id="line-932"></span><span class="annot"><a href="GHC.Tc.Utils.Concrete.html#idConcreteTvs"><span class="hs-identifier hs-type">idConcreteTvs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.BasicTypes.html#TcId"><span class="hs-identifier hs-type">TcId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#ConcreteTyVars"><span class="hs-identifier hs-type">ConcreteTyVars</span></a></span><span>
</span><span id="line-933"></span><span id="idConcreteTvs"><span class="annot"><span class="annottext">idConcreteTvs :: Var -&gt; ConcreteTyVars
</span><a href="GHC.Tc.Utils.Concrete.html#idConcreteTvs"><span class="hs-identifier hs-var hs-var">idConcreteTvs</span></a></span></span><span> </span><span id="local-6989586621683015746"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683015746"><span class="hs-identifier hs-var">id</span></a></span></span><span>
</span><span id="line-934"></span><span>
</span><span id="line-935"></span><span>  </span><span class="hs-comment">-- HACK for unsafeCoerce#: because of the way it is not quite wired in,</span><span>
</span><span id="line-936"></span><span>  </span><span class="hs-comment">-- as described in Note [Wiring in unsafeCoerce#] in GHC.HsToCore, we don't</span><span>
</span><span id="line-937"></span><span>  </span><span class="hs-comment">-- have access to the correct IdDetails in the typechecker (as we only patch</span><span>
</span><span id="line-938"></span><span>  </span><span class="hs-comment">-- in the correct information in the desugarer).</span><span>
</span><span id="line-939"></span><span>  </span><span class="hs-comment">-- So, for the time being, we manually inspect the type of the original,</span><span>
</span><span id="line-940"></span><span>  </span><span class="hs-comment">-- unpatched Id to retrieve which of its outer forall-d tyvars should be concrete.</span><span>
</span><span id="line-941"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Name
</span><a href="GHC.Types.Id.html#idName"><span class="hs-identifier hs-var">idName</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683015746"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.html#unsafeCoercePrimName"><span class="hs-identifier hs-var">unsafeCoercePrimName</span></a></span><span>
</span><span id="line-942"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683015748"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683015748"><span class="hs-identifier hs-var">a_rep</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621683015749"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683015749"><span class="hs-identifier hs-var">_b_rep</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621683015750"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683015750"><span class="hs-identifier hs-var">a</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621683015751"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683015751"><span class="hs-identifier hs-var">_b</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[Var]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcType
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; ([Var], TcType)
</span><a href="GHC.Tc.Utils.TcType.html#tcSplitForAllTyVars"><span class="hs-identifier hs-var">tcSplitForAllTyVars</span></a></span><span> </span><span class="annot"><span class="annottext">(TcType -&gt; ([Var], TcType)) -&gt; TcType -&gt; ([Var], TcType)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Var -&gt; TcType
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683015746"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-943"></span><span>  </span><span class="hs-comment">-- NB: only check the argument representation, not the result representation.</span><span>
</span><span id="line-944"></span><span>  </span><span class="hs-comment">-- This is because the following is OK:</span><span>
</span><span id="line-945"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-946"></span><span>  </span><span class="hs-comment">--   unsafeCoerceWordRep :: forall {r2} (b :: TYPE r2). Word# -&gt; b</span><span>
</span><span id="line-947"></span><span>  </span><span class="hs-comment">--   unsafeCoerceWordRep = unsafeCoerce#</span><span>
</span><span id="line-948"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Name, ConcreteTvOrigin)] -&gt; ConcreteTyVars
forall a. [(Name, a)] -&gt; NameEnv a
</span><a href="GHC.Types.Name.Env.html#mkNameEnv"><span class="hs-identifier hs-var">mkNameEnv</span></a></span><span>
</span><span id="line-949"></span><span>    </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; Name
</span><a href="GHC.Types.Var.html#tyVarName"><span class="hs-identifier hs-var">tyVarName</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683015748"><span class="hs-identifier hs-var">a_rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FixedRuntimeRepOrigin -&gt; ConcreteTvOrigin
</span><a href="GHC.Tc.Utils.TcType.html#ConcreteFRR"><span class="hs-identifier hs-var">ConcreteFRR</span></a></span><span> </span><span class="annot"><span class="annottext">(FixedRuntimeRepOrigin -&gt; ConcreteTvOrigin)
-&gt; FixedRuntimeRepOrigin -&gt; ConcreteTvOrigin
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; FixedRuntimeRepContext -&gt; FixedRuntimeRepOrigin
</span><a href="GHC.Tc.Types.Origin.html#FixedRuntimeRepOrigin"><span class="hs-identifier hs-var">FixedRuntimeRepOrigin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683015750"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-950"></span><span>                                   </span><span class="annot"><span class="annottext">(FixedRuntimeRepContext -&gt; FixedRuntimeRepOrigin)
-&gt; FixedRuntimeRepContext -&gt; FixedRuntimeRepOrigin
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; RepPolyId -&gt; Position 'Neg -&gt; FixedRuntimeRepContext
</span><a href="GHC.Tc.Types.Origin.html#FRRRepPolyId"><span class="hs-identifier hs-var">FRRRepPolyId</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.html#unsafeCoercePrimName"><span class="hs-identifier hs-var">unsafeCoercePrimName</span></a></span><span> </span><span class="annot"><span class="annottext">RepPolyId
</span><a href="GHC.Tc.Types.Origin.html#RepPolyFunction"><span class="hs-identifier hs-var">RepPolyFunction</span></a></span><span>
</span><span id="line-951"></span><span>                                   </span><span class="annot"><span class="annottext">(Position 'Neg -&gt; FixedRuntimeRepContext)
-&gt; Position 'Neg -&gt; FixedRuntimeRepContext
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Position (FlipPolarity 'Neg) -&gt; Position 'Neg
forall (p :: Polarity).
Int -&gt; Position (FlipPolarity p) -&gt; Position p
</span><a href="GHC.Tc.Types.Origin.html#Argument"><span class="hs-identifier hs-var">Argument</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Position (FlipPolarity 'Neg)
Position 'Pos
</span><a href="GHC.Tc.Types.Origin.html#Top"><span class="hs-identifier hs-var">Top</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-952"></span><span>
</span><span id="line-953"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-954"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdDetails -&gt; ConcreteTyVars
</span><a href="GHC.Types.Id.Info.html#idDetailsConcreteTvs"><span class="hs-identifier hs-var">idDetailsConcreteTvs</span></a></span><span> </span><span class="annot"><span class="annottext">(IdDetails -&gt; ConcreteTyVars) -&gt; IdDetails -&gt; ConcreteTyVars
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Var -&gt; IdDetails
</span><a href="GHC.Types.Var.html#idDetails"><span class="hs-identifier hs-var">idDetails</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683015746"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-955"></span></pre></body></html>