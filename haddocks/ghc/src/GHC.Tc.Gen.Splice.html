<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP                    #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances      #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE FunctionalDependencies #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE GADTs                  #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE InstanceSigs           #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE MultiWayIf             #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables    #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE TupleSections          #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies           #-}</span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# OPTIONS_GHC -fno-warn-orphans #-}</span><span>
</span><span id="line-12"></span><span class="hs-pragma">{-# OPTIONS_GHC -Wno-incomplete-uni-patterns #-}</span><span>
</span><span id="line-13"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns #-}</span><span class="hs-cpp">

#if __GLASGOW_HASKELL__ &lt; 914
</span><span class="hs-comment">-- In GHC 9.14, GHC.Desugar will be removed from base in favour of</span><span>
</span><span id="line-17"></span><span class="hs-comment">-- ghc-internal's GHC.Internal.Desugar. However, because of bootstrapping</span><span>
</span><span id="line-18"></span><span class="hs-comment">-- concerns, we will only depend on ghc-internal when the boot compiler is</span><span>
</span><span id="line-19"></span><span class="hs-comment">-- certain to have it.</span><span>
</span><span id="line-20"></span><span class="hs-pragma">{-# OPTIONS_GHC -Wno-warnings-deprecations #-}</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-23"></span><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998

-}</span><span>
</span><span id="line-28"></span><span>
</span><span id="line-29"></span><span class="annot"><span class="hs-comment">-- | Template Haskell splices</span></span><span>
</span><span id="line-30"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html"><span class="hs-identifier">GHC.Tc.Gen.Splice</span></a></span><span class="hs-special">(</span><span>
</span><span id="line-31"></span><span>     </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#tcTypedSplice"><span class="hs-identifier">tcTypedSplice</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#tcTypedBracket"><span class="hs-identifier">tcTypedBracket</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#tcUntypedBracket"><span class="hs-identifier">tcUntypedBracket</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-32"></span><span>     </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runAnnotation"><span class="hs-identifier">runAnnotation</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#getUntypedSpliceBody"><span class="hs-identifier">getUntypedSpliceBody</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-33"></span><span>
</span><span id="line-34"></span><span>     </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runMetaE"><span class="hs-identifier">runMetaE</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runMetaP"><span class="hs-identifier">runMetaP</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runMetaT"><span class="hs-identifier">runMetaT</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runMetaD"><span class="hs-identifier">runMetaD</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runQuasi"><span class="hs-identifier">runQuasi</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-35"></span><span>     </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#tcTopSpliceExpr"><span class="hs-identifier">tcTopSpliceExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#lookupThName_maybe"><span class="hs-identifier">lookupThName_maybe</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-36"></span><span>     </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#defaultRunMeta"><span class="hs-identifier">defaultRunMeta</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runMeta%27"><span class="hs-identifier">runMeta'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runRemoteModFinalizers"><span class="hs-identifier">runRemoteModFinalizers</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-37"></span><span>     </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#finishTH"><span class="hs-identifier">finishTH</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runTopSplice"><span class="hs-identifier">runTopSplice</span></a></span><span>
</span><span id="line-38"></span><span>      </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-41"></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Errors.html"><span class="hs-identifier">GHC.Driver.Errors</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Plugins.html"><span class="hs-identifier">GHC.Driver.Plugins</span></a></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Main.html"><span class="hs-identifier">GHC.Driver.Main</span></a></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.DynFlags.html"><span class="hs-identifier">GHC.Driver.DynFlags</span></a></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Env.html"><span class="hs-identifier">GHC.Driver.Env</span></a></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Hooks.html"><span class="hs-identifier">GHC.Driver.Hooks</span></a></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Config.Diagnostic.html"><span class="hs-identifier">GHC.Driver.Config.Diagnostic</span></a></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Config.Finder.html"><span class="hs-identifier">GHC.Driver.Config.Finder</span></a></span><span>
</span><span id="line-50"></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Hs.html"><span class="hs-identifier">GHC.Hs</span></a></span><span>
</span><span id="line-52"></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Errors.Types.html"><span class="hs-identifier">GHC.Tc.Errors.Types</span></a></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html"><span class="hs-identifier">GHC.Tc.Utils.Monad</span></a></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html"><span class="hs-identifier">GHC.Tc.Utils.TcType</span></a></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Expr.html"><span class="hs-identifier">GHC.Tc.Gen.Expr</span></a></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html"><span class="hs-identifier">GHC.Tc.Utils.Unify</span></a></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Env.html"><span class="hs-identifier">GHC.Tc.Utils.Env</span></a></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html"><span class="hs-identifier">GHC.Tc.Types.Origin</span></a></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Types.LclEnv.html"><span class="hs-identifier">GHC.Tc.Types.LclEnv</span></a></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html"><span class="hs-identifier">GHC.Tc.Types.Evidence</span></a></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Zonk.Type.html"><span class="hs-identifier">GHC.Tc.Zonk.Type</span></a></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Zonk.TcType.html"><span class="hs-identifier">GHC.Tc.Zonk.TcType</span></a></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html"><span class="hs-identifier">GHC.Tc.Solver</span></a></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html"><span class="hs-identifier">GHC.Tc.Utils.TcMType</span></a></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.HsType.html"><span class="hs-identifier">GHC.Tc.Gen.HsType</span></a></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Instance.Family.html"><span class="hs-identifier">GHC.Tc.Instance.Family</span></a></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Instantiate.html"><span class="hs-identifier">GHC.Tc.Utils.Instantiate</span></a></span><span>
</span><span id="line-69"></span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Multiplicity.html"><span class="hs-identifier">GHC.Core.Multiplicity</span></a></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html"><span class="hs-identifier">GHC.Core.Coercion</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#etaExpandCoAxBranch"><span class="hs-identifier">etaExpandCoAxBranch</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Type.html"><span class="hs-identifier">GHC.Core.Type</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Type</span></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html"><span class="hs-identifier">GHC.Core.TyCo.Rep</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TyCoRep</span></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html"><span class="hs-identifier">GHC.Core.FamInstEnv</span></a></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.InstEnv.html"><span class="hs-identifier">GHC.Core.InstEnv</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">InstEnv</span></span><span>
</span><span id="line-76"></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.TH.html"><span class="hs-identifier">GHC.Builtin.Names.TH</span></a></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html"><span class="hs-identifier">GHC.Builtin.Names</span></a></span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.html"><span class="hs-identifier">GHC.Builtin.Types</span></a></span><span>
</span><span id="line-80"></span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.ThToHs.html"><span class="hs-identifier">GHC.ThToHs</span></a></span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.HsToCore.Docs.html"><span class="hs-identifier">GHC.HsToCore.Docs</span></a></span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.HsToCore.Expr.html"><span class="hs-identifier">GHC.HsToCore.Expr</span></a></span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.HsToCore.Monad.html"><span class="hs-identifier">GHC.HsToCore.Monad</span></a></span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.IfaceToCore.html"><span class="hs-identifier">GHC.IfaceToCore</span></a></span><span>
</span><span id="line-86"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Iface.Load.html"><span class="hs-identifier">GHC.Iface.Load</span></a></span><span>
</span><span id="line-87"></span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html"><span class="hs-identifier">GHCi.Message</span></a></span><span>
</span><span id="line-89"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html"><span class="hs-identifier">GHCi.RemoteTypes</span></a></span><span>
</span><span id="line-90"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html"><span class="hs-identifier">GHC.Runtime.Interpreter</span></a></span><span>
</span><span id="line-91"></span><span>
</span><span id="line-92"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Rename.Splice.html"><span class="hs-identifier">GHC.Rename.Splice</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Rename.Splice.html#traceSplice"><span class="hs-identifier">traceSplice</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Rename.Splice.html#SpliceInfo"><span class="hs-identifier">SpliceInfo</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-93"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Rename.Expr.html"><span class="hs-identifier">GHC.Rename.Expr</span></a></span><span>
</span><span id="line-94"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Rename.Env.html"><span class="hs-identifier">GHC.Rename.Env</span></a></span><span>
</span><span id="line-95"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Rename.Fixity.html"><span class="hs-identifier">GHC.Rename.Fixity</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Rename.Fixity.html#lookupFixityRn_help"><span class="hs-identifier">lookupFixityRn_help</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Rename.HsType.html"><span class="hs-identifier">GHC.Rename.HsType</span></a></span><span>
</span><span id="line-97"></span><span>
</span><span id="line-98"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Class.html"><span class="hs-identifier">GHC.Core.Class</span></a></span><span>
</span><span id="line-99"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html"><span class="hs-identifier">GHC.Core.TyCon</span></a></span><span>
</span><span id="line-100"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html"><span class="hs-identifier">GHC.Core.Coercion.Axiom</span></a></span><span>
</span><span id="line-101"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.PatSyn.html"><span class="hs-identifier">GHC.Core.PatSyn</span></a></span><span>
</span><span id="line-102"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.ConLike.html"><span class="hs-identifier">GHC.Core.ConLike</span></a></span><span>
</span><span id="line-103"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html"><span class="hs-identifier">GHC.Core.DataCon</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DataCon</span></span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html"><span class="hs-identifier">GHC.Types.SrcLoc</span></a></span><span>
</span><span id="line-106"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.Env.html"><span class="hs-identifier">GHC.Types.Name.Env</span></a></span><span>
</span><span id="line-107"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html"><span class="hs-identifier">GHC.Types.Name.Set</span></a></span><span>
</span><span id="line-108"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.Reader.html"><span class="hs-identifier">GHC.Types.Name.Reader</span></a></span><span>
</span><span id="line-109"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.Occurrence.html"><span class="hs-identifier">GHC.Types.Name.Occurrence</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">OccName</span></span><span>
</span><span id="line-110"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.html"><span class="hs-identifier">GHC.Types.Var</span></a></span><span>
</span><span id="line-111"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.html"><span class="hs-identifier">GHC.Types.Id</span></a></span><span>
</span><span id="line-112"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.Info.html"><span class="hs-identifier">GHC.Types.Id.Info</span></a></span><span>
</span><span id="line-113"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.html"><span class="hs-identifier">GHC.Types.Unique</span></a></span><span>
</span><span id="line-114"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html"><span class="hs-identifier">GHC.Types.Var.Set</span></a></span><span>
</span><span id="line-115"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Meta.html"><span class="hs-identifier">GHC.Types.Meta</span></a></span><span>
</span><span id="line-116"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html"><span class="hs-identifier">GHC.Types.Basic</span></a></span><span> </span><span class="hs-keyword">hiding</span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SuccessFlag"><span class="hs-identifier">SuccessFlag</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-117"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Error.html"><span class="hs-identifier">GHC.Types.Error</span></a></span><span>
</span><span id="line-118"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Fixity.html"><span class="hs-identifier">GHC.Types.Fixity</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Hs</span></span><span>
</span><span id="line-119"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Annotations.html"><span class="hs-identifier">GHC.Types.Annotations</span></a></span><span>
</span><span id="line-120"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.html"><span class="hs-identifier">GHC.Types.Name</span></a></span><span>
</span><span id="line-121"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Map.html"><span class="hs-identifier">GHC.Types.Unique.Map</span></a></span><span>
</span><span id="line-122"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../ghc-boot-9.12.2-1a37/src/GHC.Serialized.html"><span class="hs-identifier">GHC.Serialized</span></a></span><span>
</span><span id="line-123"></span><span>
</span><span id="line-124"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Finder.html"><span class="hs-identifier">GHC.Unit.Finder</span></a></span><span>
</span><span id="line-125"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Module.html"><span class="hs-identifier">GHC.Unit.Module</span></a></span><span>
</span><span id="line-126"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModIface.html"><span class="hs-identifier">GHC.Unit.Module.ModIface</span></a></span><span>
</span><span id="line-127"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Module.Deps.html"><span class="hs-identifier">GHC.Unit.Module.Deps</span></a></span><span>
</span><span id="line-128"></span><span>
</span><span id="line-129"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>
</span><span id="line-130"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Panic</span></span><span>
</span><span id="line-131"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Lexeme.html"><span class="hs-identifier">GHC.Utils.Lexeme</span></a></span><span>
</span><span id="line-132"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-133"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html"><span class="hs-identifier">GHC.Utils.Logger</span></a></span><span>
</span><span id="line-134"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Exception.html"><span class="hs-identifier">GHC.Utils.Exception</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">throwIO</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">ErrorCall</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-135"></span><span>
</span><span id="line-136"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html"><span class="hs-identifier">GHC.Utils.TmpFs</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#newTempName"><span class="hs-identifier">newTempName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TempFileLifetime"><span class="hs-identifier">TempFileLifetime</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span>
</span><span id="line-138"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html"><span class="hs-identifier">GHC.Data.FastString</span></a></span><span>
</span><span id="line-139"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Maybe.html"><span class="hs-identifier">GHC.Data.Maybe</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Data.Maybe.html#MaybeErr"><span class="hs-identifier">MaybeErr</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-140"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="GHC.Data.EnumSet.html"><span class="hs-identifier">GHC.Data.EnumSet</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">EnumSet</span></span><span>
</span><span id="line-141"></span><span>
</span><span id="line-142"></span><span class="hs-comment">-- THSyntax gives access to internal functions and data types</span><span>
</span><span id="line-143"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Internal.TH.Syntax</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TH</span></span><span>
</span><span id="line-144"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../ghc-boot-th-9.12.2-e976/src/GHC.Internal.TH.Ppr.html"><span class="hs-identifier">GHC.Internal.TH.Ppr</span></a></span><span>    </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TH</span></span><span class="hs-cpp">

#if defined(HAVE_INTERNAL_INTERPRETER)
</span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Unsafe.Coerce.html"><span class="hs-identifier">Unsafe.Coerce</span></a></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">unsafeCoerce</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-148"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/GHC.Desugar.html"><span class="hs-identifier">GHC.Desugar</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">AnnotationWrapper</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-151"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span>
</span><span id="line-152"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../binary-0.8.9.3-25e5/src/Data.Binary.html"><span class="hs-identifier">Data.Binary</span></a></span><span>
</span><span id="line-153"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../binary-0.8.9.3-25e5/src/Data.Binary.Get.html"><span class="hs-identifier">Data.Binary.Get</span></a></span><span>
</span><span id="line-154"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.Maybe.html"><span class="hs-identifier">Data.Maybe</span></a></span><span>
</span><span id="line-155"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../bytestring-0.12.2.0-7dd0/src/Data.ByteString.html"><span class="hs-identifier">Data.ByteString</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">B</span></span><span>
</span><span id="line-156"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../bytestring-0.12.2.0-7dd0/src/Data.ByteString.Lazy.html"><span class="hs-identifier">Data.ByteString.Lazy</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LB</span></span><span>
</span><span id="line-157"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.Dynamic.html"><span class="hs-identifier">Data.Dynamic</span></a></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">fromDynamic</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">toDyn</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.IntMap.html"><span class="hs-identifier">Data.IntMap</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">IntMap</span></span><span>
</span><span id="line-159"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Map.html"><span class="hs-identifier">Data.Map</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-160"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.Typeable.html"><span class="hs-identifier">Data.Typeable</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">typeOf</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Typeable</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">TypeRep</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">typeRep</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-161"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.Data.html"><span class="hs-identifier">Data.Data</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Data</span></span><span class="hs-special">)</span><span>
</span><span id="line-162"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.Proxy.html"><span class="hs-identifier">Data.Proxy</span></a></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">Proxy</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-163"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.IORef.html"><span class="hs-identifier">Data.IORef</span></a></span><span>
</span><span id="line-164"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Parser.HaddockLex.html"><span class="hs-identifier">GHC.Parser.HaddockLex</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Parser.HaddockLex.html#lexHsDoc"><span class="hs-identifier">lexHsDoc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-165"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Parser.html"><span class="hs-identifier">GHC.Parser</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Parser.html#parseIdentifier"><span class="hs-identifier">parseIdentifier</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-166"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Rename.Doc.html"><span class="hs-identifier">GHC.Rename.Doc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Rename.Doc.html#rnHsDoc"><span class="hs-identifier">rnHsDoc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-167"></span><span>
</span><span id="line-168"></span><span>
</span><span id="line-169"></span><span>
</span><span id="line-170"></span><span class="hs-comment">{-
Note [Template Haskell state diagram]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Here are the ThStages, s, their corresponding level numbers
(the result of (thLevel s)), and their state transitions.
The top level of the program is stage Comp:

     Start here
         |
         V
      -----------     $      ------------   $
      |  Comp   | ---------&gt; |  Splice  | -----|
      |   1     |            |    0     | &lt;----|
      -----------            ------------
        ^     |                ^      |
      $ |     | [||]         $ |      | [||]
        |     v                |      v
   --------------          ----------------
   | Brack Comp |          | Brack Splice |
   |     2      |          |      1       |
   --------------          ----------------

* Normal top-level declarations start in state Comp
       (which has level 1).
  Annotations start in state Splice, since they are
       treated very like a splice (only without a '$')

* Code compiled in state Splice (and only such code)
  will be *run at compile time*, with the result replacing
  the splice

* The original paper used level -1 instead of 0, etc.

* The original paper did not allow a splice within a
  splice, but there is no reason not to. This is the
  $ transition in the top right.

Note [Template Haskell levels]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
* Imported things are impLevel (= 0)

* However things at level 0 are not *necessarily* imported.
      eg  $( \b -&gt; ... )   here b is bound at level 0

* In GHCi, variables bound by a previous command are treated
  as impLevel, because we have bytecode for them.

* Variables are bound at the &quot;current level&quot;

* The current level starts off at outerLevel (= 1)

* The level is decremented by splicing $(..)
               incremented by brackets [| |]
               incremented by name-quoting 'f

* When a variable is used, checkWellStaged compares
        bind:  binding level, and
        use:   current level at usage site

  Generally
        bind &gt; use      Always error (bound later than used)
                        [| \x -&gt; $(f x) |]

        bind = use      Always OK (bound same stage as used)
                        [| \x -&gt; $(f [| x |]) |]

        bind &lt; use      Inside brackets, it depends
                        Inside splice, OK
                        Inside neither, OK

  For (bind &lt; use) inside brackets, there are three cases:
    - Imported things   OK      f = [| map |]
    - Top-level things  OK      g = [| f |]
    - Non-top-level     Only if there is a liftable instance
                                h = \(x:Int) -&gt; [| x |]

  To track top-level-ness we use the ThBindEnv in TcLclEnv

  For example:
           f = ...
           g1 = $(map ...)         is OK
           g2 = $(f ...)           is not OK; because we haven't compiled f yet


Note [How top-level splices are handled]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Top-level splices (those not inside a [| .. |] quotation bracket) are handled
very straightforwardly:

  1. tcTopSpliceExpr: typecheck the body e of the splice $(e)

  2. runMetaT: desugar, compile, run it, and convert result back to
     GHC.Hs syntax RdrName (of the appropriate flavour, eg HsType RdrName,
     HsExpr RdrName etc)

  3. treat the result as if that's what you saw in the first place
     e.g for HsType, rename and kind-check
         for HsExpr, rename and type-check

     (The last step is different for decls, because they can *only* be
      top-level: we return the result of step 2.)

Note [Warnings for TH splices]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We only produce warnings for TH splices when the user requests so
(-fenable-th-splice-warnings). There are multiple reasons:

  * It's not clear that the user that compiles a splice is the author of the code
    that produces the warning. Think of the situation where they just splice in
    code from a third-party library that produces incomplete pattern matches.
    In this scenario, the user isn't even able to fix that warning.
  * Gathering information for producing the warnings (pattern-match check
    warnings in particular) is costly. There's no point in doing so if the user
    is not interested in those warnings.

That's why we store Origin flags in the Haskell AST. The functions from ThToHs
take such a flag and depending on whether TH splice warnings were enabled or
not, we pass FromSource (if the user requests warnings) or Generated
(otherwise). This is implemented in getThSpliceOrigin.

For correct pattern-match warnings it's crucial that we annotate the Origin
consistently (#17270). In the future we could offer the Origin as part of the
TH AST. That would enable us to give quotes from the current module get
FromSource origin, and/or third library authors to tag certain parts of
generated code as FromSource to enable warnings.
That effort is tracked in #14838.

Note [The life cycle of a TH quotation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When desugaring a bracket (aka quotation), we want to produce Core
code that, when run, will produce the TH syntax tree for the quotation.
To that end, we want to desugar /renamed/ but not /typechecked/ code;
the latter is cluttered with the typechecker's elaboration that should
not appear in the TH syntax tree. So in (HsExpr GhcTc) tree, we must
have a (HsExpr GhcRn) for the quotation itself.

As such, when typechecking both typed and untyped brackets,
we keep a /renamed/ bracket in the extension field.

The HsBracketTc, the GhcTc ext field for both typed and untyped
brackets, contains:
  - The renamed quote :: HsQuote GhcRn -- for the desugarer
  - [PendingTcSplice]
  - The type of the quote
  - Maybe QuoteWrapper

Note that HsBracketTc stores the untyped (HsQuote GhcRn) for both typed and
untyped brackets. They are treated uniformly by the desugarer, and we can
easily construct untyped brackets from typed ones (with ExpBr).

See Note [Desugaring of brackets].

------------
Typed quotes
------------
Here is the life cycle of a /typed/ quote [|| e ||], whose datacon is
  HsTypedBracket (XTypedBracket p) (LHsExpr p)

  In pass p   (XTypedBracket p)       (LHsExpr p)
  -------------------------------------------
  GhcPs       Annotations only        LHsExpr GhcPs
  GhcRn       Annotations only        LHsExpr GhcRn
  GhcTc       HsBracketTc             LHsExpr GhcTc: unused!

Note that in the GhcTc tree, the second field (HsExpr GhcTc)
is entirely unused; the desugarer uses the (HsExpr GhcRn) from the
first field.

--------------
Untyped quotes
--------------
Here is the life cycle of an /untyped/ quote, whose datacon is
   HsUntypedBracket (XUntypedBracket p) (HsQuote p)

Here HsQuote is a sum-type of expressions [| e |], patterns [| p |],
types [| t |] etc.

  In pass p   (XUntypedBracket p)          (HsQuote p)
  -------------------------------------------------------
  GhcPs   Annotations only                 HsQuote GhcPs
  GhcRn   Annotations, [PendingRnSplice]   HsQuote GhcRn
  GhcTc   HsBracketTc                      HsQuote GhcTc: unused!

The difficulty is: the typechecker does not typecheck the body of an
untyped quote, so how do we make a (HsQuote GhcTc) to put in the
second field?

Answer: we use the extension constructor of HsQuote, namely XQuote,
and make all the other constructors into DataConCantHappen.  That is,
the only non-bottom value of type (HsQuote GhcTc) is (XQuote noExtField).
Hence the instances

  type instance XExpBr GhcTc = DataConCantHappen
  ...etc...

See the related Note [How brackets and nested splices are handled]

Note [Typechecking Overloaded Quotes]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The main function for typechecking untyped quotations is `tcUntypedBracket`.

Consider an expression quote, `[| e |]`, its type is `forall m . Quote m =&gt; m Exp`.
Note carefully that this is overloaded: its type is not `Q Exp` for some fixed Q.

When we typecheck it we therefore create a template of a metavariable
`m` applied to `Exp` and emit a constraint `Quote m`. All this is done
in the `brackTy` function.  `brackTy` also selects the correct
contents type for the quotation (Exp, Type, Decs etc).

The meta variable and the constraint evidence variable are
returned together in a `QuoteWrapper` and then passed along to two further places
during compilation:

1. Typechecking nested splices (immediately in tcPendingSplice)
2. Desugaring quotations (see GHC.HsToCore.Quote)

`tcPendingSplice` takes the `m` type variable as an argument and
checks each nested splice against this variable `m`. During this
process the variable `m` can either be fixed to a specific value or
further constrained by the nested splices.

Once we have checked all the nested splices, the quote type is checked against
the expected return type.

The process is very simple and like typechecking a list where the quotation is
like the container and the splices are the elements of the list which must have
a specific type.

After the typechecking process is completed, the evidence variable for `Quote m`
and the type `m` is stored in a `QuoteWrapper` which is passed through the pipeline
and used when desugaring quotations.

Typechecking typed quotations is a similar idea but the `QuoteWrapper` is stored
in the `PendingStuff` as the nested splices are gathered up in a different way
to untyped splices. Untyped splices are found in the renamer but typed splices are
not typechecked and extracted until during typechecking.

Note [Lifecycle of an untyped splice, and PendingRnSplice]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Untyped splices $(f x) and quasiquotes [p| stuff |] have the following
life cycle. Remember, quasi-quotes are very like splices; see Note [Quasi-quote overview]).

The type structure is

  data HsExpr p = ...
    | HsUntypedSplice (XUntypedSplice p) (HsUntypedSplice p)

  data HsUntypedSplice p
    = HsUntypedSpliceExpr (XUntypedSpliceExpr p) (LHsExpr p)
    | HsQuasiQuote (XQuasiQuote p) (IdP id) (XRec p FastString)

Remember that untyped splices can occur in expressions, patterns,
types, and declarations.  So we have a HsUntypedSplice data
constructor in all four of these types.

Untyped splices never occur in (HsExpr GhcTc), and similarly
patterns etc. So we have

   type instance XUntypedSplice GhcTc = DataConCantHappen

Top-level and nested splices are handled differently.

-------------------------------------
Nested untyped splices/quasiquotes
----------------------------------
When we rename an /untyped/ bracket, such as
     [| f $(g x) |]
we name and lift out all the nested splices, so that when the
typechecker hits the bracket, it can typecheck those nested splices
without having to walk over the untyped bracket code.  Our example
[| f $(g x) |] parses as

    HsUntypedBracket _
       (HsApp (HsVar &quot;f&quot;)
              (HsUntypedSplice _ (HsUntypedSpliceExpr _ (g x :: LHsExpr GhcPs)))

RENAMER (rnUntypedBracket):

* Set the ThStage to (Brack s (RnPendingUntyped ps_var))

* Rename the body

* Nested splices (which must be untyped) are renamed (rnUntypedSplice),
  and the results accumulated in ps_var. Each gets a fresh
  SplicePointName, 'spn'

* The SplicePointName connects the `PendingRnSplice` with the particular point
  in the syntax tree where that expression should be spliced in.  That point
  in the tree is identified by `(HsUntypedSpliceNested spn)`.  It is used by
  the desugarer, so that we ultimately generate something like
       let spn = g x
       in App (Var &quot;f&quot;) spn

The result is
    HsUntypedBracket
        [PendingRnSplice UntypedExpSplice spn (g x  :: LHsExpr GHcRn)]
        (HsApp (HsVar f) (HsUntypedSplice (HsUntypedSpliceNested spn)
                                          (HsUntypedSpliceExpr _ (g x :: LHsExpr GhcRn))))

Note that a nested splice, such as the `$(g x)` now appears twice:
  - In the PendingRnSplice: this is the version that will later be typechecked
  - In the HsUntypedSpliceExpr in the body of the bracket. This copy is used
    only for pretty printing.

NB: a single untyped bracket can contain many splices, each of a different
`UntypedSpliceFlavour`. For example

   [| let $e0 in (f :: $e1) $e2 (\ $e -&gt; body ) |] + 1

Here $e0 is a declaration splice, $e1 is a type splice, $e2 is an
expression splice, and $e3 is a pattern splice.  The `PendingRnSplice`
keeps track of which is which through its `UntypedSpliceFlavour`
field.

TYPECHECKER (tcUntypedBracket): see also Note [Typechecking Overloaded Quotes]

* Typecheck the [PendingRnSplice] individually, to give [PendingTcSplice]
  So PendingTcSplice is used for both typed and untyped splices.

* Ignore the body of the bracket; just check that the context
  expects a bracket of that type (e.g. a [p| pat |] bracket should
  be in a context needing a (m Pat)

* Stash the whole lot inside a HsBracketTc

Result is:
    HsUntypedBracket
        (HsBracketTc { hsb_splices = [PendingTcSplice spn (g x  :: LHsExpr GHcTc)]
                     , hsb_quote = HsApp (HsVar f)
                                         (HsUntypedSplice (HsUntypedSpliceNested spn)
                                            (HsUntypedSpliceExpr _ (g x :: LHsExpr GhcRn)))
                     })
        (XQuote noExtField)

NB in the typechecker output, the original payload (which would now
have type (HsQuote GhcTc) is stubbed off with (XQuote noExtField). The payload
is now in the hsb_quote field of the HsBracketTc.


-------------------------------------
Top-level untyped splices/quasiquotes
-------------------------------------
A top-level splice (not inside a bracket) does not need a SpliceName,
nor does a top-level splice ever end up inside a PendingRnSplice;
hence HsUntypedSpliceTop does not have a SplicePointName field.

Example $(g x).  This is parsed as

  HsUntypedSplice _ (HsUntypedSpliceExpr _ ((g x) :: LHsExpr GhcPs))

Renamer: the renamer runs the splice, so the output of the renamer looks like

  HsUntypedSplice (HsUntypedSpliceTop fins (e2 :: LHsExpr GhcRn))
                  (HsUntypedSpliceExpr ((g x) :: LHsExpr GhcRn))

where 'e2' is the result of running (g x) to
             produce the syntax tree for 'e2'
      'fins' is a bunch of TH finalisers, to be run later.

Typechecker: the typechecker simply adds the finalisers, and
typechecks e2, discarding the HsUntypedSplice altogether.


Note [Lifecycle of an typed splice, and PendingTcSplice]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

----------------------
Nested, typed splices
----------------------
When we typecheck a /typed/ bracket, we lift nested splices out as
`PendingTcSplice`, very similar to Note [PendingRnSplice]. Again, the
splice needs a SplicePointName, for the desguarer to use to connect
the splice expression with the point in the syntax tree where it is
used.  Example:
     [||  f $$(g 2)||]

Parser: this is parsed as

    HsTypedBracket _ (HsApp (HsVar &quot;f&quot;)
                            (HsTypedSplice _ (g 2 :: LHsExpr GhcPs)))

RENAMER (rnTypedSplice): the renamer adds a SplicePointName, spn:

    HsTypedBracket _ (HsApp (HsVar &quot;f&quot;)
                            (HsTypedSplice spn (g x :: LHsExpr GhcRn)))

TYPECHECKER (tcTypedBracket):

* Set the ThStage to (Brack s (TcPending ps_var lie_var))

* Typecheck the body, and keep the elaborated result (despite never using it!)

* Nested splices (which must be typed) are typechecked by tcNestedSplice, and
  the results accumulated in ps_var; their constraints accumulate in lie_var

* Result is a HsTypedBracket (HsBracketTc rn_brack ty quote_wrapper pending_splices) tc_brack
  where rn_brack is the untyped renamed exp quote constructed from the typed renamed expression :: HsQuote GhcRn

Just like untyped brackets, dump the output into a HsBracketTc.

    HsTypedBracket
        (HsBracketTc { hsb_splices = [PendingTcSplice spn (g x  :: LHsExpr GHcTc)]
                     , hsb_quote = HsApp (HsVar f)
                                         (HsUntypedSplice (HsUntypedSpliceNested spn)
                                            (HsUntypedSpliceExpr _ (g x :: LHsExpr GhcRn)))
                     })
        (panic &quot;should never be looked at&quot;)

NB: we never need to represent typed /nested/ splices in phase GhcTc.

There are only typed expression splices so `PendingTcSplice` doesn't have a
flavour field.


--------------------------------
Top-level, typed splices $$(f x)
--------------------------------
Typed splices are renamed and typechecked, but only actually run in
the zonker, after typechecking. See Note [Running typed splices in the zonker]

* Output of parser:
  HsTypedSplice _ (e :: HsExpr GhcPs)

* Output of renamer:
  HsTypedSplice (n :: SplicePointName) (e :: HsExpr GhcRn)

* Output of typechecker: (top-level splices only)
  HsTypedSplice (del_splice :: DelayedSplice) (e :: HsExpr GhcTc)
  where 'del_splice' is something the zonker can run to produce
           the syntax tree to splice in.
           See Note [Running typed splices in the zonker]

Note [Desugaring of brackets]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In both cases, desugaring happens like this:
  * Hs*Bracket is desugared by GHC.HsToCore.Quote.dsBracket using the renamed
    expression held in `HsBracketTc` (`type instance X*Bracket GhcTc = HsBracketTc`). It

      a) Extends the ds_meta environment with the PendingSplices
         attached to the bracket

      b) Converts the quoted (HsExpr Name) to a CoreExpr that, when
         run, will produce a suitable TH expression/type/decl.  This
         is why we leave the *renamed* expression attached to the bracket:
         the quoted expression should not be decorated with all the goop
         added by the type checker

  * Each splice carries a unique Name, called a &quot;splice point&quot;, thus
    ${n}(e).  The name is initialised to an (Unqual &quot;splice&quot;) when the
    splice is created; the renamer gives it a unique.

  * When GHC.HsToCore.Quote (used to desugar the body of the bracket) comes across
    a splice, it looks up the splice's Name, n, in the ds_meta envt,
    to find an (HsExpr Id) that should be substituted for the splice;
    it just desugars it to get a CoreExpr (GHC.HsToCore.Quote.repSplice).

Example:
    Source:       f = [| Just $(g 3) |]
      The [| |] part is a HsUntypedBracket GhcPs

    Typechecked:  f = [| Just ${s7}(g 3) |]{s7 = g Int 3}
      The [| |] part is a HsUntypedBracket GhcTc, containing *renamed*
        (not typechecked) expression (see Note [The life cycle of a TH quotation])
      The &quot;s7&quot; is the &quot;splice point&quot;; the (g Int 3) part
        is a typechecked expression

    Desugared:    f = do { s7 &lt;- g Int 3
                         ; return (ConE &quot;Data.Maybe.Just&quot; s7) }

-}</span><span>
</span><span id="line-640"></span><span>
</span><span id="line-641"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Main interface + stubs for the non-GHCI case
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-648"></span><span>
</span><span id="line-649"></span><span class="hs-comment">-- None of these functions add constraints to the LIE</span><span>
</span><span id="line-650"></span><span>
</span><span id="line-651"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#tcTypedBracket"><span class="hs-identifier hs-type">tcTypedBracket</span></a></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#LHsExpr"><span class="hs-identifier hs-type">LHsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#ExpRhoType"><span class="hs-identifier hs-type">ExpRhoType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcTc"><span class="hs-identifier hs-type">GhcTc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-652"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#tcUntypedBracket"><span class="hs-identifier hs-type">tcUntypedBracket</span></a></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsQuote"><span class="hs-identifier hs-type">HsQuote</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Hs.Expr.html#PendingRnSplice"><span class="hs-identifier hs-type">PendingRnSplice</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#ExpRhoType"><span class="hs-identifier hs-type">ExpRhoType</span></a></span><span>
</span><span id="line-653"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcTc"><span class="hs-identifier hs-type">GhcTc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-654"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#tcTypedSplice"><span class="hs-identifier hs-type">tcTypedSplice</span></a></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#LHsExpr"><span class="hs-identifier hs-type">LHsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#ExpRhoType"><span class="hs-identifier hs-type">ExpRhoType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcTc"><span class="hs-identifier hs-type">GhcTc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-655"></span><span>
</span><span id="line-656"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#getUntypedSpliceBody"><span class="hs-identifier hs-type">getUntypedSpliceBody</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Hs.Expr.html#HsUntypedSpliceResult"><span class="hs-identifier hs-type">HsUntypedSpliceResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-657"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runAnnotation"><span class="hs-identifier hs-type">runAnnotation</span></a></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Annotations.html#CoreAnnTarget"><span class="hs-identifier hs-type">CoreAnnTarget</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#LHsExpr"><span class="hs-identifier hs-type">LHsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Annotations.html#Annotation"><span class="hs-identifier hs-type">Annotation</span></a></span><span>
</span><span id="line-658"></span><span>
</span><span id="line-659"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Quoting an expression}
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-666"></span><span>
</span><span id="line-667"></span><span class="hs-comment">-- See Note [How brackets and nested splices are handled]</span><span>
</span><span id="line-668"></span><span id="tcTypedBracket"><span class="annot"><span class="annottext">tcTypedBracket :: HsExpr GhcRn -&gt; LHsExpr GhcRn -&gt; ExpRhoType -&gt; TcM (HsExpr GhcTc)
</span><a href="GHC.Tc.Gen.Splice.html#tcTypedBracket"><span class="hs-identifier hs-var hs-var">tcTypedBracket</span></a></span></span><span> </span><span id="local-6989586621683159555"><span class="annot"><span class="annottext">HsExpr GhcRn
</span><a href="#local-6989586621683159555"><span class="hs-identifier hs-var">rn_expr</span></a></span></span><span> </span><span id="local-6989586621683159556"><span class="annot"><span class="annottext">LHsExpr GhcRn
</span><a href="#local-6989586621683159556"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span id="local-6989586621683159557"><span class="annot"><span class="annottext">ExpRhoType
</span><a href="#local-6989586621683159557"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span>
</span><span id="line-669"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; TcM (HsExpr GhcTc) -&gt; TcM (HsExpr GhcTc)
forall a. SDoc -&gt; TcM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LHsExpr GhcRn -&gt; SDoc
</span><a href="GHC.Tc.Gen.Splice.html#quotationCtxtDoc"><span class="hs-identifier hs-var">quotationCtxtDoc</span></a></span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcRn
</span><a href="#local-6989586621683159556"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcM (HsExpr GhcTc) -&gt; TcM (HsExpr GhcTc))
-&gt; TcM (HsExpr GhcTc) -&gt; TcM (HsExpr GhcTc)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-670"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683159560"><span class="annot"><a href="#local-6989586621683159560"><span class="hs-identifier hs-var">cur_stage</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM ThStage
</span><a href="GHC.Tc.Utils.Monad.html#getStage"><span class="hs-identifier hs-var">getStage</span></a></span><span>
</span><span id="line-671"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683159562"><span class="annot"><a href="#local-6989586621683159562"><span class="hs-identifier hs-var">ps_ref</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Data.IOEnv.html#newMutVar"><span class="hs-identifier hs-type">newMutVar</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-672"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683159564"><span class="annot"><a href="#local-6989586621683159564"><span class="hs-identifier hs-var">lie_var</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#getConstraintVar"><span class="hs-identifier hs-type">getConstraintVar</span></a></span><span>   </span><span class="hs-comment">-- Any constraints arising from nested splices</span><span>
</span><span id="line-673"></span><span>                                       </span><span class="hs-comment">-- should get thrown into the constraint set</span><span>
</span><span id="line-674"></span><span>                                       </span><span class="hs-comment">-- from outside the bracket</span><span>
</span><span id="line-675"></span><span>
</span><span id="line-676"></span><span>       </span><span class="hs-comment">-- Make a new type variable for the type of the overall quote</span><span>
</span><span id="line-677"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683159566"><span class="annot"><a href="#local-6989586621683159566"><span class="hs-identifier hs-var">m_var</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-type">mkTyVarTy</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#mkMetaTyVar"><span class="hs-identifier hs-type">mkMetaTyVar</span></a></span><span>
</span><span id="line-678"></span><span>       </span><span class="hs-comment">-- Make sure the type variable satisfies Quote</span><span>
</span><span id="line-679"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683159570"><span class="annot"><a href="#local-6989586621683159570"><span class="hs-identifier hs-var">ev_var</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#emitQuoteWanted"><span class="hs-identifier hs-type">emitQuoteWanted</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159566"><span class="hs-identifier hs-type">m_var</span></a></span><span>
</span><span id="line-680"></span><span>       </span><span class="hs-comment">-- Bundle them together so they can be used in GHC.HsToCore.Quote for desugaring</span><span>
</span><span id="line-681"></span><span>       </span><span class="hs-comment">-- brackets.</span><span>
</span><span id="line-682"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683159572"><span class="annot"><a href="#local-6989586621683159572"><span class="hs-identifier hs-var hs-var">wrapper</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Type -&gt; QuoteWrapper
</span><a href="GHC.Tc.Types.Evidence.html#QuoteWrapper"><span class="hs-identifier hs-var">QuoteWrapper</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621683159570"><span class="hs-identifier hs-var">ev_var</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683159566"><span class="hs-identifier hs-var">m_var</span></a></span><span>
</span><span id="line-683"></span><span>       </span><span class="hs-comment">-- Typecheck expr to make sure it is valid.</span><span>
</span><span id="line-684"></span><span>       </span><span class="hs-comment">-- The typechecked expression won't be used, so we just discard it</span><span>
</span><span id="line-685"></span><span>       </span><span class="hs-comment">--   (See Note [The life cycle of a TH quotation] in GHC.Hs.Expr)</span><span>
</span><span id="line-686"></span><span>       </span><span class="hs-comment">-- We'll typecheck it again when we splice it in somewhere</span><span>
</span><span id="line-687"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683159574"><span class="annot"><a href="#local-6989586621683159574"><span class="hs-identifier hs-var">tc_expr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683159575"><span class="annot"><a href="#local-6989586621683159575"><span class="hs-identifier hs-var">expr_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#setStage"><span class="hs-identifier hs-type">setStage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.TH.html#Brack"><span class="hs-identifier hs-type">Brack</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159560"><span class="hs-identifier hs-type">cur_stage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.TH.html#TcPending"><span class="hs-identifier hs-type">TcPending</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159562"><span class="hs-identifier hs-type">ps_ref</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159564"><span class="hs-identifier hs-type">lie_var</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159572"><span class="hs-identifier hs-type">wrapper</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-688"></span><span>                                </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#tcScalingUsage"><span class="hs-identifier hs-type">tcScalingUsage</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Type.html#ManyTy"><span class="hs-identifier hs-type">ManyTy</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-689"></span><span>                                </span><span class="hs-comment">-- Scale by Many, TH lifting is currently nonlinear (#18465)</span><span>
</span><span id="line-690"></span><span>                                </span><span class="annot"><a href="GHC.Tc.Gen.Expr.html#tcInferRhoNC"><span class="hs-identifier hs-type">tcInferRhoNC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159556"><span class="hs-identifier hs-type">expr</span></a></span><span>
</span><span id="line-691"></span><span>                                </span><span class="hs-comment">-- NC for no context; tcBracket does that</span><span>
</span><span id="line-692"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683159582"><span class="annot"><a href="#local-6989586621683159582"><span class="hs-identifier hs-var hs-var">rep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Type
Type -&gt; Type
</span><a href="GHC.Core.Type.html#getRuntimeRep"><span class="hs-identifier hs-var">getRuntimeRep</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683159575"><span class="hs-identifier hs-var">expr_ty</span></a></span><span>
</span><span id="line-693"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683159584"><span class="annot"><a href="#local-6989586621683159584"><span class="hs-identifier hs-var">meta_ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#tcTExpTy"><span class="hs-identifier hs-type">tcTExpTy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159566"><span class="hs-identifier hs-type">m_var</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159575"><span class="hs-identifier hs-type">expr_ty</span></a></span><span>
</span><span id="line-694"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683159586"><span class="annot"><a href="#local-6989586621683159586"><span class="hs-identifier hs-var">ps'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Data.IOEnv.html#readMutVar"><span class="hs-identifier hs-type">readMutVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159562"><span class="hs-identifier hs-type">ps_ref</span></a></span><span>
</span><span id="line-695"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683159588"><span class="annot"><a href="#local-6989586621683159588"><span class="hs-identifier hs-var">codeco</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Env.html#tcLookupId"><span class="hs-identifier hs-type">tcLookupId</span></a></span><span> </span><span class="annot"><a href="GHC.Builtin.Names.TH.html#unsafeCodeCoerceName"><span class="hs-identifier hs-type">unsafeCodeCoerceName</span></a></span><span>
</span><span id="line-696"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683159591"><span class="annot"><a href="#local-6989586621683159591"><span class="hs-identifier hs-var">bracket_ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Type.html#mkAppTy"><span class="hs-identifier hs-type">mkAppTy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159566"><span class="hs-identifier hs-type">m_var</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Env.html#tcMetaTy"><span class="hs-identifier hs-type">tcMetaTy</span></a></span><span> </span><span class="annot"><a href="GHC.Builtin.Names.TH.html#expTyConName"><span class="hs-identifier hs-type">expTyConName</span></a></span><span>
</span><span id="line-697"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683159595"><span class="annot"><a href="#local-6989586621683159595"><span class="hs-identifier hs-var hs-var">brack_tc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Hs.Expr.html#HsBracketTc"><span class="hs-identifier hs-type">HsBracketTc</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">hsb_quote :: HsQuote GhcRn
</span><a href="GHC.Hs.Expr.html#hsb_quote"><span class="hs-identifier hs-var">hsb_quote</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">XExpBr GhcRn -&gt; LHsExpr GhcRn -&gt; HsQuote GhcRn
forall p. XExpBr p -&gt; LHsExpr p -&gt; HsQuote p
</span><a href="Language.Haskell.Syntax.Expr.html#ExpBr"><span class="hs-identifier hs-var">ExpBr</span></a></span><span> </span><span class="annot"><span class="annottext">XExpBr GhcRn
NoExtField
</span><a href="Language.Haskell.Syntax.Extension.html#noExtField"><span class="hs-identifier hs-var">noExtField</span></a></span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcRn
</span><a href="#local-6989586621683159556"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">hsb_ty :: Type
</span><a href="GHC.Hs.Expr.html#hsb_ty"><span class="hs-identifier hs-var">hsb_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683159591"><span class="hs-identifier hs-var">bracket_ty</span></a></span><span>
</span><span id="line-698"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">hsb_wrap :: Maybe QuoteWrapper
</span><a href="GHC.Hs.Expr.html#hsb_wrap"><span class="hs-identifier hs-var">hsb_wrap</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QuoteWrapper -&gt; Maybe QuoteWrapper
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">QuoteWrapper
</span><a href="#local-6989586621683159572"><span class="hs-identifier hs-var">wrapper</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">hsb_splices :: [PendingTcSplice]
</span><a href="GHC.Hs.Expr.html#hsb_splices"><span class="hs-identifier hs-var">hsb_splices</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PendingTcSplice]
</span><a href="#local-6989586621683159586"><span class="hs-identifier hs-var">ps'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-699"></span><span>             </span><span class="hs-comment">-- The tc_expr is stored here so that the expression can be used in HIE files.</span><span>
</span><span id="line-700"></span><span>             </span><span id="local-6989586621683159603"><span class="annot"><a href="#local-6989586621683159603"><span class="hs-identifier hs-var hs-var">brack_expr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">XTypedBracket GhcTc -&gt; LHsExpr GhcTc -&gt; HsExpr GhcTc
forall p. XTypedBracket p -&gt; LHsExpr p -&gt; HsExpr p
</span><a href="Language.Haskell.Syntax.Expr.html#HsTypedBracket"><span class="hs-identifier hs-var">HsTypedBracket</span></a></span><span> </span><span class="annot"><span class="annottext">XTypedBracket GhcTc
HsBracketTc
</span><a href="#local-6989586621683159595"><span class="hs-identifier hs-var">brack_tc</span></a></span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcTc
</span><a href="#local-6989586621683159574"><span class="hs-identifier hs-var">tc_expr</span></a></span><span>
</span><span id="line-701"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcWrapResultO"><span class="hs-identifier hs-type">tcWrapResultO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#Shouldn%27tHappenOrigin"><span class="hs-identifier hs-type">Shouldn'tHappenOrigin</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;TH typed bracket expression&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-702"></span><span>                       </span><span class="annot"><a href="#local-6989586621683159555"><span class="hs-identifier hs-type">rn_expr</span></a></span><span>
</span><span id="line-703"></span><span>                       </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.SrcLoc.html#unLoc"><span class="hs-identifier hs-type">unLoc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Hs.Utils.html#mkHsApp"><span class="hs-identifier hs-type">mkHsApp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Hs.Utils.html#mkLHsWrap"><span class="hs-identifier hs-type">mkLHsWrap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#applyQuoteWrapper"><span class="hs-identifier hs-type">applyQuoteWrapper</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159572"><span class="hs-identifier hs-type">wrapper</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-704"></span><span>                                                  </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Hs.Utils.html#nlHsTyApp"><span class="hs-identifier hs-type">nlHsTyApp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159588"><span class="hs-identifier hs-type">codeco</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621683159582"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683159575"><span class="hs-identifier hs-type">expr_ty</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-705"></span><span>                                      </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Parser.Annotation.html#noLocA"><span class="hs-identifier hs-type">noLocA</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159603"><span class="hs-identifier hs-type">brack_expr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-706"></span><span>                       </span><span class="annot"><a href="#local-6989586621683159584"><span class="hs-identifier hs-type">meta_ty</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159557"><span class="hs-identifier hs-type">res_ty</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-707"></span><span>
</span><span id="line-708"></span><span class="hs-comment">-- See Note [Typechecking Overloaded Quotes]</span><span>
</span><span id="line-709"></span><span id="tcUntypedBracket"><span class="annot"><span class="annottext">tcUntypedBracket :: HsExpr GhcRn
-&gt; HsQuote GhcRn
-&gt; [PendingRnSplice]
-&gt; ExpRhoType
-&gt; TcM (HsExpr GhcTc)
</span><a href="GHC.Tc.Gen.Splice.html#tcUntypedBracket"><span class="hs-identifier hs-var hs-var">tcUntypedBracket</span></a></span></span><span> </span><span id="local-6989586621683159613"><span class="annot"><span class="annottext">HsExpr GhcRn
</span><a href="#local-6989586621683159613"><span class="hs-identifier hs-var">rn_expr</span></a></span></span><span> </span><span id="local-6989586621683159614"><span class="annot"><span class="annottext">HsQuote GhcRn
</span><a href="#local-6989586621683159614"><span class="hs-identifier hs-var">brack</span></a></span></span><span> </span><span id="local-6989586621683159615"><span class="annot"><span class="annottext">[PendingRnSplice]
</span><a href="#local-6989586621683159615"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span id="local-6989586621683159616"><span class="annot"><span class="annottext">ExpRhoType
</span><a href="#local-6989586621683159616"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span>
</span><span id="line-710"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcRn ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tc_bracket untyped&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HsQuote GhcRn -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">HsQuote GhcRn
</span><a href="#local-6989586621683159614"><span class="hs-identifier hs-var">brack</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">[PendingRnSplice] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[PendingRnSplice]
</span><a href="#local-6989586621683159615"><span class="hs-identifier hs-var">ps</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-711"></span><span>
</span><span id="line-712"></span><span>       </span><span class="hs-comment">-- Create the type m Exp for expression bracket, m Type for a type</span><span>
</span><span id="line-713"></span><span>       </span><span class="hs-comment">-- bracket and so on. The brack_info is a Maybe because the</span><span>
</span><span id="line-714"></span><span>       </span><span class="hs-comment">-- VarBracket ('a) isn't overloaded, but also shouldn't contain any</span><span>
</span><span id="line-715"></span><span>       </span><span class="hs-comment">-- splices.</span><span>
</span><span id="line-716"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683159620"><span class="annot"><a href="#local-6989586621683159620"><span class="hs-identifier hs-var">brack_info</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683159621"><span class="annot"><a href="#local-6989586621683159621"><span class="hs-identifier hs-var">expected_type</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HsQuote GhcRn -&gt; TcM (Maybe QuoteWrapper, Type)
</span><a href="GHC.Tc.Gen.Splice.html#brackTy"><span class="hs-identifier hs-var">brackTy</span></a></span><span> </span><span class="annot"><span class="annottext">HsQuote GhcRn
</span><a href="#local-6989586621683159614"><span class="hs-identifier hs-var">brack</span></a></span><span>
</span><span id="line-717"></span><span>
</span><span id="line-718"></span><span>       </span><span class="hs-comment">-- Match the expected type with the type of all the internal</span><span>
</span><span id="line-719"></span><span>       </span><span class="hs-comment">-- splices. They might have further constrained types and if they do</span><span>
</span><span id="line-720"></span><span>       </span><span class="hs-comment">-- we want to reflect that in the overall type of the bracket.</span><span>
</span><span id="line-721"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683159623"><span class="annot"><a href="#local-6989586621683159623"><span class="hs-identifier hs-var">ps'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#quoteWrapperTyVarTy"><span class="hs-identifier hs-type">quoteWrapperTyVarTy</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621683159620"><span class="hs-identifier hs-type">brack_info</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-722"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683159625"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683159625"><span class="hs-identifier hs-var">m_var</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(PendingRnSplice -&gt; IOEnv (Env TcGblEnv TcLclEnv) PendingTcSplice)
-&gt; [PendingRnSplice]
-&gt; IOEnv (Env TcGblEnv TcLclEnv) [PendingTcSplice]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type
-&gt; PendingRnSplice -&gt; IOEnv (Env TcGblEnv TcLclEnv) PendingTcSplice
</span><a href="GHC.Tc.Gen.Splice.html#tcPendingSplice"><span class="hs-identifier hs-var">tcPendingSplice</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683159625"><span class="hs-identifier hs-var">m_var</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[PendingRnSplice]
</span><a href="#local-6989586621683159615"><span class="hs-identifier hs-var">ps</span></a></span><span>
</span><span id="line-723"></span><span>                  </span><span class="annot"><span class="annottext">DFunInstType
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; IOEnv (Env TcGblEnv TcLclEnv) [PendingTcSplice]
-&gt; IOEnv (Env TcGblEnv TcLclEnv) [PendingTcSplice]
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PendingRnSplice] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[PendingRnSplice]
</span><a href="#local-6989586621683159615"><span class="hs-identifier hs-var">ps</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IOEnv (Env TcGblEnv TcLclEnv) [PendingTcSplice]
 -&gt; IOEnv (Env TcGblEnv TcLclEnv) [PendingTcSplice])
-&gt; IOEnv (Env TcGblEnv TcLclEnv) [PendingTcSplice]
-&gt; IOEnv (Env TcGblEnv TcLclEnv) [PendingTcSplice]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[PendingTcSplice]
-&gt; IOEnv (Env TcGblEnv TcLclEnv) [PendingTcSplice]
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-724"></span><span>
</span><span id="line-725"></span><span>       </span><span class="hs-comment">-- Notice that we don't attempt to typecheck the body</span><span>
</span><span id="line-726"></span><span>       </span><span class="hs-comment">-- of the bracket, which is in brack.</span><span>
</span><span id="line-727"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;tc_bracket done untyped&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159621"><span class="hs-identifier hs-type">expected_type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-728"></span><span>
</span><span id="line-729"></span><span>       </span><span class="hs-comment">-- Unify the overall type of the bracket with the expected result type</span><span>
</span><span id="line-730"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcWrapResultO"><span class="hs-identifier hs-type">tcWrapResultO</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#BracketOrigin"><span class="hs-identifier hs-type">BracketOrigin</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159613"><span class="hs-identifier hs-type">rn_expr</span></a></span><span>
</span><span id="line-731"></span><span>            </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsUntypedBracket"><span class="hs-identifier hs-type">HsUntypedBracket</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Hs.Expr.html#HsBracketTc"><span class="hs-identifier hs-type">HsBracketTc</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Hs.Expr.html#hsb_quote"><span class="hs-identifier hs-var">hsb_quote</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683159614"><span class="hs-identifier hs-type">brack</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Hs.Expr.html#hsb_ty"><span class="hs-identifier hs-var">hsb_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683159621"><span class="hs-identifier hs-type">expected_type</span></a></span><span>
</span><span id="line-732"></span><span>                                           </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Hs.Expr.html#hsb_wrap"><span class="hs-identifier hs-var">hsb_wrap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683159620"><span class="hs-identifier hs-type">brack_info</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Hs.Expr.html#hsb_splices"><span class="hs-identifier hs-var">hsb_splices</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683159623"><span class="hs-identifier hs-type">ps'</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-733"></span><span>                              </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#XQuote"><span class="hs-identifier hs-type">XQuote</span></a></span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Extension.html#noExtField"><span class="hs-identifier hs-type">noExtField</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-734"></span><span>                </span><span class="hs-comment">-- (XQuote noExtField): see Note [The life cycle of a TH quotation] in GHC.Hs.Expr</span><span>
</span><span id="line-735"></span><span>            </span><span class="annot"><a href="#local-6989586621683159621"><span class="hs-identifier hs-type">expected_type</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159616"><span class="hs-identifier hs-type">res_ty</span></a></span><span>
</span><span id="line-736"></span><span>
</span><span id="line-737"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-738"></span><span>
</span><span id="line-739"></span><span class="annot"><span class="hs-comment">-- | A type variable with kind * -&gt; * named &quot;m&quot;</span></span><span>
</span><span id="line-740"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#mkMetaTyVar"><span class="hs-identifier hs-type">mkMetaTyVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span>
</span><span id="line-741"></span><span id="mkMetaTyVar"><span class="annot"><span class="annottext">mkMetaTyVar :: IOEnv (Env TcGblEnv TcLclEnv) TyVar
</span><a href="GHC.Tc.Gen.Splice.html#mkMetaTyVar"><span class="hs-identifier hs-var hs-var">mkMetaTyVar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-742"></span><span>  </span><span class="annot"><span class="annottext">FastString -&gt; Type -&gt; IOEnv (Env TcGblEnv TcLclEnv) TyVar
</span><a href="GHC.Tc.Utils.TcMType.html#newNamedFlexiTyVar"><span class="hs-identifier hs-var">newNamedFlexiTyVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; FastString
</span><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;m&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Type -&gt; Type
Type -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#mkVisFunTyMany"><span class="hs-identifier hs-var">mkVisFunTyMany</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Builtin.Types.html#liftedTypeKind"><span class="hs-identifier hs-var">liftedTypeKind</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Builtin.Types.html#liftedTypeKind"><span class="hs-identifier hs-var">liftedTypeKind</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-743"></span><span>
</span><span id="line-744"></span><span>
</span><span id="line-745"></span><span class="annot"><span class="hs-comment">-- | For a type 'm', emit the constraint 'Quote m'.</span></span><span>
</span><span id="line-746"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#emitQuoteWanted"><span class="hs-identifier hs-type">emitQuoteWanted</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#EvVar"><span class="hs-identifier hs-type">EvVar</span></a></span><span>
</span><span id="line-747"></span><span id="emitQuoteWanted"><span class="annot"><span class="annottext">emitQuoteWanted :: Type -&gt; IOEnv (Env TcGblEnv TcLclEnv) TyVar
</span><a href="GHC.Tc.Gen.Splice.html#emitQuoteWanted"><span class="hs-identifier hs-var hs-var">emitQuoteWanted</span></a></span></span><span> </span><span id="local-6989586621683159638"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683159638"><span class="hs-identifier hs-var">m_var</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-keyword">do</span><span>
</span><span id="line-748"></span><span>        </span><span id="local-6989586621683159639"><span class="annot"><a href="#local-6989586621683159639"><span class="hs-identifier hs-var">quote_con</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM TyCon
</span><a href="GHC.Tc.Utils.Env.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.TH.html#quoteClassName"><span class="hs-identifier hs-var">quoteClassName</span></a></span><span>
</span><span id="line-749"></span><span>        </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#emitWantedEvVar"><span class="hs-identifier hs-type">emitWantedEvVar</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#BracketOrigin"><span class="hs-identifier hs-type">BracketOrigin</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-750"></span><span>          </span><span class="annot"><a href="GHC.Core.Type.html#mkTyConApp"><span class="hs-identifier hs-type">mkTyConApp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159639"><span class="hs-identifier hs-type">quote_con</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621683159638"><span class="hs-identifier hs-type">m_var</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-751"></span><span>
</span><span id="line-752"></span><span class="hs-comment">---------------</span><span>
</span><span id="line-753"></span><span class="hs-comment">-- | Compute the expected type of a quotation, and also the QuoteWrapper in</span><span>
</span><span id="line-754"></span><span class="hs-comment">-- the case where it is an overloaded quotation. All quotation forms are</span><span>
</span><span id="line-755"></span><span class="hs-comment">-- overloaded aprt from Variable quotations ('foo)</span><span>
</span><span id="line-756"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#brackTy"><span class="hs-identifier hs-type">brackTy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsQuote"><span class="hs-identifier hs-type">HsQuote</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#QuoteWrapper"><span class="hs-identifier hs-type">QuoteWrapper</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-757"></span><span id="brackTy"><span class="annot"><span class="annottext">brackTy :: HsQuote GhcRn -&gt; TcM (Maybe QuoteWrapper, Type)
</span><a href="GHC.Tc.Gen.Splice.html#brackTy"><span class="hs-identifier hs-var hs-var">brackTy</span></a></span></span><span> </span><span id="local-6989586621683159644"><span class="annot"><span class="annottext">HsQuote GhcRn
</span><a href="#local-6989586621683159644"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-758"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683159651"><span class="annot"><span class="annottext">mkTy :: Name -&gt; TcM (Maybe QuoteWrapper, Type)
</span><a href="#local-6989586621683159651"><span class="hs-identifier hs-var hs-var">mkTy</span></a></span></span><span> </span><span id="local-6989586621683159652"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683159652"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-759"></span><span>        </span><span class="hs-comment">-- New polymorphic type variable for the bracket</span><span>
</span><span id="line-760"></span><span>        </span><span id="local-6989586621683159653"><span class="annot"><a href="#local-6989586621683159653"><span class="hs-identifier hs-var">m_var</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">(TyVar -&gt; Type)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) TyVar
-&gt; IOEnv (Env TcGblEnv TcLclEnv) Type
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IOEnv (Env TcGblEnv TcLclEnv) TyVar
</span><a href="GHC.Tc.Gen.Splice.html#mkMetaTyVar"><span class="hs-identifier hs-var">mkMetaTyVar</span></a></span><span>
</span><span id="line-761"></span><span>        </span><span class="hs-comment">-- Emit a Quote constraint for the bracket</span><span>
</span><span id="line-762"></span><span>        </span><span id="local-6989586621683159654"><span class="annot"><a href="#local-6989586621683159654"><span class="hs-identifier hs-var">ev_var</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#emitQuoteWanted"><span class="hs-identifier hs-type">emitQuoteWanted</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159653"><span class="hs-identifier hs-type">m_var</span></a></span><span>
</span><span id="line-763"></span><span>        </span><span class="hs-comment">-- Construct the final expected type of the quote, for example</span><span>
</span><span id="line-764"></span><span>        </span><span class="hs-comment">-- m Exp or m Type</span><span>
</span><span id="line-765"></span><span>        </span><span id="local-6989586621683159655"><span class="annot"><a href="#local-6989586621683159655"><span class="hs-identifier hs-var">final_ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Type.html#mkAppTy"><span class="hs-identifier hs-type">mkAppTy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159653"><span class="hs-identifier hs-type">m_var</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Env.html#tcMetaTy"><span class="hs-identifier hs-type">tcMetaTy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159652"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-766"></span><span>        </span><span class="hs-comment">-- Return the evidence variable and metavariable to be used during</span><span>
</span><span id="line-767"></span><span>        </span><span class="hs-comment">-- desugaring.</span><span>
</span><span id="line-768"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683159656"><span class="annot"><a href="#local-6989586621683159656"><span class="hs-identifier hs-var hs-var">wrapper</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Type -&gt; QuoteWrapper
</span><a href="GHC.Tc.Types.Evidence.html#QuoteWrapper"><span class="hs-identifier hs-var">QuoteWrapper</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621683159654"><span class="hs-identifier hs-var">ev_var</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683159653"><span class="hs-identifier hs-var">m_var</span></a></span><span>
</span><span id="line-769"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="#local-6989586621683159656"><span class="hs-identifier hs-type">wrapper</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683159655"><span class="hs-identifier hs-type">final_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-770"></span><span>  </span><span class="hs-keyword">in</span><span>
</span><span id="line-771"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">HsQuote GhcRn
</span><a href="#local-6989586621683159644"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-772"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#VarBr"><span class="hs-identifier hs-type">VarBr</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe QuoteWrapper
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; (Maybe QuoteWrapper, Type))
-&gt; IOEnv (Env TcGblEnv TcLclEnv) Type
-&gt; TcM (Maybe QuoteWrapper, Type)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; IOEnv (Env TcGblEnv TcLclEnv) Type
</span><a href="GHC.Tc.Utils.Env.html#tcMetaTy"><span class="hs-identifier hs-var">tcMetaTy</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.TH.html#nameTyConName"><span class="hs-identifier hs-var">nameTyConName</span></a></span><span>
</span><span id="line-773"></span><span>                                           </span><span class="hs-comment">-- Result type is Var (not Quote-monadic)</span><span>
</span><span id="line-774"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#ExpBr"><span class="hs-identifier hs-type">ExpBr</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM (Maybe QuoteWrapper, Type)
</span><a href="#local-6989586621683159651"><span class="hs-identifier hs-var">mkTy</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.TH.html#expTyConName"><span class="hs-identifier hs-var">expTyConName</span></a></span><span>  </span><span class="hs-comment">-- Result type is m Exp</span><span>
</span><span id="line-775"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#TypBr"><span class="hs-identifier hs-type">TypBr</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM (Maybe QuoteWrapper, Type)
</span><a href="#local-6989586621683159651"><span class="hs-identifier hs-var">mkTy</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.TH.html#typeTyConName"><span class="hs-identifier hs-var">typeTyConName</span></a></span><span> </span><span class="hs-comment">-- Result type is m Type</span><span>
</span><span id="line-776"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#DecBrG"><span class="hs-identifier hs-type">DecBrG</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM (Maybe QuoteWrapper, Type)
</span><a href="#local-6989586621683159651"><span class="hs-identifier hs-var">mkTy</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.TH.html#decsTyConName"><span class="hs-identifier hs-var">decsTyConName</span></a></span><span> </span><span class="hs-comment">-- Result type is m [Dec]</span><span>
</span><span id="line-777"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#PatBr"><span class="hs-identifier hs-type">PatBr</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM (Maybe QuoteWrapper, Type)
</span><a href="#local-6989586621683159651"><span class="hs-identifier hs-var">mkTy</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.TH.html#patTyConName"><span class="hs-identifier hs-var">patTyConName</span></a></span><span>  </span><span class="hs-comment">-- Result type is m Pat</span><span>
</span><span id="line-778"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#DecBrL"><span class="hs-identifier hs-type">DecBrL</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; TcM (Maybe QuoteWrapper, Type)
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tcBrackTy: Unexpected DecBrL&quot;</span></span><span>
</span><span id="line-779"></span><span>
</span><span id="line-780"></span><span class="hs-comment">---------------</span><span>
</span><span id="line-781"></span><span class="annot"><span class="hs-comment">-- | Typechecking a pending splice from a untyped bracket</span></span><span>
</span><span id="line-782"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#tcPendingSplice"><span class="hs-identifier hs-type">tcPendingSplice</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-comment">-- Metavariable for the expected overall type of the</span><span>
</span><span id="line-783"></span><span>                          </span><span class="hs-comment">-- quotation.</span><span>
</span><span id="line-784"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Hs.Expr.html#PendingRnSplice"><span class="hs-identifier hs-type">PendingRnSplice</span></a></span><span>
</span><span id="line-785"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Expr.html#PendingTcSplice"><span class="hs-identifier hs-type">PendingTcSplice</span></a></span><span>
</span><span id="line-786"></span><span id="tcPendingSplice"><span class="annot"><span class="annottext">tcPendingSplice :: Type
-&gt; PendingRnSplice -&gt; IOEnv (Env TcGblEnv TcLclEnv) PendingTcSplice
</span><a href="GHC.Tc.Gen.Splice.html#tcPendingSplice"><span class="hs-identifier hs-var hs-var">tcPendingSplice</span></a></span></span><span> </span><span id="local-6989586621683159668"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683159668"><span class="hs-identifier hs-var">m_var</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Hs.Expr.html#PendingRnSplice"><span class="hs-identifier hs-type">PendingRnSplice</span></a></span><span> </span><span id="local-6989586621683159670"><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="#local-6989586621683159670"><span class="hs-identifier hs-var">flavour</span></a></span></span><span> </span><span id="local-6989586621683159671"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683159671"><span class="hs-identifier hs-var">splice_name</span></a></span></span><span> </span><span id="local-6989586621683159672"><span class="annot"><span class="annottext">LHsExpr GhcRn
</span><a href="#local-6989586621683159672"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-787"></span><span>  </span><span class="hs-comment">-- See Note [Typechecking Overloaded Quotes]</span><span>
</span><span id="line-788"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683159673"><span class="annot"><a href="#local-6989586621683159673"><span class="hs-identifier hs-var">meta_ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; IOEnv (Env TcGblEnv TcLclEnv) Type
</span><a href="GHC.Tc.Utils.Env.html#tcMetaTy"><span class="hs-identifier hs-var">tcMetaTy</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683159674"><span class="hs-identifier hs-var">meta_ty_name</span></a></span><span>
</span><span id="line-789"></span><span>         </span><span class="hs-comment">-- Expected type of splice, e.g. m Exp</span><span>
</span><span id="line-790"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683159675"><span class="annot"><a href="#local-6989586621683159675"><span class="hs-identifier hs-var hs-var">expected_type</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Type
</span><a href="GHC.Core.Type.html#mkAppTy"><span class="hs-identifier hs-var">mkAppTy</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683159668"><span class="hs-identifier hs-var">m_var</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683159673"><span class="hs-identifier hs-var">meta_ty</span></a></span><span>
</span><span id="line-791"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683159676"><span class="annot"><a href="#local-6989586621683159676"><span class="hs-identifier hs-var">expr'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#tcScalingUsage"><span class="hs-identifier hs-type">tcScalingUsage</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Type.html#ManyTy"><span class="hs-identifier hs-type">ManyTy</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Expr.html#tcCheckPolyExpr"><span class="hs-identifier hs-type">tcCheckPolyExpr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159672"><span class="hs-identifier hs-type">expr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159675"><span class="hs-identifier hs-type">expected_type</span></a></span><span>
</span><span id="line-792"></span><span>                  </span><span class="hs-comment">-- Scale by Many, TH lifting is currently nonlinear (#18465)</span><span>
</span><span id="line-793"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Hs.Expr.html#PendingTcSplice"><span class="hs-identifier hs-type">PendingTcSplice</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159671"><span class="hs-identifier hs-type">splice_name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159676"><span class="hs-identifier hs-type">expr'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-794"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-795"></span><span>     </span><span id="local-6989586621683159674"><span class="annot"><span class="annottext">meta_ty_name :: Name
</span><a href="#local-6989586621683159674"><span class="hs-identifier hs-var hs-var">meta_ty_name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="#local-6989586621683159670"><span class="hs-identifier hs-var">flavour</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-796"></span><span>                       </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="GHC.Hs.Expr.html#UntypedExpSplice"><span class="hs-identifier hs-var">UntypedExpSplice</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.TH.html#expTyConName"><span class="hs-identifier hs-var">expTyConName</span></a></span><span>
</span><span id="line-797"></span><span>                       </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="GHC.Hs.Expr.html#UntypedPatSplice"><span class="hs-identifier hs-var">UntypedPatSplice</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.TH.html#patTyConName"><span class="hs-identifier hs-var">patTyConName</span></a></span><span>
</span><span id="line-798"></span><span>                       </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="GHC.Hs.Expr.html#UntypedTypeSplice"><span class="hs-identifier hs-var">UntypedTypeSplice</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.TH.html#typeTyConName"><span class="hs-identifier hs-var">typeTyConName</span></a></span><span>
</span><span id="line-799"></span><span>                       </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="GHC.Hs.Expr.html#UntypedDeclSplice"><span class="hs-identifier hs-var">UntypedDeclSplice</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.TH.html#decsTyConName"><span class="hs-identifier hs-var">decsTyConName</span></a></span><span>
</span><span id="line-800"></span><span>
</span><span id="line-801"></span><span class="hs-comment">---------------</span><span>
</span><span id="line-802"></span><span class="hs-comment">-- Takes a m and tau and returns the type m (TExp tau)</span><span>
</span><span id="line-803"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#tcTExpTy"><span class="hs-identifier hs-type">tcTExpTy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>
</span><span id="line-804"></span><span id="tcTExpTy"><span class="annot"><span class="annottext">tcTExpTy :: Type -&gt; Type -&gt; IOEnv (Env TcGblEnv TcLclEnv) Type
</span><a href="GHC.Tc.Gen.Splice.html#tcTExpTy"><span class="hs-identifier hs-var hs-var">tcTExpTy</span></a></span></span><span> </span><span id="local-6989586621683159683"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683159683"><span class="hs-identifier hs-var">m_ty</span></a></span></span><span> </span><span id="local-6989586621683159684"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683159684"><span class="hs-identifier hs-var">exp_ty</span></a></span></span><span>
</span><span id="line-805"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcRn () -&gt; TcRn ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isTauTy"><span class="hs-identifier hs-var">isTauTy</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683159684"><span class="hs-identifier hs-var">exp_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcRn () -&gt; TcRn ()) -&gt; TcRn () -&gt; TcRn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; TcRn ()
</span><a href="GHC.Tc.Utils.Monad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; TcRn ()) -&gt; TcRnMessage -&gt; TcRn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-806"></span><span>          </span><span class="annot"><span class="annottext">THError -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnTHError"><span class="hs-identifier hs-var">TcRnTHError</span></a></span><span> </span><span class="annot"><span class="annottext">(THError -&gt; TcRnMessage) -&gt; THError -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TypedTHError -&gt; THError
</span><a href="GHC.Tc.Errors.Types.html#TypedTHError"><span class="hs-identifier hs-var">TypedTHError</span></a></span><span> </span><span class="annot"><span class="annottext">(TypedTHError -&gt; THError) -&gt; TypedTHError -&gt; THError
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; TypedTHError
</span><a href="GHC.Tc.Errors.Types.html#TypedTHWithPolyType"><span class="hs-identifier hs-var">TypedTHWithPolyType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683159684"><span class="hs-identifier hs-var">exp_ty</span></a></span><span>
</span><span id="line-807"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683159691"><span class="annot"><a href="#local-6989586621683159691"><span class="hs-identifier hs-var">codeCon</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM TyCon
</span><a href="GHC.Tc.Utils.Env.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.TH.html#codeTyConName"><span class="hs-identifier hs-var">codeTyConName</span></a></span><span>
</span><span id="line-808"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683159693"><span class="annot"><a href="#local-6989586621683159693"><span class="hs-identifier hs-var hs-var">rep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Type
Type -&gt; Type
</span><a href="GHC.Core.Type.html#getRuntimeRep"><span class="hs-identifier hs-var">getRuntimeRep</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683159684"><span class="hs-identifier hs-var">exp_ty</span></a></span><span>
</span><span id="line-809"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Type.html#mkTyConApp"><span class="hs-identifier hs-type">mkTyConApp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159691"><span class="hs-identifier hs-type">codeCon</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621683159683"><span class="hs-identifier hs-type">m_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683159693"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683159684"><span class="hs-identifier hs-type">exp_ty</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-810"></span><span>
</span><span id="line-811"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#quotationCtxtDoc"><span class="hs-identifier hs-type">quotationCtxtDoc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#LHsExpr"><span class="hs-identifier hs-type">LHsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span>
</span><span id="line-812"></span><span id="quotationCtxtDoc"><span class="annot"><span class="annottext">quotationCtxtDoc :: LHsExpr GhcRn -&gt; SDoc
</span><a href="GHC.Tc.Gen.Splice.html#quotationCtxtDoc"><span class="hs-identifier hs-var hs-var">quotationCtxtDoc</span></a></span></span><span> </span><span id="local-6989586621683159694"><span class="annot"><span class="annottext">LHsExpr GhcRn
</span><a href="#local-6989586621683159694"><span class="hs-identifier hs-var">br_body</span></a></span></span><span>
</span><span id="line-813"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SumArity -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;In the Template Haskell quotation&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-814"></span><span>         </span><span class="annot"><span class="annottext">SumArity
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
</span><a href="GHC.Hs.Expr.html#thTyBrackets"><span class="hs-identifier hs-var">thTyBrackets</span></a></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; SDoc) -&gt; (LHsExpr GhcRn -&gt; SDoc) -&gt; LHsExpr GhcRn -&gt; SDoc
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcRn -&gt; SDoc
GenLocated SrcSpanAnnA (HsExpr GhcRn) -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">(LHsExpr GhcRn -&gt; SDoc) -&gt; LHsExpr GhcRn -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcRn
</span><a href="#local-6989586621683159694"><span class="hs-identifier hs-var">br_body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-815"></span><span>
</span><span id="line-816"></span><span>
</span><span id="line-817"></span><span>  </span><span class="hs-comment">-- The whole of the rest of the file is the else-branch (ie stage2 only)</span><span>
</span><span id="line-818"></span><span>
</span><span id="line-819"></span><span>
</span><span id="line-820"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Splicing an expression}
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-827"></span><span>
</span><span id="line-828"></span><span class="hs-comment">-- getUntypedSpliceBody: the renamer has expanded the splice.</span><span>
</span><span id="line-829"></span><span class="hs-comment">-- Just run the finalizers that it produced, and return</span><span>
</span><span id="line-830"></span><span class="hs-comment">-- the renamed expression</span><span>
</span><span id="line-831"></span><span id="getUntypedSpliceBody"><span class="annot"><span class="annottext">getUntypedSpliceBody :: HsUntypedSpliceResult (HsExpr GhcRn) -&gt; TcM (HsExpr GhcRn)
</span><a href="GHC.Tc.Gen.Splice.html#getUntypedSpliceBody"><span class="hs-identifier hs-var hs-var">getUntypedSpliceBody</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Hs.Expr.html#HsUntypedSpliceTop"><span class="hs-identifier hs-type">HsUntypedSpliceTop</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">utsplice_result_finalizers :: forall thing. HsUntypedSpliceResult thing -&gt; ThModFinalizers
</span><a href="GHC.Hs.Expr.html#utsplice_result_finalizers"><span class="hs-identifier hs-var">utsplice_result_finalizers</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683159701"><span class="annot"><span class="annottext">ThModFinalizers
</span><a href="#local-6989586621683159701"><span class="hs-identifier hs-var">mod_finalizers</span></a></span></span><span>
</span><span id="line-832"></span><span>                                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">utsplice_result :: forall thing. HsUntypedSpliceResult thing -&gt; thing
</span><a href="GHC.Hs.Expr.html#utsplice_result"><span class="hs-identifier hs-var">utsplice_result</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683159703"><span class="annot"><span class="annottext">HsExpr GhcRn
</span><a href="#local-6989586621683159703"><span class="hs-identifier hs-var">rn_expr</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-833"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ThModFinalizers -&gt; TcRn ()
</span><a href="GHC.Tc.Utils.Monad.html#addModFinalizersWithLclEnv"><span class="hs-identifier hs-var">addModFinalizersWithLclEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ThModFinalizers
</span><a href="#local-6989586621683159701"><span class="hs-identifier hs-var">mod_finalizers</span></a></span><span>
</span><span id="line-834"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">HsExpr GhcRn -&gt; TcM (HsExpr GhcRn)
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">HsExpr GhcRn
</span><a href="#local-6989586621683159703"><span class="hs-identifier hs-var">rn_expr</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-835"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#getUntypedSpliceBody"><span class="hs-identifier hs-var">getUntypedSpliceBody</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Hs.Expr.html#HsUntypedSpliceNested"><span class="hs-identifier hs-type">HsUntypedSpliceNested</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-836"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; TcM (HsExpr GhcRn)
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tcTopUntypedSplice: invalid nested splice&quot;</span></span><span>
</span><span id="line-837"></span><span>
</span><span id="line-838"></span><span id="tcTypedSplice"><span class="annot"><span class="annottext">tcTypedSplice :: Name -&gt; LHsExpr GhcRn -&gt; ExpRhoType -&gt; TcM (HsExpr GhcTc)
</span><a href="GHC.Tc.Gen.Splice.html#tcTypedSplice"><span class="hs-identifier hs-var hs-var">tcTypedSplice</span></a></span></span><span> </span><span id="local-6989586621683159706"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683159706"><span class="hs-identifier hs-var">splice_name</span></a></span></span><span> </span><span id="local-6989586621683159707"><span class="annot"><span class="annottext">LHsExpr GhcRn
</span><a href="#local-6989586621683159707"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span id="local-6989586621683159708"><span class="annot"><span class="annottext">ExpRhoType
</span><a href="#local-6989586621683159708"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span>
</span><span id="line-839"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; TcM (HsExpr GhcTc) -&gt; TcM (HsExpr GhcTc)
forall a. SDoc -&gt; TcM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; LHsExpr GhcRn -&gt; SDoc
</span><a href="GHC.Tc.Gen.Splice.html#typedSpliceCtxtDoc"><span class="hs-identifier hs-var">typedSpliceCtxtDoc</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683159706"><span class="hs-identifier hs-var">splice_name</span></a></span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcRn
</span><a href="#local-6989586621683159707"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcM (HsExpr GhcTc) -&gt; TcM (HsExpr GhcTc))
-&gt; TcM (HsExpr GhcTc) -&gt; TcM (HsExpr GhcTc)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-840"></span><span>    </span><span class="annot"><span class="annottext">SrcSpan -&gt; TcM (HsExpr GhcTc) -&gt; TcM (HsExpr GhcTc)
forall a. SrcSpan -&gt; TcRn a -&gt; TcRn a
</span><a href="GHC.Tc.Utils.Monad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GenLocated SrcSpanAnnA (HsExpr GhcRn) -&gt; SrcSpan
forall a e. HasLoc a =&gt; GenLocated a e -&gt; SrcSpan
</span><a href="GHC.Parser.Annotation.html#getLocA"><span class="hs-identifier hs-var">getLocA</span></a></span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcRn
GenLocated SrcSpanAnnA (HsExpr GhcRn)
</span><a href="#local-6989586621683159707"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span>    </span><span class="annot"><span class="annottext">(TcM (HsExpr GhcTc) -&gt; TcM (HsExpr GhcTc))
-&gt; TcM (HsExpr GhcTc) -&gt; TcM (HsExpr GhcTc)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-841"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683159712"><span class="annot"><a href="#local-6989586621683159712"><span class="hs-identifier hs-var">stage</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM ThStage
</span><a href="GHC.Tc.Utils.Monad.html#getStage"><span class="hs-identifier hs-var">getStage</span></a></span><span>
</span><span id="line-842"></span><span>    </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683159712"><span class="hs-identifier hs-type">stage</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-843"></span><span>          </span><span class="annot"><a href="GHC.Tc.Types.TH.html#Splice"><span class="hs-identifier hs-type">Splice</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcRn -&gt; ExpRhoType -&gt; TcM (HsExpr GhcTc)
</span><a href="GHC.Tc.Gen.Splice.html#tcTopSplice"><span class="hs-identifier hs-var">tcTopSplice</span></a></span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcRn
</span><a href="#local-6989586621683159707"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">ExpRhoType
</span><a href="#local-6989586621683159708"><span class="hs-identifier hs-var">res_ty</span></a></span><span>
</span><span id="line-844"></span><span>          </span><span class="annot"><a href="GHC.Tc.Types.TH.html#Brack"><span class="hs-identifier hs-type">Brack</span></a></span><span> </span><span id="local-6989586621683159715"><span class="annot"><span class="annottext">ThStage
</span><a href="#local-6989586621683159715"><span class="hs-identifier hs-var">pop_stage</span></a></span></span><span> </span><span id="local-6989586621683159716"><span class="annot"><span class="annottext">PendingStuff
</span><a href="#local-6989586621683159716"><span class="hs-identifier hs-var">pend</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ThStage
-&gt; PendingStuff
-&gt; Name
-&gt; LHsExpr GhcRn
-&gt; ExpRhoType
-&gt; TcM (HsExpr GhcTc)
</span><a href="GHC.Tc.Gen.Splice.html#tcNestedSplice"><span class="hs-identifier hs-var">tcNestedSplice</span></a></span><span> </span><span class="annot"><span class="annottext">ThStage
</span><a href="#local-6989586621683159715"><span class="hs-identifier hs-var">pop_stage</span></a></span><span> </span><span class="annot"><span class="annottext">PendingStuff
</span><a href="#local-6989586621683159716"><span class="hs-identifier hs-var">pend</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683159706"><span class="hs-identifier hs-var">splice_name</span></a></span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcRn
</span><a href="#local-6989586621683159707"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">ExpRhoType
</span><a href="#local-6989586621683159708"><span class="hs-identifier hs-var">res_ty</span></a></span><span>
</span><span id="line-845"></span><span>          </span><span class="annot"><a href="GHC.Tc.Types.TH.html#RunSplice"><span class="hs-identifier hs-type">RunSplice</span></a></span><span> </span><span class="annot"><span class="annottext">TcRef [ForeignRef (Q ())]
</span><span class="hs-identifier">_</span></span><span>          </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-846"></span><span>            </span><span class="hs-comment">-- See Note [RunSplice ThLevel] in &quot;GHC.Tc.Types&quot;.</span><span>
</span><span id="line-847"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM (HsExpr GhcTc)
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tcSpliceExpr: attempted to typecheck a splice when &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-848"></span><span>                      </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;running another splice&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Name -&gt; LHsExpr GhcRn -&gt; SDoc
forall (p :: Pass).
OutputableBndrId p =&gt;
Maybe Name -&gt; LHsExpr (GhcPass p) -&gt; SDoc
</span><a href="GHC.Hs.Expr.html#pprTypedSplice"><span class="hs-identifier hs-var">pprTypedSplice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Maybe Name
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683159706"><span class="hs-identifier hs-var">splice_name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcRn
</span><a href="#local-6989586621683159707"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-849"></span><span>          </span><span class="annot"><span class="annottext">ThStage
</span><a href="GHC.Tc.Types.TH.html#Comp"><span class="hs-identifier hs-var">Comp</span></a></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcRn -&gt; ExpRhoType -&gt; TcM (HsExpr GhcTc)
</span><a href="GHC.Tc.Gen.Splice.html#tcTopSplice"><span class="hs-identifier hs-var">tcTopSplice</span></a></span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcRn
</span><a href="#local-6989586621683159707"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">ExpRhoType
</span><a href="#local-6989586621683159708"><span class="hs-identifier hs-var">res_ty</span></a></span><span>
</span><span id="line-850"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-851"></span><span>
</span><span id="line-852"></span><span class="hs-comment">{- Note [Collecting modFinalizers in typed splices]
   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
'qAddModFinalizer' of the @Quasi TcM@ instance adds finalizers in the local
environment (see Note [Delaying modFinalizers in untyped splices] in
GHC.Rename.Splice). Thus after executing the splice, we move the finalizers to the
finalizer list in the global environment and set them to use the current local
environment (with 'addModFinalizersWithLclEnv').

-}</span><span>
</span><span id="line-861"></span><span>
</span><span id="line-862"></span><span class="hs-comment">------------------</span><span>
</span><span id="line-863"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#tcTopSplice"><span class="hs-identifier hs-type">tcTopSplice</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#LHsExpr"><span class="hs-identifier hs-type">LHsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#ExpRhoType"><span class="hs-identifier hs-type">ExpRhoType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcTc"><span class="hs-identifier hs-type">GhcTc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-864"></span><span id="tcTopSplice"><span class="annot"><span class="annottext">tcTopSplice :: LHsExpr GhcRn -&gt; ExpRhoType -&gt; TcM (HsExpr GhcTc)
</span><a href="GHC.Tc.Gen.Splice.html#tcTopSplice"><span class="hs-identifier hs-var hs-var">tcTopSplice</span></a></span></span><span> </span><span id="local-6989586621683159722"><span class="annot"><span class="annottext">LHsExpr GhcRn
</span><a href="#local-6989586621683159722"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span id="local-6989586621683159723"><span class="annot"><span class="annottext">ExpRhoType
</span><a href="#local-6989586621683159723"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span>
</span><span id="line-865"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Typecheck the expression,</span><span>
</span><span id="line-866"></span><span>         </span><span class="hs-comment">-- making sure it has type Q (T res_ty)</span><span>
</span><span id="line-867"></span><span>         </span><span id="local-6989586621683159724"><span class="annot"><a href="#local-6989586621683159724"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ExpRhoType -&gt; IOEnv (Env TcGblEnv TcLclEnv) Type
</span><a href="GHC.Tc.Utils.TcMType.html#expTypeToType"><span class="hs-identifier hs-var">expTypeToType</span></a></span><span> </span><span class="annot"><span class="annottext">ExpRhoType
</span><a href="#local-6989586621683159723"><span class="hs-identifier hs-var">res_ty</span></a></span><span>
</span><span id="line-868"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683159726"><span class="annot"><a href="#local-6989586621683159726"><span class="hs-identifier hs-var">q_type</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Env.html#tcMetaTy"><span class="hs-identifier hs-type">tcMetaTy</span></a></span><span> </span><span class="annot"><a href="GHC.Builtin.Names.TH.html#qTyConName"><span class="hs-identifier hs-type">qTyConName</span></a></span><span>
</span><span id="line-869"></span><span>       </span><span class="hs-comment">-- Top level splices must still be of type Q (TExp a)</span><span>
</span><span id="line-870"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683159728"><span class="annot"><a href="#local-6989586621683159728"><span class="hs-identifier hs-var">meta_exp_ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#tcTExpTy"><span class="hs-identifier hs-type">tcTExpTy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159726"><span class="hs-identifier hs-type">q_type</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159724"><span class="hs-identifier hs-type">res_ty</span></a></span><span>
</span><span id="line-871"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683159729"><span class="annot"><a href="#local-6989586621683159729"><span class="hs-identifier hs-var">q_expr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#tcTopSpliceExpr"><span class="hs-identifier hs-type">tcTopSpliceExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.TH.html#Typed"><span class="hs-identifier hs-type">Typed</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-872"></span><span>                   </span><span class="annot"><a href="GHC.Tc.Gen.Expr.html#tcCheckMonoExpr"><span class="hs-identifier hs-type">tcCheckMonoExpr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159722"><span class="hs-identifier hs-type">expr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159728"><span class="hs-identifier hs-type">meta_exp_ty</span></a></span><span>
</span><span id="line-873"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683159732"><span class="annot"><a href="#local-6989586621683159732"><span class="hs-identifier hs-var">lcl_env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#getLclEnv"><span class="hs-identifier hs-type">getLclEnv</span></a></span><span>
</span><span id="line-874"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683159734"><span class="annot"><a href="#local-6989586621683159734"><span class="hs-identifier hs-var hs-var">delayed_splice</span></a></span></span><span>
</span><span id="line-875"></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcLclEnv -&gt; LHsExpr GhcRn -&gt; Type -&gt; LHsExpr GhcTc -&gt; DelayedSplice
</span><a href="GHC.Hs.Expr.html#DelayedSplice"><span class="hs-identifier hs-var">DelayedSplice</span></a></span><span> </span><span class="annot"><span class="annottext">TcLclEnv
</span><a href="#local-6989586621683159732"><span class="hs-identifier hs-var">lcl_env</span></a></span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcRn
</span><a href="#local-6989586621683159722"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683159724"><span class="hs-identifier hs-var">res_ty</span></a></span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcTc
</span><a href="#local-6989586621683159729"><span class="hs-identifier hs-var">q_expr</span></a></span><span>
</span><span id="line-876"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsTypedSplice"><span class="hs-identifier hs-type">HsTypedSplice</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159734"><span class="hs-identifier hs-type">delayed_splice</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159729"><span class="hs-identifier hs-type">q_expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-877"></span><span>
</span><span id="line-878"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-879"></span><span>
</span><span id="line-880"></span><span class="hs-comment">-------------------</span><span>
</span><span id="line-881"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#tcTopSpliceExpr"><span class="hs-identifier hs-type">tcTopSpliceExpr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TH.html#SpliceType"><span class="hs-identifier hs-type">SpliceType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#LHsExpr"><span class="hs-identifier hs-type">LHsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcTc"><span class="hs-identifier hs-type">GhcTc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#LHsExpr"><span class="hs-identifier hs-type">LHsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcTc"><span class="hs-identifier hs-type">GhcTc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-882"></span><span class="hs-comment">-- Note [How top-level splices are handled]</span><span>
</span><span id="line-883"></span><span class="hs-comment">-- Type check an expression that is the body of a top-level splice</span><span>
</span><span id="line-884"></span><span class="hs-comment">--   (the caller will compile and run it)</span><span>
</span><span id="line-885"></span><span class="hs-comment">-- Note that set the level to Splice, regardless of the original level,</span><span>
</span><span id="line-886"></span><span class="hs-comment">-- before typechecking the expression.  For example:</span><span>
</span><span id="line-887"></span><span class="hs-comment">--      f x = $( ...$(g 3) ... )</span><span>
</span><span id="line-888"></span><span class="hs-comment">-- The recursive call to tcCheckPolyExpr will simply expand the</span><span>
</span><span id="line-889"></span><span class="hs-comment">-- inner escape before dealing with the outer one</span><span>
</span><span id="line-890"></span><span>
</span><span id="line-891"></span><span id="tcTopSpliceExpr"><span class="annot"><span class="annottext">tcTopSpliceExpr :: SpliceType -&gt; TcM (LHsExpr GhcTc) -&gt; TcM (LHsExpr GhcTc)
</span><a href="GHC.Tc.Gen.Splice.html#tcTopSpliceExpr"><span class="hs-identifier hs-var hs-var">tcTopSpliceExpr</span></a></span></span><span> </span><span id="local-6989586621683159737"><span class="annot"><span class="annottext">SpliceType
</span><a href="#local-6989586621683159737"><span class="hs-identifier hs-var">isTypedSplice</span></a></span></span><span> </span><span id="local-6989586621683159738"><span class="annot"><span class="annottext">TcM (LHsExpr GhcTc)
</span><a href="#local-6989586621683159738"><span class="hs-identifier hs-var">tc_action</span></a></span></span><span>
</span><span id="line-892"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcM (LHsExpr GhcTc) -&gt; TcM (LHsExpr GhcTc)
forall r. TcM r -&gt; TcM r
</span><a href="GHC.Tc.Utils.Monad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a></span><span> </span><span class="annot"><span class="annottext">(TcM (LHsExpr GhcTc) -&gt; TcM (LHsExpr GhcTc))
-&gt; TcM (LHsExpr GhcTc) -&gt; TcM (LHsExpr GhcTc)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>  </span><span class="hs-comment">-- checkNoErrs: must not try to run the thing</span><span>
</span><span id="line-893"></span><span>                   </span><span class="hs-comment">-- if the type checker fails!</span><span>
</span><span id="line-894"></span><span>    </span><span class="annot"><span class="annottext">ThStage -&gt; TcM (LHsExpr GhcTc) -&gt; TcM (LHsExpr GhcTc)
forall a. ThStage -&gt; TcM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#setStage"><span class="hs-identifier hs-var">setStage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpliceType -&gt; ThStage
</span><a href="GHC.Tc.Types.TH.html#Splice"><span class="hs-identifier hs-var">Splice</span></a></span><span> </span><span class="annot"><span class="annottext">SpliceType
</span><a href="#local-6989586621683159737"><span class="hs-identifier hs-var">isTypedSplice</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcM (LHsExpr GhcTc) -&gt; TcM (LHsExpr GhcTc))
-&gt; TcM (LHsExpr GhcTc) -&gt; TcM (LHsExpr GhcTc)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-895"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>    </span><span class="hs-comment">-- Typecheck the expression</span><span>
</span><span id="line-896"></span><span>         </span><span class="hs-special">(</span><span id="local-6989586621683159740"><span class="annot"><a href="#local-6989586621683159740"><span class="hs-identifier hs-var">mb_expr'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683159741"><span class="annot"><a href="#local-6989586621683159741"><span class="hs-identifier hs-var">wanted</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM (GenLocated SrcSpanAnnA (HsExpr GhcTc))
-&gt; TcM
     (Maybe (GenLocated SrcSpanAnnA (HsExpr GhcTc)), WantedConstraints)
forall a. TcM a -&gt; TcM (Maybe a, WantedConstraints)
</span><a href="GHC.Tc.Utils.Monad.html#tryCaptureConstraints"><span class="hs-identifier hs-var">tryCaptureConstraints</span></a></span><span> </span><span class="annot"><span class="annottext">TcM (LHsExpr GhcTc)
TcM (GenLocated SrcSpanAnnA (HsExpr GhcTc))
</span><a href="#local-6989586621683159738"><span class="hs-identifier hs-var">tc_action</span></a></span><span>
</span><span id="line-897"></span><span>             </span><span class="hs-comment">-- If tc_action fails (perhaps because of insoluble constraints)</span><span>
</span><span id="line-898"></span><span>             </span><span class="hs-comment">-- we want to capture and report those constraints, else we may</span><span>
</span><span id="line-899"></span><span>             </span><span class="hs-comment">-- just get a silent failure (#20179). Hence the 'try' part.</span><span>
</span><span id="line-900"></span><span>
</span><span id="line-901"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683159743"><span class="annot"><a href="#local-6989586621683159743"><span class="hs-identifier hs-var">const_binds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#simplifyTop"><span class="hs-identifier hs-type">simplifyTop</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159741"><span class="hs-identifier hs-type">wanted</span></a></span><span>
</span><span id="line-902"></span><span>
</span><span id="line-903"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683159740"><span class="hs-identifier hs-type">mb_expr'</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-904"></span><span>            </span><span class="annot"><span class="annottext">Maybe (GenLocated SrcSpanAnnA (HsExpr GhcTc))
</span><span class="hs-identifier hs-var">Nothing</span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcM (LHsExpr GhcTc)
forall env a. IOEnv env a
</span><a href="GHC.Data.IOEnv.html#failM"><span class="hs-identifier hs-var">failM</span></a></span><span>   </span><span class="hs-comment">-- In this case simplifyTop should have</span><span>
</span><span id="line-905"></span><span>                                  </span><span class="hs-comment">-- reported some errors</span><span>
</span><span id="line-906"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683159746"><span class="annot"><span class="annottext">GenLocated SrcSpanAnnA (HsExpr GhcTc)
</span><a href="#local-6989586621683159746"><span class="hs-identifier hs-var">expr'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcTc -&gt; TcM (LHsExpr GhcTc)
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(LHsExpr GhcTc -&gt; TcM (LHsExpr GhcTc))
-&gt; LHsExpr GhcTc -&gt; TcM (LHsExpr GhcTc)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TcEvBinds -&gt; LHsExpr GhcTc -&gt; LHsExpr GhcTc
</span><a href="GHC.Hs.Utils.html#mkHsDictLet"><span class="hs-identifier hs-var">mkHsDictLet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bag EvBind -&gt; TcEvBinds
</span><a href="GHC.Tc.Types.Evidence.html#EvBinds"><span class="hs-identifier hs-var">EvBinds</span></a></span><span> </span><span class="annot"><span class="annottext">Bag EvBind
</span><a href="#local-6989586621683159743"><span class="hs-identifier hs-var">const_binds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcTc
GenLocated SrcSpanAnnA (HsExpr GhcTc)
</span><a href="#local-6989586621683159746"><span class="hs-identifier hs-var">expr'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-907"></span><span>
</span><span id="line-908"></span><span class="hs-comment">------------------</span><span>
</span><span id="line-909"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#tcNestedSplice"><span class="hs-identifier hs-type">tcNestedSplice</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TH.html#ThStage"><span class="hs-identifier hs-type">ThStage</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TH.html#PendingStuff"><span class="hs-identifier hs-type">PendingStuff</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span>
</span><span id="line-910"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#LHsExpr"><span class="hs-identifier hs-type">LHsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#ExpRhoType"><span class="hs-identifier hs-type">ExpRhoType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcTc"><span class="hs-identifier hs-type">GhcTc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-911"></span><span>    </span><span class="hs-comment">-- See Note [How brackets and nested splices are handled]</span><span>
</span><span id="line-912"></span><span>    </span><span class="hs-comment">-- A splice inside brackets</span><span>
</span><span id="line-913"></span><span id="tcNestedSplice"><span class="annot"><span class="annottext">tcNestedSplice :: ThStage
-&gt; PendingStuff
-&gt; Name
-&gt; LHsExpr GhcRn
-&gt; ExpRhoType
-&gt; TcM (HsExpr GhcTc)
</span><a href="GHC.Tc.Gen.Splice.html#tcNestedSplice"><span class="hs-identifier hs-var hs-var">tcNestedSplice</span></a></span></span><span> </span><span id="local-6989586621683159749"><span class="annot"><span class="annottext">ThStage
</span><a href="#local-6989586621683159749"><span class="hs-identifier hs-var">pop_stage</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.TH.html#TcPending"><span class="hs-identifier hs-type">TcPending</span></a></span><span> </span><span id="local-6989586621683159750"><span class="annot"><span class="annottext">IORef [PendingTcSplice]
</span><a href="#local-6989586621683159750"><span class="hs-identifier hs-var">ps_var</span></a></span></span><span> </span><span id="local-6989586621683159751"><span class="annot"><span class="annottext">TcRef WantedConstraints
</span><a href="#local-6989586621683159751"><span class="hs-identifier hs-var">lie_var</span></a></span></span><span> </span><span id="local-6989586621683159752"><span class="annot"><span class="annottext">q :: QuoteWrapper
</span><a href="#local-6989586621683159752"><span class="hs-identifier hs-var">q</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#QuoteWrapper"><span class="hs-identifier hs-type">QuoteWrapper</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683159753"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683159753"><span class="hs-identifier hs-var">m_var</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621683159754"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683159754"><span class="hs-identifier hs-var">splice_name</span></a></span></span><span> </span><span id="local-6989586621683159755"><span class="annot"><span class="annottext">LHsExpr GhcRn
</span><a href="#local-6989586621683159755"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span id="local-6989586621683159756"><span class="annot"><span class="annottext">ExpRhoType
</span><a href="#local-6989586621683159756"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span>
</span><span id="line-914"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683159757"><span class="annot"><a href="#local-6989586621683159757"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ExpRhoType -&gt; IOEnv (Env TcGblEnv TcLclEnv) Type
</span><a href="GHC.Tc.Utils.TcMType.html#expTypeToType"><span class="hs-identifier hs-var">expTypeToType</span></a></span><span> </span><span class="annot"><span class="annottext">ExpRhoType
</span><a href="#local-6989586621683159756"><span class="hs-identifier hs-var">res_ty</span></a></span><span>
</span><span id="line-915"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683159758"><span class="annot"><a href="#local-6989586621683159758"><span class="hs-identifier hs-var hs-var">rep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Type
Type -&gt; Type
</span><a href="GHC.Core.Type.html#getRuntimeRep"><span class="hs-identifier hs-var">getRuntimeRep</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683159757"><span class="hs-identifier hs-var">res_ty</span></a></span><span>
</span><span id="line-916"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683159759"><span class="annot"><a href="#local-6989586621683159759"><span class="hs-identifier hs-var">meta_exp_ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#tcTExpTy"><span class="hs-identifier hs-type">tcTExpTy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159753"><span class="hs-identifier hs-type">m_var</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159757"><span class="hs-identifier hs-type">res_ty</span></a></span><span>
</span><span id="line-917"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683159760"><span class="annot"><a href="#local-6989586621683159760"><span class="hs-identifier hs-var">expr'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#setStage"><span class="hs-identifier hs-type">setStage</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159749"><span class="hs-identifier hs-type">pop_stage</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-918"></span><span>                  </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#setConstraintVar"><span class="hs-identifier hs-type">setConstraintVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159751"><span class="hs-identifier hs-type">lie_var</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-919"></span><span>                  </span><span class="annot"><a href="GHC.Tc.Gen.Expr.html#tcCheckMonoExpr"><span class="hs-identifier hs-type">tcCheckMonoExpr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159755"><span class="hs-identifier hs-type">expr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159759"><span class="hs-identifier hs-type">meta_exp_ty</span></a></span><span>
</span><span id="line-920"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683159762"><span class="annot"><a href="#local-6989586621683159762"><span class="hs-identifier hs-var">untype_code</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Env.html#tcLookupId"><span class="hs-identifier hs-type">tcLookupId</span></a></span><span> </span><span class="annot"><a href="GHC.Builtin.Names.TH.html#unTypeCodeName"><span class="hs-identifier hs-type">unTypeCodeName</span></a></span><span>
</span><span id="line-921"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683159764"><span class="annot"><a href="#local-6989586621683159764"><span class="hs-identifier hs-var hs-var">expr''</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcTc -&gt; LHsExpr GhcTc -&gt; LHsExpr GhcTc
forall (id :: Pass).
LHsExpr (GhcPass id)
-&gt; LHsExpr (GhcPass id) -&gt; LHsExpr (GhcPass id)
</span><a href="GHC.Hs.Utils.html#mkHsApp"><span class="hs-identifier hs-var">mkHsApp</span></a></span><span>
</span><span id="line-922"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HsWrapper -&gt; LHsExpr GhcTc -&gt; LHsExpr GhcTc
</span><a href="GHC.Hs.Utils.html#mkLHsWrap"><span class="hs-identifier hs-var">mkLHsWrap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QuoteWrapper -&gt; HsWrapper
</span><a href="GHC.Tc.Types.Evidence.html#applyQuoteWrapper"><span class="hs-identifier hs-var">applyQuoteWrapper</span></a></span><span> </span><span class="annot"><span class="annottext">QuoteWrapper
</span><a href="#local-6989586621683159752"><span class="hs-identifier hs-var">q</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-923"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; [Type] -&gt; LHsExpr GhcTc
</span><a href="GHC.Hs.Utils.html#nlHsTyApp"><span class="hs-identifier hs-var">nlHsTyApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621683159762"><span class="hs-identifier hs-var">untype_code</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683159758"><span class="hs-identifier hs-var">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683159757"><span class="hs-identifier hs-var">res_ty</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcTc
</span><a href="#local-6989586621683159760"><span class="hs-identifier hs-var">expr'</span></a></span><span>
</span><span id="line-924"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683159765"><span class="annot"><a href="#local-6989586621683159765"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Data.IOEnv.html#readMutVar"><span class="hs-identifier hs-type">readMutVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159750"><span class="hs-identifier hs-type">ps_var</span></a></span><span>
</span><span id="line-925"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Data.IOEnv.html#writeMutVar"><span class="hs-identifier hs-type">writeMutVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159750"><span class="hs-identifier hs-type">ps_var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Hs.Expr.html#PendingTcSplice"><span class="hs-identifier hs-type">PendingTcSplice</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159754"><span class="hs-identifier hs-type">splice_name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159764"><span class="hs-identifier hs-type">expr''</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="#local-6989586621683159765"><span class="hs-identifier hs-type">ps</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-926"></span><span>
</span><span id="line-927"></span><span>       </span><span class="hs-comment">-- The returned expression is ignored; it's in the pending splices</span><span>
</span><span id="line-928"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#stubNestedSplice"><span class="hs-identifier hs-type">stubNestedSplice</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-929"></span><span>
</span><span id="line-930"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#tcNestedSplice"><span class="hs-identifier hs-var">tcNestedSplice</span></a></span><span> </span><span class="annot"><span class="annottext">ThStage
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">PendingStuff
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683159768"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683159768"><span class="hs-identifier hs-var">splice_name</span></a></span></span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcRn
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ExpRhoType
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-931"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM (HsExpr GhcTc)
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tcNestedSplice: rename stage found&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683159768"><span class="hs-identifier hs-var">splice_name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-932"></span><span>
</span><span id="line-933"></span><span>
</span><span id="line-934"></span><span class="hs-comment">------------------</span><span>
</span><span id="line-935"></span><span class="hs-comment">-- This is called in the zonker</span><span>
</span><span id="line-936"></span><span class="hs-comment">-- See Note [Running typed splices in the zonker]</span><span>
</span><span id="line-937"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runTopSplice"><span class="hs-identifier hs-type">runTopSplice</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Hs.Expr.html#DelayedSplice"><span class="hs-identifier hs-type">DelayedSplice</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcTc"><span class="hs-identifier hs-type">GhcTc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-938"></span><span id="runTopSplice"><span class="annot"><span class="annottext">runTopSplice :: DelayedSplice -&gt; TcM (HsExpr GhcTc)
</span><a href="GHC.Tc.Gen.Splice.html#runTopSplice"><span class="hs-identifier hs-var hs-var">runTopSplice</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Hs.Expr.html#DelayedSplice"><span class="hs-identifier hs-type">DelayedSplice</span></a></span><span> </span><span id="local-6989586621683159769"><span class="annot"><span class="annottext">TcLclEnv
</span><a href="#local-6989586621683159769"><span class="hs-identifier hs-var">lcl_env</span></a></span></span><span> </span><span id="local-6989586621683159770"><span class="annot"><span class="annottext">LHsExpr GhcRn
</span><a href="#local-6989586621683159770"><span class="hs-identifier hs-var">orig_expr</span></a></span></span><span> </span><span id="local-6989586621683159771"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683159771"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span> </span><span id="local-6989586621683159772"><span class="annot"><span class="annottext">LHsExpr GhcTc
</span><a href="#local-6989586621683159772"><span class="hs-identifier hs-var">q_expr</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-939"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcLclEnv -&gt; TcM (HsExpr GhcTc) -&gt; TcM (HsExpr GhcTc)
forall gbl a.
TcLclEnv -&gt; TcRnIf gbl TcLclEnv a -&gt; TcRnIf gbl TcLclEnv a
</span><a href="GHC.Tc.Utils.Monad.html#restoreLclEnv"><span class="hs-identifier hs-var">restoreLclEnv</span></a></span><span> </span><span class="annot"><span class="annottext">TcLclEnv
</span><a href="#local-6989586621683159769"><span class="hs-identifier hs-var">lcl_env</span></a></span><span> </span><span class="annot"><span class="annottext">(TcM (HsExpr GhcTc) -&gt; TcM (HsExpr GhcTc))
-&gt; TcM (HsExpr GhcTc) -&gt; TcM (HsExpr GhcTc)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-940"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683159774"><span class="annot"><a href="#local-6989586621683159774"><span class="hs-identifier hs-var">zonked_ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ZonkM Type -&gt; IOEnv (Env TcGblEnv TcLclEnv) Type
forall a. ZonkM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#liftZonkM"><span class="hs-identifier hs-var">liftZonkM</span></a></span><span> </span><span class="annot"><span class="annottext">(ZonkM Type -&gt; IOEnv (Env TcGblEnv TcLclEnv) Type)
-&gt; ZonkM Type -&gt; IOEnv (Env TcGblEnv TcLclEnv) Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; ZonkM Type
</span><a href="GHC.Tc.Zonk.TcType.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683159771"><span class="hs-identifier hs-var">res_ty</span></a></span><span>
</span><span id="line-941"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683159777"><span class="annot"><a href="#local-6989586621683159777"><span class="hs-identifier hs-var">zonked_q_expr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Zonk.Type.html#zonkTopLExpr"><span class="hs-identifier hs-type">zonkTopLExpr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159772"><span class="hs-identifier hs-type">q_expr</span></a></span><span>
</span><span id="line-942"></span><span>        </span><span class="hs-comment">-- See Note [Collecting modFinalizers in typed splices].</span><span>
</span><span id="line-943"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683159779"><span class="annot"><a href="#local-6989586621683159779"><span class="hs-identifier hs-var">modfinalizers_ref</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TcRef.html#newTcRef"><span class="hs-identifier hs-type">newTcRef</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-944"></span><span>         </span><span class="hs-comment">-- Run the expression</span><span>
</span><span id="line-945"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683159781"><span class="annot"><a href="#local-6989586621683159781"><span class="hs-identifier hs-var">expr2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#setStage"><span class="hs-identifier hs-type">setStage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.TH.html#RunSplice"><span class="hs-identifier hs-type">RunSplice</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159779"><span class="hs-identifier hs-type">modfinalizers_ref</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-946"></span><span>                    </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runMetaE"><span class="hs-identifier hs-type">runMetaE</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159777"><span class="hs-identifier hs-type">zonked_q_expr</span></a></span><span>
</span><span id="line-947"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683159782"><span class="annot"><a href="#local-6989586621683159782"><span class="hs-identifier hs-var">mod_finalizers</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TcRef.html#readTcRef"><span class="hs-identifier hs-type">readTcRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159779"><span class="hs-identifier hs-type">modfinalizers_ref</span></a></span><span>
</span><span id="line-948"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#addModFinalizersWithLclEnv"><span class="hs-identifier hs-type">addModFinalizersWithLclEnv</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Hs.Expr.html#ThModFinalizers"><span class="hs-identifier hs-type">ThModFinalizers</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159782"><span class="hs-identifier hs-type">mod_finalizers</span></a></span><span>
</span><span id="line-949"></span><span>       </span><span class="hs-comment">-- We use orig_expr here and not q_expr when tracing as a call to</span><span>
</span><span id="line-950"></span><span>       </span><span class="hs-comment">-- unsafeCodeCoerce is added to the original expression by the</span><span>
</span><span id="line-951"></span><span>       </span><span class="hs-comment">-- typechecker when typed quotes are type checked.</span><span>
</span><span id="line-952"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Rename.Splice.html#traceSplice"><span class="hs-identifier hs-type">traceSplice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Rename.Splice.html#SpliceInfo"><span class="hs-identifier hs-type">SpliceInfo</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Rename.Splice.html#spliceDescription"><span class="hs-identifier hs-var">spliceDescription</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-string">&quot;expression&quot;</span></span><span>
</span><span id="line-953"></span><span>                                 </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Rename.Splice.html#spliceIsDecl"><span class="hs-identifier hs-var">spliceIsDecl</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span>
</span><span id="line-954"></span><span>                                 </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Rename.Splice.html#spliceSource"><span class="hs-identifier hs-var">spliceSource</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="#local-6989586621683159770"><span class="hs-identifier hs-type">orig_expr</span></a></span><span>
</span><span id="line-955"></span><span>                                 </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Rename.Splice.html#spliceGenerated"><span class="hs-identifier hs-var">spliceGenerated</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159781"><span class="hs-identifier hs-type">expr2</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-956"></span><span>        </span><span class="hs-comment">-- Rename and typecheck the spliced-in expression,</span><span>
</span><span id="line-957"></span><span>        </span><span class="hs-comment">-- making sure it has type res_ty</span><span>
</span><span id="line-958"></span><span>        </span><span class="hs-comment">-- These steps should never fail; this is a *typed* splice</span><span>
</span><span id="line-959"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683159790"><span class="annot"><a href="#local-6989586621683159790"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683159791"><span class="annot"><a href="#local-6989586621683159791"><span class="hs-identifier hs-var">wcs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-960"></span><span>            </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#captureConstraints"><span class="hs-identifier hs-type">captureConstraints</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-961"></span><span>              </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#addErrCtxt"><span class="hs-identifier hs-type">addErrCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#spliceResultDoc"><span class="hs-identifier hs-type">spliceResultDoc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159777"><span class="hs-identifier hs-type">zonked_q_expr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-962"></span><span>                </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683159794"><span class="annot"><a href="#local-6989586621683159794"><span class="hs-identifier hs-var">exp3</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683159795"><span class="annot"><a href="#local-6989586621683159795"><span class="hs-identifier hs-var">_fvs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Rename.Expr.html#rnLExpr"><span class="hs-identifier hs-type">rnLExpr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159781"><span class="hs-identifier hs-type">expr2</span></a></span><span>
</span><span id="line-963"></span><span>                </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Expr.html#tcCheckMonoExpr"><span class="hs-identifier hs-type">tcCheckMonoExpr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159794"><span class="hs-identifier hs-type">exp3</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159774"><span class="hs-identifier hs-type">zonked_ty</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-964"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683159797"><span class="annot"><a href="#local-6989586621683159797"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#simplifyTop"><span class="hs-identifier hs-type">simplifyTop</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159791"><span class="hs-identifier hs-type">wcs</span></a></span><span>
</span><span id="line-965"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html#unLoc"><span class="hs-identifier hs-type">unLoc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Hs.Utils.html#mkHsDictLet"><span class="hs-identifier hs-type">mkHsDictLet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#EvBinds"><span class="hs-identifier hs-type">EvBinds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159797"><span class="hs-identifier hs-type">ev</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683159790"><span class="hs-identifier hs-type">res</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-966"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-967"></span><span>
</span><span id="line-968"></span><span>
</span><span id="line-969"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *

*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-976"></span><span>
</span><span id="line-977"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#typedSpliceCtxtDoc"><span class="hs-identifier hs-type">typedSpliceCtxtDoc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Hs.Expr.html#SplicePointName"><span class="hs-identifier hs-type">SplicePointName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#LHsExpr"><span class="hs-identifier hs-type">LHsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span>
</span><span id="line-978"></span><span id="typedSpliceCtxtDoc"><span class="annot"><span class="annottext">typedSpliceCtxtDoc :: Name -&gt; LHsExpr GhcRn -&gt; SDoc
</span><a href="GHC.Tc.Gen.Splice.html#typedSpliceCtxtDoc"><span class="hs-identifier hs-var hs-var">typedSpliceCtxtDoc</span></a></span></span><span> </span><span id="local-6989586621683159799"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683159799"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621683159800"><span class="annot"><span class="annottext">LHsExpr GhcRn
</span><a href="#local-6989586621683159800"><span class="hs-identifier hs-var">splice</span></a></span></span><span>
</span><span id="line-979"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SumArity -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;In the Template Haskell splice&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-980"></span><span>         </span><span class="annot"><span class="annottext">SumArity
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Name -&gt; LHsExpr GhcRn -&gt; SDoc
forall (p :: Pass).
OutputableBndrId p =&gt;
Maybe Name -&gt; LHsExpr (GhcPass p) -&gt; SDoc
</span><a href="GHC.Hs.Expr.html#pprTypedSplice"><span class="hs-identifier hs-var">pprTypedSplice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Maybe Name
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683159799"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcRn
</span><a href="#local-6989586621683159800"><span class="hs-identifier hs-var">splice</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-981"></span><span>
</span><span id="line-982"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#spliceResultDoc"><span class="hs-identifier hs-type">spliceResultDoc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#LHsExpr"><span class="hs-identifier hs-type">LHsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcTc"><span class="hs-identifier hs-type">GhcTc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span>
</span><span id="line-983"></span><span id="spliceResultDoc"><span class="annot"><span class="annottext">spliceResultDoc :: LHsExpr GhcTc -&gt; SDoc
</span><a href="GHC.Tc.Gen.Splice.html#spliceResultDoc"><span class="hs-identifier hs-var hs-var">spliceResultDoc</span></a></span></span><span> </span><span id="local-6989586621683159801"><span class="annot"><span class="annottext">LHsExpr GhcTc
</span><a href="#local-6989586621683159801"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-984"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;In the result of the splice:&quot;</span></span><span>
</span><span id="line-985"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SumArity -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a></span><span> </span><span class="annot"><span class="annottext">SumArity
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;$$&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">GenLocated SrcSpanAnnA (HsExpr GhcTc) -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcTc
GenLocated SrcSpanAnnA (HsExpr GhcTc)
</span><a href="#local-6989586621683159801"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-986"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;To see what the splice expanded to, use -ddump-splices&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-987"></span><span>
</span><span id="line-988"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#stubNestedSplice"><span class="hs-identifier hs-type">stubNestedSplice</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcTc"><span class="hs-identifier hs-type">GhcTc</span></a></span><span>
</span><span id="line-989"></span><span class="hs-comment">-- Used when we need a (LHsExpr GhcTc) that we are never going</span><span>
</span><span id="line-990"></span><span class="hs-comment">-- to look at.  We could use &quot;panic&quot; but that's confusing if we ever</span><span>
</span><span id="line-991"></span><span class="hs-comment">-- do a debug-print.  The warning is because this should never happen</span><span>
</span><span id="line-992"></span><span class="hs-comment">-- /except/ when doing debug prints.</span><span>
</span><span id="line-993"></span><span id="stubNestedSplice"><span class="annot"><span class="annottext">stubNestedSplice :: HsExpr GhcTc
</span><a href="GHC.Tc.Gen.Splice.html#stubNestedSplice"><span class="hs-identifier hs-var hs-var">stubNestedSplice</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; String -&gt; SDoc -&gt; HsExpr GhcTc -&gt; HsExpr GhcTc
forall a. HasCallStack =&gt; Bool -&gt; String -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Trace.html#warnPprTrace"><span class="hs-identifier hs-var">warnPprTrace</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;stubNestedSplice&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsOutput doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a></span><span> </span><span class="annot"><span class="annottext">(HsExpr GhcTc -&gt; HsExpr GhcTc) -&gt; HsExpr GhcTc -&gt; HsExpr GhcTc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-994"></span><span>                   </span><span class="annot"><span class="annottext">XLitE GhcTc -&gt; HsLit GhcTc -&gt; HsExpr GhcTc
forall p. XLitE p -&gt; HsLit p -&gt; HsExpr p
</span><a href="Language.Haskell.Syntax.Expr.html#HsLit"><span class="hs-identifier hs-var">HsLit</span></a></span><span> </span><span class="annot"><span class="annottext">XLitE GhcTc
NoExtField
</span><a href="Language.Haskell.Syntax.Extension.html#noExtField"><span class="hs-identifier hs-var">noExtField</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; HsLit GhcTc
forall (p :: Pass). String -&gt; HsLit (GhcPass p)
</span><a href="GHC.Hs.Utils.html#mkHsString"><span class="hs-identifier hs-var">mkHsString</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;stubNestedSplice&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-995"></span><span>
</span><span id="line-996"></span><span>
</span><span id="line-997"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Annotations
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-1004"></span><span>
</span><span id="line-1005"></span><span id="runAnnotation"><span class="annot"><span class="annottext">runAnnotation :: CoreAnnTarget -&gt; LHsExpr GhcRn -&gt; TcM Annotation
</span><a href="GHC.Tc.Gen.Splice.html#runAnnotation"><span class="hs-identifier hs-var hs-var">runAnnotation</span></a></span></span><span> </span><span id="local-6989586621683159809"><span class="annot"><span class="annottext">CoreAnnTarget
</span><a href="#local-6989586621683159809"><span class="hs-identifier hs-var">target</span></a></span></span><span> </span><span id="local-6989586621683159810"><span class="annot"><span class="annottext">LHsExpr GhcRn
</span><a href="#local-6989586621683159810"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1006"></span><span>    </span><span class="hs-comment">-- Find the classes we want instances for in order to call toAnnotationWrapper</span><span>
</span><span id="line-1007"></span><span>    </span><span id="local-6989586621683159811"><span class="annot"><a href="#local-6989586621683159811"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcRn SrcSpan
</span><a href="GHC.Tc.Utils.Monad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a></span><span>
</span><span id="line-1008"></span><span>    </span><span id="local-6989586621683159813"><span class="annot"><a href="#local-6989586621683159813"><span class="hs-identifier hs-var">data_class</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Env.html#tcLookupClass"><span class="hs-identifier hs-type">tcLookupClass</span></a></span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html#dataClassName"><span class="hs-identifier hs-type">dataClassName</span></a></span><span>
</span><span id="line-1009"></span><span>    </span><span id="local-6989586621683159816"><span class="annot"><a href="#local-6989586621683159816"><span class="hs-identifier hs-var">to_annotation_wrapper_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Env.html#tcLookupId"><span class="hs-identifier hs-type">tcLookupId</span></a></span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html#toAnnotationWrapperName"><span class="hs-identifier hs-type">toAnnotationWrapperName</span></a></span><span>
</span><span id="line-1010"></span><span>
</span><span id="line-1011"></span><span>    </span><span class="hs-comment">-- Check the instances we require live in another module (we want to execute it..)</span><span>
</span><span id="line-1012"></span><span>    </span><span class="hs-comment">-- and check identifiers live in other modules using TH stage checks. tcSimplifyStagedExpr</span><span>
</span><span id="line-1013"></span><span>    </span><span class="hs-comment">-- also resolves the LIE constraints to detect e.g. instance ambiguity</span><span>
</span><span id="line-1014"></span><span>    </span><span id="local-6989586621683159818"><span class="annot"><a href="#local-6989586621683159818"><span class="hs-identifier hs-var">zonked_wrapped_expr'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Zonk.Type.html#zonkTopLExpr"><span class="hs-identifier hs-type">zonkTopLExpr</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">=&lt;&lt;</span></span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#tcTopSpliceExpr"><span class="hs-identifier hs-type">tcTopSpliceExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.TH.html#Untyped"><span class="hs-identifier hs-type">Untyped</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-1015"></span><span>           </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683159821"><span class="annot"><a href="#local-6989586621683159821"><span class="hs-identifier hs-var">expr'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683159822"><span class="annot"><a href="#local-6989586621683159822"><span class="hs-identifier hs-var">expr_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Expr.html#tcInferRhoNC"><span class="hs-identifier hs-type">tcInferRhoNC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159810"><span class="hs-identifier hs-type">expr</span></a></span><span>
</span><span id="line-1016"></span><span>                </span><span class="hs-comment">-- We manually wrap the typechecked expression in a call to toAnnotationWrapper</span><span>
</span><span id="line-1017"></span><span>                </span><span class="hs-comment">-- By instantiating the call &gt;here&lt; it gets registered in the</span><span>
</span><span id="line-1018"></span><span>                </span><span class="hs-comment">-- LIE consulted by tcTopSpliceExpr</span><span>
</span><span id="line-1019"></span><span>                </span><span class="hs-comment">-- and hence ensures the appropriate dictionary is bound by const_binds</span><span>
</span><span id="line-1020"></span><span>              </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683159823"><span class="annot"><a href="#local-6989586621683159823"><span class="hs-identifier hs-var">wrapper</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Instantiate.html#instCall"><span class="hs-identifier hs-type">instCall</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#AnnOrigin"><span class="hs-identifier hs-type">AnnOrigin</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621683159822"><span class="hs-identifier hs-type">expr_ty</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Predicate.html#mkClassPred"><span class="hs-identifier hs-type">mkClassPred</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159813"><span class="hs-identifier hs-type">data_class</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621683159822"><span class="hs-identifier hs-type">expr_ty</span></a></span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-1021"></span><span>              </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683159827"><span class="annot"><a href="#local-6989586621683159827"><span class="hs-identifier hs-var hs-var">loc'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SrcSpan -&gt; SrcSpanAnnA
forall e. HasAnnotation e =&gt; SrcSpan -&gt; e
</span><a href="GHC.Parser.Annotation.html#noAnnSrcSpan"><span class="hs-identifier hs-var">noAnnSrcSpan</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621683159811"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-1022"></span><span>              </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683159829"><span class="annot"><a href="#local-6989586621683159829"><span class="hs-identifier hs-var hs-var">specialised_to_annotation_wrapper_expr</span></a></span></span><span>
</span><span id="line-1023"></span><span>                      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SrcSpanAnnA
-&gt; HsExpr GhcTc -&gt; GenLocated SrcSpanAnnA (HsExpr GhcTc)
forall l e. l -&gt; e -&gt; GenLocated l e
</span><a href="GHC.Types.SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpanAnnA
</span><a href="#local-6989586621683159827"><span class="hs-identifier hs-var">loc'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HsWrapper -&gt; HsExpr GhcTc -&gt; HsExpr GhcTc
</span><a href="GHC.Hs.Utils.html#mkHsWrap"><span class="hs-identifier hs-var">mkHsWrap</span></a></span><span> </span><span class="annot"><span class="annottext">HsWrapper
</span><a href="#local-6989586621683159823"><span class="hs-identifier hs-var">wrapper</span></a></span><span>
</span><span id="line-1024"></span><span>                                 </span><span class="hs-special">(</span><span class="annot"><span class="annottext">XVar GhcTc -&gt; LIdP GhcTc -&gt; HsExpr GhcTc
forall p. XVar p -&gt; LIdP p -&gt; HsExpr p
</span><a href="Language.Haskell.Syntax.Expr.html#HsVar"><span class="hs-identifier hs-var">HsVar</span></a></span><span> </span><span class="annot"><span class="annottext">XVar GhcTc
NoExtField
</span><a href="Language.Haskell.Syntax.Extension.html#noExtField"><span class="hs-identifier hs-var">noExtField</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SrcSpanAnnN -&gt; TyVar -&gt; GenLocated SrcSpanAnnN TyVar
forall l e. l -&gt; e -&gt; GenLocated l e
</span><a href="GHC.Types.SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SrcSpan -&gt; SrcSpanAnnN
forall e. HasAnnotation e =&gt; SrcSpan -&gt; e
</span><a href="GHC.Parser.Annotation.html#noAnnSrcSpan"><span class="hs-identifier hs-var">noAnnSrcSpan</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621683159811"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621683159816"><span class="hs-identifier hs-var">to_annotation_wrapper_id</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1025"></span><span>              </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.SrcLoc.html#L"><span class="hs-identifier hs-type">L</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159827"><span class="hs-identifier hs-type">loc'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsApp"><span class="hs-identifier hs-type">HsApp</span></a></span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Extension.html#noExtField"><span class="hs-identifier hs-type">noExtField</span></a></span><span>
</span><span id="line-1026"></span><span>                                </span><span class="annot"><a href="#local-6989586621683159829"><span class="hs-identifier hs-type">specialised_to_annotation_wrapper_expr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159821"><span class="hs-identifier hs-type">expr'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1027"></span><span>                                </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1028"></span><span>
</span><span id="line-1029"></span><span>    </span><span class="hs-comment">-- Run the appropriately wrapped expression to get the value of</span><span>
</span><span id="line-1030"></span><span>    </span><span class="hs-comment">-- the annotation and its dictionaries. The return value is of</span><span>
</span><span id="line-1031"></span><span>    </span><span class="hs-comment">-- type AnnotationWrapper by construction, so this conversion is</span><span>
</span><span id="line-1032"></span><span>    </span><span class="hs-comment">-- safe</span><span>
</span><span id="line-1033"></span><span>    </span><span id="local-6989586621683159834"><span class="annot"><a href="#local-6989586621683159834"><span class="hs-identifier hs-var">serialized</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runMetaAW"><span class="hs-identifier hs-type">runMetaAW</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159818"><span class="hs-identifier hs-type">zonked_wrapped_expr'</span></a></span><span>
</span><span id="line-1034"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="GHC.Types.Annotations.html#Annotation"><span class="hs-identifier hs-type">Annotation</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1035"></span><span>               </span><span class="annot"><a href="GHC.Types.Annotations.html#ann_target"><span class="hs-identifier hs-var">ann_target</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683159809"><span class="hs-identifier hs-type">target</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1036"></span><span>               </span><span class="annot"><a href="GHC.Types.Annotations.html#ann_value"><span class="hs-identifier hs-var">ann_value</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683159834"><span class="hs-identifier hs-type">serialized</span></a></span><span>
</span><span id="line-1037"></span><span>           </span><span class="hs-special">}</span><span>
</span><span id="line-1038"></span><span>
</span><span id="line-1039"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#convertAnnotationWrapper"><span class="hs-identifier hs-type">convertAnnotationWrapper</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html#ForeignHValue"><span class="hs-identifier hs-type">ForeignHValue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="../../ghc-boot-9.12.2-1a37/src/GHC.Serialized.html#Serialized"><span class="hs-identifier hs-type">Serialized</span></a></span><span>
</span><span id="line-1040"></span><span id="convertAnnotationWrapper"><span class="annot"><span class="annottext">convertAnnotationWrapper :: ForeignHValue -&gt; TcM Serialized
</span><a href="GHC.Tc.Gen.Splice.html#convertAnnotationWrapper"><span class="hs-identifier hs-var hs-var">convertAnnotationWrapper</span></a></span></span><span> </span><span id="local-6989586621683159840"><span class="annot"><span class="annottext">ForeignHValue
</span><a href="#local-6989586621683159840"><span class="hs-identifier hs-var">fhv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1041"></span><span>  </span><span id="local-6989586621683159841"><span class="annot"><a href="#local-6989586621683159841"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM Interp
</span><a href="GHC.Tc.Gen.Splice.html#tcGetInterp"><span class="hs-identifier hs-var">tcGetInterp</span></a></span><span>
</span><span id="line-1042"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#interpInstance"><span class="hs-identifier hs-var">interpInstance</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159841"><span class="hs-identifier hs-type">interp</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1043"></span><span>    </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#ExternalInterp"><span class="hs-identifier hs-type">ExternalInterp</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">THResultType -&gt; ForeignHValue -&gt; TcM Serialized
forall a. Binary a =&gt; THResultType -&gt; ForeignHValue -&gt; TcM a
</span><a href="GHC.Tc.Gen.Splice.html#runTH"><span class="hs-identifier hs-var">runTH</span></a></span><span> </span><span class="annot"><span class="annottext">THResultType
</span><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#THAnnWrapper"><span class="hs-identifier hs-var">THAnnWrapper</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignHValue
</span><a href="#local-6989586621683159840"><span class="hs-identifier hs-var">fhv</span></a></span><span class="hs-cpp">
#if defined(HAVE_INTERNAL_INTERPRETER)
</span><span>    </span><span class="annot"><span class="annottext">InterpInstance
</span><a href="GHC.Runtime.Interpreter.Types.html#InternalInterp"><span class="hs-identifier hs-var">InternalInterp</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1046"></span><span>      </span><span id="local-6989586621683159848"><span class="annot"><a href="#local-6989586621683159848"><span class="hs-identifier hs-var">annotation_wrapper</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO HValue -&gt; IOEnv (Env TcGblEnv TcLclEnv) HValue
forall a. IO a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO HValue -&gt; IOEnv (Env TcGblEnv TcLclEnv) HValue)
-&gt; IO HValue -&gt; IOEnv (Env TcGblEnv TcLclEnv) HValue
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Interp -&gt; ForeignHValue -&gt; IO HValue
forall a. Interp -&gt; ForeignRef a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#wormhole"><span class="hs-identifier hs-var">wormhole</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683159841"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignHValue
</span><a href="#local-6989586621683159840"><span class="hs-identifier hs-var">fhv</span></a></span><span>
</span><span id="line-1047"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-1048"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="hs-identifier hs-type">unsafeCoerce</span></span><span> </span><span class="annot"><a href="#local-6989586621683159848"><span class="hs-identifier hs-type">annotation_wrapper</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1049"></span><span>           </span><span class="annot"><span class="hs-identifier hs-type">AnnotationWrapper</span></span><span> </span><span id="local-6989586621683159857"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683159857"><span class="hs-identifier hs-var">value</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683159858"><span class="annot"><span class="annottext">serialized :: Serialized
</span><a href="#local-6989586621683159858"><span class="hs-identifier hs-var hs-var">serialized</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; [Word8]) -&gt; a -&gt; Serialized
forall a. Typeable a =&gt; (a -&gt; [Word8]) -&gt; a -&gt; Serialized
</span><a href="../../ghc-boot-9.12.2-1a37/src/GHC.Serialized.html#toSerialized"><span class="hs-identifier hs-var">toSerialized</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; [Word8]
forall a. Data a =&gt; a -&gt; [Word8]
</span><a href="../../ghc-boot-9.12.2-1a37/src/GHC.Serialized.html#serializeWithData"><span class="hs-identifier hs-var">serializeWithData</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683159857"><span class="hs-identifier hs-var">value</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1050"></span><span>               </span><span class="hs-comment">-- Got the value and dictionaries: build the serialized value and</span><span>
</span><span id="line-1051"></span><span>               </span><span class="hs-comment">-- call it a day. We ensure that we seq the entire serialized value</span><span>
</span><span id="line-1052"></span><span>               </span><span class="hs-comment">-- in order that any errors in the user-written code for the</span><span>
</span><span id="line-1053"></span><span>               </span><span class="hs-comment">-- annotation are exposed at this point.  This is also why we are</span><span>
</span><span id="line-1054"></span><span>               </span><span class="hs-comment">-- doing all this stuff inside the context of runMeta: it has the</span><span>
</span><span id="line-1055"></span><span>               </span><span class="hs-comment">-- facilities to deal with user error in a meta-level expression</span><span>
</span><span id="line-1056"></span><span>               </span><span class="annot"><span class="annottext">Serialized -&gt; ()
</span><a href="GHC.Tc.Gen.Splice.html#seqSerialized"><span class="hs-identifier hs-var">seqSerialized</span></a></span><span> </span><span class="annot"><span class="annottext">Serialized
</span><a href="#local-6989586621683159858"><span class="hs-identifier hs-var">serialized</span></a></span><span> </span><span class="annot"><span class="annottext">() -&gt; Serialized -&gt; Serialized
forall a b. a -&gt; b -&gt; b
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="annot"><span class="annottext">Serialized
</span><a href="#local-6989586621683159858"><span class="hs-identifier hs-var">serialized</span></a></span><span>
</span><span id="line-1057"></span><span>
</span><span id="line-1058"></span><span class="annot"><span class="hs-comment">-- | Force the contents of the Serialized value so weknow it doesn't contain any bottoms</span></span><span>
</span><span id="line-1059"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#seqSerialized"><span class="hs-identifier hs-type">seqSerialized</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../ghc-boot-9.12.2-1a37/src/GHC.Serialized.html#Serialized"><span class="hs-identifier hs-type">Serialized</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1060"></span><span id="seqSerialized"><span class="annot"><span class="annottext">seqSerialized :: Serialized -&gt; ()
</span><a href="GHC.Tc.Gen.Splice.html#seqSerialized"><span class="hs-identifier hs-var hs-var">seqSerialized</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghc-boot-9.12.2-1a37/src/GHC.Serialized.html#Serialized"><span class="hs-identifier hs-type">Serialized</span></a></span><span> </span><span id="local-6989586621683159863"><span class="annot"><span class="annottext">TypeRep
</span><a href="#local-6989586621683159863"><span class="hs-identifier hs-var">the_type</span></a></span></span><span> </span><span id="local-6989586621683159864"><span class="annot"><span class="annottext">[Word8]
</span><a href="#local-6989586621683159864"><span class="hs-identifier hs-var">bytes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeRep
</span><a href="#local-6989586621683159863"><span class="hs-identifier hs-var">the_type</span></a></span><span> </span><span class="annot"><span class="annottext">TypeRep -&gt; () -&gt; ()
forall a b. a -&gt; b -&gt; b
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="annot"><span class="annottext">[Word8]
</span><a href="#local-6989586621683159864"><span class="hs-identifier hs-var">bytes</span></a></span><span> </span><span class="annot"><span class="annottext">[Word8] -&gt; () -&gt; ()
forall a b. [a] -&gt; b -&gt; b
</span><a href="GHC.Utils.Misc.html#seqList"><span class="hs-operator hs-var">`seqList`</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-cpp">

#endif
</span><span>
</span><span id="line-1064"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Running an expression}
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-1071"></span><span>
</span><span id="line-1072"></span><span id="local-6989586621683158378"><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runQuasi"><span class="hs-identifier hs-type">runQuasi</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Q</span></span><span> </span><span class="annot"><a href="#local-6989586621683158378"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683158378"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-1073"></span><span id="runQuasi"><span class="annot"><span class="annottext">runQuasi :: forall a. Q a -&gt; TcM a
</span><a href="GHC.Tc.Gen.Splice.html#runQuasi"><span class="hs-identifier hs-var hs-var">runQuasi</span></a></span></span><span> </span><span id="local-6989586621683159868"><span class="annot"><span class="annottext">Q a
</span><a href="#local-6989586621683159868"><span class="hs-identifier hs-var">act</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Q a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Quasi m =&gt; Q a -&gt; m a
</span><span class="hs-identifier hs-var">TH.runQ</span></span><span> </span><span class="annot"><span class="annottext">Q a
</span><a href="#local-6989586621683159868"><span class="hs-identifier hs-var">act</span></a></span><span>
</span><span id="line-1074"></span><span>
</span><span id="line-1075"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runRemoteModFinalizers"><span class="hs-identifier hs-type">runRemoteModFinalizers</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Hs.Expr.html#ThModFinalizers"><span class="hs-identifier hs-type">ThModFinalizers</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1076"></span><span id="runRemoteModFinalizers"><span class="annot"><span class="annottext">runRemoteModFinalizers :: ThModFinalizers -&gt; TcRn ()
</span><a href="GHC.Tc.Gen.Splice.html#runRemoteModFinalizers"><span class="hs-identifier hs-var hs-var">runRemoteModFinalizers</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Hs.Expr.html#ThModFinalizers"><span class="hs-identifier hs-type">ThModFinalizers</span></a></span><span> </span><span id="local-6989586621683159870"><span class="annot"><span class="annottext">[ForeignRef (Q ())]
</span><a href="#local-6989586621683159870"><span class="hs-identifier hs-var">finRefs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1077"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683159871"><span class="annot"><span class="annottext">withForeignRefs :: [ForeignRef a] -&gt; ([RemoteRef a] -&gt; IO b) -&gt; IO b
</span><a href="#local-6989586621683159871"><span class="hs-identifier hs-var hs-var hs-var">withForeignRefs</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621683159872"><span class="annot"><span class="annottext">[RemoteRef a] -&gt; IO b
</span><a href="#local-6989586621683159872"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[RemoteRef a] -&gt; IO b
</span><a href="#local-6989586621683159872"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1078"></span><span>      </span><span class="annot"><a href="#local-6989586621683159871"><span class="hs-identifier hs-var">withForeignRefs</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683159873"><span class="annot"><span class="annottext">ForeignRef a
</span><a href="#local-6989586621683159873"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621683159874"><span class="annot"><span class="annottext">[ForeignRef a]
</span><a href="#local-6989586621683159874"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621683159875"><span class="annot"><span class="annottext">[RemoteRef a] -&gt; IO b
</span><a href="#local-6989586621683159875"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ForeignRef a -&gt; (RemoteRef a -&gt; IO b) -&gt; IO b
forall a b. ForeignRef a -&gt; (RemoteRef a -&gt; IO b) -&gt; IO b
</span><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html#withForeignRef"><span class="hs-identifier hs-var">withForeignRef</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignRef a
</span><a href="#local-6989586621683159873"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">((RemoteRef a -&gt; IO b) -&gt; IO b) -&gt; (RemoteRef a -&gt; IO b) -&gt; IO b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621683159877"><span class="annot"><span class="annottext">RemoteRef a
</span><a href="#local-6989586621683159877"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1079"></span><span>        </span><span class="annot"><span class="annottext">[ForeignRef a] -&gt; ([RemoteRef a] -&gt; IO b) -&gt; IO b
</span><a href="#local-6989586621683159871"><span class="hs-identifier hs-var">withForeignRefs</span></a></span><span> </span><span class="annot"><span class="annottext">[ForeignRef a]
</span><a href="#local-6989586621683159874"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">(([RemoteRef a] -&gt; IO b) -&gt; IO b)
-&gt; ([RemoteRef a] -&gt; IO b) -&gt; IO b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621683159878"><span class="annot"><span class="annottext">[RemoteRef a]
</span><a href="#local-6989586621683159878"><span class="hs-identifier hs-var">rs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[RemoteRef a] -&gt; IO b
</span><a href="#local-6989586621683159875"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoteRef a
</span><a href="#local-6989586621683159877"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteRef a -&gt; [RemoteRef a] -&gt; [RemoteRef a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[RemoteRef a]
</span><a href="#local-6989586621683159878"><span class="hs-identifier hs-var">rs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1080"></span><span>  </span><span id="local-6989586621683159879"><span class="annot"><a href="#local-6989586621683159879"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM Interp
</span><a href="GHC.Tc.Gen.Splice.html#tcGetInterp"><span class="hs-identifier hs-var">tcGetInterp</span></a></span><span>
</span><span id="line-1081"></span><span>
</span><span id="line-1082"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#interpInstance"><span class="hs-identifier hs-var">interpInstance</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159879"><span class="hs-identifier hs-type">interp</span></a></span><span> </span><span class="hs-keyword">of</span><span class="hs-cpp">
#if defined(HAVE_INTERNAL_INTERPRETER)
</span><span>    </span><span class="annot"><span class="annottext">InterpInstance
</span><a href="GHC.Runtime.Interpreter.Types.html#InternalInterp"><span class="hs-identifier hs-var">InternalInterp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1085"></span><span>      </span><span id="local-6989586621683159880"><span class="annot"><a href="#local-6989586621683159880"><span class="hs-identifier hs-var">qs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO [Q ()] -&gt; IOEnv (Env TcGblEnv TcLclEnv) [Q ()]
forall a. IO a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ForeignRef (Q ())]
-&gt; ([RemoteRef (Q ())] -&gt; IO [Q ()]) -&gt; IO [Q ()]
forall {a} {b}. [ForeignRef a] -&gt; ([RemoteRef a] -&gt; IO b) -&gt; IO b
</span><a href="#local-6989586621683159871"><span class="hs-identifier hs-var">withForeignRefs</span></a></span><span> </span><span class="annot"><span class="annottext">[ForeignRef (Q ())]
</span><a href="#local-6989586621683159870"><span class="hs-identifier hs-var">finRefs</span></a></span><span> </span><span class="annot"><span class="annottext">(([RemoteRef (Q ())] -&gt; IO [Q ()]) -&gt; IO [Q ()])
-&gt; ([RemoteRef (Q ())] -&gt; IO [Q ()]) -&gt; IO [Q ()]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(RemoteRef (Q ()) -&gt; IO (Q ())) -&gt; [RemoteRef (Q ())] -&gt; IO [Q ()]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">RemoteRef (Q ()) -&gt; IO (Q ())
forall a. RemoteRef a -&gt; IO a
</span><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html#localRef"><span class="hs-identifier hs-var">localRef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1086"></span><span>      </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runQuasi"><span class="hs-identifier hs-type">runQuasi</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">sequence_</span></span><span> </span><span class="annot"><a href="#local-6989586621683159880"><span class="hs-identifier hs-type">qs</span></a></span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-1089"></span><span>    </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#ExternalInterp"><span class="hs-identifier hs-type">ExternalInterp</span></a></span><span> </span><span id="local-6989586621683159883"><span class="annot"><span class="annottext">ExtInterp
</span><a href="#local-6989586621683159883"><span class="hs-identifier hs-var">ext</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ExtInterp -&gt; (forall d. ExtInterpInstance d -&gt; TcRn ()) -&gt; TcRn ()
forall (m :: * -&gt; *) a.
ExceptionMonad m =&gt;
ExtInterp -&gt; (forall d. ExtInterpInstance d -&gt; m a) -&gt; m a
</span><a href="GHC.Runtime.Interpreter.html#withExtInterp"><span class="hs-identifier hs-var">withExtInterp</span></a></span><span> </span><span class="annot"><span class="annottext">ExtInterp
</span><a href="#local-6989586621683159883"><span class="hs-identifier hs-var">ext</span></a></span><span> </span><span class="annot"><span class="annottext">((forall d. ExtInterpInstance d -&gt; TcRn ()) -&gt; TcRn ())
-&gt; (forall d. ExtInterpInstance d -&gt; TcRn ()) -&gt; TcRn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621683159898"><span class="annot"><span class="annottext">ExtInterpInstance d
</span><a href="#local-6989586621683159898"><span class="hs-identifier hs-var">inst</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1090"></span><span>      </span><span id="local-6989586621683159899"><span class="annot"><a href="#local-6989586621683159899"><span class="hs-identifier hs-var">tcg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcRnIf TcGblEnv TcLclEnv TcGblEnv
forall gbl lcl. TcRnIf gbl lcl gbl
</span><a href="GHC.Tc.Utils.Monad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a></span><span>
</span><span id="line-1091"></span><span>      </span><span id="local-6989586621683159901"><span class="annot"><a href="#local-6989586621683159901"><span class="hs-identifier hs-var">th_state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TcRef.html#readTcRef"><span class="hs-identifier hs-type">readTcRef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.html#tcg_th_remote_state"><span class="hs-identifier hs-var">tcg_th_remote_state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159899"><span class="hs-identifier hs-type">tcg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1092"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683159901"><span class="hs-identifier hs-type">th_state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1093"></span><span>        </span><span class="annot"><span class="annottext">Maybe (ForeignRef (IORef QState))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcRn ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- TH was not started, nothing to do</span><span>
</span><span id="line-1094"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683159903"><span class="annot"><span class="annottext">ForeignRef (IORef QState)
</span><a href="#local-6989586621683159903"><span class="hs-identifier hs-var">fhv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1095"></span><span>          </span><span id="local-6989586621683159904"><span class="annot"><a href="#local-6989586621683159904"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (DelayedResponse (QResult ()))
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (DelayedResponse (QResult ()))
forall a. IO a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (DelayedResponse (QResult ()))
 -&gt; IOEnv (Env TcGblEnv TcLclEnv) (DelayedResponse (QResult ())))
-&gt; IO (DelayedResponse (QResult ()))
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (DelayedResponse (QResult ()))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ForeignRef (IORef QState)
-&gt; (RemoteRef (IORef QState) -&gt; IO (DelayedResponse (QResult ())))
-&gt; IO (DelayedResponse (QResult ()))
forall a b. ForeignRef a -&gt; (RemoteRef a -&gt; IO b) -&gt; IO b
</span><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html#withForeignRef"><span class="hs-identifier hs-var">withForeignRef</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignRef (IORef QState)
</span><a href="#local-6989586621683159903"><span class="hs-identifier hs-var">fhv</span></a></span><span> </span><span class="annot"><span class="annottext">((RemoteRef (IORef QState) -&gt; IO (DelayedResponse (QResult ())))
 -&gt; IO (DelayedResponse (QResult ())))
-&gt; (RemoteRef (IORef QState) -&gt; IO (DelayedResponse (QResult ())))
-&gt; IO (DelayedResponse (QResult ()))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621683159905"><span class="annot"><span class="annottext">RemoteRef (IORef QState)
</span><a href="#local-6989586621683159905"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1096"></span><span>            </span><span class="annot"><span class="annottext">[ForeignRef (Q ())]
-&gt; ([RemoteRef (Q ())] -&gt; IO (DelayedResponse (QResult ())))
-&gt; IO (DelayedResponse (QResult ()))
forall {a} {b}. [ForeignRef a] -&gt; ([RemoteRef a] -&gt; IO b) -&gt; IO b
</span><a href="#local-6989586621683159871"><span class="hs-identifier hs-var">withForeignRefs</span></a></span><span> </span><span class="annot"><span class="annottext">[ForeignRef (Q ())]
</span><a href="#local-6989586621683159870"><span class="hs-identifier hs-var">finRefs</span></a></span><span> </span><span class="annot"><span class="annottext">(([RemoteRef (Q ())] -&gt; IO (DelayedResponse (QResult ())))
 -&gt; IO (DelayedResponse (QResult ())))
-&gt; ([RemoteRef (Q ())] -&gt; IO (DelayedResponse (QResult ())))
-&gt; IO (DelayedResponse (QResult ()))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621683159906"><span class="annot"><span class="annottext">[RemoteRef (Q ())]
</span><a href="#local-6989586621683159906"><span class="hs-identifier hs-var">qrefs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1097"></span><span>              </span><span class="annot"><span class="annottext">ExtInterpInstance d
-&gt; Message (QResult ()) -&gt; IO (DelayedResponse (QResult ()))
forall d a.
ExtInterpInstance d -&gt; Message a -&gt; IO (DelayedResponse a)
</span><a href="GHC.Runtime.Interpreter.Process.html#sendMessageDelayedResponse"><span class="hs-identifier hs-var">sendMessageDelayedResponse</span></a></span><span> </span><span class="annot"><span class="annottext">ExtInterpInstance d
</span><a href="#local-6989586621683159898"><span class="hs-identifier hs-var">inst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoteRef (IORef QState)
-&gt; [RemoteRef (Q ())] -&gt; Message (QResult ())
</span><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#RunModFinalizers"><span class="hs-identifier hs-var">RunModFinalizers</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteRef (IORef QState)
</span><a href="#local-6989586621683159905"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">[RemoteRef (Q ())]
</span><a href="#local-6989586621683159906"><span class="hs-identifier hs-var">qrefs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1098"></span><span>          </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runRemoteTH"><span class="hs-identifier hs-type">runRemoteTH</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159898"><span class="hs-identifier hs-type">inst</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1099"></span><span>          </span><span id="local-6989586621683159910"><span class="annot"><a href="#local-6989586621683159910"><span class="hs-identifier hs-var">qr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Process.html#receiveDelayedResponse"><span class="hs-identifier hs-type">receiveDelayedResponse</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159898"><span class="hs-identifier hs-type">inst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159904"><span class="hs-identifier hs-type">r</span></a></span><span>
</span><span id="line-1100"></span><span>          </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#checkQResult"><span class="hs-identifier hs-type">checkQResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159910"><span class="hs-identifier hs-type">qr</span></a></span><span>
</span><span id="line-1101"></span><span>
</span><span id="line-1102"></span><span id="local-6989586621683158412"><span id="local-6989586621683158414"><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runQResult"><span class="hs-identifier hs-type">runQResult</span></a></span><span>
</span><span id="line-1103"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683158412"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">)</span><span>
</span><span id="line-1104"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Basic.html#Origin"><span class="hs-identifier hs-type">Origin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html#SrcSpan"><span class="hs-identifier hs-type">SrcSpan</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621683158412"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621683158414"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1105"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html#ForeignHValue"><span class="hs-identifier hs-type">ForeignHValue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683158412"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1106"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html#SrcSpan"><span class="hs-identifier hs-type">SrcSpan</span></a></span><span>
</span><span id="line-1107"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html#ForeignHValue"><span class="hs-identifier hs-type">ForeignHValue</span></a></span><span> </span><span class="hs-comment">{- TH.Q a -}</span><span>
</span><span id="line-1108"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683158414"><span class="hs-identifier hs-type">b</span></a></span></span></span><span>
</span><span id="line-1109"></span><span id="runQResult"><span class="annot"><span class="annottext">runQResult :: forall a b.
(a -&gt; String)
-&gt; (Origin -&gt; SrcSpan -&gt; a -&gt; b)
-&gt; (ForeignHValue -&gt; TcM a)
-&gt; SrcSpan
-&gt; ForeignHValue
-&gt; TcM b
</span><a href="GHC.Tc.Gen.Splice.html#runQResult"><span class="hs-identifier hs-var hs-var">runQResult</span></a></span></span><span> </span><span id="local-6989586621683159919"><span class="annot"><span class="annottext">a -&gt; String
</span><a href="#local-6989586621683159919"><span class="hs-identifier hs-var">show_th</span></a></span></span><span> </span><span id="local-6989586621683159920"><span class="annot"><span class="annottext">Origin -&gt; SrcSpan -&gt; a -&gt; b
</span><a href="#local-6989586621683159920"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621683159921"><span class="annot"><span class="annottext">ForeignHValue -&gt; TcM a
</span><a href="#local-6989586621683159921"><span class="hs-identifier hs-var">runQ</span></a></span></span><span> </span><span id="local-6989586621683159922"><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621683159922"><span class="hs-identifier hs-var">expr_span</span></a></span></span><span> </span><span id="local-6989586621683159923"><span class="annot"><span class="annottext">ForeignHValue
</span><a href="#local-6989586621683159923"><span class="hs-identifier hs-var">hval</span></a></span></span><span>
</span><span id="line-1110"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683159924"><span class="annot"><a href="#local-6989586621683159924"><span class="hs-identifier hs-var">th_result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ForeignHValue -&gt; TcM a
</span><a href="#local-6989586621683159921"><span class="hs-identifier hs-var">runQ</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignHValue
</span><a href="#local-6989586621683159923"><span class="hs-identifier hs-var">hval</span></a></span><span>
</span><span id="line-1111"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683159925"><span class="annot"><a href="#local-6989586621683159925"><span class="hs-identifier hs-var">th_origin</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#getThSpliceOrigin"><span class="hs-identifier hs-type">getThSpliceOrigin</span></a></span><span>
</span><span id="line-1112"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Got TH result:&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683159919"><span class="hs-identifier hs-type">show_th</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159924"><span class="hs-identifier hs-type">th_result</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1113"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683159920"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159925"><span class="hs-identifier hs-type">th_origin</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159922"><span class="hs-identifier hs-type">expr_span</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159924"><span class="hs-identifier hs-type">th_result</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1114"></span><span>
</span><span id="line-1115"></span><span>
</span><span id="line-1116"></span><span class="hs-comment">-----------------</span><span>
</span><span id="line-1117"></span><span id="local-6989586621683158418"><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runMeta"><span class="hs-identifier hs-type">runMeta</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Meta.html#MetaHook"><span class="hs-identifier hs-type">MetaHook</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#LHsExpr"><span class="hs-identifier hs-type">LHsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcTc"><span class="hs-identifier hs-type">GhcTc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683158418"><span class="hs-identifier hs-type">hs_syn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1118"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#LHsExpr"><span class="hs-identifier hs-type">LHsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcTc"><span class="hs-identifier hs-type">GhcTc</span></a></span><span>
</span><span id="line-1119"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683158418"><span class="hs-identifier hs-type">hs_syn</span></a></span></span><span>
</span><span id="line-1120"></span><span id="runMeta"><span class="annot"><span class="annottext">runMeta :: forall hs_syn.
(MetaHook (IOEnv (Env TcGblEnv TcLclEnv))
 -&gt; LHsExpr GhcTc -&gt; TcM hs_syn)
-&gt; LHsExpr GhcTc -&gt; TcM hs_syn
</span><a href="GHC.Tc.Gen.Splice.html#runMeta"><span class="hs-identifier hs-var hs-var">runMeta</span></a></span></span><span> </span><span id="local-6989586621683159933"><span class="annot"><span class="annottext">MetaHook (IOEnv (Env TcGblEnv TcLclEnv))
-&gt; LHsExpr GhcTc -&gt; TcM hs_syn
</span><a href="#local-6989586621683159933"><span class="hs-identifier hs-var">unwrap</span></a></span></span><span> </span><span id="local-6989586621683159934"><span class="annot"><span class="annottext">LHsExpr GhcTc
</span><a href="#local-6989586621683159934"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1121"></span><span>    </span><span id="local-6989586621683159935"><span class="annot"><a href="#local-6989586621683159935"><span class="hs-identifier hs-var">hooks</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IOEnv (Env TcGblEnv TcLclEnv) Hooks
forall (m :: * -&gt; *). HasHooks m =&gt; m Hooks
</span><a href="GHC.Driver.Hooks.html#getHooks"><span class="hs-identifier hs-var">getHooks</span></a></span><span>
</span><span id="line-1122"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="GHC.Driver.Hooks.html#runMetaHook"><span class="hs-identifier hs-var">runMetaHook</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683159935"><span class="hs-identifier hs-type">hooks</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1123"></span><span>        </span><span class="annot"><span class="annottext">Maybe (MetaHook (IOEnv (Env TcGblEnv TcLclEnv)))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MetaHook (IOEnv (Env TcGblEnv TcLclEnv))
-&gt; LHsExpr GhcTc -&gt; TcM hs_syn
</span><a href="#local-6989586621683159933"><span class="hs-identifier hs-var">unwrap</span></a></span><span> </span><span class="annot"><span class="annottext">MetaHook (IOEnv (Env TcGblEnv TcLclEnv))
</span><a href="GHC.Tc.Gen.Splice.html#defaultRunMeta"><span class="hs-identifier hs-var">defaultRunMeta</span></a></span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcTc
</span><a href="#local-6989586621683159934"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1124"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683159938"><span class="annot"><span class="annottext">MetaHook (IOEnv (Env TcGblEnv TcLclEnv))
</span><a href="#local-6989586621683159938"><span class="hs-identifier hs-var">h</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MetaHook (IOEnv (Env TcGblEnv TcLclEnv))
-&gt; LHsExpr GhcTc -&gt; TcM hs_syn
</span><a href="#local-6989586621683159933"><span class="hs-identifier hs-var">unwrap</span></a></span><span> </span><span class="annot"><span class="annottext">MetaHook (IOEnv (Env TcGblEnv TcLclEnv))
</span><a href="#local-6989586621683159938"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcTc
</span><a href="#local-6989586621683159934"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1125"></span><span>
</span><span id="line-1126"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#defaultRunMeta"><span class="hs-identifier hs-type">defaultRunMeta</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Meta.html#MetaHook"><span class="hs-identifier hs-type">MetaHook</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span>
</span><span id="line-1127"></span><span id="defaultRunMeta"><span class="annot"><span class="annottext">defaultRunMeta :: MetaHook (IOEnv (Env TcGblEnv TcLclEnv))
</span><a href="GHC.Tc.Gen.Splice.html#defaultRunMeta"><span class="hs-identifier hs-var hs-var">defaultRunMeta</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Meta.html#MetaE"><span class="hs-identifier hs-type">MetaE</span></a></span><span> </span><span id="local-6989586621683159940"><span class="annot"><span class="annottext">LHsExpr GhcPs -&gt; MetaResult
</span><a href="#local-6989586621683159940"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1128"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(GenLocated SrcSpanAnnA (HsExpr GhcPs) -&gt; MetaResult)
-&gt; IOEnv
     (Env TcGblEnv TcLclEnv) (GenLocated SrcSpanAnnA (HsExpr GhcPs))
-&gt; TcM MetaResult
forall a b.
(a -&gt; b)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) a
-&gt; IOEnv (Env TcGblEnv TcLclEnv) b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcPs -&gt; MetaResult
GenLocated SrcSpanAnnA (HsExpr GhcPs) -&gt; MetaResult
</span><a href="#local-6989586621683159940"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">(IOEnv
   (Env TcGblEnv TcLclEnv) (GenLocated SrcSpanAnnA (HsExpr GhcPs))
 -&gt; TcM MetaResult)
-&gt; (GenLocated SrcSpanAnnA (HsExpr GhcTc)
    -&gt; IOEnv
         (Env TcGblEnv TcLclEnv) (GenLocated SrcSpanAnnA (HsExpr GhcPs)))
-&gt; GenLocated SrcSpanAnnA (HsExpr GhcTc)
-&gt; TcM MetaResult
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; (GenLocated SrcSpanAnnA (HsExpr GhcPs) -&gt; SDoc)
-&gt; (SrcSpan
    -&gt; ForeignHValue
    -&gt; TcM
         (Either
            RunSpliceFailReason (GenLocated SrcSpanAnnA (HsExpr GhcPs))))
-&gt; LHsExpr GhcTc
-&gt; IOEnv
     (Env TcGblEnv TcLclEnv) (GenLocated SrcSpanAnnA (HsExpr GhcPs))
forall hs_syn.
Bool
-&gt; (hs_syn -&gt; SDoc)
-&gt; (SrcSpan
    -&gt; ForeignHValue -&gt; TcM (Either RunSpliceFailReason hs_syn))
-&gt; LHsExpr GhcTc
-&gt; TcM hs_syn
</span><a href="GHC.Tc.Gen.Splice.html#runMeta%27"><span class="hs-identifier hs-var">runMeta'</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">GenLocated SrcSpanAnnA (HsExpr GhcPs) -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Exp -&gt; String)
-&gt; (Origin
    -&gt; SrcSpan
    -&gt; Exp
    -&gt; Either
         RunSpliceFailReason (GenLocated SrcSpanAnnA (HsExpr GhcPs)))
-&gt; (ForeignHValue -&gt; TcM Exp)
-&gt; SrcSpan
-&gt; ForeignHValue
-&gt; TcM
     (Either
        RunSpliceFailReason (GenLocated SrcSpanAnnA (HsExpr GhcPs)))
forall a b.
(a -&gt; String)
-&gt; (Origin -&gt; SrcSpan -&gt; a -&gt; b)
-&gt; (ForeignHValue -&gt; TcM a)
-&gt; SrcSpan
-&gt; ForeignHValue
-&gt; TcM b
</span><a href="GHC.Tc.Gen.Splice.html#runQResult"><span class="hs-identifier hs-var">runQResult</span></a></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; String
forall a. Ppr a =&gt; a -&gt; String
</span><a href="../../ghc-boot-th-9.12.2-e976/src/GHC.Internal.TH.Ppr.html#pprint"><span class="hs-identifier hs-var">TH.pprint</span></a></span><span> </span><span class="annot"><span class="annottext">Origin
-&gt; SrcSpan -&gt; Exp -&gt; Either RunSpliceFailReason (LHsExpr GhcPs)
Origin
-&gt; SrcSpan
-&gt; Exp
-&gt; Either
     RunSpliceFailReason (GenLocated SrcSpanAnnA (HsExpr GhcPs))
</span><a href="GHC.ThToHs.html#convertToHsExpr"><span class="hs-identifier hs-var">convertToHsExpr</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignHValue -&gt; TcM Exp
</span><a href="GHC.Tc.Gen.Splice.html#runTHExp"><span class="hs-identifier hs-var">runTHExp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1129"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#defaultRunMeta"><span class="hs-identifier hs-var">defaultRunMeta</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Meta.html#MetaP"><span class="hs-identifier hs-type">MetaP</span></a></span><span> </span><span id="local-6989586621683159945"><span class="annot"><span class="annottext">LPat GhcPs -&gt; MetaResult
</span><a href="#local-6989586621683159945"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1130"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(GenLocated SrcSpanAnnA (Pat GhcPs) -&gt; MetaResult)
-&gt; IOEnv
     (Env TcGblEnv TcLclEnv) (GenLocated SrcSpanAnnA (Pat GhcPs))
-&gt; TcM MetaResult
forall a b.
(a -&gt; b)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) a
-&gt; IOEnv (Env TcGblEnv TcLclEnv) b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">LPat GhcPs -&gt; MetaResult
GenLocated SrcSpanAnnA (Pat GhcPs) -&gt; MetaResult
</span><a href="#local-6989586621683159945"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">(IOEnv (Env TcGblEnv TcLclEnv) (GenLocated SrcSpanAnnA (Pat GhcPs))
 -&gt; TcM MetaResult)
-&gt; (GenLocated SrcSpanAnnA (HsExpr GhcTc)
    -&gt; IOEnv
         (Env TcGblEnv TcLclEnv) (GenLocated SrcSpanAnnA (Pat GhcPs)))
-&gt; GenLocated SrcSpanAnnA (HsExpr GhcTc)
-&gt; TcM MetaResult
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; (GenLocated SrcSpanAnnA (Pat GhcPs) -&gt; SDoc)
-&gt; (SrcSpan
    -&gt; ForeignHValue
    -&gt; TcM
         (Either RunSpliceFailReason (GenLocated SrcSpanAnnA (Pat GhcPs))))
-&gt; LHsExpr GhcTc
-&gt; IOEnv
     (Env TcGblEnv TcLclEnv) (GenLocated SrcSpanAnnA (Pat GhcPs))
forall hs_syn.
Bool
-&gt; (hs_syn -&gt; SDoc)
-&gt; (SrcSpan
    -&gt; ForeignHValue -&gt; TcM (Either RunSpliceFailReason hs_syn))
-&gt; LHsExpr GhcTc
-&gt; TcM hs_syn
</span><a href="GHC.Tc.Gen.Splice.html#runMeta%27"><span class="hs-identifier hs-var">runMeta'</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">GenLocated SrcSpanAnnA (Pat GhcPs) -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Pat -&gt; String)
-&gt; (Origin
    -&gt; SrcSpan
    -&gt; Pat
    -&gt; Either RunSpliceFailReason (GenLocated SrcSpanAnnA (Pat GhcPs)))
-&gt; (ForeignHValue -&gt; TcM Pat)
-&gt; SrcSpan
-&gt; ForeignHValue
-&gt; TcM
     (Either RunSpliceFailReason (GenLocated SrcSpanAnnA (Pat GhcPs)))
forall a b.
(a -&gt; String)
-&gt; (Origin -&gt; SrcSpan -&gt; a -&gt; b)
-&gt; (ForeignHValue -&gt; TcM a)
-&gt; SrcSpan
-&gt; ForeignHValue
-&gt; TcM b
</span><a href="GHC.Tc.Gen.Splice.html#runQResult"><span class="hs-identifier hs-var">runQResult</span></a></span><span> </span><span class="annot"><span class="annottext">Pat -&gt; String
forall a. Ppr a =&gt; a -&gt; String
</span><a href="../../ghc-boot-th-9.12.2-e976/src/GHC.Internal.TH.Ppr.html#pprint"><span class="hs-identifier hs-var">TH.pprint</span></a></span><span> </span><span class="annot"><span class="annottext">Origin -&gt; SrcSpan -&gt; Pat -&gt; Either RunSpliceFailReason (LPat GhcPs)
Origin
-&gt; SrcSpan
-&gt; Pat
-&gt; Either RunSpliceFailReason (GenLocated SrcSpanAnnA (Pat GhcPs))
</span><a href="GHC.ThToHs.html#convertToPat"><span class="hs-identifier hs-var">convertToPat</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignHValue -&gt; TcM Pat
</span><a href="GHC.Tc.Gen.Splice.html#runTHPat"><span class="hs-identifier hs-var">runTHPat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1131"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#defaultRunMeta"><span class="hs-identifier hs-var">defaultRunMeta</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Meta.html#MetaT"><span class="hs-identifier hs-type">MetaT</span></a></span><span> </span><span id="local-6989586621683159949"><span class="annot"><span class="annottext">LHsType GhcPs -&gt; MetaResult
</span><a href="#local-6989586621683159949"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1132"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(GenLocated SrcSpanAnnA (HsType GhcPs) -&gt; MetaResult)
-&gt; IOEnv
     (Env TcGblEnv TcLclEnv) (GenLocated SrcSpanAnnA (HsType GhcPs))
-&gt; TcM MetaResult
forall a b.
(a -&gt; b)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) a
-&gt; IOEnv (Env TcGblEnv TcLclEnv) b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">LHsType GhcPs -&gt; MetaResult
GenLocated SrcSpanAnnA (HsType GhcPs) -&gt; MetaResult
</span><a href="#local-6989586621683159949"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">(IOEnv
   (Env TcGblEnv TcLclEnv) (GenLocated SrcSpanAnnA (HsType GhcPs))
 -&gt; TcM MetaResult)
-&gt; (GenLocated SrcSpanAnnA (HsExpr GhcTc)
    -&gt; IOEnv
         (Env TcGblEnv TcLclEnv) (GenLocated SrcSpanAnnA (HsType GhcPs)))
-&gt; GenLocated SrcSpanAnnA (HsExpr GhcTc)
-&gt; TcM MetaResult
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; (GenLocated SrcSpanAnnA (HsType GhcPs) -&gt; SDoc)
-&gt; (SrcSpan
    -&gt; ForeignHValue
    -&gt; TcM
         (Either
            RunSpliceFailReason (GenLocated SrcSpanAnnA (HsType GhcPs))))
-&gt; LHsExpr GhcTc
-&gt; IOEnv
     (Env TcGblEnv TcLclEnv) (GenLocated SrcSpanAnnA (HsType GhcPs))
forall hs_syn.
Bool
-&gt; (hs_syn -&gt; SDoc)
-&gt; (SrcSpan
    -&gt; ForeignHValue -&gt; TcM (Either RunSpliceFailReason hs_syn))
-&gt; LHsExpr GhcTc
-&gt; TcM hs_syn
</span><a href="GHC.Tc.Gen.Splice.html#runMeta%27"><span class="hs-identifier hs-var">runMeta'</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">GenLocated SrcSpanAnnA (HsType GhcPs) -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Type -&gt; String)
-&gt; (Origin
    -&gt; SrcSpan
    -&gt; Type
    -&gt; Either
         RunSpliceFailReason (GenLocated SrcSpanAnnA (HsType GhcPs)))
-&gt; (ForeignHValue -&gt; TcM Type)
-&gt; SrcSpan
-&gt; ForeignHValue
-&gt; TcM
     (Either
        RunSpliceFailReason (GenLocated SrcSpanAnnA (HsType GhcPs)))
forall a b.
(a -&gt; String)
-&gt; (Origin -&gt; SrcSpan -&gt; a -&gt; b)
-&gt; (ForeignHValue -&gt; TcM a)
-&gt; SrcSpan
-&gt; ForeignHValue
-&gt; TcM b
</span><a href="GHC.Tc.Gen.Splice.html#runQResult"><span class="hs-identifier hs-var">runQResult</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; String
forall a. Ppr a =&gt; a -&gt; String
</span><a href="../../ghc-boot-th-9.12.2-e976/src/GHC.Internal.TH.Ppr.html#pprint"><span class="hs-identifier hs-var">TH.pprint</span></a></span><span> </span><span class="annot"><span class="annottext">Origin
-&gt; SrcSpan -&gt; Type -&gt; Either RunSpliceFailReason (LHsType GhcPs)
Origin
-&gt; SrcSpan
-&gt; Type
-&gt; Either
     RunSpliceFailReason (GenLocated SrcSpanAnnA (HsType GhcPs))
</span><a href="GHC.ThToHs.html#convertToHsType"><span class="hs-identifier hs-var">convertToHsType</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignHValue -&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#runTHType"><span class="hs-identifier hs-var">runTHType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1133"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#defaultRunMeta"><span class="hs-identifier hs-var">defaultRunMeta</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Meta.html#MetaD"><span class="hs-identifier hs-type">MetaD</span></a></span><span> </span><span id="local-6989586621683159953"><span class="annot"><span class="annottext">[LHsDecl GhcPs] -&gt; MetaResult
</span><a href="#local-6989586621683159953"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1134"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([GenLocated SrcSpanAnnA (HsDecl GhcPs)] -&gt; MetaResult)
-&gt; IOEnv
     (Env TcGblEnv TcLclEnv) [GenLocated SrcSpanAnnA (HsDecl GhcPs)]
-&gt; TcM MetaResult
forall a b.
(a -&gt; b)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) a
-&gt; IOEnv (Env TcGblEnv TcLclEnv) b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[LHsDecl GhcPs] -&gt; MetaResult
[GenLocated SrcSpanAnnA (HsDecl GhcPs)] -&gt; MetaResult
</span><a href="#local-6989586621683159953"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">(IOEnv
   (Env TcGblEnv TcLclEnv) [GenLocated SrcSpanAnnA (HsDecl GhcPs)]
 -&gt; TcM MetaResult)
-&gt; (GenLocated SrcSpanAnnA (HsExpr GhcTc)
    -&gt; IOEnv
         (Env TcGblEnv TcLclEnv) [GenLocated SrcSpanAnnA (HsDecl GhcPs)])
-&gt; GenLocated SrcSpanAnnA (HsExpr GhcTc)
-&gt; TcM MetaResult
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; ([GenLocated SrcSpanAnnA (HsDecl GhcPs)] -&gt; SDoc)
-&gt; (SrcSpan
    -&gt; ForeignHValue
    -&gt; TcM
         (Either
            RunSpliceFailReason [GenLocated SrcSpanAnnA (HsDecl GhcPs)]))
-&gt; LHsExpr GhcTc
-&gt; IOEnv
     (Env TcGblEnv TcLclEnv) [GenLocated SrcSpanAnnA (HsDecl GhcPs)]
forall hs_syn.
Bool
-&gt; (hs_syn -&gt; SDoc)
-&gt; (SrcSpan
    -&gt; ForeignHValue -&gt; TcM (Either RunSpliceFailReason hs_syn))
-&gt; LHsExpr GhcTc
-&gt; TcM hs_syn
</span><a href="GHC.Tc.Gen.Splice.html#runMeta%27"><span class="hs-identifier hs-var">runMeta'</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">[GenLocated SrcSpanAnnA (HsDecl GhcPs)] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([Dec] -&gt; String)
-&gt; (Origin
    -&gt; SrcSpan
    -&gt; [Dec]
    -&gt; Either
         RunSpliceFailReason [GenLocated SrcSpanAnnA (HsDecl GhcPs)])
-&gt; (ForeignHValue -&gt; TcM [Dec])
-&gt; SrcSpan
-&gt; ForeignHValue
-&gt; TcM
     (Either
        RunSpliceFailReason [GenLocated SrcSpanAnnA (HsDecl GhcPs)])
forall a b.
(a -&gt; String)
-&gt; (Origin -&gt; SrcSpan -&gt; a -&gt; b)
-&gt; (ForeignHValue -&gt; TcM a)
-&gt; SrcSpan
-&gt; ForeignHValue
-&gt; TcM b
</span><a href="GHC.Tc.Gen.Splice.html#runQResult"><span class="hs-identifier hs-var">runQResult</span></a></span><span> </span><span class="annot"><span class="annottext">[Dec] -&gt; String
forall a. Ppr a =&gt; a -&gt; String
</span><a href="../../ghc-boot-th-9.12.2-e976/src/GHC.Internal.TH.Ppr.html#pprint"><span class="hs-identifier hs-var">TH.pprint</span></a></span><span> </span><span class="annot"><span class="annottext">Origin
-&gt; SrcSpan -&gt; [Dec] -&gt; Either RunSpliceFailReason [LHsDecl GhcPs]
Origin
-&gt; SrcSpan
-&gt; [Dec]
-&gt; Either
     RunSpliceFailReason [GenLocated SrcSpanAnnA (HsDecl GhcPs)]
</span><a href="GHC.ThToHs.html#convertToHsDecls"><span class="hs-identifier hs-var">convertToHsDecls</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignHValue -&gt; TcM [Dec]
</span><a href="GHC.Tc.Gen.Splice.html#runTHDec"><span class="hs-identifier hs-var">runTHDec</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1135"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#defaultRunMeta"><span class="hs-identifier hs-var">defaultRunMeta</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Meta.html#MetaAW"><span class="hs-identifier hs-type">MetaAW</span></a></span><span> </span><span id="local-6989586621683159957"><span class="annot"><span class="annottext">Serialized -&gt; MetaResult
</span><a href="#local-6989586621683159957"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1136"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Serialized -&gt; MetaResult) -&gt; TcM Serialized -&gt; TcM MetaResult
forall a b.
(a -&gt; b)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) a
-&gt; IOEnv (Env TcGblEnv TcLclEnv) b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Serialized -&gt; MetaResult
</span><a href="#local-6989586621683159957"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">(TcM Serialized -&gt; TcM MetaResult)
-&gt; (GenLocated SrcSpanAnnA (HsExpr GhcTc) -&gt; TcM Serialized)
-&gt; GenLocated SrcSpanAnnA (HsExpr GhcTc)
-&gt; TcM MetaResult
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; (Serialized -&gt; SDoc)
-&gt; (SrcSpan
    -&gt; ForeignHValue -&gt; TcM (Either RunSpliceFailReason Serialized))
-&gt; LHsExpr GhcTc
-&gt; TcM Serialized
forall hs_syn.
Bool
-&gt; (hs_syn -&gt; SDoc)
-&gt; (SrcSpan
    -&gt; ForeignHValue -&gt; TcM (Either RunSpliceFailReason hs_syn))
-&gt; LHsExpr GhcTc
-&gt; TcM hs_syn
</span><a href="GHC.Tc.Gen.Splice.html#runMeta%27"><span class="hs-identifier hs-var">runMeta'</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SDoc -&gt; Serialized -&gt; SDoc
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsOutput doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ForeignHValue -&gt; TcM (Either RunSpliceFailReason Serialized))
-&gt; SrcSpan
-&gt; ForeignHValue
-&gt; TcM (Either RunSpliceFailReason Serialized)
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">((ForeignHValue -&gt; TcM (Either RunSpliceFailReason Serialized))
 -&gt; SrcSpan
 -&gt; ForeignHValue
 -&gt; TcM (Either RunSpliceFailReason Serialized))
-&gt; (ForeignHValue -&gt; TcM (Either RunSpliceFailReason Serialized))
-&gt; SrcSpan
-&gt; ForeignHValue
-&gt; TcM (Either RunSpliceFailReason Serialized)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Serialized -&gt; Either RunSpliceFailReason Serialized)
-&gt; TcM Serialized -&gt; TcM (Either RunSpliceFailReason Serialized)
forall a b.
(a -&gt; b)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) a
-&gt; IOEnv (Env TcGblEnv TcLclEnv) b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Serialized -&gt; Either RunSpliceFailReason Serialized
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(TcM Serialized -&gt; TcM (Either RunSpliceFailReason Serialized))
-&gt; (ForeignHValue -&gt; TcM Serialized)
-&gt; ForeignHValue
-&gt; TcM (Either RunSpliceFailReason Serialized)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ForeignHValue -&gt; TcM Serialized
</span><a href="GHC.Tc.Gen.Splice.html#convertAnnotationWrapper"><span class="hs-identifier hs-var">convertAnnotationWrapper</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1137"></span><span>    </span><span class="hs-comment">-- We turn off showing the code in meta-level exceptions because doing so exposes</span><span>
</span><span id="line-1138"></span><span>    </span><span class="hs-comment">-- the toAnnotationWrapper function that we slap around the user's code</span><span>
</span><span id="line-1139"></span><span>
</span><span id="line-1140"></span><span class="hs-comment">----------------</span><span>
</span><span id="line-1141"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runMetaAW"><span class="hs-identifier hs-type">runMetaAW</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#LHsExpr"><span class="hs-identifier hs-type">LHsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcTc"><span class="hs-identifier hs-type">GhcTc</span></a></span><span>         </span><span class="hs-comment">-- Of type AnnotationWrapper</span><span>
</span><span id="line-1142"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="../../ghc-boot-9.12.2-1a37/src/GHC.Serialized.html#Serialized"><span class="hs-identifier hs-type">Serialized</span></a></span><span>
</span><span id="line-1143"></span><span id="runMetaAW"><span class="annot"><span class="annottext">runMetaAW :: LHsExpr GhcTc -&gt; TcM Serialized
</span><a href="GHC.Tc.Gen.Splice.html#runMetaAW"><span class="hs-identifier hs-var hs-var">runMetaAW</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(MetaHook (IOEnv (Env TcGblEnv TcLclEnv))
 -&gt; LHsExpr GhcTc -&gt; TcM Serialized)
-&gt; LHsExpr GhcTc -&gt; TcM Serialized
forall hs_syn.
(MetaHook (IOEnv (Env TcGblEnv TcLclEnv))
 -&gt; LHsExpr GhcTc -&gt; TcM hs_syn)
-&gt; LHsExpr GhcTc -&gt; TcM hs_syn
</span><a href="GHC.Tc.Gen.Splice.html#runMeta"><span class="hs-identifier hs-var">runMeta</span></a></span><span> </span><span class="annot"><span class="annottext">MetaHook (IOEnv (Env TcGblEnv TcLclEnv))
-&gt; LHsExpr GhcTc -&gt; TcM Serialized
forall (f :: * -&gt; *).
Functor f =&gt;
MetaHook f -&gt; LHsExpr GhcTc -&gt; f Serialized
</span><a href="GHC.Types.Meta.html#metaRequestAW"><span class="hs-identifier hs-var">metaRequestAW</span></a></span><span>
</span><span id="line-1144"></span><span>
</span><span id="line-1145"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runMetaE"><span class="hs-identifier hs-type">runMetaE</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#LHsExpr"><span class="hs-identifier hs-type">LHsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcTc"><span class="hs-identifier hs-type">GhcTc</span></a></span><span>          </span><span class="hs-comment">-- Of type (Q Exp)</span><span>
</span><span id="line-1146"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#LHsExpr"><span class="hs-identifier hs-type">LHsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcPs"><span class="hs-identifier hs-type">GhcPs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1147"></span><span id="runMetaE"><span class="annot"><span class="annottext">runMetaE :: LHsExpr GhcTc -&gt; TcM (LHsExpr GhcPs)
</span><a href="GHC.Tc.Gen.Splice.html#runMetaE"><span class="hs-identifier hs-var hs-var">runMetaE</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(MetaHook (IOEnv (Env TcGblEnv TcLclEnv))
 -&gt; LHsExpr GhcTc
 -&gt; IOEnv
      (Env TcGblEnv TcLclEnv) (GenLocated SrcSpanAnnA (HsExpr GhcPs)))
-&gt; LHsExpr GhcTc
-&gt; IOEnv
     (Env TcGblEnv TcLclEnv) (GenLocated SrcSpanAnnA (HsExpr GhcPs))
forall hs_syn.
(MetaHook (IOEnv (Env TcGblEnv TcLclEnv))
 -&gt; LHsExpr GhcTc -&gt; TcM hs_syn)
-&gt; LHsExpr GhcTc -&gt; TcM hs_syn
</span><a href="GHC.Tc.Gen.Splice.html#runMeta"><span class="hs-identifier hs-var">runMeta</span></a></span><span> </span><span class="annot"><span class="annottext">MetaHook (IOEnv (Env TcGblEnv TcLclEnv))
-&gt; LHsExpr GhcTc -&gt; TcM (LHsExpr GhcPs)
MetaHook (IOEnv (Env TcGblEnv TcLclEnv))
-&gt; LHsExpr GhcTc
-&gt; IOEnv
     (Env TcGblEnv TcLclEnv) (GenLocated SrcSpanAnnA (HsExpr GhcPs))
forall (f :: * -&gt; *).
Functor f =&gt;
MetaHook f -&gt; LHsExpr GhcTc -&gt; f (LHsExpr GhcPs)
</span><a href="GHC.Types.Meta.html#metaRequestE"><span class="hs-identifier hs-var">metaRequestE</span></a></span><span>
</span><span id="line-1148"></span><span>
</span><span id="line-1149"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runMetaP"><span class="hs-identifier hs-type">runMetaP</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#LHsExpr"><span class="hs-identifier hs-type">LHsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcTc"><span class="hs-identifier hs-type">GhcTc</span></a></span><span>          </span><span class="hs-comment">-- Of type (Q Pat)</span><span>
</span><span id="line-1150"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Pat.html#LPat"><span class="hs-identifier hs-type">LPat</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcPs"><span class="hs-identifier hs-type">GhcPs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1151"></span><span id="runMetaP"><span class="annot"><span class="annottext">runMetaP :: LHsExpr GhcTc -&gt; TcM (LPat GhcPs)
</span><a href="GHC.Tc.Gen.Splice.html#runMetaP"><span class="hs-identifier hs-var hs-var">runMetaP</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(MetaHook (IOEnv (Env TcGblEnv TcLclEnv))
 -&gt; LHsExpr GhcTc
 -&gt; IOEnv
      (Env TcGblEnv TcLclEnv) (GenLocated SrcSpanAnnA (Pat GhcPs)))
-&gt; LHsExpr GhcTc
-&gt; IOEnv
     (Env TcGblEnv TcLclEnv) (GenLocated SrcSpanAnnA (Pat GhcPs))
forall hs_syn.
(MetaHook (IOEnv (Env TcGblEnv TcLclEnv))
 -&gt; LHsExpr GhcTc -&gt; TcM hs_syn)
-&gt; LHsExpr GhcTc -&gt; TcM hs_syn
</span><a href="GHC.Tc.Gen.Splice.html#runMeta"><span class="hs-identifier hs-var">runMeta</span></a></span><span> </span><span class="annot"><span class="annottext">MetaHook (IOEnv (Env TcGblEnv TcLclEnv))
-&gt; LHsExpr GhcTc -&gt; TcM (LPat GhcPs)
MetaHook (IOEnv (Env TcGblEnv TcLclEnv))
-&gt; LHsExpr GhcTc
-&gt; IOEnv
     (Env TcGblEnv TcLclEnv) (GenLocated SrcSpanAnnA (Pat GhcPs))
forall (f :: * -&gt; *).
Functor f =&gt;
MetaHook f -&gt; LHsExpr GhcTc -&gt; f (LPat GhcPs)
</span><a href="GHC.Types.Meta.html#metaRequestP"><span class="hs-identifier hs-var">metaRequestP</span></a></span><span>
</span><span id="line-1152"></span><span>
</span><span id="line-1153"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runMetaT"><span class="hs-identifier hs-type">runMetaT</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#LHsExpr"><span class="hs-identifier hs-type">LHsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcTc"><span class="hs-identifier hs-type">GhcTc</span></a></span><span>          </span><span class="hs-comment">-- Of type (Q Type)</span><span>
</span><span id="line-1154"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Type.html#LHsType"><span class="hs-identifier hs-type">LHsType</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcPs"><span class="hs-identifier hs-type">GhcPs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1155"></span><span id="runMetaT"><span class="annot"><span class="annottext">runMetaT :: LHsExpr GhcTc -&gt; TcM (LHsType GhcPs)
</span><a href="GHC.Tc.Gen.Splice.html#runMetaT"><span class="hs-identifier hs-var hs-var">runMetaT</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(MetaHook (IOEnv (Env TcGblEnv TcLclEnv))
 -&gt; LHsExpr GhcTc
 -&gt; IOEnv
      (Env TcGblEnv TcLclEnv) (GenLocated SrcSpanAnnA (HsType GhcPs)))
-&gt; LHsExpr GhcTc
-&gt; IOEnv
     (Env TcGblEnv TcLclEnv) (GenLocated SrcSpanAnnA (HsType GhcPs))
forall hs_syn.
(MetaHook (IOEnv (Env TcGblEnv TcLclEnv))
 -&gt; LHsExpr GhcTc -&gt; TcM hs_syn)
-&gt; LHsExpr GhcTc -&gt; TcM hs_syn
</span><a href="GHC.Tc.Gen.Splice.html#runMeta"><span class="hs-identifier hs-var">runMeta</span></a></span><span> </span><span class="annot"><span class="annottext">MetaHook (IOEnv (Env TcGblEnv TcLclEnv))
-&gt; LHsExpr GhcTc -&gt; TcM (LHsType GhcPs)
MetaHook (IOEnv (Env TcGblEnv TcLclEnv))
-&gt; LHsExpr GhcTc
-&gt; IOEnv
     (Env TcGblEnv TcLclEnv) (GenLocated SrcSpanAnnA (HsType GhcPs))
forall (f :: * -&gt; *).
Functor f =&gt;
MetaHook f -&gt; LHsExpr GhcTc -&gt; f (LHsType GhcPs)
</span><a href="GHC.Types.Meta.html#metaRequestT"><span class="hs-identifier hs-var">metaRequestT</span></a></span><span>
</span><span id="line-1156"></span><span>
</span><span id="line-1157"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runMetaD"><span class="hs-identifier hs-type">runMetaD</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#LHsExpr"><span class="hs-identifier hs-type">LHsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcTc"><span class="hs-identifier hs-type">GhcTc</span></a></span><span>          </span><span class="hs-comment">-- Of type Q [Dec]</span><span>
</span><span id="line-1158"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Haskell.Syntax.Decls.html#LHsDecl"><span class="hs-identifier hs-type">LHsDecl</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcPs"><span class="hs-identifier hs-type">GhcPs</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1159"></span><span id="runMetaD"><span class="annot"><span class="annottext">runMetaD :: LHsExpr GhcTc -&gt; TcM [LHsDecl GhcPs]
</span><a href="GHC.Tc.Gen.Splice.html#runMetaD"><span class="hs-identifier hs-var hs-var">runMetaD</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(MetaHook (IOEnv (Env TcGblEnv TcLclEnv))
 -&gt; LHsExpr GhcTc
 -&gt; IOEnv
      (Env TcGblEnv TcLclEnv) [GenLocated SrcSpanAnnA (HsDecl GhcPs)])
-&gt; LHsExpr GhcTc
-&gt; IOEnv
     (Env TcGblEnv TcLclEnv) [GenLocated SrcSpanAnnA (HsDecl GhcPs)]
forall hs_syn.
(MetaHook (IOEnv (Env TcGblEnv TcLclEnv))
 -&gt; LHsExpr GhcTc -&gt; TcM hs_syn)
-&gt; LHsExpr GhcTc -&gt; TcM hs_syn
</span><a href="GHC.Tc.Gen.Splice.html#runMeta"><span class="hs-identifier hs-var">runMeta</span></a></span><span> </span><span class="annot"><span class="annottext">MetaHook (IOEnv (Env TcGblEnv TcLclEnv))
-&gt; LHsExpr GhcTc -&gt; TcM [LHsDecl GhcPs]
MetaHook (IOEnv (Env TcGblEnv TcLclEnv))
-&gt; LHsExpr GhcTc
-&gt; IOEnv
     (Env TcGblEnv TcLclEnv) [GenLocated SrcSpanAnnA (HsDecl GhcPs)]
forall (f :: * -&gt; *).
Functor f =&gt;
MetaHook f -&gt; LHsExpr GhcTc -&gt; f [LHsDecl GhcPs]
</span><a href="GHC.Types.Meta.html#metaRequestD"><span class="hs-identifier hs-var">metaRequestD</span></a></span><span>
</span><span id="line-1160"></span><span>
</span><span id="line-1161"></span><span class="hs-comment">{- Note [Errors in desugaring a splice]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
What should we do if there are errors when desugaring a splice? We should
abort. There are several cases to consider:

(a) The desugarer hits an unrecoverable error and fails in the monad.
(b) The desugarer hits a recoverable error, reports it, and continues.
(c) The desugarer reports a fatal warning (with -Werror), reports it, and continues.
(d) The desugarer reports a non-fatal warning, and continues.

Each case is tested in th/T19709[abcd].

General principle: we wish to report all messages from dealing with a splice
eagerly, as these messages arise during an earlier stage than type-checking
generally. It's also likely that a compile-time warning from spliced code
will be easier to understand then an error that arises from processing the
code the splice produces. (Rationale: the warning will be about the code the
user actually wrote, not what is generated.)

Case (a): We have no choice but to abort here, but we must make sure that
the messages are printed or logged before aborting. Logging them is annoying,
because we're in the type-checker, and the messages are DsMessages, from the
desugarer. So we report and then fail in the monad. This case is detected
by the fact that initDsTc returns Nothing.

Case (b): We detect this case by looking for errors in the messages returned
from initDsTc and aborting if we spot any (after printing, of course). Note
that initDsTc will return a Just ds_expr in this case, but we don't wish to
use the (likely very bogus) expression.

Case (c): This is functionally the same as (b), except that the expression
isn't bogus. We still don't wish to use it, as the user's request for -Werror
tells us not to.

Case (d): We report the warnings and then carry on with the expression.
This might result in warnings printed out of source order, but this is
appropriate, as the warnings from the splice arise from an earlier stage
of compilation.

Previously, we failed to abort in cases (b) and (c), leading to #19709.
-}</span><span>
</span><span id="line-1202"></span><span>
</span><span id="line-1203"></span><span class="hs-comment">---------------</span><span>
</span><span id="line-1204"></span><span id="local-6989586621683158433"><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runMeta%27"><span class="hs-identifier hs-type">runMeta'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>                 </span><span class="hs-comment">-- Whether code should be printed in the exception message</span><span>
</span><span id="line-1205"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683158433"><span class="hs-identifier hs-type">hs_syn</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span class="hs-special">)</span><span>                                    </span><span class="hs-comment">-- how to print the code</span><span>
</span><span id="line-1206"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.SrcLoc.html#SrcSpan"><span class="hs-identifier hs-type">SrcSpan</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html#ForeignHValue"><span class="hs-identifier hs-type">ForeignHValue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="GHC.Tc.Errors.Types.html#RunSpliceFailReason"><span class="hs-identifier hs-type">RunSpliceFailReason</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683158433"><span class="hs-identifier hs-type">hs_syn</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- How to run x</span><span>
</span><span id="line-1207"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#LHsExpr"><span class="hs-identifier hs-type">LHsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcTc"><span class="hs-identifier hs-type">GhcTc</span></a></span><span>        </span><span class="hs-comment">-- Of type x; typically x = Q TH.Exp, or</span><span>
</span><span id="line-1208"></span><span>                                 </span><span class="hs-comment">--    something like that</span><span>
</span><span id="line-1209"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683158433"><span class="hs-identifier hs-type">hs_syn</span></a></span></span><span>           </span><span class="hs-comment">-- Of type t</span><span>
</span><span id="line-1210"></span><span id="runMeta%27"><span class="annot"><span class="annottext">runMeta' :: forall hs_syn.
Bool
-&gt; (hs_syn -&gt; SDoc)
-&gt; (SrcSpan
    -&gt; ForeignHValue -&gt; TcM (Either RunSpliceFailReason hs_syn))
-&gt; LHsExpr GhcTc
-&gt; TcM hs_syn
</span><a href="GHC.Tc.Gen.Splice.html#runMeta%27"><span class="hs-identifier hs-var hs-var">runMeta'</span></a></span></span><span> </span><span id="local-6989586621683160009"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683160009"><span class="hs-identifier hs-var">show_code</span></a></span></span><span> </span><span id="local-6989586621683160010"><span class="annot"><span class="annottext">hs_syn -&gt; SDoc
</span><a href="#local-6989586621683160010"><span class="hs-identifier hs-var">ppr_hs</span></a></span></span><span> </span><span id="local-6989586621683160011"><span class="annot"><span class="annottext">SrcSpan -&gt; ForeignHValue -&gt; TcM (Either RunSpliceFailReason hs_syn)
</span><a href="#local-6989586621683160011"><span class="hs-identifier hs-var">run_and_convert</span></a></span></span><span> </span><span id="local-6989586621683160012"><span class="annot"><span class="annottext">LHsExpr GhcTc
</span><a href="#local-6989586621683160012"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-1211"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcRn ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;About to run&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GenLocated SrcSpanAnnA (HsExpr GhcTc) -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcTc
GenLocated SrcSpanAnnA (HsExpr GhcTc)
</span><a href="#local-6989586621683160012"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1212"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">TcRn ()
</span><a href="GHC.Tc.Utils.Monad.html#recordThSpliceUse"><span class="hs-identifier hs-var">recordThSpliceUse</span></a></span><span> </span><span class="hs-comment">-- seems to be the best place to do this,</span><span>
</span><span id="line-1213"></span><span>                            </span><span class="hs-comment">-- we catch all kinds of splices and annotations.</span><span>
</span><span id="line-1214"></span><span>
</span><span id="line-1215"></span><span>        </span><span class="hs-comment">-- Check that we've had no errors of any sort so far.</span><span>
</span><span id="line-1216"></span><span>        </span><span class="hs-comment">-- For example, if we found an error in an earlier defn f, but</span><span>
</span><span id="line-1217"></span><span>        </span><span class="hs-comment">-- recovered giving it type f :: forall a.a, it'd be very dodgy</span><span>
</span><span id="line-1218"></span><span>        </span><span class="hs-comment">-- to carry on.  Mind you, the staging restrictions mean we won't</span><span>
</span><span id="line-1219"></span><span>        </span><span class="hs-comment">-- actually run f, but it still seems wrong. And, more concretely,</span><span>
</span><span id="line-1220"></span><span>        </span><span class="hs-comment">-- see #5358 for an example that fell over when trying to</span><span>
</span><span id="line-1221"></span><span>        </span><span class="hs-comment">-- reify a function with an unlifted kind in it.  (These don't occur</span><span>
</span><span id="line-1222"></span><span>        </span><span class="hs-comment">-- in type-correct programs.)</span><span>
</span><span id="line-1223"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">TcRn ()
</span><a href="GHC.Tc.Utils.Monad.html#failIfErrsM"><span class="hs-identifier hs-var">failIfErrsM</span></a></span><span>
</span><span id="line-1224"></span><span>
</span><span id="line-1225"></span><span>        </span><span class="hs-comment">-- run plugins</span><span>
</span><span id="line-1226"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683160015"><span class="annot"><a href="#local-6989586621683160015"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcRnIf TcGblEnv TcLclEnv HscEnv
forall gbl lcl. TcRnIf gbl lcl HscEnv
</span><a href="GHC.Tc.Utils.Monad.html#getTopEnv"><span class="hs-identifier hs-var">getTopEnv</span></a></span><span>
</span><span id="line-1227"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683160017"><span class="annot"><a href="#local-6989586621683160017"><span class="hs-identifier hs-var">expr'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Driver.Plugins.html#withPlugins"><span class="hs-identifier hs-type">withPlugins</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Driver.Env.Types.html#hsc_plugins"><span class="hs-identifier hs-var">hsc_plugins</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160015"><span class="hs-identifier hs-type">hsc_env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="GHC.Driver.Plugins.html#spliceRunAction"><span class="hs-identifier hs-var">spliceRunAction</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160012"><span class="hs-identifier hs-type">expr</span></a></span><span>
</span><span id="line-1228"></span><span>
</span><span id="line-1229"></span><span>        </span><span class="hs-comment">-- Desugar</span><span>
</span><span id="line-1230"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683160021"><span class="annot"><a href="#local-6989586621683160021"><span class="hs-identifier hs-var">ds_msgs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683160022"><span class="annot"><a href="#local-6989586621683160022"><span class="hs-identifier hs-var">mb_ds_expr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.HsToCore.Monad.html#initDsTc"><span class="hs-identifier hs-type">initDsTc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.HsToCore.Expr.html#dsLExpr"><span class="hs-identifier hs-type">dsLExpr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160017"><span class="hs-identifier hs-type">expr'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1231"></span><span>
</span><span id="line-1232"></span><span>        </span><span class="hs-comment">-- Print any messages (even warnings) eagerly: they might be helpful if anything</span><span>
</span><span id="line-1233"></span><span>        </span><span class="hs-comment">-- goes wrong. See Note [Errors in desugaring a splice]. This happens in all</span><span>
</span><span id="line-1234"></span><span>        </span><span class="hs-comment">-- cases.</span><span>
</span><span id="line-1235"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683160025"><span class="annot"><a href="#local-6989586621683160025"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#getLogger"><span class="hs-identifier hs-type">getLogger</span></a></span><span>
</span><span id="line-1236"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683160027"><span class="annot"><a href="#local-6989586621683160027"><span class="hs-identifier hs-var">diag_opts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Driver.Config.Diagnostic.html#initDiagOpts"><span class="hs-identifier hs-type">initDiagOpts</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="GHC.Driver.DynFlags.html#getDynFlags"><span class="hs-identifier hs-type">getDynFlags</span></a></span><span>
</span><span id="line-1237"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683160030"><span class="annot"><a href="#local-6989586621683160030"><span class="hs-identifier hs-var">print_config</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Driver.Config.Diagnostic.html#initDsMessageOpts"><span class="hs-identifier hs-type">initDsMessageOpts</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="GHC.Driver.DynFlags.html#getDynFlags"><span class="hs-identifier hs-type">getDynFlags</span></a></span><span>
</span><span id="line-1238"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Driver.Errors.html#printMessages"><span class="hs-identifier hs-type">printMessages</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160025"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160030"><span class="hs-identifier hs-type">print_config</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160027"><span class="hs-identifier hs-type">diag_opts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160021"><span class="hs-identifier hs-type">ds_msgs</span></a></span><span>
</span><span id="line-1239"></span><span>
</span><span id="line-1240"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683160033"><span class="annot"><a href="#local-6989586621683160033"><span class="hs-identifier hs-var">ds_expr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683160022"><span class="hs-identifier hs-type">mb_ds_expr</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1241"></span><span>            </span><span class="annot"><span class="annottext">Maybe CoreExpr
</span><span class="hs-identifier hs-var">Nothing</span></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IOEnv (Env TcGblEnv TcLclEnv) CoreExpr
forall env a. IOEnv env a
</span><a href="GHC.Data.IOEnv.html#failM"><span class="hs-identifier hs-var">failM</span></a></span><span>   </span><span class="hs-comment">-- Case (a) from Note [Errors in desugaring a splice]</span><span>
</span><span id="line-1242"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683160034"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621683160034"><span class="hs-identifier hs-var">ds_expr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="hs-comment">-- There still might be a fatal warning or recoverable</span><span>
</span><span id="line-1243"></span><span>                             </span><span class="hs-comment">-- Cases (b) and (c) from Note [Errors in desugaring a splice]</span><span>
</span><span id="line-1244"></span><span>              </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcRn () -&gt; TcRn ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Messages DsMessage -&gt; Bool
forall e. Messages e -&gt; Bool
</span><a href="GHC.Types.Error.html#errorsOrFatalWarningsFound"><span class="hs-identifier hs-var">errorsOrFatalWarningsFound</span></a></span><span> </span><span class="annot"><span class="annottext">Messages DsMessage
</span><a href="#local-6989586621683160021"><span class="hs-identifier hs-var">ds_msgs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1245"></span><span>                     </span><span class="annot"><span class="annottext">TcRn ()
forall env a. IOEnv env a
</span><a href="GHC.Data.IOEnv.html#failM"><span class="hs-identifier hs-var">failM</span></a></span><span>
</span><span id="line-1246"></span><span>                 </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; IOEnv (Env TcGblEnv TcLclEnv) CoreExpr
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621683160034"><span class="hs-identifier hs-var">ds_expr</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1247"></span><span>
</span><span id="line-1248"></span><span>        </span><span class="hs-comment">-- Compile and link it; might fail if linking fails</span><span>
</span><span id="line-1249"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683160037"><span class="annot"><a href="#local-6989586621683160037"><span class="hs-identifier hs-var">src_span</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#getSrcSpanM"><span class="hs-identifier hs-type">getSrcSpanM</span></a></span><span>
</span><span id="line-1250"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;About to run (desugared)&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160033"><span class="hs-identifier hs-type">ds_expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1251"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683160038"><span class="annot"><a href="#local-6989586621683160038"><span class="hs-identifier hs-var">either_hval</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Data.IOEnv.html#tryM"><span class="hs-identifier hs-type">tryM</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-1252"></span><span>                         </span><span class="annot"><a href="GHC.Driver.Main.html#hscCompileCoreExpr"><span class="hs-identifier hs-type">GHC.Driver.Main.hscCompileCoreExpr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160015"><span class="hs-identifier hs-type">hsc_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160037"><span class="hs-identifier hs-type">src_span</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160033"><span class="hs-identifier hs-type">ds_expr</span></a></span><span>
</span><span id="line-1253"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683160038"><span class="hs-identifier hs-type">either_hval</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1254"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621683160041"><span class="annot"><span class="annottext">IOEnvFailure
</span><a href="#local-6989586621683160041"><span class="hs-identifier hs-var">exn</span></a></span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SplicePhase -&gt; IOEnvFailure -&gt; IOEnv (Env TcGblEnv TcLclEnv) hs_syn
forall e a. Exception e =&gt; SplicePhase -&gt; e -&gt; TcM a
</span><a href="#local-6989586621683160042"><span class="hs-identifier hs-var">fail_with_exn</span></a></span><span> </span><span class="annot"><span class="annottext">SplicePhase
</span><a href="GHC.Tc.Errors.Types.html#SplicePhase_CompileAndLink"><span class="hs-identifier hs-var">SplicePhase_CompileAndLink</span></a></span><span> </span><span class="annot"><span class="annottext">IOEnvFailure
</span><a href="#local-6989586621683160041"><span class="hs-identifier hs-var">exn</span></a></span><span> </span><span class="hs-special">;</span><span>
</span><span id="line-1255"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683160044"><span class="annot"><span class="annottext">ForeignHValue
</span><a href="#local-6989586621683160044"><span class="hs-identifier hs-var">hval</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683160045"><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683160045"><span class="hs-identifier hs-var">needed_mods</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683160046"><span class="annot"><span class="annottext">PkgsLoaded
</span><a href="#local-6989586621683160046"><span class="hs-identifier hs-var">needed_pkgs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1256"></span><span>
</span><span id="line-1257"></span><span>        </span><span class="hs-special">{</span><span>       </span><span class="hs-comment">-- Coerce it to Q t, and run it</span><span>
</span><span id="line-1258"></span><span>
</span><span id="line-1259"></span><span>                </span><span class="hs-comment">-- Running might fail if it throws an exception of any kind (hence tryAllM)</span><span>
</span><span id="line-1260"></span><span>                </span><span class="hs-comment">-- including, say, a pattern-match exception in the code we are running</span><span>
</span><span id="line-1261"></span><span>                </span><span class="hs-comment">--</span><span>
</span><span id="line-1262"></span><span>                </span><span class="hs-comment">-- We also do the TH -&gt; HS syntax conversion inside the same</span><span>
</span><span id="line-1263"></span><span>                </span><span class="hs-comment">-- exception-catching thing so that if there are any lurking</span><span>
</span><span id="line-1264"></span><span>                </span><span class="hs-comment">-- exceptions in the data structure returned by hval, we'll</span><span>
</span><span id="line-1265"></span><span>                </span><span class="hs-comment">-- encounter them inside the try</span><span>
</span><span id="line-1266"></span><span>                </span><span class="hs-comment">--</span><span>
</span><span id="line-1267"></span><span>                </span><span class="hs-comment">-- See Note [Exceptions in TH]</span><span>
</span><span id="line-1268"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683160047"><span class="annot"><span class="annottext">expr_span :: SrcSpan
</span><a href="#local-6989586621683160047"><span class="hs-identifier hs-var hs-var hs-var">expr_span</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GenLocated SrcSpanAnnA (HsExpr GhcTc) -&gt; SrcSpan
forall a e. HasLoc a =&gt; GenLocated a e -&gt; SrcSpan
</span><a href="GHC.Parser.Annotation.html#getLocA"><span class="hs-identifier hs-var">getLocA</span></a></span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcTc
GenLocated SrcSpanAnnA (HsExpr GhcTc)
</span><a href="#local-6989586621683160012"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-1269"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">[Linkable] -&gt; PkgsLoaded -&gt; TcRn ()
</span><a href="GHC.Tc.Utils.Monad.html#recordThNeededRuntimeDeps"><span class="hs-identifier hs-var">recordThNeededRuntimeDeps</span></a></span><span> </span><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683160045"><span class="hs-identifier hs-var">needed_mods</span></a></span><span> </span><span class="annot"><span class="annottext">PkgsLoaded
</span><a href="#local-6989586621683160046"><span class="hs-identifier hs-var">needed_pkgs</span></a></span><span>
</span><span id="line-1270"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683160049"><span class="annot"><a href="#local-6989586621683160049"><span class="hs-identifier hs-var">either_tval</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IOEnv (Env TcGblEnv TcLclEnv) hs_syn
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (Either SomeException hs_syn)
forall env r. IOEnv env r -&gt; IOEnv env (Either SomeException r)
</span><a href="GHC.Data.IOEnv.html#tryAllM"><span class="hs-identifier hs-var">tryAllM</span></a></span><span> </span><span class="annot"><span class="annottext">(IOEnv (Env TcGblEnv TcLclEnv) hs_syn
 -&gt; IOEnv (Env TcGblEnv TcLclEnv) (Either SomeException hs_syn))
-&gt; IOEnv (Env TcGblEnv TcLclEnv) hs_syn
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (Either SomeException hs_syn)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1271"></span><span>                         </span><span class="annot"><span class="annottext">SrcSpan
-&gt; IOEnv (Env TcGblEnv TcLclEnv) hs_syn
-&gt; IOEnv (Env TcGblEnv TcLclEnv) hs_syn
forall a. SrcSpan -&gt; TcRn a -&gt; TcRn a
</span><a href="GHC.Tc.Utils.Monad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621683160047"><span class="hs-identifier hs-var">expr_span</span></a></span><span> </span><span class="annot"><span class="annottext">(IOEnv (Env TcGblEnv TcLclEnv) hs_syn
 -&gt; IOEnv (Env TcGblEnv TcLclEnv) hs_syn)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) hs_syn
-&gt; IOEnv (Env TcGblEnv TcLclEnv) hs_syn
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-comment">-- Set the span so that qLocation can</span><span>
</span><span id="line-1272"></span><span>                                                </span><span class="hs-comment">-- see where this splice is</span><span>
</span><span id="line-1273"></span><span>             </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683160051"><span class="annot"><a href="#local-6989586621683160051"><span class="hs-identifier hs-var">mb_result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SrcSpan -&gt; ForeignHValue -&gt; TcM (Either RunSpliceFailReason hs_syn)
</span><a href="#local-6989586621683160011"><span class="hs-identifier hs-var">run_and_convert</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621683160047"><span class="hs-identifier hs-var">expr_span</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignHValue
</span><a href="#local-6989586621683160044"><span class="hs-identifier hs-var">hval</span></a></span><span>
</span><span id="line-1274"></span><span>                </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683160051"><span class="hs-identifier hs-type">mb_result</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1275"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621683160052"><span class="annot"><span class="annottext">RunSpliceFailReason
</span><a href="#local-6989586621683160052"><span class="hs-identifier hs-var">err</span></a></span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; IOEnv (Env TcGblEnv TcLclEnv) hs_syn
forall a. TcRnMessage -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; IOEnv (Env TcGblEnv TcLclEnv) hs_syn)
-&gt; TcRnMessage -&gt; IOEnv (Env TcGblEnv TcLclEnv) hs_syn
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1276"></span><span>                      </span><span class="annot"><span class="annottext">THError -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnTHError"><span class="hs-identifier hs-var">TcRnTHError</span></a></span><span> </span><span class="annot"><span class="annottext">(THError -&gt; TcRnMessage) -&gt; THError -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SpliceFailReason -&gt; THError
</span><a href="GHC.Tc.Errors.Types.html#THSpliceFailed"><span class="hs-identifier hs-var">THSpliceFailed</span></a></span><span> </span><span class="annot"><span class="annottext">(SpliceFailReason -&gt; THError) -&gt; SpliceFailReason -&gt; THError
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RunSpliceFailReason -&gt; SpliceFailReason
</span><a href="GHC.Tc.Errors.Types.html#RunSpliceFailure"><span class="hs-identifier hs-var">RunSpliceFailure</span></a></span><span> </span><span class="annot"><span class="annottext">RunSpliceFailReason
</span><a href="#local-6989586621683160052"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-1277"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621683160056"><span class="annot"><span class="annottext">hs_syn
</span><a href="#local-6989586621683160056"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcRn ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Got HsSyn result:&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">hs_syn -&gt; SDoc
</span><a href="#local-6989586621683160010"><span class="hs-identifier hs-var">ppr_hs</span></a></span><span> </span><span class="annot"><span class="annottext">hs_syn
</span><a href="#local-6989586621683160056"><span class="hs-identifier hs-var">result</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1278"></span><span>                                       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">hs_syn -&gt; IOEnv (Env TcGblEnv TcLclEnv) hs_syn
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(hs_syn -&gt; IOEnv (Env TcGblEnv TcLclEnv) hs_syn)
-&gt; hs_syn -&gt; IOEnv (Env TcGblEnv TcLclEnv) hs_syn
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">hs_syn
</span><a href="#local-6989586621683160056"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1279"></span><span>
</span><span id="line-1280"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683160049"><span class="hs-identifier hs-type">either_tval</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1281"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621683160058"><span class="annot"><span class="annottext">hs_syn
</span><a href="#local-6989586621683160058"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">hs_syn -&gt; IOEnv (Env TcGblEnv TcLclEnv) hs_syn
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">hs_syn
</span><a href="#local-6989586621683160058"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1282"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621683160059"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621683160059"><span class="hs-identifier hs-var">se</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Maybe IOEnvFailure
forall e. Exception e =&gt; SomeException -&gt; Maybe e
</span><span class="hs-identifier hs-var">fromException</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621683160059"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1283"></span><span>                         </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">IOEnvFailure
</span><a href="GHC.Data.IOEnv.html#IOEnvFailure"><span class="hs-identifier hs-var">IOEnvFailure</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IOEnv (Env TcGblEnv TcLclEnv) hs_syn
forall env a. IOEnv env a
</span><a href="GHC.Data.IOEnv.html#failM"><span class="hs-identifier hs-var">failM</span></a></span><span> </span><span class="hs-comment">-- Error already in Tc monad</span><span>
</span><span id="line-1284"></span><span>                         </span><span class="annot"><span class="annottext">Maybe IOEnvFailure
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SplicePhase
-&gt; SomeException -&gt; IOEnv (Env TcGblEnv TcLclEnv) hs_syn
forall e a. Exception e =&gt; SplicePhase -&gt; e -&gt; TcM a
</span><a href="#local-6989586621683160042"><span class="hs-identifier hs-var">fail_with_exn</span></a></span><span> </span><span class="annot"><span class="annottext">SplicePhase
</span><a href="GHC.Tc.Errors.Types.html#SplicePhase_Run"><span class="hs-identifier hs-var">SplicePhase_Run</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621683160059"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-comment">-- Exception</span><span>
</span><span id="line-1285"></span><span>        </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><span id="line-1286"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1287"></span><span>    </span><span class="hs-comment">-- see Note [Concealed TH exceptions]</span><span>
</span><span id="line-1288"></span><span>    </span><span id="local-6989586621683158483"><span id="local-6989586621683158484"><span class="annot"><a href="#local-6989586621683160042"><span class="hs-identifier hs-type">fail_with_exn</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Exception</span></span><span> </span><span class="annot"><a href="#local-6989586621683158483"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Errors.Types.html#SplicePhase"><span class="hs-identifier hs-type">SplicePhase</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621683158483"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683158484"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-1289"></span><span>    </span><span id="local-6989586621683160042"><span class="annot"><span class="annottext">fail_with_exn :: forall e a. Exception e =&gt; SplicePhase -&gt; e -&gt; TcM a
</span><a href="#local-6989586621683160042"><span class="hs-identifier hs-var hs-var">fail_with_exn</span></a></span></span><span> </span><span id="local-6989586621683160068"><span class="annot"><span class="annottext">SplicePhase
</span><a href="#local-6989586621683160068"><span class="hs-identifier hs-var">phase</span></a></span></span><span> </span><span id="local-6989586621683160069"><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621683160069"><span class="hs-identifier hs-var">exn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1290"></span><span>        </span><span id="local-6989586621683160070"><span class="annot"><a href="#local-6989586621683160070"><span class="hs-identifier hs-var">exn_msg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO String -&gt; IOEnv (Env TcGblEnv TcLclEnv) String
forall a. IO a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO String -&gt; IOEnv (Env TcGblEnv TcLclEnv) String)
-&gt; IO String -&gt; IOEnv (Env TcGblEnv TcLclEnv) String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">e -&gt; IO String
forall e. Exception e =&gt; e -&gt; IO String
</span><a href="GHC.Utils.Panic.html#safeShowException"><span class="hs-identifier hs-var">Panic.safeShowException</span></a></span><span> </span><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621683160069"><span class="hs-identifier hs-var">exn</span></a></span><span>
</span><span id="line-1291"></span><span>        </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#failWithTc"><span class="hs-identifier hs-type">failWithTc</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Tc.Errors.Types.html#TcRnTHError"><span class="hs-identifier hs-type">TcRnTHError</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Tc.Errors.Types.html#THSpliceFailed"><span class="hs-identifier hs-type">THSpliceFailed</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-1292"></span><span>          </span><span class="annot"><a href="GHC.Tc.Errors.Types.html#SpliceThrewException"><span class="hs-identifier hs-type">SpliceThrewException</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160068"><span class="hs-identifier hs-type">phase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">toException</span></span><span> </span><span class="annot"><a href="#local-6989586621683160069"><span class="hs-identifier hs-type">exn</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683160070"><span class="hs-identifier hs-type">exn_msg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160012"><span class="hs-identifier hs-type">expr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160009"><span class="hs-identifier hs-type">show_code</span></a></span><span>
</span><span id="line-1293"></span><span>
</span><span id="line-1294"></span><span class="hs-comment">{-
Note [Running typed splices in the zonker]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

See #15471 for the full discussion.

For many years typed splices were run immediately after they were type checked
however, this is too early as it means to zonk some type variables before
they can be unified with type variables in the surrounding context.

For example,

```
module A where

test_foo :: forall a . Q (TExp (a -&gt; a))
test_foo = [|| id ||]

module B where

import A

qux = $$(test_foo)
```

We would expect `qux` to have inferred type `forall a . a -&gt; a` but if
we run the splices too early the unified variables are zonked to `Any`. The
inferred type is the unusable `Any -&gt; Any`.

To run the splice, we must compile `test_foo` all the way to byte code.
But at the moment when the type checker is looking at the splice, test_foo
has type `Q (TExp (alpha -&gt; alpha))` and we
certainly can't compile code involving unification variables!

We could default `alpha` to `Any` but then we infer `qux :: Any -&gt; Any`
which definitely is not what we want.  Moreover, if we had
  qux = [$$(test_foo), (\x -&gt; x +1::Int)]
then `alpha` would have to be `Int`.

Conclusion: we must defer taking decisions about `alpha` until the
typechecker is done; and *then* we can run the splice.  It's fine to do it
later, because we know it'll produce type-correct code.

Deferring running the splice until later, in the zonker, means that the
unification variables propagate upwards from the splice into the surrounding
context and are unified correctly.

This is implemented by storing the arguments we need for running the splice
in a `DelayedSplice`. In the zonker, the arguments are passed to
`GHC.Tc.Gen.Splice.runTopSplice` and the expression inserted into the AST as normal.



Note [Exceptions in TH]
~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have something like this
        $( f 4 )
where
        f :: Int -&gt; Q [Dec]
        f n | n&gt;3       = fail &quot;Too many declarations&quot;
            | otherwise = ...

The 'fail' is a user-generated failure, and should be displayed as a
perfectly ordinary compiler error message, not a panic or anything
like that.  Here's how it's processed:

  * 'fail' is the monad fail.  The monad instance for Q in TH.Syntax
    effectively transforms (fail s) to
        qReport True s &gt;&gt; fail
    where 'qReport' comes from the Quasi class and fail from its monad
    superclass.

  * The TcM monad is an instance of Quasi (see GHC.Tc.Gen.Splice), and it implements
    (qReport True s) by using addErr to add an error message to the bag of errors.
    The 'fail' in TcM raises an IOEnvFailure exception

 * 'qReport' forces the message to ensure any exception hidden in unevaluated
   thunk doesn't get into the bag of errors. Otherwise the following splice
   will trigger panic (#8987):
        $(fail undefined)
   See also Note [Concealed TH exceptions]

  * So, when running a splice, we catch all exceptions; then for
        - an IOEnvFailure exception, we assume the error is already
                in the error-bag (above)
        - other errors, we add an error to the bag
    and then fail

Note [Concealed TH exceptions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When displaying the error message contained in an exception originated from TH
code, we need to make sure that the error message itself does not contain an
exception.  For example, when executing the following splice:

    $( error (&quot;foo &quot; ++ error &quot;bar&quot;) )

the message for the outer exception is a thunk which will throw the inner
exception when evaluated.

For this reason, we display the message of a TH exception using the
'safeShowException' function, which recursively catches any exception thrown
when showing an error message.


To call runQ in the Tc monad, we need to make TcM an instance of Quasi:
-}</span><span>
</span><span id="line-1400"></span><span>
</span><span id="line-1401"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621683160092"><span class="annot"><span class="hs-identifier hs-type">TH.Quasi</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1402"></span><span>  </span><span id="local-6989586621683160112"><span class="annot"><span class="annottext">qNewName :: String -&gt; TcM Name
</span><a href="#local-6989586621683160112"><span class="hs-identifier hs-var hs-var hs-var">qNewName</span></a></span></span><span> </span><span id="local-6989586621683160114"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160114"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683160115"><span class="annot"><a href="#local-6989586621683160115"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcRnIf TcGblEnv TcLclEnv Unique
forall gbl lcl. TcRnIf gbl lcl Unique
</span><a href="GHC.Tc.Utils.Monad.html#newUnique"><span class="hs-identifier hs-var">newUnique</span></a></span><span>
</span><span id="line-1403"></span><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683160117"><span class="annot"><a href="#local-6989586621683160117"><span class="hs-identifier hs-var hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Integer
forall a. Integral a =&gt; a -&gt; Integer
</span><span class="hs-identifier hs-var">toInteger</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Unique -&gt; Word64
</span><a href="GHC.Types.Unique.html#getKey"><span class="hs-identifier hs-var">getKey</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621683160115"><span class="hs-identifier hs-var">u</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1404"></span><span>                  </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.mkNameU</span></span><span> </span><span class="annot"><a href="#local-6989586621683160114"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160117"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1405"></span><span>
</span><span id="line-1406"></span><span>  </span><span class="hs-comment">-- 'msg' is forced to ensure exceptions don't escape,</span><span>
</span><span id="line-1407"></span><span>  </span><span class="hs-comment">-- see Note [Exceptions in TH]</span><span>
</span><span id="line-1408"></span><span>  </span><span id="local-6989586621683160120"><span class="annot"><span class="annottext">qReport :: Bool -&gt; String -&gt; TcRn ()
</span><a href="#local-6989586621683160120"><span class="hs-identifier hs-var hs-var hs-var">qReport</span></a></span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span id="local-6989586621683160122"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160122"><span class="hs-identifier hs-var">msg</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; TcRn () -&gt; TcRn ()
forall a b. [a] -&gt; b -&gt; b
</span><a href="GHC.Utils.Misc.html#seqList"><span class="hs-identifier hs-var">seqList</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160122"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRn () -&gt; TcRn ()) -&gt; TcRn () -&gt; TcRn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; TcRn ()
</span><a href="GHC.Tc.Utils.Monad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a></span><span>        </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; TcRn ()) -&gt; TcRnMessage -&gt; TcRn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">THError -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnTHError"><span class="hs-identifier hs-var">TcRnTHError</span></a></span><span> </span><span class="annot"><span class="annottext">(THError -&gt; TcRnMessage) -&gt; THError -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; String -&gt; THError
</span><a href="GHC.Tc.Errors.Types.html#ReportCustomQuasiError"><span class="hs-identifier hs-var">ReportCustomQuasiError</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>  </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160122"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-1409"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">qReport</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span id="local-6989586621683160124"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160124"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; TcRn () -&gt; TcRn ()
forall a b. [a] -&gt; b -&gt; b
</span><a href="GHC.Utils.Misc.html#seqList"><span class="hs-identifier hs-var">seqList</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160124"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRn () -&gt; TcRn ()) -&gt; TcRn () -&gt; TcRn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; TcRn ()
</span><a href="GHC.Tc.Utils.Monad.html#addDiagnostic"><span class="hs-identifier hs-var">addDiagnostic</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; TcRn ()) -&gt; TcRnMessage -&gt; TcRn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">THError -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnTHError"><span class="hs-identifier hs-var">TcRnTHError</span></a></span><span> </span><span class="annot"><span class="annottext">(THError -&gt; TcRnMessage) -&gt; THError -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; String -&gt; THError
</span><a href="GHC.Tc.Errors.Types.html#ReportCustomQuasiError"><span class="hs-identifier hs-var">ReportCustomQuasiError</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160124"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-1410"></span><span>
</span><span id="line-1411"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">qLocation</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Loc</span></span><span>
</span><span id="line-1412"></span><span>  </span><span id="local-6989586621683160138"><span class="annot"><span class="annottext">qLocation :: TcM Loc
</span><span class="hs-identifier hs-var hs-var hs-var">qLocation</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683160139"><span class="annot"><a href="#local-6989586621683160139"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IOEnv (Env TcGblEnv TcLclEnv) (GenModule Unit)
forall (m :: * -&gt; *). HasModule m =&gt; m (GenModule Unit)
</span><a href="GHC.Unit.Module.html#getModule"><span class="hs-identifier hs-var">getModule</span></a></span><span>
</span><span id="line-1413"></span><span>                 </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683160141"><span class="annot"><a href="#local-6989586621683160141"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#getSrcSpanM"><span class="hs-identifier hs-type">getSrcSpanM</span></a></span><span>
</span><span id="line-1414"></span><span>                 </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683160142"><span class="annot"><a href="#local-6989586621683160142"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683160141"><span class="hs-identifier hs-type">l</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1415"></span><span>                        </span><span class="annot"><a href="GHC.Types.SrcLoc.html#UnhelpfulSpan"><span class="hs-identifier hs-type">UnhelpfulSpan</span></a></span><span> </span><span class="annot"><span class="annottext">UnhelpfulSpanReason
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; IOEnv (Env TcGblEnv TcLclEnv) RealSrcSpan
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;qLocation: Unhelpful location&quot;</span></span><span>
</span><span id="line-1416"></span><span>                                                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SrcSpan -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621683160141"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1417"></span><span>                        </span><span class="annot"><a href="GHC.Types.SrcLoc.html#RealSrcSpan"><span class="hs-identifier hs-type">RealSrcSpan</span></a></span><span> </span><span id="local-6989586621683160145"><span class="annot"><span class="annottext">RealSrcSpan
</span><a href="#local-6989586621683160145"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe BufSpan
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RealSrcSpan -&gt; IOEnv (Env TcGblEnv TcLclEnv) RealSrcSpan
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">RealSrcSpan
</span><a href="#local-6989586621683160145"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1418"></span><span>                 </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.Loc</span></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="hs-identifier hs-var">TH.loc_filename</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html#unpackFS"><span class="hs-identifier hs-type">unpackFS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.SrcLoc.html#srcSpanFile"><span class="hs-identifier hs-var">srcSpanFile</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160142"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1419"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-var">TH.loc_module</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Module.Name.html#moduleNameString"><span class="hs-identifier hs-type">moduleNameString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Unit.Types.html#moduleName"><span class="hs-identifier hs-var">moduleName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160139"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1420"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-var">TH.loc_package</span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Unit.Types.html#unitString"><span class="hs-identifier hs-type">unitString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Unit.Types.html#moduleUnit"><span class="hs-identifier hs-var">moduleUnit</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160139"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1421"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-var">TH.loc_start</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.SrcLoc.html#srcSpanStartLine"><span class="hs-identifier hs-type">srcSpanStartLine</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160142"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html#srcSpanStartCol"><span class="hs-identifier hs-type">srcSpanStartCol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160142"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1422"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-var">TH.loc_end</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.SrcLoc.html#srcSpanEndLine"><span class="hs-identifier hs-type">srcSpanEndLine</span></a></span><span>   </span><span class="annot"><a href="#local-6989586621683160142"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html#srcSpanEndCol"><span class="hs-identifier hs-type">srcSpanEndCol</span></a></span><span>   </span><span class="annot"><a href="#local-6989586621683160142"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1423"></span><span>
</span><span id="line-1424"></span><span>  </span><span id="local-6989586621683160162"><span class="annot"><span class="annottext">qLookupName :: Bool -&gt; String -&gt; TcM (Maybe Name)
</span><a href="#local-6989586621683160162"><span class="hs-identifier hs-var hs-var hs-var">qLookupName</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; String -&gt; TcM (Maybe Name)
</span><a href="GHC.Tc.Gen.Splice.html#lookupName"><span class="hs-identifier hs-var">lookupName</span></a></span><span>
</span><span id="line-1425"></span><span>  </span><span id="local-6989586621683160165"><span class="annot"><span class="annottext">qReify :: Name -&gt; TcM Info
</span><a href="#local-6989586621683160165"><span class="hs-identifier hs-var hs-var hs-var">qReify</span></a></span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM Info
</span><a href="GHC.Tc.Gen.Splice.html#reify"><span class="hs-identifier hs-var">reify</span></a></span><span>
</span><span id="line-1426"></span><span>  </span><span id="local-6989586621683160169"><span class="annot"><span class="annottext">qReifyFixity :: Name -&gt; TcM (Maybe Fixity)
</span><a href="#local-6989586621683160169"><span class="hs-identifier hs-var hs-var hs-var">qReifyFixity</span></a></span></span><span> </span><span id="local-6989586621683160171"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160171"><span class="hs-identifier hs-var">nm</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM Name
</span><a href="GHC.Tc.Gen.Splice.html#lookupThName"><span class="hs-identifier hs-var">lookupThName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160171"><span class="hs-identifier hs-var">nm</span></a></span><span> </span><span class="annot"><span class="annottext">TcM Name -&gt; (Name -&gt; TcM (Maybe Fixity)) -&gt; TcM (Maybe Fixity)
forall a b.
IOEnv (Env TcGblEnv TcLclEnv) a
-&gt; (a -&gt; IOEnv (Env TcGblEnv TcLclEnv) b)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM (Maybe Fixity)
</span><a href="GHC.Tc.Gen.Splice.html#reifyFixity"><span class="hs-identifier hs-var">reifyFixity</span></a></span><span>
</span><span id="line-1427"></span><span>  </span><span id="local-6989586621683160174"><span class="annot"><span class="annottext">qReifyType :: Name -&gt; TcM Type
</span><a href="#local-6989586621683160174"><span class="hs-identifier hs-var hs-var hs-var">qReifyType</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#reifyTypeOfThing"><span class="hs-identifier hs-var">reifyTypeOfThing</span></a></span><span>
</span><span id="line-1428"></span><span>  </span><span id="local-6989586621683160177"><span class="annot"><span class="annottext">qReifyInstances :: Name -&gt; [Type] -&gt; TcM [Dec]
</span><a href="#local-6989586621683160177"><span class="hs-identifier hs-var hs-var hs-var">qReifyInstances</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; [Type] -&gt; TcM [Dec]
</span><a href="GHC.Tc.Gen.Splice.html#reifyInstances"><span class="hs-identifier hs-var">reifyInstances</span></a></span><span>
</span><span id="line-1429"></span><span>  </span><span id="local-6989586621683160180"><span class="annot"><span class="annottext">qReifyRoles :: Name -&gt; TcM [Role]
</span><a href="#local-6989586621683160180"><span class="hs-identifier hs-var hs-var hs-var">qReifyRoles</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM [Role]
</span><a href="GHC.Tc.Gen.Splice.html#reifyRoles"><span class="hs-identifier hs-var">reifyRoles</span></a></span><span>
</span><span id="line-1430"></span><span>  </span><span id="local-6989586621683160185"><span class="annot"><span class="annottext">qReifyAnnotations :: forall a. Data a =&gt; AnnLookup -&gt; TcM [a]
</span><a href="#local-6989586621683160185"><span class="hs-identifier hs-var hs-var hs-var">qReifyAnnotations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnnLookup -&gt; TcM [a]
forall a. Data a =&gt; AnnLookup -&gt; TcM [a]
</span><a href="GHC.Tc.Gen.Splice.html#reifyAnnotations"><span class="hs-identifier hs-var">reifyAnnotations</span></a></span><span>
</span><span id="line-1431"></span><span>  </span><span id="local-6989586621683160188"><span class="annot"><span class="annottext">qReifyModule :: Module -&gt; TcM ModuleInfo
</span><a href="#local-6989586621683160188"><span class="hs-identifier hs-var hs-var hs-var">qReifyModule</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Module -&gt; TcM ModuleInfo
</span><a href="GHC.Tc.Gen.Splice.html#reifyModule"><span class="hs-identifier hs-var">reifyModule</span></a></span><span>
</span><span id="line-1432"></span><span>  </span><span id="local-6989586621683160194"><span class="annot"><span class="annottext">qReifyConStrictness :: Name -&gt; TcM [DecidedStrictness]
</span><a href="#local-6989586621683160194"><span class="hs-identifier hs-var hs-var hs-var">qReifyConStrictness</span></a></span></span><span> </span><span id="local-6989586621683160196"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160196"><span class="hs-identifier hs-var">nm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683160197"><span class="annot"><a href="#local-6989586621683160197"><span class="hs-identifier hs-var">nm'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM Name
</span><a href="GHC.Tc.Gen.Splice.html#lookupThName"><span class="hs-identifier hs-var">lookupThName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160196"><span class="hs-identifier hs-var">nm</span></a></span><span>
</span><span id="line-1433"></span><span>                              </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683160198"><span class="annot"><a href="#local-6989586621683160198"><span class="hs-identifier hs-var">dc</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Env.html#tcLookupDataCon"><span class="hs-identifier hs-type">tcLookupDataCon</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160197"><span class="hs-identifier hs-type">nm'</span></a></span><span>
</span><span id="line-1434"></span><span>                              </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683160200"><span class="annot"><a href="#local-6989586621683160200"><span class="hs-identifier hs-var hs-var">bangs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; [HsImplBang]
</span><a href="GHC.Core.DataCon.html#dataConImplBangs"><span class="hs-identifier hs-var">dataConImplBangs</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621683160198"><span class="hs-identifier hs-var">dc</span></a></span><span>
</span><span id="line-1435"></span><span>                              </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">map</span></span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyDecidedStrictness"><span class="hs-identifier hs-type">reifyDecidedStrictness</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160200"><span class="hs-identifier hs-type">bangs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1436"></span><span>
</span><span id="line-1437"></span><span>        </span><span class="hs-comment">-- For qRecover, discard error messages if</span><span>
</span><span id="line-1438"></span><span>        </span><span class="hs-comment">-- the recovery action is chosen.  Otherwise</span><span>
</span><span id="line-1439"></span><span>        </span><span class="hs-comment">-- we'll only fail higher up.</span><span>
</span><span id="line-1440"></span><span>  </span><span id="local-6989586621683160203"><span class="annot"><span class="annottext">qRecover :: forall a. TcM a -&gt; TcM a -&gt; TcM a
</span><a href="#local-6989586621683160203"><span class="hs-identifier hs-var hs-var hs-var">qRecover</span></a></span></span><span> </span><span id="local-6989586621683160205"><span class="annot"><span class="annottext">TcM a
</span><a href="#local-6989586621683160205"><span class="hs-identifier hs-var">recover</span></a></span></span><span> </span><span id="local-6989586621683160206"><span class="annot"><span class="annottext">TcM a
</span><a href="#local-6989586621683160206"><span class="hs-identifier hs-var">main</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcM a -&gt; TcM a -&gt; TcM a
forall a. TcM a -&gt; TcM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#tryTcDiscardingErrs"><span class="hs-identifier hs-var">tryTcDiscardingErrs</span></a></span><span> </span><span class="annot"><span class="annottext">TcM a
</span><a href="#local-6989586621683160205"><span class="hs-identifier hs-var">recover</span></a></span><span> </span><span class="annot"><span class="annottext">TcM a
</span><a href="#local-6989586621683160206"><span class="hs-identifier hs-var">main</span></a></span><span>
</span><span id="line-1441"></span><span>
</span><span id="line-1442"></span><span>  </span><span id="local-6989586621683160211"><span class="annot"><span class="annottext">qGetPackageRoot :: IOEnv (Env TcGblEnv TcLclEnv) String
</span><a href="#local-6989586621683160211"><span class="hs-identifier hs-var hs-var hs-var">qGetPackageRoot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1443"></span><span>    </span><span id="local-6989586621683160213"><span class="annot"><a href="#local-6989586621683160213"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IOEnv (Env TcGblEnv TcLclEnv) DynFlags
forall (m :: * -&gt; *). HasDynFlags m =&gt; m DynFlags
</span><a href="GHC.Driver.DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a></span><span>
</span><span id="line-1444"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">fromMaybe</span></span><span> </span><span class="annot"><span class="hs-string">&quot;.&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Driver.DynFlags.html#workingDirectory"><span class="hs-identifier hs-var">workingDirectory</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160213"><span class="hs-identifier hs-type">dflags</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1445"></span><span>
</span><span id="line-1446"></span><span>  </span><span id="local-6989586621683160221"><span class="annot"><span class="annottext">qAddDependentFile :: String -&gt; TcRn ()
</span><a href="#local-6989586621683160221"><span class="hs-identifier hs-var hs-var hs-var">qAddDependentFile</span></a></span></span><span> </span><span id="local-6989586621683160223"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160223"><span class="hs-identifier hs-var">fp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1447"></span><span>    </span><span id="local-6989586621683160224"><span class="annot"><a href="#local-6989586621683160224"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TcGblEnv -&gt; TcRef [String])
-&gt; TcRnIf TcGblEnv TcLclEnv TcGblEnv
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (TcRef [String])
forall a b.
(a -&gt; b)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) a
-&gt; IOEnv (Env TcGblEnv TcLclEnv) b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">TcGblEnv -&gt; TcRef [String]
</span><a href="GHC.Tc.Types.html#tcg_dependent_files"><span class="hs-identifier hs-var">tcg_dependent_files</span></a></span><span> </span><span class="annot"><span class="annottext">TcRnIf TcGblEnv TcLclEnv TcGblEnv
forall gbl lcl. TcRnIf gbl lcl gbl
</span><a href="GHC.Tc.Utils.Monad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a></span><span>
</span><span id="line-1448"></span><span>    </span><span id="local-6989586621683160226"><span class="annot"><a href="#local-6989586621683160226"><span class="hs-identifier hs-var">dep_files</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TcRef.html#readTcRef"><span class="hs-identifier hs-type">readTcRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160224"><span class="hs-identifier hs-type">ref</span></a></span><span>
</span><span id="line-1449"></span><span>    </span><span class="annot"><a href="GHC.Tc.Types.TcRef.html#writeTcRef"><span class="hs-identifier hs-type">writeTcRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160224"><span class="hs-identifier hs-type">ref</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683160223"><span class="hs-identifier hs-type">fp</span></a></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><a href="#local-6989586621683160226"><span class="hs-identifier hs-type">dep_files</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1450"></span><span>
</span><span id="line-1451"></span><span>  </span><span id="local-6989586621683160236"><span class="annot"><span class="annottext">qAddTempFile :: String -&gt; IOEnv (Env TcGblEnv TcLclEnv) String
</span><a href="#local-6989586621683160236"><span class="hs-identifier hs-var hs-var hs-var">qAddTempFile</span></a></span></span><span> </span><span id="local-6989586621683160238"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160238"><span class="hs-identifier hs-var">suffix</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1452"></span><span>    </span><span id="local-6989586621683160239"><span class="annot"><a href="#local-6989586621683160239"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IOEnv (Env TcGblEnv TcLclEnv) DynFlags
forall (m :: * -&gt; *). HasDynFlags m =&gt; m DynFlags
</span><a href="GHC.Driver.DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a></span><span>
</span><span id="line-1453"></span><span>    </span><span id="local-6989586621683160240"><span class="annot"><a href="#local-6989586621683160240"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#getLogger"><span class="hs-identifier hs-type">getLogger</span></a></span><span>
</span><span id="line-1454"></span><span>    </span><span id="local-6989586621683160241"><span class="annot"><a href="#local-6989586621683160241"><span class="hs-identifier hs-var">tmpfs</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#hsc_tmpfs"><span class="hs-identifier hs-var">hsc_tmpfs</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#getTopEnv"><span class="hs-identifier hs-type">getTopEnv</span></a></span><span>
</span><span id="line-1455"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#newTempName"><span class="hs-identifier hs-type">newTempName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160240"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160241"><span class="hs-identifier hs-type">tmpfs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Driver.DynFlags.html#tmpDir"><span class="hs-identifier hs-var">tmpDir</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160239"><span class="hs-identifier hs-type">dflags</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TFL_GhcSession"><span class="hs-identifier hs-type">TFL_GhcSession</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160238"><span class="hs-identifier hs-type">suffix</span></a></span><span>
</span><span id="line-1456"></span><span>
</span><span id="line-1457"></span><span>  </span><span id="local-6989586621683160264"><span class="annot"><span class="annottext">qAddTopDecls :: [Dec] -&gt; TcRn ()
</span><a href="#local-6989586621683160264"><span class="hs-identifier hs-var hs-var hs-var">qAddTopDecls</span></a></span></span><span> </span><span id="local-6989586621683160266"><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621683160266"><span class="hs-identifier hs-var">thds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1458"></span><span>      </span><span id="local-6989586621683160267"><span class="annot"><a href="#local-6989586621683160267"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcRn SrcSpan
</span><a href="GHC.Tc.Utils.Monad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a></span><span>
</span><span id="line-1459"></span><span>      </span><span id="local-6989586621683160268"><span class="annot"><a href="#local-6989586621683160268"><span class="hs-identifier hs-var">th_origin</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#getThSpliceOrigin"><span class="hs-identifier hs-type">getThSpliceOrigin</span></a></span><span>
</span><span id="line-1460"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683160269"><span class="annot"><a href="#local-6989586621683160269"><span class="hs-identifier hs-var hs-var">either_hval</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Origin
-&gt; SrcSpan -&gt; [Dec] -&gt; Either RunSpliceFailReason [LHsDecl GhcPs]
</span><a href="GHC.ThToHs.html#convertToHsDecls"><span class="hs-identifier hs-var">convertToHsDecls</span></a></span><span> </span><span class="annot"><span class="annottext">Origin
</span><a href="#local-6989586621683160268"><span class="hs-identifier hs-var">th_origin</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621683160267"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621683160266"><span class="hs-identifier hs-var">thds</span></a></span><span>
</span><span id="line-1461"></span><span>      </span><span id="local-6989586621683160270"><span class="annot"><a href="#local-6989586621683160270"><span class="hs-identifier hs-var">ds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683160269"><span class="hs-identifier hs-type">either_hval</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1462"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621683160271"><span class="annot"><span class="annottext">RunSpliceFailReason
</span><a href="#local-6989586621683160271"><span class="hs-identifier hs-var">exn</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcRnMessage
-&gt; IOEnv
     (Env TcGblEnv TcLclEnv) [GenLocated SrcSpanAnnA (HsDecl GhcPs)]
forall a. TcRnMessage -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage
 -&gt; IOEnv
      (Env TcGblEnv TcLclEnv) [GenLocated SrcSpanAnnA (HsDecl GhcPs)])
-&gt; TcRnMessage
-&gt; IOEnv
     (Env TcGblEnv TcLclEnv) [GenLocated SrcSpanAnnA (HsDecl GhcPs)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">THError -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnTHError"><span class="hs-identifier hs-var">TcRnTHError</span></a></span><span> </span><span class="annot"><span class="annottext">(THError -&gt; TcRnMessage) -&gt; THError -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">AddTopDeclsError -&gt; THError
</span><a href="GHC.Tc.Errors.Types.html#AddTopDeclsError"><span class="hs-identifier hs-var">AddTopDeclsError</span></a></span><span> </span><span class="annot"><span class="annottext">(AddTopDeclsError -&gt; THError) -&gt; AddTopDeclsError -&gt; THError
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1463"></span><span>                </span><span class="annot"><span class="annottext">RunSpliceFailReason -&gt; AddTopDeclsError
</span><a href="GHC.Tc.Errors.Types.html#AddTopDeclsRunSpliceFailure"><span class="hs-identifier hs-var">AddTopDeclsRunSpliceFailure</span></a></span><span> </span><span class="annot"><span class="annottext">RunSpliceFailReason
</span><a href="#local-6989586621683160271"><span class="hs-identifier hs-var">exn</span></a></span><span>
</span><span id="line-1464"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621683160274"><span class="annot"><span class="annottext">[LHsDecl GhcPs]
</span><a href="#local-6989586621683160274"><span class="hs-identifier hs-var">ds</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[GenLocated SrcSpanAnnA (HsDecl GhcPs)]
-&gt; IOEnv
     (Env TcGblEnv TcLclEnv) [GenLocated SrcSpanAnnA (HsDecl GhcPs)]
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">[LHsDecl GhcPs]
[GenLocated SrcSpanAnnA (HsDecl GhcPs)]
</span><a href="#local-6989586621683160274"><span class="hs-identifier hs-var">ds</span></a></span><span>
</span><span id="line-1465"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683160276"><span class="hs-identifier hs-type">checkTopDecl</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html#unLoc"><span class="hs-identifier hs-type">unLoc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683160270"><span class="hs-identifier hs-type">ds</span></a></span><span>
</span><span id="line-1466"></span><span>      </span><span id="local-6989586621683160277"><span class="annot"><a href="#local-6989586621683160277"><span class="hs-identifier hs-var">th_topdecls_var</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">fmap</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#tcg_th_topdecls"><span class="hs-identifier hs-var">tcg_th_topdecls</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#getGblEnv"><span class="hs-identifier hs-type">getGblEnv</span></a></span><span>
</span><span id="line-1467"></span><span>      </span><span class="annot"><a href="GHC.Tc.Types.TcRef.html#updTcRef"><span class="hs-identifier hs-type">updTcRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160277"><span class="hs-identifier hs-type">th_topdecls_var</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621683160280"><span class="annot"><span class="annottext">[GenLocated SrcSpanAnnA (HsDecl GhcPs)]
</span><a href="#local-6989586621683160280"><span class="hs-identifier hs-var">topds</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[GenLocated SrcSpanAnnA (HsDecl GhcPs)]
</span><a href="#local-6989586621683160270"><span class="hs-identifier hs-var">ds</span></a></span><span> </span><span class="annot"><span class="annottext">[GenLocated SrcSpanAnnA (HsDecl GhcPs)]
-&gt; [GenLocated SrcSpanAnnA (HsDecl GhcPs)]
-&gt; [GenLocated SrcSpanAnnA (HsDecl GhcPs)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[GenLocated SrcSpanAnnA (HsDecl GhcPs)]
</span><a href="#local-6989586621683160280"><span class="hs-identifier hs-var">topds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1468"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1469"></span><span>      </span><span class="annot"><a href="#local-6989586621683160276"><span class="hs-identifier hs-type">checkTopDecl</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Decls.html#HsDecl"><span class="hs-identifier hs-type">HsDecl</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcPs"><span class="hs-identifier hs-type">GhcPs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1470"></span><span>      </span><span id="local-6989586621683160276"><span class="annot"><span class="annottext">checkTopDecl :: HsDecl GhcPs -&gt; TcRn ()
</span><a href="#local-6989586621683160276"><span class="hs-identifier hs-var hs-var">checkTopDecl</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Decls.html#ValD"><span class="hs-identifier hs-type">ValD</span></a></span><span> </span><span class="annot"><span class="annottext">XValD GhcPs
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683160282"><span class="annot"><span class="annottext">HsBind GhcPs
</span><a href="#local-6989586621683160282"><span class="hs-identifier hs-var">binds</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1471"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RdrName -&gt; TcRn ()) -&gt; [RdrName] -&gt; TcRn ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">RdrName -&gt; TcRn ()
</span><a href="#local-6989586621683160283"><span class="hs-identifier hs-var">bindName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CollectFlag GhcPs -&gt; HsBind GhcPs -&gt; [IdP GhcPs]
forall p idR.
CollectPass p =&gt;
CollectFlag p -&gt; HsBindLR p idR -&gt; [IdP p]
</span><a href="GHC.Hs.Utils.html#collectHsBindBinders"><span class="hs-identifier hs-var">collectHsBindBinders</span></a></span><span> </span><span class="annot"><span class="annottext">CollectFlag GhcPs
forall p. CollectFlag p
</span><a href="GHC.Hs.Utils.html#CollNoDictBinders"><span class="hs-identifier hs-var">CollNoDictBinders</span></a></span><span> </span><span class="annot"><span class="annottext">HsBind GhcPs
</span><a href="#local-6989586621683160282"><span class="hs-identifier hs-var">binds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1472"></span><span>      </span><span class="annot"><a href="#local-6989586621683160276"><span class="hs-identifier hs-var">checkTopDecl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Decls.html#SigD"><span class="hs-identifier hs-type">SigD</span></a></span><span> </span><span class="annot"><span class="annottext">XSigD GhcPs
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Sig GhcPs
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-1473"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcRn ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1474"></span><span>      </span><span class="annot"><a href="#local-6989586621683160276"><span class="hs-identifier hs-var">checkTopDecl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Decls.html#AnnD"><span class="hs-identifier hs-type">AnnD</span></a></span><span> </span><span class="annot"><span class="annottext">XAnnD GhcPs
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">AnnDecl GhcPs
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-1475"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcRn ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1476"></span><span>      </span><span class="annot"><a href="#local-6989586621683160276"><span class="hs-identifier hs-var">checkTopDecl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Decls.html#ForD"><span class="hs-identifier hs-type">ForD</span></a></span><span> </span><span class="annot"><span class="annottext">XForD GhcPs
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Decls.html#ForeignImport"><span class="hs-identifier hs-type">ForeignImport</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fd_name :: forall pass. ForeignDecl pass -&gt; LIdP pass
</span><a href="Language.Haskell.Syntax.Decls.html#fd_name"><span class="hs-identifier hs-var">fd_name</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html#L"><span class="hs-identifier hs-type">L</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpanAnnN
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683160291"><span class="annot"><span class="annottext">RdrName
</span><a href="#local-6989586621683160291"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1477"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RdrName -&gt; TcRn ()
</span><a href="#local-6989586621683160283"><span class="hs-identifier hs-var">bindName</span></a></span><span> </span><span class="annot"><span class="annottext">RdrName
</span><a href="#local-6989586621683160291"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-1478"></span><span>      </span><span class="annot"><a href="#local-6989586621683160276"><span class="hs-identifier hs-var">checkTopDecl</span></a></span><span> </span><span id="local-6989586621683160292"><span class="annot"><span class="annottext">HsDecl GhcPs
</span><a href="#local-6989586621683160292"><span class="hs-identifier hs-var">d</span></a></span></span><span>
</span><span id="line-1479"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; TcRn ()
</span><a href="GHC.Tc.Utils.Monad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; TcRn ()) -&gt; TcRnMessage -&gt; TcRn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">THError -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnTHError"><span class="hs-identifier hs-var">TcRnTHError</span></a></span><span> </span><span class="annot"><span class="annottext">(THError -&gt; TcRnMessage) -&gt; THError -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">AddTopDeclsError -&gt; THError
</span><a href="GHC.Tc.Errors.Types.html#AddTopDeclsError"><span class="hs-identifier hs-var">AddTopDeclsError</span></a></span><span> </span><span class="annot"><span class="annottext">(AddTopDeclsError -&gt; THError) -&gt; AddTopDeclsError -&gt; THError
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HsDecl GhcPs -&gt; AddTopDeclsError
</span><a href="GHC.Tc.Errors.Types.html#InvalidTopDecl"><span class="hs-identifier hs-var">InvalidTopDecl</span></a></span><span> </span><span class="annot"><span class="annottext">HsDecl GhcPs
</span><a href="#local-6989586621683160292"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-1480"></span><span>
</span><span id="line-1481"></span><span>      </span><span class="annot"><a href="#local-6989586621683160283"><span class="hs-identifier hs-type">bindName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Name.Reader.html#RdrName"><span class="hs-identifier hs-type">RdrName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1482"></span><span>      </span><span id="local-6989586621683160283"><span class="annot"><span class="annottext">bindName :: RdrName -&gt; TcRn ()
</span><a href="#local-6989586621683160283"><span class="hs-identifier hs-var hs-var">bindName</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Name.Reader.html#Exact"><span class="hs-identifier hs-type">Exact</span></a></span><span> </span><span id="local-6989586621683160295"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160295"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1483"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683160296"><span class="annot"><a href="#local-6989586621683160296"><span class="hs-identifier hs-var">th_topnames_var</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TcGblEnv -&gt; TcRef FreeVars)
-&gt; TcRnIf TcGblEnv TcLclEnv TcGblEnv
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (TcRef FreeVars)
forall a b.
(a -&gt; b)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) a
-&gt; IOEnv (Env TcGblEnv TcLclEnv) b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">TcGblEnv -&gt; TcRef FreeVars
</span><a href="GHC.Tc.Types.html#tcg_th_topnames"><span class="hs-identifier hs-var">tcg_th_topnames</span></a></span><span> </span><span class="annot"><span class="annottext">TcRnIf TcGblEnv TcLclEnv TcGblEnv
forall gbl lcl. TcRnIf gbl lcl gbl
</span><a href="GHC.Tc.Utils.Monad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a></span><span>
</span><span id="line-1484"></span><span>             </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TcRef.html#updTcRef"><span class="hs-identifier hs-type">updTcRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160296"><span class="hs-identifier hs-type">th_topnames_var</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621683160298"><span class="annot"><span class="annottext">FreeVars
</span><a href="#local-6989586621683160298"><span class="hs-identifier hs-var">ns</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FreeVars -&gt; Name -&gt; FreeVars
</span><a href="GHC.Types.Name.Set.html#extendNameSet"><span class="hs-identifier hs-var">extendNameSet</span></a></span><span> </span><span class="annot"><span class="annottext">FreeVars
</span><a href="#local-6989586621683160298"><span class="hs-identifier hs-var">ns</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160295"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1485"></span><span>             </span><span class="hs-special">}</span><span>
</span><span id="line-1486"></span><span>
</span><span id="line-1487"></span><span>      </span><span class="annot"><a href="#local-6989586621683160283"><span class="hs-identifier hs-var">bindName</span></a></span><span> </span><span id="local-6989586621683160300"><span class="annot"><span class="annottext">RdrName
</span><a href="#local-6989586621683160300"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; TcRn ()
</span><a href="GHC.Tc.Utils.Monad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; TcRn ()) -&gt; TcRnMessage -&gt; TcRn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">THError -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnTHError"><span class="hs-identifier hs-var">TcRnTHError</span></a></span><span> </span><span class="annot"><span class="annottext">(THError -&gt; TcRnMessage) -&gt; THError -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">THNameError -&gt; THError
</span><a href="GHC.Tc.Errors.Types.html#THNameError"><span class="hs-identifier hs-var">THNameError</span></a></span><span> </span><span class="annot"><span class="annottext">(THNameError -&gt; THError) -&gt; THNameError -&gt; THError
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RdrName -&gt; THNameError
</span><a href="GHC.Tc.Errors.Types.html#NonExactName"><span class="hs-identifier hs-var">NonExactName</span></a></span><span> </span><span class="annot"><span class="annottext">RdrName
</span><a href="#local-6989586621683160300"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-1488"></span><span>
</span><span id="line-1489"></span><span>  </span><span id="local-6989586621683160306"><span class="annot"><span class="annottext">qAddForeignFilePath :: ForeignSrcLang -&gt; String -&gt; TcRn ()
</span><a href="#local-6989586621683160306"><span class="hs-identifier hs-var hs-var hs-var">qAddForeignFilePath</span></a></span></span><span> </span><span id="local-6989586621683160308"><span class="annot"><span class="annottext">ForeignSrcLang
</span><a href="#local-6989586621683160308"><span class="hs-identifier hs-var">lang</span></a></span></span><span> </span><span id="local-6989586621683160309"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160309"><span class="hs-identifier hs-var">fp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1490"></span><span>    </span><span id="local-6989586621683160310"><span class="annot"><a href="#local-6989586621683160310"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TcGblEnv -&gt; TcRef [(ForeignSrcLang, String)])
-&gt; TcRnIf TcGblEnv TcLclEnv TcGblEnv
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (TcRef [(ForeignSrcLang, String)])
forall a b.
(a -&gt; b)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) a
-&gt; IOEnv (Env TcGblEnv TcLclEnv) b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">TcGblEnv -&gt; TcRef [(ForeignSrcLang, String)]
</span><a href="GHC.Tc.Types.html#tcg_th_foreign_files"><span class="hs-identifier hs-var">tcg_th_foreign_files</span></a></span><span> </span><span class="annot"><span class="annottext">TcRnIf TcGblEnv TcLclEnv TcGblEnv
forall gbl lcl. TcRnIf gbl lcl gbl
</span><a href="GHC.Tc.Utils.Monad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a></span><span>
</span><span id="line-1491"></span><span>    </span><span class="annot"><a href="GHC.Tc.Types.TcRef.html#updTcRef"><span class="hs-identifier hs-type">updTcRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160310"><span class="hs-identifier hs-type">var</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">lang</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">fp</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph">:</span></span><span class="hs-special">)</span><span>
</span><span id="line-1492"></span><span>
</span><span id="line-1493"></span><span>  </span><span id="local-6989586621683160316"><span class="annot"><span class="annottext">qAddModFinalizer :: Q () -&gt; TcRn ()
</span><a href="#local-6989586621683160316"><span class="hs-identifier hs-var hs-var hs-var">qAddModFinalizer</span></a></span></span><span> </span><span id="local-6989586621683160318"><span class="annot"><span class="annottext">Q ()
</span><a href="#local-6989586621683160318"><span class="hs-identifier hs-var">fin</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1494"></span><span>      </span><span id="local-6989586621683160319"><span class="annot"><a href="#local-6989586621683160319"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (RemoteRef (Q ()))
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (RemoteRef (Q ()))
forall a. IO a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (RemoteRef (Q ()))
 -&gt; IOEnv (Env TcGblEnv TcLclEnv) (RemoteRef (Q ())))
-&gt; IO (RemoteRef (Q ()))
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (RemoteRef (Q ()))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Q () -&gt; IO (RemoteRef (Q ()))
forall a. a -&gt; IO (RemoteRef a)
</span><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html#mkRemoteRef"><span class="hs-identifier hs-var">mkRemoteRef</span></a></span><span> </span><span class="annot"><span class="annottext">Q ()
</span><a href="#local-6989586621683160318"><span class="hs-identifier hs-var">fin</span></a></span><span>
</span><span id="line-1495"></span><span>      </span><span id="local-6989586621683160321"><span class="annot"><a href="#local-6989586621683160321"><span class="hs-identifier hs-var">fref</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html#mkForeignRef"><span class="hs-identifier hs-type">mkForeignRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160319"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html#freeRemoteRef"><span class="hs-identifier hs-type">freeRemoteRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160319"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1496"></span><span>      </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#addModFinalizerRef"><span class="hs-identifier hs-type">addModFinalizerRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160321"><span class="hs-identifier hs-type">fref</span></a></span><span>
</span><span id="line-1497"></span><span>
</span><span id="line-1498"></span><span>  </span><span id="local-6989586621683160333"><span class="annot"><span class="annottext">qAddCorePlugin :: String -&gt; TcRn ()
</span><a href="#local-6989586621683160333"><span class="hs-identifier hs-var hs-var hs-var">qAddCorePlugin</span></a></span></span><span> </span><span id="local-6989586621683160335"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160335"><span class="hs-identifier hs-var">plugin</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1499"></span><span>      </span><span id="local-6989586621683160336"><span class="annot"><a href="#local-6989586621683160336"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcRnIf TcGblEnv TcLclEnv HscEnv
forall gbl lcl. TcRnIf gbl lcl HscEnv
</span><a href="GHC.Tc.Utils.Monad.html#getTopEnv"><span class="hs-identifier hs-var">getTopEnv</span></a></span><span>
</span><span id="line-1500"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683160337"><span class="annot"><a href="#local-6989586621683160337"><span class="hs-identifier hs-var hs-var">fc</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; FinderCache
</span><a href="GHC.Driver.Env.Types.html#hsc_FC"><span class="hs-identifier hs-var">hsc_FC</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683160336"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-1501"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683160339"><span class="annot"><a href="#local-6989586621683160339"><span class="hs-identifier hs-var hs-var">home_unit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; HomeUnit
</span><a href="GHC.Driver.Env.html#hsc_home_unit"><span class="hs-identifier hs-var">hsc_home_unit</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683160336"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-1502"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683160341"><span class="annot"><a href="#local-6989586621683160341"><span class="hs-identifier hs-var hs-var">dflags</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; DynFlags
</span><a href="GHC.Driver.Env.Types.html#hsc_dflags"><span class="hs-identifier hs-var">hsc_dflags</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683160336"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-1503"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683160343"><span class="annot"><a href="#local-6989586621683160343"><span class="hs-identifier hs-var hs-var">fopts</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; FinderOpts
</span><a href="GHC.Driver.Config.Finder.html#initFinderOpts"><span class="hs-identifier hs-var">initFinderOpts</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683160341"><span class="hs-identifier hs-var">dflags</span></a></span><span>
</span><span id="line-1504"></span><span>      </span><span id="local-6989586621683160345"><span class="annot"><a href="#local-6989586621683160345"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Unit.Finder.html#findHomeModule"><span class="hs-identifier hs-type">findHomeModule</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160337"><span class="hs-identifier hs-type">fc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160343"><span class="hs-identifier hs-type">fopts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160339"><span class="hs-identifier hs-type">home_unit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Module.Name.html#mkModuleName"><span class="hs-identifier hs-type">mkModuleName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160335"><span class="hs-identifier hs-type">plugin</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1505"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683160348"><span class="annot"><a href="#local-6989586621683160348"><span class="hs-identifier hs-var hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">THError -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnTHError"><span class="hs-identifier hs-var">TcRnTHError</span></a></span><span> </span><span class="annot"><span class="annottext">(THError -&gt; TcRnMessage) -&gt; THError -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; THError
</span><a href="GHC.Tc.Errors.Types.html#AddInvalidCorePlugin"><span class="hs-identifier hs-var">AddInvalidCorePlugin</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160335"><span class="hs-identifier hs-var">plugin</span></a></span><span>
</span><span id="line-1506"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683160345"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1507"></span><span>        </span><span class="annot"><a href="GHC.Unit.Finder.Types.html#Found"><span class="hs-identifier hs-type">Found</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; TcRn ()
</span><a href="GHC.Tc.Utils.Monad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a></span><span> </span><span class="annot"><span class="annottext">TcRnMessage
</span><a href="#local-6989586621683160348"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-1508"></span><span>        </span><span class="annot"><a href="GHC.Unit.Finder.Types.html#FoundMultiple"><span class="hs-identifier hs-type">FoundMultiple</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; TcRn ()
</span><a href="GHC.Tc.Utils.Monad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a></span><span> </span><span class="annot"><span class="annottext">TcRnMessage
</span><a href="#local-6989586621683160348"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-1509"></span><span>        </span><span class="annot"><span class="annottext">FindResult
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcRn ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1510"></span><span>      </span><span id="local-6989586621683160352"><span class="annot"><a href="#local-6989586621683160352"><span class="hs-identifier hs-var">th_coreplugins_var</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#tcg_th_coreplugins"><span class="hs-identifier hs-var">tcg_th_coreplugins</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#getGblEnv"><span class="hs-identifier hs-type">getGblEnv</span></a></span><span>
</span><span id="line-1511"></span><span>      </span><span class="annot"><a href="GHC.Tc.Types.TcRef.html#updTcRef"><span class="hs-identifier hs-type">updTcRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160352"><span class="hs-identifier hs-type">th_coreplugins_var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">plugin</span></span><span class="annot"><span class="hs-glyph">:</span></span><span class="hs-special">)</span><span>
</span><span id="line-1512"></span><span>
</span><span id="line-1513"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">qGetQ</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621683160355"><span class="annot"><a href="#local-6989586621683160355"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Typeable</span></span><span> </span><span class="annot"><a href="#local-6989586621683160355"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621683160355"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1514"></span><span>  </span><span id="local-6989586621683160369"><span class="annot"><span class="annottext">qGetQ :: forall a. Typeable a =&gt; TcM (Maybe a)
</span><span class="hs-identifier hs-var hs-var hs-var">qGetQ</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1515"></span><span>      </span><span id="local-6989586621683160370"><span class="annot"><a href="#local-6989586621683160370"><span class="hs-identifier hs-var">th_state_var</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TcGblEnv -&gt; TcRef (Map TypeRep Dynamic))
-&gt; TcRnIf TcGblEnv TcLclEnv TcGblEnv
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (TcRef (Map TypeRep Dynamic))
forall a b.
(a -&gt; b)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) a
-&gt; IOEnv (Env TcGblEnv TcLclEnv) b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">TcGblEnv -&gt; TcRef (Map TypeRep Dynamic)
</span><a href="GHC.Tc.Types.html#tcg_th_state"><span class="hs-identifier hs-var">tcg_th_state</span></a></span><span> </span><span class="annot"><span class="annottext">TcRnIf TcGblEnv TcLclEnv TcGblEnv
forall gbl lcl. TcRnIf gbl lcl gbl
</span><a href="GHC.Tc.Utils.Monad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a></span><span>
</span><span id="line-1516"></span><span>      </span><span id="local-6989586621683160372"><span class="annot"><a href="#local-6989586621683160372"><span class="hs-identifier hs-var">th_state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TcRef.html#readTcRef"><span class="hs-identifier hs-type">readTcRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160370"><span class="hs-identifier hs-type">th_state_var</span></a></span><span>
</span><span id="line-1517"></span><span>      </span><span class="hs-comment">-- See #10596 for why we use a scoped type variable here.</span><span>
</span><span id="line-1518"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Map.Internal.html#lookup"><span class="hs-identifier hs-type">Map.lookup</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">typeRep</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Proxy</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Proxy</span></span><span> </span><span class="annot"><a href="#local-6989586621683160355"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683160372"><span class="hs-identifier hs-type">th_state</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">fromDynamic</span></span><span class="hs-special">)</span><span>
</span><span id="line-1519"></span><span>
</span><span id="line-1520"></span><span>  </span><span id="local-6989586621683160382"><span class="annot"><span class="annottext">qPutQ :: forall a. Typeable a =&gt; a -&gt; TcRn ()
</span><a href="#local-6989586621683160382"><span class="hs-identifier hs-var hs-var hs-var">qPutQ</span></a></span></span><span> </span><span id="local-6989586621683160384"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683160384"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1521"></span><span>      </span><span id="local-6989586621683160385"><span class="annot"><a href="#local-6989586621683160385"><span class="hs-identifier hs-var">th_state_var</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TcGblEnv -&gt; TcRef (Map TypeRep Dynamic))
-&gt; TcRnIf TcGblEnv TcLclEnv TcGblEnv
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (TcRef (Map TypeRep Dynamic))
forall a b.
(a -&gt; b)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) a
-&gt; IOEnv (Env TcGblEnv TcLclEnv) b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">TcGblEnv -&gt; TcRef (Map TypeRep Dynamic)
</span><a href="GHC.Tc.Types.html#tcg_th_state"><span class="hs-identifier hs-var">tcg_th_state</span></a></span><span> </span><span class="annot"><span class="annottext">TcRnIf TcGblEnv TcLclEnv TcGblEnv
forall gbl lcl. TcRnIf gbl lcl gbl
</span><a href="GHC.Tc.Utils.Monad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a></span><span>
</span><span id="line-1522"></span><span>      </span><span class="annot"><a href="GHC.Tc.Types.TcRef.html#updTcRef"><span class="hs-identifier hs-type">updTcRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160385"><span class="hs-identifier hs-type">th_state_var</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621683160386"><span class="annot"><span class="annottext">Map TypeRep Dynamic
</span><a href="#local-6989586621683160386"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TypeRep -&gt; Dynamic -&gt; Map TypeRep Dynamic -&gt; Map TypeRep Dynamic
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><a href="../../containers-0.7-5a8f/src/Data.Map.Internal.html#insert"><span class="hs-identifier hs-var">Map.insert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; TypeRep
forall a. Typeable a =&gt; a -&gt; TypeRep
</span><span class="hs-identifier hs-var">typeOf</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683160384"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Dynamic
forall a. Typeable a =&gt; a -&gt; Dynamic
</span><span class="hs-identifier hs-var">toDyn</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683160384"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map TypeRep Dynamic
</span><a href="#local-6989586621683160386"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1523"></span><span>
</span><span id="line-1524"></span><span>  </span><span id="local-6989586621683160388"><span class="annot"><span class="annottext">qIsExtEnabled :: Extension -&gt; TcM Bool
</span><a href="#local-6989586621683160388"><span class="hs-identifier hs-var hs-var hs-var">qIsExtEnabled</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Extension -&gt; TcM Bool
forall gbl lcl. Extension -&gt; TcRnIf gbl lcl Bool
</span><a href="GHC.Tc.Utils.Monad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a></span><span>
</span><span id="line-1525"></span><span>
</span><span id="line-1526"></span><span>  </span><span id="local-6989586621683160394"><span class="annot"><span class="annottext">qExtsEnabled :: TcM [Extension]
</span><a href="#local-6989586621683160394"><span class="hs-identifier hs-var hs-var hs-var">qExtsEnabled</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1527"></span><span>    </span><span class="annot"><span class="annottext">EnumSet Extension -&gt; [Extension]
forall a. Enum a =&gt; EnumSet a -&gt; [a]
</span><a href="GHC.Data.EnumSet.html#toList"><span class="hs-identifier hs-var">EnumSet.toList</span></a></span><span> </span><span class="annot"><span class="annottext">(EnumSet Extension -&gt; [Extension])
-&gt; (HscEnv -&gt; EnumSet Extension) -&gt; HscEnv -&gt; [Extension]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; EnumSet Extension
</span><a href="GHC.Driver.DynFlags.html#extensionFlags"><span class="hs-identifier hs-var">extensionFlags</span></a></span><span> </span><span class="annot"><span class="annottext">(DynFlags -&gt; EnumSet Extension)
-&gt; (HscEnv -&gt; DynFlags) -&gt; HscEnv -&gt; EnumSet Extension
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; DynFlags
</span><a href="GHC.Driver.Env.Types.html#hsc_dflags"><span class="hs-identifier hs-var">hsc_dflags</span></a></span><span> </span><span class="annot"><span class="annottext">(HscEnv -&gt; [Extension])
-&gt; TcRnIf TcGblEnv TcLclEnv HscEnv -&gt; TcM [Extension]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TcRnIf TcGblEnv TcLclEnv HscEnv
forall gbl lcl. TcRnIf gbl lcl HscEnv
</span><a href="GHC.Tc.Utils.Monad.html#getTopEnv"><span class="hs-identifier hs-var">getTopEnv</span></a></span><span>
</span><span id="line-1528"></span><span>
</span><span id="line-1529"></span><span>  </span><span id="local-6989586621683160410"><span class="annot"><span class="annottext">qPutDoc :: DocLoc -&gt; String -&gt; TcRn ()
</span><a href="#local-6989586621683160410"><span class="hs-identifier hs-var hs-var hs-var">qPutDoc</span></a></span></span><span> </span><span id="local-6989586621683160412"><span class="annot"><span class="annottext">DocLoc
</span><a href="#local-6989586621683160412"><span class="hs-identifier hs-var">doc_loc</span></a></span></span><span> </span><span id="local-6989586621683160413"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160413"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1530"></span><span>    </span><span id="local-6989586621683160414"><span class="annot"><a href="#local-6989586621683160414"><span class="hs-identifier hs-var">th_doc_var</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcGblEnv -&gt; TcRef THDocs
</span><a href="GHC.Tc.Types.html#tcg_th_docs"><span class="hs-identifier hs-var">tcg_th_docs</span></a></span><span> </span><span class="annot"><span class="annottext">(TcGblEnv -&gt; TcRef THDocs)
-&gt; TcRnIf TcGblEnv TcLclEnv TcGblEnv
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (TcRef THDocs)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TcRnIf TcGblEnv TcLclEnv TcGblEnv
forall gbl lcl. TcRnIf gbl lcl gbl
</span><a href="GHC.Tc.Utils.Monad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a></span><span>
</span><span id="line-1531"></span><span>    </span><span id="local-6989586621683160416"><span class="annot"><a href="#local-6989586621683160416"><span class="hs-identifier hs-var">resolved_doc_loc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621683160417"><span class="hs-identifier hs-type">resolve_loc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160412"><span class="hs-identifier hs-type">doc_loc</span></a></span><span>
</span><span id="line-1532"></span><span>    </span><span id="local-6989586621683160418"><span class="annot"><a href="#local-6989586621683160418"><span class="hs-identifier hs-var">is_local</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621683160419"><span class="hs-identifier hs-type">checkLocalName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160416"><span class="hs-identifier hs-type">resolved_doc_loc</span></a></span><span>
</span><span id="line-1533"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">unless</span></span><span> </span><span class="annot"><a href="#local-6989586621683160418"><span class="hs-identifier hs-type">is_local</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#failWithTc"><span class="hs-identifier hs-type">failWithTc</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Tc.Errors.Types.html#TcRnTHError"><span class="hs-identifier hs-type">TcRnTHError</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Tc.Errors.Types.html#AddDocToNonLocalDefn"><span class="hs-identifier hs-type">AddDocToNonLocalDefn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160412"><span class="hs-identifier hs-type">doc_loc</span></a></span><span>
</span><span id="line-1534"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683160421"><span class="annot"><a href="#local-6989586621683160421"><span class="hs-identifier hs-var hs-var">ds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; HsDocString
</span><a href="GHC.Hs.DocString.html#mkGeneratedHsDocString"><span class="hs-identifier hs-var">mkGeneratedHsDocString</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160413"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1535"></span><span>        </span><span id="local-6989586621683160423"><span class="annot"><a href="#local-6989586621683160423"><span class="hs-identifier hs-var hs-var">hd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">P (GenLocated SrcSpanAnnN RdrName) -&gt; HsDocString -&gt; HsDoc GhcPs
</span><a href="GHC.Parser.HaddockLex.html#lexHsDoc"><span class="hs-identifier hs-var">lexHsDoc</span></a></span><span> </span><span class="annot"><span class="annottext">P (GenLocated SrcSpanAnnN RdrName)
</span><a href="GHC.Parser.html#parseIdentifier"><span class="hs-identifier hs-var">parseIdentifier</span></a></span><span> </span><span class="annot"><span class="annottext">HsDocString
</span><a href="#local-6989586621683160421"><span class="hs-identifier hs-var">ds</span></a></span><span>
</span><span id="line-1536"></span><span>    </span><span id="local-6989586621683160424"><span class="annot"><a href="#local-6989586621683160424"><span class="hs-identifier hs-var">hd'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Rename.Doc.html#rnHsDoc"><span class="hs-identifier hs-type">rnHsDoc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160423"><span class="hs-identifier hs-type">hd</span></a></span><span>
</span><span id="line-1537"></span><span>    </span><span class="annot"><a href="GHC.Tc.Types.TcRef.html#updTcRef"><span class="hs-identifier hs-type">updTcRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160414"><span class="hs-identifier hs-type">th_doc_var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Map.Internal.html#insert"><span class="hs-identifier hs-type">Map.insert</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160416"><span class="hs-identifier hs-type">resolved_doc_loc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160424"><span class="hs-identifier hs-type">hd'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1538"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1539"></span><span>      </span><span id="local-6989586621683160417"><span class="annot"><span class="annottext">resolve_loc :: DocLoc -&gt; IOEnv (Env TcGblEnv TcLclEnv) DocLoc
</span><a href="#local-6989586621683160417"><span class="hs-identifier hs-var hs-var">resolve_loc</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.DeclDoc</span></span><span> </span><span id="local-6989586621683160434"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160434"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; DocLoc
</span><a href="GHC.Tc.Types.html#DeclDoc"><span class="hs-identifier hs-var">DeclDoc</span></a></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; DocLoc)
-&gt; TcM Name -&gt; IOEnv (Env TcGblEnv TcLclEnv) DocLoc
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM Name
</span><a href="GHC.Tc.Gen.Splice.html#lookupThName"><span class="hs-identifier hs-var">lookupThName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160434"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1540"></span><span>      </span><span class="annot"><a href="#local-6989586621683160417"><span class="hs-identifier hs-var">resolve_loc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.ArgDoc</span></span><span> </span><span id="local-6989586621683160437"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160437"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621683160438"><span class="annot"><span class="annottext">SumArity
</span><a href="#local-6989586621683160438"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; SumArity -&gt; DocLoc
</span><a href="GHC.Tc.Types.html#ArgDoc"><span class="hs-identifier hs-var">ArgDoc</span></a></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; SumArity -&gt; DocLoc)
-&gt; TcM Name -&gt; IOEnv (Env TcGblEnv TcLclEnv) (SumArity -&gt; DocLoc)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM Name
</span><a href="GHC.Tc.Gen.Splice.html#lookupThName"><span class="hs-identifier hs-var">lookupThName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160437"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">IOEnv (Env TcGblEnv TcLclEnv) (SumArity -&gt; DocLoc)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) SumArity
-&gt; IOEnv (Env TcGblEnv TcLclEnv) DocLoc
forall a b.
IOEnv (Env TcGblEnv TcLclEnv) (a -&gt; b)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) a
-&gt; IOEnv (Env TcGblEnv TcLclEnv) b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SumArity -&gt; IOEnv (Env TcGblEnv TcLclEnv) SumArity
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">SumArity
</span><a href="#local-6989586621683160438"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-1541"></span><span>      </span><span class="annot"><a href="#local-6989586621683160417"><span class="hs-identifier hs-var">resolve_loc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.InstDoc</span></span><span> </span><span id="local-6989586621683160441"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683160441"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; DocLoc
</span><a href="GHC.Tc.Types.html#InstDoc"><span class="hs-identifier hs-var">InstDoc</span></a></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; DocLoc)
-&gt; TcM Name -&gt; IOEnv (Env TcGblEnv TcLclEnv) DocLoc
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Name) -&gt; TcM Name -&gt; TcM Name
forall a b.
(a -&gt; b)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) a
-&gt; IOEnv (Env TcGblEnv TcLclEnv) b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name
forall a. NamedThing a =&gt; a -&gt; Name
</span><a href="GHC.Types.Name.html#getName"><span class="hs-identifier hs-var">getName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; TcM Name
</span><a href="GHC.Tc.Gen.Splice.html#lookupThInstName"><span class="hs-identifier hs-var">lookupThInstName</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683160441"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1542"></span><span>      </span><span class="annot"><a href="#local-6989586621683160417"><span class="hs-identifier hs-var">resolve_loc</span></a></span><span> </span><span class="annot"><span class="annottext">DocLoc
</span><span class="hs-identifier hs-var">TH.ModuleDoc</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DocLoc -&gt; IOEnv (Env TcGblEnv TcLclEnv) DocLoc
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">DocLoc
</span><a href="GHC.Tc.Types.html#ModuleDoc"><span class="hs-identifier hs-var">ModuleDoc</span></a></span><span>
</span><span id="line-1543"></span><span>
</span><span id="line-1544"></span><span>      </span><span class="hs-comment">-- It doesn't make sense to add documentation to something not inside</span><span>
</span><span id="line-1545"></span><span>      </span><span class="hs-comment">-- the current module. So check for it!</span><span>
</span><span id="line-1546"></span><span>      </span><span id="local-6989586621683160419"><span class="annot"><span class="annottext">checkLocalName :: DocLoc -&gt; f Bool
</span><a href="#local-6989586621683160419"><span class="hs-identifier hs-var hs-var">checkLocalName</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.html#DeclDoc"><span class="hs-identifier hs-type">DeclDoc</span></a></span><span> </span><span id="local-6989586621683160465"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160465"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GenModule Unit -&gt; Name -&gt; Bool
</span><a href="GHC.Types.Name.html#nameIsLocalOrFrom"><span class="hs-identifier hs-var">nameIsLocalOrFrom</span></a></span><span> </span><span class="annot"><span class="annottext">(GenModule Unit -&gt; Name -&gt; Bool)
-&gt; f (GenModule Unit) -&gt; f (Name -&gt; Bool)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">f (GenModule Unit)
forall (m :: * -&gt; *). HasModule m =&gt; m (GenModule Unit)
</span><a href="GHC.Unit.Module.html#getModule"><span class="hs-identifier hs-var">getModule</span></a></span><span> </span><span class="annot"><span class="annottext">f (Name -&gt; Bool) -&gt; f Name -&gt; f Bool
forall a b. f (a -&gt; b) -&gt; f a -&gt; f b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; f Name
forall a. a -&gt; f a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160465"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1547"></span><span>      </span><span class="annot"><a href="#local-6989586621683160419"><span class="hs-identifier hs-var">checkLocalName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.html#ArgDoc"><span class="hs-identifier hs-type">ArgDoc</span></a></span><span> </span><span id="local-6989586621683160467"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160467"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><span class="annottext">SumArity
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GenModule Unit -&gt; Name -&gt; Bool
</span><a href="GHC.Types.Name.html#nameIsLocalOrFrom"><span class="hs-identifier hs-var">nameIsLocalOrFrom</span></a></span><span> </span><span class="annot"><span class="annottext">(GenModule Unit -&gt; Name -&gt; Bool)
-&gt; f (GenModule Unit) -&gt; f (Name -&gt; Bool)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">f (GenModule Unit)
forall (m :: * -&gt; *). HasModule m =&gt; m (GenModule Unit)
</span><a href="GHC.Unit.Module.html#getModule"><span class="hs-identifier hs-var">getModule</span></a></span><span> </span><span class="annot"><span class="annottext">f (Name -&gt; Bool) -&gt; f Name -&gt; f Bool
forall a b. f (a -&gt; b) -&gt; f a -&gt; f b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; f Name
forall a. a -&gt; f a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160467"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1548"></span><span>      </span><span class="annot"><a href="#local-6989586621683160419"><span class="hs-identifier hs-var">checkLocalName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.html#InstDoc"><span class="hs-identifier hs-type">InstDoc</span></a></span><span> </span><span id="local-6989586621683160468"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160468"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GenModule Unit -&gt; Name -&gt; Bool
</span><a href="GHC.Types.Name.html#nameIsLocalOrFrom"><span class="hs-identifier hs-var">nameIsLocalOrFrom</span></a></span><span> </span><span class="annot"><span class="annottext">(GenModule Unit -&gt; Name -&gt; Bool)
-&gt; f (GenModule Unit) -&gt; f (Name -&gt; Bool)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">f (GenModule Unit)
forall (m :: * -&gt; *). HasModule m =&gt; m (GenModule Unit)
</span><a href="GHC.Unit.Module.html#getModule"><span class="hs-identifier hs-var">getModule</span></a></span><span> </span><span class="annot"><span class="annottext">f (Name -&gt; Bool) -&gt; f Name -&gt; f Bool
forall a b. f (a -&gt; b) -&gt; f a -&gt; f b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; f Name
forall a. a -&gt; f a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160468"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1549"></span><span>      </span><span class="annot"><a href="#local-6989586621683160419"><span class="hs-identifier hs-var">checkLocalName</span></a></span><span> </span><span class="annot"><span class="annottext">DocLoc
</span><a href="GHC.Tc.Types.html#ModuleDoc"><span class="hs-identifier hs-var">ModuleDoc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; f Bool
forall a. a -&gt; f a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1550"></span><span>
</span><span id="line-1551"></span><span>
</span><span id="line-1552"></span><span>  </span><span id="local-6989586621683160480"><span class="annot"><span class="annottext">qGetDoc :: DocLoc -&gt; TcM (Maybe String)
</span><a href="#local-6989586621683160480"><span class="hs-identifier hs-var hs-var hs-var">qGetDoc</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.DeclDoc</span></span><span> </span><span id="local-6989586621683160482"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160482"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM Name
</span><a href="GHC.Tc.Gen.Splice.html#lookupThName"><span class="hs-identifier hs-var">lookupThName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160482"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">TcM Name -&gt; (Name -&gt; TcM (Maybe String)) -&gt; TcM (Maybe String)
forall a b.
IOEnv (Env TcGblEnv TcLclEnv) a
-&gt; (a -&gt; IOEnv (Env TcGblEnv TcLclEnv) b)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM (Maybe String)
</span><a href="GHC.Tc.Gen.Splice.html#lookupDeclDoc"><span class="hs-identifier hs-var">lookupDeclDoc</span></a></span><span>
</span><span id="line-1553"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">qGetDoc</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.InstDoc</span></span><span> </span><span id="local-6989586621683160484"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683160484"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcM Name
</span><a href="GHC.Tc.Gen.Splice.html#lookupThInstName"><span class="hs-identifier hs-var">lookupThInstName</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683160484"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">TcM Name -&gt; (Name -&gt; TcM (Maybe String)) -&gt; TcM (Maybe String)
forall a b.
IOEnv (Env TcGblEnv TcLclEnv) a
-&gt; (a -&gt; IOEnv (Env TcGblEnv TcLclEnv) b)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM (Maybe String)
</span><a href="GHC.Tc.Gen.Splice.html#lookupDeclDoc"><span class="hs-identifier hs-var">lookupDeclDoc</span></a></span><span>
</span><span id="line-1554"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">qGetDoc</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.ArgDoc</span></span><span> </span><span id="local-6989586621683160485"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160485"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621683160486"><span class="annot"><span class="annottext">SumArity
</span><a href="#local-6989586621683160486"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM Name
</span><a href="GHC.Tc.Gen.Splice.html#lookupThName"><span class="hs-identifier hs-var">lookupThName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160485"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">TcM Name -&gt; (Name -&gt; TcM (Maybe String)) -&gt; TcM (Maybe String)
forall a b.
IOEnv (Env TcGblEnv TcLclEnv) a
-&gt; (a -&gt; IOEnv (Env TcGblEnv TcLclEnv) b)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">SumArity -&gt; Name -&gt; TcM (Maybe String)
</span><a href="GHC.Tc.Gen.Splice.html#lookupArgDoc"><span class="hs-identifier hs-var">lookupArgDoc</span></a></span><span> </span><span class="annot"><span class="annottext">SumArity
</span><a href="#local-6989586621683160486"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-1555"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">qGetDoc</span></span><span> </span><span class="annot"><span class="annottext">DocLoc
</span><span class="hs-identifier hs-var">TH.ModuleDoc</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1556"></span><span>    </span><span id="local-6989586621683160488"><span class="annot"><a href="#local-6989586621683160488"><span class="hs-identifier hs-var">df</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IOEnv (Env TcGblEnv TcLclEnv) DynFlags
forall (m :: * -&gt; *). HasDynFlags m =&gt; m DynFlags
</span><a href="GHC.Driver.DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a></span><span>
</span><span id="line-1557"></span><span>    </span><span id="local-6989586621683160489"><span class="annot"><a href="#local-6989586621683160489"><span class="hs-identifier hs-var">docs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#getGblEnv"><span class="hs-identifier hs-type">getGblEnv</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&gt;&gt;=</span></span><span> </span><span class="annot"><a href="GHC.HsToCore.Docs.html#extractDocs"><span class="hs-identifier hs-type">extractDocs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160488"><span class="hs-identifier hs-type">df</span></a></span><span>
</span><span id="line-1558"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Hs.DocString.html#renderHsDocString"><span class="hs-identifier hs-type">renderHsDocString</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><a href="GHC.Hs.Doc.html#hsDocString"><span class="hs-identifier hs-var">hsDocString</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Hs.Doc.html#docs_mod_hdr"><span class="hs-identifier hs-var">docs_mod_hdr</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">=&lt;&lt;</span></span><span> </span><span class="annot"><a href="#local-6989586621683160489"><span class="hs-identifier hs-type">docs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1559"></span><span>
</span><span id="line-1560"></span><span class="hs-comment">-- | Looks up documentation for a declaration in first the current module,</span><span>
</span><span id="line-1561"></span><span class="hs-comment">-- otherwise tries to find it in another module via 'hscGetModuleInterface'.</span><span>
</span><span id="line-1562"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#lookupDeclDoc"><span class="hs-identifier hs-type">lookupDeclDoc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">)</span><span>
</span><span id="line-1563"></span><span id="lookupDeclDoc"><span class="annot"><span class="annottext">lookupDeclDoc :: Name -&gt; TcM (Maybe String)
</span><a href="GHC.Tc.Gen.Splice.html#lookupDeclDoc"><span class="hs-identifier hs-var hs-var">lookupDeclDoc</span></a></span></span><span> </span><span id="local-6989586621683160495"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160495"><span class="hs-identifier hs-var">nm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1564"></span><span>  </span><span id="local-6989586621683160496"><span class="annot"><a href="#local-6989586621683160496"><span class="hs-identifier hs-var">df</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IOEnv (Env TcGblEnv TcLclEnv) DynFlags
forall (m :: * -&gt; *). HasDynFlags m =&gt; m DynFlags
</span><a href="GHC.Driver.DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a></span><span>
</span><span id="line-1565"></span><span>  </span><span class="annot"><a href="GHC.Hs.Doc.html#Docs"><span class="hs-identifier hs-type">Docs</span></a></span><span class="hs-special">{</span><span id="local-6989586621683160498"><span class="annot"><a href="#local-6989586621683160498"><span class="hs-identifier hs-var hs-var">docs_decls</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">fromMaybe</span></span><span> </span><span class="annot"><a href="GHC.Hs.Doc.html#emptyDocs"><span class="hs-identifier hs-type">emptyDocs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#getGblEnv"><span class="hs-identifier hs-type">getGblEnv</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&gt;&gt;=</span></span><span> </span><span class="annot"><a href="GHC.HsToCore.Docs.html#extractDocs"><span class="hs-identifier hs-type">extractDocs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160496"><span class="hs-identifier hs-type">df</span></a></span><span>
</span><span id="line-1566"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Map.html#lookupUniqMap"><span class="hs-identifier hs-type">lookupUniqMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160498"><span class="hs-identifier hs-type">docs_decls</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160495"><span class="hs-identifier hs-type">nm</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1567"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683160502"><span class="annot"><span class="annottext">[WithHsDocIdentifiers HsDocString GhcRn]
</span><a href="#local-6989586621683160502"><span class="hs-identifier hs-var">doc</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe String -&gt; TcM (Maybe String)
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Maybe String -&gt; TcM (Maybe String))
-&gt; Maybe String -&gt; TcM (Maybe String)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe String
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[HsDocString] -&gt; String
</span><a href="GHC.Hs.DocString.html#renderHsDocStrings"><span class="hs-identifier hs-var">renderHsDocStrings</span></a></span><span> </span><span class="annot"><span class="annottext">([HsDocString] -&gt; String) -&gt; [HsDocString] -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(WithHsDocIdentifiers HsDocString GhcRn -&gt; HsDocString)
-&gt; [WithHsDocIdentifiers HsDocString GhcRn] -&gt; [HsDocString]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">WithHsDocIdentifiers HsDocString GhcRn -&gt; HsDocString
forall a pass. WithHsDocIdentifiers a pass -&gt; a
</span><a href="GHC.Hs.Doc.html#hsDocString"><span class="hs-identifier hs-var">hsDocString</span></a></span><span> </span><span class="annot"><span class="annottext">[WithHsDocIdentifiers HsDocString GhcRn]
</span><a href="#local-6989586621683160502"><span class="hs-identifier hs-var">doc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1568"></span><span>    </span><span class="annot"><span class="annottext">Maybe [WithHsDocIdentifiers HsDocString GhcRn]
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1569"></span><span>      </span><span class="hs-comment">-- Wasn't in the current module. Try searching other external ones!</span><span>
</span><span id="line-1570"></span><span>      </span><span id="local-6989586621683160504"><span class="annot"><a href="#local-6989586621683160504"><span class="hs-identifier hs-var">mIface</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM (Maybe ModIface)
</span><a href="GHC.Tc.Gen.Splice.html#getExternalModIface"><span class="hs-identifier hs-var">getExternalModIface</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160495"><span class="hs-identifier hs-var">nm</span></a></span><span>
</span><span id="line-1571"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683160504"><span class="hs-identifier hs-type">mIface</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1572"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683160506"><span class="annot"><span class="annottext">ModIface
</span><a href="#local-6989586621683160506"><span class="hs-identifier hs-var">iface</span></a></span></span><span>
</span><span id="line-1573"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="GHC.Hs.Doc.html#Docs"><span class="hs-identifier hs-type">Docs</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">docs_decls :: Docs -&gt; UniqMap Name [WithHsDocIdentifiers HsDocString GhcRn]
</span><a href="GHC.Hs.Doc.html#docs_decls"><span class="hs-identifier hs-var">docs_decls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683160507"><span class="annot"><span class="annottext">UniqMap Name [WithHsDocIdentifiers HsDocString GhcRn]
</span><a href="#local-6989586621683160507"><span class="hs-identifier hs-var">dmap</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ModIface -&gt; Maybe Docs
forall (phase :: ModIfacePhase). ModIface_ phase -&gt; Maybe Docs
</span><a href="GHC.Unit.Module.ModIface.html#mi_docs"><span class="hs-identifier hs-var">mi_docs</span></a></span><span> </span><span class="annot"><span class="annottext">ModIface
</span><a href="#local-6989586621683160506"><span class="hs-identifier hs-var">iface</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1574"></span><span>          </span><span class="annot"><span class="annottext">Maybe String -&gt; TcM (Maybe String)
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Maybe String -&gt; TcM (Maybe String))
-&gt; Maybe String -&gt; TcM (Maybe String)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[HsDocString] -&gt; String
</span><a href="GHC.Hs.DocString.html#renderHsDocStrings"><span class="hs-identifier hs-var">renderHsDocStrings</span></a></span><span> </span><span class="annot"><span class="annottext">([HsDocString] -&gt; String)
-&gt; ([WithHsDocIdentifiers HsDocString GhcRn] -&gt; [HsDocString])
-&gt; [WithHsDocIdentifiers HsDocString GhcRn]
-&gt; String
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(WithHsDocIdentifiers HsDocString GhcRn -&gt; HsDocString)
-&gt; [WithHsDocIdentifiers HsDocString GhcRn] -&gt; [HsDocString]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">WithHsDocIdentifiers HsDocString GhcRn -&gt; HsDocString
forall a pass. WithHsDocIdentifiers a pass -&gt; a
</span><a href="GHC.Hs.Doc.html#hsDocString"><span class="hs-identifier hs-var">hsDocString</span></a></span><span> </span><span class="annot"><span class="annottext">([WithHsDocIdentifiers HsDocString GhcRn] -&gt; String)
-&gt; Maybe [WithHsDocIdentifiers HsDocString GhcRn] -&gt; Maybe String
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">UniqMap Name [WithHsDocIdentifiers HsDocString GhcRn]
-&gt; Name -&gt; Maybe [WithHsDocIdentifiers HsDocString GhcRn]
forall k a. Uniquable k =&gt; UniqMap k a -&gt; k -&gt; Maybe a
</span><a href="GHC.Types.Unique.Map.html#lookupUniqMap"><span class="hs-identifier hs-var">lookupUniqMap</span></a></span><span> </span><span class="annot"><span class="annottext">UniqMap Name [WithHsDocIdentifiers HsDocString GhcRn]
</span><a href="#local-6989586621683160507"><span class="hs-identifier hs-var">dmap</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160495"><span class="hs-identifier hs-var">nm</span></a></span><span>
</span><span id="line-1575"></span><span>        </span><span class="annot"><span class="annottext">Maybe ModIface
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe String -&gt; TcM (Maybe String)
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Maybe String
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1576"></span><span>
</span><span id="line-1577"></span><span class="hs-comment">-- | Like 'lookupDeclDoc', looks up documentation for a function argument. If</span><span>
</span><span id="line-1578"></span><span class="hs-comment">-- it can't find any documentation for a function in this module, it tries to</span><span>
</span><span id="line-1579"></span><span class="hs-comment">-- find it in another module.</span><span>
</span><span id="line-1580"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#lookupArgDoc"><span class="hs-identifier hs-type">lookupArgDoc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">)</span><span>
</span><span id="line-1581"></span><span id="lookupArgDoc"><span class="annot"><span class="annottext">lookupArgDoc :: SumArity -&gt; Name -&gt; TcM (Maybe String)
</span><a href="GHC.Tc.Gen.Splice.html#lookupArgDoc"><span class="hs-identifier hs-var hs-var">lookupArgDoc</span></a></span></span><span> </span><span id="local-6989586621683160509"><span class="annot"><span class="annottext">SumArity
</span><a href="#local-6989586621683160509"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621683160510"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160510"><span class="hs-identifier hs-var">nm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1582"></span><span>  </span><span id="local-6989586621683160511"><span class="annot"><a href="#local-6989586621683160511"><span class="hs-identifier hs-var">df</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IOEnv (Env TcGblEnv TcLclEnv) DynFlags
forall (m :: * -&gt; *). HasDynFlags m =&gt; m DynFlags
</span><a href="GHC.Driver.DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a></span><span>
</span><span id="line-1583"></span><span>  </span><span class="annot"><a href="GHC.Hs.Doc.html#Docs"><span class="hs-identifier hs-type">Docs</span></a></span><span class="hs-special">{</span><span class="annot"><a href="GHC.Hs.Doc.html#docs_args"><span class="hs-identifier hs-var">docs_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683160513"><span class="annot"><a href="#local-6989586621683160513"><span class="hs-identifier hs-var">argDocs</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">fromMaybe</span></span><span> </span><span class="annot"><a href="GHC.Hs.Doc.html#emptyDocs"><span class="hs-identifier hs-type">emptyDocs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#getGblEnv"><span class="hs-identifier hs-type">getGblEnv</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&gt;&gt;=</span></span><span> </span><span class="annot"><a href="GHC.HsToCore.Docs.html#extractDocs"><span class="hs-identifier hs-type">extractDocs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160511"><span class="hs-identifier hs-type">df</span></a></span><span>
</span><span id="line-1584"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Map.html#lookupUniqMap"><span class="hs-identifier hs-type">lookupUniqMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160513"><span class="hs-identifier hs-type">argDocs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160510"><span class="hs-identifier hs-type">nm</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1585"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683160514"><span class="annot"><span class="annottext">IntMap (WithHsDocIdentifiers HsDocString GhcRn)
</span><a href="#local-6989586621683160514"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe String -&gt; TcM (Maybe String)
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Maybe String -&gt; TcM (Maybe String))
-&gt; Maybe String -&gt; TcM (Maybe String)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HsDocString -&gt; String
</span><a href="GHC.Hs.DocString.html#renderHsDocString"><span class="hs-identifier hs-var">renderHsDocString</span></a></span><span> </span><span class="annot"><span class="annottext">(HsDocString -&gt; String)
-&gt; (WithHsDocIdentifiers HsDocString GhcRn -&gt; HsDocString)
-&gt; WithHsDocIdentifiers HsDocString GhcRn
-&gt; String
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">WithHsDocIdentifiers HsDocString GhcRn -&gt; HsDocString
forall a pass. WithHsDocIdentifiers a pass -&gt; a
</span><a href="GHC.Hs.Doc.html#hsDocString"><span class="hs-identifier hs-var">hsDocString</span></a></span><span> </span><span class="annot"><span class="annottext">(WithHsDocIdentifiers HsDocString GhcRn -&gt; String)
-&gt; Maybe (WithHsDocIdentifiers HsDocString GhcRn) -&gt; Maybe String
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">SumArity
-&gt; IntMap (WithHsDocIdentifiers HsDocString GhcRn)
-&gt; Maybe (WithHsDocIdentifiers HsDocString GhcRn)
forall a. SumArity -&gt; IntMap a -&gt; Maybe a
</span><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#lookup"><span class="hs-identifier hs-var">IntMap.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">SumArity
</span><a href="#local-6989586621683160509"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap (WithHsDocIdentifiers HsDocString GhcRn)
</span><a href="#local-6989586621683160514"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-1586"></span><span>    </span><span class="annot"><span class="annottext">Maybe (IntMap (WithHsDocIdentifiers HsDocString GhcRn))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1587"></span><span>      </span><span id="local-6989586621683160516"><span class="annot"><a href="#local-6989586621683160516"><span class="hs-identifier hs-var">mIface</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM (Maybe ModIface)
</span><a href="GHC.Tc.Gen.Splice.html#getExternalModIface"><span class="hs-identifier hs-var">getExternalModIface</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160510"><span class="hs-identifier hs-var">nm</span></a></span><span>
</span><span id="line-1588"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683160516"><span class="hs-identifier hs-type">mIface</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1589"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683160517"><span class="annot"><span class="annottext">ModIface
</span><a href="#local-6989586621683160517"><span class="hs-identifier hs-var">iface</span></a></span></span><span>
</span><span id="line-1590"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="GHC.Hs.Doc.html#Docs"><span class="hs-identifier hs-type">Docs</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">docs_args :: Docs
-&gt; UniqMap Name (IntMap (WithHsDocIdentifiers HsDocString GhcRn))
</span><a href="GHC.Hs.Doc.html#docs_args"><span class="hs-identifier hs-var">docs_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683160518"><span class="annot"><span class="annottext">UniqMap Name (IntMap (WithHsDocIdentifiers HsDocString GhcRn))
</span><a href="#local-6989586621683160518"><span class="hs-identifier hs-var">amap</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ModIface -&gt; Maybe Docs
forall (phase :: ModIfacePhase). ModIface_ phase -&gt; Maybe Docs
</span><a href="GHC.Unit.Module.ModIface.html#mi_docs"><span class="hs-identifier hs-var">mi_docs</span></a></span><span> </span><span class="annot"><span class="annottext">ModIface
</span><a href="#local-6989586621683160517"><span class="hs-identifier hs-var">iface</span></a></span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1591"></span><span>          </span><span class="annot"><span class="annottext">Maybe String -&gt; TcM (Maybe String)
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Maybe String -&gt; TcM (Maybe String))
-&gt; Maybe String -&gt; TcM (Maybe String)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HsDocString -&gt; String
</span><a href="GHC.Hs.DocString.html#renderHsDocString"><span class="hs-identifier hs-var">renderHsDocString</span></a></span><span> </span><span class="annot"><span class="annottext">(HsDocString -&gt; String)
-&gt; (WithHsDocIdentifiers HsDocString GhcRn -&gt; HsDocString)
-&gt; WithHsDocIdentifiers HsDocString GhcRn
-&gt; String
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">WithHsDocIdentifiers HsDocString GhcRn -&gt; HsDocString
forall a pass. WithHsDocIdentifiers a pass -&gt; a
</span><a href="GHC.Hs.Doc.html#hsDocString"><span class="hs-identifier hs-var">hsDocString</span></a></span><span> </span><span class="annot"><span class="annottext">(WithHsDocIdentifiers HsDocString GhcRn -&gt; String)
-&gt; Maybe (WithHsDocIdentifiers HsDocString GhcRn) -&gt; Maybe String
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UniqMap Name (IntMap (WithHsDocIdentifiers HsDocString GhcRn))
-&gt; Name -&gt; Maybe (IntMap (WithHsDocIdentifiers HsDocString GhcRn))
forall k a. Uniquable k =&gt; UniqMap k a -&gt; k -&gt; Maybe a
</span><a href="GHC.Types.Unique.Map.html#lookupUniqMap"><span class="hs-identifier hs-var">lookupUniqMap</span></a></span><span> </span><span class="annot"><span class="annottext">UniqMap Name (IntMap (WithHsDocIdentifiers HsDocString GhcRn))
</span><a href="#local-6989586621683160518"><span class="hs-identifier hs-var">amap</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160510"><span class="hs-identifier hs-var">nm</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (IntMap (WithHsDocIdentifiers HsDocString GhcRn))
-&gt; (IntMap (WithHsDocIdentifiers HsDocString GhcRn)
    -&gt; Maybe (WithHsDocIdentifiers HsDocString GhcRn))
-&gt; Maybe (WithHsDocIdentifiers HsDocString GhcRn)
forall a b. Maybe a -&gt; (a -&gt; Maybe b) -&gt; Maybe b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">SumArity
-&gt; IntMap (WithHsDocIdentifiers HsDocString GhcRn)
-&gt; Maybe (WithHsDocIdentifiers HsDocString GhcRn)
forall a. SumArity -&gt; IntMap a -&gt; Maybe a
</span><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#lookup"><span class="hs-identifier hs-var">IntMap.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">SumArity
</span><a href="#local-6989586621683160509"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1592"></span><span>        </span><span class="annot"><span class="annottext">Maybe ModIface
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe String -&gt; TcM (Maybe String)
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Maybe String
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1593"></span><span>
</span><span id="line-1594"></span><span class="annot"><span class="hs-comment">-- | Returns the module a Name belongs to, if it is isn't local.</span></span><span>
</span><span id="line-1595"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#getExternalModIface"><span class="hs-identifier hs-type">getExternalModIface</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModIface.html#ModIface"><span class="hs-identifier hs-type">ModIface</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1596"></span><span id="getExternalModIface"><span class="annot"><span class="annottext">getExternalModIface :: Name -&gt; TcM (Maybe ModIface)
</span><a href="GHC.Tc.Gen.Splice.html#getExternalModIface"><span class="hs-identifier hs-var hs-var">getExternalModIface</span></a></span></span><span> </span><span id="local-6989586621683160519"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160519"><span class="hs-identifier hs-var">nm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1597"></span><span>  </span><span id="local-6989586621683160520"><span class="annot"><a href="#local-6989586621683160520"><span class="hs-identifier hs-var">isLocal</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">GenModule Unit -&gt; Name -&gt; Bool
</span><a href="GHC.Types.Name.html#nameIsLocalOrFrom"><span class="hs-identifier hs-var">nameIsLocalOrFrom</span></a></span><span> </span><span class="annot"><span class="annottext">(GenModule Unit -&gt; Name -&gt; Bool)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (GenModule Unit)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (Name -&gt; Bool)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IOEnv (Env TcGblEnv TcLclEnv) (GenModule Unit)
forall (m :: * -&gt; *). HasModule m =&gt; m (GenModule Unit)
</span><a href="GHC.Unit.Module.html#getModule"><span class="hs-identifier hs-var">getModule</span></a></span><span> </span><span class="annot"><span class="annottext">IOEnv (Env TcGblEnv TcLclEnv) (Name -&gt; Bool)
-&gt; TcM Name -&gt; TcM Bool
forall a b.
IOEnv (Env TcGblEnv TcLclEnv) (a -&gt; b)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) a
-&gt; IOEnv (Env TcGblEnv TcLclEnv) b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM Name
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160519"><span class="hs-identifier hs-var">nm</span></a></span><span>
</span><span id="line-1598"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621683160520"><span class="hs-identifier hs-type">isLocal</span></a></span><span>
</span><span id="line-1599"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span>
</span><span id="line-1600"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#nameModule_maybe"><span class="hs-identifier hs-type">nameModule_maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160519"><span class="hs-identifier hs-type">nm</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1601"></span><span>          </span><span class="annot"><span class="annottext">Maybe (GenModule Unit)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ModIface -&gt; TcM (Maybe ModIface)
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Maybe ModIface
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1602"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683160522"><span class="annot"><span class="annottext">GenModule Unit
</span><a href="#local-6989586621683160522"><span class="hs-identifier hs-var">modNm</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1603"></span><span>            </span><span id="local-6989586621683160523"><span class="annot"><a href="#local-6989586621683160523"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcRnIf TcGblEnv TcLclEnv HscEnv
forall gbl lcl. TcRnIf gbl lcl HscEnv
</span><a href="GHC.Tc.Utils.Monad.html#getTopEnv"><span class="hs-identifier hs-var">getTopEnv</span></a></span><span>
</span><span id="line-1604"></span><span>            </span><span id="local-6989586621683160524"><span class="annot"><a href="#local-6989586621683160524"><span class="hs-identifier hs-var">iface</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Driver.Main.html#hscGetModuleInterface"><span class="hs-identifier hs-type">hscGetModuleInterface</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160523"><span class="hs-identifier hs-type">hsc_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160522"><span class="hs-identifier hs-type">modNm</span></a></span><span>
</span><span id="line-1605"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="#local-6989586621683160524"><span class="hs-identifier hs-type">iface</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1606"></span><span>
</span><span id="line-1607"></span><span class="annot"><span class="hs-comment">-- | Find the GHC name of the first instance that matches the TH type</span></span><span>
</span><span id="line-1608"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#lookupThInstName"><span class="hs-identifier hs-type">lookupThInstName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Type</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span>
</span><span id="line-1609"></span><span id="lookupThInstName"><span class="annot"><span class="annottext">lookupThInstName :: Type -&gt; TcM Name
</span><a href="GHC.Tc.Gen.Splice.html#lookupThInstName"><span class="hs-identifier hs-var hs-var">lookupThInstName</span></a></span></span><span> </span><span id="local-6989586621683160525"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683160525"><span class="hs-identifier hs-var">th_type</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1610"></span><span>  </span><span id="local-6989586621683160526"><span class="annot"><a href="#local-6989586621683160526"><span class="hs-identifier hs-var">cls_name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcM Name
</span><a href="#local-6989586621683160527"><span class="hs-identifier hs-var">inst_cls_name</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683160525"><span class="hs-identifier hs-var">th_type</span></a></span><span>
</span><span id="line-1611"></span><span>  </span><span id="local-6989586621683160528"><span class="annot"><a href="#local-6989586621683160528"><span class="hs-identifier hs-var">insts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyInstances%27"><span class="hs-identifier hs-type">reifyInstances'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160526"><span class="hs-identifier hs-type">cls_name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683160530"><span class="hs-identifier hs-type">inst_arg_types</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160525"><span class="hs-identifier hs-type">th_type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1612"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683160528"><span class="hs-identifier hs-type">insts</span></a></span><span> </span><span class="hs-keyword">of</span><span>   </span><span class="hs-comment">-- This expands any type synonyms</span><span>
</span><span id="line-1613"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Class
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683160531"><span class="annot"><span class="annottext">ClsInst
</span><a href="#local-6989586621683160531"><span class="hs-identifier hs-var">inst</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[ClsInst]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM Name
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; TcM Name) -&gt; Name -&gt; TcM Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ClsInst -&gt; Name
forall a. NamedThing a =&gt; a -&gt; Name
</span><a href="GHC.Types.Name.html#getName"><span class="hs-identifier hs-var">getName</span></a></span><span> </span><span class="annot"><span class="annottext">ClsInst
</span><a href="#local-6989586621683160531"><span class="hs-identifier hs-var">inst</span></a></span><span>
</span><span id="line-1614"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Class
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcM Name
</span><a href="#local-6989586621683160532"><span class="hs-identifier hs-var">noMatches</span></a></span><span>
</span><span id="line-1615"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683160533"><span class="annot"><span class="annottext">FamInst
</span><a href="#local-6989586621683160533"><span class="hs-identifier hs-var">inst</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[FamInst]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM Name
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; TcM Name) -&gt; Name -&gt; TcM Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FamInst -&gt; Name
forall a. NamedThing a =&gt; a -&gt; Name
</span><a href="GHC.Types.Name.html#getName"><span class="hs-identifier hs-var">getName</span></a></span><span> </span><span class="annot"><span class="annottext">FamInst
</span><a href="#local-6989586621683160533"><span class="hs-identifier hs-var">inst</span></a></span><span>
</span><span id="line-1616"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcM Name
</span><a href="#local-6989586621683160532"><span class="hs-identifier hs-var">noMatches</span></a></span><span>
</span><span id="line-1617"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1618"></span><span>    </span><span id="local-6989586621683160532"><span class="annot"><span class="annottext">noMatches :: TcM Name
</span><a href="#local-6989586621683160532"><span class="hs-identifier hs-var hs-var">noMatches</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; TcM Name
forall a. TcRnMessage -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; TcM Name) -&gt; TcRnMessage -&gt; TcM Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1619"></span><span>      </span><span class="annot"><span class="annottext">THError -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnTHError"><span class="hs-identifier hs-var">TcRnTHError</span></a></span><span> </span><span class="annot"><span class="annottext">(THError -&gt; TcRnMessage) -&gt; THError -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; LookupTHInstNameErrReason -&gt; THError
</span><a href="GHC.Tc.Errors.Types.html#FailedToLookupThInstName"><span class="hs-identifier hs-var">FailedToLookupThInstName</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683160525"><span class="hs-identifier hs-var">th_type</span></a></span><span> </span><span class="annot"><span class="annottext">LookupTHInstNameErrReason
</span><a href="GHC.Tc.Errors.Types.html#NoMatchesFound"><span class="hs-identifier hs-var">NoMatchesFound</span></a></span><span>
</span><span id="line-1620"></span><span>
</span><span id="line-1621"></span><span>    </span><span class="hs-comment">-- Get the name of the class for the instance we are documenting</span><span>
</span><span id="line-1622"></span><span>    </span><span class="hs-comment">-- &gt; inst_cls_name (Monad Maybe) == Monad</span><span>
</span><span id="line-1623"></span><span>    </span><span class="hs-comment">-- &gt; inst_cls_name C = C</span><span>
</span><span id="line-1624"></span><span>    </span><span class="annot"><a href="#local-6989586621683160527"><span class="hs-identifier hs-type">inst_cls_name</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Type</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Name</span></span><span>
</span><span id="line-1625"></span><span>    </span><span id="local-6989586621683160527"><span class="annot"><span class="annottext">inst_cls_name :: Type -&gt; TcM Name
</span><a href="#local-6989586621683160527"><span class="hs-identifier hs-var hs-var">inst_cls_name</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.AppT</span></span><span> </span><span id="local-6989586621683160537"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683160537"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcM Name
</span><a href="#local-6989586621683160527"><span class="hs-identifier hs-var">inst_cls_name</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683160537"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-1626"></span><span>    </span><span class="annot"><a href="#local-6989586621683160527"><span class="hs-identifier hs-var">inst_cls_name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.SigT</span></span><span> </span><span id="local-6989586621683160539"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683160539"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcM Name
</span><a href="#local-6989586621683160527"><span class="hs-identifier hs-var">inst_cls_name</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683160539"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1627"></span><span>    </span><span class="annot"><a href="#local-6989586621683160527"><span class="hs-identifier hs-var">inst_cls_name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.VarT</span></span><span> </span><span id="local-6989586621683160541"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160541"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM Name
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160541"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1628"></span><span>    </span><span class="annot"><a href="#local-6989586621683160527"><span class="hs-identifier hs-var">inst_cls_name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.ConT</span></span><span> </span><span id="local-6989586621683160543"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160543"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM Name
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160543"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1629"></span><span>    </span><span class="annot"><a href="#local-6989586621683160527"><span class="hs-identifier hs-var">inst_cls_name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.PromotedT</span></span><span> </span><span id="local-6989586621683160545"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160545"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM Name
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160545"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1630"></span><span>    </span><span class="annot"><a href="#local-6989586621683160527"><span class="hs-identifier hs-var">inst_cls_name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.InfixT</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683160547"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160547"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM Name
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160547"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1631"></span><span>    </span><span class="annot"><a href="#local-6989586621683160527"><span class="hs-identifier hs-var">inst_cls_name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.UInfixT</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683160549"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160549"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM Name
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160549"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1632"></span><span>    </span><span class="annot"><a href="#local-6989586621683160527"><span class="hs-identifier hs-var">inst_cls_name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.PromotedInfixT</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683160551"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160551"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM Name
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160551"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1633"></span><span>    </span><span class="annot"><a href="#local-6989586621683160527"><span class="hs-identifier hs-var">inst_cls_name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.PromotedUInfixT</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683160553"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160553"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM Name
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160553"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1634"></span><span>    </span><span class="annot"><a href="#local-6989586621683160527"><span class="hs-identifier hs-var">inst_cls_name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.ParensT</span></span><span> </span><span id="local-6989586621683160555"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683160555"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcM Name
</span><a href="#local-6989586621683160527"><span class="hs-identifier hs-var">inst_cls_name</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683160555"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-1635"></span><span>
</span><span id="line-1636"></span><span>    </span><span class="annot"><a href="#local-6989586621683160527"><span class="hs-identifier hs-var">inst_cls_name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.ForallT</span></span><span> </span><span class="annot"><span class="annottext">[TyVarBndr Specificity]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcM Name
</span><a href="#local-6989586621683160557"><span class="hs-identifier hs-var">inst_cls_name_err</span></a></span><span>
</span><span id="line-1637"></span><span>    </span><span class="annot"><a href="#local-6989586621683160527"><span class="hs-identifier hs-var">inst_cls_name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.ForallVisT</span></span><span> </span><span class="annot"><span class="annottext">[TyVarBndr ()]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcM Name
</span><a href="#local-6989586621683160557"><span class="hs-identifier hs-var">inst_cls_name_err</span></a></span><span>
</span><span id="line-1638"></span><span>    </span><span class="annot"><a href="#local-6989586621683160527"><span class="hs-identifier hs-var">inst_cls_name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.AppKindT</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcM Name
</span><a href="#local-6989586621683160557"><span class="hs-identifier hs-var">inst_cls_name_err</span></a></span><span>
</span><span id="line-1639"></span><span>    </span><span class="annot"><a href="#local-6989586621683160527"><span class="hs-identifier hs-var">inst_cls_name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.TupleT</span></span><span> </span><span class="annot"><span class="annottext">SumArity
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcM Name
</span><a href="#local-6989586621683160557"><span class="hs-identifier hs-var">inst_cls_name_err</span></a></span><span>
</span><span id="line-1640"></span><span>    </span><span class="annot"><a href="#local-6989586621683160527"><span class="hs-identifier hs-var">inst_cls_name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.UnboxedTupleT</span></span><span> </span><span class="annot"><span class="annottext">SumArity
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcM Name
</span><a href="#local-6989586621683160557"><span class="hs-identifier hs-var">inst_cls_name_err</span></a></span><span>
</span><span id="line-1641"></span><span>    </span><span class="annot"><a href="#local-6989586621683160527"><span class="hs-identifier hs-var">inst_cls_name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.UnboxedSumT</span></span><span> </span><span class="annot"><span class="annottext">SumArity
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcM Name
</span><a href="#local-6989586621683160557"><span class="hs-identifier hs-var">inst_cls_name_err</span></a></span><span>
</span><span id="line-1642"></span><span>    </span><span class="annot"><a href="#local-6989586621683160527"><span class="hs-identifier hs-var">inst_cls_name</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier hs-var">TH.ArrowT</span></span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcM Name
</span><a href="#local-6989586621683160557"><span class="hs-identifier hs-var">inst_cls_name_err</span></a></span><span>
</span><span id="line-1643"></span><span>    </span><span class="annot"><a href="#local-6989586621683160527"><span class="hs-identifier hs-var">inst_cls_name</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier hs-var">TH.MulArrowT</span></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcM Name
</span><a href="#local-6989586621683160557"><span class="hs-identifier hs-var">inst_cls_name_err</span></a></span><span>
</span><span id="line-1644"></span><span>    </span><span class="annot"><a href="#local-6989586621683160527"><span class="hs-identifier hs-var">inst_cls_name</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier hs-var">TH.EqualityT</span></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcM Name
</span><a href="#local-6989586621683160557"><span class="hs-identifier hs-var">inst_cls_name_err</span></a></span><span>
</span><span id="line-1645"></span><span>    </span><span class="annot"><a href="#local-6989586621683160527"><span class="hs-identifier hs-var">inst_cls_name</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier hs-var">TH.ListT</span></span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcM Name
</span><a href="#local-6989586621683160557"><span class="hs-identifier hs-var">inst_cls_name_err</span></a></span><span>
</span><span id="line-1646"></span><span>    </span><span class="annot"><a href="#local-6989586621683160527"><span class="hs-identifier hs-var">inst_cls_name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.PromotedTupleT</span></span><span> </span><span class="annot"><span class="annottext">SumArity
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcM Name
</span><a href="#local-6989586621683160557"><span class="hs-identifier hs-var">inst_cls_name_err</span></a></span><span>
</span><span id="line-1647"></span><span>    </span><span class="annot"><a href="#local-6989586621683160527"><span class="hs-identifier hs-var">inst_cls_name</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier hs-var">TH.PromotedNilT</span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcM Name
</span><a href="#local-6989586621683160557"><span class="hs-identifier hs-var">inst_cls_name_err</span></a></span><span>
</span><span id="line-1648"></span><span>    </span><span class="annot"><a href="#local-6989586621683160527"><span class="hs-identifier hs-var">inst_cls_name</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier hs-var">TH.PromotedConsT</span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcM Name
</span><a href="#local-6989586621683160557"><span class="hs-identifier hs-var">inst_cls_name_err</span></a></span><span>
</span><span id="line-1649"></span><span>    </span><span class="annot"><a href="#local-6989586621683160527"><span class="hs-identifier hs-var">inst_cls_name</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier hs-var">TH.StarT</span></span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcM Name
</span><a href="#local-6989586621683160557"><span class="hs-identifier hs-var">inst_cls_name_err</span></a></span><span>
</span><span id="line-1650"></span><span>    </span><span class="annot"><a href="#local-6989586621683160527"><span class="hs-identifier hs-var">inst_cls_name</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier hs-var">TH.ConstraintT</span></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcM Name
</span><a href="#local-6989586621683160557"><span class="hs-identifier hs-var">inst_cls_name_err</span></a></span><span>
</span><span id="line-1651"></span><span>    </span><span class="annot"><a href="#local-6989586621683160527"><span class="hs-identifier hs-var">inst_cls_name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.LitT</span></span><span> </span><span class="annot"><span class="annottext">TyLit
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcM Name
</span><a href="#local-6989586621683160557"><span class="hs-identifier hs-var">inst_cls_name_err</span></a></span><span>
</span><span id="line-1652"></span><span>    </span><span class="annot"><a href="#local-6989586621683160527"><span class="hs-identifier hs-var">inst_cls_name</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier hs-var">TH.WildCardT</span></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcM Name
</span><a href="#local-6989586621683160557"><span class="hs-identifier hs-var">inst_cls_name_err</span></a></span><span>
</span><span id="line-1653"></span><span>    </span><span class="annot"><a href="#local-6989586621683160527"><span class="hs-identifier hs-var">inst_cls_name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.ImplicitParamT</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcM Name
</span><a href="#local-6989586621683160557"><span class="hs-identifier hs-var">inst_cls_name_err</span></a></span><span>
</span><span id="line-1654"></span><span>
</span><span id="line-1655"></span><span>    </span><span id="local-6989586621683160557"><span class="annot"><span class="annottext">inst_cls_name_err :: TcM Name
</span><a href="#local-6989586621683160557"><span class="hs-identifier hs-var hs-var">inst_cls_name_err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; TcM Name
forall a. TcRnMessage -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; TcM Name) -&gt; TcRnMessage -&gt; TcM Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1656"></span><span>      </span><span class="annot"><span class="annottext">THError -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnTHError"><span class="hs-identifier hs-var">TcRnTHError</span></a></span><span> </span><span class="annot"><span class="annottext">(THError -&gt; TcRnMessage) -&gt; THError -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; LookupTHInstNameErrReason -&gt; THError
</span><a href="GHC.Tc.Errors.Types.html#FailedToLookupThInstName"><span class="hs-identifier hs-var">FailedToLookupThInstName</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683160525"><span class="hs-identifier hs-var">th_type</span></a></span><span> </span><span class="annot"><span class="annottext">LookupTHInstNameErrReason
</span><a href="GHC.Tc.Errors.Types.html#CouldNotDetermineInstance"><span class="hs-identifier hs-var">CouldNotDetermineInstance</span></a></span><span>
</span><span id="line-1657"></span><span>
</span><span id="line-1658"></span><span>    </span><span class="hs-comment">-- Basically does the opposite of 'mkThAppTs'</span><span>
</span><span id="line-1659"></span><span>    </span><span class="hs-comment">-- &gt; inst_arg_types (Monad Maybe) == [Maybe]</span><span>
</span><span id="line-1660"></span><span>    </span><span class="hs-comment">-- &gt; inst_arg_types C == []</span><span>
</span><span id="line-1661"></span><span>    </span><span class="annot"><a href="#local-6989586621683160530"><span class="hs-identifier hs-type">inst_arg_types</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Type</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">TH.Type</span></span><span class="hs-special">]</span><span>
</span><span id="line-1662"></span><span>    </span><span id="local-6989586621683160530"><span class="annot"><span class="annottext">inst_arg_types :: Type -&gt; [Type]
</span><a href="#local-6989586621683160530"><span class="hs-identifier hs-var hs-var">inst_arg_types</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.AppT</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683160576"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683160576"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1663"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683160577"><span class="annot"><span class="annottext">go :: Type -&gt; [Type]
</span><a href="#local-6989586621683160577"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.AppT</span></span><span> </span><span id="local-6989586621683160578"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683160578"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621683160579"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683160579"><span class="hs-identifier hs-var">ts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683160578"><span class="hs-identifier hs-var">t</span></a></span><span class="annot"><span class="annottext">Type -&gt; [Type] -&gt; [Type]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">Type -&gt; [Type]
</span><a href="#local-6989586621683160577"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683160579"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-1664"></span><span>          </span><span class="annot"><a href="#local-6989586621683160577"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683160580"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683160580"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683160580"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1665"></span><span>        </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Type -&gt; [Type]
</span><a href="#local-6989586621683160577"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683160576"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-1666"></span><span>    </span><span class="annot"><a href="#local-6989586621683160530"><span class="hs-identifier hs-var">inst_arg_types</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1667"></span><span>
</span><span id="line-1668"></span><span class="annot"><span class="hs-comment">-- | Adds a mod finalizer reference to the local environment.</span></span><span>
</span><span id="line-1669"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#addModFinalizerRef"><span class="hs-identifier hs-type">addModFinalizerRef</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html#ForeignRef"><span class="hs-identifier hs-type">ForeignRef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.Q</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1670"></span><span id="addModFinalizerRef"><span class="annot"><span class="annottext">addModFinalizerRef :: ForeignRef (Q ()) -&gt; TcRn ()
</span><a href="GHC.Tc.Gen.Splice.html#addModFinalizerRef"><span class="hs-identifier hs-var hs-var">addModFinalizerRef</span></a></span></span><span> </span><span id="local-6989586621683160581"><span class="annot"><span class="annottext">ForeignRef (Q ())
</span><a href="#local-6989586621683160581"><span class="hs-identifier hs-var">finRef</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1671"></span><span>    </span><span id="local-6989586621683160582"><span class="annot"><a href="#local-6989586621683160582"><span class="hs-identifier hs-var">th_stage</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM ThStage
</span><a href="GHC.Tc.Utils.Monad.html#getStage"><span class="hs-identifier hs-var">getStage</span></a></span><span>
</span><span id="line-1672"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683160582"><span class="hs-identifier hs-type">th_stage</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1673"></span><span>      </span><span class="annot"><a href="GHC.Tc.Types.TH.html#RunSplice"><span class="hs-identifier hs-type">RunSplice</span></a></span><span> </span><span id="local-6989586621683160583"><span class="annot"><span class="annottext">TcRef [ForeignRef (Q ())]
</span><a href="#local-6989586621683160583"><span class="hs-identifier hs-var">th_modfinalizers_var</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcRef [ForeignRef (Q ())]
-&gt; ([ForeignRef (Q ())] -&gt; [ForeignRef (Q ())]) -&gt; TcRn ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TcRef a -&gt; (a -&gt; a) -&gt; m ()
</span><a href="GHC.Tc.Types.TcRef.html#updTcRef"><span class="hs-identifier hs-var">updTcRef</span></a></span><span> </span><span class="annot"><span class="annottext">TcRef [ForeignRef (Q ())]
</span><a href="#local-6989586621683160583"><span class="hs-identifier hs-var">th_modfinalizers_var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ForeignRef (Q ())
</span><a href="#local-6989586621683160581"><span class="hs-identifier hs-var">finRef</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignRef (Q ()) -&gt; [ForeignRef (Q ())] -&gt; [ForeignRef (Q ())]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="hs-special">)</span><span>
</span><span id="line-1674"></span><span>      </span><span class="hs-comment">-- This case happens only if a splice is executed and the caller does</span><span>
</span><span id="line-1675"></span><span>      </span><span class="hs-comment">-- not set the 'ThStage' to 'RunSplice' to collect finalizers.</span><span>
</span><span id="line-1676"></span><span>      </span><span class="hs-comment">-- See Note [Delaying modFinalizers in untyped splices] in GHC.Rename.Splice.</span><span>
</span><span id="line-1677"></span><span>      </span><span class="annot"><span class="annottext">ThStage
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1678"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcRn ()
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;addModFinalizer was called when no finalizers were collected&quot;</span></span><span>
</span><span id="line-1679"></span><span>                 </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThStage -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">ThStage
</span><a href="#local-6989586621683160582"><span class="hs-identifier hs-var">th_stage</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1680"></span><span>
</span><span id="line-1681"></span><span class="annot"><span class="hs-comment">-- | Releases the external interpreter state.</span></span><span>
</span><span id="line-1682"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#finishTH"><span class="hs-identifier hs-type">finishTH</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1683"></span><span id="finishTH"><span class="annot"><span class="annottext">finishTH :: TcRn ()
</span><a href="GHC.Tc.Gen.Splice.html#finishTH"><span class="hs-identifier hs-var hs-var">finishTH</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1684"></span><span>  </span><span id="local-6989586621683160584"><span class="annot"><a href="#local-6989586621683160584"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcRnIf TcGblEnv TcLclEnv HscEnv
forall gbl lcl. TcRnIf gbl lcl HscEnv
</span><a href="GHC.Tc.Utils.Monad.html#getTopEnv"><span class="hs-identifier hs-var">getTopEnv</span></a></span><span>
</span><span id="line-1685"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#interpInstance"><span class="hs-identifier hs-var">interpInstance</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#hsc_interp"><span class="hs-identifier hs-var">hsc_interp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160584"><span class="hs-identifier hs-type">hsc_env</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1686"></span><span>    </span><span class="annot"><span class="annottext">Maybe InterpInstance
</span><span class="hs-identifier hs-var">Nothing</span></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcRn ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-cpp">
#if defined(HAVE_INTERNAL_INTERPRETER)
</span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">InterpInstance
</span><a href="GHC.Runtime.Interpreter.Types.html#InternalInterp"><span class="hs-identifier hs-var">InternalInterp</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcRn ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#ExternalInterp"><span class="hs-identifier hs-type">ExternalInterp</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1691"></span><span>      </span><span id="local-6989586621683160586"><span class="annot"><a href="#local-6989586621683160586"><span class="hs-identifier hs-var">tcg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcRnIf TcGblEnv TcLclEnv TcGblEnv
forall gbl lcl. TcRnIf gbl lcl gbl
</span><a href="GHC.Tc.Utils.Monad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a></span><span>
</span><span id="line-1692"></span><span>      </span><span class="annot"><a href="GHC.Tc.Types.TcRef.html#writeTcRef"><span class="hs-identifier hs-type">writeTcRef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.html#tcg_th_remote_state"><span class="hs-identifier hs-var">tcg_th_remote_state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160586"><span class="hs-identifier hs-type">tcg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span>
</span><span id="line-1693"></span><span>
</span><span id="line-1694"></span><span>
</span><span id="line-1695"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runTHExp"><span class="hs-identifier hs-type">runTHExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html#ForeignHValue"><span class="hs-identifier hs-type">ForeignHValue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Exp</span></span><span>
</span><span id="line-1696"></span><span id="runTHExp"><span class="annot"><span class="annottext">runTHExp :: ForeignHValue -&gt; TcM Exp
</span><a href="GHC.Tc.Gen.Splice.html#runTHExp"><span class="hs-identifier hs-var hs-var">runTHExp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">THResultType -&gt; ForeignHValue -&gt; TcM Exp
forall a. Binary a =&gt; THResultType -&gt; ForeignHValue -&gt; TcM a
</span><a href="GHC.Tc.Gen.Splice.html#runTH"><span class="hs-identifier hs-var">runTH</span></a></span><span> </span><span class="annot"><span class="annottext">THResultType
</span><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#THExp"><span class="hs-identifier hs-var">THExp</span></a></span><span>
</span><span id="line-1697"></span><span>
</span><span id="line-1698"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runTHPat"><span class="hs-identifier hs-type">runTHPat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html#ForeignHValue"><span class="hs-identifier hs-type">ForeignHValue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Pat</span></span><span>
</span><span id="line-1699"></span><span id="runTHPat"><span class="annot"><span class="annottext">runTHPat :: ForeignHValue -&gt; TcM Pat
</span><a href="GHC.Tc.Gen.Splice.html#runTHPat"><span class="hs-identifier hs-var hs-var">runTHPat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">THResultType -&gt; ForeignHValue -&gt; TcM Pat
forall a. Binary a =&gt; THResultType -&gt; ForeignHValue -&gt; TcM a
</span><a href="GHC.Tc.Gen.Splice.html#runTH"><span class="hs-identifier hs-var">runTH</span></a></span><span> </span><span class="annot"><span class="annottext">THResultType
</span><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#THPat"><span class="hs-identifier hs-var">THPat</span></a></span><span>
</span><span id="line-1700"></span><span>
</span><span id="line-1701"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runTHType"><span class="hs-identifier hs-type">runTHType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html#ForeignHValue"><span class="hs-identifier hs-type">ForeignHValue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Type</span></span><span>
</span><span id="line-1702"></span><span id="runTHType"><span class="annot"><span class="annottext">runTHType :: ForeignHValue -&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#runTHType"><span class="hs-identifier hs-var hs-var">runTHType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">THResultType -&gt; ForeignHValue -&gt; TcM Type
forall a. Binary a =&gt; THResultType -&gt; ForeignHValue -&gt; TcM a
</span><a href="GHC.Tc.Gen.Splice.html#runTH"><span class="hs-identifier hs-var">runTH</span></a></span><span> </span><span class="annot"><span class="annottext">THResultType
</span><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#THType"><span class="hs-identifier hs-var">THType</span></a></span><span>
</span><span id="line-1703"></span><span>
</span><span id="line-1704"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runTHDec"><span class="hs-identifier hs-type">runTHDec</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html#ForeignHValue"><span class="hs-identifier hs-type">ForeignHValue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">TH.Dec</span></span><span class="hs-special">]</span><span>
</span><span id="line-1705"></span><span id="runTHDec"><span class="annot"><span class="annottext">runTHDec :: ForeignHValue -&gt; TcM [Dec]
</span><a href="GHC.Tc.Gen.Splice.html#runTHDec"><span class="hs-identifier hs-var hs-var">runTHDec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">THResultType -&gt; ForeignHValue -&gt; TcM [Dec]
forall a. Binary a =&gt; THResultType -&gt; ForeignHValue -&gt; TcM a
</span><a href="GHC.Tc.Gen.Splice.html#runTH"><span class="hs-identifier hs-var">runTH</span></a></span><span> </span><span class="annot"><span class="annottext">THResultType
</span><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#THDec"><span class="hs-identifier hs-var">THDec</span></a></span><span>
</span><span id="line-1706"></span><span>
</span><span id="line-1707"></span><span id="local-6989586621683158362"><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runTH"><span class="hs-identifier hs-type">runTH</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../binary-0.8.9.3-25e5/src/Data.Binary.Class.html#Binary"><span class="hs-identifier hs-type">Binary</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683158362"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#THResultType"><span class="hs-identifier hs-type">THResultType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html#ForeignHValue"><span class="hs-identifier hs-type">ForeignHValue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683158362"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-1708"></span><span id="runTH"><span class="annot"><span class="annottext">runTH :: forall a. Binary a =&gt; THResultType -&gt; ForeignHValue -&gt; TcM a
</span><a href="GHC.Tc.Gen.Splice.html#runTH"><span class="hs-identifier hs-var hs-var">runTH</span></a></span></span><span> </span><span id="local-6989586621683160598"><span class="annot"><span class="annottext">THResultType
</span><a href="#local-6989586621683160598"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621683160599"><span class="annot"><span class="annottext">ForeignHValue
</span><a href="#local-6989586621683160599"><span class="hs-identifier hs-var">fhv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1709"></span><span>  </span><span id="local-6989586621683160600"><span class="annot"><a href="#local-6989586621683160600"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM Interp
</span><a href="GHC.Tc.Gen.Splice.html#tcGetInterp"><span class="hs-identifier hs-var">tcGetInterp</span></a></span><span>
</span><span id="line-1710"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#interpInstance"><span class="hs-identifier hs-var">interpInstance</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160600"><span class="hs-identifier hs-type">interp</span></a></span><span> </span><span class="hs-keyword">of</span><span class="hs-cpp">
#if defined(HAVE_INTERNAL_INTERPRETER)
</span><span>    </span><span class="annot"><span class="annottext">InterpInstance
</span><a href="GHC.Runtime.Interpreter.Types.html#InternalInterp"><span class="hs-identifier hs-var">InternalInterp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1713"></span><span>       </span><span class="hs-comment">-- Run it in the local TcM</span><span>
</span><span id="line-1714"></span><span>      </span><span id="local-6989586621683160601"><span class="annot"><a href="#local-6989586621683160601"><span class="hs-identifier hs-var">hv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO HValue -&gt; IOEnv (Env TcGblEnv TcLclEnv) HValue
forall a. IO a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO HValue -&gt; IOEnv (Env TcGblEnv TcLclEnv) HValue)
-&gt; IO HValue -&gt; IOEnv (Env TcGblEnv TcLclEnv) HValue
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Interp -&gt; ForeignHValue -&gt; IO HValue
forall a. Interp -&gt; ForeignRef a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#wormhole"><span class="hs-identifier hs-var">wormhole</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683160600"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignHValue
</span><a href="#local-6989586621683160599"><span class="hs-identifier hs-var">fhv</span></a></span><span>
</span><span id="line-1715"></span><span>      </span><span id="local-6989586621683160602"><span class="annot"><a href="#local-6989586621683160602"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runQuasi"><span class="hs-identifier hs-type">runQuasi</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683160603"><span class="annot"><span class="hs-identifier hs-type">unsafeCoerce</span></span><span> </span><span class="annot"><a href="#local-6989586621683160601"><span class="hs-identifier hs-type">hv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Q</span></span><span> </span><span class="annot"><a href="#local-6989586621683160603"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1716"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683160602"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-1719"></span><span>    </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#ExternalInterp"><span class="hs-identifier hs-type">ExternalInterp</span></a></span><span> </span><span id="local-6989586621683160604"><span class="annot"><span class="annottext">ExtInterp
</span><a href="#local-6989586621683160604"><span class="hs-identifier hs-var">ext</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ExtInterp
-&gt; (forall d.
    ExtInterpInstance d -&gt; IOEnv (Env TcGblEnv TcLclEnv) a)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a.
ExceptionMonad m =&gt;
ExtInterp -&gt; (forall d. ExtInterpInstance d -&gt; m a) -&gt; m a
</span><a href="GHC.Runtime.Interpreter.html#withExtInterp"><span class="hs-identifier hs-var">withExtInterp</span></a></span><span> </span><span class="annot"><span class="annottext">ExtInterp
</span><a href="#local-6989586621683160604"><span class="hs-identifier hs-var">ext</span></a></span><span> </span><span class="annot"><span class="annottext">((forall d. ExtInterpInstance d -&gt; IOEnv (Env TcGblEnv TcLclEnv) a)
 -&gt; IOEnv (Env TcGblEnv TcLclEnv) a)
-&gt; (forall d.
    ExtInterpInstance d -&gt; IOEnv (Env TcGblEnv TcLclEnv) a)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621683160619"><span class="annot"><span class="annottext">ExtInterpInstance d
</span><a href="#local-6989586621683160619"><span class="hs-identifier hs-var">inst</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1720"></span><span>      </span><span class="hs-comment">-- Run it on the server.  For an overview of how TH works with</span><span>
</span><span id="line-1721"></span><span>      </span><span class="hs-comment">-- Remote GHCi, see Note [Remote Template Haskell] in</span><span>
</span><span id="line-1722"></span><span>      </span><span class="hs-comment">-- libraries/ghci/GHCi/TH.hs.</span><span>
</span><span id="line-1723"></span><span>      </span><span id="local-6989586621683160620"><span class="annot"><a href="#local-6989586621683160620"><span class="hs-identifier hs-var">rstate</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ExtInterpInstance d -&gt; TcM (ForeignRef (IORef QState))
forall d. ExtInterpInstance d -&gt; TcM (ForeignRef (IORef QState))
</span><a href="GHC.Tc.Gen.Splice.html#getTHState"><span class="hs-identifier hs-var">getTHState</span></a></span><span> </span><span class="annot"><span class="annottext">ExtInterpInstance d
</span><a href="#local-6989586621683160619"><span class="hs-identifier hs-var">inst</span></a></span><span>
</span><span id="line-1724"></span><span>      </span><span id="local-6989586621683160622"><span class="annot"><a href="#local-6989586621683160622"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.qLocation</span></span><span>
</span><span id="line-1725"></span><span>      </span><span class="hs-comment">-- run a remote TH request</span><span>
</span><span id="line-1726"></span><span>      </span><span id="local-6989586621683160623"><span class="annot"><a href="#local-6989586621683160623"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-1727"></span><span>        </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html#withForeignRef"><span class="hs-identifier hs-type">withForeignRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160620"><span class="hs-identifier hs-type">rstate</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621683160624"><span class="annot"><span class="annottext">RemoteRef (IORef QState)
</span><a href="#local-6989586621683160624"><span class="hs-identifier hs-var">state_hv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1728"></span><span>        </span><span class="annot"><span class="annottext">ForeignHValue
-&gt; (RemoteRef HValue -&gt; IO (DelayedResponse (QResult ByteString)))
-&gt; IO (DelayedResponse (QResult ByteString))
forall a b. ForeignRef a -&gt; (RemoteRef a -&gt; IO b) -&gt; IO b
</span><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html#withForeignRef"><span class="hs-identifier hs-var">withForeignRef</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignHValue
</span><a href="#local-6989586621683160599"><span class="hs-identifier hs-var">fhv</span></a></span><span> </span><span class="annot"><span class="annottext">((RemoteRef HValue -&gt; IO (DelayedResponse (QResult ByteString)))
 -&gt; IO (DelayedResponse (QResult ByteString)))
-&gt; (RemoteRef HValue -&gt; IO (DelayedResponse (QResult ByteString)))
-&gt; IO (DelayedResponse (QResult ByteString))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621683160625"><span class="annot"><span class="annottext">RemoteRef HValue
</span><a href="#local-6989586621683160625"><span class="hs-identifier hs-var">q_hv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1729"></span><span>          </span><span class="annot"><span class="annottext">ExtInterpInstance d
-&gt; Message (QResult ByteString)
-&gt; IO (DelayedResponse (QResult ByteString))
forall d a.
ExtInterpInstance d -&gt; Message a -&gt; IO (DelayedResponse a)
</span><a href="GHC.Runtime.Interpreter.Process.html#sendMessageDelayedResponse"><span class="hs-identifier hs-var">sendMessageDelayedResponse</span></a></span><span> </span><span class="annot"><span class="annottext">ExtInterpInstance d
</span><a href="#local-6989586621683160619"><span class="hs-identifier hs-var">inst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoteRef (IORef QState)
-&gt; RemoteRef HValue
-&gt; THResultType
-&gt; Maybe Loc
-&gt; Message (QResult ByteString)
</span><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#RunTH"><span class="hs-identifier hs-var">RunTH</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteRef (IORef QState)
</span><a href="#local-6989586621683160624"><span class="hs-identifier hs-var">state_hv</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteRef HValue
</span><a href="#local-6989586621683160625"><span class="hs-identifier hs-var">q_hv</span></a></span><span> </span><span class="annot"><span class="annottext">THResultType
</span><a href="#local-6989586621683160598"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Loc -&gt; Maybe Loc
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Loc
</span><a href="#local-6989586621683160622"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1730"></span><span>      </span><span class="hs-comment">-- respond to requests from the interpreter</span><span>
</span><span id="line-1731"></span><span>      </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runRemoteTH"><span class="hs-identifier hs-type">runRemoteTH</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160619"><span class="hs-identifier hs-type">inst</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1732"></span><span>      </span><span class="hs-comment">-- get the final result</span><span>
</span><span id="line-1733"></span><span>      </span><span id="local-6989586621683160627"><span class="annot"><a href="#local-6989586621683160627"><span class="hs-identifier hs-var">qr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Process.html#receiveDelayedResponse"><span class="hs-identifier hs-type">receiveDelayedResponse</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160619"><span class="hs-identifier hs-type">inst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160623"><span class="hs-identifier hs-type">r</span></a></span><span>
</span><span id="line-1734"></span><span>      </span><span id="local-6989586621683160628"><span class="annot"><a href="#local-6989586621683160628"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#checkQResult"><span class="hs-identifier hs-type">checkQResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160627"><span class="hs-identifier hs-type">qr</span></a></span><span>
</span><span id="line-1735"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$!</span></span><span> </span><span class="annot"><a href="../../binary-0.8.9.3-25e5/src/Data.Binary.Get.html#runGet"><span class="hs-identifier hs-type">runGet</span></a></span><span> </span><span class="annot"><a href="../../binary-0.8.9.3-25e5/src/Data.Binary.Class.html#get"><span class="hs-identifier hs-type">get</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../bytestring-0.12.2.0-7dd0/src/Data.ByteString.Lazy.Internal.html#fromStrict"><span class="hs-identifier hs-type">LB.fromStrict</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160628"><span class="hs-identifier hs-type">bs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1736"></span><span>
</span><span id="line-1737"></span><span>
</span><span id="line-1738"></span><span class="hs-comment">-- | communicate with a remotely-running TH computation until it finishes.</span><span>
</span><span id="line-1739"></span><span class="hs-comment">-- See Note [Remote Template Haskell] in libraries/ghci/GHCi/TH.hs.</span><span>
</span><span id="line-1740"></span><span id="local-6989586621683158408"><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runRemoteTH"><span class="hs-identifier hs-type">runRemoteTH</span></a></span><span>
</span><span id="line-1741"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#ExtInterpInstance"><span class="hs-identifier hs-type">ExtInterpInstance</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683158408"><span class="hs-identifier hs-type">d</span></a></span><span>
</span><span id="line-1742"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Error.html#Messages"><span class="hs-identifier hs-type">Messages</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Errors.Types.html#TcRnMessage"><span class="hs-identifier hs-type">TcRnMessage</span></a></span><span class="hs-special">]</span><span>   </span><span class="hs-comment">--  saved from nested calls to qRecover</span><span>
</span><span id="line-1743"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-1744"></span><span id="runRemoteTH"><span class="annot"><span class="annottext">runRemoteTH :: forall d. ExtInterpInstance d -&gt; [Messages TcRnMessage] -&gt; TcRn ()
</span><a href="GHC.Tc.Gen.Splice.html#runRemoteTH"><span class="hs-identifier hs-var hs-var">runRemoteTH</span></a></span></span><span> </span><span id="local-6989586621683160634"><span class="annot"><span class="annottext">ExtInterpInstance d
</span><a href="#local-6989586621683160634"><span class="hs-identifier hs-var">inst</span></a></span></span><span> </span><span id="local-6989586621683160635"><span class="annot"><span class="annottext">[Messages TcRnMessage]
</span><a href="#local-6989586621683160635"><span class="hs-identifier hs-var">recovers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1745"></span><span>  </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#THMsg"><span class="hs-identifier hs-type">THMsg</span></a></span><span> </span><span id="local-6989586621683160643"><span class="annot"><a href="#local-6989586621683160643"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO THMsg -&gt; IOEnv (Env TcGblEnv TcLclEnv) THMsg
forall a. IO a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO THMsg -&gt; IOEnv (Env TcGblEnv TcLclEnv) THMsg)
-&gt; IO THMsg -&gt; IOEnv (Env TcGblEnv TcLclEnv) THMsg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ExtInterpInstance d -&gt; IO THMsg
forall d. ExtInterpInstance d -&gt; IO THMsg
</span><a href="GHC.Runtime.Interpreter.Process.html#receiveTHMessage"><span class="hs-identifier hs-var">receiveTHMessage</span></a></span><span> </span><span class="annot"><span class="annottext">ExtInterpInstance d
</span><a href="#local-6989586621683160634"><span class="hs-identifier hs-var">inst</span></a></span><span>
</span><span id="line-1746"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683160643"><span class="hs-identifier hs-type">msg</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1747"></span><span>    </span><span class="annot"><span class="annottext">THMessage a
</span><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#RunTHDone"><span class="hs-identifier hs-var">RunTHDone</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcRn ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1748"></span><span>    </span><span class="annot"><span class="annottext">THMessage a
</span><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#StartRecover"><span class="hs-identifier hs-var">StartRecover</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- Note [TH recover with -fexternal-interpreter]</span><span>
</span><span id="line-1749"></span><span>      </span><span id="local-6989586621683160655"><span class="annot"><a href="#local-6989586621683160655"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcRn (TcRef (Messages TcRnMessage))
</span><a href="GHC.Tc.Utils.Monad.html#getErrsVar"><span class="hs-identifier hs-var">getErrsVar</span></a></span><span>
</span><span id="line-1750"></span><span>      </span><span id="local-6989586621683160657"><span class="annot"><a href="#local-6989586621683160657"><span class="hs-identifier hs-var">msgs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TcRef.html#readTcRef"><span class="hs-identifier hs-type">readTcRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160655"><span class="hs-identifier hs-type">v</span></a></span><span>
</span><span id="line-1751"></span><span>      </span><span class="annot"><a href="GHC.Tc.Types.TcRef.html#writeTcRef"><span class="hs-identifier hs-type">writeTcRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160655"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Error.html#emptyMessages"><span class="hs-identifier hs-type">emptyMessages</span></a></span><span>
</span><span id="line-1752"></span><span>      </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runRemoteTH"><span class="hs-identifier hs-type">runRemoteTH</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160634"><span class="hs-identifier hs-type">inst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683160657"><span class="hs-identifier hs-type">msgs</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="#local-6989586621683160635"><span class="hs-identifier hs-type">recovers</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1753"></span><span>    </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#EndRecover"><span class="hs-identifier hs-type">EndRecover</span></a></span><span> </span><span id="local-6989586621683160671"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683160671"><span class="hs-identifier hs-var">caught_error</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1754"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683160672"><span class="annot"><span class="annottext">Messages TcRnMessage
</span><a href="#local-6989586621683160672"><span class="hs-identifier hs-var hs-var">prev_msgs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683160673"><span class="annot"><span class="annottext">[Messages TcRnMessage]
</span><a href="#local-6989586621683160673"><span class="hs-identifier hs-var hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[Messages TcRnMessage]
</span><a href="#local-6989586621683160635"><span class="hs-identifier hs-var">recovers</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1755"></span><span>             </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; (Messages TcRnMessage, [Messages TcRnMessage])
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;EndRecover&quot;</span></span><span>
</span><span id="line-1756"></span><span>             </span><span id="local-6989586621683160674"><span class="annot"><span class="annottext">Messages TcRnMessage
</span><a href="#local-6989586621683160674"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621683160675"><span class="annot"><span class="annottext">[Messages TcRnMessage]
</span><a href="#local-6989586621683160675"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Messages TcRnMessage
</span><a href="#local-6989586621683160674"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">[Messages TcRnMessage]
</span><a href="#local-6989586621683160675"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1757"></span><span>      </span><span id="local-6989586621683160676"><span class="annot"><a href="#local-6989586621683160676"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcRn (TcRef (Messages TcRnMessage))
</span><a href="GHC.Tc.Utils.Monad.html#getErrsVar"><span class="hs-identifier hs-var">getErrsVar</span></a></span><span>
</span><span id="line-1758"></span><span>      </span><span id="local-6989586621683160677"><span class="annot"><a href="#local-6989586621683160677"><span class="hs-identifier hs-var">warn_msgs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Types.Error.html#getWarningMessages"><span class="hs-identifier hs-type">getWarningMessages</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.TcRef.html#readTcRef"><span class="hs-identifier hs-type">readTcRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160676"><span class="hs-identifier hs-type">v</span></a></span><span>
</span><span id="line-1759"></span><span>      </span><span class="hs-comment">-- keep the warnings only if there were no errors</span><span>
</span><span id="line-1760"></span><span>      </span><span class="annot"><a href="GHC.Tc.Types.TcRef.html#writeTcRef"><span class="hs-identifier hs-type">writeTcRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160676"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621683160671"><span class="hs-identifier hs-type">caught_error</span></a></span><span>
</span><span id="line-1761"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><a href="#local-6989586621683160672"><span class="hs-identifier hs-type">prev_msgs</span></a></span><span>
</span><span id="line-1762"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><a href="GHC.Types.Error.html#mkMessages"><span class="hs-identifier hs-type">mkMessages</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160677"><span class="hs-identifier hs-type">warn_msgs</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Error.html#unionMessages"><span class="hs-operator hs-type">`unionMessages`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160672"><span class="hs-identifier hs-type">prev_msgs</span></a></span><span>
</span><span id="line-1763"></span><span>      </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runRemoteTH"><span class="hs-identifier hs-type">runRemoteTH</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160634"><span class="hs-identifier hs-type">inst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160673"><span class="hs-identifier hs-type">rest</span></a></span><span>
</span><span id="line-1764"></span><span>    </span><span id="local-6989586621683160681"><span class="annot"><span class="annottext">THMessage a
</span><a href="#local-6989586621683160681"><span class="hs-identifier hs-var">_other</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1765"></span><span>      </span><span id="local-6989586621683160682"><span class="annot"><a href="#local-6989586621683160682"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">THMessage a -&gt; TcM a
forall a. THMessage a -&gt; TcM a
</span><a href="GHC.Tc.Gen.Splice.html#handleTHMessage"><span class="hs-identifier hs-var">handleTHMessage</span></a></span><span> </span><span class="annot"><span class="annottext">THMessage a
</span><a href="#local-6989586621683160643"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-1766"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Process.html#sendAnyValue"><span class="hs-identifier hs-type">sendAnyValue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160634"><span class="hs-identifier hs-type">inst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160682"><span class="hs-identifier hs-type">r</span></a></span><span>
</span><span id="line-1767"></span><span>      </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runRemoteTH"><span class="hs-identifier hs-type">runRemoteTH</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160634"><span class="hs-identifier hs-type">inst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160635"><span class="hs-identifier hs-type">recovers</span></a></span><span>
</span><span id="line-1768"></span><span>
</span><span id="line-1769"></span><span class="annot"><span class="hs-comment">-- | Check a QResult</span></span><span>
</span><span id="line-1770"></span><span id="local-6989586621683158411"><span class="annot"><a href="GHC.Tc.Gen.Splice.html#checkQResult"><span class="hs-identifier hs-type">checkQResult</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#QResult"><span class="hs-identifier hs-type">QResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683158411"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683158411"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-1771"></span><span id="checkQResult"><span class="annot"><span class="annottext">checkQResult :: forall a. QResult a -&gt; TcM a
</span><a href="GHC.Tc.Gen.Splice.html#checkQResult"><span class="hs-identifier hs-var hs-var">checkQResult</span></a></span></span><span> </span><span id="local-6989586621683160692"><span class="annot"><span class="annottext">QResult a
</span><a href="#local-6989586621683160692"><span class="hs-identifier hs-var">qr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1772"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">QResult a
</span><a href="#local-6989586621683160692"><span class="hs-identifier hs-var">qr</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1773"></span><span>    </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#QDone"><span class="hs-identifier hs-type">QDone</span></a></span><span> </span><span id="local-6989586621683160694"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683160694"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; TcM a
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683160694"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-1774"></span><span>    </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#QException"><span class="hs-identifier hs-type">QException</span></a></span><span> </span><span id="local-6989586621683160696"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160696"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO a -&gt; TcM a
forall a. IO a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO a -&gt; TcM a) -&gt; IO a -&gt; TcM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCall -&gt; IO a
forall e a. (HasCallStack, Exception e) =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; ErrorCall
</span><span class="hs-identifier hs-var">ErrorCall</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160696"><span class="hs-identifier hs-var">str</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1775"></span><span>    </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#QFail"><span class="hs-identifier hs-type">QFail</span></a></span><span> </span><span id="local-6989586621683160699"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160699"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; TcM a
forall a. String -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160699"><span class="hs-identifier hs-var">str</span></a></span><span>
</span><span id="line-1776"></span><span>
</span><span id="line-1777"></span><span class="hs-comment">{- Note [TH recover with -fexternal-interpreter]
   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Recover is slightly tricky to implement.

The meaning of &quot;recover a b&quot; is
 - Do a
   - If it finished with no errors, then keep the warnings it generated
   - If it failed, discard any messages it generated, and do b

Note that &quot;failed&quot; here can mean either
  (1) threw an exception (failTc)
  (2) generated an error message (addErrTcM)

The messages are managed by GHC in the TcM monad, whereas the
exception-handling is done in the ghc-iserv process, so we have to
coordinate between the two.

On the server:
  - emit a StartRecover message
  - run &quot;a; FailIfErrs&quot; inside a try
  - emit an (EndRecover x) message, where x = True if &quot;a; FailIfErrs&quot; failed
  - if &quot;a; FailIfErrs&quot; failed, run &quot;b&quot;

Back in GHC, when we receive:

  FailIfErrrs
    failTc if there are any error messages (= failIfErrsM)
  StartRecover
    save the current messages and start with an empty set.
  EndRecover caught_error
    Restore the previous messages,
    and merge in the new messages if caught_error is false.
-}</span><span>
</span><span id="line-1810"></span><span>
</span><span id="line-1811"></span><span class="hs-comment">-- | Retrieve (or create, if it hasn't been created already), the</span><span>
</span><span id="line-1812"></span><span class="hs-comment">-- remote TH state.  The TH state is a remote reference to an IORef</span><span>
</span><span id="line-1813"></span><span class="hs-comment">-- QState living on the server, and we have to pass this to each RunTH</span><span>
</span><span id="line-1814"></span><span class="hs-comment">-- call we make.</span><span>
</span><span id="line-1815"></span><span class="hs-comment">--</span><span>
</span><span id="line-1816"></span><span class="hs-comment">-- The TH state is stored in tcg_th_remote_state in the TcGblEnv.</span><span>
</span><span id="line-1817"></span><span class="hs-comment">--</span><span>
</span><span id="line-1818"></span><span id="local-6989586621683158626"><span class="annot"><a href="GHC.Tc.Gen.Splice.html#getTHState"><span class="hs-identifier hs-type">getTHState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#ExtInterpInstance"><span class="hs-identifier hs-type">ExtInterpInstance</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683158626"><span class="hs-identifier hs-type">d</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html#ForeignRef"><span class="hs-identifier hs-type">ForeignRef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#QState"><span class="hs-identifier hs-type">QState</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-1819"></span><span id="getTHState"><span class="annot"><span class="annottext">getTHState :: forall d. ExtInterpInstance d -&gt; TcM (ForeignRef (IORef QState))
</span><a href="GHC.Tc.Gen.Splice.html#getTHState"><span class="hs-identifier hs-var hs-var">getTHState</span></a></span></span><span> </span><span id="local-6989586621683160711"><span class="annot"><span class="annottext">ExtInterpInstance d
</span><a href="#local-6989586621683160711"><span class="hs-identifier hs-var">inst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1820"></span><span>  </span><span id="local-6989586621683160712"><span class="annot"><a href="#local-6989586621683160712"><span class="hs-identifier hs-var">th_state_var</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcGblEnv -&gt; TcRef (Maybe (ForeignRef (IORef QState)))
</span><a href="GHC.Tc.Types.html#tcg_th_remote_state"><span class="hs-identifier hs-var">tcg_th_remote_state</span></a></span><span> </span><span class="annot"><span class="annottext">(TcGblEnv -&gt; TcRef (Maybe (ForeignRef (IORef QState))))
-&gt; TcRnIf TcGblEnv TcLclEnv TcGblEnv
-&gt; IOEnv
     (Env TcGblEnv TcLclEnv) (TcRef (Maybe (ForeignRef (IORef QState))))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TcRnIf TcGblEnv TcLclEnv TcGblEnv
forall gbl lcl. TcRnIf gbl lcl gbl
</span><a href="GHC.Tc.Utils.Monad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a></span><span>
</span><span id="line-1821"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1822"></span><span>    </span><span id="local-6989586621683160713"><span class="annot"><a href="#local-6989586621683160713"><span class="hs-identifier hs-var">th_state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">readIORef</span></span><span> </span><span class="annot"><a href="#local-6989586621683160712"><span class="hs-identifier hs-type">th_state_var</span></a></span><span>
</span><span id="line-1823"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683160713"><span class="hs-identifier hs-type">th_state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1824"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683160715"><span class="annot"><span class="annottext">ForeignRef (IORef QState)
</span><a href="#local-6989586621683160715"><span class="hs-identifier hs-var">rhv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ForeignRef (IORef QState) -&gt; IO (ForeignRef (IORef QState))
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">ForeignRef (IORef QState)
</span><a href="#local-6989586621683160715"><span class="hs-identifier hs-var">rhv</span></a></span><span>
</span><span id="line-1825"></span><span>      </span><span class="annot"><span class="annottext">Maybe (ForeignRef (IORef QState))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1826"></span><span>        </span><span id="local-6989586621683160716"><span class="annot"><a href="#local-6989586621683160716"><span class="hs-identifier hs-var">rref</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ExtInterpInstance d
-&gt; Message (RemoteRef (IORef QState))
-&gt; IO (RemoteRef (IORef QState))
forall a d. Binary a =&gt; ExtInterpInstance d -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.Process.html#sendMessage"><span class="hs-identifier hs-var">sendMessage</span></a></span><span> </span><span class="annot"><span class="annottext">ExtInterpInstance d
</span><a href="#local-6989586621683160711"><span class="hs-identifier hs-var">inst</span></a></span><span> </span><span class="annot"><span class="annottext">Message (RemoteRef (IORef QState))
</span><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#StartTH"><span class="hs-identifier hs-var">StartTH</span></a></span><span>
</span><span id="line-1827"></span><span>        </span><span id="local-6989586621683160719"><span class="annot"><a href="#local-6989586621683160719"><span class="hs-identifier hs-var">fhv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html#mkForeignRef"><span class="hs-identifier hs-type">mkForeignRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160716"><span class="hs-identifier hs-type">rref</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Runtime.Interpreter.html#freeReallyRemoteRef"><span class="hs-identifier hs-type">freeReallyRemoteRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160711"><span class="hs-identifier hs-type">inst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160716"><span class="hs-identifier hs-type">rref</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1828"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">writeIORef</span></span><span> </span><span class="annot"><a href="#local-6989586621683160712"><span class="hs-identifier hs-type">th_state_var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="#local-6989586621683160719"><span class="hs-identifier hs-type">fhv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1829"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683160719"><span class="hs-identifier hs-type">fhv</span></a></span><span>
</span><span id="line-1830"></span><span>
</span><span id="line-1831"></span><span id="local-6989586621683158658"><span class="annot"><a href="GHC.Tc.Gen.Splice.html#wrapTHResult"><span class="hs-identifier hs-type">wrapTHResult</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683158658"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#THResult"><span class="hs-identifier hs-type">THResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683158658"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-1832"></span><span id="wrapTHResult"><span class="annot"><span class="annottext">wrapTHResult :: forall a. TcM a -&gt; TcM (THResult a)
</span><a href="GHC.Tc.Gen.Splice.html#wrapTHResult"><span class="hs-identifier hs-var hs-var">wrapTHResult</span></a></span></span><span> </span><span id="local-6989586621683160728"><span class="annot"><span class="annottext">TcM a
</span><a href="#local-6989586621683160728"><span class="hs-identifier hs-var">tcm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1833"></span><span>  </span><span id="local-6989586621683160729"><span class="annot"><a href="#local-6989586621683160729"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM a -&gt; IOEnv (Env TcGblEnv TcLclEnv) (Either IOEnvFailure a)
forall env r. IOEnv env r -&gt; IOEnv env (Either IOEnvFailure r)
</span><a href="GHC.Data.IOEnv.html#tryM"><span class="hs-identifier hs-var">tryM</span></a></span><span> </span><span class="annot"><span class="annottext">TcM a
</span><a href="#local-6989586621683160728"><span class="hs-identifier hs-var">tcm</span></a></span><span>   </span><span class="hs-comment">-- only catch 'fail', treat everything else as catastrophic</span><span>
</span><span id="line-1834"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683160729"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1835"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621683160730"><span class="annot"><span class="annottext">IOEnvFailure
</span><a href="#local-6989586621683160730"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">THResult a -&gt; IOEnv (Env TcGblEnv TcLclEnv) (THResult a)
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; THResult a
forall a. String -&gt; THResult a
</span><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#THException"><span class="hs-identifier hs-var">THException</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IOEnvFailure -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">IOEnvFailure
</span><a href="#local-6989586621683160730"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1836"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621683160733"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683160733"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">THResult a -&gt; IOEnv (Env TcGblEnv TcLclEnv) (THResult a)
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; THResult a
forall a. a -&gt; THResult a
</span><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#THComplete"><span class="hs-identifier hs-var">THComplete</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683160733"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1837"></span><span>
</span><span id="line-1838"></span><span id="local-6989586621683158641"><span class="annot"><a href="GHC.Tc.Gen.Splice.html#handleTHMessage"><span class="hs-identifier hs-type">handleTHMessage</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#THMessage"><span class="hs-identifier hs-type">THMessage</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683158641"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683158641"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-1839"></span><span id="handleTHMessage"><span class="annot"><span class="annottext">handleTHMessage :: forall a. THMessage a -&gt; TcM a
</span><a href="GHC.Tc.Gen.Splice.html#handleTHMessage"><span class="hs-identifier hs-var hs-var">handleTHMessage</span></a></span></span><span> </span><span id="local-6989586621683160739"><span class="annot"><span class="annottext">THMessage a
</span><a href="#local-6989586621683160739"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">THMessage a
</span><a href="#local-6989586621683160739"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1840"></span><span>  </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#NewName"><span class="hs-identifier hs-type">NewName</span></a></span><span> </span><span id="local-6989586621683160743"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160743"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcM Name -&gt; TcM (THResult Name)
forall a. TcM a -&gt; TcM (THResult a)
</span><a href="GHC.Tc.Gen.Splice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a></span><span> </span><span class="annot"><span class="annottext">(TcM Name -&gt; TcM (THResult Name))
-&gt; TcM Name -&gt; TcM (THResult Name)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; TcM Name
forall (m :: * -&gt; *). Quasi m =&gt; String -&gt; m Name
</span><span class="hs-identifier hs-var">TH.qNewName</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160743"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-1841"></span><span>  </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#Report"><span class="hs-identifier hs-type">Report</span></a></span><span> </span><span id="local-6989586621683160747"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683160747"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621683160748"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160748"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcRn () -&gt; TcM (THResult ())
forall a. TcM a -&gt; TcM (THResult a)
</span><a href="GHC.Tc.Gen.Splice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRn () -&gt; TcM (THResult ())) -&gt; TcRn () -&gt; TcM (THResult ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; String -&gt; TcRn ()
forall (m :: * -&gt; *). Quasi m =&gt; Bool -&gt; String -&gt; m ()
</span><span class="hs-identifier hs-var">TH.qReport</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683160747"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160748"><span class="hs-identifier hs-var">str</span></a></span><span>
</span><span id="line-1842"></span><span>  </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#LookupName"><span class="hs-identifier hs-type">LookupName</span></a></span><span> </span><span id="local-6989586621683160752"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683160752"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621683160753"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160753"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcM (Maybe Name) -&gt; TcM (THResult (Maybe Name))
forall a. TcM a -&gt; TcM (THResult a)
</span><a href="GHC.Tc.Gen.Splice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a></span><span> </span><span class="annot"><span class="annottext">(TcM (Maybe Name) -&gt; TcM (THResult (Maybe Name)))
-&gt; TcM (Maybe Name) -&gt; TcM (THResult (Maybe Name))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; String -&gt; TcM (Maybe Name)
forall (m :: * -&gt; *). Quasi m =&gt; Bool -&gt; String -&gt; m (Maybe Name)
</span><span class="hs-identifier hs-var">TH.qLookupName</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683160752"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160753"><span class="hs-identifier hs-var">str</span></a></span><span>
</span><span id="line-1843"></span><span>  </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#Reify"><span class="hs-identifier hs-type">Reify</span></a></span><span> </span><span id="local-6989586621683160757"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160757"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcM Info -&gt; TcM (THResult Info)
forall a. TcM a -&gt; TcM (THResult a)
</span><a href="GHC.Tc.Gen.Splice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a></span><span> </span><span class="annot"><span class="annottext">(TcM Info -&gt; TcM (THResult Info))
-&gt; TcM Info -&gt; TcM (THResult Info)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM Info
forall (m :: * -&gt; *). Quasi m =&gt; Name -&gt; m Info
</span><span class="hs-identifier hs-var">TH.qReify</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160757"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1844"></span><span>  </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#ReifyFixity"><span class="hs-identifier hs-type">ReifyFixity</span></a></span><span> </span><span id="local-6989586621683160761"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160761"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcM (Maybe Fixity) -&gt; TcM (THResult (Maybe Fixity))
forall a. TcM a -&gt; TcM (THResult a)
</span><a href="GHC.Tc.Gen.Splice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a></span><span> </span><span class="annot"><span class="annottext">(TcM (Maybe Fixity) -&gt; TcM (THResult (Maybe Fixity)))
-&gt; TcM (Maybe Fixity) -&gt; TcM (THResult (Maybe Fixity))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM (Maybe Fixity)
forall (m :: * -&gt; *). Quasi m =&gt; Name -&gt; m (Maybe Fixity)
</span><span class="hs-identifier hs-var">TH.qReifyFixity</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160761"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1845"></span><span>  </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#ReifyType"><span class="hs-identifier hs-type">ReifyType</span></a></span><span> </span><span id="local-6989586621683160765"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160765"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcM Type -&gt; TcM (THResult Type)
forall a. TcM a -&gt; TcM (THResult a)
</span><a href="GHC.Tc.Gen.Splice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a></span><span> </span><span class="annot"><span class="annottext">(TcM Type -&gt; TcM (THResult Type))
-&gt; TcM Type -&gt; TcM (THResult Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM Type
forall (m :: * -&gt; *). Quasi m =&gt; Name -&gt; m Type
</span><span class="hs-identifier hs-var">TH.qReifyType</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160765"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1846"></span><span>  </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#ReifyInstances"><span class="hs-identifier hs-type">ReifyInstances</span></a></span><span> </span><span id="local-6989586621683160769"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160769"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621683160770"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683160770"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcM [Dec] -&gt; TcM (THResult [Dec])
forall a. TcM a -&gt; TcM (THResult a)
</span><a href="GHC.Tc.Gen.Splice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a></span><span> </span><span class="annot"><span class="annottext">(TcM [Dec] -&gt; TcM (THResult [Dec]))
-&gt; TcM [Dec] -&gt; TcM (THResult [Dec])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; [Type] -&gt; TcM [Dec]
forall (m :: * -&gt; *). Quasi m =&gt; Name -&gt; [Type] -&gt; m [Dec]
</span><span class="hs-identifier hs-var">TH.qReifyInstances</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160769"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683160770"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-1847"></span><span>  </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#ReifyRoles"><span class="hs-identifier hs-type">ReifyRoles</span></a></span><span> </span><span id="local-6989586621683160774"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160774"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcM [Role] -&gt; TcM (THResult [Role])
forall a. TcM a -&gt; TcM (THResult a)
</span><a href="GHC.Tc.Gen.Splice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a></span><span> </span><span class="annot"><span class="annottext">(TcM [Role] -&gt; TcM (THResult [Role]))
-&gt; TcM [Role] -&gt; TcM (THResult [Role])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM [Role]
forall (m :: * -&gt; *). Quasi m =&gt; Name -&gt; m [Role]
</span><span class="hs-identifier hs-var">TH.qReifyRoles</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160774"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1848"></span><span>  </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#ReifyAnnotations"><span class="hs-identifier hs-type">ReifyAnnotations</span></a></span><span> </span><span id="local-6989586621683160778"><span class="annot"><span class="annottext">AnnLookup
</span><a href="#local-6989586621683160778"><span class="hs-identifier hs-var">lookup</span></a></span></span><span> </span><span id="local-6989586621683160779"><span class="annot"><span class="annottext">TypeRep
</span><a href="#local-6989586621683160779"><span class="hs-identifier hs-var">tyrep</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1849"></span><span>    </span><span class="annot"><span class="annottext">TcM [ByteString] -&gt; TcM (THResult [ByteString])
forall a. TcM a -&gt; TcM (THResult a)
</span><a href="GHC.Tc.Gen.Splice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a></span><span> </span><span class="annot"><span class="annottext">(TcM [ByteString] -&gt; TcM (THResult [ByteString]))
-&gt; TcM [ByteString] -&gt; TcM (THResult [ByteString])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([Word8] -&gt; ByteString) -&gt; [[Word8]] -&gt; [ByteString]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">[Word8] -&gt; ByteString
</span><a href="../../bytestring-0.12.2.0-7dd0/src/Data.ByteString.html#pack"><span class="hs-identifier hs-var">B.pack</span></a></span><span> </span><span class="annot"><span class="annottext">([[Word8]] -&gt; [ByteString])
-&gt; IOEnv (Env TcGblEnv TcLclEnv) [[Word8]] -&gt; TcM [ByteString]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">AnnLookup -&gt; TypeRep -&gt; IOEnv (Env TcGblEnv TcLclEnv) [[Word8]]
</span><a href="GHC.Tc.Gen.Splice.html#getAnnotationsByTypeRep"><span class="hs-identifier hs-var">getAnnotationsByTypeRep</span></a></span><span> </span><span class="annot"><span class="annottext">AnnLookup
</span><a href="#local-6989586621683160778"><span class="hs-identifier hs-var">lookup</span></a></span><span> </span><span class="annot"><span class="annottext">TypeRep
</span><a href="#local-6989586621683160779"><span class="hs-identifier hs-var">tyrep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1850"></span><span>  </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#ReifyModule"><span class="hs-identifier hs-type">ReifyModule</span></a></span><span> </span><span id="local-6989586621683160785"><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621683160785"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcM ModuleInfo -&gt; TcM (THResult ModuleInfo)
forall a. TcM a -&gt; TcM (THResult a)
</span><a href="GHC.Tc.Gen.Splice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a></span><span> </span><span class="annot"><span class="annottext">(TcM ModuleInfo -&gt; TcM (THResult ModuleInfo))
-&gt; TcM ModuleInfo -&gt; TcM (THResult ModuleInfo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Module -&gt; TcM ModuleInfo
forall (m :: * -&gt; *). Quasi m =&gt; Module -&gt; m ModuleInfo
</span><span class="hs-identifier hs-var">TH.qReifyModule</span></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621683160785"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-1851"></span><span>  </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#ReifyConStrictness"><span class="hs-identifier hs-type">ReifyConStrictness</span></a></span><span> </span><span id="local-6989586621683160789"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160789"><span class="hs-identifier hs-var">nm</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcM [DecidedStrictness] -&gt; TcM (THResult [DecidedStrictness])
forall a. TcM a -&gt; TcM (THResult a)
</span><a href="GHC.Tc.Gen.Splice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a></span><span> </span><span class="annot"><span class="annottext">(TcM [DecidedStrictness] -&gt; TcM (THResult [DecidedStrictness]))
-&gt; TcM [DecidedStrictness] -&gt; TcM (THResult [DecidedStrictness])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM [DecidedStrictness]
forall (m :: * -&gt; *). Quasi m =&gt; Name -&gt; m [DecidedStrictness]
</span><span class="hs-identifier hs-var">TH.qReifyConStrictness</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160789"><span class="hs-identifier hs-var">nm</span></a></span><span>
</span><span id="line-1852"></span><span>  </span><span class="annot"><span class="annottext">THMessage a
</span><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#GetPackageRoot"><span class="hs-identifier hs-var">GetPackageRoot</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IOEnv (Env TcGblEnv TcLclEnv) String -&gt; TcM (THResult String)
forall a. TcM a -&gt; TcM (THResult a)
</span><a href="GHC.Tc.Gen.Splice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a></span><span> </span><span class="annot"><span class="annottext">(IOEnv (Env TcGblEnv TcLclEnv) String -&gt; TcM (THResult String))
-&gt; IOEnv (Env TcGblEnv TcLclEnv) String -&gt; TcM (THResult String)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IOEnv (Env TcGblEnv TcLclEnv) String
forall (m :: * -&gt; *). Quasi m =&gt; m String
</span><span class="hs-identifier hs-var">TH.qGetPackageRoot</span></span><span>
</span><span id="line-1853"></span><span>  </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#AddDependentFile"><span class="hs-identifier hs-type">AddDependentFile</span></a></span><span> </span><span id="local-6989586621683160796"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160796"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcRn () -&gt; TcM (THResult ())
forall a. TcM a -&gt; TcM (THResult a)
</span><a href="GHC.Tc.Gen.Splice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRn () -&gt; TcM (THResult ())) -&gt; TcRn () -&gt; TcM (THResult ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; TcRn ()
forall (m :: * -&gt; *). Quasi m =&gt; String -&gt; m ()
</span><span class="hs-identifier hs-var">TH.qAddDependentFile</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160796"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-1854"></span><span>  </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#AddTempFile"><span class="hs-identifier hs-type">AddTempFile</span></a></span><span> </span><span id="local-6989586621683160800"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160800"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IOEnv (Env TcGblEnv TcLclEnv) String -&gt; TcM (THResult String)
forall a. TcM a -&gt; TcM (THResult a)
</span><a href="GHC.Tc.Gen.Splice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a></span><span> </span><span class="annot"><span class="annottext">(IOEnv (Env TcGblEnv TcLclEnv) String -&gt; TcM (THResult String))
-&gt; IOEnv (Env TcGblEnv TcLclEnv) String -&gt; TcM (THResult String)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; IOEnv (Env TcGblEnv TcLclEnv) String
forall (m :: * -&gt; *). Quasi m =&gt; String -&gt; m String
</span><span class="hs-identifier hs-var">TH.qAddTempFile</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160800"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1855"></span><span>  </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#AddModFinalizer"><span class="hs-identifier hs-type">AddModFinalizer</span></a></span><span> </span><span id="local-6989586621683160807"><span class="annot"><span class="annottext">RemoteRef (Q ())
</span><a href="#local-6989586621683160807"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1856"></span><span>    </span><span id="local-6989586621683160808"><span class="annot"><a href="#local-6989586621683160808"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; Interp
</span><a href="GHC.Driver.Env.html#hscInterp"><span class="hs-identifier hs-var">hscInterp</span></a></span><span> </span><span class="annot"><span class="annottext">(HscEnv -&gt; Interp) -&gt; TcRnIf TcGblEnv TcLclEnv HscEnv -&gt; TcM Interp
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TcRnIf TcGblEnv TcLclEnv HscEnv
forall gbl lcl. TcRnIf gbl lcl HscEnv
</span><a href="GHC.Tc.Utils.Monad.html#getTopEnv"><span class="hs-identifier hs-var">getTopEnv</span></a></span><span>
</span><span id="line-1857"></span><span>    </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#wrapTHResult"><span class="hs-identifier hs-type">wrapTHResult</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Runtime.Interpreter.html#mkFinalizedHValue"><span class="hs-identifier hs-type">mkFinalizedHValue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160808"><span class="hs-identifier hs-type">interp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160807"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">&gt;&gt;=</span></span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#addModFinalizerRef"><span class="hs-identifier hs-type">addModFinalizerRef</span></a></span><span>
</span><span id="line-1858"></span><span>  </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#AddCorePlugin"><span class="hs-identifier hs-type">AddCorePlugin</span></a></span><span> </span><span id="local-6989586621683160814"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160814"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcRn () -&gt; TcM (THResult ())
forall a. TcM a -&gt; TcM (THResult a)
</span><a href="GHC.Tc.Gen.Splice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRn () -&gt; TcM (THResult ())) -&gt; TcRn () -&gt; TcM (THResult ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; TcRn ()
forall (m :: * -&gt; *). Quasi m =&gt; String -&gt; m ()
</span><span class="hs-identifier hs-var">TH.qAddCorePlugin</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160814"><span class="hs-identifier hs-var">str</span></a></span><span>
</span><span id="line-1859"></span><span>  </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#AddTopDecls"><span class="hs-identifier hs-type">AddTopDecls</span></a></span><span> </span><span id="local-6989586621683160818"><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621683160818"><span class="hs-identifier hs-var">decs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcRn () -&gt; TcM (THResult ())
forall a. TcM a -&gt; TcM (THResult a)
</span><a href="GHC.Tc.Gen.Splice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRn () -&gt; TcM (THResult ())) -&gt; TcRn () -&gt; TcM (THResult ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Dec] -&gt; TcRn ()
forall (m :: * -&gt; *). Quasi m =&gt; [Dec] -&gt; m ()
</span><span class="hs-identifier hs-var">TH.qAddTopDecls</span></span><span> </span><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621683160818"><span class="hs-identifier hs-var">decs</span></a></span><span>
</span><span id="line-1860"></span><span>  </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#AddForeignFilePath"><span class="hs-identifier hs-type">AddForeignFilePath</span></a></span><span> </span><span id="local-6989586621683160822"><span class="annot"><span class="annottext">ForeignSrcLang
</span><a href="#local-6989586621683160822"><span class="hs-identifier hs-var">lang</span></a></span></span><span> </span><span id="local-6989586621683160823"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160823"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcRn () -&gt; TcM (THResult ())
forall a. TcM a -&gt; TcM (THResult a)
</span><a href="GHC.Tc.Gen.Splice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRn () -&gt; TcM (THResult ())) -&gt; TcRn () -&gt; TcM (THResult ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ForeignSrcLang -&gt; String -&gt; TcRn ()
forall (m :: * -&gt; *). Quasi m =&gt; ForeignSrcLang -&gt; String -&gt; m ()
</span><span class="hs-identifier hs-var">TH.qAddForeignFilePath</span></span><span> </span><span class="annot"><span class="annottext">ForeignSrcLang
</span><a href="#local-6989586621683160822"><span class="hs-identifier hs-var">lang</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160823"><span class="hs-identifier hs-var">str</span></a></span><span>
</span><span id="line-1861"></span><span>  </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#IsExtEnabled"><span class="hs-identifier hs-type">IsExtEnabled</span></a></span><span> </span><span id="local-6989586621683160827"><span class="annot"><span class="annottext">Extension
</span><a href="#local-6989586621683160827"><span class="hs-identifier hs-var">ext</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcM Bool -&gt; TcM (THResult Bool)
forall a. TcM a -&gt; TcM (THResult a)
</span><a href="GHC.Tc.Gen.Splice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a></span><span> </span><span class="annot"><span class="annottext">(TcM Bool -&gt; TcM (THResult Bool))
-&gt; TcM Bool -&gt; TcM (THResult Bool)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Extension -&gt; TcM Bool
forall (m :: * -&gt; *). Quasi m =&gt; Extension -&gt; m Bool
</span><span class="hs-identifier hs-var">TH.qIsExtEnabled</span></span><span> </span><span class="annot"><span class="annottext">Extension
</span><a href="#local-6989586621683160827"><span class="hs-identifier hs-var">ext</span></a></span><span>
</span><span id="line-1862"></span><span>  </span><span class="annot"><span class="annottext">THMessage a
</span><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#ExtsEnabled"><span class="hs-identifier hs-var">ExtsEnabled</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcM [Extension] -&gt; TcM (THResult [Extension])
forall a. TcM a -&gt; TcM (THResult a)
</span><a href="GHC.Tc.Gen.Splice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a></span><span> </span><span class="annot"><span class="annottext">(TcM [Extension] -&gt; TcM (THResult [Extension]))
-&gt; TcM [Extension] -&gt; TcM (THResult [Extension])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TcM [Extension]
forall (m :: * -&gt; *). Quasi m =&gt; m [Extension]
</span><span class="hs-identifier hs-var">TH.qExtsEnabled</span></span><span>
</span><span id="line-1863"></span><span>  </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#PutDoc"><span class="hs-identifier hs-type">PutDoc</span></a></span><span> </span><span id="local-6989586621683160834"><span class="annot"><span class="annottext">DocLoc
</span><a href="#local-6989586621683160834"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621683160835"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160835"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcRn () -&gt; TcM (THResult ())
forall a. TcM a -&gt; TcM (THResult a)
</span><a href="GHC.Tc.Gen.Splice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRn () -&gt; TcM (THResult ())) -&gt; TcRn () -&gt; TcM (THResult ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DocLoc -&gt; String -&gt; TcRn ()
forall (m :: * -&gt; *). Quasi m =&gt; DocLoc -&gt; String -&gt; m ()
</span><span class="hs-identifier hs-var">TH.qPutDoc</span></span><span> </span><span class="annot"><span class="annottext">DocLoc
</span><a href="#local-6989586621683160834"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160835"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1864"></span><span>  </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#GetDoc"><span class="hs-identifier hs-type">GetDoc</span></a></span><span> </span><span id="local-6989586621683160839"><span class="annot"><span class="annottext">DocLoc
</span><a href="#local-6989586621683160839"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcM (Maybe String) -&gt; TcM (THResult (Maybe String))
forall a. TcM a -&gt; TcM (THResult a)
</span><a href="GHC.Tc.Gen.Splice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a></span><span> </span><span class="annot"><span class="annottext">(TcM (Maybe String) -&gt; TcM (THResult (Maybe String)))
-&gt; TcM (Maybe String) -&gt; TcM (THResult (Maybe String))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DocLoc -&gt; TcM (Maybe String)
forall (m :: * -&gt; *). Quasi m =&gt; DocLoc -&gt; m (Maybe String)
</span><span class="hs-identifier hs-var">TH.qGetDoc</span></span><span> </span><span class="annot"><span class="annottext">DocLoc
</span><a href="#local-6989586621683160839"><span class="hs-identifier hs-var">l</span></a></span><span>
</span><span id="line-1865"></span><span>  </span><span class="annot"><span class="annottext">THMessage a
</span><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#FailIfErrs"><span class="hs-identifier hs-var">FailIfErrs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcRn () -&gt; TcM (THResult ())
forall a. TcM a -&gt; TcM (THResult a)
</span><a href="GHC.Tc.Gen.Splice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a></span><span> </span><span class="annot"><span class="annottext">TcRn ()
</span><a href="GHC.Tc.Utils.Monad.html#failIfErrsM"><span class="hs-identifier hs-var">failIfErrsM</span></a></span><span>
</span><span id="line-1866"></span><span>  </span><span class="annot"><span class="annottext">THMessage a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; TcM a
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;handleTHMessage: unexpected message &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">THMessage a -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">THMessage a
</span><a href="#local-6989586621683160739"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1867"></span><span>
</span><span id="line-1868"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#getAnnotationsByTypeRep"><span class="hs-identifier hs-type">getAnnotationsByTypeRep</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.AnnLookup</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeRep</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-1869"></span><span id="getAnnotationsByTypeRep"><span class="annot"><span class="annottext">getAnnotationsByTypeRep :: AnnLookup -&gt; TypeRep -&gt; IOEnv (Env TcGblEnv TcLclEnv) [[Word8]]
</span><a href="GHC.Tc.Gen.Splice.html#getAnnotationsByTypeRep"><span class="hs-identifier hs-var hs-var">getAnnotationsByTypeRep</span></a></span></span><span> </span><span id="local-6989586621683160842"><span class="annot"><span class="annottext">AnnLookup
</span><a href="#local-6989586621683160842"><span class="hs-identifier hs-var">th_name</span></a></span></span><span> </span><span id="local-6989586621683160843"><span class="annot"><span class="annottext">TypeRep
</span><a href="#local-6989586621683160843"><span class="hs-identifier hs-var">tyrep</span></a></span></span><span>
</span><span id="line-1870"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683160844"><span class="annot"><a href="#local-6989586621683160844"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AnnLookup -&gt; TcM CoreAnnTarget
</span><a href="GHC.Tc.Gen.Splice.html#lookupThAnnLookup"><span class="hs-identifier hs-var">lookupThAnnLookup</span></a></span><span> </span><span class="annot"><span class="annottext">AnnLookup
</span><a href="#local-6989586621683160842"><span class="hs-identifier hs-var">th_name</span></a></span><span>
</span><span id="line-1871"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683160846"><span class="annot"><a href="#local-6989586621683160846"><span class="hs-identifier hs-var">topEnv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#getTopEnv"><span class="hs-identifier hs-type">getTopEnv</span></a></span><span>
</span><span id="line-1872"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683160847"><span class="annot"><a href="#local-6989586621683160847"><span class="hs-identifier hs-var">epsHptAnns</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Driver.Env.html#prepareAnnotations"><span class="hs-identifier hs-type">prepareAnnotations</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160846"><span class="hs-identifier hs-type">topEnv</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span>
</span><span id="line-1873"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683160849"><span class="annot"><a href="#local-6989586621683160849"><span class="hs-identifier hs-var">tcg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#getGblEnv"><span class="hs-identifier hs-type">getGblEnv</span></a></span><span>
</span><span id="line-1874"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683160850"><span class="annot"><a href="#local-6989586621683160850"><span class="hs-identifier hs-var hs-var">selectedEpsHptAnns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnnEnv -&gt; CoreAnnTarget -&gt; TypeRep -&gt; [[Word8]]
</span><a href="GHC.Types.Annotations.html#findAnnsByTypeRep"><span class="hs-identifier hs-var">findAnnsByTypeRep</span></a></span><span> </span><span class="annot"><span class="annottext">AnnEnv
</span><a href="#local-6989586621683160847"><span class="hs-identifier hs-var">epsHptAnns</span></a></span><span> </span><span class="annot"><span class="annottext">CoreAnnTarget
</span><a href="#local-6989586621683160844"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">TypeRep
</span><a href="#local-6989586621683160843"><span class="hs-identifier hs-var">tyrep</span></a></span><span>
</span><span id="line-1875"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683160852"><span class="annot"><a href="#local-6989586621683160852"><span class="hs-identifier hs-var hs-var">selectedTcgAnns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnnEnv -&gt; CoreAnnTarget -&gt; TypeRep -&gt; [[Word8]]
</span><a href="GHC.Types.Annotations.html#findAnnsByTypeRep"><span class="hs-identifier hs-var">findAnnsByTypeRep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcGblEnv -&gt; AnnEnv
</span><a href="GHC.Tc.Types.html#tcg_ann_env"><span class="hs-identifier hs-var">tcg_ann_env</span></a></span><span> </span><span class="annot"><span class="annottext">TcGblEnv
</span><a href="#local-6989586621683160849"><span class="hs-identifier hs-var">tcg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreAnnTarget
</span><a href="#local-6989586621683160844"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">TypeRep
</span><a href="#local-6989586621683160843"><span class="hs-identifier hs-var">tyrep</span></a></span><span>
</span><span id="line-1876"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683160850"><span class="hs-identifier hs-type">selectedEpsHptAnns</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621683160852"><span class="hs-identifier hs-type">selectedTcgAnns</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1877"></span><span>
</span><span id="line-1878"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
            Instance Testing
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-1885"></span><span>
</span><span id="line-1886"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyInstances"><span class="hs-identifier hs-type">reifyInstances</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">TH.Type</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">TH.Dec</span></span><span class="hs-special">]</span><span>
</span><span id="line-1887"></span><span id="reifyInstances"><span class="annot"><span class="annottext">reifyInstances :: Name -&gt; [Type] -&gt; TcM [Dec]
</span><a href="GHC.Tc.Gen.Splice.html#reifyInstances"><span class="hs-identifier hs-var hs-var">reifyInstances</span></a></span></span><span> </span><span id="local-6989586621683160854"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160854"><span class="hs-identifier hs-var">th_nm</span></a></span></span><span> </span><span id="local-6989586621683160855"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683160855"><span class="hs-identifier hs-var">th_tys</span></a></span></span><span>
</span><span id="line-1888"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683160856"><span class="annot"><a href="#local-6989586621683160856"><span class="hs-identifier hs-var">insts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name
-&gt; [Type] -&gt; TcM (Either (Class, [ClsInst]) (TyCon, [FamInst]))
</span><a href="GHC.Tc.Gen.Splice.html#reifyInstances%27"><span class="hs-identifier hs-var">reifyInstances'</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160854"><span class="hs-identifier hs-var">th_nm</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683160855"><span class="hs-identifier hs-var">th_tys</span></a></span><span>
</span><span id="line-1889"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683160856"><span class="hs-identifier hs-type">insts</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1890"></span><span>           </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683160857"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683160857"><span class="hs-identifier hs-var">cls</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683160858"><span class="annot"><span class="annottext">[ClsInst]
</span><a href="#local-6989586621683160858"><span class="hs-identifier hs-var">cls_insts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1891"></span><span>             </span><span class="annot"><span class="annottext">Class -&gt; [ClsInst] -&gt; TcM [Dec]
</span><a href="GHC.Tc.Gen.Splice.html#reifyClassInstances"><span class="hs-identifier hs-var">reifyClassInstances</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683160857"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">[ClsInst]
</span><a href="#local-6989586621683160858"><span class="hs-identifier hs-var">cls_insts</span></a></span><span>
</span><span id="line-1892"></span><span>           </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683160860"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683160860"><span class="hs-identifier hs-var">tc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683160861"><span class="annot"><span class="annottext">[FamInst]
</span><a href="#local-6989586621683160861"><span class="hs-identifier hs-var">fam_insts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1893"></span><span>             </span><span class="annot"><span class="annottext">TyCon -&gt; [FamInst] -&gt; TcM [Dec]
</span><a href="GHC.Tc.Gen.Splice.html#reifyFamilyInstances"><span class="hs-identifier hs-var">reifyFamilyInstances</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683160860"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[FamInst]
</span><a href="#local-6989586621683160861"><span class="hs-identifier hs-var">fam_insts</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1894"></span><span>
</span><span id="line-1895"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyInstances%27"><span class="hs-identifier hs-type">reifyInstances'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Name</span></span><span>
</span><span id="line-1896"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">TH.Type</span></span><span class="hs-special">]</span><span>
</span><span id="line-1897"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Class.html#Class"><span class="hs-identifier hs-type">Class</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.InstEnv.html#ClsInst"><span class="hs-identifier hs-type">ClsInst</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1898"></span><span>                </span><span class="hs-comment">-- ^ Returns 'Left' in the case that the instances were found to</span><span>
</span><span id="line-1899"></span><span>                </span><span class="hs-comment">-- be class instances, or 'Right' if they are family instances.</span><span>
</span><span id="line-1900"></span><span id="reifyInstances%27"><span class="annot"><span class="annottext">reifyInstances' :: Name
-&gt; [Type] -&gt; TcM (Either (Class, [ClsInst]) (TyCon, [FamInst]))
</span><a href="GHC.Tc.Gen.Splice.html#reifyInstances%27"><span class="hs-identifier hs-var hs-var">reifyInstances'</span></a></span></span><span> </span><span id="local-6989586621683160863"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160863"><span class="hs-identifier hs-var">th_nm</span></a></span></span><span> </span><span id="local-6989586621683160864"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683160864"><span class="hs-identifier hs-var">th_tys</span></a></span></span><span>
</span><span id="line-1901"></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SDoc
-&gt; TcM (Either (Class, [ClsInst]) (TyCon, [FamInst]))
-&gt; TcM (Either (Class, [ClsInst]) (TyCon, [FamInst]))
forall a. SDoc -&gt; TcM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;In the argument of reifyInstances:&quot;</span></span><span>
</span><span id="line-1902"></span><span>                 </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; SDoc
forall a. Ppr a =&gt; a -&gt; SDoc
</span><a href="GHC.Tc.Gen.Splice.html#ppr_th"><span class="hs-identifier hs-var">ppr_th</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160863"><span class="hs-identifier hs-var">th_nm</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Type -&gt; SDoc) -&gt; [Type] -&gt; [SDoc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; SDoc
forall a. Ppr a =&gt; a -&gt; SDoc
</span><a href="GHC.Tc.Gen.Splice.html#ppr_th"><span class="hs-identifier hs-var">ppr_th</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683160864"><span class="hs-identifier hs-var">th_tys</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcM (Either (Class, [ClsInst]) (TyCon, [FamInst]))
 -&gt; TcM (Either (Class, [ClsInst]) (TyCon, [FamInst])))
-&gt; TcM (Either (Class, [ClsInst]) (TyCon, [FamInst]))
-&gt; TcM (Either (Class, [ClsInst]) (TyCon, [FamInst]))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1903"></span><span>     </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683160867"><span class="annot"><a href="#local-6989586621683160867"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcRn SrcSpan
</span><a href="GHC.Tc.Utils.Monad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a></span><span>
</span><span id="line-1904"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683160868"><span class="annot"><a href="#local-6989586621683160868"><span class="hs-identifier hs-var">th_origin</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#getThSpliceOrigin"><span class="hs-identifier hs-type">getThSpliceOrigin</span></a></span><span>
</span><span id="line-1905"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683160869"><span class="annot"><a href="#local-6989586621683160869"><span class="hs-identifier hs-var">rdr_ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621683160870"><span class="hs-identifier hs-type">cvt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160868"><span class="hs-identifier hs-type">th_origin</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160867"><span class="hs-identifier hs-type">loc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#mkThAppTs"><span class="hs-identifier hs-type">mkThAppTs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.ConT</span></span><span> </span><span class="annot"><a href="#local-6989586621683160863"><span class="hs-identifier hs-type">th_nm</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683160864"><span class="hs-identifier hs-type">th_tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1906"></span><span>          </span><span class="hs-comment">-- #9262 says to bring vars into scope, like in HsForAllTy case</span><span>
</span><span id="line-1907"></span><span>          </span><span class="hs-comment">-- of rnHsTyKi</span><span>
</span><span id="line-1908"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683160872"><span class="annot"><a href="#local-6989586621683160872"><span class="hs-identifier hs-var">tv_rdrs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Rename.HsType.html#filterInScopeM"><span class="hs-identifier hs-type">filterInScopeM</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Rename.HsType.html#extractHsTyRdrTyVars"><span class="hs-identifier hs-type">extractHsTyRdrTyVars</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160869"><span class="hs-identifier hs-type">rdr_ty</span></a></span><span>
</span><span id="line-1909"></span><span>          </span><span class="hs-comment">-- Rename  to HsType Name</span><span>
</span><span id="line-1910"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621683160875"><span class="annot"><a href="#local-6989586621683160875"><span class="hs-identifier hs-var">tv_names</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683160876"><span class="annot"><a href="#local-6989586621683160876"><span class="hs-identifier hs-var">rn_ty</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621683160877"><span class="annot"><a href="#local-6989586621683160877"><span class="hs-identifier hs-var">_fvs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1911"></span><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#checkNoErrs"><span class="hs-identifier hs-type">checkNoErrs</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-comment">-- If there are out-of-scope Names here, then we</span><span>
</span><span id="line-1912"></span><span>                             </span><span class="hs-comment">-- must error before proceeding to typecheck the</span><span>
</span><span id="line-1913"></span><span>                             </span><span class="hs-comment">-- renamed type, as that will result in GHC</span><span>
</span><span id="line-1914"></span><span>                             </span><span class="hs-comment">-- internal errors (#13837).</span><span>
</span><span id="line-1915"></span><span>               </span><span class="annot"><a href="GHC.Rename.HsType.html#rnImplicitTvOccs"><span class="hs-identifier hs-type">rnImplicitTvOccs</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="annot"><a href="#local-6989586621683160872"><span class="hs-identifier hs-type">tv_rdrs</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621683160879"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621683160879"><span class="hs-identifier hs-var">tv_names</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1916"></span><span>               </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683160880"><span class="annot"><a href="#local-6989586621683160880"><span class="hs-identifier hs-var">rn_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683160881"><span class="annot"><a href="#local-6989586621683160881"><span class="hs-identifier hs-var">fvs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HsDocContext -&gt; LHsType GhcPs -&gt; RnM (LHsType GhcRn, FreeVars)
</span><a href="GHC.Rename.HsType.html#rnLHsType"><span class="hs-identifier hs-var">rnLHsType</span></a></span><span> </span><span class="annot"><span class="annottext">HsDocContext
</span><a href="#local-6989586621683160883"><span class="hs-identifier hs-var">doc</span></a></span><span> </span><span class="annot"><span class="annottext">LHsType GhcPs
GenLocated SrcSpanAnnA (HsType GhcPs)
</span><a href="#local-6989586621683160869"><span class="hs-identifier hs-var">rdr_ty</span></a></span><span>
</span><span id="line-1917"></span><span>                  </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683160879"><span class="hs-identifier hs-type">tv_names</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683160880"><span class="hs-identifier hs-type">rn_ty</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683160881"><span class="hs-identifier hs-type">fvs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1918"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683160884"><span class="annot"><a href="#local-6989586621683160884"><span class="hs-identifier hs-var">skol_info</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#mkSkolemInfo"><span class="hs-identifier hs-type">mkSkolemInfo</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#ReifySkol"><span class="hs-identifier hs-type">ReifySkol</span></a></span><span>
</span><span id="line-1919"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683160887"><span class="annot"><a href="#local-6989586621683160887"><span class="hs-identifier hs-var">tclvl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683160888"><span class="annot"><a href="#local-6989586621683160888"><span class="hs-identifier hs-var">wanted</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683160889"><span class="annot"><a href="#local-6989586621683160889"><span class="hs-identifier hs-var">tvs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683160890"><span class="annot"><a href="#local-6989586621683160890"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1920"></span><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#pushLevelAndSolveEqualitiesX"><span class="hs-identifier hs-type">pushLevelAndSolveEqualitiesX</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;reifyInstances&quot;</span></span><span>  </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-1921"></span><span>               </span><span class="annot"><a href="GHC.Tc.Gen.HsType.html#bindImplicitTKBndrs_Skol"><span class="hs-identifier hs-type">bindImplicitTKBndrs_Skol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160884"><span class="hs-identifier hs-type">skol_info</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160875"><span class="hs-identifier hs-type">tv_names</span></a></span><span>              </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-1922"></span><span>               </span><span class="annot"><a href="GHC.Tc.Gen.HsType.html#tcInferLHsType"><span class="hs-identifier hs-type">tcInferLHsType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160876"><span class="hs-identifier hs-type">rn_ty</span></a></span><span>
</span><span id="line-1923"></span><span>
</span><span id="line-1924"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683160894"><span class="annot"><a href="#local-6989586621683160894"><span class="hs-identifier hs-var">tvs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.HsType.html#zonkAndScopedSort"><span class="hs-identifier hs-type">zonkAndScopedSort</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160889"><span class="hs-identifier hs-type">tvs</span></a></span><span>
</span><span id="line-1925"></span><span>
</span><span id="line-1926"></span><span>        </span><span class="hs-comment">-- Avoid error cascade if there are unsolved</span><span>
</span><span id="line-1927"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#reportUnsolvedEqualities"><span class="hs-identifier hs-type">reportUnsolvedEqualities</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160884"><span class="hs-identifier hs-type">skol_info</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160894"><span class="hs-identifier hs-type">tvs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160887"><span class="hs-identifier hs-type">tclvl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160888"><span class="hs-identifier hs-type">wanted</span></a></span><span>
</span><span id="line-1928"></span><span>
</span><span id="line-1929"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683160897"><span class="annot"><a href="#local-6989586621683160897"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Zonk.Type.html#zonkTcTypeToType"><span class="hs-identifier hs-type">zonkTcTypeToType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160890"><span class="hs-identifier hs-type">ty</span></a></span><span>
</span><span id="line-1930"></span><span>                </span><span class="hs-comment">-- Substitute out the meta type variables</span><span>
</span><span id="line-1931"></span><span>                </span><span class="hs-comment">-- In particular, the type might have kind</span><span>
</span><span id="line-1932"></span><span>                </span><span class="hs-comment">-- variables inside it (#7477)</span><span>
</span><span id="line-1933"></span><span>
</span><span id="line-1934"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;reifyInstances'&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160897"><span class="hs-identifier hs-type">ty</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-type">$$</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-type">typeKind</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160897"><span class="hs-identifier hs-type">ty</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1935"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="GHC.Core.Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-type">splitTyConApp_maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160897"><span class="hs-identifier hs-type">ty</span></a></span><span> </span><span class="hs-keyword">of</span><span>   </span><span class="hs-comment">-- This expands any type synonyms</span><span>
</span><span id="line-1936"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683160901"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683160901"><span class="hs-identifier hs-var">tc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683160902"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683160902"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span>                 </span><span class="hs-comment">-- See #7910</span><span>
</span><span id="line-1937"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683160903"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683160903"><span class="hs-identifier hs-var">cls</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Maybe Class
</span><a href="GHC.Core.TyCon.html#tyConClass_maybe"><span class="hs-identifier hs-var">tyConClass_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683160901"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-1938"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683160905"><span class="annot"><a href="#local-6989586621683160905"><span class="hs-identifier hs-var">inst_envs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM InstEnvs
</span><a href="GHC.Tc.Utils.Env.html#tcGetInstEnvs"><span class="hs-identifier hs-var">tcGetInstEnvs</span></a></span><span>
</span><span id="line-1939"></span><span>                     </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683160907"><span class="annot"><a href="#local-6989586621683160907"><span class="hs-identifier hs-var">matches</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683160908"><span class="annot"><a href="#local-6989586621683160908"><span class="hs-identifier hs-var">unifies</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.InstEnv.html#lookupInstEnv"><span class="hs-identifier hs-type">lookupInstEnv</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span> </span><span class="annot"><a href="#local-6989586621683160905"><span class="hs-identifier hs-type">inst_envs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160903"><span class="hs-identifier hs-type">cls</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160902"><span class="hs-identifier hs-type">tys</span></a></span><span>
</span><span id="line-1940"></span><span>                     </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;reifyInstances'1&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160907"><span class="hs-identifier hs-type">matches</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1941"></span><span>                     </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683160903"><span class="hs-identifier hs-type">cls</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">fst</span></span><span> </span><span class="annot"><a href="#local-6989586621683160907"><span class="hs-identifier hs-type">matches</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="GHC.Core.InstEnv.html#getCoherentUnifiers"><span class="hs-identifier hs-type">getCoherentUnifiers</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160908"><span class="hs-identifier hs-type">unifies</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1942"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isOpenFamilyTyCon"><span class="hs-identifier hs-var">isOpenFamilyTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683160901"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-1943"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683160913"><span class="annot"><a href="#local-6989586621683160913"><span class="hs-identifier hs-var">inst_envs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM FamInstEnvs
</span><a href="GHC.Tc.Instance.Family.html#tcGetFamInstEnvs"><span class="hs-identifier hs-var">tcGetFamInstEnvs</span></a></span><span>
</span><span id="line-1944"></span><span>                     </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683160915"><span class="annot"><a href="#local-6989586621683160915"><span class="hs-identifier hs-var hs-var">matches</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FamInstEnvs -&gt; TyCon -&gt; [Type] -&gt; [FamInstMatch]
</span><a href="GHC.Core.FamInstEnv.html#lookupFamInstEnv"><span class="hs-identifier hs-var">lookupFamInstEnv</span></a></span><span> </span><span class="annot"><span class="annottext">FamInstEnvs
</span><a href="#local-6989586621683160913"><span class="hs-identifier hs-var">inst_envs</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683160901"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683160902"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-1945"></span><span>                     </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;reifyInstances'2&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160915"><span class="hs-identifier hs-type">matches</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1946"></span><span>                     </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683160901"><span class="hs-identifier hs-type">tc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">map</span></span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#fim_instance"><span class="hs-identifier hs-var">fim_instance</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160915"><span class="hs-identifier hs-type">matches</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1947"></span><span>            </span><span class="annot"><span class="annottext">Maybe (TyCon, [Type])
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; TcM (Either (Class, [ClsInst]) (TyCon, [FamInst]))
forall a. TcRnMessage -&gt; TcM a
</span><a href="#local-6989586621683160918"><span class="hs-identifier hs-var">bale_out</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; TcM (Either (Class, [ClsInst]) (TyCon, [FamInst])))
-&gt; TcRnMessage
-&gt; TcM (Either (Class, [ClsInst]) (TyCon, [FamInst]))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">THError -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnTHError"><span class="hs-identifier hs-var">TcRnTHError</span></a></span><span> </span><span class="annot"><span class="annottext">(THError -&gt; TcRnMessage) -&gt; THError -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">THReifyError -&gt; THError
</span><a href="GHC.Tc.Errors.Types.html#THReifyError"><span class="hs-identifier hs-var">THReifyError</span></a></span><span> </span><span class="annot"><span class="annottext">(THReifyError -&gt; THError) -&gt; THReifyError -&gt; THError
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; THReifyError
</span><a href="GHC.Tc.Errors.Types.html#CannotReifyInstance"><span class="hs-identifier hs-var">CannotReifyInstance</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683160897"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1948"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1949"></span><span>    </span><span id="local-6989586621683160883"><span class="annot"><span class="annottext">doc :: HsDocContext
</span><a href="#local-6989586621683160883"><span class="hs-identifier hs-var hs-var">doc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HsDocContext
</span><a href="GHC.Tc.Errors.Types.html#ClassInstanceCtx"><span class="hs-identifier hs-var">ClassInstanceCtx</span></a></span><span>
</span><span id="line-1950"></span><span>    </span><span id="local-6989586621683160918"><span class="annot"><span class="annottext">bale_out :: TcRnMessage -&gt; TcM a
</span><a href="#local-6989586621683160918"><span class="hs-identifier hs-var hs-var">bale_out</span></a></span></span><span> </span><span id="local-6989586621683160922"><span class="annot"><span class="annottext">TcRnMessage
</span><a href="#local-6989586621683160922"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; TcM a
forall a. TcRnMessage -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a></span><span> </span><span class="annot"><span class="annottext">TcRnMessage
</span><a href="#local-6989586621683160922"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-1951"></span><span>
</span><span id="line-1952"></span><span>    </span><span class="annot"><a href="#local-6989586621683160870"><span class="hs-identifier hs-type">cvt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Origin"><span class="hs-identifier hs-type">Origin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html#SrcSpan"><span class="hs-identifier hs-type">SrcSpan</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Type</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Type.html#LHsType"><span class="hs-identifier hs-type">LHsType</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcPs"><span class="hs-identifier hs-type">GhcPs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1953"></span><span>    </span><span id="local-6989586621683160870"><span class="annot"><span class="annottext">cvt :: Origin -&gt; SrcSpan -&gt; Type -&gt; TcM (LHsType GhcPs)
</span><a href="#local-6989586621683160870"><span class="hs-identifier hs-var hs-var">cvt</span></a></span></span><span> </span><span id="local-6989586621683160923"><span class="annot"><span class="annottext">Origin
</span><a href="#local-6989586621683160923"><span class="hs-identifier hs-var">origin</span></a></span></span><span> </span><span id="local-6989586621683160924"><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621683160924"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621683160925"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683160925"><span class="hs-identifier hs-var">th_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Origin
-&gt; SrcSpan -&gt; Type -&gt; Either RunSpliceFailReason (LHsType GhcPs)
</span><a href="GHC.ThToHs.html#convertToHsType"><span class="hs-identifier hs-var">convertToHsType</span></a></span><span> </span><span class="annot"><span class="annottext">Origin
</span><a href="#local-6989586621683160923"><span class="hs-identifier hs-var">origin</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621683160924"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683160925"><span class="hs-identifier hs-var">th_ty</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1954"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621683160926"><span class="annot"><span class="annottext">RunSpliceFailReason
</span><a href="#local-6989586621683160926"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcRnMessage
-&gt; IOEnv
     (Env TcGblEnv TcLclEnv) (GenLocated SrcSpanAnnA (HsType GhcPs))
forall a. TcRnMessage -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">THError -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnTHError"><span class="hs-identifier hs-var">TcRnTHError</span></a></span><span> </span><span class="annot"><span class="annottext">(THError -&gt; TcRnMessage) -&gt; THError -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SpliceFailReason -&gt; THError
</span><a href="GHC.Tc.Errors.Types.html#THSpliceFailed"><span class="hs-identifier hs-var">THSpliceFailed</span></a></span><span> </span><span class="annot"><span class="annottext">(SpliceFailReason -&gt; THError) -&gt; SpliceFailReason -&gt; THError
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RunSpliceFailReason -&gt; SpliceFailReason
</span><a href="GHC.Tc.Errors.Types.html#RunSpliceFailure"><span class="hs-identifier hs-var">RunSpliceFailure</span></a></span><span> </span><span class="annot"><span class="annottext">RunSpliceFailReason
</span><a href="#local-6989586621683160926"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1955"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621683160927"><span class="annot"><span class="annottext">LHsType GhcPs
</span><a href="#local-6989586621683160927"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">GenLocated SrcSpanAnnA (HsType GhcPs)
-&gt; IOEnv
     (Env TcGblEnv TcLclEnv) (GenLocated SrcSpanAnnA (HsType GhcPs))
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">LHsType GhcPs
GenLocated SrcSpanAnnA (HsType GhcPs)
</span><a href="#local-6989586621683160927"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1956"></span><span>
</span><span id="line-1957"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
                        Reification
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-1964"></span><span>
</span><span id="line-1965"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#lookupName"><span class="hs-identifier hs-type">lookupName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>      </span><span class="hs-comment">-- True  &lt;=&gt; type namespace</span><span>
</span><span id="line-1966"></span><span>                        </span><span class="hs-comment">-- False &lt;=&gt; value namespace</span><span>
</span><span id="line-1967"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Name</span></span><span class="hs-special">)</span><span>
</span><span id="line-1968"></span><span id="lookupName"><span class="annot"><span class="annottext">lookupName :: Bool -&gt; String -&gt; TcM (Maybe Name)
</span><a href="GHC.Tc.Gen.Splice.html#lookupName"><span class="hs-identifier hs-var hs-var">lookupName</span></a></span></span><span> </span><span id="local-6989586621683160928"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683160928"><span class="hs-identifier hs-var">is_type_name</span></a></span></span><span> </span><span id="local-6989586621683160929"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160929"><span class="hs-identifier hs-var">s</span></a></span></span><span>
</span><span id="line-1969"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683160930"><span class="annot"><a href="#local-6989586621683160930"><span class="hs-identifier hs-var">mb_nm</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RdrName -&gt; RnM (Maybe GlobalRdrElt)
</span><a href="GHC.Rename.Env.html#lookupOccRn_maybe"><span class="hs-identifier hs-var">lookupOccRn_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">RdrName
</span><a href="#local-6989586621683160932"><span class="hs-identifier hs-var">rdr_name</span></a></span><span>
</span><span id="line-1970"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyName"><span class="hs-identifier hs-type">reifyName</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><a href="GHC.Types.Name.Reader.html#greName"><span class="hs-identifier hs-type">greName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683160930"><span class="hs-identifier hs-type">mb_nm</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1971"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1972"></span><span>    </span><span id="local-6989586621683160935"><span class="annot"><span class="annottext">th_name :: Name
</span><a href="#local-6989586621683160935"><span class="hs-identifier hs-var hs-var">th_name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Name
</span><span class="hs-identifier hs-var">TH.mkName</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160929"><span class="hs-identifier hs-var">s</span></a></span><span>       </span><span class="hs-comment">-- Parses M.x into a base of 'x' and a module of 'M'</span><span>
</span><span id="line-1973"></span><span>
</span><span id="line-1974"></span><span>    </span><span class="annot"><a href="#local-6989586621683160936"><span class="hs-identifier hs-type">occ_fs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a></span><span>
</span><span id="line-1975"></span><span>    </span><span id="local-6989586621683160936"><span class="annot"><span class="annottext">occ_fs :: FastString
</span><a href="#local-6989586621683160936"><span class="hs-identifier hs-var hs-var">occ_fs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; FastString
</span><a href="GHC.Data.FastString.html#mkFastString"><span class="hs-identifier hs-var">mkFastString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; String
</span><span class="hs-identifier hs-var">TH.nameBase</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160935"><span class="hs-identifier hs-var">th_name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1976"></span><span>
</span><span id="line-1977"></span><span>    </span><span class="annot"><a href="#local-6989586621683160939"><span class="hs-identifier hs-type">occ</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Name.Occurrence.html#OccName"><span class="hs-identifier hs-type">OccName</span></a></span><span>
</span><span id="line-1978"></span><span>    </span><span id="local-6989586621683160939"><span class="annot"><span class="annottext">occ :: OccName
</span><a href="#local-6989586621683160939"><span class="hs-identifier hs-var hs-var">occ</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683160928"><span class="hs-identifier hs-var">is_type_name</span></a></span><span>
</span><span id="line-1979"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">FastString -&gt; Bool
</span><a href="GHC.Utils.Lexeme.html#isLexVarSym"><span class="hs-identifier hs-var">isLexVarSym</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683160936"><span class="hs-identifier hs-var">occ_fs</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">FastString -&gt; Bool
</span><a href="GHC.Utils.Lexeme.html#isLexCon"><span class="hs-identifier hs-var">isLexCon</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683160936"><span class="hs-identifier hs-var">occ_fs</span></a></span><span>
</span><span id="line-1980"></span><span>                             </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">FastString -&gt; OccName
</span><a href="GHC.Types.Name.Occurrence.html#mkTcOccFS"><span class="hs-identifier hs-var">mkTcOccFS</span></a></span><span>    </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683160936"><span class="hs-identifier hs-var">occ_fs</span></a></span><span>
</span><span id="line-1981"></span><span>                             </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">FastString -&gt; OccName
</span><a href="GHC.Types.Name.Occurrence.html#mkTyVarOccFS"><span class="hs-identifier hs-var">mkTyVarOccFS</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683160936"><span class="hs-identifier hs-var">occ_fs</span></a></span><span>
</span><span id="line-1982"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1983"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">FastString -&gt; Bool
</span><a href="GHC.Utils.Lexeme.html#isLexCon"><span class="hs-identifier hs-var">isLexCon</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683160936"><span class="hs-identifier hs-var">occ_fs</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">FastString -&gt; OccName
</span><a href="GHC.Types.Name.Occurrence.html#mkDataOccFS"><span class="hs-identifier hs-var">mkDataOccFS</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683160936"><span class="hs-identifier hs-var">occ_fs</span></a></span><span>
</span><span id="line-1984"></span><span>                             </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">FastString -&gt; OccName
</span><a href="GHC.Types.Name.Occurrence.html#mkVarOccFS"><span class="hs-identifier hs-var">mkVarOccFS</span></a></span><span>  </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683160936"><span class="hs-identifier hs-var">occ_fs</span></a></span><span>
</span><span id="line-1985"></span><span>                               </span><span class="hs-comment">-- NB: when we pick the variable namespace, we</span><span>
</span><span id="line-1986"></span><span>                               </span><span class="hs-comment">-- might well obtain an identifier in a record</span><span>
</span><span id="line-1987"></span><span>                               </span><span class="hs-comment">-- field namespace, as lookupOccRn_maybe looks in</span><span>
</span><span id="line-1988"></span><span>                               </span><span class="hs-comment">-- record field namespaces when looking up variables.</span><span>
</span><span id="line-1989"></span><span>                               </span><span class="hs-comment">-- This ensures we can look up record fields using</span><span>
</span><span id="line-1990"></span><span>                               </span><span class="hs-comment">-- this function (#24293).</span><span>
</span><span id="line-1991"></span><span>
</span><span id="line-1992"></span><span>    </span><span id="local-6989586621683160932"><span class="annot"><span class="annottext">rdr_name :: RdrName
</span><a href="#local-6989586621683160932"><span class="hs-identifier hs-var hs-var">rdr_name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Maybe String
</span><span class="hs-identifier hs-var">TH.nameModule</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160935"><span class="hs-identifier hs-var">th_name</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1993"></span><span>                 </span><span class="annot"><span class="annottext">Maybe String
</span><span class="hs-identifier hs-var">Nothing</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">OccName -&gt; RdrName
</span><a href="GHC.Types.Name.Reader.html#mkRdrUnqual"><span class="hs-identifier hs-var">mkRdrUnqual</span></a></span><span> </span><span class="annot"><span class="annottext">OccName
</span><a href="#local-6989586621683160939"><span class="hs-identifier hs-var">occ</span></a></span><span>
</span><span id="line-1994"></span><span>                 </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683160949"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160949"><span class="hs-identifier hs-var">mod</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ModuleName -&gt; OccName -&gt; RdrName
</span><a href="GHC.Types.Name.Reader.html#mkRdrQual"><span class="hs-identifier hs-var">mkRdrQual</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; ModuleName
</span><a href="Language.Haskell.Syntax.Module.Name.html#mkModuleName"><span class="hs-identifier hs-var">mkModuleName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683160949"><span class="hs-identifier hs-var">mod</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OccName
</span><a href="#local-6989586621683160939"><span class="hs-identifier hs-var">occ</span></a></span><span>
</span><span id="line-1995"></span><span>
</span><span id="line-1996"></span><span class="hs-comment">-- | We only want to produce warnings for TH-splices if the user requests so.</span><span>
</span><span id="line-1997"></span><span class="hs-comment">-- See Note [Warnings for TH splices].</span><span>
</span><span id="line-1998"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#getThSpliceOrigin"><span class="hs-identifier hs-type">getThSpliceOrigin</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Origin"><span class="hs-identifier hs-type">Origin</span></a></span><span>
</span><span id="line-1999"></span><span id="getThSpliceOrigin"><span class="annot"><span class="annottext">getThSpliceOrigin :: TcM Origin
</span><a href="GHC.Tc.Gen.Splice.html#getThSpliceOrigin"><span class="hs-identifier hs-var hs-var">getThSpliceOrigin</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2000"></span><span>  </span><span id="local-6989586621683160951"><span class="annot"><a href="#local-6989586621683160951"><span class="hs-identifier hs-var">warn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">GeneralFlag -&gt; TcM Bool
forall gbl lcl. GeneralFlag -&gt; TcRnIf gbl lcl Bool
</span><a href="GHC.Tc.Utils.Monad.html#goptM"><span class="hs-identifier hs-var">goptM</span></a></span><span> </span><span class="annot"><span class="annottext">GeneralFlag
</span><a href="GHC.Driver.Flags.html#Opt_EnableThSpliceWarnings"><span class="hs-identifier hs-var">Opt_EnableThSpliceWarnings</span></a></span><span>
</span><span id="line-2001"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621683160951"><span class="hs-identifier hs-type">warn</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#FromSource"><span class="hs-identifier hs-type">FromSource</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Basic.html#Generated"><span class="hs-identifier hs-type">Generated</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#OtherExpansion"><span class="hs-identifier hs-type">OtherExpansion</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SkipPmc"><span class="hs-identifier hs-type">SkipPmc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2002"></span><span>
</span><span id="line-2003"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#getThing"><span class="hs-identifier hs-type">getThing</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.BasicTypes.html#TcTyThing"><span class="hs-identifier hs-type">TcTyThing</span></a></span><span>
</span><span id="line-2004"></span><span id="getThing"><span class="annot"><span class="annottext">getThing :: Name -&gt; TcM TcTyThing
</span><a href="GHC.Tc.Gen.Splice.html#getThing"><span class="hs-identifier hs-var hs-var">getThing</span></a></span></span><span> </span><span id="local-6989586621683160959"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160959"><span class="hs-identifier hs-var">th_name</span></a></span></span><span>
</span><span id="line-2005"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683160960"><span class="annot"><a href="#local-6989586621683160960"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM Name
</span><a href="GHC.Tc.Gen.Splice.html#lookupThName"><span class="hs-identifier hs-var">lookupThName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160959"><span class="hs-identifier hs-var">th_name</span></a></span><span>
</span><span id="line-2006"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceIf"><span class="hs-identifier hs-type">traceIf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;reify&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">show</span></span><span> </span><span class="annot"><a href="#local-6989586621683160959"><span class="hs-identifier hs-type">th_name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#brackets"><span class="hs-identifier hs-type">brackets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683160963"><span class="hs-identifier hs-type">ppr_ns</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160959"><span class="hs-identifier hs-type">th_name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160960"><span class="hs-identifier hs-type">name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2007"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#tcLookupTh"><span class="hs-identifier hs-type">tcLookupTh</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160960"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2008"></span><span>        </span><span class="hs-comment">-- ToDo: this tcLookup could fail, which would give a</span><span>
</span><span id="line-2009"></span><span>        </span><span class="hs-comment">--       rather unhelpful error message</span><span>
</span><span id="line-2010"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2011"></span><span>    </span><span id="local-6989586621683160963"><span class="annot"><span class="annottext">ppr_ns :: Name -&gt; doc
</span><a href="#local-6989586621683160963"><span class="hs-identifier hs-var hs-var">ppr_ns</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.Name</span></span><span> </span><span class="annot"><span class="annottext">OccName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.NameG</span></span><span> </span><span class="annot"><span class="annottext">NameSpace
</span><span class="hs-identifier hs-var">TH.DataName</span></span><span>     </span><span id="local-6989586621683160978"><span class="annot"><span class="annottext">PkgName
</span><a href="#local-6989586621683160978"><span class="hs-identifier hs-var">_pkg</span></a></span></span><span> </span><span id="local-6989586621683160979"><span class="annot"><span class="annottext">ModName
</span><a href="#local-6989586621683160979"><span class="hs-identifier hs-var">_mod</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; doc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;data&quot;</span></span><span>
</span><span id="line-2012"></span><span>    </span><span class="annot"><a href="#local-6989586621683160963"><span class="hs-identifier hs-var">ppr_ns</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.Name</span></span><span> </span><span class="annot"><span class="annottext">OccName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.NameG</span></span><span> </span><span class="annot"><span class="annottext">NameSpace
</span><span class="hs-identifier hs-var">TH.TcClsName</span></span><span>    </span><span id="local-6989586621683160981"><span class="annot"><span class="annottext">PkgName
</span><a href="#local-6989586621683160981"><span class="hs-identifier hs-var">_pkg</span></a></span></span><span> </span><span id="local-6989586621683160982"><span class="annot"><span class="annottext">ModName
</span><a href="#local-6989586621683160982"><span class="hs-identifier hs-var">_mod</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; doc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tc&quot;</span></span><span>
</span><span id="line-2013"></span><span>    </span><span class="annot"><a href="#local-6989586621683160963"><span class="hs-identifier hs-var">ppr_ns</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.Name</span></span><span> </span><span class="annot"><span class="annottext">OccName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.NameG</span></span><span> </span><span class="annot"><span class="annottext">NameSpace
</span><span class="hs-identifier hs-var">TH.VarName</span></span><span>      </span><span id="local-6989586621683160984"><span class="annot"><span class="annottext">PkgName
</span><a href="#local-6989586621683160984"><span class="hs-identifier hs-var">_pkg</span></a></span></span><span> </span><span id="local-6989586621683160985"><span class="annot"><span class="annottext">ModName
</span><a href="#local-6989586621683160985"><span class="hs-identifier hs-var">_mod</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; doc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;var&quot;</span></span><span>
</span><span id="line-2014"></span><span>    </span><span class="annot"><a href="#local-6989586621683160963"><span class="hs-identifier hs-var">ppr_ns</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.Name</span></span><span> </span><span class="annot"><span class="annottext">OccName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.NameG</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.FldName</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621683160987"><span class="annot"><span class="annottext">PkgName
</span><a href="#local-6989586621683160987"><span class="hs-identifier hs-var">_pkg</span></a></span></span><span> </span><span id="local-6989586621683160988"><span class="annot"><span class="annottext">ModName
</span><a href="#local-6989586621683160988"><span class="hs-identifier hs-var">_mod</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; doc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;fld&quot;</span></span><span>
</span><span id="line-2015"></span><span>    </span><span class="annot"><a href="#local-6989586621683160963"><span class="hs-identifier hs-var">ppr_ns</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; doc
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;reify/ppr_ns&quot;</span></span><span>
</span><span id="line-2016"></span><span>
</span><span id="line-2017"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reify"><span class="hs-identifier hs-type">reify</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Info</span></span><span>
</span><span id="line-2018"></span><span id="reify"><span class="annot"><span class="annottext">reify :: Name -&gt; TcM Info
</span><a href="GHC.Tc.Gen.Splice.html#reify"><span class="hs-identifier hs-var hs-var">reify</span></a></span></span><span> </span><span id="local-6989586621683160989"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160989"><span class="hs-identifier hs-var">th_name</span></a></span></span><span>
</span><span id="line-2019"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcRn ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;reify 1&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; String
</span><span class="hs-identifier hs-var">TH.showName</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160989"><span class="hs-identifier hs-var">th_name</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2020"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683160991"><span class="annot"><a href="#local-6989586621683160991"><span class="hs-identifier hs-var">thing</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM TcTyThing
</span><a href="GHC.Tc.Gen.Splice.html#getThing"><span class="hs-identifier hs-var">getThing</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160989"><span class="hs-identifier hs-var">th_name</span></a></span><span>
</span><span id="line-2021"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;reify 2&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160991"><span class="hs-identifier hs-type">thing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2022"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyThing"><span class="hs-identifier hs-type">reifyThing</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683160991"><span class="hs-identifier hs-type">thing</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2023"></span><span>
</span><span id="line-2024"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#lookupThName"><span class="hs-identifier hs-type">lookupThName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span>
</span><span id="line-2025"></span><span id="lookupThName"><span class="annot"><span class="annottext">lookupThName :: Name -&gt; TcM Name
</span><a href="GHC.Tc.Gen.Splice.html#lookupThName"><span class="hs-identifier hs-var hs-var">lookupThName</span></a></span></span><span> </span><span id="local-6989586621683160993"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160993"><span class="hs-identifier hs-var">th_name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2026"></span><span>    </span><span id="local-6989586621683160994"><span class="annot"><a href="#local-6989586621683160994"><span class="hs-identifier hs-var">mb_name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM (Maybe Name)
</span><a href="GHC.Tc.Gen.Splice.html#lookupThName_maybe"><span class="hs-identifier hs-var">lookupThName_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160993"><span class="hs-identifier hs-var">th_name</span></a></span><span>
</span><span id="line-2027"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683160994"><span class="hs-identifier hs-type">mb_name</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2028"></span><span>        </span><span class="annot"><span class="annottext">Maybe Name
</span><span class="hs-identifier hs-var">Nothing</span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; TcM Name
forall a. TcRnMessage -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; TcRnMessage
</span><a href="GHC.Tc.Gen.Splice.html#notInScope"><span class="hs-identifier hs-var">notInScope</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160993"><span class="hs-identifier hs-var">th_name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2029"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683160996"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160996"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM Name
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160996"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-2030"></span><span>
</span><span id="line-2031"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#lookupThName_maybe"><span class="hs-identifier hs-type">lookupThName_maybe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2032"></span><span id="lookupThName_maybe"><span class="annot"><span class="annottext">lookupThName_maybe :: Name -&gt; TcM (Maybe Name)
</span><a href="GHC.Tc.Gen.Splice.html#lookupThName_maybe"><span class="hs-identifier hs-var hs-var">lookupThName_maybe</span></a></span></span><span> </span><span id="local-6989586621683160997"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160997"><span class="hs-identifier hs-var">th_name</span></a></span></span><span>
</span><span id="line-2033"></span><span>  </span><span class="hs-glyph">=</span><span>  </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683160998"><span class="annot"><span class="annottext">guesses :: [RdrName]
</span><a href="#local-6989586621683160998"><span class="hs-identifier hs-var hs-var">guesses</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; [RdrName]
</span><a href="GHC.ThToHs.html#thRdrNameGuesses"><span class="hs-identifier hs-var">thRdrNameGuesses</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683160997"><span class="hs-identifier hs-var">th_name</span></a></span><span>
</span><span id="line-2034"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[RdrName]
</span><a href="#local-6989586621683160998"><span class="hs-identifier hs-var">guesses</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2035"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="hs-special">[</span><span id="local-6989586621683161000"><span class="annot"><span class="annottext">RdrName
</span><a href="#local-6989586621683161000"><span class="hs-identifier hs-var">for_sure</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RdrName -&gt; TcM (Maybe Name)
</span><a href="GHC.Rename.Env.html#lookupSameOccRn_maybe"><span class="hs-identifier hs-var">lookupSameOccRn_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">RdrName
</span><a href="#local-6989586621683161000"><span class="hs-identifier hs-var">for_sure</span></a></span><span>
</span><span id="line-2036"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">[RdrName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2037"></span><span>     </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683161002"><span class="annot"><a href="#local-6989586621683161002"><span class="hs-identifier hs-var">gres</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(RdrName -&gt; RnM (Maybe GlobalRdrElt))
-&gt; [RdrName] -&gt; IOEnv (Env TcGblEnv TcLclEnv) [GlobalRdrElt]
forall (m :: * -&gt; *) a b.
Applicative m =&gt;
(a -&gt; m (Maybe b)) -&gt; [a] -&gt; m [b]
</span><a href="GHC.Utils.Monad.html#mapMaybeM"><span class="hs-identifier hs-var">mapMaybeM</span></a></span><span> </span><span class="annot"><span class="annottext">RdrName -&gt; RnM (Maybe GlobalRdrElt)
</span><a href="GHC.Rename.Env.html#lookupOccRn_maybe"><span class="hs-identifier hs-var">lookupOccRn_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">[RdrName]
</span><a href="#local-6989586621683160998"><span class="hs-identifier hs-var">guesses</span></a></span><span>
</span><span id="line-2038"></span><span>          </span><span class="hs-comment">-- Pick the first that works</span><span>
</span><span id="line-2039"></span><span>          </span><span class="hs-comment">-- E.g. reify (mkName &quot;A&quot;) will pick the class A in preference to the data constructor A</span><span>
</span><span id="line-2040"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">fmap</span></span><span> </span><span class="annot"><a href="GHC.Types.Name.Reader.html#greName"><span class="hs-identifier hs-type">greName</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">listToMaybe</span></span><span> </span><span class="annot"><a href="#local-6989586621683161002"><span class="hs-identifier hs-type">gres</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2041"></span><span>
</span><span id="line-2042"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#tcLookupTh"><span class="hs-identifier hs-type">tcLookupTh</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.BasicTypes.html#TcTyThing"><span class="hs-identifier hs-type">TcTyThing</span></a></span><span>
</span><span id="line-2043"></span><span class="hs-comment">-- This is a specialised version of GHC.Tc.Utils.Env.tcLookup; specialised mainly in that</span><span>
</span><span id="line-2044"></span><span class="hs-comment">-- it gives a reify-related error message on failure, whereas in the normal</span><span>
</span><span id="line-2045"></span><span class="hs-comment">-- tcLookup, failure is a bug.</span><span>
</span><span id="line-2046"></span><span id="tcLookupTh"><span class="annot"><span class="annottext">tcLookupTh :: Name -&gt; TcM TcTyThing
</span><a href="GHC.Tc.Gen.Splice.html#tcLookupTh"><span class="hs-identifier hs-var hs-var">tcLookupTh</span></a></span></span><span> </span><span id="local-6989586621683161005"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161005"><span class="hs-identifier hs-var">name</span></a></span></span><span>
</span><span id="line-2047"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683161006"><span class="annot"><a href="#local-6989586621683161006"><span class="hs-identifier hs-var">gbl_env</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161007"><span class="annot"><a href="#local-6989586621683161007"><span class="hs-identifier hs-var">lcl_env</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcRnIf TcGblEnv TcLclEnv (TcGblEnv, TcLclEnv)
forall gbl lcl. TcRnIf gbl lcl (gbl, lcl)
</span><a href="GHC.Tc.Utils.Monad.html#getEnvs"><span class="hs-identifier hs-var">getEnvs</span></a></span><span>
</span><span id="line-2048"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="GHC.Types.Name.Env.html#lookupNameEnv"><span class="hs-identifier hs-type">lookupNameEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.LclEnv.html#getLclEnvTypeEnv"><span class="hs-identifier hs-type">getLclEnvTypeEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161007"><span class="hs-identifier hs-type">lcl_env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683161005"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-2049"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683161011"><span class="annot"><span class="annottext">TcTyThing
</span><a href="#local-6989586621683161011"><span class="hs-identifier hs-var">thing</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcTyThing -&gt; TcM TcTyThing
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">TcTyThing
</span><a href="#local-6989586621683161011"><span class="hs-identifier hs-var">thing</span></a></span><span class="hs-special">;</span><span>
</span><span id="line-2050"></span><span>                </span><span class="annot"><span class="annottext">Maybe TcTyThing
</span><span class="hs-identifier hs-var">Nothing</span></span><span>    </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2051"></span><span>
</span><span id="line-2052"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">NameEnv TyThing -&gt; Name -&gt; Maybe TyThing
forall a. NameEnv a -&gt; Name -&gt; Maybe a
</span><a href="GHC.Types.Name.Env.html#lookupNameEnv"><span class="hs-identifier hs-var">lookupNameEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcGblEnv -&gt; NameEnv TyThing
</span><a href="GHC.Tc.Types.html#tcg_type_env"><span class="hs-identifier hs-var">tcg_type_env</span></a></span><span> </span><span class="annot"><span class="annottext">TcGblEnv
</span><a href="#local-6989586621683161006"><span class="hs-identifier hs-var">gbl_env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161005"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-2053"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683161013"><span class="annot"><span class="annottext">TyThing
</span><a href="#local-6989586621683161013"><span class="hs-identifier hs-var">thing</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcTyThing -&gt; TcM TcTyThing
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyThing -&gt; TcTyThing
</span><a href="GHC.Tc.Types.BasicTypes.html#AGlobal"><span class="hs-identifier hs-var">AGlobal</span></a></span><span> </span><span class="annot"><span class="annottext">TyThing
</span><a href="#local-6989586621683161013"><span class="hs-identifier hs-var">thing</span></a></span><span class="hs-special">)</span><span class="hs-special">;</span><span>
</span><span id="line-2054"></span><span>                </span><span class="annot"><span class="annottext">Maybe TyThing
</span><span class="hs-identifier hs-var">Nothing</span></span><span>    </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2055"></span><span>
</span><span id="line-2056"></span><span>          </span><span class="hs-comment">-- EZY: I don't think this choice matters, no TH in signatures!</span><span>
</span><span id="line-2057"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">GenModule Unit -&gt; Name -&gt; Bool
</span><a href="GHC.Types.Name.html#nameIsLocalOrFrom"><span class="hs-identifier hs-var">nameIsLocalOrFrom</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcGblEnv -&gt; GenModule Unit
</span><a href="GHC.Tc.Types.html#tcg_semantic_mod"><span class="hs-identifier hs-var">tcg_semantic_mod</span></a></span><span> </span><span class="annot"><span class="annottext">TcGblEnv
</span><a href="#local-6989586621683161006"><span class="hs-identifier hs-var">gbl_env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161005"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-2058"></span><span>          </span><span class="hs-keyword">then</span><span>  </span><span class="hs-comment">-- It's defined in this module</span><span>
</span><span id="line-2059"></span><span>                </span><span class="annot"><span class="annottext">TcRnMessage -&gt; TcM TcTyThing
forall a. TcRnMessage -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; TcRnMessage
</span><a href="GHC.Tc.Gen.Splice.html#notInEnv"><span class="hs-identifier hs-var">notInEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161005"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2060"></span><span>
</span><span id="line-2061"></span><span>          </span><span class="hs-keyword">else</span><span>
</span><span id="line-2062"></span><span>     </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683161017"><span class="annot"><a href="#local-6989586621683161017"><span class="hs-identifier hs-var">mb_thing</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM (MaybeErr IfaceMessage TyThing)
</span><a href="GHC.Iface.Load.html#tcLookupImported_maybe"><span class="hs-identifier hs-var">tcLookupImported_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161005"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-2063"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683161017"><span class="hs-identifier hs-type">mb_thing</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2064"></span><span>            </span><span class="annot"><a href="GHC.Data.Maybe.html#Succeeded"><span class="hs-identifier hs-type">Succeeded</span></a></span><span> </span><span id="local-6989586621683161020"><span class="annot"><span class="annottext">TyThing
</span><a href="#local-6989586621683161020"><span class="hs-identifier hs-var">thing</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcTyThing -&gt; TcM TcTyThing
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyThing -&gt; TcTyThing
</span><a href="GHC.Tc.Types.BasicTypes.html#AGlobal"><span class="hs-identifier hs-var">AGlobal</span></a></span><span> </span><span class="annot"><span class="annottext">TyThing
</span><a href="#local-6989586621683161020"><span class="hs-identifier hs-var">thing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2065"></span><span>            </span><span class="annot"><a href="GHC.Data.Maybe.html#Failed"><span class="hs-identifier hs-type">Failed</span></a></span><span> </span><span id="local-6989586621683161022"><span class="annot"><span class="annottext">IfaceMessage
</span><a href="#local-6989586621683161022"><span class="hs-identifier hs-var">msg</span></a></span></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; TcM TcTyThing
forall a. TcRnMessage -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IfaceMessage -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnInterfaceError"><span class="hs-identifier hs-var">TcRnInterfaceError</span></a></span><span> </span><span class="annot"><span class="annottext">IfaceMessage
</span><a href="#local-6989586621683161022"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2066"></span><span>    </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><span id="line-2067"></span><span>
</span><span id="line-2068"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#notInScope"><span class="hs-identifier hs-type">notInScope</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Errors.Types.html#TcRnMessage"><span class="hs-identifier hs-type">TcRnMessage</span></a></span><span>
</span><span id="line-2069"></span><span id="notInScope"><span class="annot"><span class="annottext">notInScope :: Name -&gt; TcRnMessage
</span><a href="GHC.Tc.Gen.Splice.html#notInScope"><span class="hs-identifier hs-var hs-var">notInScope</span></a></span></span><span> </span><span id="local-6989586621683161024"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161024"><span class="hs-identifier hs-var">th_name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2070"></span><span>  </span><span class="annot"><span class="annottext">THError -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnTHError"><span class="hs-identifier hs-var">TcRnTHError</span></a></span><span> </span><span class="annot"><span class="annottext">(THError -&gt; TcRnMessage) -&gt; THError -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">THReifyError -&gt; THError
</span><a href="GHC.Tc.Errors.Types.html#THReifyError"><span class="hs-identifier hs-var">THReifyError</span></a></span><span> </span><span class="annot"><span class="annottext">(THReifyError -&gt; THError) -&gt; THReifyError -&gt; THError
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; THReifyError
</span><a href="GHC.Tc.Errors.Types.html#CannotReifyOutOfScopeThing"><span class="hs-identifier hs-var">CannotReifyOutOfScopeThing</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161024"><span class="hs-identifier hs-var">th_name</span></a></span><span>
</span><span id="line-2071"></span><span>
</span><span id="line-2072"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#notInEnv"><span class="hs-identifier hs-type">notInEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Errors.Types.html#TcRnMessage"><span class="hs-identifier hs-type">TcRnMessage</span></a></span><span>
</span><span id="line-2073"></span><span id="notInEnv"><span class="annot"><span class="annottext">notInEnv :: Name -&gt; TcRnMessage
</span><a href="GHC.Tc.Gen.Splice.html#notInEnv"><span class="hs-identifier hs-var hs-var">notInEnv</span></a></span></span><span> </span><span id="local-6989586621683161026"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161026"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">THError -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnTHError"><span class="hs-identifier hs-var">TcRnTHError</span></a></span><span> </span><span class="annot"><span class="annottext">(THError -&gt; TcRnMessage) -&gt; THError -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">THReifyError -&gt; THError
</span><a href="GHC.Tc.Errors.Types.html#THReifyError"><span class="hs-identifier hs-var">THReifyError</span></a></span><span> </span><span class="annot"><span class="annottext">(THReifyError -&gt; THError) -&gt; THReifyError -&gt; THError
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; THReifyError
</span><a href="GHC.Tc.Errors.Types.html#CannotReifyThingNotInTypeEnv"><span class="hs-identifier hs-var">CannotReifyThingNotInTypeEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161026"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-2074"></span><span>
</span><span id="line-2075"></span><span class="hs-comment">------------------------------</span><span>
</span><span id="line-2076"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyRoles"><span class="hs-identifier hs-type">reifyRoles</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">TH.Role</span></span><span class="hs-special">]</span><span>
</span><span id="line-2077"></span><span id="reifyRoles"><span class="annot"><span class="annottext">reifyRoles :: Name -&gt; TcM [Role]
</span><a href="GHC.Tc.Gen.Splice.html#reifyRoles"><span class="hs-identifier hs-var hs-var">reifyRoles</span></a></span></span><span> </span><span id="local-6989586621683161028"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161028"><span class="hs-identifier hs-var">th_name</span></a></span></span><span>
</span><span id="line-2078"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683161029"><span class="annot"><a href="#local-6989586621683161029"><span class="hs-identifier hs-var">thing</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM TcTyThing
</span><a href="GHC.Tc.Gen.Splice.html#getThing"><span class="hs-identifier hs-var">getThing</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161028"><span class="hs-identifier hs-var">th_name</span></a></span><span>
</span><span id="line-2079"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683161029"><span class="hs-identifier hs-type">thing</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2080"></span><span>           </span><span class="annot"><a href="GHC.Tc.Types.BasicTypes.html#AGlobal"><span class="hs-identifier hs-type">AGlobal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.TyThing.html#ATyCon"><span class="hs-identifier hs-type">ATyCon</span></a></span><span> </span><span id="local-6989586621683161031"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161031"><span class="hs-identifier hs-var">tc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Role] -&gt; TcM [Role]
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Role -&gt; Role) -&gt; [Role] -&gt; [Role]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Role
</span><a href="#local-6989586621683161032"><span class="hs-identifier hs-var">reify_role</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [Role]
</span><a href="GHC.Core.TyCon.html#tyConRoles"><span class="hs-identifier hs-var">tyConRoles</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161031"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2081"></span><span>           </span><span class="annot"><span class="annottext">TcTyThing
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; TcM [Role]
forall a. TcRnMessage -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; TcM [Role]) -&gt; TcRnMessage -&gt; TcM [Role]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">THError -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnTHError"><span class="hs-identifier hs-var">TcRnTHError</span></a></span><span> </span><span class="annot"><span class="annottext">(THError -&gt; TcRnMessage) -&gt; THError -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">THReifyError -&gt; THError
</span><a href="GHC.Tc.Errors.Types.html#THReifyError"><span class="hs-identifier hs-var">THReifyError</span></a></span><span> </span><span class="annot"><span class="annottext">(THReifyError -&gt; THError) -&gt; THReifyError -&gt; THError
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2082"></span><span>                  </span><span class="annot"><span class="annottext">TcTyThing -&gt; THReifyError
</span><a href="GHC.Tc.Errors.Types.html#NoRolesAssociatedWithThing"><span class="hs-identifier hs-var">NoRolesAssociatedWithThing</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyThing
</span><a href="#local-6989586621683161029"><span class="hs-identifier hs-var">thing</span></a></span><span>
</span><span id="line-2083"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-2084"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2085"></span><span>    </span><span id="local-6989586621683161032"><span class="annot"><span class="annottext">reify_role :: Role -&gt; Role
</span><a href="#local-6989586621683161032"><span class="hs-identifier hs-var hs-var">reify_role</span></a></span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role
</span><span class="hs-identifier hs-var">TH.NominalR</span></span><span>
</span><span id="line-2086"></span><span>    </span><span class="annot"><a href="#local-6989586621683161032"><span class="hs-identifier hs-var">reify_role</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Representational"><span class="hs-identifier hs-var">Representational</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role
</span><span class="hs-identifier hs-var">TH.RepresentationalR</span></span><span>
</span><span id="line-2087"></span><span>    </span><span class="annot"><a href="#local-6989586621683161032"><span class="hs-identifier hs-var">reify_role</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Phantom"><span class="hs-identifier hs-var">Phantom</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role
</span><span class="hs-identifier hs-var">TH.PhantomR</span></span><span>
</span><span id="line-2088"></span><span>
</span><span id="line-2089"></span><span class="hs-comment">------------------------------</span><span>
</span><span id="line-2090"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyThing"><span class="hs-identifier hs-type">reifyThing</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.BasicTypes.html#TcTyThing"><span class="hs-identifier hs-type">TcTyThing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Info</span></span><span>
</span><span id="line-2091"></span><span class="hs-comment">-- The only reason this is monadic is for error reporting,</span><span>
</span><span id="line-2092"></span><span class="hs-comment">-- which in turn is mainly for the case when TH can't express</span><span>
</span><span id="line-2093"></span><span class="hs-comment">-- some random GHC extension</span><span>
</span><span id="line-2094"></span><span>
</span><span id="line-2095"></span><span id="reifyThing"><span class="annot"><span class="annottext">reifyThing :: TcTyThing -&gt; TcM Info
</span><a href="GHC.Tc.Gen.Splice.html#reifyThing"><span class="hs-identifier hs-var hs-var">reifyThing</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.BasicTypes.html#AGlobal"><span class="hs-identifier hs-type">AGlobal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.TyThing.html#AnId"><span class="hs-identifier hs-type">AnId</span></a></span><span> </span><span id="local-6989586621683161042"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621683161042"><span class="hs-identifier hs-var">id</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2096"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683161043"><span class="annot"><a href="#local-6989586621683161043"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621683161042"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2097"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683161046"><span class="annot"><a href="#local-6989586621683161046"><span class="hs-identifier hs-var hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Name
forall n. NamedThing n =&gt; n -&gt; Name
</span><a href="GHC.Tc.Gen.Splice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621683161042"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-2098"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#idDetails"><span class="hs-identifier hs-type">idDetails</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161042"><span class="hs-identifier hs-type">id</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2099"></span><span>            </span><span class="annot"><a href="GHC.Types.Id.Info.html#ClassOpId"><span class="hs-identifier hs-type">ClassOpId</span></a></span><span> </span><span id="local-6989586621683161049"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683161049"><span class="hs-identifier hs-var">cls</span></a></span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Info -&gt; TcM Info
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Type -&gt; Name -&gt; Info
</span><span class="hs-identifier hs-var">TH.ClassOpI</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161046"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161043"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Class -&gt; Name
forall n. NamedThing n =&gt; n -&gt; Name
</span><a href="GHC.Tc.Gen.Splice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683161049"><span class="hs-identifier hs-var">cls</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2100"></span><span>            </span><span class="annot"><span class="annottext">IdDetails
</span><span class="hs-identifier">_</span></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Info -&gt; TcM Info
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Type -&gt; Maybe Dec -&gt; Info
</span><span class="hs-identifier hs-var">TH.VarI</span></span><span>     </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161046"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161043"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Dec
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-2101"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-2102"></span><span>
</span><span id="line-2103"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyThing"><span class="hs-identifier hs-var">reifyThing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.BasicTypes.html#AGlobal"><span class="hs-identifier hs-type">AGlobal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.TyThing.html#ATyCon"><span class="hs-identifier hs-type">ATyCon</span></a></span><span> </span><span id="local-6989586621683161052"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161052"><span class="hs-identifier hs-var">tc</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; TcM Info
</span><a href="GHC.Tc.Gen.Splice.html#reifyTyCon"><span class="hs-identifier hs-var">reifyTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161052"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-2104"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyThing"><span class="hs-identifier hs-var">reifyThing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.BasicTypes.html#AGlobal"><span class="hs-identifier hs-type">AGlobal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.TyThing.html#AConLike"><span class="hs-identifier hs-type">AConLike</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.ConLike.html#RealDataCon"><span class="hs-identifier hs-type">RealDataCon</span></a></span><span> </span><span id="local-6989586621683161056"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621683161056"><span class="hs-identifier hs-var">dc</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2105"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; TcM Info
</span><a href="GHC.Tc.Gen.Splice.html#mkDataConI"><span class="hs-identifier hs-var">mkDataConI</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621683161056"><span class="hs-identifier hs-var">dc</span></a></span><span>
</span><span id="line-2106"></span><span>
</span><span id="line-2107"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyThing"><span class="hs-identifier hs-var">reifyThing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.BasicTypes.html#AGlobal"><span class="hs-identifier hs-type">AGlobal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.TyThing.html#AConLike"><span class="hs-identifier hs-type">AConLike</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.ConLike.html#PatSynCon"><span class="hs-identifier hs-type">PatSynCon</span></a></span><span> </span><span id="local-6989586621683161059"><span class="annot"><span class="annottext">PatSyn
</span><a href="#local-6989586621683161059"><span class="hs-identifier hs-var">ps</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2108"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683161060"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621683161060"><span class="hs-identifier hs-var hs-var hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatSyn -&gt; Name
forall n. NamedThing n =&gt; n -&gt; Name
</span><a href="GHC.Tc.Gen.Splice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a></span><span> </span><span class="annot"><span class="annottext">PatSyn
</span><a href="#local-6989586621683161059"><span class="hs-identifier hs-var">ps</span></a></span><span>
</span><span id="line-2109"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161061"><span class="annot"><a href="#local-6989586621683161061"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">([InvisTVBinder], [Type], [InvisTVBinder], [Type], [Scaled Type],
 Type)
-&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#reifyPatSynType"><span class="hs-identifier hs-var">reifyPatSynType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatSyn
-&gt; ([InvisTVBinder], [Type], [InvisTVBinder], [Type],
    [Scaled Type], Type)
</span><a href="GHC.Core.PatSyn.html#patSynSigBndr"><span class="hs-identifier hs-var">patSynSigBndr</span></a></span><span> </span><span class="annot"><span class="annottext">PatSyn
</span><a href="#local-6989586621683161059"><span class="hs-identifier hs-var">ps</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2110"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.PatSynI</span></span><span> </span><span class="annot"><a href="#local-6989586621683161060"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161061"><span class="hs-identifier hs-type">ty</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2111"></span><span>
</span><span id="line-2112"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyThing"><span class="hs-identifier hs-var">reifyThing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.BasicTypes.html#ATcId"><span class="hs-identifier hs-type">ATcId</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">tct_id :: TcTyThing -&gt; TyVar
</span><a href="GHC.Tc.Types.BasicTypes.html#tct_id"><span class="hs-identifier hs-var">tct_id</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683161067"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621683161067"><span class="hs-identifier hs-var">id</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2113"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683161068"><span class="annot"><a href="#local-6989586621683161068"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ZonkM Type -&gt; IOEnv (Env TcGblEnv TcLclEnv) Type
forall a. ZonkM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#liftZonkM"><span class="hs-identifier hs-var">liftZonkM</span></a></span><span> </span><span class="annot"><span class="annottext">(ZonkM Type -&gt; IOEnv (Env TcGblEnv TcLclEnv) Type)
-&gt; ZonkM Type -&gt; IOEnv (Env TcGblEnv TcLclEnv) Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; ZonkM Type
</span><a href="GHC.Tc.Zonk.TcType.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621683161067"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Make use of all the info we have, even</span><span>
</span><span id="line-2114"></span><span>                                        </span><span class="hs-comment">-- though it may be incomplete</span><span>
</span><span id="line-2115"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161069"><span class="annot"><a href="#local-6989586621683161069"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-type">reifyType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161068"><span class="hs-identifier hs-type">ty1</span></a></span><span>
</span><span id="line-2116"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.VarI</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyName"><span class="hs-identifier hs-type">reifyName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161067"><span class="hs-identifier hs-type">id</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683161069"><span class="hs-identifier hs-type">ty2</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2117"></span><span>
</span><span id="line-2118"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyThing"><span class="hs-identifier hs-var">reifyThing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.BasicTypes.html#ATyVar"><span class="hs-identifier hs-type">ATyVar</span></a></span><span> </span><span id="local-6989586621683161071"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161071"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span id="local-6989586621683161072"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621683161072"><span class="hs-identifier hs-var">tv1</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2119"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683161073"><span class="annot"><a href="#local-6989586621683161073"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ZonkM Type -&gt; IOEnv (Env TcGblEnv TcLclEnv) Type
forall a. ZonkM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#liftZonkM"><span class="hs-identifier hs-var">liftZonkM</span></a></span><span> </span><span class="annot"><span class="annottext">(ZonkM Type -&gt; IOEnv (Env TcGblEnv TcLclEnv) Type)
-&gt; ZonkM Type -&gt; IOEnv (Env TcGblEnv TcLclEnv) Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; ZonkM Type
</span><a href="GHC.Tc.Zonk.TcType.html#zonkTcTyVar"><span class="hs-identifier hs-var">zonkTcTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621683161072"><span class="hs-identifier hs-var">tv1</span></a></span><span>
</span><span id="line-2120"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161075"><span class="annot"><a href="#local-6989586621683161075"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-type">reifyType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161073"><span class="hs-identifier hs-type">ty1</span></a></span><span>
</span><span id="line-2121"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.TyVarI</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyName"><span class="hs-identifier hs-type">reifyName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161071"><span class="hs-identifier hs-type">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683161075"><span class="hs-identifier hs-type">ty2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2122"></span><span>
</span><span id="line-2123"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyThing"><span class="hs-identifier hs-var">reifyThing</span></a></span><span> </span><span id="local-6989586621683161077"><span class="annot"><span class="annottext">TcTyThing
</span><a href="#local-6989586621683161077"><span class="hs-identifier hs-var">thing</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM Info
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;reifyThing&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyThing -&gt; SDoc
</span><a href="GHC.Tc.Types.BasicTypes.html#pprTcTyThingCategory"><span class="hs-identifier hs-var">pprTcTyThingCategory</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyThing
</span><a href="#local-6989586621683161077"><span class="hs-identifier hs-var">thing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2124"></span><span>
</span><span id="line-2125"></span><span class="hs-comment">-------------------------------------------</span><span>
</span><span id="line-2126"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyAxBranch"><span class="hs-identifier hs-type">reifyAxBranch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.TySynEqn</span></span><span>
</span><span id="line-2127"></span><span id="reifyAxBranch"><span class="annot"><span class="annottext">reifyAxBranch :: TyCon -&gt; CoAxBranch -&gt; TcM TySynEqn
</span><a href="GHC.Tc.Gen.Splice.html#reifyAxBranch"><span class="hs-identifier hs-var hs-var">reifyAxBranch</span></a></span></span><span> </span><span id="local-6989586621683161080"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161080"><span class="hs-identifier hs-var">fam_tc</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cab_tvs :: CoAxBranch -&gt; [TyVar]
</span><a href="GHC.Core.Coercion.Axiom.html#cab_tvs"><span class="hs-identifier hs-var">cab_tvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683161083"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621683161083"><span class="hs-identifier hs-var">tvs</span></a></span></span><span>
</span><span id="line-2128"></span><span>                                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cab_lhs :: CoAxBranch -&gt; [Type]
</span><a href="GHC.Core.Coercion.Axiom.html#cab_lhs"><span class="hs-identifier hs-var">cab_lhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683161085"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161085"><span class="hs-identifier hs-var">lhs</span></a></span></span><span>
</span><span id="line-2129"></span><span>                                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cab_rhs :: CoAxBranch -&gt; Type
</span><a href="GHC.Core.Coercion.Axiom.html#cab_rhs"><span class="hs-identifier hs-var">cab_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683161087"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161087"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2130"></span><span>            </span><span class="hs-comment">-- remove kind patterns (#8884)</span><span>
</span><span id="line-2131"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683161088"><span class="annot"><a href="#local-6989586621683161088"><span class="hs-identifier hs-var">tvs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; TcM (Maybe [TyVarBndr ()])
</span><a href="GHC.Tc.Gen.Splice.html#reifyTyVarsToMaybe"><span class="hs-identifier hs-var">reifyTyVarsToMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621683161083"><span class="hs-identifier hs-var">tvs</span></a></span><span>
</span><span id="line-2132"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683161090"><span class="annot"><a href="#local-6989586621683161090"><span class="hs-identifier hs-var hs-var">lhs_types_only</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; [Type]
</span><a href="GHC.Core.Type.html#filterOutInvisibleTypes"><span class="hs-identifier hs-var">filterOutInvisibleTypes</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161080"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161085"><span class="hs-identifier hs-var">lhs</span></a></span><span>
</span><span id="line-2133"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161092"><span class="annot"><a href="#local-6989586621683161092"><span class="hs-identifier hs-var">lhs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyTypes"><span class="hs-identifier hs-type">reifyTypes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161090"><span class="hs-identifier hs-type">lhs_types_only</span></a></span><span>
</span><span id="line-2134"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161094"><span class="annot"><a href="#local-6989586621683161094"><span class="hs-identifier hs-var">annot_th_lhs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Utils.Monad.html#zipWith3M"><span class="hs-identifier hs-type">zipWith3M</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#annotThType"><span class="hs-identifier hs-type">annotThType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#tyConArgsPolyKinded"><span class="hs-identifier hs-type">tyConArgsPolyKinded</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161080"><span class="hs-identifier hs-type">fam_tc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2135"></span><span>                                   </span><span class="annot"><a href="#local-6989586621683161090"><span class="hs-identifier hs-type">lhs_types_only</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161092"><span class="hs-identifier hs-type">lhs'</span></a></span><span>
</span><span id="line-2136"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683161098"><span class="annot"><a href="#local-6989586621683161098"><span class="hs-identifier hs-var hs-var">lhs_type</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; [Type] -&gt; Type
</span><a href="GHC.Tc.Gen.Splice.html#mkThAppTs"><span class="hs-identifier hs-var">mkThAppTs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Type
</span><span class="hs-identifier hs-var">TH.ConT</span></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Type) -&gt; Name -&gt; Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Name
forall n. NamedThing n =&gt; n -&gt; Name
</span><a href="GHC.Tc.Gen.Splice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161080"><span class="hs-identifier hs-var">fam_tc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161094"><span class="hs-identifier hs-var">annot_th_lhs</span></a></span><span>
</span><span id="line-2137"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161099"><span class="annot"><a href="#local-6989586621683161099"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-type">reifyType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161087"><span class="hs-identifier hs-type">rhs</span></a></span><span>
</span><span id="line-2138"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.TySynEqn</span></span><span> </span><span class="annot"><a href="#local-6989586621683161088"><span class="hs-identifier hs-type">tvs'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161098"><span class="hs-identifier hs-type">lhs_type</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161099"><span class="hs-identifier hs-type">rhs'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2139"></span><span>
</span><span id="line-2140"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyTyCon"><span class="hs-identifier hs-type">reifyTyCon</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Info</span></span><span>
</span><span id="line-2141"></span><span id="reifyTyCon"><span class="annot"><span class="annottext">reifyTyCon :: TyCon -&gt; TcM Info
</span><a href="GHC.Tc.Gen.Splice.html#reifyTyCon"><span class="hs-identifier hs-var hs-var">reifyTyCon</span></a></span></span><span> </span><span id="local-6989586621683161101"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161101"><span class="hs-identifier hs-var">tc</span></a></span></span><span>
</span><span id="line-2142"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683161102"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683161102"><span class="hs-identifier hs-var">cls</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Maybe Class
</span><a href="GHC.Core.TyCon.html#tyConClass_maybe"><span class="hs-identifier hs-var">tyConClass_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161101"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-2143"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Class -&gt; TcM Info
</span><a href="GHC.Tc.Gen.Splice.html#reifyClass"><span class="hs-identifier hs-var">reifyClass</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683161102"><span class="hs-identifier hs-var">cls</span></a></span><span>
</span><span id="line-2144"></span><span>
</span><span id="line-2145"></span><span class="hs-comment">{-  Seems to be just a short cut for the next equation -- omit
  | tc `hasKey` fUNTyConKey -- I'm not quite sure what is happening here
  = return (TH.PrimTyConI (reifyName tc) 2 False)
-}</span><span>
</span><span id="line-2149"></span><span>
</span><span id="line-2150"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isPrimTyCon"><span class="hs-identifier hs-var">isPrimTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161101"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-2151"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Info -&gt; TcM Info
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; SumArity -&gt; Bool -&gt; Info
</span><span class="hs-identifier hs-var">TH.PrimTyConI</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Name
forall n. NamedThing n =&gt; n -&gt; Name
</span><a href="GHC.Tc.Gen.Splice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161101"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TyVar] -&gt; SumArity
forall a. [a] -&gt; SumArity
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; SumArity
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [TyVar]
</span><a href="GHC.Core.TyCon.html#tyConVisibleTyVars"><span class="hs-identifier hs-var">tyConVisibleTyVars</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161101"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2152"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isUnliftedTypeKind"><span class="hs-identifier hs-var">isUnliftedTypeKind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Type
</span><a href="GHC.Core.TyCon.html#tyConResKind"><span class="hs-identifier hs-var">tyConResKind</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161101"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2153"></span><span>
</span><span id="line-2154"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isTypeFamilyTyCon"><span class="hs-identifier hs-var">isTypeFamilyTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161101"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-2155"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683161111"><span class="annot"><span class="annottext">tvs :: [TyVar]
</span><a href="#local-6989586621683161111"><span class="hs-identifier hs-var hs-var hs-var">tvs</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [TyVar]
</span><a href="GHC.Core.TyCon.html#tyConTyVars"><span class="hs-identifier hs-var">tyConTyVars</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161101"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-2156"></span><span>             </span><span id="local-6989586621683161113"><span class="annot"><span class="annottext">res_kind :: Type
</span><a href="#local-6989586621683161113"><span class="hs-identifier hs-var hs-var hs-var">res_kind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Type
</span><a href="GHC.Core.TyCon.html#tyConResKind"><span class="hs-identifier hs-var">tyConResKind</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161101"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-2157"></span><span>             </span><span id="local-6989586621683161114"><span class="annot"><span class="annottext">resVar :: Maybe Name
</span><a href="#local-6989586621683161114"><span class="hs-identifier hs-var hs-var hs-var">resVar</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Maybe Name
</span><a href="GHC.Core.TyCon.html#tyConFamilyResVar_maybe"><span class="hs-identifier hs-var">tyConFamilyResVar_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161101"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-2158"></span><span>
</span><span id="line-2159"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161116"><span class="annot"><a href="#local-6989586621683161116"><span class="hs-identifier hs-var">kind'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#reifyKind"><span class="hs-identifier hs-var">reifyKind</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161113"><span class="hs-identifier hs-var">res_kind</span></a></span><span>
</span><span id="line-2160"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683161118"><span class="annot"><a href="#local-6989586621683161118"><span class="hs-identifier hs-var">resultSig</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161119"><span class="annot"><a href="#local-6989586621683161119"><span class="hs-identifier hs-var">injectivity</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2161"></span><span>                 </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683161114"><span class="hs-identifier hs-type">resVar</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2162"></span><span>                   </span><span class="annot"><span class="annottext">Maybe Name
</span><span class="hs-identifier hs-var">Nothing</span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; FamilyResultSig
</span><span class="hs-identifier hs-var">TH.KindSig</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161116"><span class="hs-identifier hs-var">kind'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe InjectivityAnn
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-2163"></span><span>                   </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683161121"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161121"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2164"></span><span>                     </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683161122"><span class="annot"><span class="annottext">thName :: Name
</span><a href="#local-6989586621683161122"><span class="hs-identifier hs-var hs-var">thName</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name
forall n. NamedThing n =&gt; n -&gt; Name
</span><a href="GHC.Tc.Gen.Splice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161121"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-2165"></span><span>                         </span><span id="local-6989586621683161123"><span class="annot"><span class="annottext">injAnnot :: Injectivity
</span><a href="#local-6989586621683161123"><span class="hs-identifier hs-var hs-var">injAnnot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Injectivity
</span><a href="GHC.Core.TyCon.html#tyConInjectivityInfo"><span class="hs-identifier hs-var">tyConInjectivityInfo</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161101"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-2166"></span><span>                         </span><span id="local-6989586621683161125"><span class="annot"><span class="annottext">sig :: FamilyResultSig
</span><a href="#local-6989586621683161125"><span class="hs-identifier hs-var hs-var">sig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVarBndr () -&gt; FamilyResultSig
</span><span class="hs-identifier hs-var">TH.TyVarSig</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; () -&gt; Type -&gt; TyVarBndr ()
forall flag. Name -&gt; flag -&gt; Type -&gt; TyVarBndr flag
</span><span class="hs-identifier hs-var">TH.KindedTV</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161122"><span class="hs-identifier hs-var">thName</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161116"><span class="hs-identifier hs-var">kind'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2167"></span><span>                         </span><span id="local-6989586621683161128"><span class="annot"><span class="annottext">inj :: Maybe InjectivityAnn
</span><a href="#local-6989586621683161128"><span class="hs-identifier hs-var hs-var">inj</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Injectivity
</span><a href="#local-6989586621683161123"><span class="hs-identifier hs-var">injAnnot</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2168"></span><span>                                 </span><span class="annot"><span class="annottext">Injectivity
</span><a href="GHC.Core.TyCon.html#NotInjective"><span class="hs-identifier hs-var">NotInjective</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe InjectivityAnn
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-2169"></span><span>                                 </span><span class="annot"><a href="GHC.Core.TyCon.html#Injective"><span class="hs-identifier hs-type">Injective</span></a></span><span> </span><span id="local-6989586621683161131"><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621683161131"><span class="hs-identifier hs-var">ms</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2170"></span><span>                                     </span><span class="annot"><span class="annottext">InjectivityAnn -&gt; Maybe InjectivityAnn
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; [Name] -&gt; InjectivityAnn
</span><span class="hs-identifier hs-var">TH.InjectivityAnn</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161122"><span class="hs-identifier hs-var">thName</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621683161133"><span class="hs-identifier hs-var">injRHS</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2171"></span><span>                                   </span><span class="hs-keyword">where</span><span>
</span><span id="line-2172"></span><span>                                     </span><span id="local-6989586621683161133"><span class="annot"><span class="annottext">injRHS :: [Name]
</span><a href="#local-6989586621683161133"><span class="hs-identifier hs-var hs-var">injRHS</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TyVar -&gt; Name) -&gt; [TyVar] -&gt; [Name]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Name
forall n. NamedThing n =&gt; n -&gt; Name
</span><a href="GHC.Tc.Gen.Splice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Name) -&gt; (TyVar -&gt; Name) -&gt; TyVar -&gt; Name
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Name
</span><a href="GHC.Types.Var.html#tyVarName"><span class="hs-identifier hs-var">tyVarName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2173"></span><span>                                                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Bool] -&gt; [TyVar] -&gt; [TyVar]
forall a. [Bool] -&gt; [a] -&gt; [a]
</span><a href="GHC.Utils.Misc.html#filterByList"><span class="hs-identifier hs-var">filterByList</span></a></span><span> </span><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621683161131"><span class="hs-identifier hs-var">ms</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621683161111"><span class="hs-identifier hs-var">tvs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2174"></span><span>                     </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FamilyResultSig
</span><a href="#local-6989586621683161125"><span class="hs-identifier hs-var">sig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe InjectivityAnn
</span><a href="#local-6989586621683161128"><span class="hs-identifier hs-var">inj</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2175"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161136"><span class="annot"><a href="#local-6989586621683161136"><span class="hs-identifier hs-var">tvs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyTyConBinders"><span class="hs-identifier hs-type">reifyTyConBinders</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161101"><span class="hs-identifier hs-type">tc</span></a></span><span>
</span><span id="line-2176"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683161138"><span class="annot"><a href="#local-6989586621683161138"><span class="hs-identifier hs-var hs-var">tfHead</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2177"></span><span>               </span><span class="annot"><span class="annottext">Name
-&gt; [TyVarBndr BndrVis]
-&gt; FamilyResultSig
-&gt; Maybe InjectivityAnn
-&gt; TypeFamilyHead
</span><span class="hs-identifier hs-var">TH.TypeFamilyHead</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Name
forall n. NamedThing n =&gt; n -&gt; Name
</span><a href="GHC.Tc.Gen.Splice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161101"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TyVarBndr BndrVis]
</span><a href="#local-6989586621683161136"><span class="hs-identifier hs-var">tvs'</span></a></span><span> </span><span class="annot"><span class="annottext">FamilyResultSig
</span><a href="#local-6989586621683161118"><span class="hs-identifier hs-var">resultSig</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe InjectivityAnn
</span><a href="#local-6989586621683161119"><span class="hs-identifier hs-var">injectivity</span></a></span><span>
</span><span id="line-2178"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#isOpenTypeFamilyTyCon"><span class="hs-identifier hs-type">isOpenTypeFamilyTyCon</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161101"><span class="hs-identifier hs-type">tc</span></a></span><span>
</span><span id="line-2179"></span><span>         </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683161141"><span class="annot"><a href="#local-6989586621683161141"><span class="hs-identifier hs-var">fam_envs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Instance.Family.html#tcGetFamInstEnvs"><span class="hs-identifier hs-type">tcGetFamInstEnvs</span></a></span><span>
</span><span id="line-2180"></span><span>                 </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161142"><span class="annot"><a href="#local-6989586621683161142"><span class="hs-identifier hs-var">instances</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyFamilyInstances"><span class="hs-identifier hs-type">reifyFamilyInstances</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161101"><span class="hs-identifier hs-type">tc</span></a></span><span>
</span><span id="line-2181"></span><span>                                  </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#familyInstances"><span class="hs-identifier hs-type">familyInstances</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161141"><span class="hs-identifier hs-type">fam_envs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161101"><span class="hs-identifier hs-type">tc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2182"></span><span>                 </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.FamilyI</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.OpenTypeFamilyD</span></span><span> </span><span class="annot"><a href="#local-6989586621683161138"><span class="hs-identifier hs-type">tfHead</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683161142"><span class="hs-identifier hs-type">instances</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2183"></span><span>         </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683161146"><span class="annot"><a href="#local-6989586621683161146"><span class="hs-identifier hs-var">eqns</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-2184"></span><span>                     </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#isClosedSynFamilyTyConWithAxiom_maybe"><span class="hs-identifier hs-type">isClosedSynFamilyTyConWithAxiom_maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161101"><span class="hs-identifier hs-type">tc</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2185"></span><span>                       </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683161148"><span class="annot"><span class="annottext">CoAxiom Branched
</span><a href="#local-6989586621683161148"><span class="hs-identifier hs-var">ax</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(CoAxBranch -&gt; TcM TySynEqn)
-&gt; [CoAxBranch] -&gt; IOEnv (Env TcGblEnv TcLclEnv) [TySynEqn]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; CoAxBranch -&gt; TcM TySynEqn
</span><a href="GHC.Tc.Gen.Splice.html#reifyAxBranch"><span class="hs-identifier hs-var">reifyAxBranch</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161101"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([CoAxBranch] -&gt; IOEnv (Env TcGblEnv TcLclEnv) [TySynEqn])
-&gt; [CoAxBranch] -&gt; IOEnv (Env TcGblEnv TcLclEnv) [TySynEqn]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2186"></span><span>                                  </span><span class="annot"><span class="annottext">Branches Branched -&gt; [CoAxBranch]
forall (br :: BranchFlag). Branches br -&gt; [CoAxBranch]
</span><a href="GHC.Core.Coercion.Axiom.html#fromBranches"><span class="hs-identifier hs-var">fromBranches</span></a></span><span> </span><span class="annot"><span class="annottext">(Branches Branched -&gt; [CoAxBranch])
-&gt; Branches Branched -&gt; [CoAxBranch]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CoAxiom Branched -&gt; Branches Branched
forall (br :: BranchFlag). CoAxiom br -&gt; Branches br
</span><a href="GHC.Core.Coercion.Axiom.html#coAxiomBranches"><span class="hs-identifier hs-var">coAxiomBranches</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiom Branched
</span><a href="#local-6989586621683161148"><span class="hs-identifier hs-var">ax</span></a></span><span>
</span><span id="line-2187"></span><span>                       </span><span class="annot"><span class="annottext">Maybe (CoAxiom Branched)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[TySynEqn] -&gt; IOEnv (Env TcGblEnv TcLclEnv) [TySynEqn]
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-2188"></span><span>                 </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.FamilyI</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.ClosedTypeFamilyD</span></span><span> </span><span class="annot"><a href="#local-6989586621683161138"><span class="hs-identifier hs-type">tfHead</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161146"><span class="hs-identifier hs-type">eqns</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2189"></span><span>                      </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2190"></span><span>
</span><span id="line-2191"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isDataFamilyTyCon"><span class="hs-identifier hs-var">isDataFamilyTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161101"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-2192"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683161153"><span class="annot"><span class="annottext">res_kind :: Type
</span><a href="#local-6989586621683161153"><span class="hs-identifier hs-var hs-var hs-var">res_kind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Type
</span><a href="GHC.Core.TyCon.html#tyConResKind"><span class="hs-identifier hs-var">tyConResKind</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161101"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-2193"></span><span>
</span><span id="line-2194"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161154"><span class="annot"><a href="#local-6989586621683161154"><span class="hs-identifier hs-var">kind'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Maybe Type)
-&gt; TcM Type -&gt; IOEnv (Env TcGblEnv TcLclEnv) (Maybe Type)
forall a b.
(a -&gt; b)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) a
-&gt; IOEnv (Env TcGblEnv TcLclEnv) b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe Type
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#reifyKind"><span class="hs-identifier hs-var">reifyKind</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161153"><span class="hs-identifier hs-var">res_kind</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2195"></span><span>
</span><span id="line-2196"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161155"><span class="annot"><a href="#local-6989586621683161155"><span class="hs-identifier hs-var">tvs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyTyConBinders"><span class="hs-identifier hs-type">reifyTyConBinders</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161101"><span class="hs-identifier hs-type">tc</span></a></span><span>
</span><span id="line-2197"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161156"><span class="annot"><a href="#local-6989586621683161156"><span class="hs-identifier hs-var">fam_envs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Instance.Family.html#tcGetFamInstEnvs"><span class="hs-identifier hs-type">tcGetFamInstEnvs</span></a></span><span>
</span><span id="line-2198"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161157"><span class="annot"><a href="#local-6989586621683161157"><span class="hs-identifier hs-var">instances</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyFamilyInstances"><span class="hs-identifier hs-type">reifyFamilyInstances</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161101"><span class="hs-identifier hs-type">tc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#familyInstances"><span class="hs-identifier hs-type">familyInstances</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161156"><span class="hs-identifier hs-type">fam_envs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161101"><span class="hs-identifier hs-type">tc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2199"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.FamilyI</span></span><span>
</span><span id="line-2200"></span><span>                       </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.DataFamilyD</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyName"><span class="hs-identifier hs-type">reifyName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161101"><span class="hs-identifier hs-type">tc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683161155"><span class="hs-identifier hs-type">tvs'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161154"><span class="hs-identifier hs-type">kind'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683161157"><span class="hs-identifier hs-type">instances</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2201"></span><span>
</span><span id="line-2202"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TyVar]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161159"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161159"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Maybe ([TyVar], Type)
</span><a href="GHC.Core.TyCon.html#synTyConDefn_maybe"><span class="hs-identifier hs-var">synTyConDefn_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161101"><span class="hs-identifier hs-var">tc</span></a></span><span>  </span><span class="hs-comment">-- Vanilla type synonym</span><span>
</span><span id="line-2203"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683161161"><span class="annot"><a href="#local-6989586621683161161"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161159"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-2204"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161162"><span class="annot"><a href="#local-6989586621683161162"><span class="hs-identifier hs-var">tvs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyTyConBinders"><span class="hs-identifier hs-type">reifyTyConBinders</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161101"><span class="hs-identifier hs-type">tc</span></a></span><span>
</span><span id="line-2205"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.TyConI</span></span><span>
</span><span id="line-2206"></span><span>                   </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.TySynD</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyName"><span class="hs-identifier hs-type">reifyName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161101"><span class="hs-identifier hs-type">tc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683161162"><span class="hs-identifier hs-type">tvs'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161161"><span class="hs-identifier hs-type">rhs'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2207"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-2208"></span><span>
</span><span id="line-2209"></span><span>  </span><span class="hs-comment">-- Special case for `type data` data constructors, which are reified as</span><span>
</span><span id="line-2210"></span><span>  </span><span class="hs-comment">-- `ATyCon`s rather than `ADataCon`s (#22818).</span><span>
</span><span id="line-2211"></span><span>  </span><span class="hs-comment">-- See Note [Type data declarations] in GHC.Rename.Module.</span><span>
</span><span id="line-2212"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683161165"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621683161165"><span class="hs-identifier hs-var">dc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Maybe DataCon
</span><a href="GHC.Core.TyCon.html#isPromotedDataCon_maybe"><span class="hs-identifier hs-var">isPromotedDataCon_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161101"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-2213"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; Bool
</span><a href="GHC.Core.DataCon.html#isTypeDataCon"><span class="hs-identifier hs-var">isTypeDataCon</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621683161165"><span class="hs-identifier hs-var">dc</span></a></span><span>
</span><span id="line-2214"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; TcM Info
</span><a href="GHC.Tc.Gen.Splice.html#mkDataConI"><span class="hs-identifier hs-var">mkDataConI</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621683161165"><span class="hs-identifier hs-var">dc</span></a></span><span>
</span><span id="line-2215"></span><span>
</span><span id="line-2216"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2217"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683161168"><span class="annot"><a href="#local-6989586621683161168"><span class="hs-identifier hs-var">cxt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; TcM [Type]
</span><a href="GHC.Tc.Gen.Splice.html#reifyCxt"><span class="hs-identifier hs-var">reifyCxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [Type]
</span><a href="GHC.Core.TyCon.html#tyConStupidTheta"><span class="hs-identifier hs-var">tyConStupidTheta</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161101"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2218"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683161171"><span class="annot"><a href="#local-6989586621683161171"><span class="hs-identifier hs-var hs-var">tvs</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [TyVar]
</span><a href="GHC.Core.TyCon.html#tyConTyVars"><span class="hs-identifier hs-var">tyConTyVars</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161101"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-2219"></span><span>              </span><span id="local-6989586621683161172"><span class="annot"><a href="#local-6989586621683161172"><span class="hs-identifier hs-var hs-var">dataCons</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [DataCon]
</span><a href="GHC.Core.TyCon.html#tyConDataCons"><span class="hs-identifier hs-var">tyConDataCons</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161101"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-2220"></span><span>              </span><span id="local-6989586621683161174"><span class="annot"><a href="#local-6989586621683161174"><span class="hs-identifier hs-var hs-var">isGadt</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isGadtSyntaxTyCon"><span class="hs-identifier hs-var">isGadtSyntaxTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161101"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-2221"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161176"><span class="annot"><a href="#local-6989586621683161176"><span class="hs-identifier hs-var">cons</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyDataCon"><span class="hs-identifier hs-type">reifyDataCon</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161174"><span class="hs-identifier hs-type">isGadt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#mkTyVarTys"><span class="hs-identifier hs-type">mkTyVarTys</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161171"><span class="hs-identifier hs-type">tvs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683161172"><span class="hs-identifier hs-type">dataCons</span></a></span><span>
</span><span id="line-2222"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161179"><span class="annot"><a href="#local-6989586621683161179"><span class="hs-identifier hs-var">r_tvs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyTyConBinders"><span class="hs-identifier hs-type">reifyTyConBinders</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161101"><span class="hs-identifier hs-type">tc</span></a></span><span>
</span><span id="line-2223"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683161180"><span class="annot"><a href="#local-6989586621683161180"><span class="hs-identifier hs-var hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Name
forall n. NamedThing n =&gt; n -&gt; Name
</span><a href="GHC.Tc.Gen.Splice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161101"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-2224"></span><span>              </span><span id="local-6989586621683161181"><span class="annot"><a href="#local-6989586621683161181"><span class="hs-identifier hs-var hs-var">deriv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>        </span><span class="hs-comment">-- Don't know about deriving</span><span>
</span><span id="line-2225"></span><span>              </span><span id="local-6989586621683161182"><span class="annot"><a href="#local-6989586621683161182"><span class="hs-identifier hs-var hs-var">decl</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isTypeDataTyCon"><span class="hs-identifier hs-var">isTypeDataTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161101"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2226"></span><span>                       </span><span class="hs-comment">-- `type data` declarations have a special `Dec`,</span><span>
</span><span id="line-2227"></span><span>                       </span><span class="hs-comment">-- separate from other `DataD`s. See</span><span>
</span><span id="line-2228"></span><span>                       </span><span class="hs-comment">-- [Type data declarations] in GHC.Rename.Module.</span><span>
</span><span id="line-2229"></span><span>                       </span><span class="annot"><span class="annottext">Name -&gt; [TyVarBndr BndrVis] -&gt; Maybe Type -&gt; [Con] -&gt; Dec
</span><span class="hs-identifier hs-var">TH.TypeDataD</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161180"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVarBndr BndrVis]
</span><a href="#local-6989586621683161179"><span class="hs-identifier hs-var">r_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Type
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">[Con]
</span><a href="#local-6989586621683161176"><span class="hs-identifier hs-var">cons</span></a></span><span>
</span><span id="line-2230"></span><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isNewTyCon"><span class="hs-identifier hs-var">isNewTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161101"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2231"></span><span>                       </span><span class="annot"><span class="annottext">[Type]
-&gt; Name
-&gt; [TyVarBndr BndrVis]
-&gt; Maybe Type
-&gt; Con
-&gt; [DerivClause]
-&gt; Dec
</span><span class="hs-identifier hs-var">TH.NewtypeD</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161168"><span class="hs-identifier hs-var">cxt</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161180"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVarBndr BndrVis]
</span><a href="#local-6989586621683161179"><span class="hs-identifier hs-var">r_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Type
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Con] -&gt; Con
forall a. HasCallStack =&gt; [a] -&gt; a
</span><a href="GHC.Prelude.Basic.html#head"><span class="hs-identifier hs-var">head</span></a></span><span> </span><span class="annot"><span class="annottext">[Con]
</span><a href="#local-6989586621683161176"><span class="hs-identifier hs-var">cons</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DerivClause]
forall a. [a]
</span><a href="#local-6989586621683161181"><span class="hs-identifier hs-var">deriv</span></a></span><span>
</span><span id="line-2232"></span><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>     </span><span class="hs-glyph">=</span><span>
</span><span id="line-2233"></span><span>                       </span><span class="annot"><span class="annottext">[Type]
-&gt; Name
-&gt; [TyVarBndr BndrVis]
-&gt; Maybe Type
-&gt; [Con]
-&gt; [DerivClause]
-&gt; Dec
</span><span class="hs-identifier hs-var">TH.DataD</span></span><span>    </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161168"><span class="hs-identifier hs-var">cxt</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161180"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVarBndr BndrVis]
</span><a href="#local-6989586621683161179"><span class="hs-identifier hs-var">r_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Type
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>       </span><span class="annot"><span class="annottext">[Con]
</span><a href="#local-6989586621683161176"><span class="hs-identifier hs-var">cons</span></a></span><span>  </span><span class="annot"><span class="annottext">[DerivClause]
forall a. [a]
</span><a href="#local-6989586621683161181"><span class="hs-identifier hs-var">deriv</span></a></span><span>
</span><span id="line-2234"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.TyConI</span></span><span> </span><span class="annot"><a href="#local-6989586621683161182"><span class="hs-identifier hs-type">decl</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2235"></span><span>
</span><span id="line-2236"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyDataCon"><span class="hs-identifier hs-type">reifyDataCon</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Con</span></span><span>
</span><span id="line-2237"></span><span id="reifyDataCon"><span class="annot"><span class="annottext">reifyDataCon :: Bool -&gt; [Type] -&gt; DataCon -&gt; IOEnv (Env TcGblEnv TcLclEnv) Con
</span><a href="GHC.Tc.Gen.Splice.html#reifyDataCon"><span class="hs-identifier hs-var hs-var">reifyDataCon</span></a></span></span><span> </span><span id="local-6989586621683161189"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683161189"><span class="hs-identifier hs-var">isGadtDataCon</span></a></span></span><span> </span><span id="local-6989586621683161190"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161190"><span class="hs-identifier hs-var">tys</span></a></span></span><span> </span><span id="local-6989586621683161191"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621683161191"><span class="hs-identifier hs-var">dc</span></a></span></span><span>
</span><span id="line-2238"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- used for H98 data constructors</span><span>
</span><span id="line-2239"></span><span>             </span><span class="hs-special">(</span><span id="local-6989586621683161192"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621683161192"><span class="hs-identifier hs-var hs-var">ex_tvs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161193"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161193"><span class="hs-identifier hs-var hs-var">theta</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161194"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161194"><span class="hs-identifier hs-var hs-var">arg_tys</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2240"></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; [Type] -&gt; ([TyVar], [Type], [Type])
</span><a href="GHC.Core.DataCon.html#dataConInstSig"><span class="hs-identifier hs-var">dataConInstSig</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621683161191"><span class="hs-identifier hs-var">dc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161190"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-2241"></span><span>             </span><span class="hs-comment">-- used for GADTs data constructors</span><span>
</span><span id="line-2242"></span><span>             </span><span id="local-6989586621683161196"><span class="annot"><span class="annottext">g_user_tvs' :: [InvisTVBinder]
</span><a href="#local-6989586621683161196"><span class="hs-identifier hs-var hs-var hs-var">g_user_tvs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; [InvisTVBinder]
</span><a href="GHC.Core.DataCon.html#dataConUserTyVarBinders"><span class="hs-identifier hs-var">dataConUserTyVarBinders</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621683161191"><span class="hs-identifier hs-var">dc</span></a></span><span>
</span><span id="line-2243"></span><span>             </span><span class="hs-special">(</span><span id="local-6989586621683161198"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621683161198"><span class="hs-identifier hs-var hs-var">g_univ_tvs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161199"><span class="annot"><span class="annottext">[EqSpec]
</span><a href="#local-6989586621683161199"><span class="hs-identifier hs-var hs-var">g_eq_spec</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161200"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161200"><span class="hs-identifier hs-var hs-var">g_theta'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161201"><span class="annot"><span class="annottext">[Scaled Type]
</span><a href="#local-6989586621683161201"><span class="hs-identifier hs-var hs-var">g_arg_tys'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161202"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161202"><span class="hs-identifier hs-var hs-var">g_res_ty'</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2244"></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon
-&gt; ([TyVar], [TyVar], [EqSpec], [Type], [Scaled Type], Type)
</span><a href="GHC.Core.DataCon.html#dataConFullSig"><span class="hs-identifier hs-var">dataConFullSig</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621683161191"><span class="hs-identifier hs-var">dc</span></a></span><span>
</span><span id="line-2245"></span><span>             </span><span class="hs-special">(</span><span id="local-6989586621683161204"><span class="annot"><span class="annottext">[SourceUnpackedness]
</span><a href="#local-6989586621683161204"><span class="hs-identifier hs-var hs-var">srcUnpks</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161205"><span class="annot"><span class="annottext">[SourceStrictness]
</span><a href="#local-6989586621683161205"><span class="hs-identifier hs-var hs-var">srcStricts</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2246"></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(HsSrcBang -&gt; (SourceUnpackedness, SourceStrictness))
-&gt; [HsSrcBang] -&gt; ([SourceUnpackedness], [SourceStrictness])
forall a b c. (a -&gt; (b, c)) -&gt; [a] -&gt; ([b], [c])
</span><a href="GHC.Utils.Misc.html#mapAndUnzip"><span class="hs-identifier hs-var">mapAndUnzip</span></a></span><span> </span><span class="annot"><span class="annottext">HsSrcBang -&gt; (SourceUnpackedness, SourceStrictness)
</span><a href="GHC.Tc.Gen.Splice.html#reifySourceBang"><span class="hs-identifier hs-var">reifySourceBang</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; [HsSrcBang]
</span><a href="GHC.Core.DataCon.html#dataConSrcBangs"><span class="hs-identifier hs-var">dataConSrcBangs</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621683161191"><span class="hs-identifier hs-var">dc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2247"></span><span>             </span><span id="local-6989586621683161209"><span class="annot"><span class="annottext">dcdBangs :: [Bang]
</span><a href="#local-6989586621683161209"><span class="hs-identifier hs-var hs-var hs-var">dcdBangs</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SourceUnpackedness -&gt; SourceStrictness -&gt; Bang)
-&gt; [SourceUnpackedness] -&gt; [SourceStrictness] -&gt; [Bang]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">SourceUnpackedness -&gt; SourceStrictness -&gt; Bang
</span><span class="hs-identifier hs-var">TH.Bang</span></span><span> </span><span class="annot"><span class="annottext">[SourceUnpackedness]
</span><a href="#local-6989586621683161204"><span class="hs-identifier hs-var">srcUnpks</span></a></span><span> </span><span class="annot"><span class="annottext">[SourceStrictness]
</span><a href="#local-6989586621683161205"><span class="hs-identifier hs-var">srcStricts</span></a></span><span>
</span><span id="line-2248"></span><span>             </span><span id="local-6989586621683161212"><span class="annot"><span class="annottext">fields :: [FieldLabel]
</span><a href="#local-6989586621683161212"><span class="hs-identifier hs-var hs-var hs-var">fields</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; [FieldLabel]
</span><a href="GHC.Core.DataCon.html#dataConFieldLabels"><span class="hs-identifier hs-var">dataConFieldLabels</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621683161191"><span class="hs-identifier hs-var">dc</span></a></span><span>
</span><span id="line-2249"></span><span>             </span><span id="local-6989586621683161214"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621683161214"><span class="hs-identifier hs-var hs-var hs-var">name</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; Name
forall n. NamedThing n =&gt; n -&gt; Name
</span><a href="GHC.Tc.Gen.Splice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621683161191"><span class="hs-identifier hs-var">dc</span></a></span><span>
</span><span id="line-2250"></span><span>             </span><span class="hs-comment">-- Universal tvs present in eq_spec need to be filtered out, as</span><span>
</span><span id="line-2251"></span><span>             </span><span class="hs-comment">-- they will not appear anywhere in the type.</span><span>
</span><span id="line-2252"></span><span>             </span><span id="local-6989586621683161215"><span class="annot"><span class="annottext">eq_spec_tvs :: VarSet
</span><a href="#local-6989586621683161215"><span class="hs-identifier hs-var hs-var hs-var">eq_spec_tvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(EqSpec -&gt; TyVar) -&gt; [EqSpec] -&gt; [TyVar]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">EqSpec -&gt; TyVar
</span><a href="GHC.Core.DataCon.html#eqSpecTyVar"><span class="hs-identifier hs-var">eqSpecTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">[EqSpec]
</span><a href="#local-6989586621683161199"><span class="hs-identifier hs-var">g_eq_spec</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2253"></span><span>
</span><span id="line-2254"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683161218"><span class="annot"><a href="#local-6989586621683161218"><span class="hs-identifier hs-var">univ_subst</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-2255"></span><span>              </span><span class="hs-comment">-- See Note [Freshen reified GADT constructors' universal tyvars]</span><span>
</span><span id="line-2256"></span><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; TcM (Subst, [TyVar])
</span><a href="GHC.Tc.Utils.Instantiate.html#freshenTyVarBndrs"><span class="hs-identifier hs-var">freshenTyVarBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">([TyVar] -&gt; TcM (Subst, [TyVar]))
-&gt; [TyVar] -&gt; TcM (Subst, [TyVar])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2257"></span><span>              </span><span class="annot"><span class="annottext">(TyVar -&gt; Bool) -&gt; [TyVar] -&gt; [TyVar]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="GHC.Utils.Misc.html#filterOut"><span class="hs-identifier hs-var">filterOut</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683161215"><span class="hs-identifier hs-var">eq_spec_tvs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621683161198"><span class="hs-identifier hs-var">g_univ_tvs</span></a></span><span>
</span><span id="line-2258"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683161222"><span class="annot"><a href="#local-6989586621683161222"><span class="hs-identifier hs-var">tvb_subst</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161223"><span class="annot"><a href="#local-6989586621683161223"><span class="hs-identifier hs-var">g_user_tvs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683161224"><span class="hs-identifier hs-type">subst_tv_binders</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161218"><span class="hs-identifier hs-type">univ_subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161196"><span class="hs-identifier hs-type">g_user_tvs'</span></a></span><span>
</span><span id="line-2259"></span><span>             </span><span id="local-6989586621683161225"><span class="annot"><a href="#local-6989586621683161225"><span class="hs-identifier hs-var hs-var">g_theta</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; [Type] -&gt; [Type]
Subst -&gt; [Type] -&gt; [Type]
</span><a href="GHC.Core.TyCo.Subst.html#substTys"><span class="hs-identifier hs-var">substTys</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683161222"><span class="hs-identifier hs-var">tvb_subst</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161200"><span class="hs-identifier hs-var">g_theta'</span></a></span><span>
</span><span id="line-2260"></span><span>             </span><span id="local-6989586621683161227"><span class="annot"><a href="#local-6989586621683161227"><span class="hs-identifier hs-var hs-var">g_arg_tys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; [Type] -&gt; [Type]
Subst -&gt; [Type] -&gt; [Type]
</span><a href="GHC.Core.TyCo.Subst.html#substTys"><span class="hs-identifier hs-var">substTys</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683161222"><span class="hs-identifier hs-var">tvb_subst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Scaled Type -&gt; Type) -&gt; [Scaled Type] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Scaled Type -&gt; Type
forall a. Scaled a -&gt; a
</span><a href="GHC.Core.TyCo.Rep.html#scaledThing"><span class="hs-identifier hs-var">scaledThing</span></a></span><span> </span><span class="annot"><span class="annottext">[Scaled Type]
</span><a href="#local-6989586621683161201"><span class="hs-identifier hs-var">g_arg_tys'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2261"></span><span>             </span><span id="local-6989586621683161229"><span class="annot"><a href="#local-6989586621683161229"><span class="hs-identifier hs-var hs-var">g_res_ty</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Type -&gt; Type
Subst -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Subst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a></span><span>  </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683161222"><span class="hs-identifier hs-var">tvb_subst</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161202"><span class="hs-identifier hs-var">g_res_ty'</span></a></span><span>
</span><span id="line-2262"></span><span>
</span><span id="line-2263"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161231"><span class="annot"><a href="#local-6989586621683161231"><span class="hs-identifier hs-var">r_arg_tys</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyTypes"><span class="hs-identifier hs-type">reifyTypes</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621683161189"><span class="hs-identifier hs-type">isGadtDataCon</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><a href="#local-6989586621683161227"><span class="hs-identifier hs-type">g_arg_tys</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><a href="#local-6989586621683161194"><span class="hs-identifier hs-type">arg_tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2264"></span><span>
</span><span id="line-2265"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161232"><span class="annot"><a href="#local-6989586621683161232"><span class="hs-identifier hs-var">main_con</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-2266"></span><span>           </span><span class="hs-keyword">if</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">null</span></span><span> </span><span class="annot"><a href="#local-6989586621683161212"><span class="hs-identifier hs-type">fields</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">&amp;&amp;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="annot"><a href="#local-6989586621683161189"><span class="hs-identifier hs-type">isGadtDataCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2267"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.RecC</span></span><span> </span><span class="annot"><a href="#local-6989586621683161214"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">zip3</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">map</span></span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyFieldLabel"><span class="hs-identifier hs-type">reifyFieldLabel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161212"><span class="hs-identifier hs-type">fields</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2268"></span><span>                                         </span><span class="annot"><a href="#local-6989586621683161209"><span class="hs-identifier hs-type">dcdBangs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161231"><span class="hs-identifier hs-type">r_arg_tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2269"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">null</span></span><span> </span><span class="annot"><a href="#local-6989586621683161212"><span class="hs-identifier hs-type">fields</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2270"></span><span>                  </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683161238"><span class="annot"><a href="#local-6989586621683161238"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-type">reifyType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161229"><span class="hs-identifier hs-type">g_res_ty</span></a></span><span>
</span><span id="line-2271"></span><span>                  </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.RecGadtC</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621683161214"><span class="hs-identifier hs-type">name</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2272"></span><span>                                     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">zip3</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">map</span></span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyFieldLabel"><span class="hs-identifier hs-type">reifyFieldLabel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161212"><span class="hs-identifier hs-type">fields</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2273"></span><span>                                      </span><span class="annot"><a href="#local-6989586621683161209"><span class="hs-identifier hs-type">dcdBangs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161231"><span class="hs-identifier hs-type">r_arg_tys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683161238"><span class="hs-identifier hs-type">res_ty</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2274"></span><span>                </span><span class="hs-comment">-- We need to check not isGadtDataCon here because GADT</span><span>
</span><span id="line-2275"></span><span>                </span><span class="hs-comment">-- constructors can be declared infix.</span><span>
</span><span id="line-2276"></span><span>                </span><span class="hs-comment">-- See Note [Infix GADT constructors] in GHC.Tc.TyCl.</span><span>
</span><span id="line-2277"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#dataConIsInfix"><span class="hs-identifier hs-type">dataConIsInfix</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161191"><span class="hs-identifier hs-type">dc</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&amp;&amp;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="annot"><a href="#local-6989586621683161189"><span class="hs-identifier hs-type">isGadtDataCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2278"></span><span>                  </span><span class="annot"><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-type">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683161231"><span class="hs-identifier hs-type">r_arg_tys</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#lengthIs"><span class="hs-operator hs-type">`lengthIs`</span></a></span><span> </span><span class="annot"><span class="hs-number">2</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2279"></span><span>                  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">[</span><span id="local-6989586621683161242"><span class="annot"><a href="#local-6989586621683161242"><span class="hs-identifier hs-var">r_a1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161243"><span class="annot"><a href="#local-6989586621683161243"><span class="hs-identifier hs-var">r_a2</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683161231"><span class="hs-identifier hs-type">r_arg_tys</span></a></span><span>
</span><span id="line-2280"></span><span>                        </span><span class="hs-special">[</span><span id="local-6989586621683161244"><span class="annot"><a href="#local-6989586621683161244"><span class="hs-identifier hs-var">s1</span></a></span></span><span class="hs-special">,</span><span>   </span><span id="local-6989586621683161245"><span class="annot"><a href="#local-6989586621683161245"><span class="hs-identifier hs-var">s2</span></a></span></span><span class="hs-special">]</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683161209"><span class="hs-identifier hs-type">dcdBangs</span></a></span><span>
</span><span id="line-2281"></span><span>                  </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.InfixC</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683161244"><span class="hs-identifier hs-type">s1</span></a></span><span class="hs-special">,</span><span class="annot"><a href="#local-6989586621683161242"><span class="hs-identifier hs-type">r_a1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683161214"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683161245"><span class="hs-identifier hs-type">s2</span></a></span><span class="hs-special">,</span><span class="annot"><a href="#local-6989586621683161243"><span class="hs-identifier hs-type">r_a2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2282"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="#local-6989586621683161189"><span class="hs-identifier hs-type">isGadtDataCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2283"></span><span>                  </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683161247"><span class="annot"><a href="#local-6989586621683161247"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-type">reifyType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161229"><span class="hs-identifier hs-type">g_res_ty</span></a></span><span>
</span><span id="line-2284"></span><span>                  </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.GadtC</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621683161214"><span class="hs-identifier hs-type">name</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2285"></span><span>                                 </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683161209"><span class="hs-identifier hs-type">dcdBangs</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">`zip`</span></span><span> </span><span class="annot"><a href="#local-6989586621683161231"><span class="hs-identifier hs-type">r_arg_tys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683161247"><span class="hs-identifier hs-type">res_ty</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2286"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2287"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.NormalC</span></span><span> </span><span class="annot"><a href="#local-6989586621683161214"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683161209"><span class="hs-identifier hs-type">dcdBangs</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">`zip`</span></span><span> </span><span class="annot"><a href="#local-6989586621683161231"><span class="hs-identifier hs-type">r_arg_tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2288"></span><span>
</span><span id="line-2289"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683161250"><span class="annot"><a href="#local-6989586621683161250"><span class="hs-identifier hs-var">ex_tvs'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161251"><span class="annot"><a href="#local-6989586621683161251"><span class="hs-identifier hs-var">theta'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="#local-6989586621683161189"><span class="hs-identifier hs-type">isGadtDataCon</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683161223"><span class="hs-identifier hs-type">g_user_tvs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683161225"><span class="hs-identifier hs-type">g_theta</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2290"></span><span>                               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">otherwise</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-type">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">all</span></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-type">isTyVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161192"><span class="hs-identifier hs-type">ex_tvs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2291"></span><span>                                                 </span><span class="hs-comment">-- no covars for haskell syntax</span><span>
</span><span id="line-2292"></span><span>                                                 </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">map</span></span><span> </span><span class="annot"><a href="#local-6989586621683161254"><span class="hs-identifier hs-type">mk_specified</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161192"><span class="hs-identifier hs-type">ex_tvs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683161193"><span class="hs-identifier hs-type">theta</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2293"></span><span>             </span><span id="local-6989586621683161255"><span class="annot"><a href="#local-6989586621683161255"><span class="hs-identifier hs-var hs-var">ret_con</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[InvisTVBinder] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[InvisTVBinder]
</span><a href="#local-6989586621683161250"><span class="hs-identifier hs-var">ex_tvs'</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161251"><span class="hs-identifier hs-var">theta'</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Con -&gt; IOEnv (Env TcGblEnv TcLclEnv) Con
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Con
</span><a href="#local-6989586621683161232"><span class="hs-identifier hs-var">main_con</span></a></span><span>
</span><span id="line-2294"></span><span>                     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2295"></span><span>                         </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683161256"><span class="annot"><a href="#local-6989586621683161256"><span class="hs-identifier hs-var">cxt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; TcM [Type]
</span><a href="GHC.Tc.Gen.Splice.html#reifyCxt"><span class="hs-identifier hs-var">reifyCxt</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161251"><span class="hs-identifier hs-var">theta'</span></a></span><span>
</span><span id="line-2296"></span><span>                         </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161257"><span class="annot"><a href="#local-6989586621683161257"><span class="hs-identifier hs-var">ex_tvs''</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyTyVarBndrs"><span class="hs-identifier hs-type">reifyTyVarBndrs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161250"><span class="hs-identifier hs-type">ex_tvs'</span></a></span><span>
</span><span id="line-2297"></span><span>                         </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.ForallC</span></span><span> </span><span class="annot"><a href="#local-6989586621683161257"><span class="hs-identifier hs-type">ex_tvs''</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161256"><span class="hs-identifier hs-type">cxt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161232"><span class="hs-identifier hs-type">main_con</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2298"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-type">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683161231"><span class="hs-identifier hs-type">r_arg_tys</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#equalLength"><span class="hs-operator hs-type">`equalLength`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161209"><span class="hs-identifier hs-type">dcdBangs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2299"></span><span>         </span><span class="annot"><a href="#local-6989586621683161255"><span class="hs-identifier hs-type">ret_con</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2300"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2301"></span><span>    </span><span id="local-6989586621683161254"><span class="annot"><span class="annottext">mk_specified :: var -&gt; VarBndr var Specificity
</span><a href="#local-6989586621683161254"><span class="hs-identifier hs-var hs-var">mk_specified</span></a></span></span><span> </span><span id="local-6989586621683161261"><span class="annot"><span class="annottext">var
</span><a href="#local-6989586621683161261"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">var -&gt; Specificity -&gt; VarBndr var Specificity
forall var argf. var -&gt; argf -&gt; VarBndr var argf
</span><a href="GHC.Types.Var.html#Bndr"><span class="hs-identifier hs-var">Bndr</span></a></span><span> </span><span class="annot"><span class="annottext">var
</span><a href="#local-6989586621683161261"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">Specificity
</span><a href="Language.Haskell.Syntax.Specificity.html#SpecifiedSpec"><span class="hs-identifier hs-var">SpecifiedSpec</span></a></span><span>
</span><span id="line-2302"></span><span>
</span><span id="line-2303"></span><span>    </span><span id="local-6989586621683161224"><span class="annot"><span class="annottext">subst_tv_binders :: Subst -&gt; [VarBndr TyVar argf] -&gt; (Subst, [VarBndr TyVar argf])
</span><a href="#local-6989586621683161224"><span class="hs-identifier hs-var hs-var">subst_tv_binders</span></a></span></span><span> </span><span id="local-6989586621683161265"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683161265"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621683161266"><span class="annot"><span class="annottext">[VarBndr TyVar argf]
</span><a href="#local-6989586621683161266"><span class="hs-identifier hs-var">tv_bndrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2304"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683161267"><span class="annot"><span class="annottext">tvs :: [TyVar]
</span><a href="#local-6989586621683161267"><span class="hs-identifier hs-var hs-var">tvs</span></a></span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VarBndr TyVar argf] -&gt; [TyVar]
forall tv argf. [VarBndr tv argf] -&gt; [tv]
</span><a href="GHC.Types.Var.html#binderVars"><span class="hs-identifier hs-var">binderVars</span></a></span><span> </span><span class="annot"><span class="annottext">[VarBndr TyVar argf]
</span><a href="#local-6989586621683161266"><span class="hs-identifier hs-var">tv_bndrs</span></a></span><span>
</span><span id="line-2305"></span><span>          </span><span id="local-6989586621683161269"><span class="annot"><span class="annottext">flags :: [argf]
</span><a href="#local-6989586621683161269"><span class="hs-identifier hs-var hs-var">flags</span></a></span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VarBndr TyVar argf] -&gt; [argf]
forall tv argf. [VarBndr tv argf] -&gt; [argf]
</span><a href="GHC.Types.Var.html#binderFlags"><span class="hs-identifier hs-var">binderFlags</span></a></span><span> </span><span class="annot"><span class="annottext">[VarBndr TyVar argf]
</span><a href="#local-6989586621683161266"><span class="hs-identifier hs-var">tv_bndrs</span></a></span><span>
</span><span id="line-2306"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621683161271"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683161271"><span class="hs-identifier hs-var">subst'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161272"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621683161272"><span class="hs-identifier hs-var">tvs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; [TyVar] -&gt; (Subst, [TyVar])
Subst -&gt; [TyVar] -&gt; (Subst, [TyVar])
</span><a href="GHC.Core.TyCo.Subst.html#substTyVarBndrs"><span class="hs-identifier hs-var">substTyVarBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683161265"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621683161267"><span class="hs-identifier hs-var">tvs</span></a></span><span>
</span><span id="line-2307"></span><span>          </span><span id="local-6989586621683161274"><span class="annot"><span class="annottext">tv_bndrs' :: [VarBndr TyVar argf]
</span><a href="#local-6989586621683161274"><span class="hs-identifier hs-var hs-var">tv_bndrs'</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((TyVar, argf) -&gt; VarBndr TyVar argf)
-&gt; [(TyVar, argf)] -&gt; [VarBndr TyVar argf]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621683161275"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621683161275"><span class="hs-identifier hs-var">tv</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621683161276"><span class="annot"><span class="annottext">argf
</span><a href="#local-6989586621683161276"><span class="hs-identifier hs-var">fl</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; argf -&gt; VarBndr TyVar argf
forall var argf. var -&gt; argf -&gt; VarBndr var argf
</span><a href="GHC.Types.Var.html#Bndr"><span class="hs-identifier hs-var">Bndr</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621683161275"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">argf
</span><a href="#local-6989586621683161276"><span class="hs-identifier hs-var">fl</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TyVar] -&gt; [argf] -&gt; [(TyVar, argf)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621683161272"><span class="hs-identifier hs-var">tvs'</span></a></span><span> </span><span class="annot"><span class="annottext">[argf]
</span><a href="#local-6989586621683161269"><span class="hs-identifier hs-var">flags</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2308"></span><span>      </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683161271"><span class="hs-identifier hs-var">subst'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[VarBndr TyVar argf]
</span><a href="#local-6989586621683161274"><span class="hs-identifier hs-var">tv_bndrs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2309"></span><span>
</span><span id="line-2310"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#mkDataConI"><span class="hs-identifier hs-type">mkDataConI</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Info</span></span><span>
</span><span id="line-2311"></span><span id="mkDataConI"><span class="annot"><span class="annottext">mkDataConI :: DataCon -&gt; TcM Info
</span><a href="GHC.Tc.Gen.Splice.html#mkDataConI"><span class="hs-identifier hs-var hs-var">mkDataConI</span></a></span></span><span> </span><span id="local-6989586621683161277"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621683161277"><span class="hs-identifier hs-var">dc</span></a></span></span><span>
</span><span id="line-2312"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683161278"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621683161278"><span class="hs-identifier hs-var hs-var hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; Name
</span><a href="GHC.Core.DataCon.html#dataConName"><span class="hs-identifier hs-var">dataConName</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621683161277"><span class="hs-identifier hs-var">dc</span></a></span><span>
</span><span id="line-2313"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161280"><span class="annot"><a href="#local-6989586621683161280"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; TyVar
</span><a href="GHC.Core.DataCon.html#dataConWrapId"><span class="hs-identifier hs-var">dataConWrapId</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621683161277"><span class="hs-identifier hs-var">dc</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2314"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.DataConI</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyName"><span class="hs-identifier hs-type">reifyName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161278"><span class="hs-identifier hs-type">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683161280"><span class="hs-identifier hs-type">ty</span></a></span><span>
</span><span id="line-2315"></span><span>                              </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyName"><span class="hs-identifier hs-type">reifyName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.DataCon.html#dataConOrigTyCon"><span class="hs-identifier hs-type">dataConOrigTyCon</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161277"><span class="hs-identifier hs-type">dc</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2316"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-2317"></span><span>
</span><span id="line-2318"></span><span class="hs-comment">{-
Note [Freshen reified GADT constructors' universal tyvars]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose one were to reify this GADT:

  data a :~: b where
    Refl :: forall a b. (a ~ b) =&gt; a :~: b

We ought to be careful here about the uniques we give to the occurrences of `a`
and `b` in this definition. That is because in the original DataCon, all uses
of `a` and `b` have the same unique, since `a` and `b` are both universally
quantified type variables--that is, they are used in both the (:~:) tycon as
well as in the constructor type signature. But when we turn the DataCon
definition into the reified one, the `a` and `b` in the constructor type
signature becomes differently scoped than the `a` and `b` in `data a :~: b`.

While it wouldn't technically be *wrong* per se to re-use the same uniques for
`a` and `b` across these two different scopes, it's somewhat annoying for end
users of Template Haskell, since they wouldn't be able to rely on the
assumption that all TH names have globally distinct uniques (#13885). For this
reason, we freshen the universally quantified tyvars that go into the reified
GADT constructor type signature to give them distinct uniques from their
counterparts in the tycon.
-}</span><span>
</span><span id="line-2342"></span><span>
</span><span id="line-2343"></span><span class="hs-comment">------------------------------</span><span>
</span><span id="line-2344"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyClass"><span class="hs-identifier hs-type">reifyClass</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Class.html#Class"><span class="hs-identifier hs-type">Class</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Info</span></span><span>
</span><span id="line-2345"></span><span id="reifyClass"><span class="annot"><span class="annottext">reifyClass :: Class -&gt; TcM Info
</span><a href="GHC.Tc.Gen.Splice.html#reifyClass"><span class="hs-identifier hs-var hs-var">reifyClass</span></a></span></span><span> </span><span id="local-6989586621683161284"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683161284"><span class="hs-identifier hs-var">cls</span></a></span></span><span>
</span><span id="line-2346"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683161285"><span class="annot"><a href="#local-6989586621683161285"><span class="hs-identifier hs-var">cxt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; TcM [Type]
</span><a href="GHC.Tc.Gen.Splice.html#reifyCxt"><span class="hs-identifier hs-var">reifyCxt</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161286"><span class="hs-identifier hs-var">theta</span></a></span><span>
</span><span id="line-2347"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161287"><span class="annot"><a href="#local-6989586621683161287"><span class="hs-identifier hs-var">inst_envs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Env.html#tcGetInstEnvs"><span class="hs-identifier hs-type">tcGetInstEnvs</span></a></span><span>
</span><span id="line-2348"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161288"><span class="annot"><a href="#local-6989586621683161288"><span class="hs-identifier hs-var">insts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyClassInstances"><span class="hs-identifier hs-type">reifyClassInstances</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161284"><span class="hs-identifier hs-type">cls</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.InstEnv.html#classInstances"><span class="hs-identifier hs-type">InstEnv.classInstances</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161287"><span class="hs-identifier hs-type">inst_envs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161284"><span class="hs-identifier hs-type">cls</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2349"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161290"><span class="annot"><a href="#local-6989586621683161290"><span class="hs-identifier hs-var">assocTys</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Utils.Monad.html#concatMapM"><span class="hs-identifier hs-type">concatMapM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161292"><span class="hs-identifier hs-type">reifyAT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161293"><span class="hs-identifier hs-type">ats</span></a></span><span>
</span><span id="line-2350"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161294"><span class="annot"><a href="#local-6989586621683161294"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Utils.Monad.html#concatMapM"><span class="hs-identifier hs-type">concatMapM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161295"><span class="hs-identifier hs-type">reify_op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161296"><span class="hs-identifier hs-type">op_stuff</span></a></span><span>
</span><span id="line-2351"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161297"><span class="annot"><a href="#local-6989586621683161297"><span class="hs-identifier hs-var">tvs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyTyConBinders"><span class="hs-identifier hs-type">reifyTyConBinders</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Class.html#classTyCon"><span class="hs-identifier hs-var">classTyCon</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161284"><span class="hs-identifier hs-type">cls</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2352"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683161299"><span class="annot"><a href="#local-6989586621683161299"><span class="hs-identifier hs-var hs-var">dec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; Name -&gt; [TyVarBndr BndrVis] -&gt; [FunDep] -&gt; [Dec] -&gt; Dec
</span><span class="hs-identifier hs-var">TH.ClassD</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161285"><span class="hs-identifier hs-var">cxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Class -&gt; Name
forall n. NamedThing n =&gt; n -&gt; Name
</span><a href="GHC.Tc.Gen.Splice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683161284"><span class="hs-identifier hs-var">cls</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TyVarBndr BndrVis]
</span><a href="#local-6989586621683161297"><span class="hs-identifier hs-var">tvs'</span></a></span><span> </span><span class="annot"><span class="annottext">[FunDep]
</span><a href="#local-6989586621683161301"><span class="hs-identifier hs-var">fds'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621683161290"><span class="hs-identifier hs-var">assocTys</span></a></span><span> </span><span class="annot"><span class="annottext">[Dec] -&gt; [Dec] -&gt; [Dec]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621683161294"><span class="hs-identifier hs-var">ops</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2353"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.ClassI</span></span><span> </span><span class="annot"><a href="#local-6989586621683161299"><span class="hs-identifier hs-type">dec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161288"><span class="hs-identifier hs-type">insts</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2354"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2355"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TyVar]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161303"><span class="annot"><span class="annottext">[FunDep TyVar]
</span><a href="#local-6989586621683161303"><span class="hs-identifier hs-var">fds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161286"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161286"><span class="hs-identifier hs-var">theta</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161293"><span class="annot"><span class="annottext">[ClassATItem]
</span><a href="#local-6989586621683161293"><span class="hs-identifier hs-var">ats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161296"><span class="annot"><span class="annottext">[(TyVar, Maybe (Name, DefMethSpec Type))]
</span><a href="#local-6989586621683161296"><span class="hs-identifier hs-var">op_stuff</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Class
-&gt; ([TyVar], [FunDep TyVar], [Type], [TyVar], [ClassATItem],
    [(TyVar, Maybe (Name, DefMethSpec Type))])
</span><a href="GHC.Core.Class.html#classExtraBigSig"><span class="hs-identifier hs-var">classExtraBigSig</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683161284"><span class="hs-identifier hs-var">cls</span></a></span><span>
</span><span id="line-2356"></span><span>    </span><span id="local-6989586621683161301"><span class="annot"><span class="annottext">fds' :: [FunDep]
</span><a href="#local-6989586621683161301"><span class="hs-identifier hs-var hs-var">fds'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FunDep TyVar -&gt; FunDep) -&gt; [FunDep TyVar] -&gt; [FunDep]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">FunDep TyVar -&gt; FunDep
</span><a href="GHC.Tc.Gen.Splice.html#reifyFunDep"><span class="hs-identifier hs-var">reifyFunDep</span></a></span><span> </span><span class="annot"><span class="annottext">[FunDep TyVar]
</span><a href="#local-6989586621683161303"><span class="hs-identifier hs-var">fds</span></a></span><span>
</span><span id="line-2357"></span><span>    </span><span id="local-6989586621683161295"><span class="annot"><span class="annottext">reify_op :: (TyVar, Maybe (a, DefMethSpec Type)) -&gt; TcM [Dec]
</span><a href="#local-6989586621683161295"><span class="hs-identifier hs-var hs-var">reify_op</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683161311"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621683161311"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161312"><span class="annot"><span class="annottext">Maybe (a, DefMethSpec Type)
</span><a href="#local-6989586621683161312"><span class="hs-identifier hs-var">def_meth</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2358"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TyVar]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161313"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161313"><span class="hs-identifier hs-var hs-var">ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; ([TyVar], Type, Type)
</span><a href="GHC.Tc.Utils.TcType.html#tcSplitMethodTy"><span class="hs-identifier hs-var">tcSplitMethodTy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621683161311"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2359"></span><span>               </span><span class="hs-comment">-- Use tcSplitMethodTy to get rid of the extraneous class</span><span>
</span><span id="line-2360"></span><span>               </span><span class="hs-comment">-- variables and predicates at the beginning of op's type</span><span>
</span><span id="line-2361"></span><span>               </span><span class="hs-comment">-- (see #15551).</span><span>
</span><span id="line-2362"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161315"><span class="annot"><a href="#local-6989586621683161315"><span class="hs-identifier hs-var">ty'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161313"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2363"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683161316"><span class="annot"><a href="#local-6989586621683161316"><span class="hs-identifier hs-var hs-var">nm'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Name
forall n. NamedThing n =&gt; n -&gt; Name
</span><a href="GHC.Tc.Gen.Splice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621683161311"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-2364"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683161312"><span class="hs-identifier hs-type">def_meth</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2365"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#GenericDM"><span class="hs-identifier hs-type">GenericDM</span></a></span><span> </span><span id="local-6989586621683161318"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161318"><span class="hs-identifier hs-var">gdm_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2366"></span><span>                  </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683161319"><span class="annot"><a href="#local-6989586621683161319"><span class="hs-identifier hs-var">gdm_ty'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161318"><span class="hs-identifier hs-var">gdm_ty</span></a></span><span>
</span><span id="line-2367"></span><span>                     </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">TH.SigD</span></span><span> </span><span class="annot"><a href="#local-6989586621683161316"><span class="hs-identifier hs-type">nm'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161315"><span class="hs-identifier hs-type">ty'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.DefaultSigD</span></span><span> </span><span class="annot"><a href="#local-6989586621683161316"><span class="hs-identifier hs-type">nm'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161319"><span class="hs-identifier hs-type">gdm_ty'</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2368"></span><span>                </span><span class="annot"><span class="annottext">Maybe (a, DefMethSpec Type)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Dec] -&gt; TcM [Dec]
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Name -&gt; Type -&gt; Dec
</span><span class="hs-identifier hs-var">TH.SigD</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161316"><span class="hs-identifier hs-var">nm'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161315"><span class="hs-identifier hs-var">ty'</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2369"></span><span>
</span><span id="line-2370"></span><span>    </span><span class="annot"><a href="#local-6989586621683161292"><span class="hs-identifier hs-type">reifyAT</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Class.html#ClassATItem"><span class="hs-identifier hs-type">ClassATItem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">TH.Dec</span></span><span class="hs-special">]</span><span>
</span><span id="line-2371"></span><span>    </span><span id="local-6989586621683161292"><span class="annot"><span class="annottext">reifyAT :: ClassATItem -&gt; TcM [Dec]
</span><a href="#local-6989586621683161292"><span class="hs-identifier hs-var hs-var">reifyAT</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Class.html#ATI"><span class="hs-identifier hs-type">ATI</span></a></span><span> </span><span id="local-6989586621683161323"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161323"><span class="hs-identifier hs-var">tycon</span></a></span></span><span> </span><span id="local-6989586621683161324"><span class="annot"><span class="annottext">Maybe (Type, TyFamEqnValidityInfo)
</span><a href="#local-6989586621683161324"><span class="hs-identifier hs-var">def</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2372"></span><span>      </span><span id="local-6989586621683161325"><span class="annot"><a href="#local-6989586621683161325"><span class="hs-identifier hs-var">tycon'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; TcM Info
</span><a href="GHC.Tc.Gen.Splice.html#reifyTyCon"><span class="hs-identifier hs-var">reifyTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161323"><span class="hs-identifier hs-var">tycon</span></a></span><span>
</span><span id="line-2373"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683161325"><span class="hs-identifier hs-type">tycon'</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2374"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">TH.FamilyI</span></span><span> </span><span id="local-6989586621683161326"><span class="annot"><span class="annottext">Dec
</span><a href="#local-6989586621683161326"><span class="hs-identifier hs-var">dec</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Dec]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2375"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683161327"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161327"><span class="hs-identifier hs-var">tyName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161328"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621683161328"><span class="hs-identifier hs-var">tyArgs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Dec -&gt; (Name, [Name])
</span><a href="#local-6989586621683161329"><span class="hs-identifier hs-var">tfNames</span></a></span><span> </span><span class="annot"><span class="annottext">Dec
</span><a href="#local-6989586621683161326"><span class="hs-identifier hs-var">dec</span></a></span><span>
</span><span id="line-2376"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Dec
</span><a href="#local-6989586621683161326"><span class="hs-identifier hs-var">dec</span></a></span><span> </span><span class="annot"><span class="annottext">Dec -&gt; [Dec] -&gt; [Dec]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Dec] -&gt; [Dec]) -&gt; TcM [Dec] -&gt; TcM [Dec]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TcM [Dec]
-&gt; ((Type, TyFamEqnValidityInfo) -&gt; TcM [Dec])
-&gt; Maybe (Type, TyFamEqnValidityInfo)
-&gt; TcM [Dec]
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Dec] -&gt; TcM [Dec]
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2377"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Dec -&gt; [Dec]) -&gt; IOEnv (Env TcGblEnv TcLclEnv) Dec -&gt; TcM [Dec]
forall a b.
(a -&gt; b)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) a
-&gt; IOEnv (Env TcGblEnv TcLclEnv) b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Dec -&gt; [Dec] -&gt; [Dec]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IOEnv (Env TcGblEnv TcLclEnv) Dec -&gt; TcM [Dec])
-&gt; ((Type, TyFamEqnValidityInfo)
    -&gt; IOEnv (Env TcGblEnv TcLclEnv) Dec)
-&gt; (Type, TyFamEqnValidityInfo)
-&gt; TcM [Dec]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; [Name] -&gt; Type -&gt; IOEnv (Env TcGblEnv TcLclEnv) Dec
</span><a href="#local-6989586621683161331"><span class="hs-identifier hs-var">reifyDefImpl</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161327"><span class="hs-identifier hs-var">tyName</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621683161328"><span class="hs-identifier hs-var">tyArgs</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; IOEnv (Env TcGblEnv TcLclEnv) Dec)
-&gt; ((Type, TyFamEqnValidityInfo) -&gt; Type)
-&gt; (Type, TyFamEqnValidityInfo)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) Dec
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Type, TyFamEqnValidityInfo) -&gt; Type
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span>
</span><span id="line-2378"></span><span>                            </span><span class="annot"><span class="annottext">Maybe (Type, TyFamEqnValidityInfo)
</span><a href="#local-6989586621683161324"><span class="hs-identifier hs-var">def</span></a></span><span>
</span><span id="line-2379"></span><span>        </span><span class="annot"><span class="annottext">Info
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM [Dec]
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;reifyAT&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Info -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Info
</span><a href="#local-6989586621683161325"><span class="hs-identifier hs-var">tycon'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2380"></span><span>
</span><span id="line-2381"></span><span>    </span><span class="annot"><a href="#local-6989586621683161331"><span class="hs-identifier hs-type">reifyDefImpl</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">TH.Name</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Dec</span></span><span>
</span><span id="line-2382"></span><span>    </span><span id="local-6989586621683161331"><span class="annot"><span class="annottext">reifyDefImpl :: Name -&gt; [Name] -&gt; Type -&gt; IOEnv (Env TcGblEnv TcLclEnv) Dec
</span><a href="#local-6989586621683161331"><span class="hs-identifier hs-var hs-var">reifyDefImpl</span></a></span></span><span> </span><span id="local-6989586621683161332"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161332"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621683161333"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621683161333"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621683161334"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161334"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2383"></span><span>      </span><span class="annot"><span class="annottext">TySynEqn -&gt; Dec
</span><span class="hs-identifier hs-var">TH.TySynInstD</span></span><span> </span><span class="annot"><span class="annottext">(TySynEqn -&gt; Dec) -&gt; (Type -&gt; TySynEqn) -&gt; Type -&gt; Dec
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Maybe [TyVarBndr ()] -&gt; Type -&gt; Type -&gt; TySynEqn
</span><span class="hs-identifier hs-var">TH.TySynEqn</span></span><span> </span><span class="annot"><span class="annottext">Maybe [TyVarBndr ()]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; [Type] -&gt; Type
</span><a href="GHC.Tc.Gen.Splice.html#mkThAppTs"><span class="hs-identifier hs-var">mkThAppTs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Type
</span><span class="hs-identifier hs-var">TH.ConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161332"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; Type) -&gt; [Name] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Type
</span><span class="hs-identifier hs-var">TH.VarT</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621683161333"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2384"></span><span>                                  </span><span class="annot"><span class="annottext">(Type -&gt; Dec) -&gt; TcM Type -&gt; IOEnv (Env TcGblEnv TcLclEnv) Dec
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161334"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2385"></span><span>
</span><span id="line-2386"></span><span>    </span><span class="annot"><a href="#local-6989586621683161329"><span class="hs-identifier hs-type">tfNames</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Dec</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.Name</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">TH.Name</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2387"></span><span>    </span><span id="local-6989586621683161329"><span class="annot"><span class="annottext">tfNames :: Dec -&gt; (Name, [Name])
</span><a href="#local-6989586621683161329"><span class="hs-identifier hs-var hs-var">tfNames</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.OpenTypeFamilyD</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.TypeFamilyHead</span></span><span> </span><span id="local-6989586621683161336"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161336"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621683161337"><span class="annot"><span class="annottext">[TyVarBndr BndrVis]
</span><a href="#local-6989586621683161337"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="annot"><span class="annottext">FamilyResultSig
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe InjectivityAnn
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2388"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161336"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(TyVarBndr BndrVis -&gt; Name) -&gt; [TyVarBndr BndrVis] -&gt; [Name]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TyVarBndr BndrVis -&gt; Name
forall flag. TyVarBndr flag -&gt; Name
</span><a href="#local-6989586621683161338"><span class="hs-identifier hs-var">bndrName</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVarBndr BndrVis]
</span><a href="#local-6989586621683161337"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2389"></span><span>    </span><span class="annot"><a href="#local-6989586621683161329"><span class="hs-identifier hs-var">tfNames</span></a></span><span> </span><span id="local-6989586621683161339"><span class="annot"><span class="annottext">Dec
</span><a href="#local-6989586621683161339"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; (Name, [Name])
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tfNames&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Dec -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Dec
</span><a href="#local-6989586621683161339"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2390"></span><span>
</span><span id="line-2391"></span><span>    </span><span id="local-6989586621683158788"><span class="annot"><a href="#local-6989586621683161338"><span class="hs-identifier hs-type">bndrName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.TyVarBndr</span></span><span> </span><span class="annot"><a href="#local-6989586621683158788"><span class="hs-identifier hs-type">flag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Name</span></span></span><span>
</span><span id="line-2392"></span><span>    </span><span id="local-6989586621683161338"><span class="annot"><span class="annottext">bndrName :: forall flag. TyVarBndr flag -&gt; Name
</span><a href="#local-6989586621683161338"><span class="hs-identifier hs-var hs-var">bndrName</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.PlainTV</span></span><span> </span><span id="local-6989586621683161341"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161341"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><span class="annottext">flag
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161341"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-2393"></span><span>    </span><span class="annot"><a href="#local-6989586621683161338"><span class="hs-identifier hs-var">bndrName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.KindedTV</span></span><span> </span><span id="local-6989586621683161342"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161342"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><span class="annottext">flag
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161342"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-2394"></span><span>
</span><span id="line-2395"></span><span class="hs-comment">------------------------------</span><span>
</span><span id="line-2396"></span><span class="hs-comment">-- | Annotate (with TH.SigT) a type if the first parameter is True</span><span>
</span><span id="line-2397"></span><span class="hs-comment">-- and if the type contains a free variable.</span><span>
</span><span id="line-2398"></span><span class="hs-comment">-- This is used to annotate type patterns for poly-kinded tyvars in</span><span>
</span><span id="line-2399"></span><span class="hs-comment">-- reifying class and type instances.</span><span>
</span><span id="line-2400"></span><span class="hs-comment">-- See @Note [Reified instances and explicit kind signatures]@.</span><span>
</span><span id="line-2401"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#annotThType"><span class="hs-identifier hs-type">annotThType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>   </span><span class="hs-comment">-- True &lt;=&gt; annotate</span><span>
</span><span id="line-2402"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">TyCoRep.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Type</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Type</span></span><span>
</span><span id="line-2403"></span><span>  </span><span class="hs-comment">-- tiny optimization: if the type is annotated, don't annotate again.</span><span>
</span><span id="line-2404"></span><span id="annotThType"><span class="annot"><span class="annottext">annotThType :: Bool -&gt; Type -&gt; Type -&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#annotThType"><span class="hs-identifier hs-var hs-var">annotThType</span></a></span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span>    </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span>  </span><span id="local-6989586621683161343"><span class="annot"><span class="annottext">th_ty :: Type
</span><a href="#local-6989586621683161343"><span class="hs-identifier hs-var">th_ty</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.SigT</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcM Type
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161343"><span class="hs-identifier hs-var">th_ty</span></a></span><span>
</span><span id="line-2405"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#annotThType"><span class="hs-identifier hs-var">annotThType</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span id="local-6989586621683161344"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161344"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621683161345"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161345"><span class="hs-identifier hs-var">th_ty</span></a></span></span><span>
</span><span id="line-2406"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#isEmptyVarSet"><span class="hs-identifier hs-var">isEmptyVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">(VarSet -&gt; Bool) -&gt; VarSet -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TyVar -&gt; Bool) -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#filterVarSet"><span class="hs-identifier hs-var">filterVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">(VarSet -&gt; VarSet) -&gt; VarSet -&gt; VarSet
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161344"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2407"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683161349"><span class="annot"><span class="annottext">ki :: Type
</span><a href="#local-6989586621683161349"><span class="hs-identifier hs-var hs-var hs-var">ki</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Type
Type -&gt; Type
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161344"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2408"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161350"><span class="annot"><a href="#local-6989586621683161350"><span class="hs-identifier hs-var">th_ki</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#reifyKind"><span class="hs-identifier hs-var">reifyKind</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161349"><span class="hs-identifier hs-var">ki</span></a></span><span>
</span><span id="line-2409"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.SigT</span></span><span> </span><span class="annot"><a href="#local-6989586621683161345"><span class="hs-identifier hs-type">th_ty</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161350"><span class="hs-identifier hs-type">th_ki</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2410"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#annotThType"><span class="hs-identifier hs-var">annotThType</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span>    </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683161351"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161351"><span class="hs-identifier hs-var">th_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcM Type
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161351"><span class="hs-identifier hs-var">th_ty</span></a></span><span>
</span><span id="line-2411"></span><span>
</span><span id="line-2412"></span><span class="hs-comment">-- | For every argument type that a type constructor accepts,</span><span>
</span><span id="line-2413"></span><span class="hs-comment">-- report whether or not the argument is poly-kinded. This is used to</span><span>
</span><span id="line-2414"></span><span class="hs-comment">-- eventually feed into 'annotThType'.</span><span>
</span><span id="line-2415"></span><span class="hs-comment">-- See @Note [Reified instances and explicit kind signatures]@.</span><span>
</span><span id="line-2416"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#tyConArgsPolyKinded"><span class="hs-identifier hs-type">tyConArgsPolyKinded</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">]</span><span>
</span><span id="line-2417"></span><span id="tyConArgsPolyKinded"><span class="annot"><span class="annottext">tyConArgsPolyKinded :: TyCon -&gt; [Bool]
</span><a href="GHC.Tc.Gen.Splice.html#tyConArgsPolyKinded"><span class="hs-identifier hs-var hs-var">tyConArgsPolyKinded</span></a></span></span><span> </span><span id="local-6989586621683161352"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161352"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2418"></span><span>     </span><span class="annot"><span class="annottext">(TyVar -&gt; Bool) -&gt; [TyVar] -&gt; [Bool]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="#local-6989586621683161353"><span class="hs-identifier hs-var">is_poly_ty</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Bool) -&gt; (TyVar -&gt; Type) -&gt; TyVar -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Type
</span><a href="GHC.Types.Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a></span><span class="hs-special">)</span><span>      </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621683161355"><span class="hs-identifier hs-var">tc_vis_tvs</span></a></span><span>
</span><span id="line-2419"></span><span>     </span><span class="hs-comment">-- See &quot;Wrinkle: Oversaturated data family instances&quot; in</span><span>
</span><span id="line-2420"></span><span>     </span><span class="hs-comment">-- @Note [Reified instances and explicit kind signatures]@</span><span>
</span><span id="line-2421"></span><span>  </span><span class="annot"><span class="annottext">[Bool] -&gt; [Bool] -&gt; [Bool]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(PiTyBinder -&gt; Bool) -&gt; [PiTyBinder] -&gt; [Bool]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="#local-6989586621683161353"><span class="hs-identifier hs-var">is_poly_ty</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Bool) -&gt; (PiTyBinder -&gt; Type) -&gt; PiTyBinder -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PiTyBinder -&gt; Type
</span><a href="GHC.Types.Var.html#piTyBinderType"><span class="hs-identifier hs-var">piTyBinderType</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[PiTyBinder]
</span><a href="#local-6989586621683161357"><span class="hs-identifier hs-var">tc_res_kind_vis_bndrs</span></a></span><span> </span><span class="hs-comment">-- (1) in Wrinkle</span><span>
</span><span id="line-2422"></span><span>  </span><span class="annot"><span class="annottext">[Bool] -&gt; [Bool] -&gt; [Bool]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; [Bool]
forall a. a -&gt; [a]
</span><span class="hs-identifier hs-var">repeat</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>                                             </span><span class="hs-comment">-- (2) in Wrinkle</span><span>
</span><span id="line-2423"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2424"></span><span>    </span><span class="annot"><a href="#local-6989586621683161353"><span class="hs-identifier hs-type">is_poly_ty</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-2425"></span><span>    </span><span id="local-6989586621683161353"><span class="annot"><span class="annottext">is_poly_ty :: Type -&gt; Bool
</span><a href="#local-6989586621683161353"><span class="hs-identifier hs-var hs-var">is_poly_ty</span></a></span></span><span> </span><span id="local-6989586621683161359"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161359"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2426"></span><span>                    </span><span class="annot"><span class="annottext">VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#isEmptyVarSet"><span class="hs-identifier hs-var">isEmptyVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">(VarSet -&gt; Bool) -&gt; VarSet -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2427"></span><span>                    </span><span class="annot"><span class="annottext">(TyVar -&gt; Bool) -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#filterVarSet"><span class="hs-identifier hs-var">filterVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">(VarSet -&gt; VarSet) -&gt; VarSet -&gt; VarSet
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2428"></span><span>                    </span><span class="annot"><span class="annottext">Type -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161359"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2429"></span><span>
</span><span id="line-2430"></span><span>    </span><span class="annot"><a href="#local-6989586621683161355"><span class="hs-identifier hs-type">tc_vis_tvs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2431"></span><span>    </span><span id="local-6989586621683161355"><span class="annot"><span class="annottext">tc_vis_tvs :: [TyVar]
</span><a href="#local-6989586621683161355"><span class="hs-identifier hs-var hs-var">tc_vis_tvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [TyVar]
</span><a href="GHC.Core.TyCon.html#tyConVisibleTyVars"><span class="hs-identifier hs-var">tyConVisibleTyVars</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161352"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-2432"></span><span>
</span><span id="line-2433"></span><span>    </span><span class="annot"><a href="#local-6989586621683161357"><span class="hs-identifier hs-type">tc_res_kind_vis_bndrs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#PiTyBinder"><span class="hs-identifier hs-type">PiTyBinder</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2434"></span><span>    </span><span id="local-6989586621683161357"><span class="annot"><span class="annottext">tc_res_kind_vis_bndrs :: [PiTyBinder]
</span><a href="#local-6989586621683161357"><span class="hs-identifier hs-var hs-var">tc_res_kind_vis_bndrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PiTyBinder -&gt; Bool) -&gt; [PiTyBinder] -&gt; [PiTyBinder]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="annot"><span class="annottext">PiTyBinder -&gt; Bool
</span><a href="GHC.Types.Var.html#isVisiblePiTyBinder"><span class="hs-identifier hs-var">isVisiblePiTyBinder</span></a></span><span> </span><span class="annot"><span class="annottext">([PiTyBinder] -&gt; [PiTyBinder]) -&gt; [PiTyBinder] -&gt; [PiTyBinder]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">([PiTyBinder], Type) -&gt; [PiTyBinder]
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">(([PiTyBinder], Type) -&gt; [PiTyBinder])
-&gt; ([PiTyBinder], Type) -&gt; [PiTyBinder]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; ([PiTyBinder], Type)
</span><a href="GHC.Core.Type.html#splitPiTys"><span class="hs-identifier hs-var">splitPiTys</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; ([PiTyBinder], Type)) -&gt; Type -&gt; ([PiTyBinder], Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Type
</span><a href="GHC.Core.TyCon.html#tyConResKind"><span class="hs-identifier hs-var">tyConResKind</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161352"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-2435"></span><span>
</span><span id="line-2436"></span><span class="hs-comment">{-
Note [Reified instances and explicit kind signatures]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Reified class instances and type family instances often include extra kind
information to disambiguate instances. Here is one such example that
illustrates this (#8953):

    type family Poly (a :: k) :: Type
    type instance Poly (x :: Bool)    = Int
    type instance Poly (x :: Maybe k) = Double

If you're not careful, reifying these instances might yield this:

    type instance Poly x = Int
    type instance Poly x = Double

To avoid this, we go through some care to annotate things with extra kind
information. Some functions which accomplish this feat include:

* annotThType: This annotates a type with a kind signature if the type contains
  a free variable.
* tyConArgsPolyKinded: This checks every argument that a type constructor can
  accept and reports if the type of the argument is poly-kinded. This
  information is ultimately fed into annotThType.

-----
-- Wrinkle: Oversaturated data family instances
-----

What constitutes an argument to a type constructor in the definition of
tyConArgsPolyKinded? For most type constructors, it's simply the visible
type variable binders (i.e., tyConVisibleTyVars). There is one corner case
we must keep in mind, however: data family instances can appear oversaturated
(#17296). For instance:

    data family   Foo :: Type -&gt; Type
    data instance Foo x

    data family Bar :: k
    data family Bar x

For these sorts of data family instances, tyConVisibleTyVars isn't enough,
as they won't give you the kinds of the oversaturated arguments. We must
also consult:

1. The kinds of the arguments in the result kind (i.e., the tyConResKind).
   This will tell us, e.g., the kind of `x` in `Foo x` above.
2. If we go beyond the number of arguments in the result kind (like the
   `x` in `Bar x`), then we conservatively assume that the argument's
   kind is poly-kinded.

-----
-- Wrinkle: data family instances with return kinds
-----

Another squirrelly corner case is this:

    data family Foo (a :: k)
    data instance Foo :: Bool -&gt; Type
    data instance Foo :: Char -&gt; Type

If you're not careful, reifying these instances might yield this:

    data instance Foo
    data instance Foo

We can fix this ambiguity by reifying the instances' explicit return kinds. We
should only do this if necessary (see
Note [When does a tycon application need an explicit kind signature?] in GHC.Core.Type),
but more importantly, we *only* do this if either of the following are true:

1. The data family instance has no constructors.
2. The data family instance is declared with GADT syntax.

If neither of these are true, then reifying the return kind would yield
something like this:

    data instance (Bar a :: Type) = MkBar a

Which is not valid syntax.
-}</span><span>
</span><span id="line-2517"></span><span>
</span><span id="line-2518"></span><span class="hs-comment">------------------------------</span><span>
</span><span id="line-2519"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyClassInstances"><span class="hs-identifier hs-type">reifyClassInstances</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Class.html#Class"><span class="hs-identifier hs-type">Class</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.InstEnv.html#ClsInst"><span class="hs-identifier hs-type">ClsInst</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">TH.Dec</span></span><span class="hs-special">]</span><span>
</span><span id="line-2520"></span><span id="reifyClassInstances"><span class="annot"><span class="annottext">reifyClassInstances :: Class -&gt; [ClsInst] -&gt; TcM [Dec]
</span><a href="GHC.Tc.Gen.Splice.html#reifyClassInstances"><span class="hs-identifier hs-var hs-var">reifyClassInstances</span></a></span></span><span> </span><span id="local-6989586621683161362"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683161362"><span class="hs-identifier hs-var">cls</span></a></span></span><span> </span><span id="local-6989586621683161363"><span class="annot"><span class="annottext">[ClsInst]
</span><a href="#local-6989586621683161363"><span class="hs-identifier hs-var">insts</span></a></span></span><span>
</span><span id="line-2521"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ClsInst -&gt; IOEnv (Env TcGblEnv TcLclEnv) Dec)
-&gt; [ClsInst] -&gt; TcM [Dec]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Bool] -&gt; ClsInst -&gt; IOEnv (Env TcGblEnv TcLclEnv) Dec
</span><a href="GHC.Tc.Gen.Splice.html#reifyClassInstance"><span class="hs-identifier hs-var">reifyClassInstance</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [Bool]
</span><a href="GHC.Tc.Gen.Splice.html#tyConArgsPolyKinded"><span class="hs-identifier hs-var">tyConArgsPolyKinded</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Class -&gt; TyCon
</span><a href="GHC.Core.Class.html#classTyCon"><span class="hs-identifier hs-var">classTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683161362"><span class="hs-identifier hs-var">cls</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ClsInst]
</span><a href="#local-6989586621683161363"><span class="hs-identifier hs-var">insts</span></a></span><span>
</span><span id="line-2522"></span><span>
</span><span id="line-2523"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyClassInstance"><span class="hs-identifier hs-type">reifyClassInstance</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- True &lt;=&gt; the corresponding tv is poly-kinded</span><span>
</span><span id="line-2524"></span><span>                              </span><span class="hs-comment">-- includes only *visible* tvs</span><span>
</span><span id="line-2525"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.InstEnv.html#ClsInst"><span class="hs-identifier hs-type">ClsInst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Dec</span></span><span>
</span><span id="line-2526"></span><span id="reifyClassInstance"><span class="annot"><span class="annottext">reifyClassInstance :: [Bool] -&gt; ClsInst -&gt; IOEnv (Env TcGblEnv TcLclEnv) Dec
</span><a href="GHC.Tc.Gen.Splice.html#reifyClassInstance"><span class="hs-identifier hs-var hs-var">reifyClassInstance</span></a></span></span><span> </span><span id="local-6989586621683161365"><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621683161365"><span class="hs-identifier hs-var">is_poly_tvs</span></a></span></span><span> </span><span id="local-6989586621683161366"><span class="annot"><span class="annottext">ClsInst
</span><a href="#local-6989586621683161366"><span class="hs-identifier hs-var">i</span></a></span></span><span>
</span><span id="line-2527"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683161367"><span class="annot"><a href="#local-6989586621683161367"><span class="hs-identifier hs-var">cxt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; TcM [Type]
</span><a href="GHC.Tc.Gen.Splice.html#reifyCxt"><span class="hs-identifier hs-var">reifyCxt</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161368"><span class="hs-identifier hs-var">theta</span></a></span><span>
</span><span id="line-2528"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683161369"><span class="annot"><a href="#local-6989586621683161369"><span class="hs-identifier hs-var hs-var">vis_types</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; [Type]
</span><a href="GHC.Core.Type.html#filterOutInvisibleTypes"><span class="hs-identifier hs-var">filterOutInvisibleTypes</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161370"><span class="hs-identifier hs-var">cls_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161371"><span class="hs-identifier hs-var">types</span></a></span><span>
</span><span id="line-2529"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161372"><span class="annot"><a href="#local-6989586621683161372"><span class="hs-identifier hs-var">thtypes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyTypes"><span class="hs-identifier hs-type">reifyTypes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161369"><span class="hs-identifier hs-type">vis_types</span></a></span><span>
</span><span id="line-2530"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161373"><span class="annot"><a href="#local-6989586621683161373"><span class="hs-identifier hs-var">annot_thtypes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Utils.Monad.html#zipWith3M"><span class="hs-identifier hs-type">zipWith3M</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#annotThType"><span class="hs-identifier hs-type">annotThType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161365"><span class="hs-identifier hs-type">is_poly_tvs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161369"><span class="hs-identifier hs-type">vis_types</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161372"><span class="hs-identifier hs-type">thtypes</span></a></span><span>
</span><span id="line-2531"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683161374"><span class="annot"><a href="#local-6989586621683161374"><span class="hs-identifier hs-var hs-var">head_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; [Type] -&gt; Type
</span><a href="GHC.Tc.Gen.Splice.html#mkThAppTs"><span class="hs-identifier hs-var">mkThAppTs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Type
</span><span class="hs-identifier hs-var">TH.ConT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Class -&gt; Name
forall n. NamedThing n =&gt; n -&gt; Name
</span><a href="GHC.Tc.Gen.Splice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683161375"><span class="hs-identifier hs-var">cls</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161373"><span class="hs-identifier hs-var">annot_thtypes</span></a></span><span>
</span><span id="line-2532"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.InstanceD</span></span><span> </span><span class="annot"><a href="#local-6989586621683161377"><span class="hs-identifier hs-type">over</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161367"><span class="hs-identifier hs-type">cxt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161374"><span class="hs-identifier hs-type">head_ty</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2533"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2534"></span><span>     </span><span class="hs-special">(</span><span id="local-6989586621683161378"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621683161378"><span class="hs-identifier hs-var">_tvs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161368"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161368"><span class="hs-identifier hs-var">theta</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161375"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683161375"><span class="hs-identifier hs-var">cls</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161371"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161371"><span class="hs-identifier hs-var">types</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; ([TyVar], [Type], Class, [Type])
</span><a href="GHC.Tc.Utils.TcType.html#tcSplitDFunTy"><span class="hs-identifier hs-var">tcSplitDFunTy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621683161380"><span class="hs-identifier hs-var">dfun</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2535"></span><span>     </span><span id="local-6989586621683161370"><span class="annot"><span class="annottext">cls_tc :: TyCon
</span><a href="#local-6989586621683161370"><span class="hs-identifier hs-var hs-var">cls_tc</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Class -&gt; TyCon
</span><a href="GHC.Core.Class.html#classTyCon"><span class="hs-identifier hs-var">classTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683161375"><span class="hs-identifier hs-var">cls</span></a></span><span>
</span><span id="line-2536"></span><span>     </span><span id="local-6989586621683161380"><span class="annot"><span class="annottext">dfun :: TyVar
</span><a href="#local-6989586621683161380"><span class="hs-identifier hs-var hs-var">dfun</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ClsInst -&gt; TyVar
</span><a href="GHC.Core.InstEnv.html#instanceDFunId"><span class="hs-identifier hs-var">instanceDFunId</span></a></span><span> </span><span class="annot"><span class="annottext">ClsInst
</span><a href="#local-6989586621683161366"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-2537"></span><span>     </span><span id="local-6989586621683161377"><span class="annot"><span class="annottext">over :: Maybe Overlap
</span><a href="#local-6989586621683161377"><span class="hs-identifier hs-var hs-var">over</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">OverlapFlag -&gt; OverlapMode
</span><a href="GHC.Types.Basic.html#overlapMode"><span class="hs-identifier hs-var">overlapMode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClsInst -&gt; OverlapFlag
</span><a href="GHC.Core.InstEnv.html#is_flag"><span class="hs-identifier hs-var">is_flag</span></a></span><span> </span><span class="annot"><span class="annottext">ClsInst
</span><a href="#local-6989586621683161366"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2538"></span><span>                  </span><span class="annot"><a href="GHC.Types.Basic.html#NoOverlap"><span class="hs-identifier hs-type">NoOverlap</span></a></span><span> </span><span class="annot"><span class="annottext">SourceText
</span><span class="hs-identifier">_</span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Overlap
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-2539"></span><span>                  </span><span class="annot"><a href="GHC.Types.Basic.html#Overlappable"><span class="hs-identifier hs-type">Overlappable</span></a></span><span> </span><span class="annot"><span class="annottext">SourceText
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Overlap -&gt; Maybe Overlap
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Overlap
</span><span class="hs-identifier hs-var">TH.Overlappable</span></span><span>
</span><span id="line-2540"></span><span>                  </span><span class="annot"><a href="GHC.Types.Basic.html#Overlapping"><span class="hs-identifier hs-type">Overlapping</span></a></span><span> </span><span class="annot"><span class="annottext">SourceText
</span><span class="hs-identifier">_</span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Overlap -&gt; Maybe Overlap
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Overlap
</span><span class="hs-identifier hs-var">TH.Overlapping</span></span><span>
</span><span id="line-2541"></span><span>                  </span><span class="annot"><a href="GHC.Types.Basic.html#Overlaps"><span class="hs-identifier hs-type">Overlaps</span></a></span><span> </span><span class="annot"><span class="annottext">SourceText
</span><span class="hs-identifier">_</span></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Overlap -&gt; Maybe Overlap
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Overlap
</span><span class="hs-identifier hs-var">TH.Overlaps</span></span><span>
</span><span id="line-2542"></span><span>                  </span><span class="annot"><a href="GHC.Types.Basic.html#Incoherent"><span class="hs-identifier hs-type">Incoherent</span></a></span><span> </span><span class="annot"><span class="annottext">SourceText
</span><span class="hs-identifier">_</span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Overlap -&gt; Maybe Overlap
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Overlap
</span><span class="hs-identifier hs-var">TH.Incoherent</span></span><span>
</span><span id="line-2543"></span><span>                  </span><span class="annot"><a href="GHC.Types.Basic.html#NonCanonical"><span class="hs-identifier hs-type">NonCanonical</span></a></span><span> </span><span class="annot"><span class="annottext">SourceText
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Overlap -&gt; Maybe Overlap
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Overlap
</span><span class="hs-identifier hs-var">TH.Incoherent</span></span><span>
</span><span id="line-2544"></span><span>
</span><span id="line-2545"></span><span class="hs-comment">------------------------------</span><span>
</span><span id="line-2546"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyFamilyInstances"><span class="hs-identifier hs-type">reifyFamilyInstances</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">TH.Dec</span></span><span class="hs-special">]</span><span>
</span><span id="line-2547"></span><span id="reifyFamilyInstances"><span class="annot"><span class="annottext">reifyFamilyInstances :: TyCon -&gt; [FamInst] -&gt; TcM [Dec]
</span><a href="GHC.Tc.Gen.Splice.html#reifyFamilyInstances"><span class="hs-identifier hs-var hs-var">reifyFamilyInstances</span></a></span></span><span> </span><span id="local-6989586621683161390"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161390"><span class="hs-identifier hs-var">fam_tc</span></a></span></span><span> </span><span id="local-6989586621683161391"><span class="annot"><span class="annottext">[FamInst]
</span><a href="#local-6989586621683161391"><span class="hs-identifier hs-var">fam_insts</span></a></span></span><span>
</span><span id="line-2548"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FamInst -&gt; IOEnv (Env TcGblEnv TcLclEnv) Dec)
-&gt; [FamInst] -&gt; TcM [Dec]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Bool] -&gt; FamInst -&gt; IOEnv (Env TcGblEnv TcLclEnv) Dec
</span><a href="GHC.Tc.Gen.Splice.html#reifyFamilyInstance"><span class="hs-identifier hs-var">reifyFamilyInstance</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [Bool]
</span><a href="GHC.Tc.Gen.Splice.html#tyConArgsPolyKinded"><span class="hs-identifier hs-var">tyConArgsPolyKinded</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161390"><span class="hs-identifier hs-var">fam_tc</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[FamInst]
</span><a href="#local-6989586621683161391"><span class="hs-identifier hs-var">fam_insts</span></a></span><span>
</span><span id="line-2549"></span><span>
</span><span id="line-2550"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyFamilyInstance"><span class="hs-identifier hs-type">reifyFamilyInstance</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- True &lt;=&gt; the corresponding tv is poly-kinded</span><span>
</span><span id="line-2551"></span><span>                              </span><span class="hs-comment">-- includes only *visible* tvs</span><span>
</span><span id="line-2552"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Dec</span></span><span>
</span><span id="line-2553"></span><span id="reifyFamilyInstance"><span class="annot"><span class="annottext">reifyFamilyInstance :: [Bool] -&gt; FamInst -&gt; IOEnv (Env TcGblEnv TcLclEnv) Dec
</span><a href="GHC.Tc.Gen.Splice.html#reifyFamilyInstance"><span class="hs-identifier hs-var hs-var">reifyFamilyInstance</span></a></span></span><span> </span><span id="local-6989586621683161393"><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621683161393"><span class="hs-identifier hs-var">is_poly_tvs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fi_flavor :: FamInst -&gt; FamFlavor
</span><a href="GHC.Core.FamInstEnv.html#fi_flavor"><span class="hs-identifier hs-var">fi_flavor</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683161396"><span class="annot"><span class="annottext">FamFlavor
</span><a href="#local-6989586621683161396"><span class="hs-identifier hs-var">flavor</span></a></span></span><span>
</span><span id="line-2554"></span><span>                                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fi_axiom :: FamInst -&gt; CoAxiom Unbranched
</span><a href="GHC.Core.FamInstEnv.html#fi_axiom"><span class="hs-identifier hs-var">fi_axiom</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683161398"><span class="annot"><span class="annottext">CoAxiom Unbranched
</span><a href="#local-6989586621683161398"><span class="hs-identifier hs-var">ax</span></a></span></span><span>
</span><span id="line-2555"></span><span>                                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fi_fam :: FamInst -&gt; Name
</span><a href="GHC.Core.FamInstEnv.html#fi_fam"><span class="hs-identifier hs-var">fi_fam</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683161400"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161400"><span class="hs-identifier hs-var">fam</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2556"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683161401"><span class="annot"><span class="annottext">fam_tc :: TyCon
</span><a href="#local-6989586621683161401"><span class="hs-identifier hs-var hs-var">fam_tc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoAxiom Unbranched -&gt; TyCon
forall (br :: BranchFlag). CoAxiom br -&gt; TyCon
</span><a href="GHC.Core.Coercion.Axiom.html#coAxiomTyCon"><span class="hs-identifier hs-var">coAxiomTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiom Unbranched
</span><a href="#local-6989586621683161398"><span class="hs-identifier hs-var">ax</span></a></span><span>
</span><span id="line-2557"></span><span>        </span><span id="local-6989586621683161403"><span class="annot"><span class="annottext">branch :: CoAxBranch
</span><a href="#local-6989586621683161403"><span class="hs-identifier hs-var hs-var">branch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoAxiom Unbranched -&gt; CoAxBranch
</span><a href="GHC.Core.Coercion.Axiom.html#coAxiomSingleBranch"><span class="hs-identifier hs-var">coAxiomSingleBranch</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiom Unbranched
</span><a href="#local-6989586621683161398"><span class="hs-identifier hs-var">ax</span></a></span><span>
</span><span id="line-2558"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cab_tvs :: CoAxBranch -&gt; [TyVar]
</span><a href="GHC.Core.Coercion.Axiom.html#cab_tvs"><span class="hs-identifier hs-var">cab_tvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683161405"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621683161405"><span class="hs-identifier hs-var">tvs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cab_lhs :: CoAxBranch -&gt; [Type]
</span><a href="GHC.Core.Coercion.Axiom.html#cab_lhs"><span class="hs-identifier hs-var">cab_lhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683161406"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161406"><span class="hs-identifier hs-var">lhs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cab_rhs :: CoAxBranch -&gt; Type
</span><a href="GHC.Core.Coercion.Axiom.html#cab_rhs"><span class="hs-identifier hs-var">cab_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683161407"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161407"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621683161403"><span class="hs-identifier hs-var">branch</span></a></span><span>
</span><span id="line-2559"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">FamFlavor
</span><a href="#local-6989586621683161396"><span class="hs-identifier hs-var">flavor</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2560"></span><span>      </span><span class="annot"><span class="annottext">FamFlavor
</span><a href="GHC.Core.FamInstEnv.html#SynFamilyInst"><span class="hs-identifier hs-var">SynFamilyInst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2561"></span><span>               </span><span class="hs-comment">-- remove kind patterns (#8884)</span><span>
</span><span id="line-2562"></span><span>        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683161409"><span class="annot"><a href="#local-6989586621683161409"><span class="hs-identifier hs-var">th_tvs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; TcM (Maybe [TyVarBndr ()])
</span><a href="GHC.Tc.Gen.Splice.html#reifyTyVarsToMaybe"><span class="hs-identifier hs-var">reifyTyVarsToMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621683161405"><span class="hs-identifier hs-var">tvs</span></a></span><span>
</span><span id="line-2563"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683161410"><span class="annot"><a href="#local-6989586621683161410"><span class="hs-identifier hs-var hs-var">lhs_types_only</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; [Type]
</span><a href="GHC.Core.Type.html#filterOutInvisibleTypes"><span class="hs-identifier hs-var">filterOutInvisibleTypes</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161401"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161406"><span class="hs-identifier hs-var">lhs</span></a></span><span>
</span><span id="line-2564"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161411"><span class="annot"><a href="#local-6989586621683161411"><span class="hs-identifier hs-var">th_lhs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyTypes"><span class="hs-identifier hs-type">reifyTypes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161410"><span class="hs-identifier hs-type">lhs_types_only</span></a></span><span>
</span><span id="line-2565"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161412"><span class="annot"><a href="#local-6989586621683161412"><span class="hs-identifier hs-var">annot_th_lhs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Utils.Monad.html#zipWith3M"><span class="hs-identifier hs-type">zipWith3M</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#annotThType"><span class="hs-identifier hs-type">annotThType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161393"><span class="hs-identifier hs-type">is_poly_tvs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161410"><span class="hs-identifier hs-type">lhs_types_only</span></a></span><span>
</span><span id="line-2566"></span><span>                                                   </span><span class="annot"><a href="#local-6989586621683161411"><span class="hs-identifier hs-type">th_lhs</span></a></span><span>
</span><span id="line-2567"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683161413"><span class="annot"><a href="#local-6989586621683161413"><span class="hs-identifier hs-var hs-var">lhs_type</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; [Type] -&gt; Type
</span><a href="GHC.Tc.Gen.Splice.html#mkThAppTs"><span class="hs-identifier hs-var">mkThAppTs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Type
</span><span class="hs-identifier hs-var">TH.ConT</span></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Type) -&gt; Name -&gt; Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name
forall n. NamedThing n =&gt; n -&gt; Name
</span><a href="GHC.Tc.Gen.Splice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161400"><span class="hs-identifier hs-var">fam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161412"><span class="hs-identifier hs-var">annot_th_lhs</span></a></span><span>
</span><span id="line-2568"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161414"><span class="annot"><a href="#local-6989586621683161414"><span class="hs-identifier hs-var">th_rhs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-type">reifyType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161407"><span class="hs-identifier hs-type">rhs</span></a></span><span>
</span><span id="line-2569"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.TySynInstD</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.TySynEqn</span></span><span> </span><span class="annot"><a href="#local-6989586621683161409"><span class="hs-identifier hs-type">th_tvs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161413"><span class="hs-identifier hs-type">lhs_type</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161414"><span class="hs-identifier hs-type">th_rhs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2570"></span><span>
</span><span id="line-2571"></span><span>      </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#DataFamilyInst"><span class="hs-identifier hs-type">DataFamilyInst</span></a></span><span> </span><span id="local-6989586621683161416"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161416"><span class="hs-identifier hs-var">rep_tc</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2572"></span><span>        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- eta-expand lhs types, because sometimes data/newtype</span><span>
</span><span id="line-2573"></span><span>                 </span><span class="hs-comment">-- instances are eta-reduced; See #9692</span><span>
</span><span id="line-2574"></span><span>                 </span><span class="hs-comment">-- See Note [Eta reduction for data families] in GHC.Core.Coercion.Axiom</span><span>
</span><span id="line-2575"></span><span>                 </span><span class="hs-special">(</span><span id="local-6989586621683161417"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621683161417"><span class="hs-identifier hs-var hs-var">ee_tvs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161418"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161418"><span class="hs-identifier hs-var hs-var">ee_lhs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoAxBranch -&gt; ([TyVar], [Type], Type)
</span><a href="GHC.Core.Coercion.html#etaExpandCoAxBranch"><span class="hs-identifier hs-var">etaExpandCoAxBranch</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621683161403"><span class="hs-identifier hs-var">branch</span></a></span><span>
</span><span id="line-2576"></span><span>                 </span><span id="local-6989586621683161419"><span class="annot"><span class="annottext">fam' :: Name
</span><a href="#local-6989586621683161419"><span class="hs-identifier hs-var hs-var hs-var">fam'</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name
forall n. NamedThing n =&gt; n -&gt; Name
</span><a href="GHC.Tc.Gen.Splice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161400"><span class="hs-identifier hs-var">fam</span></a></span><span>
</span><span id="line-2577"></span><span>                 </span><span id="local-6989586621683161420"><span class="annot"><span class="annottext">dataCons :: [DataCon]
</span><a href="#local-6989586621683161420"><span class="hs-identifier hs-var hs-var hs-var">dataCons</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [DataCon]
</span><a href="GHC.Core.TyCon.html#tyConDataCons"><span class="hs-identifier hs-var">tyConDataCons</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161416"><span class="hs-identifier hs-var">rep_tc</span></a></span><span>
</span><span id="line-2578"></span><span>                 </span><span id="local-6989586621683161421"><span class="annot"><span class="annottext">isGadt :: Bool
</span><a href="#local-6989586621683161421"><span class="hs-identifier hs-var hs-var hs-var">isGadt</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isGadtSyntaxTyCon"><span class="hs-identifier hs-var">isGadtSyntaxTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161416"><span class="hs-identifier hs-var">rep_tc</span></a></span><span>
</span><span id="line-2579"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161422"><span class="annot"><a href="#local-6989586621683161422"><span class="hs-identifier hs-var">th_tvs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; TcM (Maybe [TyVarBndr ()])
</span><a href="GHC.Tc.Gen.Splice.html#reifyTyVarsToMaybe"><span class="hs-identifier hs-var">reifyTyVarsToMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621683161417"><span class="hs-identifier hs-var">ee_tvs</span></a></span><span>
</span><span id="line-2580"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161423"><span class="annot"><a href="#local-6989586621683161423"><span class="hs-identifier hs-var">cons</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyDataCon"><span class="hs-identifier hs-type">reifyDataCon</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161421"><span class="hs-identifier hs-type">isGadt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#mkTyVarTys"><span class="hs-identifier hs-type">mkTyVarTys</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161417"><span class="hs-identifier hs-type">ee_tvs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683161420"><span class="hs-identifier hs-type">dataCons</span></a></span><span>
</span><span id="line-2581"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683161424"><span class="annot"><a href="#local-6989586621683161424"><span class="hs-identifier hs-var hs-var">types_only</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; [Type]
</span><a href="GHC.Core.Type.html#filterOutInvisibleTypes"><span class="hs-identifier hs-var">filterOutInvisibleTypes</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161401"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161418"><span class="hs-identifier hs-var">ee_lhs</span></a></span><span>
</span><span id="line-2582"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161425"><span class="annot"><a href="#local-6989586621683161425"><span class="hs-identifier hs-var">th_tys</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyTypes"><span class="hs-identifier hs-type">reifyTypes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161424"><span class="hs-identifier hs-type">types_only</span></a></span><span>
</span><span id="line-2583"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161426"><span class="annot"><a href="#local-6989586621683161426"><span class="hs-identifier hs-var">annot_th_tys</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Utils.Monad.html#zipWith3M"><span class="hs-identifier hs-type">zipWith3M</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#annotThType"><span class="hs-identifier hs-type">annotThType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161393"><span class="hs-identifier hs-type">is_poly_tvs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161424"><span class="hs-identifier hs-type">types_only</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161425"><span class="hs-identifier hs-type">th_tys</span></a></span><span>
</span><span id="line-2584"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683161427"><span class="annot"><a href="#local-6989586621683161427"><span class="hs-identifier hs-var hs-var">lhs_type</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; [Type] -&gt; Type
</span><a href="GHC.Tc.Gen.Splice.html#mkThAppTs"><span class="hs-identifier hs-var">mkThAppTs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Type
</span><span class="hs-identifier hs-var">TH.ConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161419"><span class="hs-identifier hs-var">fam'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161426"><span class="hs-identifier hs-var">annot_th_tys</span></a></span><span>
</span><span id="line-2585"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161428"><span class="annot"><a href="#local-6989586621683161428"><span class="hs-identifier hs-var">mb_sig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-2586"></span><span>               </span><span class="hs-comment">-- See &quot;Wrinkle: data family instances with return kinds&quot; in</span><span>
</span><span id="line-2587"></span><span>               </span><span class="hs-comment">-- Note [Reified instances and explicit kind signatures]</span><span>
</span><span id="line-2588"></span><span>               </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">null</span></span><span> </span><span class="annot"><a href="#local-6989586621683161423"><span class="hs-identifier hs-type">cons</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">||</span></span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#isGadtSyntaxTyCon"><span class="hs-identifier hs-type">isGadtSyntaxTyCon</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161416"><span class="hs-identifier hs-type">rep_tc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2589"></span><span>                     </span><span class="annot"><span class="hs-operator hs-type">&amp;&amp;</span></span><span> </span><span class="annot"><a href="GHC.Core.Type.html#tyConAppNeedsKindSig"><span class="hs-identifier hs-type">tyConAppNeedsKindSig</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span> </span><span class="annot"><a href="#local-6989586621683161401"><span class="hs-identifier hs-type">fam_tc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">length</span></span><span> </span><span class="annot"><a href="#local-6989586621683161418"><span class="hs-identifier hs-type">ee_lhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2590"></span><span>               </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683161430"><span class="annot"><a href="#local-6989586621683161430"><span class="hs-identifier hs-var hs-var">full_kind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Type
Type -&gt; Type
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; Type
</span><a href="GHC.Core.Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161401"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161418"><span class="hs-identifier hs-var">ee_lhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2591"></span><span>                       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161431"><span class="annot"><a href="#local-6989586621683161431"><span class="hs-identifier hs-var">th_full_kind</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyKind"><span class="hs-identifier hs-type">reifyKind</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161430"><span class="hs-identifier hs-type">full_kind</span></a></span><span>
</span><span id="line-2592"></span><span>                       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="#local-6989586621683161431"><span class="hs-identifier hs-type">th_full_kind</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2593"></span><span>               </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span>
</span><span id="line-2594"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-2595"></span><span>               </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#isNewTyCon"><span class="hs-identifier hs-type">isNewTyCon</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161416"><span class="hs-identifier hs-type">rep_tc</span></a></span><span>
</span><span id="line-2596"></span><span>               </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.NewtypeInstD</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><a href="#local-6989586621683161422"><span class="hs-identifier hs-type">th_tvs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161427"><span class="hs-identifier hs-type">lhs_type</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161428"><span class="hs-identifier hs-type">mb_sig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Prelude.Basic.html#head"><span class="hs-identifier hs-type">head</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161423"><span class="hs-identifier hs-type">cons</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-2597"></span><span>               </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.DataInstD</span></span><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><a href="#local-6989586621683161422"><span class="hs-identifier hs-type">th_tvs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161427"><span class="hs-identifier hs-type">lhs_type</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161428"><span class="hs-identifier hs-type">mb_sig</span></a></span><span>       </span><span class="annot"><a href="#local-6989586621683161423"><span class="hs-identifier hs-type">cons</span></a></span><span>  </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-2598"></span><span>           </span><span class="hs-special">}</span><span>
</span><span id="line-2599"></span><span>
</span><span id="line-2600"></span><span class="hs-comment">------------------------------</span><span>
</span><span id="line-2601"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-type">reifyType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">TyCoRep.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Type</span></span><span>
</span><span id="line-2602"></span><span class="hs-comment">-- Monadic only because of failure</span><span>
</span><span id="line-2603"></span><span id="reifyType"><span class="annot"><span class="annottext">reifyType :: Type -&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-var hs-var">reifyType</span></a></span></span><span> </span><span id="local-6989586621683161434"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161434"><span class="hs-identifier hs-var">ty</span></a></span></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Type.html#tcIsLiftedTypeKind"><span class="hs-identifier hs-var">tcIsLiftedTypeKind</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161434"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcM Type
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier hs-var">TH.StarT</span></span><span>
</span><span id="line-2604"></span><span>  </span><span class="hs-comment">-- Make sure to use tcIsLiftedTypeKind here, since we don't want to confuse it</span><span>
</span><span id="line-2605"></span><span>  </span><span class="hs-comment">-- with Constraint (#14869).</span><span>
</span><span id="line-2606"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a></span><span> </span><span id="local-6989586621683161436"><span class="annot"><span class="annottext">ty :: Type
</span><a href="#local-6989586621683161436"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ForAllTy"><span class="hs-identifier hs-type">ForAllTy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Bndr"><span class="hs-identifier hs-type">Bndr</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683161438"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621683161438"><span class="hs-identifier hs-var">argf</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-2607"></span><span>                            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag -&gt; Type -&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#reify_for_all"><span class="hs-identifier hs-var">reify_for_all</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621683161438"><span class="hs-identifier hs-var">argf</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161436"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2608"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#LitTy"><span class="hs-identifier hs-type">LitTy</span></a></span><span> </span><span id="local-6989586621683161441"><span class="annot"><span class="annottext">TyLit
</span><a href="#local-6989586621683161441"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683161442"><span class="annot"><a href="#local-6989586621683161442"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyLit -&gt; TcM TyLit
</span><a href="GHC.Tc.Gen.Splice.html#reifyTyLit"><span class="hs-identifier hs-var">reifyTyLit</span></a></span><span> </span><span class="annot"><span class="annottext">TyLit
</span><a href="#local-6989586621683161441"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.LitT</span></span><span> </span><span class="annot"><a href="#local-6989586621683161442"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2609"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyVarTy"><span class="hs-identifier hs-type">TyVarTy</span></a></span><span> </span><span id="local-6989586621683161445"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621683161445"><span class="hs-identifier hs-var">tv</span></a></span></span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcM Type
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Type
</span><span class="hs-identifier hs-var">TH.VarT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Name
forall n. NamedThing n =&gt; n -&gt; Name
</span><a href="GHC.Tc.Gen.Splice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621683161445"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2610"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyConApp"><span class="hs-identifier hs-type">TyConApp</span></a></span><span> </span><span id="local-6989586621683161447"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161447"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621683161448"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161448"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#reify_tc_app"><span class="hs-identifier hs-var">reify_tc_app</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161447"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161448"><span class="hs-identifier hs-var">tys</span></a></span><span>   </span><span class="hs-comment">-- Do not expand type synonyms here</span><span>
</span><span id="line-2611"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a></span><span> </span><span id="local-6989586621683161450"><span class="annot"><span class="annottext">ty :: Type
</span><a href="#local-6989586621683161450"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#AppTy"><span class="hs-identifier hs-type">AppTy</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2612"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683161452"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161452"><span class="hs-identifier hs-var hs-var">ty_head</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161453"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161453"><span class="hs-identifier hs-var hs-var">ty_args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; (Type, [Type])
Type -&gt; (Type, [Type])
</span><a href="GHC.Core.Type.html#splitAppTys"><span class="hs-identifier hs-var">splitAppTys</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161450"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2613"></span><span>  </span><span id="local-6989586621683161455"><span class="annot"><a href="#local-6989586621683161455"><span class="hs-identifier hs-var">ty_head'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161452"><span class="hs-identifier hs-var">ty_head</span></a></span><span>
</span><span id="line-2614"></span><span>  </span><span id="local-6989586621683161456"><span class="annot"><a href="#local-6989586621683161456"><span class="hs-identifier hs-var">ty_args'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyTypes"><span class="hs-identifier hs-type">reifyTypes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683161457"><span class="hs-identifier hs-type">filter_out_invisible_args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161452"><span class="hs-identifier hs-type">ty_head</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161453"><span class="hs-identifier hs-type">ty_args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2615"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#mkThAppTs"><span class="hs-identifier hs-type">mkThAppTs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161455"><span class="hs-identifier hs-type">ty_head'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161456"><span class="hs-identifier hs-type">ty_args'</span></a></span><span>
</span><span id="line-2616"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2617"></span><span>    </span><span class="hs-comment">-- Make sure to filter out any invisible arguments. For instance, if you</span><span>
</span><span id="line-2618"></span><span>    </span><span class="hs-comment">-- reify the following:</span><span>
</span><span id="line-2619"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-2620"></span><span>    </span><span class="hs-comment">--   newtype T (f :: forall a. a -&gt; Type) = MkT (f Bool)</span><span>
</span><span id="line-2621"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-2622"></span><span>    </span><span class="hs-comment">-- Then you should receive back `f Bool`, not `f Type Bool`, since the</span><span>
</span><span id="line-2623"></span><span>    </span><span class="hs-comment">-- `Type` argument is invisible (#15792).</span><span>
</span><span id="line-2624"></span><span>    </span><span class="annot"><a href="#local-6989586621683161457"><span class="hs-identifier hs-type">filter_out_invisible_args</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2625"></span><span>    </span><span id="local-6989586621683161457"><span class="annot"><span class="annottext">filter_out_invisible_args :: Type -&gt; [Type] -&gt; [Type]
</span><a href="#local-6989586621683161457"><span class="hs-identifier hs-var hs-var">filter_out_invisible_args</span></a></span></span><span> </span><span id="local-6989586621683161458"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161458"><span class="hs-identifier hs-var">ty_head</span></a></span></span><span> </span><span id="local-6989586621683161459"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161459"><span class="hs-identifier hs-var">ty_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2626"></span><span>      </span><span class="annot"><span class="annottext">[Bool] -&gt; [Type] -&gt; [Type]
forall a. [Bool] -&gt; [a] -&gt; [a]
</span><a href="GHC.Utils.Misc.html#filterByList"><span class="hs-identifier hs-var">filterByList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ForAllTyFlag -&gt; Bool) -&gt; [ForAllTyFlag] -&gt; [Bool]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag -&gt; Bool
</span><a href="Language.Haskell.Syntax.Specificity.html#isVisibleForAllTyFlag"><span class="hs-identifier hs-var">isVisibleForAllTyFlag</span></a></span><span> </span><span class="annot"><span class="annottext">([ForAllTyFlag] -&gt; [Bool]) -&gt; [ForAllTyFlag] -&gt; [Bool]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; [Type] -&gt; [ForAllTyFlag]
</span><a href="GHC.Core.Type.html#appTyForAllTyFlags"><span class="hs-identifier hs-var">appTyForAllTyFlags</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161458"><span class="hs-identifier hs-var">ty_head</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161459"><span class="hs-identifier hs-var">ty_args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2627"></span><span>                   </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161459"><span class="hs-identifier hs-var">ty_args</span></a></span><span>
</span><span id="line-2628"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a></span><span> </span><span id="local-6989586621683161462"><span class="annot"><span class="annottext">ty :: Type
</span><a href="#local-6989586621683161462"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#FunTy"><span class="hs-identifier hs-type">FunTy</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ft_af :: Type -&gt; FunTyFlag
</span><a href="GHC.Core.TyCo.Rep.html#ft_af"><span class="hs-identifier hs-var">ft_af</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683161465"><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683161465"><span class="hs-identifier hs-var">af</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_mult :: Type -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#ft_mult"><span class="hs-identifier hs-var">ft_mult</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Core.Type.html#ManyTy"><span class="hs-identifier hs-var">ManyTy</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_arg :: Type -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#ft_arg"><span class="hs-identifier hs-var">ft_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683161468"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161468"><span class="hs-identifier hs-var">t1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_res :: Type -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#ft_res"><span class="hs-identifier hs-var">ft_res</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683161470"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161470"><span class="hs-identifier hs-var">t2</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2629"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">FunTyFlag -&gt; Bool
</span><a href="GHC.Types.Var.html#isInvisibleFunArg"><span class="hs-identifier hs-var">isInvisibleFunArg</span></a></span><span> </span><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683161465"><span class="hs-identifier hs-var">af</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag -&gt; Type -&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#reify_for_all"><span class="hs-identifier hs-var">reify_for_all</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="Language.Haskell.Syntax.Specificity.html#Inferred"><span class="hs-identifier hs-var">Inferred</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161462"><span class="hs-identifier hs-var">ty</span></a></span><span>  </span><span class="hs-comment">-- Types like ((?x::Int) =&gt; Char -&gt; Char)</span><span>
</span><span id="line-2630"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">[</span><span id="local-6989586621683161473"><span class="annot"><a href="#local-6989586621683161473"><span class="hs-identifier hs-var">r1</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621683161474"><span class="annot"><a href="#local-6989586621683161474"><span class="hs-identifier hs-var">r2</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; TcM [Type]
</span><a href="GHC.Tc.Gen.Splice.html#reifyTypes"><span class="hs-identifier hs-var">reifyTypes</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161468"><span class="hs-identifier hs-var">t1</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161470"><span class="hs-identifier hs-var">t2</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2631"></span><span>                              </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.ArrowT</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">`TH.AppT`</span></span><span> </span><span class="annot"><a href="#local-6989586621683161473"><span class="hs-identifier hs-type">r1</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">`TH.AppT`</span></span><span> </span><span class="annot"><a href="#local-6989586621683161474"><span class="hs-identifier hs-type">r2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2632"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a></span><span> </span><span id="local-6989586621683161475"><span class="annot"><span class="annottext">ty :: Type
</span><a href="#local-6989586621683161475"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#FunTy"><span class="hs-identifier hs-type">FunTy</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ft_af :: Type -&gt; FunTyFlag
</span><a href="GHC.Core.TyCo.Rep.html#ft_af"><span class="hs-identifier hs-var">ft_af</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683161476"><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683161476"><span class="hs-identifier hs-var">af</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_mult :: Type -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#ft_mult"><span class="hs-identifier hs-var">ft_mult</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683161477"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161477"><span class="hs-identifier hs-var">tm</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_arg :: Type -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#ft_arg"><span class="hs-identifier hs-var">ft_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683161478"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161478"><span class="hs-identifier hs-var">t1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_res :: Type -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#ft_res"><span class="hs-identifier hs-var">ft_res</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683161479"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161479"><span class="hs-identifier hs-var">t2</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2633"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">FunTyFlag -&gt; Bool
</span><a href="GHC.Types.Var.html#isInvisibleFunArg"><span class="hs-identifier hs-var">isInvisibleFunArg</span></a></span><span> </span><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683161476"><span class="hs-identifier hs-var">af</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnrepresentableTypeDescr -&gt; Type -&gt; TcM Type
forall a. UnrepresentableTypeDescr -&gt; Type -&gt; TcM a
</span><a href="GHC.Tc.Gen.Splice.html#noTH"><span class="hs-identifier hs-var">noTH</span></a></span><span> </span><span class="annot"><span class="annottext">UnrepresentableTypeDescr
</span><a href="GHC.Tc.Errors.Types.html#LinearInvisibleArgument"><span class="hs-identifier hs-var">LinearInvisibleArgument</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161475"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2634"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">[</span><span id="local-6989586621683161482"><span class="annot"><a href="#local-6989586621683161482"><span class="hs-identifier hs-var">rm</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621683161483"><span class="annot"><a href="#local-6989586621683161483"><span class="hs-identifier hs-var">r1</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621683161484"><span class="annot"><a href="#local-6989586621683161484"><span class="hs-identifier hs-var">r2</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; TcM [Type]
</span><a href="GHC.Tc.Gen.Splice.html#reifyTypes"><span class="hs-identifier hs-var">reifyTypes</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161477"><span class="hs-identifier hs-var">tm</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161478"><span class="hs-identifier hs-var">t1</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161479"><span class="hs-identifier hs-var">t2</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2635"></span><span>                              </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.MulArrowT</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">`TH.AppT`</span></span><span> </span><span class="annot"><a href="#local-6989586621683161482"><span class="hs-identifier hs-type">rm</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">`TH.AppT`</span></span><span> </span><span class="annot"><a href="#local-6989586621683161483"><span class="hs-identifier hs-type">r1</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">`TH.AppT`</span></span><span> </span><span class="annot"><a href="#local-6989586621683161484"><span class="hs-identifier hs-type">r2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2636"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CastTy"><span class="hs-identifier hs-type">CastTy</span></a></span><span> </span><span id="local-6989586621683161486"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161486"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="annot"><span class="annottext">KindCoercion
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161486"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-comment">-- Casts are ignored in TH</span><span>
</span><span id="line-2637"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a></span><span> </span><span id="local-6989586621683161487"><span class="annot"><span class="annottext">ty :: Type
</span><a href="#local-6989586621683161487"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionTy"><span class="hs-identifier hs-type">CoercionTy</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnrepresentableTypeDescr -&gt; Type -&gt; TcM Type
forall a. UnrepresentableTypeDescr -&gt; Type -&gt; TcM a
</span><a href="GHC.Tc.Gen.Splice.html#noTH"><span class="hs-identifier hs-var">noTH</span></a></span><span> </span><span class="annot"><span class="annottext">UnrepresentableTypeDescr
</span><a href="GHC.Tc.Errors.Types.html#CoercionsInTypes"><span class="hs-identifier hs-var">CoercionsInTypes</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161487"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2638"></span><span>
</span><span id="line-2639"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reify_for_all"><span class="hs-identifier hs-type">reify_for_all</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Specificity.html#ForAllTyFlag"><span class="hs-identifier hs-type">TyCoRep.ForAllTyFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">TyCoRep.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Type</span></span><span>
</span><span id="line-2640"></span><span class="hs-comment">-- Arg of reify_for_all is always ForAllTy or a predicate FunTy</span><span>
</span><span id="line-2641"></span><span id="reify_for_all"><span class="annot"><span class="annottext">reify_for_all :: ForAllTyFlag -&gt; Type -&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#reify_for_all"><span class="hs-identifier hs-var hs-var">reify_for_all</span></a></span></span><span> </span><span id="local-6989586621683161490"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621683161490"><span class="hs-identifier hs-var">argf</span></a></span></span><span> </span><span id="local-6989586621683161491"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161491"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-2642"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag -&gt; Bool
</span><a href="Language.Haskell.Syntax.Specificity.html#isVisibleForAllTyFlag"><span class="hs-identifier hs-var">isVisibleForAllTyFlag</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621683161490"><span class="hs-identifier hs-var">argf</span></a></span><span>
</span><span id="line-2643"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683161492"><span class="annot"><span class="annottext">[TcReqTVBinder]
</span><a href="#local-6989586621683161492"><span class="hs-identifier hs-var hs-var">req_bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161493"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161493"><span class="hs-identifier hs-var hs-var">phi</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; ([TcReqTVBinder], Type)
</span><a href="GHC.Tc.Utils.TcType.html#tcSplitForAllReqTVBinders"><span class="hs-identifier hs-var">tcSplitForAllReqTVBinders</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161491"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2644"></span><span>       </span><span id="local-6989586621683161495"><span class="annot"><a href="#local-6989586621683161495"><span class="hs-identifier hs-var">tvbndrs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TcReqTVBinder] -&gt; TcM [TyVarBndr ()]
forall flag flag'.
ReifyFlag flag flag' =&gt;
[VarBndr TyVar flag] -&gt; TcM [TyVarBndr flag']
</span><a href="GHC.Tc.Gen.Splice.html#reifyTyVarBndrs"><span class="hs-identifier hs-var">reifyTyVarBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">[TcReqTVBinder]
</span><a href="#local-6989586621683161492"><span class="hs-identifier hs-var">req_bndrs</span></a></span><span>
</span><span id="line-2645"></span><span>       </span><span id="local-6989586621683161496"><span class="annot"><a href="#local-6989586621683161496"><span class="hs-identifier hs-var">phi'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-type">reifyType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161493"><span class="hs-identifier hs-type">phi</span></a></span><span>
</span><span id="line-2646"></span><span>       </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.ForallVisT</span></span><span> </span><span class="annot"><a href="#local-6989586621683161495"><span class="hs-identifier hs-type">tvbndrs'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161496"><span class="hs-identifier hs-type">phi'</span></a></span><span>
</span><span id="line-2647"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2648"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683161497"><span class="annot"><span class="annottext">[InvisTVBinder]
</span><a href="#local-6989586621683161497"><span class="hs-identifier hs-var hs-var">inv_bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161498"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161498"><span class="hs-identifier hs-var hs-var">phi</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; ([InvisTVBinder], Type)
</span><a href="GHC.Tc.Utils.TcType.html#tcSplitForAllInvisTVBinders"><span class="hs-identifier hs-var">tcSplitForAllInvisTVBinders</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161491"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2649"></span><span>       </span><span id="local-6989586621683161500"><span class="annot"><a href="#local-6989586621683161500"><span class="hs-identifier hs-var">tvbndrs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[InvisTVBinder] -&gt; TcM [TyVarBndr Specificity]
forall flag flag'.
ReifyFlag flag flag' =&gt;
[VarBndr TyVar flag] -&gt; TcM [TyVarBndr flag']
</span><a href="GHC.Tc.Gen.Splice.html#reifyTyVarBndrs"><span class="hs-identifier hs-var">reifyTyVarBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">[InvisTVBinder]
</span><a href="#local-6989586621683161497"><span class="hs-identifier hs-var">inv_bndrs</span></a></span><span>
</span><span id="line-2650"></span><span>       </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683161501"><span class="annot"><a href="#local-6989586621683161501"><span class="hs-identifier hs-var">cxt</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161502"><span class="annot"><a href="#local-6989586621683161502"><span class="hs-identifier hs-var">tau</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#tcSplitPhiTy"><span class="hs-identifier hs-type">tcSplitPhiTy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161498"><span class="hs-identifier hs-type">phi</span></a></span><span>
</span><span id="line-2651"></span><span>       </span><span id="local-6989586621683161504"><span class="annot"><a href="#local-6989586621683161504"><span class="hs-identifier hs-var">cxt'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyCxt"><span class="hs-identifier hs-type">reifyCxt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161501"><span class="hs-identifier hs-type">cxt</span></a></span><span>
</span><span id="line-2652"></span><span>       </span><span id="local-6989586621683161505"><span class="annot"><a href="#local-6989586621683161505"><span class="hs-identifier hs-var">tau'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-type">reifyType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161502"><span class="hs-identifier hs-type">tau</span></a></span><span>
</span><span id="line-2653"></span><span>       </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.ForallT</span></span><span> </span><span class="annot"><a href="#local-6989586621683161500"><span class="hs-identifier hs-type">tvbndrs'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161504"><span class="hs-identifier hs-type">cxt'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161505"><span class="hs-identifier hs-type">tau'</span></a></span><span>
</span><span id="line-2654"></span><span>
</span><span id="line-2655"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyTyLit"><span class="hs-identifier hs-type">reifyTyLit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyLit"><span class="hs-identifier hs-type">TyCoRep.TyLit</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.TyLit</span></span><span>
</span><span id="line-2656"></span><span id="reifyTyLit"><span class="annot"><span class="annottext">reifyTyLit :: TyLit -&gt; TcM TyLit
</span><a href="GHC.Tc.Gen.Splice.html#reifyTyLit"><span class="hs-identifier hs-var hs-var">reifyTyLit</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#NumTyLit"><span class="hs-identifier hs-type">NumTyLit</span></a></span><span> </span><span id="local-6989586621683161507"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621683161507"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyLit -&gt; TcM TyLit
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; TyLit
</span><span class="hs-identifier hs-var">TH.NumTyLit</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621683161507"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2657"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyTyLit"><span class="hs-identifier hs-var">reifyTyLit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#StrTyLit"><span class="hs-identifier hs-type">StrTyLit</span></a></span><span> </span><span id="local-6989586621683161510"><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683161510"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyLit -&gt; TcM TyLit
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; TyLit
</span><span class="hs-identifier hs-var">TH.StrTyLit</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FastString -&gt; String
</span><a href="GHC.Data.FastString.html#unpackFS"><span class="hs-identifier hs-var">unpackFS</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683161510"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2658"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyTyLit"><span class="hs-identifier hs-var">reifyTyLit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CharTyLit"><span class="hs-identifier hs-type">CharTyLit</span></a></span><span> </span><span id="local-6989586621683161513"><span class="annot"><span class="annottext">Char
</span><a href="#local-6989586621683161513"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyLit -&gt; TcM TyLit
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char -&gt; TyLit
</span><span class="hs-identifier hs-var">TH.CharTyLit</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><a href="#local-6989586621683161513"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2659"></span><span>
</span><span id="line-2660"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyTypes"><span class="hs-identifier hs-type">reifyTypes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">TH.Type</span></span><span class="hs-special">]</span><span>
</span><span id="line-2661"></span><span id="reifyTypes"><span class="annot"><span class="annottext">reifyTypes :: [Type] -&gt; TcM [Type]
</span><a href="GHC.Tc.Gen.Splice.html#reifyTypes"><span class="hs-identifier hs-var hs-var">reifyTypes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; TcM Type) -&gt; [Type] -&gt; TcM [Type]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a></span><span>
</span><span id="line-2662"></span><span>
</span><span id="line-2663"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyPatSynType"><span class="hs-identifier hs-type">reifyPatSynType</span></a></span><span>
</span><span id="line-2664"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#InvisTVBinder"><span class="hs-identifier hs-type">InvisTVBinder</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#InvisTVBinder"><span class="hs-identifier hs-type">InvisTVBinder</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Scaled"><span class="hs-identifier hs-type">Scaled</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Type</span></span><span>
</span><span id="line-2665"></span><span class="hs-comment">-- reifies a pattern synonym's type and returns its *complete* type</span><span>
</span><span id="line-2666"></span><span class="hs-comment">-- signature; see Note [Pattern synonym type signatures and Template</span><span>
</span><span id="line-2667"></span><span class="hs-comment">-- Haskell] in GHC.ThToHs</span><span>
</span><span id="line-2668"></span><span id="reifyPatSynType"><span class="annot"><span class="annottext">reifyPatSynType :: ([InvisTVBinder], [Type], [InvisTVBinder], [Type], [Scaled Type],
 Type)
-&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#reifyPatSynType"><span class="hs-identifier hs-var hs-var">reifyPatSynType</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683161516"><span class="annot"><span class="annottext">[InvisTVBinder]
</span><a href="#local-6989586621683161516"><span class="hs-identifier hs-var">univTyVars</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161517"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161517"><span class="hs-identifier hs-var">req</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161518"><span class="annot"><span class="annottext">[InvisTVBinder]
</span><a href="#local-6989586621683161518"><span class="hs-identifier hs-var">exTyVars</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161519"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161519"><span class="hs-identifier hs-var">prov</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161520"><span class="annot"><span class="annottext">[Scaled Type]
</span><a href="#local-6989586621683161520"><span class="hs-identifier hs-var">argTys</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161521"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161521"><span class="hs-identifier hs-var">resTy</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2669"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683161522"><span class="annot"><a href="#local-6989586621683161522"><span class="hs-identifier hs-var">univTyVars'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[InvisTVBinder] -&gt; TcM [TyVarBndr Specificity]
forall flag flag'.
ReifyFlag flag flag' =&gt;
[VarBndr TyVar flag] -&gt; TcM [TyVarBndr flag']
</span><a href="GHC.Tc.Gen.Splice.html#reifyTyVarBndrs"><span class="hs-identifier hs-var">reifyTyVarBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">[InvisTVBinder]
</span><a href="#local-6989586621683161516"><span class="hs-identifier hs-var">univTyVars</span></a></span><span>
</span><span id="line-2670"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161523"><span class="annot"><a href="#local-6989586621683161523"><span class="hs-identifier hs-var">req'</span></a></span></span><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyCxt"><span class="hs-identifier hs-type">reifyCxt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161517"><span class="hs-identifier hs-type">req</span></a></span><span>
</span><span id="line-2671"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161524"><span class="annot"><a href="#local-6989586621683161524"><span class="hs-identifier hs-var">exTyVars'</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyTyVarBndrs"><span class="hs-identifier hs-type">reifyTyVarBndrs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161518"><span class="hs-identifier hs-type">exTyVars</span></a></span><span>
</span><span id="line-2672"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161525"><span class="annot"><a href="#local-6989586621683161525"><span class="hs-identifier hs-var">prov'</span></a></span></span><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyCxt"><span class="hs-identifier hs-type">reifyCxt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161519"><span class="hs-identifier hs-type">prov</span></a></span><span>
</span><span id="line-2673"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161526"><span class="annot"><a href="#local-6989586621683161526"><span class="hs-identifier hs-var">tau'</span></a></span></span><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-type">reifyType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#mkScaledFunTys"><span class="hs-identifier hs-type">mkScaledFunTys</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161520"><span class="hs-identifier hs-type">argTys</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161521"><span class="hs-identifier hs-type">resTy</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2674"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.ForallT</span></span><span> </span><span class="annot"><a href="#local-6989586621683161522"><span class="hs-identifier hs-type">univTyVars'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161523"><span class="hs-identifier hs-type">req'</span></a></span><span>
</span><span id="line-2675"></span><span>                </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.ForallT</span></span><span> </span><span class="annot"><a href="#local-6989586621683161524"><span class="hs-identifier hs-type">exTyVars'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161525"><span class="hs-identifier hs-type">prov'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161526"><span class="hs-identifier hs-type">tau'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2676"></span><span>
</span><span id="line-2677"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyKind"><span class="hs-identifier hs-type">reifyKind</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Kind"><span class="hs-identifier hs-type">Kind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Kind</span></span><span>
</span><span id="line-2678"></span><span id="reifyKind"><span class="annot"><span class="annottext">reifyKind :: Type -&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#reifyKind"><span class="hs-identifier hs-var hs-var">reifyKind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a></span><span>
</span><span id="line-2679"></span><span>
</span><span id="line-2680"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyCxt"><span class="hs-identifier hs-type">reifyCxt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">TH.Pred</span></span><span class="hs-special">]</span><span>
</span><span id="line-2681"></span><span id="reifyCxt"><span class="annot"><span class="annottext">reifyCxt :: [Type] -&gt; TcM [Type]
</span><a href="GHC.Tc.Gen.Splice.html#reifyCxt"><span class="hs-identifier hs-var hs-var">reifyCxt</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; TcM Type) -&gt; [Type] -&gt; TcM [Type]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a></span><span>
</span><span id="line-2682"></span><span>
</span><span id="line-2683"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyFunDep"><span class="hs-identifier hs-type">reifyFunDep</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.FunDep</span></span><span>
</span><span id="line-2684"></span><span id="reifyFunDep"><span class="annot"><span class="annottext">reifyFunDep :: FunDep TyVar -&gt; FunDep
</span><a href="GHC.Tc.Gen.Splice.html#reifyFunDep"><span class="hs-identifier hs-var hs-var">reifyFunDep</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683161530"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621683161530"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161531"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621683161531"><span class="hs-identifier hs-var">ys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; [Name] -&gt; FunDep
</span><span class="hs-identifier hs-var">TH.FunDep</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TyVar -&gt; Name) -&gt; [TyVar] -&gt; [Name]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Name
forall n. NamedThing n =&gt; n -&gt; Name
</span><a href="GHC.Tc.Gen.Splice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621683161530"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TyVar -&gt; Name) -&gt; [TyVar] -&gt; [Name]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Name
forall n. NamedThing n =&gt; n -&gt; Name
</span><a href="GHC.Tc.Gen.Splice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621683161531"><span class="hs-identifier hs-var">ys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2685"></span><span>
</span><span id="line-2686"></span><span class="hs-keyword">class</span><span> </span><span id="ReifyFlag"><span class="annot"><a href="GHC.Tc.Gen.Splice.html#ReifyFlag"><span class="hs-identifier hs-var">ReifyFlag</span></a></span></span><span> </span><span id="local-6989586621683158805"><span class="annot"><a href="#local-6989586621683158805"><span class="hs-identifier hs-type">flag</span></a></span></span><span> </span><span id="local-6989586621683158806"><span class="annot"><a href="#local-6989586621683158806"><span class="hs-identifier hs-type">flag'</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="#local-6989586621683158805"><span class="hs-identifier hs-type">flag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621683158806"><span class="hs-identifier hs-type">flag'</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-2687"></span><span>    </span><span id="reifyFlag"><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyFlag"><span class="hs-identifier hs-type">reifyFlag</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621683158805"><span class="hs-identifier hs-type">flag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621683158806"><span class="hs-identifier hs-type">flag'</span></a></span><span>
</span><span id="line-2688"></span><span>
</span><span id="line-2689"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#ReifyFlag"><span class="hs-identifier hs-type">ReifyFlag</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-2690"></span><span>    </span><span id="local-6989586621683161536"><span class="annot"><span class="annottext">reifyFlag :: () -&gt; ()
</span><a href="GHC.Tc.Gen.Splice.html#reifyFlag"><span class="hs-identifier hs-var hs-var hs-var">reifyFlag</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2691"></span><span>
</span><span id="line-2692"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#ReifyFlag"><span class="hs-identifier hs-type">ReifyFlag</span></a></span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Specificity.html#Specificity"><span class="hs-identifier hs-type">Specificity</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Specificity</span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-2693"></span><span>    </span><span id="local-6989586621683161538"><span class="annot"><span class="annottext">reifyFlag :: Specificity -&gt; Specificity
</span><a href="GHC.Tc.Gen.Splice.html#reifyFlag"><span class="hs-identifier hs-var hs-var hs-var">reifyFlag</span></a></span></span><span> </span><span class="annot"><span class="annottext">Specificity
</span><a href="Language.Haskell.Syntax.Specificity.html#SpecifiedSpec"><span class="hs-identifier hs-var">SpecifiedSpec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Specificity
</span><span class="hs-identifier hs-var">TH.SpecifiedSpec</span></span><span>
</span><span id="line-2694"></span><span>    </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyFlag"><span class="hs-identifier hs-var">reifyFlag</span></a></span><span> </span><span class="annot"><span class="annottext">Specificity
</span><a href="Language.Haskell.Syntax.Specificity.html#InferredSpec"><span class="hs-identifier hs-var">InferredSpec</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Specificity
</span><span class="hs-identifier hs-var">TH.InferredSpec</span></span><span>
</span><span id="line-2695"></span><span>
</span><span id="line-2696"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#ReifyFlag"><span class="hs-identifier hs-type">ReifyFlag</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyConBndrVis"><span class="hs-identifier hs-type">TyConBndrVis</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.BndrVis</span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-2697"></span><span>    </span><span id="local-6989586621683161543"><span class="annot"><span class="annottext">reifyFlag :: TyConBndrVis -&gt; Maybe BndrVis
</span><a href="GHC.Tc.Gen.Splice.html#reifyFlag"><span class="hs-identifier hs-var hs-var hs-var">reifyFlag</span></a></span></span><span> </span><span class="annot"><span class="annottext">TyConBndrVis
</span><a href="GHC.Core.TyCon.html#AnonTCB"><span class="hs-identifier hs-var">AnonTCB</span></a></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BndrVis -&gt; Maybe BndrVis
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">BndrVis
</span><span class="hs-identifier hs-var">TH.BndrReq</span></span><span>
</span><span id="line-2698"></span><span>    </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyFlag"><span class="hs-identifier hs-var">reifyFlag</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCon.html#NamedTCB"><span class="hs-identifier hs-type">NamedTCB</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="Language.Haskell.Syntax.Specificity.html#Required"><span class="hs-identifier hs-var">Required</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BndrVis -&gt; Maybe BndrVis
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">BndrVis
</span><span class="hs-identifier hs-var">TH.BndrReq</span></span><span>
</span><span id="line-2699"></span><span>    </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyFlag"><span class="hs-identifier hs-var">reifyFlag</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCon.html#NamedTCB"><span class="hs-identifier hs-type">NamedTCB</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Specificity.html#Invisible"><span class="hs-identifier hs-type">Invisible</span></a></span><span> </span><span class="annot"><span class="annottext">Specificity
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2700"></span><span>      </span><span class="annot"><span class="annottext">Maybe BndrVis
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-comment">-- See Note [Reifying invisible type variable binders] and #22828.</span><span>
</span><span id="line-2701"></span><span>
</span><span id="line-2702"></span><span class="hs-comment">-- Currently does not return invisible type variable binders (@k-binders).</span><span>
</span><span id="line-2703"></span><span class="hs-comment">-- See Note [Reifying invisible type variable binders] and #22828.</span><span>
</span><span id="line-2704"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyTyConBinders"><span class="hs-identifier hs-type">reifyTyConBinders</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">TH.TyVarBndr</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.BndrVis</span></span><span class="hs-special">]</span><span>
</span><span id="line-2705"></span><span id="reifyTyConBinders"><span class="annot"><span class="annottext">reifyTyConBinders :: TyCon -&gt; TcM [TyVarBndr BndrVis]
</span><a href="GHC.Tc.Gen.Splice.html#reifyTyConBinders"><span class="hs-identifier hs-var hs-var">reifyTyConBinders</span></a></span></span><span> </span><span id="local-6989586621683161549"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161549"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([TyVarBndr (Maybe BndrVis)] -&gt; [TyVarBndr BndrVis])
-&gt; IOEnv (Env TcGblEnv TcLclEnv) [TyVarBndr (Maybe BndrVis)]
-&gt; TcM [TyVarBndr BndrVis]
forall a b.
(a -&gt; b)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) a
-&gt; IOEnv (Env TcGblEnv TcLclEnv) b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TyVarBndr (Maybe BndrVis) -&gt; Maybe (TyVarBndr BndrVis))
-&gt; [TyVarBndr (Maybe BndrVis)] -&gt; [TyVarBndr BndrVis]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">TyVarBndr (Maybe BndrVis) -&gt; Maybe (TyVarBndr BndrVis)
forall flag. TyVarBndr (Maybe flag) -&gt; Maybe (TyVarBndr flag)
</span><a href="#local-6989586621683161551"><span class="hs-identifier hs-var">get_bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VarBndr TyVar TyConBndrVis]
-&gt; IOEnv (Env TcGblEnv TcLclEnv) [TyVarBndr (Maybe BndrVis)]
forall flag flag'.
ReifyFlag flag flag' =&gt;
[VarBndr TyVar flag] -&gt; TcM [TyVarBndr flag']
</span><a href="GHC.Tc.Gen.Splice.html#reifyTyVarBndrs"><span class="hs-identifier hs-var">reifyTyVarBndrs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [VarBndr TyVar TyConBndrVis]
</span><a href="GHC.Core.TyCon.html#tyConBinders"><span class="hs-identifier hs-var">tyConBinders</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161549"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2706"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2707"></span><span>    </span><span id="local-6989586621683158809"><span class="annot"><a href="#local-6989586621683161551"><span class="hs-identifier hs-type">get_bndr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.TyVarBndr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621683158809"><span class="hs-identifier hs-type">flag</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.TyVarBndr</span></span><span> </span><span class="annot"><a href="#local-6989586621683158809"><span class="hs-identifier hs-type">flag</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-2708"></span><span>    </span><span id="local-6989586621683161551"><span class="annot"><span class="annottext">get_bndr :: forall flag. TyVarBndr (Maybe flag) -&gt; Maybe (TyVarBndr flag)
</span><a href="#local-6989586621683161551"><span class="hs-identifier hs-var hs-var">get_bndr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVarBndr (Maybe flag) -&gt; Maybe (TyVarBndr flag)
forall (t :: * -&gt; *) (f :: * -&gt; *) a.
(Traversable t, Applicative f) =&gt;
t (f a) -&gt; f (t a)
forall (f :: * -&gt; *) a.
Applicative f =&gt;
TyVarBndr (f a) -&gt; f (TyVarBndr a)
</span><span class="hs-identifier hs-var">sequenceA</span></span><span>
</span><span id="line-2709"></span><span>
</span><span id="line-2710"></span><span class="hs-comment">{- Note [Reifying invisible type variable binders]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In reifyFlag for TyConBndrVis, we have the following clause:

    reifyFlag (NamedTCB (Invisible _)) = Nothing

This means that reifyTyConBinders doesn't reify invisible type variables as
@k-binders. However, it is possible (and not hard) to change this.
Just replace the above clause with:

    reifyFlag (NamedTCB Specified) = Just TH.BndrInvis
    reifyFlag (NamedTCB Inferred)  = Nothing    -- Inferred variables can not be bound

There are two reasons we opt not to do that for now.
  1. It would be a (sometimes silent) breaking change affecting th-abstraction,
     aeson, and other libraries that assume that reified binders are visible.
  2. It would create an asymmetry with visible kind applications, which are
     not reified either.

This decision is not set in stone. If a use case for reifying invisible type
variable binders presents itself, we can reconsider. See #22828.
-}</span><span>
</span><span id="line-2732"></span><span>
</span><span id="line-2733"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyTyVars"><span class="hs-identifier hs-type">reifyTyVars</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">TH.TyVarBndr</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-2734"></span><span id="reifyTyVars"><span class="annot"><span class="annottext">reifyTyVars :: [TyVar] -&gt; TcM [TyVarBndr ()]
</span><a href="GHC.Tc.Gen.Splice.html#reifyTyVars"><span class="hs-identifier hs-var hs-var">reifyTyVars</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TcReqTVBinder] -&gt; TcM [TyVarBndr ()]
forall flag flag'.
ReifyFlag flag flag' =&gt;
[VarBndr TyVar flag] -&gt; TcM [TyVarBndr flag']
</span><a href="GHC.Tc.Gen.Splice.html#reifyTyVarBndrs"><span class="hs-identifier hs-var">reifyTyVarBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">([TcReqTVBinder] -&gt; TcM [TyVarBndr ()])
-&gt; ([TyVar] -&gt; [TcReqTVBinder]) -&gt; [TyVar] -&gt; TcM [TyVarBndr ()]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(TyVar -&gt; TcReqTVBinder) -&gt; [TyVar] -&gt; [TcReqTVBinder]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; TcReqTVBinder
forall {var}. var -&gt; VarBndr var ()
</span><a href="#local-6989586621683161559"><span class="hs-identifier hs-var">mk_bndr</span></a></span><span>
</span><span id="line-2735"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2736"></span><span>    </span><span id="local-6989586621683161559"><span class="annot"><span class="annottext">mk_bndr :: var -&gt; VarBndr var ()
</span><a href="#local-6989586621683161559"><span class="hs-identifier hs-var hs-var">mk_bndr</span></a></span></span><span> </span><span id="local-6989586621683161560"><span class="annot"><span class="annottext">var
</span><a href="#local-6989586621683161560"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">var -&gt; () -&gt; VarBndr var ()
forall var argf. var -&gt; argf -&gt; VarBndr var argf
</span><a href="GHC.Types.Var.html#Bndr"><span class="hs-identifier hs-var">Bndr</span></a></span><span> </span><span class="annot"><span class="annottext">var
</span><a href="#local-6989586621683161560"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2737"></span><span>
</span><span id="line-2738"></span><span id="local-6989586621683158767"><span id="local-6989586621683158768"><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyTyVarBndrs"><span class="hs-identifier hs-type">reifyTyVarBndrs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#ReifyFlag"><span class="hs-identifier hs-type">ReifyFlag</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683158767"><span class="hs-identifier hs-type">flag</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683158768"><span class="hs-identifier hs-type">flag'</span></a></span><span>
</span><span id="line-2739"></span><span>                </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#VarBndr"><span class="hs-identifier hs-type">VarBndr</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683158767"><span class="hs-identifier hs-type">flag</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">TH.TyVarBndr</span></span><span> </span><span class="annot"><a href="#local-6989586621683158768"><span class="hs-identifier hs-type">flag'</span></a></span><span class="hs-special">]</span></span></span><span>
</span><span id="line-2740"></span><span id="reifyTyVarBndrs"><span class="annot"><span class="annottext">reifyTyVarBndrs :: forall flag flag'.
ReifyFlag flag flag' =&gt;
[VarBndr TyVar flag] -&gt; TcM [TyVarBndr flag']
</span><a href="GHC.Tc.Gen.Splice.html#reifyTyVarBndrs"><span class="hs-identifier hs-var hs-var">reifyTyVarBndrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VarBndr TyVar flag
 -&gt; IOEnv (Env TcGblEnv TcLclEnv) (TyVarBndr flag'))
-&gt; [VarBndr TyVar flag]
-&gt; IOEnv (Env TcGblEnv TcLclEnv) [TyVarBndr flag']
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">VarBndr TyVar flag
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (TyVarBndr flag')
forall {flag} {flag}.
ReifyFlag flag flag =&gt;
VarBndr TyVar flag
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (TyVarBndr flag)
</span><a href="#local-6989586621683161565"><span class="hs-identifier hs-var">reify_tvbndr</span></a></span><span>
</span><span id="line-2741"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2742"></span><span>    </span><span class="hs-comment">-- even if the kind is *, we need to include a kind annotation,</span><span>
</span><span id="line-2743"></span><span>    </span><span class="hs-comment">-- in case a poly-kind would be inferred without the annotation.</span><span>
</span><span id="line-2744"></span><span>    </span><span class="hs-comment">-- See #8953 or test th/T8953</span><span>
</span><span id="line-2745"></span><span>    </span><span id="local-6989586621683161565"><span class="annot"><span class="annottext">reify_tvbndr :: VarBndr TyVar flag
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (TyVarBndr flag)
</span><a href="#local-6989586621683161565"><span class="hs-identifier hs-var hs-var">reify_tvbndr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Bndr"><span class="hs-identifier hs-type">Bndr</span></a></span><span> </span><span id="local-6989586621683161570"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621683161570"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span id="local-6989586621683161571"><span class="annot"><span class="annottext">flag
</span><a href="#local-6989586621683161571"><span class="hs-identifier hs-var">fl</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; flag -&gt; Type -&gt; TyVarBndr flag
forall flag. Name -&gt; flag -&gt; Type -&gt; TyVarBndr flag
</span><span class="hs-identifier hs-var">TH.KindedTV</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Name
forall n. NamedThing n =&gt; n -&gt; Name
</span><a href="GHC.Tc.Gen.Splice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621683161570"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2746"></span><span>                                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">flag -&gt; flag
forall flag flag'. ReifyFlag flag flag' =&gt; flag -&gt; flag'
</span><a href="GHC.Tc.Gen.Splice.html#reifyFlag"><span class="hs-identifier hs-var">reifyFlag</span></a></span><span> </span><span class="annot"><span class="annottext">flag
</span><a href="#local-6989586621683161571"><span class="hs-identifier hs-var">fl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2747"></span><span>                                            </span><span class="annot"><span class="annottext">(Type -&gt; TyVarBndr flag)
-&gt; TcM Type -&gt; IOEnv (Env TcGblEnv TcLclEnv) (TyVarBndr flag)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#reifyKind"><span class="hs-identifier hs-var">reifyKind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Type
</span><a href="GHC.Types.Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621683161570"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2748"></span><span>
</span><span id="line-2749"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyTyVarsToMaybe"><span class="hs-identifier hs-type">reifyTyVarsToMaybe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">TH.TyVarBndr</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2750"></span><span id="reifyTyVarsToMaybe"><span class="annot"><span class="annottext">reifyTyVarsToMaybe :: [TyVar] -&gt; TcM (Maybe [TyVarBndr ()])
</span><a href="GHC.Tc.Gen.Splice.html#reifyTyVarsToMaybe"><span class="hs-identifier hs-var hs-var">reifyTyVarsToMaybe</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe [TyVarBndr ()] -&gt; TcM (Maybe [TyVarBndr ()])
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Maybe [TyVarBndr ()]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-2751"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyTyVarsToMaybe"><span class="hs-identifier hs-var">reifyTyVarsToMaybe</span></a></span><span> </span><span id="local-6989586621683161572"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621683161572"><span class="hs-identifier hs-var">tys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVarBndr ()] -&gt; Maybe [TyVarBndr ()]
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">([TyVarBndr ()] -&gt; Maybe [TyVarBndr ()])
-&gt; TcM [TyVarBndr ()] -&gt; TcM (Maybe [TyVarBndr ()])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; TcM [TyVarBndr ()]
</span><a href="GHC.Tc.Gen.Splice.html#reifyTyVars"><span class="hs-identifier hs-var">reifyTyVars</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621683161572"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-2752"></span><span>
</span><span id="line-2753"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reify_tc_app"><span class="hs-identifier hs-type">reify_tc_app</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type.Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Type</span></span><span>
</span><span id="line-2754"></span><span id="reify_tc_app"><span class="annot"><span class="annottext">reify_tc_app :: TyCon -&gt; [Type] -&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#reify_tc_app"><span class="hs-identifier hs-var hs-var">reify_tc_app</span></a></span></span><span> </span><span id="local-6989586621683161573"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161573"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621683161574"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161574"><span class="hs-identifier hs-var">tys</span></a></span></span><span>
</span><span id="line-2755"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683161575"><span class="annot"><a href="#local-6989586621683161575"><span class="hs-identifier hs-var">tys'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; TcM [Type]
</span><a href="GHC.Tc.Gen.Splice.html#reifyTypes"><span class="hs-identifier hs-var">reifyTypes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; [Type]
</span><a href="GHC.Core.Type.html#filterOutInvisibleTypes"><span class="hs-identifier hs-var">filterOutInvisibleTypes</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161573"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161574"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2756"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="#local-6989586621683161576"><span class="hs-identifier hs-type">maybe_sig_t</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#mkThAppTs"><span class="hs-identifier hs-type">mkThAppTs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161577"><span class="hs-identifier hs-type">r_tc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161575"><span class="hs-identifier hs-type">tys'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2757"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2758"></span><span>    </span><span id="local-6989586621683161578"><span class="annot"><span class="annottext">arity :: SumArity
</span><a href="#local-6989586621683161578"><span class="hs-identifier hs-var hs-var">arity</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; SumArity
</span><a href="GHC.Core.TyCon.html#tyConArity"><span class="hs-identifier hs-var">tyConArity</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161573"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-2759"></span><span>
</span><span id="line-2760"></span><span>    </span><span id="local-6989586621683161577"><span class="annot"><span class="annottext">r_tc :: Type
</span><a href="#local-6989586621683161577"><span class="hs-identifier hs-var hs-var">r_tc</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isUnboxedSumTyCon"><span class="hs-identifier hs-var">isUnboxedSumTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161573"><span class="hs-identifier hs-var">tc</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SumArity -&gt; Type
</span><span class="hs-identifier hs-var">TH.UnboxedSumT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SumArity
</span><a href="#local-6989586621683161578"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="annot"><span class="annottext">SumArity -&gt; SumArity -&gt; SumArity
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`div`</span></span><span> </span><span class="annot"><span class="annottext">SumArity
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span>
</span><span id="line-2761"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isUnboxedTupleTyCon"><span class="hs-identifier hs-var">isUnboxedTupleTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161573"><span class="hs-identifier hs-var">tc</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SumArity -&gt; Type
</span><span class="hs-identifier hs-var">TH.UnboxedTupleT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SumArity
</span><a href="#local-6989586621683161578"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="annot"><span class="annottext">SumArity -&gt; SumArity -&gt; SumArity
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`div`</span></span><span> </span><span class="annot"><span class="annottext">SumArity
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span>
</span><span id="line-2762"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isPromotedTupleTyCon"><span class="hs-identifier hs-var">isPromotedTupleTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161573"><span class="hs-identifier hs-var">tc</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SumArity -&gt; Type
</span><span class="hs-identifier hs-var">TH.PromotedTupleT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SumArity
</span><a href="#local-6989586621683161578"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="annot"><span class="annottext">SumArity -&gt; SumArity -&gt; SumArity
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`div`</span></span><span> </span><span class="annot"><span class="annottext">SumArity
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span>
</span><span id="line-2763"></span><span>             </span><span class="hs-comment">-- See Note [Unboxed tuple RuntimeRep vars] in GHC.Core.TyCon</span><span>
</span><span id="line-2764"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isTupleTyCon"><span class="hs-identifier hs-var">isTupleTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161573"><span class="hs-identifier hs-var">tc</span></a></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isPromotedDataCon"><span class="hs-identifier hs-var">isPromotedDataCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161573"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-2765"></span><span>                                            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">SumArity -&gt; Type
</span><span class="hs-identifier hs-var">TH.PromotedTupleT</span></span><span> </span><span class="annot"><span class="annottext">SumArity
</span><a href="#local-6989586621683161578"><span class="hs-identifier hs-var">arity</span></a></span><span>
</span><span id="line-2766"></span><span>                                            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SumArity -&gt; Type
</span><span class="hs-identifier hs-var">TH.TupleT</span></span><span> </span><span class="annot"><span class="annottext">SumArity
</span><a href="#local-6989586621683161578"><span class="hs-identifier hs-var">arity</span></a></span><span>
</span><span id="line-2767"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161573"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#constraintKindTyConKey"><span class="hs-identifier hs-var">constraintKindTyConKey</span></a></span><span>
</span><span id="line-2768"></span><span>                                          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier hs-var">TH.ConstraintT</span></span><span>
</span><span id="line-2769"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161573"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#unrestrictedFunTyConKey"><span class="hs-identifier hs-var">unrestrictedFunTyConKey</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier hs-var">TH.ArrowT</span></span><span>
</span><span id="line-2770"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161573"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#listTyConKey"><span class="hs-identifier hs-var">listTyConKey</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier hs-var">TH.ListT</span></span><span>
</span><span id="line-2771"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161573"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#nilDataConKey"><span class="hs-identifier hs-var">nilDataConKey</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier hs-var">TH.PromotedNilT</span></span><span>
</span><span id="line-2772"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161573"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#consDataConKey"><span class="hs-identifier hs-var">consDataConKey</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier hs-var">TH.PromotedConsT</span></span><span>
</span><span id="line-2773"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161573"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#heqTyConKey"><span class="hs-identifier hs-var">heqTyConKey</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier hs-var">TH.EqualityT</span></span><span>
</span><span id="line-2774"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161573"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#eqPrimTyConKey"><span class="hs-identifier hs-var">eqPrimTyConKey</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier hs-var">TH.EqualityT</span></span><span>
</span><span id="line-2775"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161573"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#eqReprPrimTyConKey"><span class="hs-identifier hs-var">eqReprPrimTyConKey</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Type
</span><span class="hs-identifier hs-var">TH.ConT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Name
forall n. NamedThing n =&gt; n -&gt; Name
</span><a href="GHC.Tc.Gen.Splice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="GHC.Builtin.Types.html#coercibleTyCon"><span class="hs-identifier hs-var">coercibleTyCon</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2776"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isDataKindsPromotedDataCon"><span class="hs-identifier hs-var">isDataKindsPromotedDataCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161573"><span class="hs-identifier hs-var">tc</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Type
</span><span class="hs-identifier hs-var">TH.PromotedT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Name
forall n. NamedThing n =&gt; n -&gt; Name
</span><a href="GHC.Tc.Gen.Splice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161573"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2777"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Type
</span><span class="hs-identifier hs-var">TH.ConT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Name
forall n. NamedThing n =&gt; n -&gt; Name
</span><a href="GHC.Tc.Gen.Splice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161573"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2778"></span><span>
</span><span id="line-2779"></span><span>    </span><span class="hs-comment">-- See Note [When does a tycon application need an explicit kind</span><span>
</span><span id="line-2780"></span><span>    </span><span class="hs-comment">-- signature?] in GHC.Core.TyCo.Rep</span><span>
</span><span id="line-2781"></span><span>    </span><span id="local-6989586621683161576"><span class="annot"><span class="annottext">maybe_sig_t :: Type -&gt; TcM Type
</span><a href="#local-6989586621683161576"><span class="hs-identifier hs-var hs-var">maybe_sig_t</span></a></span></span><span> </span><span id="local-6989586621683161597"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161597"><span class="hs-identifier hs-var">th_type</span></a></span></span><span>
</span><span id="line-2782"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TyCon -&gt; SumArity -&gt; Bool
</span><a href="GHC.Core.Type.html#tyConAppNeedsKindSig"><span class="hs-identifier hs-var">tyConAppNeedsKindSig</span></a></span><span>
</span><span id="line-2783"></span><span>          </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-comment">-- We don't reify types using visible kind applications, so</span><span>
</span><span id="line-2784"></span><span>                </span><span class="hs-comment">-- don't count specified binders as contributing towards</span><span>
</span><span id="line-2785"></span><span>                </span><span class="hs-comment">-- injective positions in the kind of the tycon.</span><span>
</span><span id="line-2786"></span><span>          </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161573"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type] -&gt; SumArity
forall a. [a] -&gt; SumArity
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; SumArity
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161574"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2787"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683161598"><span class="annot"><span class="annottext">full_kind :: Type
</span><a href="#local-6989586621683161598"><span class="hs-identifier hs-var hs-var hs-var">full_kind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Type
Type -&gt; Type
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; Type
</span><a href="GHC.Core.Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161573"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161574"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2788"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161599"><span class="annot"><a href="#local-6989586621683161599"><span class="hs-identifier hs-var">th_full_kind</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#reifyKind"><span class="hs-identifier hs-var">reifyKind</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161598"><span class="hs-identifier hs-var">full_kind</span></a></span><span>
</span><span id="line-2789"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.SigT</span></span><span> </span><span class="annot"><a href="#local-6989586621683161597"><span class="hs-identifier hs-type">th_type</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161599"><span class="hs-identifier hs-type">th_full_kind</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2790"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2791"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcM Type
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161597"><span class="hs-identifier hs-var">th_type</span></a></span><span>
</span><span id="line-2792"></span><span>
</span><span id="line-2793"></span><span class="hs-comment">------------------------------</span><span>
</span><span id="line-2794"></span><span id="local-6989586621683158687"><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyName"><span class="hs-identifier hs-type">reifyName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#NamedThing"><span class="hs-identifier hs-type">NamedThing</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683158687"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621683158687"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Name</span></span></span><span>
</span><span id="line-2795"></span><span id="reifyName"><span class="annot"><span class="annottext">reifyName :: forall n. NamedThing n =&gt; n -&gt; Name
</span><a href="GHC.Tc.Gen.Splice.html#reifyName"><span class="hs-identifier hs-var hs-var">reifyName</span></a></span></span><span> </span><span id="local-6989586621683161611"><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621683161611"><span class="hs-identifier hs-var">thing</span></a></span></span><span>
</span><span id="line-2796"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Bool
</span><a href="GHC.Types.Name.html#isExternalName"><span class="hs-identifier hs-var">isExternalName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161613"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-2797"></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String -&gt; Name
</span><a href="#local-6989586621683161614"><span class="hs-identifier hs-var">mk_varg</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683161615"><span class="hs-identifier hs-var">pkg_str</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683161616"><span class="hs-identifier hs-var">mod_str</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683161617"><span class="hs-identifier hs-var">occ_str</span></a></span><span>
</span><span id="line-2798"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Integer -&gt; Name
</span><span class="hs-identifier hs-var">TH.mkNameU</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683161617"><span class="hs-identifier hs-var">occ_str</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; Integer
forall a. Integral a =&gt; a -&gt; Integer
</span><span class="hs-identifier hs-var">toInteger</span></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; Integer) -&gt; Word64 -&gt; Integer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Unique -&gt; Word64
</span><a href="GHC.Types.Unique.html#getKey"><span class="hs-identifier hs-var">getKey</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Unique
forall a. Uniquable a =&gt; a -&gt; Unique
</span><a href="GHC.Types.Unique.html#getUnique"><span class="hs-identifier hs-var">getUnique</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161613"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2799"></span><span>        </span><span class="hs-comment">-- Many of the things we reify have local bindings, and</span><span>
</span><span id="line-2800"></span><span>        </span><span class="hs-comment">-- NameL's aren't supposed to appear in binding positions, so</span><span>
</span><span id="line-2801"></span><span>        </span><span class="hs-comment">-- we use NameU.  When/if we start to reify nested things, that</span><span>
</span><span id="line-2802"></span><span>        </span><span class="hs-comment">-- have free variables, we may need to generate NameL's for them.</span><span>
</span><span id="line-2803"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2804"></span><span>    </span><span id="local-6989586621683161613"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621683161613"><span class="hs-identifier hs-var hs-var">name</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">n -&gt; Name
forall a. NamedThing a =&gt; a -&gt; Name
</span><a href="GHC.Types.Name.html#getName"><span class="hs-identifier hs-var">getName</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621683161611"><span class="hs-identifier hs-var">thing</span></a></span><span>
</span><span id="line-2805"></span><span>    </span><span id="local-6989586621683161619"><span class="annot"><span class="annottext">mod :: GenModule Unit
</span><a href="#local-6989586621683161619"><span class="hs-identifier hs-var hs-var">mod</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; GenModule Unit -&gt; GenModule Unit
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Bool
</span><a href="GHC.Types.Name.html#isExternalName"><span class="hs-identifier hs-var">isExternalName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161613"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(GenModule Unit -&gt; GenModule Unit)
-&gt; GenModule Unit -&gt; GenModule Unit
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Name -&gt; GenModule Unit
Name -&gt; GenModule Unit
</span><a href="GHC.Types.Name.html#nameModule"><span class="hs-identifier hs-var">nameModule</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161613"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-2806"></span><span>    </span><span id="local-6989586621683161615"><span class="annot"><span class="annottext">pkg_str :: String
</span><a href="#local-6989586621683161615"><span class="hs-identifier hs-var hs-var">pkg_str</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unit -&gt; String
forall u. IsUnitId u =&gt; u -&gt; String
</span><a href="GHC.Unit.Types.html#unitString"><span class="hs-identifier hs-var">unitString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GenModule Unit -&gt; Unit
forall unit. GenModule unit -&gt; unit
</span><a href="GHC.Unit.Types.html#moduleUnit"><span class="hs-identifier hs-var">moduleUnit</span></a></span><span> </span><span class="annot"><span class="annottext">GenModule Unit
</span><a href="#local-6989586621683161619"><span class="hs-identifier hs-var">mod</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2807"></span><span>    </span><span id="local-6989586621683161616"><span class="annot"><span class="annottext">mod_str :: String
</span><a href="#local-6989586621683161616"><span class="hs-identifier hs-var hs-var">mod_str</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ModuleName -&gt; String
</span><a href="Language.Haskell.Syntax.Module.Name.html#moduleNameString"><span class="hs-identifier hs-var">moduleNameString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GenModule Unit -&gt; ModuleName
forall unit. GenModule unit -&gt; ModuleName
</span><a href="GHC.Unit.Types.html#moduleName"><span class="hs-identifier hs-var">moduleName</span></a></span><span> </span><span class="annot"><span class="annottext">GenModule Unit
</span><a href="#local-6989586621683161619"><span class="hs-identifier hs-var">mod</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2808"></span><span>    </span><span id="local-6989586621683161617"><span class="annot"><span class="annottext">occ_str :: String
</span><a href="#local-6989586621683161617"><span class="hs-identifier hs-var hs-var">occ_str</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccName -&gt; String
</span><a href="GHC.Types.Name.Occurrence.html#occNameString"><span class="hs-identifier hs-var">occNameString</span></a></span><span> </span><span class="annot"><span class="annottext">OccName
</span><a href="#local-6989586621683161622"><span class="hs-identifier hs-var">occ</span></a></span><span>
</span><span id="line-2809"></span><span>    </span><span id="local-6989586621683161622"><span class="annot"><span class="annottext">occ :: OccName
</span><a href="#local-6989586621683161622"><span class="hs-identifier hs-var hs-var">occ</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; OccName
</span><a href="GHC.Types.Name.html#nameOccName"><span class="hs-identifier hs-var">nameOccName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161613"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-2810"></span><span>    </span><span id="local-6989586621683161614"><span class="annot"><span class="annottext">mk_varg :: String -&gt; String -&gt; String -&gt; Name
</span><a href="#local-6989586621683161614"><span class="hs-identifier hs-var hs-var">mk_varg</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">OccName -&gt; Bool
</span><a href="GHC.Types.Name.Occurrence.html#isDataOcc"><span class="hs-identifier hs-var">OccName.isDataOcc</span></a></span><span> </span><span class="annot"><span class="annottext">OccName
</span><a href="#local-6989586621683161622"><span class="hs-identifier hs-var">occ</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String -&gt; Name
</span><span class="hs-identifier hs-var">TH.mkNameG_d</span></span><span>
</span><span id="line-2811"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">OccName -&gt; Bool
</span><a href="GHC.Types.Name.Occurrence.html#isVarOcc"><span class="hs-identifier hs-var">OccName.isVarOcc</span></a></span><span>  </span><span class="annot"><span class="annottext">OccName
</span><a href="#local-6989586621683161622"><span class="hs-identifier hs-var">occ</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String -&gt; Name
</span><span class="hs-identifier hs-var">TH.mkNameG_v</span></span><span>
</span><span id="line-2812"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">OccName -&gt; Bool
</span><a href="GHC.Types.Name.Occurrence.html#isTcOcc"><span class="hs-identifier hs-var">OccName.isTcOcc</span></a></span><span>   </span><span class="annot"><span class="annottext">OccName
</span><a href="#local-6989586621683161622"><span class="hs-identifier hs-var">occ</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String -&gt; Name
</span><span class="hs-identifier hs-var">TH.mkNameG_tc</span></span><span>
</span><span id="line-2813"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683161627"><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683161627"><span class="hs-identifier hs-var">con_fs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OccName -&gt; Maybe FastString
</span><a href="GHC.Types.Name.Occurrence.html#fieldOcc_maybe"><span class="hs-identifier hs-var">OccName.fieldOcc_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">OccName
</span><a href="#local-6989586621683161622"><span class="hs-identifier hs-var">occ</span></a></span><span>
</span><span id="line-2814"></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621683161629"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683161629"><span class="hs-identifier hs-var">pkg</span></a></span></span><span> </span><span id="local-6989586621683161630"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683161630"><span class="hs-identifier hs-var">mod</span></a></span></span><span> </span><span id="local-6989586621683161631"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683161631"><span class="hs-identifier hs-var">occ</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String -&gt; String -&gt; Name
</span><span class="hs-identifier hs-var">TH.mkNameG_fld</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683161629"><span class="hs-identifier hs-var">pkg</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683161630"><span class="hs-identifier hs-var">mod</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FastString -&gt; String
</span><a href="GHC.Data.FastString.html#unpackFS"><span class="hs-identifier hs-var">unpackFS</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683161627"><span class="hs-identifier hs-var">con_fs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683161631"><span class="hs-identifier hs-var">occ</span></a></span><span>
</span><span id="line-2815"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; String -&gt; String -&gt; String -&gt; Name
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;reifyName&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161613"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2816"></span><span>
</span><span id="line-2817"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyFieldLabel"><span class="hs-identifier hs-type">reifyFieldLabel</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.FieldLabel.html#FieldLabel"><span class="hs-identifier hs-type">FieldLabel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Name</span></span><span>
</span><span id="line-2818"></span><span id="reifyFieldLabel"><span class="annot"><span class="annottext">reifyFieldLabel :: FieldLabel -&gt; Name
</span><a href="GHC.Tc.Gen.Splice.html#reifyFieldLabel"><span class="hs-identifier hs-var hs-var">reifyFieldLabel</span></a></span></span><span> </span><span id="local-6989586621683161632"><span class="annot"><span class="annottext">FieldLabel
</span><a href="#local-6989586621683161632"><span class="hs-identifier hs-var">fl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name
forall n. NamedThing n =&gt; n -&gt; Name
</span><a href="GHC.Tc.Gen.Splice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Name) -&gt; Name -&gt; Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FieldLabel -&gt; Name
</span><a href="GHC.Types.FieldLabel.html#flSelector"><span class="hs-identifier hs-var">flSelector</span></a></span><span> </span><span class="annot"><span class="annottext">FieldLabel
</span><a href="#local-6989586621683161632"><span class="hs-identifier hs-var">fl</span></a></span><span>
</span><span id="line-2819"></span><span>
</span><span id="line-2820"></span><span class="hs-comment">------------------------------</span><span>
</span><span id="line-2821"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyFixity"><span class="hs-identifier hs-type">reifyFixity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Fixity</span></span><span class="hs-special">)</span><span>
</span><span id="line-2822"></span><span id="reifyFixity"><span class="annot"><span class="annottext">reifyFixity :: Name -&gt; TcM (Maybe Fixity)
</span><a href="GHC.Tc.Gen.Splice.html#reifyFixity"><span class="hs-identifier hs-var hs-var">reifyFixity</span></a></span></span><span> </span><span id="local-6989586621683161634"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161634"><span class="hs-identifier hs-var">name</span></a></span></span><span>
</span><span id="line-2823"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683161635"><span class="annot"><a href="#local-6989586621683161635"><span class="hs-identifier hs-var">found</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683161636"><span class="annot"><a href="#local-6989586621683161636"><span class="hs-identifier hs-var">fix</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; RnM (Bool, Fixity)
</span><a href="GHC.Rename.Fixity.html#lookupFixityRn_help"><span class="hs-identifier hs-var">lookupFixityRn_help</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161634"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-2824"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621683161635"><span class="hs-identifier hs-type">found</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683161637"><span class="hs-identifier hs-type">conv_fix</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161636"><span class="hs-identifier hs-type">fix</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2825"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-2826"></span><span>      </span><span id="local-6989586621683161637"><span class="annot"><span class="annottext">conv_fix :: Fixity -&gt; Fixity
</span><a href="#local-6989586621683161637"><span class="hs-identifier hs-var hs-var">conv_fix</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Fixity"><span class="hs-identifier hs-type">Hs.Fixity</span></a></span><span> </span><span id="local-6989586621683161639"><span class="annot"><span class="annottext">SumArity
</span><a href="#local-6989586621683161639"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621683161640"><span class="annot"><span class="annottext">FixityDirection
</span><a href="#local-6989586621683161640"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SumArity -&gt; FixityDirection -&gt; Fixity
</span><span class="hs-identifier hs-var">TH.Fixity</span></span><span> </span><span class="annot"><span class="annottext">SumArity
</span><a href="#local-6989586621683161639"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FixityDirection -&gt; FixityDirection
</span><a href="#local-6989586621683161642"><span class="hs-identifier hs-var">conv_dir</span></a></span><span> </span><span class="annot"><span class="annottext">FixityDirection
</span><a href="#local-6989586621683161640"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2827"></span><span>      </span><span id="local-6989586621683161642"><span class="annot"><span class="annottext">conv_dir :: FixityDirection -&gt; FixityDirection
</span><a href="#local-6989586621683161642"><span class="hs-identifier hs-var hs-var">conv_dir</span></a></span></span><span> </span><span class="annot"><span class="annottext">FixityDirection
</span><a href="Language.Haskell.Syntax.Basic.html#InfixR"><span class="hs-identifier hs-var">Hs.InfixR</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FixityDirection
</span><span class="hs-identifier hs-var">TH.InfixR</span></span><span>
</span><span id="line-2828"></span><span>      </span><span class="annot"><a href="#local-6989586621683161642"><span class="hs-identifier hs-var">conv_dir</span></a></span><span> </span><span class="annot"><span class="annottext">FixityDirection
</span><a href="Language.Haskell.Syntax.Basic.html#InfixL"><span class="hs-identifier hs-var">Hs.InfixL</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FixityDirection
</span><span class="hs-identifier hs-var">TH.InfixL</span></span><span>
</span><span id="line-2829"></span><span>      </span><span class="annot"><a href="#local-6989586621683161642"><span class="hs-identifier hs-var">conv_dir</span></a></span><span> </span><span class="annot"><span class="annottext">FixityDirection
</span><a href="Language.Haskell.Syntax.Basic.html#InfixN"><span class="hs-identifier hs-var">Hs.InfixN</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FixityDirection
</span><span class="hs-identifier hs-var">TH.InfixN</span></span><span>
</span><span id="line-2830"></span><span>
</span><span id="line-2831"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyUnpackedness"><span class="hs-identifier hs-type">reifyUnpackedness</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#SrcUnpackedness"><span class="hs-identifier hs-type">DataCon.SrcUnpackedness</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.SourceUnpackedness</span></span><span>
</span><span id="line-2832"></span><span id="reifyUnpackedness"><span class="annot"><span class="annottext">reifyUnpackedness :: SrcUnpackedness -&gt; SourceUnpackedness
</span><a href="GHC.Tc.Gen.Splice.html#reifyUnpackedness"><span class="hs-identifier hs-var hs-var">reifyUnpackedness</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcUnpackedness
</span><a href="Language.Haskell.Syntax.Basic.html#NoSrcUnpack"><span class="hs-identifier hs-var">NoSrcUnpack</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SourceUnpackedness
</span><span class="hs-identifier hs-var">TH.NoSourceUnpackedness</span></span><span>
</span><span id="line-2833"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyUnpackedness"><span class="hs-identifier hs-var">reifyUnpackedness</span></a></span><span> </span><span class="annot"><span class="annottext">SrcUnpackedness
</span><a href="Language.Haskell.Syntax.Basic.html#SrcNoUnpack"><span class="hs-identifier hs-var">SrcNoUnpack</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SourceUnpackedness
</span><span class="hs-identifier hs-var">TH.SourceNoUnpack</span></span><span>
</span><span id="line-2834"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyUnpackedness"><span class="hs-identifier hs-var">reifyUnpackedness</span></a></span><span> </span><span class="annot"><span class="annottext">SrcUnpackedness
</span><a href="Language.Haskell.Syntax.Basic.html#SrcUnpack"><span class="hs-identifier hs-var">SrcUnpack</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SourceUnpackedness
</span><span class="hs-identifier hs-var">TH.SourceUnpack</span></span><span>
</span><span id="line-2835"></span><span>
</span><span id="line-2836"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyStrictness"><span class="hs-identifier hs-type">reifyStrictness</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#SrcStrictness"><span class="hs-identifier hs-type">DataCon.SrcStrictness</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.SourceStrictness</span></span><span>
</span><span id="line-2837"></span><span id="reifyStrictness"><span class="annot"><span class="annottext">reifyStrictness :: SrcStrictness -&gt; SourceStrictness
</span><a href="GHC.Tc.Gen.Splice.html#reifyStrictness"><span class="hs-identifier hs-var hs-var">reifyStrictness</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcStrictness
</span><a href="Language.Haskell.Syntax.Basic.html#NoSrcStrict"><span class="hs-identifier hs-var">NoSrcStrict</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SourceStrictness
</span><span class="hs-identifier hs-var">TH.NoSourceStrictness</span></span><span>
</span><span id="line-2838"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyStrictness"><span class="hs-identifier hs-var">reifyStrictness</span></a></span><span> </span><span class="annot"><span class="annottext">SrcStrictness
</span><a href="Language.Haskell.Syntax.Basic.html#SrcStrict"><span class="hs-identifier hs-var">SrcStrict</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SourceStrictness
</span><span class="hs-identifier hs-var">TH.SourceStrict</span></span><span>
</span><span id="line-2839"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyStrictness"><span class="hs-identifier hs-var">reifyStrictness</span></a></span><span> </span><span class="annot"><span class="annottext">SrcStrictness
</span><a href="Language.Haskell.Syntax.Basic.html#SrcLazy"><span class="hs-identifier hs-var">SrcLazy</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SourceStrictness
</span><span class="hs-identifier hs-var">TH.SourceLazy</span></span><span>
</span><span id="line-2840"></span><span>
</span><span id="line-2841"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifySourceBang"><span class="hs-identifier hs-type">reifySourceBang</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#HsSrcBang"><span class="hs-identifier hs-type">DataCon.HsSrcBang</span></a></span><span>
</span><span id="line-2842"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.SourceUnpackedness</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.SourceStrictness</span></span><span class="hs-special">)</span><span>
</span><span id="line-2843"></span><span id="reifySourceBang"><span class="annot"><span class="annottext">reifySourceBang :: HsSrcBang -&gt; (SourceUnpackedness, SourceStrictness)
</span><a href="GHC.Tc.Gen.Splice.html#reifySourceBang"><span class="hs-identifier hs-var hs-var">reifySourceBang</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.DataCon.html#HsSrcBang"><span class="hs-identifier hs-type">HsSrcBang</span></a></span><span> </span><span class="annot"><span class="annottext">SourceText
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#HsBang"><span class="hs-identifier hs-type">HsBang</span></a></span><span> </span><span id="local-6989586621683161665"><span class="annot"><span class="annottext">SrcUnpackedness
</span><a href="#local-6989586621683161665"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span id="local-6989586621683161666"><span class="annot"><span class="annottext">SrcStrictness
</span><a href="#local-6989586621683161666"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SrcUnpackedness -&gt; SourceUnpackedness
</span><a href="GHC.Tc.Gen.Splice.html#reifyUnpackedness"><span class="hs-identifier hs-var">reifyUnpackedness</span></a></span><span> </span><span class="annot"><span class="annottext">SrcUnpackedness
</span><a href="#local-6989586621683161665"><span class="hs-identifier hs-var">u</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SrcStrictness -&gt; SourceStrictness
</span><a href="GHC.Tc.Gen.Splice.html#reifyStrictness"><span class="hs-identifier hs-var">reifyStrictness</span></a></span><span> </span><span class="annot"><span class="annottext">SrcStrictness
</span><a href="#local-6989586621683161666"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2844"></span><span>
</span><span id="line-2845"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyDecidedStrictness"><span class="hs-identifier hs-type">reifyDecidedStrictness</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#HsImplBang"><span class="hs-identifier hs-type">DataCon.HsImplBang</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.DecidedStrictness</span></span><span>
</span><span id="line-2846"></span><span id="reifyDecidedStrictness"><span class="annot"><span class="annottext">reifyDecidedStrictness :: HsImplBang -&gt; DecidedStrictness
</span><a href="GHC.Tc.Gen.Splice.html#reifyDecidedStrictness"><span class="hs-identifier hs-var hs-var">reifyDecidedStrictness</span></a></span></span><span> </span><span class="annot"><span class="annottext">HsImplBang
</span><a href="GHC.Core.DataCon.html#HsLazy"><span class="hs-identifier hs-var">HsLazy</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DecidedStrictness
</span><span class="hs-identifier hs-var">TH.DecidedLazy</span></span><span>
</span><span id="line-2847"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyDecidedStrictness"><span class="hs-identifier hs-var">reifyDecidedStrictness</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.DataCon.html#HsStrict"><span class="hs-identifier hs-type">HsStrict</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DecidedStrictness
</span><span class="hs-identifier hs-var">TH.DecidedStrict</span></span><span>
</span><span id="line-2848"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyDecidedStrictness"><span class="hs-identifier hs-var">reifyDecidedStrictness</span></a></span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#HsUnpack"><span class="hs-identifier hs-type">HsUnpack</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DecidedStrictness
</span><span class="hs-identifier hs-var">TH.DecidedUnpack</span></span><span>
</span><span id="line-2849"></span><span>
</span><span id="line-2850"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyTypeOfThing"><span class="hs-identifier hs-type">reifyTypeOfThing</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Type</span></span><span>
</span><span id="line-2851"></span><span id="reifyTypeOfThing"><span class="annot"><span class="annottext">reifyTypeOfThing :: Name -&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#reifyTypeOfThing"><span class="hs-identifier hs-var hs-var">reifyTypeOfThing</span></a></span></span><span> </span><span id="local-6989586621683161673"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161673"><span class="hs-identifier hs-var">th_name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2852"></span><span>  </span><span id="local-6989586621683161674"><span class="annot"><a href="#local-6989586621683161674"><span class="hs-identifier hs-var">thing</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcM TcTyThing
</span><a href="GHC.Tc.Gen.Splice.html#getThing"><span class="hs-identifier hs-var">getThing</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161673"><span class="hs-identifier hs-var">th_name</span></a></span><span>
</span><span id="line-2853"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683161674"><span class="hs-identifier hs-type">thing</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2854"></span><span>    </span><span class="annot"><a href="GHC.Tc.Types.BasicTypes.html#AGlobal"><span class="hs-identifier hs-type">AGlobal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.TyThing.html#AnId"><span class="hs-identifier hs-type">AnId</span></a></span><span> </span><span id="local-6989586621683161675"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621683161675"><span class="hs-identifier hs-var">id</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621683161675"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2855"></span><span>    </span><span class="annot"><a href="GHC.Tc.Types.BasicTypes.html#AGlobal"><span class="hs-identifier hs-type">AGlobal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.TyThing.html#ATyCon"><span class="hs-identifier hs-type">ATyCon</span></a></span><span> </span><span id="local-6989586621683161676"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161676"><span class="hs-identifier hs-var">tc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#reifyKind"><span class="hs-identifier hs-var">reifyKind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Type
</span><a href="GHC.Core.TyCon.html#tyConKind"><span class="hs-identifier hs-var">tyConKind</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683161676"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2856"></span><span>    </span><span class="annot"><a href="GHC.Tc.Types.BasicTypes.html#AGlobal"><span class="hs-identifier hs-type">AGlobal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.TyThing.html#AConLike"><span class="hs-identifier hs-type">AConLike</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.ConLike.html#RealDataCon"><span class="hs-identifier hs-type">RealDataCon</span></a></span><span> </span><span id="local-6989586621683161678"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621683161678"><span class="hs-identifier hs-var">dc</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2857"></span><span>      </span><span class="annot"><span class="annottext">Type -&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; TyVar
</span><a href="GHC.Core.DataCon.html#dataConWrapId"><span class="hs-identifier hs-var">dataConWrapId</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621683161678"><span class="hs-identifier hs-var">dc</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2858"></span><span>    </span><span class="annot"><a href="GHC.Tc.Types.BasicTypes.html#AGlobal"><span class="hs-identifier hs-type">AGlobal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.TyThing.html#AConLike"><span class="hs-identifier hs-type">AConLike</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.ConLike.html#PatSynCon"><span class="hs-identifier hs-type">PatSynCon</span></a></span><span> </span><span id="local-6989586621683161679"><span class="annot"><span class="annottext">PatSyn
</span><a href="#local-6989586621683161679"><span class="hs-identifier hs-var">ps</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2859"></span><span>      </span><span class="annot"><span class="annottext">([InvisTVBinder], [Type], [InvisTVBinder], [Type], [Scaled Type],
 Type)
-&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#reifyPatSynType"><span class="hs-identifier hs-var">reifyPatSynType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatSyn
-&gt; ([InvisTVBinder], [Type], [InvisTVBinder], [Type],
    [Scaled Type], Type)
</span><a href="GHC.Core.PatSyn.html#patSynSigBndr"><span class="hs-identifier hs-var">patSynSigBndr</span></a></span><span> </span><span class="annot"><span class="annottext">PatSyn
</span><a href="#local-6989586621683161679"><span class="hs-identifier hs-var">ps</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2860"></span><span>    </span><span class="annot"><a href="GHC.Tc.Types.BasicTypes.html#ATcId"><span class="hs-identifier hs-type">ATcId</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">tct_id :: TcTyThing -&gt; TyVar
</span><a href="GHC.Tc.Types.BasicTypes.html#tct_id"><span class="hs-identifier hs-var">tct_id</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683161680"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621683161680"><span class="hs-identifier hs-var">id</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ZonkM Type -&gt; IOEnv (Env TcGblEnv TcLclEnv) Type
forall a. ZonkM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#liftZonkM"><span class="hs-identifier hs-var">liftZonkM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; ZonkM Type
</span><a href="GHC.Tc.Zonk.TcType.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621683161680"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IOEnv (Env TcGblEnv TcLclEnv) Type
-&gt; (Type -&gt; TcM Type) -&gt; TcM Type
forall a b.
IOEnv (Env TcGblEnv TcLclEnv) a
-&gt; (a -&gt; IOEnv (Env TcGblEnv TcLclEnv) b)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a></span><span>
</span><span id="line-2861"></span><span>    </span><span class="annot"><a href="GHC.Tc.Types.BasicTypes.html#ATyVar"><span class="hs-identifier hs-type">ATyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683161681"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621683161681"><span class="hs-identifier hs-var">tctv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ZonkM Type -&gt; IOEnv (Env TcGblEnv TcLclEnv) Type
forall a. ZonkM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#liftZonkM"><span class="hs-identifier hs-var">liftZonkM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; ZonkM Type
</span><a href="GHC.Tc.Zonk.TcType.html#zonkTcTyVar"><span class="hs-identifier hs-var">zonkTcTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621683161681"><span class="hs-identifier hs-var">tctv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IOEnv (Env TcGblEnv TcLclEnv) Type
-&gt; (Type -&gt; TcM Type) -&gt; TcM Type
forall a b.
IOEnv (Env TcGblEnv TcLclEnv) a
-&gt; (a -&gt; IOEnv (Env TcGblEnv TcLclEnv) b)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcM Type
</span><a href="GHC.Tc.Gen.Splice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a></span><span>
</span><span id="line-2862"></span><span>    </span><span class="hs-comment">-- Impossible cases, supposedly:</span><span>
</span><span id="line-2863"></span><span>    </span><span class="annot"><a href="GHC.Tc.Types.BasicTypes.html#AGlobal"><span class="hs-identifier hs-type">AGlobal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.TyThing.html#ACoAxiom"><span class="hs-identifier hs-type">ACoAxiom</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiom Branched
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; TcM Type
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;reifyTypeOfThing: ACoAxiom&quot;</span></span><span>
</span><span id="line-2864"></span><span>    </span><span class="annot"><a href="GHC.Tc.Types.BasicTypes.html#ATcTyCon"><span class="hs-identifier hs-type">ATcTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; TcM Type
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;reifyTypeOfThing: ATcTyCon&quot;</span></span><span>
</span><span id="line-2865"></span><span>    </span><span class="annot"><a href="GHC.Tc.Types.BasicTypes.html#APromotionErr"><span class="hs-identifier hs-type">APromotionErr</span></a></span><span> </span><span class="annot"><span class="annottext">PromotionErr
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; TcM Type
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;reifyTypeOfThing: APromotionErr&quot;</span></span><span>
</span><span id="line-2866"></span><span>
</span><span id="line-2867"></span><span class="hs-comment">------------------------------</span><span>
</span><span id="line-2868"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#lookupThAnnLookup"><span class="hs-identifier hs-type">lookupThAnnLookup</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.AnnLookup</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Annotations.html#CoreAnnTarget"><span class="hs-identifier hs-type">CoreAnnTarget</span></a></span><span>
</span><span id="line-2869"></span><span id="lookupThAnnLookup"><span class="annot"><span class="annottext">lookupThAnnLookup :: AnnLookup -&gt; TcM CoreAnnTarget
</span><a href="GHC.Tc.Gen.Splice.html#lookupThAnnLookup"><span class="hs-identifier hs-var hs-var">lookupThAnnLookup</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.AnnLookupName</span></span><span> </span><span id="local-6989586621683161686"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161686"><span class="hs-identifier hs-var">th_nm</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; CoreAnnTarget) -&gt; TcM Name -&gt; TcM CoreAnnTarget
forall a b.
(a -&gt; b)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) a
-&gt; IOEnv (Env TcGblEnv TcLclEnv) b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; CoreAnnTarget
forall name. name -&gt; AnnTarget name
</span><a href="GHC.Types.Annotations.html#NamedTarget"><span class="hs-identifier hs-var">NamedTarget</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; TcM Name
</span><a href="GHC.Tc.Gen.Splice.html#lookupThName"><span class="hs-identifier hs-var">lookupThName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683161686"><span class="hs-identifier hs-var">th_nm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2870"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#lookupThAnnLookup"><span class="hs-identifier hs-var">lookupThAnnLookup</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.AnnLookupModule</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.Module</span></span><span> </span><span id="local-6989586621683161690"><span class="annot"><span class="annottext">PkgName
</span><a href="#local-6989586621683161690"><span class="hs-identifier hs-var">pn</span></a></span></span><span> </span><span id="local-6989586621683161691"><span class="annot"><span class="annottext">ModName
</span><a href="#local-6989586621683161691"><span class="hs-identifier hs-var">mn</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2871"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreAnnTarget -&gt; TcM CoreAnnTarget
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(CoreAnnTarget -&gt; TcM CoreAnnTarget)
-&gt; CoreAnnTarget -&gt; TcM CoreAnnTarget
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">GenModule Unit -&gt; CoreAnnTarget
forall name. GenModule Unit -&gt; AnnTarget name
</span><a href="GHC.Types.Annotations.html#ModuleTarget"><span class="hs-identifier hs-var">ModuleTarget</span></a></span><span> </span><span class="annot"><span class="annottext">(GenModule Unit -&gt; CoreAnnTarget)
-&gt; GenModule Unit -&gt; CoreAnnTarget
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2872"></span><span>    </span><span class="annot"><span class="annottext">Unit -&gt; ModuleName -&gt; GenModule Unit
forall u. u -&gt; ModuleName -&gt; GenModule u
</span><a href="GHC.Unit.Types.html#mkModule"><span class="hs-identifier hs-var">mkModule</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Unit
</span><a href="GHC.Unit.Types.html#stringToUnit"><span class="hs-identifier hs-var">stringToUnit</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Unit) -&gt; String -&gt; Unit
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PkgName -&gt; String
</span><span class="hs-identifier hs-var">TH.pkgString</span></span><span> </span><span class="annot"><span class="annottext">PkgName
</span><a href="#local-6989586621683161690"><span class="hs-identifier hs-var">pn</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; ModuleName
</span><a href="Language.Haskell.Syntax.Module.Name.html#mkModuleName"><span class="hs-identifier hs-var">mkModuleName</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; ModuleName) -&gt; String -&gt; ModuleName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ModName -&gt; String
</span><span class="hs-identifier hs-var">TH.modString</span></span><span> </span><span class="annot"><span class="annottext">ModName
</span><a href="#local-6989586621683161691"><span class="hs-identifier hs-var">mn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2873"></span><span>
</span><span id="line-2874"></span><span id="local-6989586621683161697"><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyAnnotations"><span class="hs-identifier hs-type">reifyAnnotations</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Data</span></span><span> </span><span class="annot"><a href="#local-6989586621683161697"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.AnnLookup</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621683161697"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-2875"></span><span id="reifyAnnotations"><span class="annot"><span class="annottext">reifyAnnotations :: forall a. Data a =&gt; AnnLookup -&gt; TcM [a]
</span><a href="GHC.Tc.Gen.Splice.html#reifyAnnotations"><span class="hs-identifier hs-var hs-var">reifyAnnotations</span></a></span></span><span> </span><span id="local-6989586621683161710"><span class="annot"><span class="annottext">AnnLookup
</span><a href="#local-6989586621683161710"><span class="hs-identifier hs-var">th_name</span></a></span></span><span>
</span><span id="line-2876"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683161711"><span class="annot"><a href="#local-6989586621683161711"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AnnLookup -&gt; TcM CoreAnnTarget
</span><a href="GHC.Tc.Gen.Splice.html#lookupThAnnLookup"><span class="hs-identifier hs-var">lookupThAnnLookup</span></a></span><span> </span><span class="annot"><span class="annottext">AnnLookup
</span><a href="#local-6989586621683161710"><span class="hs-identifier hs-var">th_name</span></a></span><span>
</span><span id="line-2877"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161712"><span class="annot"><a href="#local-6989586621683161712"><span class="hs-identifier hs-var">topEnv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#getTopEnv"><span class="hs-identifier hs-type">getTopEnv</span></a></span><span>
</span><span id="line-2878"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161713"><span class="annot"><a href="#local-6989586621683161713"><span class="hs-identifier hs-var">epsHptAnns</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Driver.Env.html#prepareAnnotations"><span class="hs-identifier hs-type">prepareAnnotations</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161712"><span class="hs-identifier hs-type">topEnv</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span>
</span><span id="line-2879"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683161714"><span class="annot"><a href="#local-6989586621683161714"><span class="hs-identifier hs-var">tcg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#getGblEnv"><span class="hs-identifier hs-type">getGblEnv</span></a></span><span>
</span><span id="line-2880"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683161715"><span class="annot"><a href="#local-6989586621683161715"><span class="hs-identifier hs-var hs-var">selectedEpsHptAnns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([Word8] -&gt; a) -&gt; AnnEnv -&gt; CoreAnnTarget -&gt; [a]
forall a.
Typeable a =&gt;
([Word8] -&gt; a) -&gt; AnnEnv -&gt; CoreAnnTarget -&gt; [a]
</span><a href="GHC.Types.Annotations.html#findAnns"><span class="hs-identifier hs-var">findAnns</span></a></span><span> </span><span class="annot"><span class="annottext">[Word8] -&gt; a
forall a. Data a =&gt; [Word8] -&gt; a
</span><a href="../../ghc-boot-9.12.2-1a37/src/GHC.Serialized.html#deserializeWithData"><span class="hs-identifier hs-var">deserializeWithData</span></a></span><span> </span><span class="annot"><span class="annottext">AnnEnv
</span><a href="#local-6989586621683161713"><span class="hs-identifier hs-var">epsHptAnns</span></a></span><span> </span><span class="annot"><span class="annottext">CoreAnnTarget
</span><a href="#local-6989586621683161711"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-2881"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683161718"><span class="annot"><a href="#local-6989586621683161718"><span class="hs-identifier hs-var hs-var">selectedTcgAnns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([Word8] -&gt; a) -&gt; AnnEnv -&gt; CoreAnnTarget -&gt; [a]
forall a.
Typeable a =&gt;
([Word8] -&gt; a) -&gt; AnnEnv -&gt; CoreAnnTarget -&gt; [a]
</span><a href="GHC.Types.Annotations.html#findAnns"><span class="hs-identifier hs-var">findAnns</span></a></span><span> </span><span class="annot"><span class="annottext">[Word8] -&gt; a
forall a. Data a =&gt; [Word8] -&gt; a
</span><a href="../../ghc-boot-9.12.2-1a37/src/GHC.Serialized.html#deserializeWithData"><span class="hs-identifier hs-var">deserializeWithData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcGblEnv -&gt; AnnEnv
</span><a href="GHC.Tc.Types.html#tcg_ann_env"><span class="hs-identifier hs-var">tcg_ann_env</span></a></span><span> </span><span class="annot"><span class="annottext">TcGblEnv
</span><a href="#local-6989586621683161714"><span class="hs-identifier hs-var">tcg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreAnnTarget
</span><a href="#local-6989586621683161711"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-2882"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683161715"><span class="hs-identifier hs-type">selectedEpsHptAnns</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621683161718"><span class="hs-identifier hs-type">selectedTcgAnns</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2883"></span><span>
</span><span id="line-2884"></span><span class="hs-comment">------------------------------</span><span>
</span><span id="line-2885"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#modToTHMod"><span class="hs-identifier hs-type">modToTHMod</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Unit.Types.html#Module"><span class="hs-identifier hs-type">Module</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Module</span></span><span>
</span><span id="line-2886"></span><span id="modToTHMod"><span class="annot"><span class="annottext">modToTHMod :: GenModule Unit -&gt; Module
</span><a href="GHC.Tc.Gen.Splice.html#modToTHMod"><span class="hs-identifier hs-var hs-var">modToTHMod</span></a></span></span><span> </span><span id="local-6989586621683161721"><span class="annot"><span class="annottext">GenModule Unit
</span><a href="#local-6989586621683161721"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PkgName -&gt; ModName -&gt; Module
</span><span class="hs-identifier hs-var">TH.Module</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; PkgName
</span><span class="hs-identifier hs-var">TH.PkgName</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; PkgName) -&gt; String -&gt; PkgName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Unit -&gt; String
forall u. IsUnitId u =&gt; u -&gt; String
</span><a href="GHC.Unit.Types.html#unitString"><span class="hs-identifier hs-var">unitString</span></a></span><span>  </span><span class="annot"><span class="annottext">(Unit -&gt; String) -&gt; Unit -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">GenModule Unit -&gt; Unit
forall unit. GenModule unit -&gt; unit
</span><a href="GHC.Unit.Types.html#moduleUnit"><span class="hs-identifier hs-var">moduleUnit</span></a></span><span> </span><span class="annot"><span class="annottext">GenModule Unit
</span><a href="#local-6989586621683161721"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2887"></span><span>                         </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; ModName
</span><span class="hs-identifier hs-var">TH.ModName</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; ModName) -&gt; String -&gt; ModName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ModuleName -&gt; String
</span><a href="Language.Haskell.Syntax.Module.Name.html#moduleNameString"><span class="hs-identifier hs-var">moduleNameString</span></a></span><span> </span><span class="annot"><span class="annottext">(ModuleName -&gt; String) -&gt; ModuleName -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">GenModule Unit -&gt; ModuleName
forall unit. GenModule unit -&gt; ModuleName
</span><a href="GHC.Unit.Types.html#moduleName"><span class="hs-identifier hs-var">moduleName</span></a></span><span> </span><span class="annot"><span class="annottext">GenModule Unit
</span><a href="#local-6989586621683161721"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2888"></span><span>
</span><span id="line-2889"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#reifyModule"><span class="hs-identifier hs-type">reifyModule</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Module</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.ModuleInfo</span></span><span>
</span><span id="line-2890"></span><span id="reifyModule"><span class="annot"><span class="annottext">reifyModule :: Module -&gt; TcM ModuleInfo
</span><a href="GHC.Tc.Gen.Splice.html#reifyModule"><span class="hs-identifier hs-var hs-var">reifyModule</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.Module</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.PkgName</span></span><span> </span><span id="local-6989586621683161724"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683161724"><span class="hs-identifier hs-var">pkgString</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.ModName</span></span><span> </span><span id="local-6989586621683161725"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683161725"><span class="hs-identifier hs-var">mString</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2891"></span><span>  </span><span id="local-6989586621683161726"><span class="annot"><a href="#local-6989586621683161726"><span class="hs-identifier hs-var">this_mod</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IOEnv (Env TcGblEnv TcLclEnv) (GenModule Unit)
forall (m :: * -&gt; *). HasModule m =&gt; m (GenModule Unit)
</span><a href="GHC.Unit.Module.html#getModule"><span class="hs-identifier hs-var">getModule</span></a></span><span>
</span><span id="line-2892"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683161727"><span class="annot"><a href="#local-6989586621683161727"><span class="hs-identifier hs-var hs-var">reifMod</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unit -&gt; ModuleName -&gt; GenModule Unit
forall u. u -&gt; ModuleName -&gt; GenModule u
</span><a href="GHC.Unit.Types.html#mkModule"><span class="hs-identifier hs-var">mkModule</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Unit
</span><a href="GHC.Unit.Types.html#stringToUnit"><span class="hs-identifier hs-var">stringToUnit</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683161724"><span class="hs-identifier hs-var">pkgString</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; ModuleName
</span><a href="Language.Haskell.Syntax.Module.Name.html#mkModuleName"><span class="hs-identifier hs-var">mkModuleName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683161725"><span class="hs-identifier hs-var">mString</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2893"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683161727"><span class="hs-identifier hs-type">reifMod</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">==</span></span><span> </span><span class="annot"><a href="#local-6989586621683161726"><span class="hs-identifier hs-type">this_mod</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><a href="#local-6989586621683161728"><span class="hs-identifier hs-type">reifyThisModule</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><a href="#local-6989586621683161729"><span class="hs-identifier hs-type">reifyFromIface</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161727"><span class="hs-identifier hs-type">reifMod</span></a></span><span>
</span><span id="line-2894"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-2895"></span><span>      </span><span id="local-6989586621683161728"><span class="annot"><span class="annottext">reifyThisModule :: TcM ModuleInfo
</span><a href="#local-6989586621683161728"><span class="hs-identifier hs-var hs-var">reifyThisModule</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2896"></span><span>        </span><span id="local-6989586621683161733"><span class="annot"><a href="#local-6989586621683161733"><span class="hs-identifier hs-var">usages</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(ImportAvails -&gt; [Module])
-&gt; IOEnv (Env TcGblEnv TcLclEnv) ImportAvails
-&gt; IOEnv (Env TcGblEnv TcLclEnv) [Module]
forall a b.
(a -&gt; b)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) a
-&gt; IOEnv (Env TcGblEnv TcLclEnv) b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(GenModule Unit -&gt; Module) -&gt; [GenModule Unit] -&gt; [Module]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">GenModule Unit -&gt; Module
</span><a href="GHC.Tc.Gen.Splice.html#modToTHMod"><span class="hs-identifier hs-var">modToTHMod</span></a></span><span> </span><span class="annot"><span class="annottext">([GenModule Unit] -&gt; [Module])
-&gt; (ImportAvails -&gt; [GenModule Unit]) -&gt; ImportAvails -&gt; [Module]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Map (GenModule Unit) [ImportedBy] -&gt; [GenModule Unit]
forall k a. Map k a -&gt; [k]
</span><a href="../../containers-0.7-5a8f/src/Data.Map.Internal.html#keys"><span class="hs-identifier hs-var">Map.keys</span></a></span><span> </span><span class="annot"><span class="annottext">(Map (GenModule Unit) [ImportedBy] -&gt; [GenModule Unit])
-&gt; (ImportAvails -&gt; Map (GenModule Unit) [ImportedBy])
-&gt; ImportAvails
-&gt; [GenModule Unit]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ImportAvails -&gt; Map (GenModule Unit) [ImportedBy]
</span><a href="GHC.Unit.Module.Deps.html#imp_mods"><span class="hs-identifier hs-var">imp_mods</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IOEnv (Env TcGblEnv TcLclEnv) ImportAvails
</span><a href="GHC.Tc.Utils.Monad.html#getImports"><span class="hs-identifier hs-var">getImports</span></a></span><span>
</span><span id="line-2897"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.ModuleInfo</span></span><span> </span><span class="annot"><a href="#local-6989586621683161733"><span class="hs-identifier hs-type">usages</span></a></span><span>
</span><span id="line-2898"></span><span>
</span><span id="line-2899"></span><span>      </span><span id="local-6989586621683161729"><span class="annot"><span class="annottext">reifyFromIface :: GenModule Unit -&gt; TcM ModuleInfo
</span><a href="#local-6989586621683161729"><span class="hs-identifier hs-var hs-var">reifyFromIface</span></a></span></span><span> </span><span id="local-6989586621683161744"><span class="annot"><span class="annottext">GenModule Unit
</span><a href="#local-6989586621683161744"><span class="hs-identifier hs-var">reifMod</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2900"></span><span>        </span><span id="local-6989586621683161745"><span class="annot"><a href="#local-6989586621683161745"><span class="hs-identifier hs-var">iface</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; GenModule Unit -&gt; IOEnv (Env TcGblEnv TcLclEnv) ModIface
</span><a href="GHC.Iface.Load.html#loadInterfaceForModule"><span class="hs-identifier hs-var">loadInterfaceForModule</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;reifying module from TH for&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">GenModule Unit -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">GenModule Unit
</span><a href="#local-6989586621683161744"><span class="hs-identifier hs-var">reifMod</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">GenModule Unit
</span><a href="#local-6989586621683161744"><span class="hs-identifier hs-var">reifMod</span></a></span><span>
</span><span id="line-2901"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683161747"><span class="annot"><a href="#local-6989586621683161747"><span class="hs-identifier hs-var hs-var">usages</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">GenModule Unit -&gt; Module
</span><a href="GHC.Tc.Gen.Splice.html#modToTHMod"><span class="hs-identifier hs-var">modToTHMod</span></a></span><span> </span><span class="annot"><span class="annottext">GenModule Unit
</span><a href="#local-6989586621683161748"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621683161749"><span class="annot"><span class="annottext">Usage
</span><a href="#local-6989586621683161749"><span class="hs-identifier hs-var">usage</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ModIface -&gt; [Usage]
forall (phase :: ModIfacePhase). ModIface_ phase -&gt; [Usage]
</span><a href="GHC.Unit.Module.ModIface.html#mi_usages"><span class="hs-identifier hs-var">mi_usages</span></a></span><span> </span><span class="annot"><span class="annottext">ModIface
</span><a href="#local-6989586621683161745"><span class="hs-identifier hs-var">iface</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-2902"></span><span>                                     </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683161748"><span class="annot"><span class="annottext">GenModule Unit
</span><a href="#local-6989586621683161748"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Unit -&gt; Usage -&gt; Maybe (GenModule Unit)
</span><a href="#local-6989586621683161751"><span class="hs-identifier hs-var">usageToModule</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GenModule Unit -&gt; Unit
forall unit. GenModule unit -&gt; unit
</span><a href="GHC.Unit.Types.html#moduleUnit"><span class="hs-identifier hs-var">moduleUnit</span></a></span><span> </span><span class="annot"><span class="annottext">GenModule Unit
</span><a href="#local-6989586621683161744"><span class="hs-identifier hs-var">reifMod</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Usage
</span><a href="#local-6989586621683161749"><span class="hs-identifier hs-var">usage</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-2903"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.ModuleInfo</span></span><span> </span><span class="annot"><a href="#local-6989586621683161747"><span class="hs-identifier hs-type">usages</span></a></span><span>
</span><span id="line-2904"></span><span>
</span><span id="line-2905"></span><span>      </span><span class="annot"><a href="#local-6989586621683161751"><span class="hs-identifier hs-type">usageToModule</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Unit.Types.html#Unit"><span class="hs-identifier hs-type">Unit</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Unit.Module.Deps.html#Usage"><span class="hs-identifier hs-type">Usage</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Unit.Types.html#Module"><span class="hs-identifier hs-type">Module</span></a></span><span>
</span><span id="line-2906"></span><span>      </span><span id="local-6989586621683161751"><span class="annot"><span class="annottext">usageToModule :: Unit -&gt; Usage -&gt; Maybe (GenModule Unit)
</span><a href="#local-6989586621683161751"><span class="hs-identifier hs-var hs-var">usageToModule</span></a></span></span><span> </span><span class="annot"><span class="annottext">Unit
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Unit.Module.Deps.html#UsageFile"><span class="hs-identifier hs-type">UsageFile</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (GenModule Unit)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-2907"></span><span>      </span><span class="annot"><a href="#local-6989586621683161751"><span class="hs-identifier hs-var">usageToModule</span></a></span><span> </span><span id="local-6989586621683161753"><span class="annot"><span class="annottext">Unit
</span><a href="#local-6989586621683161753"><span class="hs-identifier hs-var">this_pkg</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Unit.Module.Deps.html#UsageHomeModule"><span class="hs-identifier hs-type">UsageHomeModule</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">usg_mod_name :: Usage -&gt; ModuleName
</span><a href="GHC.Unit.Module.Deps.html#usg_mod_name"><span class="hs-identifier hs-var">usg_mod_name</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683161756"><span class="annot"><span class="annottext">ModuleName
</span><a href="#local-6989586621683161756"><span class="hs-identifier hs-var">mn</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GenModule Unit -&gt; Maybe (GenModule Unit)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(GenModule Unit -&gt; Maybe (GenModule Unit))
-&gt; GenModule Unit -&gt; Maybe (GenModule Unit)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Unit -&gt; ModuleName -&gt; GenModule Unit
forall u. u -&gt; ModuleName -&gt; GenModule u
</span><a href="GHC.Unit.Types.html#mkModule"><span class="hs-identifier hs-var">mkModule</span></a></span><span> </span><span class="annot"><span class="annottext">Unit
</span><a href="#local-6989586621683161753"><span class="hs-identifier hs-var">this_pkg</span></a></span><span> </span><span class="annot"><span class="annottext">ModuleName
</span><a href="#local-6989586621683161756"><span class="hs-identifier hs-var">mn</span></a></span><span>
</span><span id="line-2908"></span><span>      </span><span class="annot"><a href="#local-6989586621683161751"><span class="hs-identifier hs-var">usageToModule</span></a></span><span> </span><span class="annot"><span class="annottext">Unit
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Unit.Module.Deps.html#UsagePackageModule"><span class="hs-identifier hs-type">UsagePackageModule</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">usg_mod :: Usage -&gt; GenModule Unit
</span><a href="GHC.Unit.Module.Deps.html#usg_mod"><span class="hs-identifier hs-var">usg_mod</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683161759"><span class="annot"><span class="annottext">GenModule Unit
</span><a href="#local-6989586621683161759"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GenModule Unit -&gt; Maybe (GenModule Unit)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">GenModule Unit
</span><a href="#local-6989586621683161759"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-2909"></span><span>      </span><span class="annot"><a href="#local-6989586621683161751"><span class="hs-identifier hs-var">usageToModule</span></a></span><span> </span><span class="annot"><span class="annottext">Unit
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Unit.Module.Deps.html#UsageMergedRequirement"><span class="hs-identifier hs-type">UsageMergedRequirement</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">usg_mod :: Usage -&gt; GenModule Unit
</span><a href="GHC.Unit.Module.Deps.html#usg_mod"><span class="hs-identifier hs-var">usg_mod</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683161761"><span class="annot"><span class="annottext">GenModule Unit
</span><a href="#local-6989586621683161761"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GenModule Unit -&gt; Maybe (GenModule Unit)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">GenModule Unit
</span><a href="#local-6989586621683161761"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-2910"></span><span>      </span><span class="annot"><a href="#local-6989586621683161751"><span class="hs-identifier hs-var">usageToModule</span></a></span><span> </span><span id="local-6989586621683161762"><span class="annot"><span class="annottext">Unit
</span><a href="#local-6989586621683161762"><span class="hs-identifier hs-var">this_pkg</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Unit.Module.Deps.html#UsageHomeModuleInterface"><span class="hs-identifier hs-type">UsageHomeModuleInterface</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">usg_mod_name :: Usage -&gt; ModuleName
</span><a href="GHC.Unit.Module.Deps.html#usg_mod_name"><span class="hs-identifier hs-var">usg_mod_name</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683161764"><span class="annot"><span class="annottext">ModuleName
</span><a href="#local-6989586621683161764"><span class="hs-identifier hs-var">mn</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GenModule Unit -&gt; Maybe (GenModule Unit)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(GenModule Unit -&gt; Maybe (GenModule Unit))
-&gt; GenModule Unit -&gt; Maybe (GenModule Unit)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Unit -&gt; ModuleName -&gt; GenModule Unit
forall u. u -&gt; ModuleName -&gt; GenModule u
</span><a href="GHC.Unit.Types.html#mkModule"><span class="hs-identifier hs-var">mkModule</span></a></span><span> </span><span class="annot"><span class="annottext">Unit
</span><a href="#local-6989586621683161762"><span class="hs-identifier hs-var">this_pkg</span></a></span><span> </span><span class="annot"><span class="annottext">ModuleName
</span><a href="#local-6989586621683161764"><span class="hs-identifier hs-var">mn</span></a></span><span>
</span><span id="line-2911"></span><span>
</span><span id="line-2912"></span><span class="hs-comment">------------------------------</span><span>
</span><span id="line-2913"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#mkThAppTs"><span class="hs-identifier hs-type">mkThAppTs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Type</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">TH.Type</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Type</span></span><span>
</span><span id="line-2914"></span><span id="mkThAppTs"><span class="annot"><span class="annottext">mkThAppTs :: Type -&gt; [Type] -&gt; Type
</span><a href="GHC.Tc.Gen.Splice.html#mkThAppTs"><span class="hs-identifier hs-var hs-var">mkThAppTs</span></a></span></span><span> </span><span id="local-6989586621683161765"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161765"><span class="hs-identifier hs-var">fun_ty</span></a></span></span><span> </span><span id="local-6989586621683161766"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161766"><span class="hs-identifier hs-var">arg_tys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Type -&gt; Type) -&gt; Type -&gt; [Type] -&gt; Type
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Type
</span><span class="hs-identifier hs-var">TH.AppT</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161765"><span class="hs-identifier hs-var">fun_ty</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683161766"><span class="hs-identifier hs-var">arg_tys</span></a></span><span>
</span><span id="line-2915"></span><span>
</span><span id="line-2916"></span><span id="local-6989586621683158802"><span class="annot"><a href="GHC.Tc.Gen.Splice.html#noTH"><span class="hs-identifier hs-type">noTH</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Errors.Types.html#UnrepresentableTypeDescr"><span class="hs-identifier hs-type">UnrepresentableTypeDescr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683158802"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-2917"></span><span id="noTH"><span class="annot"><span class="annottext">noTH :: forall a. UnrepresentableTypeDescr -&gt; Type -&gt; TcM a
</span><a href="GHC.Tc.Gen.Splice.html#noTH"><span class="hs-identifier hs-var hs-var">noTH</span></a></span></span><span> </span><span id="local-6989586621683161768"><span class="annot"><span class="annottext">UnrepresentableTypeDescr
</span><a href="#local-6989586621683161768"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621683161769"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161769"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; TcM a
forall a. TcRnMessage -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; TcM a) -&gt; TcRnMessage -&gt; TcM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">THError -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnTHError"><span class="hs-identifier hs-var">TcRnTHError</span></a></span><span> </span><span class="annot"><span class="annottext">(THError -&gt; TcRnMessage) -&gt; THError -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">THReifyError -&gt; THError
</span><a href="GHC.Tc.Errors.Types.html#THReifyError"><span class="hs-identifier hs-var">THReifyError</span></a></span><span> </span><span class="annot"><span class="annottext">(THReifyError -&gt; THError) -&gt; THReifyError -&gt; THError
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UnrepresentableTypeDescr -&gt; Type -&gt; THReifyError
</span><a href="GHC.Tc.Errors.Types.html#CannotRepresentType"><span class="hs-identifier hs-var">CannotRepresentType</span></a></span><span> </span><span class="annot"><span class="annottext">UnrepresentableTypeDescr
</span><a href="#local-6989586621683161768"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683161769"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-2918"></span><span>
</span><span id="line-2919"></span><span id="local-6989586621683158668"><span class="annot"><a href="GHC.Tc.Gen.Splice.html#ppr_th"><span class="hs-identifier hs-type">ppr_th</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../ghc-boot-th-9.12.2-e976/src/GHC.Internal.TH.Ppr.html#Ppr"><span class="hs-identifier hs-type">TH.Ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683158668"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621683158668"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span></span><span>
</span><span id="line-2920"></span><span id="ppr_th"><span class="annot"><span class="annottext">ppr_th :: forall a. Ppr a =&gt; a -&gt; SDoc
</span><a href="GHC.Tc.Gen.Splice.html#ppr_th"><span class="hs-identifier hs-var hs-var">ppr_th</span></a></span></span><span> </span><span id="local-6989586621683161774"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683161774"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; String
forall a. Ppr a =&gt; a -&gt; String
</span><a href="../../ghc-boot-th-9.12.2-e976/src/GHC.Internal.TH.Ppr.html#pprint"><span class="hs-identifier hs-var">TH.pprint</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683161774"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2921"></span><span>
</span><span id="line-2922"></span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#tcGetInterp"><span class="hs-identifier hs-type">tcGetInterp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span>
</span><span id="line-2923"></span><span id="tcGetInterp"><span class="annot"><span class="annottext">tcGetInterp :: TcM Interp
</span><a href="GHC.Tc.Gen.Splice.html#tcGetInterp"><span class="hs-identifier hs-var hs-var">tcGetInterp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2924"></span><span>   </span><span id="local-6989586621683161775"><span class="annot"><a href="#local-6989586621683161775"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcRnIf TcGblEnv TcLclEnv HscEnv
forall gbl lcl. TcRnIf gbl lcl HscEnv
</span><a href="GHC.Tc.Utils.Monad.html#getTopEnv"><span class="hs-identifier hs-var">getTopEnv</span></a></span><span>
</span><span id="line-2925"></span><span>   </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#hsc_interp"><span class="hs-identifier hs-var">hsc_interp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683161775"><span class="hs-identifier hs-type">hsc_env</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2926"></span><span>      </span><span class="annot"><span class="annottext">Maybe Interp
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO Interp -&gt; TcM Interp
forall a. IO a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO Interp -&gt; TcM Interp) -&gt; IO Interp -&gt; TcM Interp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">GhcException -&gt; IO Interp
forall e a. (HasCallStack, Exception e) =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; GhcException
</span><a href="GHC.Utils.Panic.html#InstallationError"><span class="hs-identifier hs-var">InstallationError</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Template haskell requires a target code interpreter&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-2927"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683161777"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683161777"><span class="hs-identifier hs-var">i</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Interp -&gt; TcM Interp
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683161777"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-2928"></span><span>
</span><span id="line-2929"></span><span class="hs-comment">-- Note [Bootstrapping Template Haskell]</span><span>
</span><span id="line-2930"></span><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><span id="line-2931"></span><span class="hs-comment">-- Staged Metaprogramming as implemented in Template Haskell introduces a whole</span><span>
</span><span id="line-2932"></span><span class="hs-comment">-- new dimension of staging to the already staged bootstrapping process.</span><span>
</span><span id="line-2933"></span><span class="hs-comment">-- While users depend on the user-facing `template-haskell` library, the TH</span><span>
</span><span id="line-2934"></span><span class="hs-comment">-- interface (all wired-in identifiers) is defined in `ghc-internal` and for</span><span>
</span><span id="line-2935"></span><span class="hs-comment">-- bootstrapping purposes, re-exported from `ghc-boot-th`.</span><span>
</span><span id="line-2936"></span><span class="hs-comment">--</span><span>
</span><span id="line-2937"></span><span class="hs-comment">-- Nomenclature:</span><span>
</span><span id="line-2938"></span><span class="hs-comment">--</span><span>
</span><span id="line-2939"></span><span class="hs-comment">--   boot/stage0 compiler: An already released compiler used to compile GHC</span><span>
</span><span id="line-2940"></span><span class="hs-comment">--   stage(N+1) compiler: The result of compiling GHC from source with stage(N)</span><span>
</span><span id="line-2941"></span><span class="hs-comment">--       Recall that any code compiled by the stage1 compiler should be binary</span><span>
</span><span id="line-2942"></span><span class="hs-comment">--       identical to the same code compiled by later stages.</span><span>
</span><span id="line-2943"></span><span class="hs-comment">--   boot `ghc-boot-th`: the `ghc-boot-th` that comes with (and is linked to) the</span><span>
</span><span id="line-2944"></span><span class="hs-comment">--       boot/stage0 compiler</span><span>
</span><span id="line-2945"></span><span class="hs-comment">--   in-tree `ghc-boot-th`: the `ghc-boot-th` library that lives in GHC's repository.</span><span>
</span><span id="line-2946"></span><span class="hs-comment">--</span><span>
</span><span id="line-2947"></span><span class="hs-comment">-- Here is how we bootstrap TH in tandem with GHC:</span><span>
</span><span id="line-2948"></span><span class="hs-comment">--</span><span>
</span><span id="line-2949"></span><span class="hs-comment">--  1. Build the stage1 compiler with the boot compiler.</span><span>
</span><span id="line-2950"></span><span class="hs-comment">--     The latter comes with its own boot `ghc-boot-th` library, but we do not import it.</span><span>
</span><span id="line-2951"></span><span class="hs-comment">--  2. Instead, the stage1 compiler depends on the in-tree `ghc-boot-th`.</span><span>
</span><span id="line-2952"></span><span class="hs-comment">--       * To avoid clashes with the boot `ghc-boot-th`, we change its</span><span>
</span><span id="line-2953"></span><span class="hs-comment">--         package-id `ghc-boot-th-next`.</span><span>
</span><span id="line-2954"></span><span class="hs-comment">--       * There is a bit of CPP to vendor the stage1 TH AST defined in</span><span>
</span><span id="line-2955"></span><span class="hs-comment">--         `ghc-internal`, which we cannot build with the boot compiler.</span><span>
</span><span id="line-2956"></span><span class="hs-comment">--  3. Build `ghc-internal` and in-tree `ghc-boot-th` with the stage1 compiler.</span><span>
</span><span id="line-2957"></span><span class="hs-comment">--     From here on `ghc-boot-th` re-exposes the TH modules from `ghc-internal`.</span><span>
</span><span id="line-2958"></span><span class="hs-comment">--  4. Build and link the stage2 compiler against the in-tree `ghc-boot-th`.</span><span>
</span><span id="line-2959"></span><span class="hs-comment">--     NB: No dependency on `ghc-boot-th-next`.</span><span>
</span><span id="line-2960"></span><span class="hs-comment">--</span><span>
</span><span id="line-2961"></span><span class="hs-comment">-- Observations:</span><span>
</span><span id="line-2962"></span><span class="hs-comment">--</span><span>
</span><span id="line-2963"></span><span class="hs-comment">--  A. The vendoring in (2) means that the fully qualified name of the in-tree TH</span><span>
</span><span id="line-2964"></span><span class="hs-comment">--     AST will be, e.g., `ghc-boot-th-next:...VarE`, not `ghc-internal:...VarE`.</span><span>
</span><span id="line-2965"></span><span class="hs-comment">--     That is OK, because we need it just for the `Binary` instance and to</span><span>
</span><span id="line-2966"></span><span class="hs-comment">--     convert TH ASTs returned by splices into the Hs AST, both of which do not</span><span>
</span><span id="line-2967"></span><span class="hs-comment">--     depend on the fully qualified name of the type to serialise! Importantly,</span><span>
</span><span id="line-2968"></span><span class="hs-comment">--     Note [Hard-wiring in-tree template-haskell for desugaring quotes] is</span><span>
</span><span id="line-2969"></span><span class="hs-comment">--     unaffected, because the desugaring refers to names in the in-tree TH</span><span>
</span><span id="line-2970"></span><span class="hs-comment">--     library, which is built in the next stage, stage1, and later.</span><span>
</span><span id="line-2971"></span><span class="hs-comment">--</span><span>
</span><span id="line-2972"></span><span class="hs-comment">-- When we decided in favour of the current design, `template-haskell`</span><span>
</span><span id="line-2973"></span><span class="hs-comment">-- still contained the wired-in Ids that meanwhile were moved to</span><span>
</span><span id="line-2974"></span><span class="hs-comment">-- `ghc-internal`.</span><span>
</span><span id="line-2975"></span><span class="hs-comment">-- These were the (rejected) alternative designs back then:</span><span>
</span><span id="line-2976"></span><span class="hs-comment">--</span><span>
</span><span id="line-2977"></span><span class="hs-comment">--  1b. Build the in-tree TH with the stage0 compiler and link the stage1 compiler</span><span>
</span><span id="line-2978"></span><span class="hs-comment">--      against it. This is what we did until Apr 24 and it is problematic (#23536):</span><span>
</span><span id="line-2979"></span><span class="hs-comment">--        * (It rules out using TH in GHC, for example to derive GHC.Core.Map types,</span><span>
</span><span id="line-2980"></span><span class="hs-comment">--           because the boot compiler expects the boot TH AST in splices, but, e.g.,</span><span>
</span><span id="line-2981"></span><span class="hs-comment">--           splice functions in GHC.Core.Map.TH would return the in-tree TH AST.</span><span>
</span><span id="line-2982"></span><span class="hs-comment">--           However, at the moment, we are not using TH in GHC anyway.)</span><span>
</span><span id="line-2983"></span><span class="hs-comment">--        * Ultimately, we must link the stage1 compiler against a</span><span>
</span><span id="line-2984"></span><span class="hs-comment">--          single version of template-haskell.</span><span>
</span><span id="line-2985"></span><span class="hs-comment">--            (Beyond the fact that doing otherwise would invite even</span><span>
</span><span id="line-2986"></span><span class="hs-comment">--            more &quot;which `template-haskell` is this&quot; confusion, it</span><span>
</span><span id="line-2987"></span><span class="hs-comment">--            would also result in confusing linker errors: see for</span><span>
</span><span id="line-2988"></span><span class="hs-comment">--            example #21981.  In principle we could likely lift this</span><span>
</span><span id="line-2989"></span><span class="hs-comment">--            restriction with more aggressive name mangling, but the</span><span>
</span><span id="line-2990"></span><span class="hs-comment">--            knock-on effects of doing so are unexplored.)</span><span>
</span><span id="line-2991"></span><span class="hs-comment">--        * If the single version is the in-tree TH, we have to recompile all boot</span><span>
</span><span id="line-2992"></span><span class="hs-comment">--          libraries (e.g. bytestring, containers) with this new TH version.</span><span>
</span><span id="line-2993"></span><span class="hs-comment">--        * But the boot libraries must *not* be built against a non-boot TH version.</span><span>
</span><span id="line-2994"></span><span class="hs-comment">--          The reason is Note [Hard-wiring in-tree template-haskell for desugaring quotes]:</span><span>
</span><span id="line-2995"></span><span class="hs-comment">--          The boot compiler will desugar quotes wrt. names in the boot TH version.</span><span>
</span><span id="line-2996"></span><span class="hs-comment">--          A quote like `[| unsafePackLenLiteral |]` in bytestring will desugar</span><span>
</span><span id="line-2997"></span><span class="hs-comment">--          to `varE (mkNameS &quot;unsafePackLenLiteral&quot;)`, and all</span><span>
</span><span id="line-2998"></span><span class="hs-comment">--          those smart constructors refer to locations in *boot TH*, because that</span><span>
</span><span id="line-2999"></span><span class="hs-comment">--          is all that the boot GHC knows about.</span><span>
</span><span id="line-3000"></span><span class="hs-comment">--          If the in-tree TH were to move or rename the definition of</span><span>
</span><span id="line-3001"></span><span class="hs-comment">--          `mkNameS`, the boot compiler would report a linker error when</span><span>
</span><span id="line-3002"></span><span class="hs-comment">--          compiling bytestring.</span><span>
</span><span id="line-3003"></span><span class="hs-comment">--        * (Stopping to use quotes in bytestring is no solution, either, because</span><span>
</span><span id="line-3004"></span><span class="hs-comment">--           the `Lift` type class is wired-in as well.</span><span>
</span><span id="line-3005"></span><span class="hs-comment">--           Only remaining option: provide an entirely TH-less variant of every</span><span>
</span><span id="line-3006"></span><span class="hs-comment">--           boot library. That would place a huge burden on maintainers and is</span><span>
</span><span id="line-3007"></span><span class="hs-comment">--           thus rejected.)</span><span>
</span><span id="line-3008"></span><span class="hs-comment">--        * We have thus made it impossible to refactor in-tree TH.</span><span>
</span><span id="line-3009"></span><span class="hs-comment">--          This problem was discussed in #23536.</span><span>
</span><span id="line-3010"></span><span class="hs-comment">--  1c. Do not build the stage1 compiler against any library exposing the in-tree TH AST.</span><span>
</span><span id="line-3011"></span><span class="hs-comment">--      This is viable because no splices need to be run as part of the</span><span>
</span><span id="line-3012"></span><span class="hs-comment">--      bootstrapping process, so we could CPP away all the code in the stage1</span><span>
</span><span id="line-3013"></span><span class="hs-comment">--      compiler that refers to template-haskell types. However,</span><span>
</span><span id="line-3014"></span><span class="hs-comment">--        * it is not so simple either: a surprising example is GHC.Tc.Errors.Types</span><span>
</span><span id="line-3015"></span><span class="hs-comment">--          where we would need to replace all TH types with dummy types.</span><span>
</span><span id="line-3016"></span><span class="hs-comment">--          (We *cannot* simply CPP away TH-specific error constructors because</span><span>
</span><span id="line-3017"></span><span class="hs-comment">--          that affects binary compatibility with the stage2 compiler.)</span><span>
</span><span id="line-3018"></span><span class="hs-comment">--        * we would still need to vendor the updated Extension enum, so even</span><span>
</span><span id="line-3019"></span><span class="hs-comment">--          though we had to use a lot of CPP, we still end up depending on names</span><span>
</span><span id="line-3020"></span><span class="hs-comment">--          that are not present in the stage2 compiler.</span><span>
</span><span id="line-3021"></span><span class="hs-comment">--        * this design would never allow us to use TH in GHC's code base, for</span><span>
</span><span id="line-3022"></span><span class="hs-comment">--          example in GHC.Core.Map.</span><span>
</span><span id="line-3023"></span><span class="hs-comment">--      It seems simpler just to depend on a template-haskell library in a fake</span><span>
</span><span id="line-3024"></span><span class="hs-comment">--      namespace.</span><span>
</span><span id="line-3025"></span><span class="hs-comment">--  2b. Alternatively vendor the parts relevant to serialising</span><span>
</span><span id="line-3026"></span><span class="hs-comment">--      the (new, in-tree) TH AST into `ghc-boot`, thus shadowing definitions in the</span><span>
</span><span id="line-3027"></span><span class="hs-comment">--      implicitly linked boot TH.</span><span>
</span><span id="line-3028"></span><span class="hs-comment">--        * We found that this led to quite a bit of duplication in the</span><span>
</span><span id="line-3029"></span><span class="hs-comment">--          `ghc-boot` cabal file.</span><span>
</span><span id="line-3030"></span><span>
</span><span id="line-3031"></span><span class="hs-comment">-- Note [Hard-wiring in-tree template-haskell for desugaring quotes]</span><span>
</span><span id="line-3032"></span><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><span id="line-3033"></span><span class="hs-comment">-- To desugar Template Haskell quotes, GHC needs to wire in a bunch of Names in the</span><span>
</span><span id="line-3034"></span><span class="hs-comment">-- `ghc-internal` library as Note [Known-key names], in GHC.Builtin.Names.TH.</span><span>
</span><span id="line-3035"></span><span class="hs-comment">-- Consider</span><span>
</span><span id="line-3036"></span><span class="hs-comment">-- &gt; foo :: Q Exp</span><span>
</span><span id="line-3037"></span><span class="hs-comment">-- &gt; foo = [| unwords [&quot;hello&quot;, &quot;world&quot;] |]</span><span>
</span><span id="line-3038"></span><span class="hs-comment">-- this desugars to Core that looks like this</span><span>
</span><span id="line-3039"></span><span class="hs-comment">-- &gt; varE (mkNameS &quot;unwords&quot;) `appE` listE [litE (stringE &quot;hello&quot;), litE (stringE &quot;world&quot;)]</span><span>
</span><span id="line-3040"></span><span class="hs-comment">-- And all these smart constructors are known-key.</span><span>
</span><span id="line-3041"></span><span class="hs-comment">-- NB: Since the constructors are known-key, it is impossible to link this program</span><span>
</span><span id="line-3042"></span><span class="hs-comment">-- against another `ghc-internal` library in which, e.g., `varE` was moved into a</span><span>
</span><span id="line-3043"></span><span class="hs-comment">-- different module. So effectively, GHC is hard-wired against the in-tree</span><span>
</span><span id="line-3044"></span><span class="hs-comment">-- `ghc-internal` library.</span><span>
</span><span id="line-3045"></span></pre></body></html>