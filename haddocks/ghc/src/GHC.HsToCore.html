<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE MonadComprehensions #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-3"></span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# OPTIONS_GHC -Wno-incomplete-uni-patterns #-}</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998


The Desugarer: turning HsSyn into Core.
-}</span><span>
</span><span id="line-13"></span><span>
</span><span id="line-14"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="GHC.HsToCore.html"><span class="hs-identifier">GHC.HsToCore</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-15"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Desugaring operations</span></span><span>
</span><span id="line-16"></span><span>    </span><span class="annot"><a href="GHC.HsToCore.html#deSugar"><span class="hs-identifier">deSugar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.HsToCore.html#deSugarExpr"><span class="hs-identifier">deSugarExpr</span></a></span><span>
</span><span id="line-17"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-18"></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-20"></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.DynFlags.html"><span class="hs-identifier">GHC.Driver.DynFlags</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Config.html"><span class="hs-identifier">GHC.Driver.Config</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Config.Core.Lint.html"><span class="hs-identifier">GHC.Driver.Config.Core.Lint</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Driver.Config.Core.Lint.html#endPassHscEnvIO"><span class="hs-identifier">endPassHscEnvIO</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Config.HsToCore.Ticks.html"><span class="hs-identifier">GHC.Driver.Config.HsToCore.Ticks</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Config.HsToCore.Usage.html"><span class="hs-identifier">GHC.Driver.Config.HsToCore.Usage</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Env.html"><span class="hs-identifier">GHC.Driver.Env</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Backend.html"><span class="hs-identifier">GHC.Driver.Backend</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Plugins.html"><span class="hs-identifier">GHC.Driver.Plugins</span></a></span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Hs.html"><span class="hs-identifier">GHC.Hs</span></a></span><span>
</span><span id="line-31"></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.HsToCore.Usage.html"><span class="hs-identifier">GHC.HsToCore.Usage</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.HsToCore.Monad.html"><span class="hs-identifier">GHC.HsToCore.Monad</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.HsToCore.Errors.Types.html"><span class="hs-identifier">GHC.HsToCore.Errors.Types</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.HsToCore.Expr.html"><span class="hs-identifier">GHC.HsToCore.Expr</span></a></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.HsToCore.Binds.html"><span class="hs-identifier">GHC.HsToCore.Binds</span></a></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.HsToCore.Foreign.Decl.html"><span class="hs-identifier">GHC.HsToCore.Foreign.Decl</span></a></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.HsToCore.Ticks.html"><span class="hs-identifier">GHC.HsToCore.Ticks</span></a></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.HsToCore.Breakpoints.html"><span class="hs-identifier">GHC.HsToCore.Breakpoints</span></a></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.HsToCore.Coverage.html"><span class="hs-identifier">GHC.HsToCore.Coverage</span></a></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.HsToCore.Docs.html"><span class="hs-identifier">GHC.HsToCore.Docs</span></a></span><span>
</span><span id="line-42"></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html"><span class="hs-identifier">GHC.Tc.Types</span></a></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html"><span class="hs-identifier">GHC.Tc.Types.Origin</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#Position"><span class="hs-identifier">Position</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html"><span class="hs-identifier">GHC.Tc.Utils.Monad</span></a></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#finalSafeMode"><span class="hs-identifier">finalSafeMode</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#fixSafeInstances"><span class="hs-identifier">fixSafeInstances</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#initIfaceLoad"><span class="hs-identifier">initIfaceLoad</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Module.html"><span class="hs-identifier">GHC.Tc.Module</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Tc.Module.html#runTcInteractive"><span class="hs-identifier">runTcInteractive</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Type.html"><span class="hs-identifier">GHC.Core.Type</span></a></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Compare.html"><span class="hs-identifier">GHC.Core.TyCo.Compare</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Compare.html#eqType"><span class="hs-identifier">eqType</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html"><span class="hs-identifier">GHC.Core.TyCon</span></a></span><span>       </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#tyConDataCons"><span class="hs-identifier">tyConDataCons</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.html"><span class="hs-identifier">GHC.Core</span></a></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.FVs.html"><span class="hs-identifier">GHC.Core.FVs</span></a></span><span>       </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.FVs.html#exprsSomeFreeVarsList"><span class="hs-identifier">exprsSomeFreeVarsList</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FVs.html#exprFreeVars"><span class="hs-identifier">exprFreeVars</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.SimpleOpt.html"><span class="hs-identifier">GHC.Core.SimpleOpt</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.SimpleOpt.html#simpleOptPgm"><span class="hs-identifier">simpleOptPgm</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.SimpleOpt.html#simpleOptExpr"><span class="hs-identifier">simpleOptExpr</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html"><span class="hs-identifier">GHC.Core.Utils</span></a></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.Make.html"><span class="hs-identifier">GHC.Core.Unfold.Make</span></a></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html"><span class="hs-identifier">GHC.Core.Coercion</span></a></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html"><span class="hs-identifier">GHC.Core.DataCon</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#dataConWrapId"><span class="hs-identifier">dataConWrapId</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Make.html"><span class="hs-identifier">GHC.Core.Make</span></a></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html"><span class="hs-identifier">GHC.Core.Rules</span></a></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Pipeline.Types.html"><span class="hs-identifier">GHC.Core.Opt.Pipeline.Types</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Pipeline.Types.html#CoreToDo"><span class="hs-identifier">CoreToDo</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Ppr.html"><span class="hs-identifier">GHC.Core.Ppr</span></a></span><span>
</span><span id="line-62"></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html"><span class="hs-identifier">GHC.Builtin.Names</span></a></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.Prim.html"><span class="hs-identifier">GHC.Builtin.Types.Prim</span></a></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.html"><span class="hs-identifier">GHC.Builtin.Types</span></a></span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Maybe.html"><span class="hs-identifier">GHC.Data.Maybe</span></a></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Data.Maybe.html#expectJust"><span class="hs-identifier">expectJust</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.OrdList.html"><span class="hs-identifier">GHC.Data.OrdList</span></a></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../ghc-boot-9.12.2-1a37/src/GHC.Data.SizedSeq.html"><span class="hs-identifier">GHC.Data.SizedSeq</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../ghc-boot-9.12.2-1a37/src/GHC.Data.SizedSeq.html#sizeSS"><span class="hs-identifier">sizeSS</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Error.html"><span class="hs-identifier">GHC.Utils.Error</span></a></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.Plain.html"><span class="hs-identifier">GHC.Utils.Panic.Plain</span></a></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Monad.html"><span class="hs-identifier">GHC.Utils.Monad</span></a></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html"><span class="hs-identifier">GHC.Utils.Logger</span></a></span><span>
</span><span id="line-77"></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.html"><span class="hs-identifier">GHC.Types.Id</span></a></span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.Info.html"><span class="hs-identifier">GHC.Types.Id.Info</span></a></span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.Make.html"><span class="hs-identifier">GHC.Types.Id.Make</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Id.Make.html#mkRepPolyIdConcreteTyVars"><span class="hs-identifier">mkRepPolyIdConcreteTyVars</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.ForeignStubs.html"><span class="hs-identifier">GHC.Types.ForeignStubs</span></a></span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Avail.html"><span class="hs-identifier">GHC.Types.Avail</span></a></span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html"><span class="hs-identifier">GHC.Types.Basic</span></a></span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html"><span class="hs-identifier">GHC.Types.Var.Set</span></a></span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html"><span class="hs-identifier">GHC.Types.SrcLoc</span></a></span><span>
</span><span id="line-86"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.SourceFile.html"><span class="hs-identifier">GHC.Types.SourceFile</span></a></span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.TypeEnv.html"><span class="hs-identifier">GHC.Types.TypeEnv</span></a></span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.html"><span class="hs-identifier">GHC.Types.Name</span></a></span><span>
</span><span id="line-89"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html"><span class="hs-identifier">GHC.Types.Name.Set</span></a></span><span>
</span><span id="line-90"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.Env.html"><span class="hs-identifier">GHC.Types.Name.Env</span></a></span><span>
</span><span id="line-91"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.Ppr.html"><span class="hs-identifier">GHC.Types.Name.Ppr</span></a></span><span>
</span><span id="line-92"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.HpcInfo.html"><span class="hs-identifier">GHC.Types.HpcInfo</span></a></span><span>
</span><span id="line-93"></span><span>
</span><span id="line-94"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.html"><span class="hs-identifier">GHC.Unit</span></a></span><span>
</span><span id="line-95"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html"><span class="hs-identifier">GHC.Unit.Module.ModGuts</span></a></span><span>
</span><span id="line-96"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModIface.html"><span class="hs-identifier">GHC.Unit.Module.ModIface</span></a></span><span>
</span><span id="line-97"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Module.Deps.html"><span class="hs-identifier">GHC.Unit.Module.Deps</span></a></span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">partition</span></span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.IORef.html"><span class="hs-identifier">Data.IORef</span></a></span><span>
</span><span id="line-101"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.Traversable.html"><span class="hs-identifier">Data.Traversable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">for</span></span><span class="hs-special">)</span><span>
</span><span id="line-102"></span><span>
</span><span id="line-103"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
*              The main function: deSugar
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-110"></span><span>
</span><span id="line-111"></span><span class="annot"><span class="hs-comment">-- | Main entry point to the desugarer.</span></span><span>
</span><span id="line-112"></span><span class="annot"><a href="GHC.HsToCore.html#deSugar"><span class="hs-identifier hs-type">deSugar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Unit.Module.Location.html#ModLocation"><span class="hs-identifier hs-type">ModLocation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcGblEnv"><span class="hs-identifier hs-type">TcGblEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Error.html#Messages"><span class="hs-identifier hs-type">Messages</span></a></span><span> </span><span class="annot"><a href="GHC.HsToCore.Errors.Types.html#DsMessage"><span class="hs-identifier hs-type">DsMessage</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html#ModGuts"><span class="hs-identifier hs-type">ModGuts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-113"></span><span class="hs-comment">-- Can modify PCS by faulting in more declarations</span><span>
</span><span id="line-114"></span><span>
</span><span id="line-115"></span><span id="deSugar"><span class="annot"><span class="annottext">deSugar :: HscEnv
-&gt; ModLocation
-&gt; TcGblEnv
-&gt; IO (Messages DsMessage, Maybe ModGuts)
</span><a href="GHC.HsToCore.html#deSugar"><span class="hs-identifier hs-var hs-var">deSugar</span></a></span></span><span> </span><span id="local-6989586621683151404"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683151404"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span>
</span><span id="line-116"></span><span>        </span><span id="local-6989586621683151405"><span class="annot"><span class="annottext">ModLocation
</span><a href="#local-6989586621683151405"><span class="hs-identifier hs-var">mod_loc</span></a></span></span><span>
</span><span id="line-117"></span><span>        </span><span id="local-6989586621683151406"><span class="annot"><span class="annottext">tcg_env :: TcGblEnv
</span><a href="#local-6989586621683151406"><span class="hs-identifier hs-var">tcg_env</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.html#TcGblEnv"><span class="hs-identifier hs-type">TcGblEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">tcg_mod :: TcGblEnv -&gt; Module
</span><a href="GHC.Tc.Types.html#tcg_mod"><span class="hs-identifier hs-var">tcg_mod</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151409"><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621683151409"><span class="hs-identifier hs-var">id_mod</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-118"></span><span>                            </span><span class="annot"><span class="annottext">tcg_semantic_mod :: TcGblEnv -&gt; Module
</span><a href="GHC.Tc.Types.html#tcg_semantic_mod"><span class="hs-identifier hs-var">tcg_semantic_mod</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151411"><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621683151411"><span class="hs-identifier hs-var">mod</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-119"></span><span>                            </span><span class="annot"><span class="annottext">tcg_src :: TcGblEnv -&gt; HscSource
</span><a href="GHC.Tc.Types.html#tcg_src"><span class="hs-identifier hs-var">tcg_src</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151413"><span class="annot"><span class="annottext">HscSource
</span><a href="#local-6989586621683151413"><span class="hs-identifier hs-var">hsc_src</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-120"></span><span>                            </span><span class="annot"><span class="annottext">tcg_type_env :: TcGblEnv -&gt; TypeEnv
</span><a href="GHC.Tc.Types.html#tcg_type_env"><span class="hs-identifier hs-var">tcg_type_env</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151415"><span class="annot"><span class="annottext">TypeEnv
</span><a href="#local-6989586621683151415"><span class="hs-identifier hs-var">type_env</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-121"></span><span>                            </span><span class="annot"><span class="annottext">tcg_imports :: TcGblEnv -&gt; ImportAvails
</span><a href="GHC.Tc.Types.html#tcg_imports"><span class="hs-identifier hs-var">tcg_imports</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151417"><span class="annot"><span class="annottext">ImportAvails
</span><a href="#local-6989586621683151417"><span class="hs-identifier hs-var">imports</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-122"></span><span>                            </span><span class="annot"><span class="annottext">tcg_exports :: TcGblEnv -&gt; [AvailInfo]
</span><a href="GHC.Tc.Types.html#tcg_exports"><span class="hs-identifier hs-var">tcg_exports</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151419"><span class="annot"><span class="annottext">[AvailInfo]
</span><a href="#local-6989586621683151419"><span class="hs-identifier hs-var">exports</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-123"></span><span>                            </span><span class="annot"><span class="annottext">tcg_keep :: TcGblEnv -&gt; TcRef NameSet
</span><a href="GHC.Tc.Types.html#tcg_keep"><span class="hs-identifier hs-var">tcg_keep</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151421"><span class="annot"><span class="annottext">TcRef NameSet
</span><a href="#local-6989586621683151421"><span class="hs-identifier hs-var">keep_var</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-124"></span><span>                            </span><span class="annot"><span class="annottext">tcg_th_splice_used :: TcGblEnv -&gt; TcRef Bool
</span><a href="GHC.Tc.Types.html#tcg_th_splice_used"><span class="hs-identifier hs-var">tcg_th_splice_used</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151423"><span class="annot"><span class="annottext">TcRef Bool
</span><a href="#local-6989586621683151423"><span class="hs-identifier hs-var">tc_splice_used</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-125"></span><span>                            </span><span class="annot"><span class="annottext">tcg_rdr_env :: TcGblEnv -&gt; GlobalRdrEnv
</span><a href="GHC.Tc.Types.html#tcg_rdr_env"><span class="hs-identifier hs-var">tcg_rdr_env</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151425"><span class="annot"><span class="annottext">GlobalRdrEnv
</span><a href="#local-6989586621683151425"><span class="hs-identifier hs-var">rdr_env</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-126"></span><span>                            </span><span class="annot"><span class="annottext">tcg_fix_env :: TcGblEnv -&gt; FixityEnv
</span><a href="GHC.Tc.Types.html#tcg_fix_env"><span class="hs-identifier hs-var">tcg_fix_env</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151427"><span class="annot"><span class="annottext">FixityEnv
</span><a href="#local-6989586621683151427"><span class="hs-identifier hs-var">fix_env</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-127"></span><span>                            </span><span class="annot"><span class="annottext">tcg_inst_env :: TcGblEnv -&gt; InstEnv
</span><a href="GHC.Tc.Types.html#tcg_inst_env"><span class="hs-identifier hs-var">tcg_inst_env</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151429"><span class="annot"><span class="annottext">InstEnv
</span><a href="#local-6989586621683151429"><span class="hs-identifier hs-var">inst_env</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-128"></span><span>                            </span><span class="annot"><span class="annottext">tcg_fam_inst_env :: TcGblEnv -&gt; FamInstEnv
</span><a href="GHC.Tc.Types.html#tcg_fam_inst_env"><span class="hs-identifier hs-var">tcg_fam_inst_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151431"><span class="annot"><span class="annottext">FamInstEnv
</span><a href="#local-6989586621683151431"><span class="hs-identifier hs-var">fam_inst_env</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-129"></span><span>                            </span><span class="annot"><span class="annottext">tcg_merged :: TcGblEnv -&gt; [(Module, Fingerprint)]
</span><a href="GHC.Tc.Types.html#tcg_merged"><span class="hs-identifier hs-var">tcg_merged</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151433"><span class="annot"><span class="annottext">[(Module, Fingerprint)]
</span><a href="#local-6989586621683151433"><span class="hs-identifier hs-var">merged</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-130"></span><span>                            </span><span class="annot"><span class="annottext">tcg_warns :: TcGblEnv -&gt; Warnings GhcRn
</span><a href="GHC.Tc.Types.html#tcg_warns"><span class="hs-identifier hs-var">tcg_warns</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151435"><span class="annot"><span class="annottext">Warnings GhcRn
</span><a href="#local-6989586621683151435"><span class="hs-identifier hs-var">warns</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-131"></span><span>                            </span><span class="annot"><span class="annottext">tcg_anns :: TcGblEnv -&gt; [Annotation]
</span><a href="GHC.Tc.Types.html#tcg_anns"><span class="hs-identifier hs-var">tcg_anns</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151437"><span class="annot"><span class="annottext">[Annotation]
</span><a href="#local-6989586621683151437"><span class="hs-identifier hs-var">anns</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-132"></span><span>                            </span><span class="annot"><span class="annottext">tcg_binds :: TcGblEnv -&gt; LHsBinds GhcTc
</span><a href="GHC.Tc.Types.html#tcg_binds"><span class="hs-identifier hs-var">tcg_binds</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151439"><span class="annot"><span class="annottext">LHsBinds GhcTc
</span><a href="#local-6989586621683151439"><span class="hs-identifier hs-var">binds</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-133"></span><span>                            </span><span class="annot"><span class="annottext">tcg_imp_specs :: TcGblEnv -&gt; [LTcSpecPrag]
</span><a href="GHC.Tc.Types.html#tcg_imp_specs"><span class="hs-identifier hs-var">tcg_imp_specs</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151441"><span class="annot"><span class="annottext">[LTcSpecPrag]
</span><a href="#local-6989586621683151441"><span class="hs-identifier hs-var">imp_specs</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-134"></span><span>                            </span><span class="annot"><span class="annottext">tcg_dependent_files :: TcGblEnv -&gt; TcRef [FilePath]
</span><a href="GHC.Tc.Types.html#tcg_dependent_files"><span class="hs-identifier hs-var">tcg_dependent_files</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151443"><span class="annot"><span class="annottext">TcRef [FilePath]
</span><a href="#local-6989586621683151443"><span class="hs-identifier hs-var">dependent_files</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-135"></span><span>                            </span><span class="annot"><span class="annottext">tcg_ev_binds :: TcGblEnv -&gt; Bag EvBind
</span><a href="GHC.Tc.Types.html#tcg_ev_binds"><span class="hs-identifier hs-var">tcg_ev_binds</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151445"><span class="annot"><span class="annottext">Bag EvBind
</span><a href="#local-6989586621683151445"><span class="hs-identifier hs-var">ev_binds</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-136"></span><span>                            </span><span class="annot"><span class="annottext">tcg_th_foreign_files :: TcGblEnv -&gt; TcRef [(ForeignSrcLang, FilePath)]
</span><a href="GHC.Tc.Types.html#tcg_th_foreign_files"><span class="hs-identifier hs-var">tcg_th_foreign_files</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151447"><span class="annot"><span class="annottext">TcRef [(ForeignSrcLang, FilePath)]
</span><a href="#local-6989586621683151447"><span class="hs-identifier hs-var">th_foreign_files_var</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-137"></span><span>                            </span><span class="annot"><span class="annottext">tcg_fords :: TcGblEnv -&gt; [LForeignDecl GhcTc]
</span><a href="GHC.Tc.Types.html#tcg_fords"><span class="hs-identifier hs-var">tcg_fords</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151449"><span class="annot"><span class="annottext">[LForeignDecl GhcTc]
</span><a href="#local-6989586621683151449"><span class="hs-identifier hs-var">fords</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-138"></span><span>                            </span><span class="annot"><span class="annottext">tcg_rules :: TcGblEnv -&gt; [LRuleDecl GhcTc]
</span><a href="GHC.Tc.Types.html#tcg_rules"><span class="hs-identifier hs-var">tcg_rules</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151451"><span class="annot"><span class="annottext">[LRuleDecl GhcTc]
</span><a href="#local-6989586621683151451"><span class="hs-identifier hs-var">rules</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-139"></span><span>                            </span><span class="annot"><span class="annottext">tcg_patsyns :: TcGblEnv -&gt; [PatSyn]
</span><a href="GHC.Tc.Types.html#tcg_patsyns"><span class="hs-identifier hs-var">tcg_patsyns</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151453"><span class="annot"><span class="annottext">[PatSyn]
</span><a href="#local-6989586621683151453"><span class="hs-identifier hs-var">patsyns</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-140"></span><span>                            </span><span class="annot"><span class="annottext">tcg_tcs :: TcGblEnv -&gt; [TyCon]
</span><a href="GHC.Tc.Types.html#tcg_tcs"><span class="hs-identifier hs-var">tcg_tcs</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151455"><span class="annot"><span class="annottext">[TyCon]
</span><a href="#local-6989586621683151455"><span class="hs-identifier hs-var">tcs</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-141"></span><span>                            </span><span class="annot"><span class="annottext">tcg_default_exports :: TcGblEnv -&gt; DefaultEnv
</span><a href="GHC.Tc.Types.html#tcg_default_exports"><span class="hs-identifier hs-var">tcg_default_exports</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151457"><span class="annot"><span class="annottext">DefaultEnv
</span><a href="#local-6989586621683151457"><span class="hs-identifier hs-var">defaults</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-142"></span><span>                            </span><span class="annot"><span class="annottext">tcg_insts :: TcGblEnv -&gt; [ClsInst]
</span><a href="GHC.Tc.Types.html#tcg_insts"><span class="hs-identifier hs-var">tcg_insts</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151459"><span class="annot"><span class="annottext">[ClsInst]
</span><a href="#local-6989586621683151459"><span class="hs-identifier hs-var">insts</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-143"></span><span>                            </span><span class="annot"><span class="annottext">tcg_fam_insts :: TcGblEnv -&gt; [FamInst]
</span><a href="GHC.Tc.Types.html#tcg_fam_insts"><span class="hs-identifier hs-var">tcg_fam_insts</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151461"><span class="annot"><span class="annottext">[FamInst]
</span><a href="#local-6989586621683151461"><span class="hs-identifier hs-var">fam_insts</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-144"></span><span>                            </span><span class="annot"><span class="annottext">tcg_hpc :: TcGblEnv -&gt; Bool
</span><a href="GHC.Tc.Types.html#tcg_hpc"><span class="hs-identifier hs-var">tcg_hpc</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151463"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683151463"><span class="hs-identifier hs-var">other_hpc_info</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-145"></span><span>                            </span><span class="annot"><span class="annottext">tcg_complete_matches :: TcGblEnv -&gt; CompleteMatches
</span><a href="GHC.Tc.Types.html#tcg_complete_matches"><span class="hs-identifier hs-var">tcg_complete_matches</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151465"><span class="annot"><span class="annottext">CompleteMatches
</span><a href="#local-6989586621683151465"><span class="hs-identifier hs-var">complete_matches</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-146"></span><span>                            </span><span class="annot"><span class="annottext">tcg_self_boot :: TcGblEnv -&gt; SelfBootInfo
</span><a href="GHC.Tc.Types.html#tcg_self_boot"><span class="hs-identifier hs-var">tcg_self_boot</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151467"><span class="annot"><span class="annottext">SelfBootInfo
</span><a href="#local-6989586621683151467"><span class="hs-identifier hs-var">self_boot</span></a></span></span><span>
</span><span id="line-147"></span><span>                            </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-148"></span><span>
</span><span id="line-149"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683151468"><span class="annot"><span class="annottext">dflags :: DynFlags
</span><a href="#local-6989586621683151468"><span class="hs-identifier hs-var hs-var">dflags</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; DynFlags
</span><a href="GHC.Driver.Env.Types.html#hsc_dflags"><span class="hs-identifier hs-var">hsc_dflags</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683151404"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-150"></span><span>             </span><span id="local-6989586621683151470"><span class="annot"><span class="annottext">logger :: Logger
</span><a href="#local-6989586621683151470"><span class="hs-identifier hs-var hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; Logger
</span><a href="GHC.Driver.Env.Types.html#hsc_logger"><span class="hs-identifier hs-var">hsc_logger</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683151404"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-151"></span><span>             </span><span id="local-6989586621683151472"><span class="annot"><span class="annottext">ptc :: PromotionTickContext
</span><a href="#local-6989586621683151472"><span class="hs-identifier hs-var hs-var">ptc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; PromotionTickContext
</span><a href="GHC.Driver.DynFlags.html#initPromotionTickContext"><span class="hs-identifier hs-var">initPromotionTickContext</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HscEnv -&gt; DynFlags
</span><a href="GHC.Driver.Env.Types.html#hsc_dflags"><span class="hs-identifier hs-var">hsc_dflags</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683151404"><span class="hs-identifier hs-var">hsc_env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-152"></span><span>             </span><span id="local-6989586621683151474"><span class="annot"><span class="annottext">name_ppr_ctx :: NamePprCtx
</span><a href="#local-6989586621683151474"><span class="hs-identifier hs-var hs-var">name_ppr_ctx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PromotionTickContext -&gt; UnitEnv -&gt; GlobalRdrEnv -&gt; NamePprCtx
forall info.
Outputable info =&gt;
PromotionTickContext -&gt; UnitEnv -&gt; GlobalRdrEnvX info -&gt; NamePprCtx
</span><a href="GHC.Types.Name.Ppr.html#mkNamePprCtx"><span class="hs-identifier hs-var">mkNamePprCtx</span></a></span><span> </span><span class="annot"><span class="annottext">PromotionTickContext
</span><a href="#local-6989586621683151472"><span class="hs-identifier hs-var">ptc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HscEnv -&gt; UnitEnv
</span><a href="GHC.Driver.Env.Types.html#hsc_unit_env"><span class="hs-identifier hs-var">hsc_unit_env</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683151404"><span class="hs-identifier hs-var">hsc_env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">GlobalRdrEnv
</span><a href="#local-6989586621683151425"><span class="hs-identifier hs-var">rdr_env</span></a></span><span>
</span><span id="line-153"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Logger
-&gt; SDoc
-&gt; ((Messages DsMessage, Maybe ModGuts) -&gt; ())
-&gt; IO (Messages DsMessage, Maybe ModGuts)
-&gt; IO (Messages DsMessage, Maybe ModGuts)
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
Logger -&gt; SDoc -&gt; (a -&gt; ()) -&gt; m a -&gt; m a
</span><a href="GHC.Utils.Error.html#withTiming"><span class="hs-identifier hs-var">withTiming</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621683151470"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-154"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; SDoc
forall doc. IsLine doc =&gt; FilePath -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Desugar&quot;</span></span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#brackets"><span class="hs-identifier hs-var">brackets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Module -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621683151411"><span class="hs-identifier hs-var">mod</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-155"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; (Messages DsMessage, Maybe ModGuts) -&gt; ()
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO (Messages DsMessage, Maybe ModGuts)
 -&gt; IO (Messages DsMessage, Maybe ModGuts))
-&gt; IO (Messages DsMessage, Maybe ModGuts)
-&gt; IO (Messages DsMessage, Maybe ModGuts)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-156"></span><span>     </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Desugar the program</span><span>
</span><span id="line-157"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683151483"><span class="annot"><span class="annottext">export_set :: NameSet
</span><a href="#local-6989586621683151483"><span class="hs-identifier hs-var hs-var hs-var">export_set</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[AvailInfo] -&gt; NameSet
</span><a href="GHC.Types.Avail.html#availsToNameSet"><span class="hs-identifier hs-var">availsToNameSet</span></a></span><span> </span><span class="annot"><span class="annottext">[AvailInfo]
</span><a href="#local-6989586621683151419"><span class="hs-identifier hs-var">exports</span></a></span><span>
</span><span id="line-158"></span><span>              </span><span id="local-6989586621683151485"><span class="annot"><span class="annottext">bcknd :: Backend
</span><a href="#local-6989586621683151485"><span class="hs-identifier hs-var hs-var hs-var">bcknd</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; Backend
</span><a href="GHC.Driver.DynFlags.html#backend"><span class="hs-identifier hs-var">backend</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683151468"><span class="hs-identifier hs-var">dflags</span></a></span><span>
</span><span id="line-159"></span><span>              </span><span class="hs-comment">-- See Note [Named default declarations] in GHC.Tc.Gen.Default</span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683151487"><span class="annot"><a href="#local-6989586621683151487"><span class="hs-identifier hs-var">binds_cvr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683151488"><span class="annot"><a href="#local-6989586621683151488"><span class="hs-identifier hs-var">m_tickInfo</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-162"></span><span>                         </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HscSource -&gt; Bool
</span><a href="GHC.Types.SourceFile.html#isHsBootOrSig"><span class="hs-identifier hs-var">isHsBootOrSig</span></a></span><span> </span><span class="annot"><span class="annottext">HscSource
</span><a href="#local-6989586621683151413"><span class="hs-identifier hs-var">hsc_src</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-163"></span><span>                              </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Logger
-&gt; TicksConfig
-&gt; Module
-&gt; ModLocation
-&gt; NameSet
-&gt; [TyCon]
-&gt; LHsBinds GhcTc
-&gt; IO (LHsBinds GhcTc, Maybe (FilePath, SizedSeq Tick))
</span><a href="GHC.HsToCore.Ticks.html#addTicksToBinds"><span class="hs-identifier hs-var">addTicksToBinds</span></a></span><span>
</span><span id="line-164"></span><span>                                       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HscEnv -&gt; Logger
</span><a href="GHC.Driver.Env.Types.html#hsc_logger"><span class="hs-identifier hs-var">hsc_logger</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683151404"><span class="hs-identifier hs-var">hsc_env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-165"></span><span>                                       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DynFlags -&gt; TicksConfig
</span><a href="GHC.Driver.Config.HsToCore.Ticks.html#initTicksConfig"><span class="hs-identifier hs-var">initTicksConfig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HscEnv -&gt; DynFlags
</span><a href="GHC.Driver.Env.Types.html#hsc_dflags"><span class="hs-identifier hs-var">hsc_dflags</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683151404"><span class="hs-identifier hs-var">hsc_env</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-166"></span><span>                                       </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621683151411"><span class="hs-identifier hs-var">mod</span></a></span><span> </span><span class="annot"><span class="annottext">ModLocation
</span><a href="#local-6989586621683151405"><span class="hs-identifier hs-var">mod_loc</span></a></span><span>
</span><span id="line-167"></span><span>                                       </span><span class="annot"><span class="annottext">NameSet
</span><a href="#local-6989586621683151483"><span class="hs-identifier hs-var">export_set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeEnv -&gt; [TyCon]
</span><a href="GHC.Types.TypeEnv.html#typeEnvTyCons"><span class="hs-identifier hs-var">typeEnvTyCons</span></a></span><span> </span><span class="annot"><span class="annottext">TypeEnv
</span><a href="#local-6989586621683151415"><span class="hs-identifier hs-var">type_env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LHsBinds GhcTc
</span><a href="#local-6989586621683151439"><span class="hs-identifier hs-var">binds</span></a></span><span>
</span><span id="line-168"></span><span>                              </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">([GenLocated SrcSpanAnnA (HsBindLR GhcTc GhcTc)],
 Maybe (FilePath, SizedSeq Tick))
-&gt; IO
     ([GenLocated SrcSpanAnnA (HsBindLR GhcTc GhcTc)],
      Maybe (FilePath, SizedSeq Tick))
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LHsBinds GhcTc
[GenLocated SrcSpanAnnA (HsBindLR GhcTc GhcTc)]
</span><a href="#local-6989586621683151439"><span class="hs-identifier hs-var">binds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (FilePath, SizedSeq Tick)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-169"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683151494"><span class="annot"><a href="#local-6989586621683151494"><span class="hs-identifier hs-var">modBreaks</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">for</span></span><span>
</span><span id="line-170"></span><span>           </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683151495"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683151496"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-171"></span><span>           </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621683151495"><span class="annot"><a href="#local-6989586621683151495"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#hsc_interp"><span class="hs-identifier hs-var">hsc_interp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151404"><span class="hs-identifier hs-type">hsc_env</span></a></span><span>
</span><span id="line-172"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683151496"><span class="annot"><a href="#local-6989586621683151496"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621683151488"><span class="hs-identifier hs-type">m_tickInfo</span></a></span><span>
</span><span id="line-173"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.Config.HsToCore.Ticks.html#breakpointsAllowed"><span class="hs-identifier hs-type">breakpointsAllowed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151468"><span class="hs-identifier hs-type">dflags</span></a></span><span>
</span><span id="line-174"></span><span>           </span><span class="hs-special">]</span><span>
</span><span id="line-175"></span><span>           </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621683151499"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683151499"><span class="hs-identifier hs-var">interp</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683151500"><span class="annot"><span class="annottext">SizedSeq Tick
</span><a href="#local-6989586621683151500"><span class="hs-identifier hs-var">specs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Interp -&gt; Module -&gt; SizedSeq Tick -&gt; IO ModBreaks
</span><a href="GHC.HsToCore.Breakpoints.html#mkModBreaks"><span class="hs-identifier hs-var">mkModBreaks</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683151499"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621683151411"><span class="hs-identifier hs-var">mod</span></a></span><span> </span><span class="annot"><span class="annottext">SizedSeq Tick
</span><a href="#local-6989586621683151500"><span class="hs-identifier hs-var">specs</span></a></span><span>
</span><span id="line-176"></span><span>
</span><span id="line-177"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683151502"><span class="annot"><a href="#local-6989586621683151502"><span class="hs-identifier hs-var">ds_hpc_info</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683151488"><span class="hs-identifier hs-type">m_tickInfo</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-178"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683151503"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621683151503"><span class="hs-identifier hs-var">orig_file2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683151504"><span class="annot"><span class="annottext">SizedSeq Tick
</span><a href="#local-6989586621683151504"><span class="hs-identifier hs-var">ticks</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-179"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">GeneralFlag -&gt; DynFlags -&gt; Bool
</span><a href="GHC.Driver.DynFlags.html#gopt"><span class="hs-identifier hs-var">gopt</span></a></span><span> </span><span class="annot"><span class="annottext">GeneralFlag
</span><a href="GHC.Driver.Flags.html#Opt_Hpc"><span class="hs-identifier hs-var">Opt_Hpc</span></a></span><span> </span><span class="annot"><span class="annottext">(DynFlags -&gt; Bool) -&gt; DynFlags -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; DynFlags
</span><a href="GHC.Driver.Env.Types.html#hsc_dflags"><span class="hs-identifier hs-var">hsc_dflags</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683151404"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-180"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-181"></span><span>              </span><span id="local-6989586621683151507"><span class="annot"><a href="#local-6989586621683151507"><span class="hs-identifier hs-var">hashNo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">GeneralFlag -&gt; DynFlags -&gt; Bool
</span><a href="GHC.Driver.DynFlags.html#gopt"><span class="hs-identifier hs-var">gopt</span></a></span><span> </span><span class="annot"><span class="annottext">GeneralFlag
</span><a href="GHC.Driver.Flags.html#Opt_Hpc"><span class="hs-identifier hs-var">Opt_Hpc</span></a></span><span> </span><span class="annot"><span class="annottext">(DynFlags -&gt; Bool) -&gt; DynFlags -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; DynFlags
</span><a href="GHC.Driver.Env.Types.html#hsc_dflags"><span class="hs-identifier hs-var">hsc_dflags</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683151404"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-182"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; Module -&gt; SizedSeq Tick -&gt; FilePath -&gt; IO Int
</span><a href="GHC.HsToCore.Coverage.html#writeMixEntries"><span class="hs-identifier hs-var">writeMixEntries</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DynFlags -&gt; FilePath
</span><a href="GHC.Driver.DynFlags.html#hpcDir"><span class="hs-identifier hs-var">hpcDir</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683151468"><span class="hs-identifier hs-var">dflags</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621683151411"><span class="hs-identifier hs-var">mod</span></a></span><span> </span><span class="annot"><span class="annottext">SizedSeq Tick
</span><a href="#local-6989586621683151504"><span class="hs-identifier hs-var">ticks</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621683151503"><span class="hs-identifier hs-var">orig_file2</span></a></span><span>
</span><span id="line-183"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO Int
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-comment">-- dummy hash when none are written</span><span>
</span><span id="line-184"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Types.HpcInfo.html#HpcInfo"><span class="hs-identifier hs-type">HpcInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">fromIntegral</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="../../ghc-boot-9.12.2-1a37/src/GHC.Data.SizedSeq.html#sizeSS"><span class="hs-identifier hs-type">sizeSS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151504"><span class="hs-identifier hs-type">ticks</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683151507"><span class="hs-identifier hs-type">hashNo</span></a></span><span>
</span><span id="line-185"></span><span>            </span><span class="annot"><span class="annottext">Maybe (FilePath, SizedSeq Tick)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HpcInfo -&gt; IO HpcInfo
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(HpcInfo -&gt; IO HpcInfo) -&gt; HpcInfo -&gt; IO HpcInfo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; HpcInfo
</span><a href="GHC.Types.HpcInfo.html#emptyHpcInfo"><span class="hs-identifier hs-var">emptyHpcInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683151463"><span class="hs-identifier hs-var">other_hpc_info</span></a></span><span>
</span><span id="line-186"></span><span>
</span><span id="line-187"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683151512"><span class="annot"><a href="#local-6989586621683151512"><span class="hs-identifier hs-var">msgs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683151513"><span class="annot"><a href="#local-6989586621683151513"><span class="hs-identifier hs-var">mb_res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.HsToCore.Monad.html#initDs"><span class="hs-identifier hs-type">initDs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151404"><span class="hs-identifier hs-type">hsc_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151406"><span class="hs-identifier hs-type">tcg_env</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-188"></span><span>                       </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.HsToCore.Binds.html#dsEvBinds"><span class="hs-identifier hs-type">dsEvBinds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151445"><span class="hs-identifier hs-type">ev_binds</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621683151516"><span class="annot"><span class="annottext">[CoreBind]
</span><a href="#local-6989586621683151516"><span class="hs-identifier hs-var">ds_ev_binds</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-189"></span><span>                          </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683151517"><span class="annot"><a href="#local-6989586621683151517"><span class="hs-identifier hs-var">core_prs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LHsBinds GhcTc -&gt; DsM (OrdList Binding)
</span><a href="GHC.HsToCore.Binds.html#dsTopLHsBinds"><span class="hs-identifier hs-var">dsTopLHsBinds</span></a></span><span> </span><span class="annot"><span class="annottext">LHsBinds GhcTc
[GenLocated SrcSpanAnnA (HsBindLR GhcTc GhcTc)]
</span><a href="#local-6989586621683151487"><span class="hs-identifier hs-var">binds_cvr</span></a></span><span>
</span><span id="line-190"></span><span>                          </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683151519"><span class="annot"><a href="#local-6989586621683151519"><span class="hs-identifier hs-var">core_prs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.HsToCore.html#patchMagicDefns"><span class="hs-identifier hs-type">patchMagicDefns</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151517"><span class="hs-identifier hs-type">core_prs</span></a></span><span>
</span><span id="line-191"></span><span>                          </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683151521"><span class="annot"><a href="#local-6989586621683151521"><span class="hs-identifier hs-var">spec_prs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683151522"><span class="annot"><a href="#local-6989586621683151522"><span class="hs-identifier hs-var">spec_rules</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.HsToCore.html#dsImpSpecs"><span class="hs-identifier hs-type">dsImpSpecs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151441"><span class="hs-identifier hs-type">imp_specs</span></a></span><span>
</span><span id="line-192"></span><span>                          </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683151524"><span class="annot"><a href="#local-6989586621683151524"><span class="hs-identifier hs-var">ds_fords</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683151525"><span class="annot"><a href="#local-6989586621683151525"><span class="hs-identifier hs-var">foreign_prs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.HsToCore.Foreign.Decl.html#dsForeigns"><span class="hs-identifier hs-type">dsForeigns</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151449"><span class="hs-identifier hs-type">fords</span></a></span><span>
</span><span id="line-193"></span><span>                          </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683151527"><span class="annot"><a href="#local-6989586621683151527"><span class="hs-identifier hs-var">ds_rules</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Utils.Monad.html#mapMaybeM"><span class="hs-identifier hs-type">mapMaybeM</span></a></span><span> </span><span class="annot"><a href="GHC.HsToCore.html#dsRule"><span class="hs-identifier hs-type">dsRule</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151451"><span class="hs-identifier hs-type">rules</span></a></span><span>
</span><span id="line-194"></span><span>                          </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683151530"><span class="annot"><a href="#local-6989586621683151530"><span class="hs-identifier hs-var hs-var">hpc_init</span></a></span></span><span>
</span><span id="line-195"></span><span>                                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">GeneralFlag -&gt; DynFlags -&gt; Bool
</span><a href="GHC.Driver.DynFlags.html#gopt"><span class="hs-identifier hs-var">gopt</span></a></span><span> </span><span class="annot"><span class="annottext">GeneralFlag
</span><a href="GHC.Driver.Flags.html#Opt_Hpc"><span class="hs-identifier hs-var">Opt_Hpc</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683151468"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Platform -&gt; Module -&gt; HpcInfo -&gt; CStub
</span><a href="GHC.HsToCore.Coverage.html#hpcInitCode"><span class="hs-identifier hs-var">hpcInitCode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DynFlags -&gt; Platform
</span><a href="GHC.Driver.DynFlags.html#targetPlatform"><span class="hs-identifier hs-var">targetPlatform</span></a></span><span> </span><span class="annot"><span class="annottext">(DynFlags -&gt; Platform) -&gt; DynFlags -&gt; Platform
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; DynFlags
</span><a href="GHC.Driver.Env.Types.html#hsc_dflags"><span class="hs-identifier hs-var">hsc_dflags</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683151404"><span class="hs-identifier hs-var">hsc_env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621683151411"><span class="hs-identifier hs-var">mod</span></a></span><span> </span><span class="annot"><span class="annottext">HpcInfo
</span><a href="#local-6989586621683151502"><span class="hs-identifier hs-var">ds_hpc_info</span></a></span><span>
</span><span id="line-196"></span><span>                                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CStub
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-197"></span><span>                          </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="#local-6989586621683151516"><span class="hs-identifier hs-type">ds_ev_binds</span></a></span><span>
</span><span id="line-198"></span><span>                                   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683151525"><span class="hs-identifier hs-type">foreign_prs</span></a></span><span> </span><span class="annot"><a href="GHC.Data.OrdList.html#appOL"><span class="hs-operator hs-type">`appOL`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151519"><span class="hs-identifier hs-type">core_prs</span></a></span><span> </span><span class="annot"><a href="GHC.Data.OrdList.html#appOL"><span class="hs-operator hs-type">`appOL`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151521"><span class="hs-identifier hs-type">spec_prs</span></a></span><span>
</span><span id="line-199"></span><span>                                   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683151522"><span class="hs-identifier hs-type">spec_rules</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621683151527"><span class="hs-identifier hs-type">ds_rules</span></a></span><span>
</span><span id="line-200"></span><span>                                   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683151524"><span class="hs-identifier hs-type">ds_fords</span></a></span><span> </span><span class="annot"><a href="GHC.Types.ForeignStubs.html#appendStubC"><span class="hs-operator hs-type">`appendStubC`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151530"><span class="hs-identifier hs-type">hpc_init</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-201"></span><span>
</span><span id="line-202"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683151513"><span class="hs-identifier hs-type">mb_res</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-203"></span><span>           </span><span class="annot"><span class="annottext">Maybe ([CoreBind], OrdList Binding, [CoreRule], ForeignStubs)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Messages DsMessage, Maybe ModGuts)
-&gt; IO (Messages DsMessage, Maybe ModGuts)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Messages DsMessage
</span><a href="#local-6989586621683151512"><span class="hs-identifier hs-var">msgs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe ModGuts
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">;</span><span>
</span><span id="line-204"></span><span>           </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683151535"><span class="annot"><span class="annottext">[CoreBind]
</span><a href="#local-6989586621683151535"><span class="hs-identifier hs-var">ds_ev_binds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683151536"><span class="annot"><span class="annottext">OrdList Binding
</span><a href="#local-6989586621683151536"><span class="hs-identifier hs-var">all_prs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683151537"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621683151537"><span class="hs-identifier hs-var">all_rules</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683151538"><span class="annot"><span class="annottext">ForeignStubs
</span><a href="#local-6989586621683151538"><span class="hs-identifier hs-var">ds_fords</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-205"></span><span>
</span><span id="line-206"></span><span>     </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>       </span><span class="hs-comment">-- Add export flags to bindings</span><span>
</span><span id="line-207"></span><span>          </span><span id="local-6989586621683151539"><span class="annot"><a href="#local-6989586621683151539"><span class="hs-identifier hs-var">keep_alive</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcRef NameSet -&gt; IO NameSet
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">TcRef NameSet
</span><a href="#local-6989586621683151421"><span class="hs-identifier hs-var">keep_var</span></a></span><span>
</span><span id="line-208"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683151541"><span class="annot"><a href="#local-6989586621683151541"><span class="hs-identifier hs-var">rules_for_locals</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683151542"><span class="annot"><a href="#local-6989586621683151542"><span class="hs-identifier hs-var">rules_for_imps</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">partition</span></span><span> </span><span class="annot"><a href="GHC.Core.html#isLocalRule"><span class="hs-identifier hs-type">isLocalRule</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151537"><span class="hs-identifier hs-type">all_rules</span></a></span><span>
</span><span id="line-209"></span><span>              </span><span id="local-6989586621683151544"><span class="annot"><a href="#local-6989586621683151544"><span class="hs-identifier hs-var hs-var">final_prs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Backend
-&gt; NameSet -&gt; NameSet -&gt; [CoreRule] -&gt; [Binding] -&gt; [Binding]
forall t.
Backend
-&gt; NameSet -&gt; NameSet -&gt; [CoreRule] -&gt; [(Id, t)] -&gt; [(Id, t)]
</span><a href="GHC.HsToCore.html#addExportFlagsAndRules"><span class="hs-identifier hs-var">addExportFlagsAndRules</span></a></span><span> </span><span class="annot"><span class="annottext">Backend
</span><a href="#local-6989586621683151485"><span class="hs-identifier hs-var">bcknd</span></a></span><span> </span><span class="annot"><span class="annottext">NameSet
</span><a href="#local-6989586621683151483"><span class="hs-identifier hs-var">export_set</span></a></span><span> </span><span class="annot"><span class="annottext">NameSet
</span><a href="#local-6989586621683151539"><span class="hs-identifier hs-var">keep_alive</span></a></span><span>
</span><span id="line-210"></span><span>                                                 </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621683151541"><span class="hs-identifier hs-var">rules_for_locals</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OrdList Binding -&gt; [Binding]
forall a. OrdList a -&gt; [a]
</span><a href="GHC.Data.OrdList.html#fromOL"><span class="hs-identifier hs-var">fromOL</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList Binding
</span><a href="#local-6989586621683151536"><span class="hs-identifier hs-var">all_prs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-211"></span><span>
</span><span id="line-212"></span><span>              </span><span id="local-6989586621683151547"><span class="annot"><a href="#local-6989586621683151547"><span class="hs-identifier hs-var hs-var">final_pgm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CoreBind] -&gt; [Binding] -&gt; [CoreBind]
</span><a href="GHC.HsToCore.html#combineEvBinds"><span class="hs-identifier hs-var">combineEvBinds</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBind]
</span><a href="#local-6989586621683151535"><span class="hs-identifier hs-var">ds_ev_binds</span></a></span><span> </span><span class="annot"><span class="annottext">[Binding]
</span><a href="#local-6989586621683151544"><span class="hs-identifier hs-var">final_prs</span></a></span><span>
</span><span id="line-213"></span><span>        </span><span class="hs-comment">-- Notice that we put the whole lot in a big Rec, even the foreign binds</span><span>
</span><span id="line-214"></span><span>        </span><span class="hs-comment">-- When compiling PrelFloat, which defines data Float = F# Float#</span><span>
</span><span id="line-215"></span><span>        </span><span class="hs-comment">-- we want F# to be in scope in the foreign marshalling code!</span><span>
</span><span id="line-216"></span><span>        </span><span class="hs-comment">-- You might think it doesn't matter, but the simplifier brings all top-level</span><span>
</span><span id="line-217"></span><span>        </span><span class="hs-comment">-- things into the in-scope set before simplifying; so we get no unfolding for F#!</span><span>
</span><span id="line-218"></span><span>
</span><span id="line-219"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Driver.Config.Core.Lint.html#endPassHscEnvIO"><span class="hs-identifier hs-type">endPassHscEnvIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151404"><span class="hs-identifier hs-type">hsc_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151474"><span class="hs-identifier hs-type">name_ppr_ctx</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Pipeline.Types.html#CoreDesugar"><span class="hs-identifier hs-type">CoreDesugar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151547"><span class="hs-identifier hs-type">final_pgm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151542"><span class="hs-identifier hs-type">rules_for_imps</span></a></span><span>
</span><span id="line-220"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683151550"><span class="annot"><a href="#local-6989586621683151550"><span class="hs-identifier hs-var hs-var">simpl_opts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; SimpleOpts
</span><a href="GHC.Driver.Config.html#initSimpleOpts"><span class="hs-identifier hs-var">initSimpleOpts</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683151468"><span class="hs-identifier hs-var">dflags</span></a></span><span>
</span><span id="line-221"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683151552"><span class="annot"><a href="#local-6989586621683151552"><span class="hs-identifier hs-var">ds_binds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683151553"><span class="annot"><a href="#local-6989586621683151553"><span class="hs-identifier hs-var">ds_rules_for_imps</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683151554"><span class="annot"><a href="#local-6989586621683151554"><span class="hs-identifier hs-var">occ_anald_binds</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.SimpleOpt.html#simpleOptPgm"><span class="hs-identifier hs-type">simpleOptPgm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151550"><span class="hs-identifier hs-type">simpl_opts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151411"><span class="hs-identifier hs-type">mod</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151547"><span class="hs-identifier hs-type">final_pgm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151542"><span class="hs-identifier hs-type">rules_for_imps</span></a></span><span>
</span><span id="line-223"></span><span>                         </span><span class="hs-comment">-- The simpleOptPgm gets rid of type</span><span>
</span><span id="line-224"></span><span>                         </span><span class="hs-comment">-- bindings plus any stupid dead code</span><span>
</span><span id="line-225"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#putDumpFileMaybe"><span class="hs-identifier hs-type">putDumpFileMaybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151470"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><a href="GHC.Driver.Flags.html#Opt_D_dump_occur_anal"><span class="hs-identifier hs-type">Opt_D_dump_occur_anal</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Occurrence analysis&quot;</span></span><span>
</span><span id="line-226"></span><span>            </span><span class="annot"><a href="GHC.Utils.Logger.html#FormatCore"><span class="hs-identifier hs-type">FormatCore</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Ppr.html#pprCoreBindings"><span class="hs-identifier hs-type">pprCoreBindings</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151554"><span class="hs-identifier hs-type">occ_anald_binds</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-type">$$</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Ppr.html#pprRules"><span class="hs-identifier hs-type">pprRules</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151553"><span class="hs-identifier hs-type">ds_rules_for_imps</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-227"></span><span>
</span><span id="line-228"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Driver.Config.Core.Lint.html#endPassHscEnvIO"><span class="hs-identifier hs-type">endPassHscEnvIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151404"><span class="hs-identifier hs-type">hsc_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151474"><span class="hs-identifier hs-type">name_ppr_ctx</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Pipeline.Types.html#CoreDesugarOpt"><span class="hs-identifier hs-type">CoreDesugarOpt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151552"><span class="hs-identifier hs-type">ds_binds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151553"><span class="hs-identifier hs-type">ds_rules_for_imps</span></a></span><span>
</span><span id="line-229"></span><span>
</span><span id="line-230"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683151562"><span class="annot"><a href="#local-6989586621683151562"><span class="hs-identifier hs-var hs-var">used_names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcGblEnv -&gt; NameSet
</span><a href="GHC.HsToCore.Usage.html#mkUsedNames"><span class="hs-identifier hs-var">mkUsedNames</span></a></span><span> </span><span class="annot"><span class="annottext">TcGblEnv
</span><a href="#local-6989586621683151406"><span class="hs-identifier hs-var">tcg_env</span></a></span><span>
</span><span id="line-231"></span><span>              </span><span id="local-6989586621683151564"><span class="annot"><a href="#local-6989586621683151564"><span class="hs-identifier hs-var hs-var">pluginModules</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LoadedPlugin -&gt; ModIface) -&gt; [LoadedPlugin] -&gt; [ModIface]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">LoadedPlugin -&gt; ModIface
</span><a href="GHC.Driver.Plugins.html#lpModule"><span class="hs-identifier hs-var">lpModule</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Plugins -&gt; [LoadedPlugin]
</span><a href="GHC.Driver.Plugins.html#loadedPlugins"><span class="hs-identifier hs-var">loadedPlugins</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HscEnv -&gt; Plugins
</span><a href="GHC.Driver.Env.Types.html#hsc_plugins"><span class="hs-identifier hs-var">hsc_plugins</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683151404"><span class="hs-identifier hs-var">hsc_env</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-232"></span><span>              </span><span id="local-6989586621683151568"><span class="annot"><a href="#local-6989586621683151568"><span class="hs-identifier hs-var hs-var">home_unit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; HomeUnit
</span><a href="GHC.Driver.Env.html#hsc_home_unit"><span class="hs-identifier hs-var">hsc_home_unit</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683151404"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-233"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683151570"><span class="annot"><a href="#local-6989586621683151570"><span class="hs-identifier hs-var hs-var">deps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HomeUnit -&gt; Module -&gt; ImportAvails -&gt; [Module] -&gt; Dependencies
</span><a href="GHC.Unit.Module.Deps.html#mkDependencies"><span class="hs-identifier hs-var">mkDependencies</span></a></span><span> </span><span class="annot"><span class="annottext">HomeUnit
</span><a href="#local-6989586621683151568"><span class="hs-identifier hs-var">home_unit</span></a></span><span>
</span><span id="line-234"></span><span>                                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcGblEnv -&gt; Module
</span><a href="GHC.Tc.Types.html#tcg_mod"><span class="hs-identifier hs-var">tcg_mod</span></a></span><span> </span><span class="annot"><span class="annottext">TcGblEnv
</span><a href="#local-6989586621683151406"><span class="hs-identifier hs-var">tcg_env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-235"></span><span>                                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcGblEnv -&gt; ImportAvails
</span><a href="GHC.Tc.Types.html#tcg_imports"><span class="hs-identifier hs-var">tcg_imports</span></a></span><span> </span><span class="annot"><span class="annottext">TcGblEnv
</span><a href="#local-6989586621683151406"><span class="hs-identifier hs-var">tcg_env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-236"></span><span>                                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ModIface -&gt; Module) -&gt; [ModIface] -&gt; [Module]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">ModIface -&gt; Module
forall (phase :: ModIfacePhase). ModIface_ phase -&gt; Module
</span><a href="GHC.Unit.Module.ModIface.html#mi_module"><span class="hs-identifier hs-var">mi_module</span></a></span><span> </span><span class="annot"><span class="annottext">[ModIface]
</span><a href="#local-6989586621683151564"><span class="hs-identifier hs-var">pluginModules</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-237"></span><span>
</span><span id="line-238"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683151573"><span class="annot"><a href="#local-6989586621683151573"><span class="hs-identifier hs-var">used_th</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">readIORef</span></span><span> </span><span class="annot"><a href="#local-6989586621683151423"><span class="hs-identifier hs-type">tc_splice_used</span></a></span><span>
</span><span id="line-239"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683151574"><span class="annot"><a href="#local-6989586621683151574"><span class="hs-identifier hs-var">dep_files</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">readIORef</span></span><span> </span><span class="annot"><a href="#local-6989586621683151443"><span class="hs-identifier hs-type">dependent_files</span></a></span><span>
</span><span id="line-240"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683151575"><span class="annot"><a href="#local-6989586621683151575"><span class="hs-identifier hs-var">safe_mode</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#finalSafeMode"><span class="hs-identifier hs-type">finalSafeMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151468"><span class="hs-identifier hs-type">dflags</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151406"><span class="hs-identifier hs-type">tcg_env</span></a></span><span>
</span><span id="line-241"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683151576"><span class="annot"><a href="#local-6989586621683151576"><span class="hs-identifier hs-var">needed_mods</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683151577"><span class="annot"><a href="#local-6989586621683151577"><span class="hs-identifier hs-var">needed_pkgs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">readIORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.html#tcg_th_needed_deps"><span class="hs-identifier hs-var">tcg_th_needed_deps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151406"><span class="hs-identifier hs-type">tcg_env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span>
</span><span id="line-243"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683151579"><span class="annot"><a href="#local-6989586621683151579"><span class="hs-identifier hs-var hs-var">uc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; UsageConfig
</span><a href="GHC.Driver.Config.HsToCore.Usage.html#initUsageConfig"><span class="hs-identifier hs-var">initUsageConfig</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683151404"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-244"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683151581"><span class="annot"><a href="#local-6989586621683151581"><span class="hs-identifier hs-var hs-var">plugins</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; Plugins
</span><a href="GHC.Driver.Env.Types.html#hsc_plugins"><span class="hs-identifier hs-var">hsc_plugins</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683151404"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-245"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683151582"><span class="annot"><a href="#local-6989586621683151582"><span class="hs-identifier hs-var hs-var">fc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; FinderCache
</span><a href="GHC.Driver.Env.Types.html#hsc_FC"><span class="hs-identifier hs-var">hsc_FC</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683151404"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-246"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683151584"><span class="annot"><a href="#local-6989586621683151584"><span class="hs-identifier hs-var hs-var">unit_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; UnitEnv
</span><a href="GHC.Driver.Env.Types.html#hsc_unit_env"><span class="hs-identifier hs-var">hsc_unit_env</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683151404"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-247"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683151585"><span class="annot"><a href="#local-6989586621683151585"><span class="hs-identifier hs-var">usages</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#initIfaceLoad"><span class="hs-identifier hs-type">initIfaceLoad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151404"><span class="hs-identifier hs-type">hsc_env</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-248"></span><span>                      </span><span class="annot"><a href="GHC.HsToCore.Usage.html#mkUsageInfo"><span class="hs-identifier hs-type">mkUsageInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151579"><span class="hs-identifier hs-type">uc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151581"><span class="hs-identifier hs-type">plugins</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151582"><span class="hs-identifier hs-type">fc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151584"><span class="hs-identifier hs-type">unit_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151411"><span class="hs-identifier hs-type">mod</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Unit.Module.Deps.html#imp_mods"><span class="hs-identifier hs-var">imp_mods</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151417"><span class="hs-identifier hs-type">imports</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683151562"><span class="hs-identifier hs-type">used_names</span></a></span><span>
</span><span id="line-249"></span><span>                        </span><span class="annot"><a href="#local-6989586621683151574"><span class="hs-identifier hs-type">dep_files</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151433"><span class="hs-identifier hs-type">merged</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151576"><span class="hs-identifier hs-type">needed_mods</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151577"><span class="hs-identifier hs-type">needed_pkgs</span></a></span><span>
</span><span id="line-250"></span><span>        </span><span class="hs-comment">-- id_mod /= mod when we are processing an hsig, but hsigs</span><span>
</span><span id="line-251"></span><span>        </span><span class="hs-comment">-- never desugared and compiled (there's no code!)</span><span>
</span><span id="line-252"></span><span>        </span><span class="hs-comment">-- Consequently, this should hold for any ModGuts that make</span><span>
</span><span id="line-253"></span><span>        </span><span class="hs-comment">-- past desugaring. See Note [Identity versus semantic module].</span><span>
</span><span id="line-254"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.Plain.html#massert"><span class="hs-identifier hs-type">massert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683151409"><span class="hs-identifier hs-type">id_mod</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">==</span></span><span> </span><span class="annot"><a href="#local-6989586621683151411"><span class="hs-identifier hs-type">mod</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-255"></span><span>
</span><span id="line-256"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683151589"><span class="annot"><a href="#local-6989586621683151589"><span class="hs-identifier hs-var">foreign_files</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">readIORef</span></span><span> </span><span class="annot"><a href="#local-6989586621683151447"><span class="hs-identifier hs-type">th_foreign_files_var</span></a></span><span>
</span><span id="line-257"></span><span>
</span><span id="line-258"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683151590"><span class="annot"><a href="#local-6989586621683151590"><span class="hs-identifier hs-var">docs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.HsToCore.Docs.html#extractDocs"><span class="hs-identifier hs-type">extractDocs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151468"><span class="hs-identifier hs-type">dflags</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151406"><span class="hs-identifier hs-type">tcg_env</span></a></span><span>
</span><span id="line-259"></span><span>
</span><span id="line-260"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683151592"><span class="annot"><a href="#local-6989586621683151592"><span class="hs-identifier hs-var hs-var">mod_guts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html#ModGuts"><span class="hs-identifier hs-type">ModGuts</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-261"></span><span>                </span><span class="annot"><span class="annottext">mg_module :: Module
</span><a href="GHC.Unit.Module.ModGuts.html#mg_module"><span class="hs-identifier hs-var">mg_module</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621683151411"><span class="hs-identifier hs-var">mod</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-262"></span><span>                </span><span class="annot"><span class="annottext">mg_hsc_src :: HscSource
</span><a href="GHC.Unit.Module.ModGuts.html#mg_hsc_src"><span class="hs-identifier hs-var">mg_hsc_src</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HscSource
</span><a href="#local-6989586621683151413"><span class="hs-identifier hs-var">hsc_src</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-263"></span><span>                </span><span class="annot"><span class="annottext">mg_loc :: SrcSpan
</span><a href="GHC.Unit.Module.ModGuts.html#mg_loc"><span class="hs-identifier hs-var">mg_loc</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ModLocation -&gt; SrcSpan
</span><a href="GHC.Unit.Module.Location.html#mkFileSrcSpan"><span class="hs-identifier hs-var">mkFileSrcSpan</span></a></span><span> </span><span class="annot"><span class="annottext">ModLocation
</span><a href="#local-6989586621683151405"><span class="hs-identifier hs-var">mod_loc</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-264"></span><span>                </span><span class="annot"><span class="annottext">mg_exports :: [AvailInfo]
</span><a href="GHC.Unit.Module.ModGuts.html#mg_exports"><span class="hs-identifier hs-var">mg_exports</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[AvailInfo]
</span><a href="#local-6989586621683151419"><span class="hs-identifier hs-var">exports</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-265"></span><span>                </span><span class="annot"><span class="annottext">mg_usages :: [Usage]
</span><a href="GHC.Unit.Module.ModGuts.html#mg_usages"><span class="hs-identifier hs-var">mg_usages</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Usage]
</span><a href="#local-6989586621683151585"><span class="hs-identifier hs-var">usages</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-266"></span><span>                </span><span class="annot"><span class="annottext">mg_deps :: Dependencies
</span><a href="GHC.Unit.Module.ModGuts.html#mg_deps"><span class="hs-identifier hs-var">mg_deps</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Dependencies
</span><a href="#local-6989586621683151570"><span class="hs-identifier hs-var">deps</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-267"></span><span>                </span><span class="annot"><span class="annottext">mg_used_th :: Bool
</span><a href="GHC.Unit.Module.ModGuts.html#mg_used_th"><span class="hs-identifier hs-var">mg_used_th</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683151573"><span class="hs-identifier hs-var">used_th</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-268"></span><span>                </span><span class="annot"><span class="annottext">mg_rdr_env :: GlobalRdrEnv
</span><a href="GHC.Unit.Module.ModGuts.html#mg_rdr_env"><span class="hs-identifier hs-var">mg_rdr_env</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GlobalRdrEnv
</span><a href="#local-6989586621683151425"><span class="hs-identifier hs-var">rdr_env</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-269"></span><span>                </span><span class="annot"><span class="annottext">mg_fix_env :: FixityEnv
</span><a href="GHC.Unit.Module.ModGuts.html#mg_fix_env"><span class="hs-identifier hs-var">mg_fix_env</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FixityEnv
</span><a href="#local-6989586621683151427"><span class="hs-identifier hs-var">fix_env</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-270"></span><span>                </span><span class="annot"><span class="annottext">mg_warns :: Warnings GhcRn
</span><a href="GHC.Unit.Module.ModGuts.html#mg_warns"><span class="hs-identifier hs-var">mg_warns</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Warnings GhcRn
</span><a href="#local-6989586621683151435"><span class="hs-identifier hs-var">warns</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-271"></span><span>                </span><span class="annot"><span class="annottext">mg_anns :: [Annotation]
</span><a href="GHC.Unit.Module.ModGuts.html#mg_anns"><span class="hs-identifier hs-var">mg_anns</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Annotation]
</span><a href="#local-6989586621683151437"><span class="hs-identifier hs-var">anns</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-272"></span><span>                </span><span class="annot"><span class="annottext">mg_tcs :: [TyCon]
</span><a href="GHC.Unit.Module.ModGuts.html#mg_tcs"><span class="hs-identifier hs-var">mg_tcs</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyCon]
</span><a href="#local-6989586621683151455"><span class="hs-identifier hs-var">tcs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-273"></span><span>                </span><span class="annot"><span class="annottext">mg_defaults :: DefaultEnv
</span><a href="GHC.Unit.Module.ModGuts.html#mg_defaults"><span class="hs-identifier hs-var">mg_defaults</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DefaultEnv
</span><a href="#local-6989586621683151457"><span class="hs-identifier hs-var">defaults</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-274"></span><span>                </span><span class="annot"><span class="annottext">mg_insts :: [ClsInst]
</span><a href="GHC.Unit.Module.ModGuts.html#mg_insts"><span class="hs-identifier hs-var">mg_insts</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SafeHaskellMode -&gt; [ClsInst] -&gt; [ClsInst]
</span><a href="GHC.Tc.Utils.Monad.html#fixSafeInstances"><span class="hs-identifier hs-var">fixSafeInstances</span></a></span><span> </span><span class="annot"><span class="annottext">SafeHaskellMode
</span><a href="#local-6989586621683151575"><span class="hs-identifier hs-var">safe_mode</span></a></span><span> </span><span class="annot"><span class="annottext">[ClsInst]
</span><a href="#local-6989586621683151459"><span class="hs-identifier hs-var">insts</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-275"></span><span>                </span><span class="annot"><span class="annottext">mg_fam_insts :: [FamInst]
</span><a href="GHC.Unit.Module.ModGuts.html#mg_fam_insts"><span class="hs-identifier hs-var">mg_fam_insts</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[FamInst]
</span><a href="#local-6989586621683151461"><span class="hs-identifier hs-var">fam_insts</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-276"></span><span>                </span><span class="annot"><span class="annottext">mg_inst_env :: InstEnv
</span><a href="GHC.Unit.Module.ModGuts.html#mg_inst_env"><span class="hs-identifier hs-var">mg_inst_env</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InstEnv
</span><a href="#local-6989586621683151429"><span class="hs-identifier hs-var">inst_env</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-277"></span><span>                </span><span class="annot"><span class="annottext">mg_fam_inst_env :: FamInstEnv
</span><a href="GHC.Unit.Module.ModGuts.html#mg_fam_inst_env"><span class="hs-identifier hs-var">mg_fam_inst_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FamInstEnv
</span><a href="#local-6989586621683151431"><span class="hs-identifier hs-var">fam_inst_env</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-278"></span><span>                </span><span class="annot"><span class="annottext">mg_boot_exports :: NameSet
</span><a href="GHC.Unit.Module.ModGuts.html#mg_boot_exports"><span class="hs-identifier hs-var">mg_boot_exports</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SelfBootInfo -&gt; NameSet
</span><a href="GHC.Tc.Types.html#bootExports"><span class="hs-identifier hs-var">bootExports</span></a></span><span> </span><span class="annot"><span class="annottext">SelfBootInfo
</span><a href="#local-6989586621683151467"><span class="hs-identifier hs-var">self_boot</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-279"></span><span>                </span><span class="annot"><span class="annottext">mg_patsyns :: [PatSyn]
</span><a href="GHC.Unit.Module.ModGuts.html#mg_patsyns"><span class="hs-identifier hs-var">mg_patsyns</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PatSyn]
</span><a href="#local-6989586621683151453"><span class="hs-identifier hs-var">patsyns</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-280"></span><span>                </span><span class="annot"><span class="annottext">mg_rules :: [CoreRule]
</span><a href="GHC.Unit.Module.ModGuts.html#mg_rules"><span class="hs-identifier hs-var">mg_rules</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621683151553"><span class="hs-identifier hs-var">ds_rules_for_imps</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-281"></span><span>                </span><span class="annot"><span class="annottext">mg_binds :: [CoreBind]
</span><a href="GHC.Unit.Module.ModGuts.html#mg_binds"><span class="hs-identifier hs-var">mg_binds</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CoreBind]
</span><a href="#local-6989586621683151552"><span class="hs-identifier hs-var">ds_binds</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-282"></span><span>                </span><span class="annot"><span class="annottext">mg_foreign :: ForeignStubs
</span><a href="GHC.Unit.Module.ModGuts.html#mg_foreign"><span class="hs-identifier hs-var">mg_foreign</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ForeignStubs
</span><a href="#local-6989586621683151538"><span class="hs-identifier hs-var">ds_fords</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-283"></span><span>                </span><span class="annot"><span class="annottext">mg_foreign_files :: [(ForeignSrcLang, FilePath)]
</span><a href="GHC.Unit.Module.ModGuts.html#mg_foreign_files"><span class="hs-identifier hs-var">mg_foreign_files</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(ForeignSrcLang, FilePath)]
</span><a href="#local-6989586621683151589"><span class="hs-identifier hs-var">foreign_files</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-284"></span><span>                </span><span class="annot"><span class="annottext">mg_hpc_info :: HpcInfo
</span><a href="GHC.Unit.Module.ModGuts.html#mg_hpc_info"><span class="hs-identifier hs-var">mg_hpc_info</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HpcInfo
</span><a href="#local-6989586621683151502"><span class="hs-identifier hs-var">ds_hpc_info</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-285"></span><span>                </span><span class="annot"><span class="annottext">mg_modBreaks :: Maybe ModBreaks
</span><a href="GHC.Unit.Module.ModGuts.html#mg_modBreaks"><span class="hs-identifier hs-var">mg_modBreaks</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ModBreaks
</span><a href="#local-6989586621683151494"><span class="hs-identifier hs-var">modBreaks</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-286"></span><span>                </span><span class="annot"><span class="annottext">mg_safe_haskell :: SafeHaskellMode
</span><a href="GHC.Unit.Module.ModGuts.html#mg_safe_haskell"><span class="hs-identifier hs-var">mg_safe_haskell</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SafeHaskellMode
</span><a href="#local-6989586621683151575"><span class="hs-identifier hs-var">safe_mode</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-287"></span><span>                </span><span class="annot"><span class="annottext">mg_trust_pkg :: Bool
</span><a href="GHC.Unit.Module.ModGuts.html#mg_trust_pkg"><span class="hs-identifier hs-var">mg_trust_pkg</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ImportAvails -&gt; Bool
</span><a href="GHC.Unit.Module.Deps.html#imp_trust_own_pkg"><span class="hs-identifier hs-var">imp_trust_own_pkg</span></a></span><span> </span><span class="annot"><span class="annottext">ImportAvails
</span><a href="#local-6989586621683151417"><span class="hs-identifier hs-var">imports</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-288"></span><span>                </span><span class="annot"><span class="annottext">mg_complete_matches :: CompleteMatches
</span><a href="GHC.Unit.Module.ModGuts.html#mg_complete_matches"><span class="hs-identifier hs-var">mg_complete_matches</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CompleteMatches
</span><a href="#local-6989586621683151465"><span class="hs-identifier hs-var">complete_matches</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-289"></span><span>                </span><span class="annot"><span class="annottext">mg_docs :: Maybe Docs
</span><a href="GHC.Unit.Module.ModGuts.html#mg_docs"><span class="hs-identifier hs-var">mg_docs</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Docs
</span><a href="#local-6989586621683151590"><span class="hs-identifier hs-var">docs</span></a></span><span>
</span><span id="line-290"></span><span>              </span><span class="hs-special">}</span><span>
</span><span id="line-291"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683151512"><span class="hs-identifier hs-type">msgs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="#local-6989586621683151592"><span class="hs-identifier hs-type">mod_guts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-292"></span><span>        </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><span id="line-293"></span><span>
</span><span id="line-294"></span><span class="annot"><a href="GHC.HsToCore.html#dsImpSpecs"><span class="hs-identifier hs-type">dsImpSpecs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Hs.Binds.html#LTcSpecPrag"><span class="hs-identifier hs-type">LTcSpecPrag</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.HsToCore.Types.html#DsM"><span class="hs-identifier hs-type">DsM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.OrdList.html#OrdList"><span class="hs-identifier hs-type">OrdList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-295"></span><span id="dsImpSpecs"><span class="annot"><span class="annottext">dsImpSpecs :: [LTcSpecPrag] -&gt; DsM (OrdList Binding, [CoreRule])
</span><a href="GHC.HsToCore.html#dsImpSpecs"><span class="hs-identifier hs-var hs-var">dsImpSpecs</span></a></span></span><span> </span><span id="local-6989586621683151626"><span class="annot"><span class="annottext">[LTcSpecPrag]
</span><a href="#local-6989586621683151626"><span class="hs-identifier hs-var">imp_specs</span></a></span></span><span>
</span><span id="line-296"></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683151627"><span class="annot"><a href="#local-6989586621683151627"><span class="hs-identifier hs-var">spec_prs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(LTcSpecPrag
 -&gt; IOEnv
      (Env DsGblEnv DsLclEnv) (Maybe (OrdList Binding, CoreRule)))
-&gt; [LTcSpecPrag]
-&gt; IOEnv (Env DsGblEnv DsLclEnv) [(OrdList Binding, CoreRule)]
forall (m :: * -&gt; *) a b.
Applicative m =&gt;
(a -&gt; m (Maybe b)) -&gt; [a] -&gt; m [b]
</span><a href="GHC.Utils.Monad.html#mapMaybeM"><span class="hs-identifier hs-var">mapMaybeM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe CoreExpr
-&gt; LTcSpecPrag
-&gt; IOEnv
     (Env DsGblEnv DsLclEnv) (Maybe (OrdList Binding, CoreRule))
</span><a href="GHC.HsToCore.Binds.html#dsSpec"><span class="hs-identifier hs-var">dsSpec</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe CoreExpr
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[LTcSpecPrag]
</span><a href="#local-6989586621683151626"><span class="hs-identifier hs-var">imp_specs</span></a></span><span>
</span><span id="line-297"></span><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683151629"><span class="annot"><a href="#local-6989586621683151629"><span class="hs-identifier hs-var">spec_binds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683151630"><span class="annot"><a href="#local-6989586621683151630"><span class="hs-identifier hs-var">spec_rules</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">unzip</span></span><span> </span><span class="annot"><a href="#local-6989586621683151627"><span class="hs-identifier hs-type">spec_prs</span></a></span><span>
</span><span id="line-298"></span><span>      </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.OrdList.html#concatOL"><span class="hs-identifier hs-type">concatOL</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151629"><span class="hs-identifier hs-type">spec_binds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683151630"><span class="hs-identifier hs-type">spec_rules</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-299"></span><span>
</span><span id="line-300"></span><span class="annot"><a href="GHC.HsToCore.html#combineEvBinds"><span class="hs-identifier hs-type">combineEvBinds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-301"></span><span class="hs-comment">-- Top-level bindings can include coercion bindings, but not via superclasses</span><span>
</span><span id="line-302"></span><span class="hs-comment">-- See Note [Top-level evidence]</span><span>
</span><span id="line-303"></span><span id="combineEvBinds"><span class="annot"><span class="annottext">combineEvBinds :: [CoreBind] -&gt; [Binding] -&gt; [CoreBind]
</span><a href="GHC.HsToCore.html#combineEvBinds"><span class="hs-identifier hs-var hs-var">combineEvBinds</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621683151633"><span class="annot"><span class="annottext">[Binding]
</span><a href="#local-6989586621683151633"><span class="hs-identifier hs-var">val_prs</span></a></span></span><span>
</span><span id="line-304"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[Binding] -&gt; CoreBind
forall b. [(b, Expr b)] -&gt; Bind b
</span><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-var">Rec</span></a></span><span> </span><span class="annot"><span class="annottext">[Binding]
</span><a href="#local-6989586621683151633"><span class="hs-identifier hs-var">val_prs</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-305"></span><span class="annot"><a href="GHC.HsToCore.html#combineEvBinds"><span class="hs-identifier hs-var">combineEvBinds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span id="local-6989586621683151636"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151636"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621683151637"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621683151637"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621683151638"><span class="annot"><span class="annottext">[CoreBind]
</span><a href="#local-6989586621683151638"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621683151639"><span class="annot"><span class="annottext">[Binding]
</span><a href="#local-6989586621683151639"><span class="hs-identifier hs-var">val_prs</span></a></span></span><span>
</span><span id="line-306"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151636"><span class="hs-identifier hs-var">b</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CoreBind] -&gt; [Binding] -&gt; [CoreBind]
</span><a href="GHC.HsToCore.html#combineEvBinds"><span class="hs-identifier hs-var">combineEvBinds</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBind]
</span><a href="#local-6989586621683151638"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151636"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621683151637"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span class="annot"><span class="annottext">Binding -&gt; [Binding] -&gt; [Binding]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[Binding]
</span><a href="#local-6989586621683151639"><span class="hs-identifier hs-var">val_prs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-307"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; CoreExpr -&gt; CoreBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151636"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621683151637"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind -&gt; [CoreBind] -&gt; [CoreBind]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[CoreBind] -&gt; [Binding] -&gt; [CoreBind]
</span><a href="GHC.HsToCore.html#combineEvBinds"><span class="hs-identifier hs-var">combineEvBinds</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBind]
</span><a href="#local-6989586621683151638"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">[Binding]
</span><a href="#local-6989586621683151639"><span class="hs-identifier hs-var">val_prs</span></a></span><span>
</span><span id="line-308"></span><span class="annot"><a href="GHC.HsToCore.html#combineEvBinds"><span class="hs-identifier hs-var">combineEvBinds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span id="local-6989586621683151641"><span class="annot"><span class="annottext">[Binding]
</span><a href="#local-6989586621683151641"><span class="hs-identifier hs-var">prs</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621683151642"><span class="annot"><span class="annottext">[CoreBind]
</span><a href="#local-6989586621683151642"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621683151643"><span class="annot"><span class="annottext">[Binding]
</span><a href="#local-6989586621683151643"><span class="hs-identifier hs-var">val_prs</span></a></span></span><span>
</span><span id="line-309"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CoreBind] -&gt; [Binding] -&gt; [CoreBind]
</span><a href="GHC.HsToCore.html#combineEvBinds"><span class="hs-identifier hs-var">combineEvBinds</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBind]
</span><a href="#local-6989586621683151642"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Binding]
</span><a href="#local-6989586621683151641"><span class="hs-identifier hs-var">prs</span></a></span><span> </span><span class="annot"><span class="annottext">[Binding] -&gt; [Binding] -&gt; [Binding]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Binding]
</span><a href="#local-6989586621683151643"><span class="hs-identifier hs-var">val_prs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-310"></span><span>
</span><span id="line-311"></span><span class="hs-comment">{-
Note [Top-level evidence]
~~~~~~~~~~~~~~~~~~~~~~~~~
Top-level evidence bindings may be mutually recursive with the top-level value
bindings, so we must put those in a Rec.  But we can't put them *all* in a Rec
because the occurrence analyser doesn't take account of type/coercion variables
when computing dependencies.

So we pull out the type/coercion variables (which are in dependency order),
and Rec the rest.
-}</span><span>
</span><span id="line-322"></span><span>
</span><span id="line-323"></span><span class="annot"><a href="GHC.HsToCore.html#deSugarExpr"><span class="hs-identifier hs-type">deSugarExpr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#LHsExpr"><span class="hs-identifier hs-type">LHsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcTc"><span class="hs-identifier hs-type">GhcTc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Error.html#Messages"><span class="hs-identifier hs-type">Messages</span></a></span><span> </span><span class="annot"><a href="GHC.HsToCore.Errors.Types.html#DsMessage"><span class="hs-identifier hs-type">DsMessage</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-324"></span><span id="deSugarExpr"><span class="annot"><span class="annottext">deSugarExpr :: HscEnv -&gt; LHsExpr GhcTc -&gt; IO (Messages DsMessage, Maybe CoreExpr)
</span><a href="GHC.HsToCore.html#deSugarExpr"><span class="hs-identifier hs-var hs-var">deSugarExpr</span></a></span></span><span> </span><span id="local-6989586621683151644"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683151644"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span id="local-6989586621683151645"><span class="annot"><span class="annottext">LHsExpr GhcTc
</span><a href="#local-6989586621683151645"><span class="hs-identifier hs-var">tc_expr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-325"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683151646"><span class="annot"><span class="annottext">logger :: Logger
</span><a href="#local-6989586621683151646"><span class="hs-identifier hs-var hs-var hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; Logger
</span><a href="GHC.Driver.Env.Types.html#hsc_logger"><span class="hs-identifier hs-var">hsc_logger</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683151644"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-326"></span><span>
</span><span id="line-327"></span><span>    </span><span class="annot"><span class="annottext">Logger -&gt; FilePath -&gt; IO ()
</span><a href="GHC.Utils.Error.html#showPass"><span class="hs-identifier hs-var">showPass</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621683151646"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Desugar&quot;</span></span><span>
</span><span id="line-328"></span><span>
</span><span id="line-329"></span><span>    </span><span class="hs-comment">-- Do desugaring</span><span>
</span><span id="line-330"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621683151648"><span class="annot"><a href="#local-6989586621683151648"><span class="hs-identifier hs-var">tc_msgs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683151649"><span class="annot"><a href="#local-6989586621683151649"><span class="hs-identifier hs-var">mb_result</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HscEnv
-&gt; TcRn (Messages DsMessage, Maybe CoreExpr)
-&gt; IO
     (Messages TcRnMessage, Maybe (Messages DsMessage, Maybe CoreExpr))
forall a. HscEnv -&gt; TcRn a -&gt; IO (Messages TcRnMessage, Maybe a)
</span><a href="GHC.Tc.Module.html#runTcInteractive"><span class="hs-identifier hs-var">runTcInteractive</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683151644"><span class="hs-identifier hs-var">hsc_env</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRn (Messages DsMessage, Maybe CoreExpr)
 -&gt; IO
      (Messages TcRnMessage, Maybe (Messages DsMessage, Maybe CoreExpr)))
-&gt; TcRn (Messages DsMessage, Maybe CoreExpr)
-&gt; IO
     (Messages TcRnMessage, Maybe (Messages DsMessage, Maybe CoreExpr))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-331"></span><span>                            </span><span class="annot"><span class="annottext">DsM CoreExpr -&gt; TcRn (Messages DsMessage, Maybe CoreExpr)
forall a. DsM a -&gt; TcM (Messages DsMessage, Maybe a)
</span><a href="GHC.HsToCore.Monad.html#initDsTc"><span class="hs-identifier hs-var">initDsTc</span></a></span><span> </span><span class="annot"><span class="annottext">(DsM CoreExpr -&gt; TcRn (Messages DsMessage, Maybe CoreExpr))
-&gt; DsM CoreExpr -&gt; TcRn (Messages DsMessage, Maybe CoreExpr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-332"></span><span>                            </span><span class="annot"><span class="annottext">LHsExpr GhcTc -&gt; DsM CoreExpr
</span><a href="GHC.HsToCore.Expr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a></span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcTc
</span><a href="#local-6989586621683151645"><span class="hs-identifier hs-var">tc_expr</span></a></span><span>
</span><span id="line-333"></span><span>
</span><span id="line-334"></span><span>    </span><span class="annot"><a href="GHC.Utils.Panic.Plain.html#massert"><span class="hs-identifier hs-type">massert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Error.html#isEmptyMessages"><span class="hs-identifier hs-type">isEmptyMessages</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151648"><span class="hs-identifier hs-type">tc_msgs</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- the type-checker isn't doing anything here</span><span>
</span><span id="line-335"></span><span>
</span><span id="line-336"></span><span>      </span><span class="hs-comment">-- mb_result is Nothing only when a failure happens in the type-checker,</span><span>
</span><span id="line-337"></span><span>      </span><span class="hs-comment">-- but mb_core_expr is Nothing when a failure happens in the desugarer</span><span>
</span><span id="line-338"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683151653"><span class="annot"><a href="#local-6989586621683151653"><span class="hs-identifier hs-var">ds_msgs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683151654"><span class="annot"><a href="#local-6989586621683151654"><span class="hs-identifier hs-var">mb_core_expr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Data.Maybe.html#expectJust"><span class="hs-identifier hs-type">expectJust</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;deSugarExpr&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621683151649"><span class="hs-identifier hs-type">mb_result</span></a></span><span>
</span><span id="line-339"></span><span>
</span><span id="line-340"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683151654"><span class="hs-identifier hs-type">mb_core_expr</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-341"></span><span>       </span><span class="annot"><span class="annottext">Maybe CoreExpr
</span><span class="hs-identifier hs-var">Nothing</span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-342"></span><span>       </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683151655"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621683151655"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Logger -&gt; DumpFlag -&gt; FilePath -&gt; DumpFormat -&gt; SDoc -&gt; IO ()
</span><a href="GHC.Utils.Logger.html#putDumpFileMaybe"><span class="hs-identifier hs-var">putDumpFileMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621683151646"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">DumpFlag
</span><a href="GHC.Driver.Flags.html#Opt_D_dump_ds"><span class="hs-identifier hs-var">Opt_D_dump_ds</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Desugared&quot;</span></span><span>
</span><span id="line-343"></span><span>                    </span><span class="annot"><span class="annottext">DumpFormat
</span><a href="GHC.Utils.Logger.html#FormatCore"><span class="hs-identifier hs-var">FormatCore</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; SDoc
forall b. OutputableBndr b =&gt; Expr b -&gt; SDoc
</span><a href="GHC.Core.Ppr.html#pprCoreExpr"><span class="hs-identifier hs-var">pprCoreExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621683151655"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-344"></span><span>
</span><span id="line-345"></span><span>      </span><span class="hs-comment">-- callers (i.e. ioMsgMaybe) expect that no expression is returned if</span><span>
</span><span id="line-346"></span><span>      </span><span class="hs-comment">-- there are errors</span><span>
</span><span id="line-347"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683151658"><span class="annot"><a href="#local-6989586621683151658"><span class="hs-identifier hs-var hs-var">final_res</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Messages DsMessage -&gt; Bool
forall e. Diagnostic e =&gt; Messages e -&gt; Bool
</span><a href="GHC.Types.Error.html#errorsFound"><span class="hs-identifier hs-var">errorsFound</span></a></span><span> </span><span class="annot"><span class="annottext">Messages DsMessage
</span><a href="#local-6989586621683151653"><span class="hs-identifier hs-var">ds_msgs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe CoreExpr
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-348"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe CoreExpr
</span><a href="#local-6989586621683151654"><span class="hs-identifier hs-var">mb_core_expr</span></a></span><span>
</span><span id="line-349"></span><span>
</span><span id="line-350"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683151653"><span class="hs-identifier hs-type">ds_msgs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683151658"><span class="hs-identifier hs-type">final_res</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-351"></span><span>
</span><span id="line-352"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
*              Add rules and export flags to binders
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-359"></span><span>
</span><span id="line-360"></span><span id="local-6989586621683151076"><span class="annot"><a href="GHC.HsToCore.html#addExportFlagsAndRules"><span class="hs-identifier hs-type">addExportFlagsAndRules</span></a></span><span>
</span><span id="line-361"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Backend.html#Backend"><span class="hs-identifier hs-type">Backend</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html#NameSet"><span class="hs-identifier hs-type">NameSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html#NameSet"><span class="hs-identifier hs-type">NameSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-362"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683151076"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683151076"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span></span><span>
</span><span id="line-363"></span><span id="addExportFlagsAndRules"><span class="annot"><span class="annottext">addExportFlagsAndRules :: forall t.
Backend
-&gt; NameSet -&gt; NameSet -&gt; [CoreRule] -&gt; [(Id, t)] -&gt; [(Id, t)]
</span><a href="GHC.HsToCore.html#addExportFlagsAndRules"><span class="hs-identifier hs-var hs-var">addExportFlagsAndRules</span></a></span></span><span> </span><span id="local-6989586621683151662"><span class="annot"><span class="annottext">Backend
</span><a href="#local-6989586621683151662"><span class="hs-identifier hs-var">bcknd</span></a></span></span><span> </span><span id="local-6989586621683151663"><span class="annot"><span class="annottext">NameSet
</span><a href="#local-6989586621683151663"><span class="hs-identifier hs-var">exports</span></a></span></span><span> </span><span id="local-6989586621683151664"><span class="annot"><span class="annottext">NameSet
</span><a href="#local-6989586621683151664"><span class="hs-identifier hs-var">keep_alive</span></a></span></span><span> </span><span id="local-6989586621683151665"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621683151665"><span class="hs-identifier hs-var">rules</span></a></span></span><span>
</span><span id="line-364"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Id) -&gt; [(Id, t)] -&gt; [(Id, t)]
forall (f :: * -&gt; *) a c b.
Functor f =&gt;
(a -&gt; c) -&gt; f (a, b) -&gt; f (c, b)
</span><a href="GHC.Utils.Misc.html#mapFst"><span class="hs-identifier hs-var">mapFst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleBase -&gt; Id -&gt; Id
</span><a href="GHC.Core.Rules.html#addRulesToId"><span class="hs-identifier hs-var">addRulesToId</span></a></span><span> </span><span class="annot"><span class="annottext">RuleBase
</span><a href="#local-6989586621683151668"><span class="hs-identifier hs-var">rule_base</span></a></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Id) -&gt; (Id -&gt; Id) -&gt; Id -&gt; Id
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Id
</span><a href="#local-6989586621683151670"><span class="hs-identifier hs-var">add_export_flag</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-365"></span><span>        </span><span class="hs-comment">-- addRulesToId: see Note [Attach rules to local ids]</span><span>
</span><span id="line-366"></span><span>        </span><span class="hs-comment">-- NB: the binder might have some existing rules,</span><span>
</span><span id="line-367"></span><span>        </span><span class="hs-comment">-- arising from specialisation pragmas</span><span>
</span><span id="line-368"></span><span>
</span><span id="line-369"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-370"></span><span>
</span><span id="line-371"></span><span>    </span><span class="hs-comment">---------- Rules --------</span><span>
</span><span id="line-372"></span><span>    </span><span id="local-6989586621683151668"><span class="annot"><span class="annottext">rule_base :: RuleBase
</span><a href="#local-6989586621683151668"><span class="hs-identifier hs-var hs-var">rule_base</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleBase -&gt; [CoreRule] -&gt; RuleBase
</span><a href="GHC.Core.Rules.html#extendRuleBaseList"><span class="hs-identifier hs-var">extendRuleBaseList</span></a></span><span> </span><span class="annot"><span class="annottext">RuleBase
</span><a href="GHC.Core.Rules.html#emptyRuleBase"><span class="hs-identifier hs-var">emptyRuleBase</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621683151665"><span class="hs-identifier hs-var">rules</span></a></span><span>
</span><span id="line-373"></span><span>
</span><span id="line-374"></span><span>    </span><span class="hs-comment">---------- Export flag --------</span><span>
</span><span id="line-375"></span><span>    </span><span class="hs-comment">-- See Note [Adding export flags]</span><span>
</span><span id="line-376"></span><span>    </span><span id="local-6989586621683151670"><span class="annot"><span class="annottext">add_export_flag :: Id -&gt; Id
</span><a href="#local-6989586621683151670"><span class="hs-identifier hs-var hs-var">add_export_flag</span></a></span></span><span> </span><span id="local-6989586621683151673"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151673"><span class="hs-identifier hs-var">bndr</span></a></span></span><span>
</span><span id="line-377"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="#local-6989586621683151674"><span class="hs-identifier hs-var">dont_discard</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151673"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Id
</span><a href="GHC.Types.Id.html#setIdExported"><span class="hs-identifier hs-var">setIdExported</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151673"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-378"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151673"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-379"></span><span>
</span><span id="line-380"></span><span>    </span><span class="annot"><a href="#local-6989586621683151674"><span class="hs-identifier hs-type">dont_discard</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-381"></span><span>    </span><span id="local-6989586621683151674"><span class="annot"><span class="annottext">dont_discard :: Id -&gt; Bool
</span><a href="#local-6989586621683151674"><span class="hs-identifier hs-var hs-var">dont_discard</span></a></span></span><span> </span><span id="local-6989586621683151676"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151676"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Bool
</span><a href="#local-6989586621683151677"><span class="hs-identifier hs-var">is_exported</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683151678"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-382"></span><span>                     </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683151678"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; NameSet -&gt; Bool
</span><a href="GHC.Types.Name.Set.html#elemNameSet"><span class="hs-operator hs-var">`elemNameSet`</span></a></span><span> </span><span class="annot"><span class="annottext">NameSet
</span><a href="#local-6989586621683151664"><span class="hs-identifier hs-var">keep_alive</span></a></span><span>
</span><span id="line-383"></span><span>       </span><span class="hs-keyword">where</span><span>
</span><span id="line-384"></span><span>         </span><span id="local-6989586621683151678"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621683151678"><span class="hs-identifier hs-var hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Name
</span><a href="GHC.Types.Id.html#idName"><span class="hs-identifier hs-var">idName</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151676"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-385"></span><span>
</span><span id="line-386"></span><span>        </span><span class="hs-comment">-- In interactive mode, we don't want to discard any top-level</span><span>
</span><span id="line-387"></span><span>        </span><span class="hs-comment">-- entities at all (eg. do not inline them away during</span><span>
</span><span id="line-388"></span><span>        </span><span class="hs-comment">-- simplification), and retain them all in the TypeEnv so they are</span><span>
</span><span id="line-389"></span><span>        </span><span class="hs-comment">-- available from the command line.</span><span>
</span><span id="line-390"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-391"></span><span>        </span><span class="hs-comment">-- isExternalName separates the user-defined top-level names from those</span><span>
</span><span id="line-392"></span><span>        </span><span class="hs-comment">-- introduced by the type checker.</span><span>
</span><span id="line-393"></span><span>    </span><span class="annot"><a href="#local-6989586621683151677"><span class="hs-identifier hs-type">is_exported</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-394"></span><span>    </span><span id="local-6989586621683151677"><span class="annot"><span class="annottext">is_exported :: Name -&gt; Bool
</span><a href="#local-6989586621683151677"><span class="hs-identifier hs-var hs-var">is_exported</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Backend -&gt; Bool
</span><a href="GHC.Driver.Backend.html#backendWantsGlobalBindings"><span class="hs-identifier hs-var">backendWantsGlobalBindings</span></a></span><span> </span><span class="annot"><span class="annottext">Backend
</span><a href="#local-6989586621683151662"><span class="hs-identifier hs-var">bcknd</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Bool
</span><a href="GHC.Types.Name.html#isExternalName"><span class="hs-identifier hs-var">isExternalName</span></a></span><span>
</span><span id="line-395"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; NameSet -&gt; Bool
</span><a href="GHC.Types.Name.Set.html#elemNameSet"><span class="hs-operator hs-var">`elemNameSet`</span></a></span><span> </span><span class="annot"><span class="annottext">NameSet
</span><a href="#local-6989586621683151663"><span class="hs-identifier hs-var">exports</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-396"></span><span>
</span><span id="line-397"></span><span class="hs-comment">{-
Note [Adding export flags]
~~~~~~~~~~~~~~~~~~~~~~~~~~
Set the no-discard flag if either
        a) the Id is exported
        b) it's mentioned in the RHS of an orphan rule
        c) it's in the keep-alive set

It means that the binding won't be discarded EVEN if the binding
ends up being trivial (v = w) -- the simplifier would usually just
substitute w for v throughout, but we don't apply the substitution to
the rules (maybe we should?), so this substitution would make the rule
bogus.

You might wonder why exported Ids aren't already marked as such;
it's just because the type checker is rather busy already and
I didn't want to pass in yet another mapping.

Note [Attach rules to local ids]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Find the rules for locally-defined Ids; then we can attach them
to the binders in the top-level bindings

Reason
  - It makes the rules easier to look up
  - It means that rewrite rules and specialisations for
    locally defined Ids are handled uniformly
  - It keeps alive things that are referred to only from a rule
    (the occurrence analyser knows about rules attached to Ids)
  - It makes sure that, when we apply a rule, the free vars
    of the RHS are more likely to be in scope
  - The imported rules are carried in the in-scope set
    which is extended on each iteration by the new wave of
    local binders; any rules which aren't on the binding will
    thereby get dropped


************************************************************************
*                                                                      *
*              Desugaring rewrite rules
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-440"></span><span>
</span><span id="line-441"></span><span class="annot"><a href="GHC.HsToCore.html#dsRule"><span class="hs-identifier hs-type">dsRule</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Decls.html#LRuleDecl"><span class="hs-identifier hs-type">LRuleDecl</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcTc"><span class="hs-identifier hs-type">GhcTc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.HsToCore.Types.html#DsM"><span class="hs-identifier hs-type">DsM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-442"></span><span id="dsRule"><span class="annot"><span class="annottext">dsRule :: LRuleDecl GhcTc -&gt; IOEnv (Env DsGblEnv DsLclEnv) (Maybe CoreRule)
</span><a href="GHC.HsToCore.html#dsRule"><span class="hs-identifier hs-var hs-var">dsRule</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.SrcLoc.html#L"><span class="hs-identifier hs-type">L</span></a></span><span> </span><span id="local-6989586621683151685"><span class="annot"><span class="annottext">SrcSpanAnnA
</span><a href="#local-6989586621683151685"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Decls.html#HsRule"><span class="hs-identifier hs-type">HsRule</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">rd_name :: forall pass. RuleDecl pass -&gt; XRec pass RuleName
</span><a href="Language.Haskell.Syntax.Decls.html#rd_name"><span class="hs-identifier hs-var">rd_name</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151688"><span class="annot"><span class="annottext">XRec GhcTc RuleName
</span><a href="#local-6989586621683151688"><span class="hs-identifier hs-var">name</span></a></span></span><span>
</span><span id="line-443"></span><span>                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">rd_act :: forall pass. RuleDecl pass -&gt; Activation
</span><a href="Language.Haskell.Syntax.Decls.html#rd_act"><span class="hs-identifier hs-var">rd_act</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151690"><span class="annot"><span class="annottext">Activation
</span><a href="#local-6989586621683151690"><span class="hs-identifier hs-var">rule_act</span></a></span></span><span>
</span><span id="line-444"></span><span>                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">rd_tmvs :: forall pass. RuleDecl pass -&gt; [LRuleBndr pass]
</span><a href="Language.Haskell.Syntax.Decls.html#rd_tmvs"><span class="hs-identifier hs-var">rd_tmvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151692"><span class="annot"><span class="annottext">[LRuleBndr GhcTc]
</span><a href="#local-6989586621683151692"><span class="hs-identifier hs-var">vars</span></a></span></span><span>
</span><span id="line-445"></span><span>                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">rd_lhs :: forall pass. RuleDecl pass -&gt; XRec pass (HsExpr pass)
</span><a href="Language.Haskell.Syntax.Decls.html#rd_lhs"><span class="hs-identifier hs-var">rd_lhs</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151694"><span class="annot"><span class="annottext">LHsExpr GhcTc
</span><a href="#local-6989586621683151694"><span class="hs-identifier hs-var">lhs</span></a></span></span><span>
</span><span id="line-446"></span><span>                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">rd_rhs :: forall pass. RuleDecl pass -&gt; XRec pass (HsExpr pass)
</span><a href="Language.Haskell.Syntax.Decls.html#rd_rhs"><span class="hs-identifier hs-var">rd_rhs</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151696"><span class="annot"><span class="annottext">LHsExpr GhcTc
</span><a href="#local-6989586621683151696"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-447"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SrcSpan
-&gt; IOEnv (Env DsGblEnv DsLclEnv) (Maybe CoreRule)
-&gt; IOEnv (Env DsGblEnv DsLclEnv) (Maybe CoreRule)
forall a. SrcSpan -&gt; DsM a -&gt; DsM a
</span><a href="GHC.HsToCore.Monad.html#putSrcSpanDs"><span class="hs-identifier hs-var">putSrcSpanDs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SrcSpanAnnA -&gt; SrcSpan
forall a. HasLoc a =&gt; a -&gt; SrcSpan
</span><a href="GHC.Parser.Annotation.html#locA"><span class="hs-identifier hs-var">locA</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpanAnnA
</span><a href="#local-6989586621683151685"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IOEnv (Env DsGblEnv DsLclEnv) (Maybe CoreRule)
 -&gt; IOEnv (Env DsGblEnv DsLclEnv) (Maybe CoreRule))
-&gt; IOEnv (Env DsGblEnv DsLclEnv) (Maybe CoreRule)
-&gt; IOEnv (Env DsGblEnv DsLclEnv) (Maybe CoreRule)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-448"></span><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683151699"><span class="annot"><span class="annottext">bndrs' :: [Id]
</span><a href="#local-6989586621683151699"><span class="hs-identifier hs-var hs-var hs-var">bndrs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151700"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html#L"><span class="hs-identifier hs-type">L</span></a></span><span> </span><span class="annot"><span class="annottext">EpAnnCO
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Decls.html#RuleBndr"><span class="hs-identifier hs-type">RuleBndr</span></a></span><span> </span><span class="annot"><span class="annottext">XCRuleBndr GhcTc
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.SrcLoc.html#L"><span class="hs-identifier hs-type">L</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpanAnnN
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683151700"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151700"><span class="hs-identifier hs-var">var</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[LRuleBndr GhcTc]
[GenLocated EpAnnCO (RuleBndr GhcTc)]
</span><a href="#local-6989586621683151692"><span class="hs-identifier hs-var">vars</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-449"></span><span>
</span><span id="line-450"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683151702"><span class="annot"><a href="#local-6989586621683151702"><span class="hs-identifier hs-var">lhs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">GeneralFlag -&gt; DsM CoreExpr -&gt; DsM CoreExpr
forall gbl lcl a.
GeneralFlag -&gt; TcRnIf gbl lcl a -&gt; TcRnIf gbl lcl a
</span><a href="GHC.Tc.Utils.Monad.html#unsetGOptM"><span class="hs-identifier hs-var">unsetGOptM</span></a></span><span> </span><span class="annot"><span class="annottext">GeneralFlag
</span><a href="GHC.Driver.Flags.html#Opt_EnableRewriteRules"><span class="hs-identifier hs-var">Opt_EnableRewriteRules</span></a></span><span> </span><span class="annot"><span class="annottext">(DsM CoreExpr -&gt; DsM CoreExpr) -&gt; DsM CoreExpr -&gt; DsM CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-451"></span><span>                  </span><span class="annot"><span class="annottext">WarningFlag -&gt; DsM CoreExpr -&gt; DsM CoreExpr
forall gbl lcl a.
WarningFlag -&gt; TcRnIf gbl lcl a -&gt; TcRnIf gbl lcl a
</span><a href="GHC.Tc.Utils.Monad.html#unsetWOptM"><span class="hs-identifier hs-var">unsetWOptM</span></a></span><span> </span><span class="annot"><span class="annottext">WarningFlag
</span><a href="GHC.Driver.Flags.html#Opt_WarnIdentities"><span class="hs-identifier hs-var">Opt_WarnIdentities</span></a></span><span> </span><span class="annot"><span class="annottext">(DsM CoreExpr -&gt; DsM CoreExpr) -&gt; DsM CoreExpr -&gt; DsM CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-452"></span><span>                  </span><span class="annot"><span class="annottext">LHsExpr GhcTc -&gt; DsM CoreExpr
</span><a href="GHC.HsToCore.Expr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a></span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcTc
</span><a href="#local-6989586621683151694"><span class="hs-identifier hs-var">lhs</span></a></span><span>   </span><span class="hs-comment">-- Note [Desugaring RULE left hand sides]</span><span>
</span><span id="line-453"></span><span>
</span><span id="line-454"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683151707"><span class="annot"><a href="#local-6989586621683151707"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.HsToCore.Expr.html#dsLExpr"><span class="hs-identifier hs-type">dsLExpr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151696"><span class="hs-identifier hs-type">rhs</span></a></span><span>
</span><span id="line-455"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683151708"><span class="annot"><a href="#local-6989586621683151708"><span class="hs-identifier hs-var">this_mod</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Unit.Module.html#getModule"><span class="hs-identifier hs-type">getModule</span></a></span><span>
</span><span id="line-456"></span><span>
</span><span id="line-457"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683151710"><span class="annot"><a href="#local-6989586621683151710"><span class="hs-identifier hs-var">bndrs''</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683151711"><span class="annot"><a href="#local-6989586621683151711"><span class="hs-identifier hs-var">lhs''</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683151712"><span class="annot"><a href="#local-6989586621683151712"><span class="hs-identifier hs-var">rhs''</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.HsToCore.html#unfold_coerce"><span class="hs-identifier hs-type">unfold_coerce</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151699"><span class="hs-identifier hs-type">bndrs'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151702"><span class="hs-identifier hs-type">lhs'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151707"><span class="hs-identifier hs-type">rhs'</span></a></span><span>
</span><span id="line-458"></span><span>
</span><span id="line-459"></span><span>        </span><span class="hs-comment">-- Substitute the dict bindings eagerly,</span><span>
</span><span id="line-460"></span><span>        </span><span class="hs-comment">-- and take the body apart into a (f args) form</span><span>
</span><span id="line-461"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683151714"><span class="annot"><a href="#local-6989586621683151714"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Driver.DynFlags.html#getDynFlags"><span class="hs-identifier hs-type">getDynFlags</span></a></span><span>
</span><span id="line-462"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="GHC.HsToCore.Binds.html#decomposeRuleLhs"><span class="hs-identifier hs-type">decomposeRuleLhs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151714"><span class="hs-identifier hs-type">dflags</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151710"><span class="hs-identifier hs-type">bndrs''</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151711"><span class="hs-identifier hs-type">lhs''</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.FVs.html#exprFreeVars"><span class="hs-identifier hs-type">exprFreeVars</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151712"><span class="hs-identifier hs-type">rhs''</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-463"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621683151717"><span class="annot"><span class="annottext">DsMessage
</span><a href="#local-6989586621683151717"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">DsMessage -&gt; DsM ()
</span><a href="GHC.HsToCore.Monad.html#diagnosticDs"><span class="hs-identifier hs-var">diagnosticDs</span></a></span><span> </span><span class="annot"><span class="annottext">DsMessage
</span><a href="#local-6989586621683151717"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Maybe CoreRule -&gt; IOEnv (Env DsGblEnv DsLclEnv) (Maybe CoreRule)
forall a. a -&gt; IOEnv (Env DsGblEnv DsLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe CoreRule
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>
</span><span id="line-464"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683151719"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621683151719"><span class="hs-identifier hs-var">final_bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683151720"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151720"><span class="hs-identifier hs-var">fn_id</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683151721"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621683151721"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-465"></span><span>
</span><span id="line-466"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683151722"><span class="annot"><span class="annottext">is_local :: Bool
</span><a href="#local-6989586621683151722"><span class="hs-identifier hs-var hs-var hs-var">is_local</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isLocalId"><span class="hs-identifier hs-var">isLocalId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151720"><span class="hs-identifier hs-var">fn_id</span></a></span><span>
</span><span id="line-467"></span><span>                </span><span class="hs-comment">-- NB: isLocalId is False of implicit Ids.  This is good because</span><span>
</span><span id="line-468"></span><span>                </span><span class="hs-comment">-- we don't want to attach rules to the bindings of implicit Ids,</span><span>
</span><span id="line-469"></span><span>                </span><span class="hs-comment">-- because they don't show up in the bindings until just before code gen</span><span>
</span><span id="line-470"></span><span>              </span><span id="local-6989586621683151724"><span class="annot"><span class="annottext">fn_name :: Name
</span><a href="#local-6989586621683151724"><span class="hs-identifier hs-var hs-var hs-var">fn_name</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Name
</span><a href="GHC.Types.Id.html#idName"><span class="hs-identifier hs-var">idName</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151720"><span class="hs-identifier hs-var">fn_id</span></a></span><span>
</span><span id="line-471"></span><span>              </span><span id="local-6989586621683151725"><span class="annot"><span class="annottext">simpl_opts :: SimpleOpts
</span><a href="#local-6989586621683151725"><span class="hs-identifier hs-var hs-var hs-var">simpl_opts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; SimpleOpts
</span><a href="GHC.Driver.Config.html#initSimpleOpts"><span class="hs-identifier hs-var">initSimpleOpts</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683151714"><span class="hs-identifier hs-var">dflags</span></a></span><span>
</span><span id="line-472"></span><span>              </span><span id="local-6989586621683151726"><span class="annot"><span class="annottext">final_rhs :: CoreExpr
</span><a href="#local-6989586621683151726"><span class="hs-identifier hs-var hs-var hs-var">final_rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; SimpleOpts -&gt; CoreExpr -&gt; CoreExpr
SimpleOpts -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.SimpleOpt.html#simpleOptExpr"><span class="hs-identifier hs-var">simpleOptExpr</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleOpts
</span><a href="#local-6989586621683151725"><span class="hs-identifier hs-var">simpl_opts</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621683151712"><span class="hs-identifier hs-var">rhs''</span></a></span><span>    </span><span class="hs-comment">-- De-crap it</span><span>
</span><span id="line-473"></span><span>              </span><span id="local-6989586621683151727"><span class="annot"><span class="annottext">rule_name :: RuleName
</span><a href="#local-6989586621683151727"><span class="hs-identifier hs-var hs-var hs-var">rule_name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GenLocated EpAnnCO RuleName -&gt; RuleName
forall l e. GenLocated l e -&gt; e
</span><a href="GHC.Types.SrcLoc.html#unLoc"><span class="hs-identifier hs-var">unLoc</span></a></span><span> </span><span class="annot"><span class="annottext">XRec GhcTc RuleName
GenLocated EpAnnCO RuleName
</span><a href="#local-6989586621683151688"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-474"></span><span>              </span><span id="local-6989586621683151729"><span class="annot"><span class="annottext">rule :: CoreRule
</span><a href="#local-6989586621683151729"><span class="hs-identifier hs-var hs-var hs-var">rule</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Module
-&gt; Bool
-&gt; Bool
-&gt; RuleName
-&gt; Activation
-&gt; Name
-&gt; [Id]
-&gt; [CoreExpr]
-&gt; CoreExpr
-&gt; CoreRule
</span><a href="GHC.Core.Rules.html#mkRule"><span class="hs-identifier hs-var">mkRule</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621683151708"><span class="hs-identifier hs-var">this_mod</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683151722"><span class="hs-identifier hs-var">is_local</span></a></span><span> </span><span class="annot"><span class="annottext">RuleName
</span><a href="#local-6989586621683151727"><span class="hs-identifier hs-var">rule_name</span></a></span><span> </span><span class="annot"><span class="annottext">Activation
</span><a href="#local-6989586621683151690"><span class="hs-identifier hs-var">rule_act</span></a></span><span>
</span><span id="line-475"></span><span>                            </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683151724"><span class="hs-identifier hs-var">fn_name</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621683151719"><span class="hs-identifier hs-var">final_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621683151721"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621683151726"><span class="hs-identifier hs-var">final_rhs</span></a></span><span>
</span><span id="line-476"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CoreRule -&gt; DsM ()
</span><a href="GHC.HsToCore.Binds.html#dsWarnOrphanRule"><span class="hs-identifier hs-var">dsWarnOrphanRule</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621683151729"><span class="hs-identifier hs-var">rule</span></a></span><span>
</span><span id="line-477"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Id -&gt; CoreRule -&gt; DsM ()
</span><a href="GHC.HsToCore.html#dsWarnRuleShadowing"><span class="hs-identifier hs-var">dsWarnRuleShadowing</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151720"><span class="hs-identifier hs-var">fn_id</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621683151729"><span class="hs-identifier hs-var">rule</span></a></span><span>
</span><span id="line-478"></span><span>
</span><span id="line-479"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Maybe CoreRule -&gt; IOEnv (Env DsGblEnv DsLclEnv) (Maybe CoreRule)
forall a. a -&gt; IOEnv (Env DsGblEnv DsLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreRule -&gt; Maybe CoreRule
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621683151729"><span class="hs-identifier hs-var">rule</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-480"></span><span>        </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-481"></span><span>
</span><span id="line-482"></span><span class="annot"><a href="GHC.HsToCore.html#dsWarnRuleShadowing"><span class="hs-identifier hs-type">dsWarnRuleShadowing</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.HsToCore.Types.html#DsM"><span class="hs-identifier hs-type">DsM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-483"></span><span class="hs-comment">-- See Note [Rules and inlining/other rules]</span><span>
</span><span id="line-484"></span><span id="dsWarnRuleShadowing"><span class="annot"><span class="annottext">dsWarnRuleShadowing :: Id -&gt; CoreRule -&gt; DsM ()
</span><a href="GHC.HsToCore.html#dsWarnRuleShadowing"><span class="hs-identifier hs-var hs-var">dsWarnRuleShadowing</span></a></span></span><span> </span><span id="local-6989586621683151733"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151733"><span class="hs-identifier hs-var">fn_id</span></a></span></span><span>
</span><span id="line-485"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rule"><span class="hs-identifier hs-type">Rule</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ru_name :: CoreRule -&gt; RuleName
</span><a href="GHC.Core.html#ru_name"><span class="hs-identifier hs-var">ru_name</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151736"><span class="annot"><span class="annottext">RuleName
</span><a href="#local-6989586621683151736"><span class="hs-identifier hs-var">rule_name</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_act :: CoreRule -&gt; Activation
</span><a href="GHC.Core.html#ru_act"><span class="hs-identifier hs-var">ru_act</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151738"><span class="annot"><span class="annottext">Activation
</span><a href="#local-6989586621683151738"><span class="hs-identifier hs-var">rule_act</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_bndrs :: CoreRule -&gt; [Id]
</span><a href="GHC.Core.html#ru_bndrs"><span class="hs-identifier hs-var">ru_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151740"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621683151740"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_args :: CoreRule -&gt; [CoreExpr]
</span><a href="GHC.Core.html#ru_args"><span class="hs-identifier hs-var">ru_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683151742"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621683151742"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-486"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Id -&gt; DsM ()
</span><a href="#local-6989586621683151743"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151733"><span class="hs-identifier hs-var">fn_id</span></a></span><span>    </span><span class="hs-comment">-- We often have multiple rules for the same Id in a</span><span>
</span><span id="line-487"></span><span>                              </span><span class="hs-comment">-- module. Maybe we should check that they don't overlap</span><span>
</span><span id="line-488"></span><span>                              </span><span class="hs-comment">-- but currently we don't</span><span>
</span><span id="line-489"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; DsM ()) -&gt; [Id] -&gt; DsM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Id -&gt; DsM ()
</span><a href="#local-6989586621683151743"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621683151745"><span class="hs-identifier hs-var">arg_ids</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-490"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-491"></span><span>    </span><span id="local-6989586621683151746"><span class="annot"><span class="annottext">bndrs_set :: VarSet
</span><a href="#local-6989586621683151746"><span class="hs-identifier hs-var hs-var">bndrs_set</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621683151740"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-492"></span><span>    </span><span id="local-6989586621683151745"><span class="annot"><span class="annottext">arg_ids :: [Id]
</span><a href="#local-6989586621683151745"><span class="hs-identifier hs-var hs-var">arg_ids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; [Id] -&gt; [Id]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="GHC.Utils.Misc.html#filterOut"><span class="hs-identifier hs-var">filterOut</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683151746"><span class="hs-identifier hs-var">bndrs_set</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Id] -&gt; [Id]) -&gt; [Id] -&gt; [Id]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-493"></span><span>              </span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; [CoreExpr] -&gt; [Id]
</span><a href="GHC.Core.FVs.html#exprsSomeFreeVarsList"><span class="hs-identifier hs-var">exprsSomeFreeVarsList</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621683151742"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-494"></span><span>
</span><span id="line-495"></span><span>    </span><span id="local-6989586621683151743"><span class="annot"><span class="annottext">check :: Bool -&gt; Id -&gt; DsM ()
</span><a href="#local-6989586621683151743"><span class="hs-identifier hs-var hs-var">check</span></a></span></span><span> </span><span id="local-6989586621683151750"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683151750"><span class="hs-identifier hs-var">check_rules_too</span></a></span></span><span> </span><span id="local-6989586621683151751"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151751"><span class="hs-identifier hs-var">lhs_id</span></a></span></span><span>
</span><span id="line-496"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isLocalId"><span class="hs-identifier hs-var">isLocalId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151751"><span class="hs-identifier hs-var">lhs_id</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; Bool
</span><a href="GHC.Core.html#canUnfold"><span class="hs-identifier hs-var">canUnfold</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdUnfoldingFun
</span><a href="GHC.Types.Id.html#idUnfolding"><span class="hs-identifier hs-var">idUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151751"><span class="hs-identifier hs-var">lhs_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-497"></span><span>                       </span><span class="hs-comment">-- If imported with no unfolding, no worries</span><span>
</span><span id="line-498"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Activation
</span><a href="GHC.Types.Id.html#idInlineActivation"><span class="hs-identifier hs-var">idInlineActivation</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151751"><span class="hs-identifier hs-var">lhs_id</span></a></span><span> </span><span class="annot"><span class="annottext">Activation -&gt; Activation -&gt; Bool
</span><a href="GHC.Types.Basic.html#competesWith"><span class="hs-operator hs-var">`competesWith`</span></a></span><span> </span><span class="annot"><span class="annottext">Activation
</span><a href="#local-6989586621683151738"><span class="hs-identifier hs-var">rule_act</span></a></span><span>
</span><span id="line-499"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DsMessage -&gt; DsM ()
</span><a href="GHC.HsToCore.Monad.html#diagnosticDs"><span class="hs-identifier hs-var">diagnosticDs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleName -&gt; Id -&gt; Activation -&gt; DsMessage
</span><a href="GHC.HsToCore.Errors.Types.html#DsRuleMightInlineFirst"><span class="hs-identifier hs-var">DsRuleMightInlineFirst</span></a></span><span> </span><span class="annot"><span class="annottext">RuleName
</span><a href="#local-6989586621683151736"><span class="hs-identifier hs-var">rule_name</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151751"><span class="hs-identifier hs-var">lhs_id</span></a></span><span> </span><span class="annot"><span class="annottext">Activation
</span><a href="#local-6989586621683151738"><span class="hs-identifier hs-var">rule_act</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-500"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683151750"><span class="hs-identifier hs-var">check_rules_too</span></a></span><span>
</span><span id="line-501"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621683151757"><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621683151757"><span class="hs-identifier hs-var">bad_rule</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Id -&gt; [CoreRule]
</span><a href="#local-6989586621683151758"><span class="hs-identifier hs-var">get_bad_rules</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151751"><span class="hs-identifier hs-var">lhs_id</span></a></span><span>
</span><span id="line-502"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DsMessage -&gt; DsM ()
</span><a href="GHC.HsToCore.Monad.html#diagnosticDs"><span class="hs-identifier hs-var">diagnosticDs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleName -&gt; RuleName -&gt; Id -&gt; DsMessage
</span><a href="GHC.HsToCore.Errors.Types.html#DsAnotherRuleMightFireFirst"><span class="hs-identifier hs-var">DsAnotherRuleMightFireFirst</span></a></span><span> </span><span class="annot"><span class="annottext">RuleName
</span><a href="#local-6989586621683151736"><span class="hs-identifier hs-var">rule_name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreRule -&gt; RuleName
</span><a href="GHC.Core.html#ruleName"><span class="hs-identifier hs-var">ruleName</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621683151757"><span class="hs-identifier hs-var">bad_rule</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151751"><span class="hs-identifier hs-var">lhs_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-503"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-504"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; DsM ()
forall a. a -&gt; IOEnv (Env DsGblEnv DsLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-505"></span><span>
</span><span id="line-506"></span><span>    </span><span id="local-6989586621683151758"><span class="annot"><span class="annottext">get_bad_rules :: Id -&gt; [CoreRule]
</span><a href="#local-6989586621683151758"><span class="hs-identifier hs-var hs-var">get_bad_rules</span></a></span></span><span> </span><span id="local-6989586621683151761"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151761"><span class="hs-identifier hs-var">lhs_id</span></a></span></span><span>
</span><span id="line-507"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621683151762"><span class="hs-identifier hs-var">rule</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621683151762"><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621683151762"><span class="hs-identifier hs-var">rule</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Id -&gt; [CoreRule]
</span><a href="GHC.Types.Id.html#idCoreRules"><span class="hs-identifier hs-var">idCoreRules</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151761"><span class="hs-identifier hs-var">lhs_id</span></a></span><span>
</span><span id="line-508"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreRule -&gt; Activation
</span><a href="GHC.Core.html#ruleActivation"><span class="hs-identifier hs-var">ruleActivation</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621683151762"><span class="hs-identifier hs-var">rule</span></a></span><span> </span><span class="annot"><span class="annottext">Activation -&gt; Activation -&gt; Bool
</span><a href="GHC.Types.Basic.html#competesWith"><span class="hs-operator hs-var">`competesWith`</span></a></span><span> </span><span class="annot"><span class="annottext">Activation
</span><a href="#local-6989586621683151738"><span class="hs-identifier hs-var">rule_act</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-509"></span><span>
</span><span id="line-510"></span><span class="annot"><a href="GHC.HsToCore.html#dsWarnRuleShadowing"><span class="hs-identifier hs-var">dsWarnRuleShadowing</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; DsM ()
forall a. a -&gt; IOEnv (Env DsGblEnv DsLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Not expecting built-in rules here</span><span>
</span><span id="line-511"></span><span>
</span><span id="line-512"></span><span class="hs-comment">-- See Note [Desugaring coerce as cast]</span><span>
</span><span id="line-513"></span><span class="annot"><a href="GHC.HsToCore.html#unfold_coerce"><span class="hs-identifier hs-type">unfold_coerce</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.HsToCore.Types.html#DsM"><span class="hs-identifier hs-type">DsM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-514"></span><span id="unfold_coerce"><span class="annot"><span class="annottext">unfold_coerce :: [Id] -&gt; CoreExpr -&gt; CoreExpr -&gt; DsM ([Id], CoreExpr, CoreExpr)
</span><a href="GHC.HsToCore.html#unfold_coerce"><span class="hs-identifier hs-var hs-var">unfold_coerce</span></a></span></span><span> </span><span id="local-6989586621683151766"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621683151766"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span id="local-6989586621683151767"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621683151767"><span class="hs-identifier hs-var">lhs</span></a></span></span><span> </span><span id="local-6989586621683151768"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621683151768"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-515"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621683151769"><span class="annot"><a href="#local-6989586621683151769"><span class="hs-identifier hs-var">bndrs'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683151770"><span class="annot"><a href="#local-6989586621683151770"><span class="hs-identifier hs-var">wrap</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; DsM ([Id], CoreExpr -&gt; CoreExpr)
</span><a href="#local-6989586621683151771"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621683151766"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-516"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683151769"><span class="hs-identifier hs-type">bndrs'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683151770"><span class="hs-identifier hs-type">wrap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151767"><span class="hs-identifier hs-type">lhs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683151770"><span class="hs-identifier hs-type">wrap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151768"><span class="hs-identifier hs-type">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-517"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-518"></span><span>    </span><span class="annot"><a href="#local-6989586621683151771"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.HsToCore.Types.html#DsM"><span class="hs-identifier hs-type">DsM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-519"></span><span>    </span><span id="local-6989586621683151771"><span class="annot"><span class="annottext">go :: [Id] -&gt; DsM ([Id], CoreExpr -&gt; CoreExpr)
</span><a href="#local-6989586621683151771"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([Id], CoreExpr -&gt; CoreExpr) -&gt; DsM ([Id], CoreExpr -&gt; CoreExpr)
forall a. a -&gt; IOEnv (Env DsGblEnv DsLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">)</span><span>
</span><span id="line-520"></span><span>    </span><span class="annot"><a href="#local-6989586621683151771"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683151773"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151773"><span class="hs-identifier hs-var">v</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621683151774"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621683151774"><span class="hs-identifier hs-var">vs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-521"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683151775"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683151775"><span class="hs-identifier hs-var">tc</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span id="local-6989586621683151776"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683151776"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683151777"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683151777"><span class="hs-identifier hs-var">t1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683151778"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683151778"><span class="hs-identifier hs-var">t2</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Maybe (TyCon, [Type])
Type -&gt; Maybe (TyCon, [Type])
</span><a href="GHC.Core.Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151773"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-522"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683151775"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#coercibleTyConKey"><span class="hs-identifier hs-var">coercibleTyConKey</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-523"></span><span>            </span><span id="local-6989586621683151783"><span class="annot"><a href="#local-6989586621683151783"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcRnIf DsGblEnv DsLclEnv Unique
forall gbl lcl. TcRnIf gbl lcl Unique
</span><a href="GHC.Tc.Utils.Monad.html#newUnique"><span class="hs-identifier hs-var">newUnique</span></a></span><span>
</span><span id="line-524"></span><span>
</span><span id="line-525"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683151785"><span class="annot"><a href="#local-6989586621683151785"><span class="hs-identifier hs-var hs-var">ty'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; Type
</span><a href="GHC.Core.Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="GHC.Builtin.Types.Prim.html#eqReprPrimTyCon"><span class="hs-identifier hs-var">eqReprPrimTyCon</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683151776"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683151776"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683151777"><span class="hs-identifier hs-var">t1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683151778"><span class="hs-identifier hs-var">t2</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-526"></span><span>                </span><span id="local-6989586621683151788"><span class="annot"><a href="#local-6989586621683151788"><span class="hs-identifier hs-var hs-var">v'</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Name -&gt; Type -&gt; Id
Name -&gt; Type -&gt; Id
</span><a href="GHC.Types.Id.html#mkLocalCoVar"><span class="hs-identifier hs-var">mkLocalCoVar</span></a></span><span>
</span><span id="line-527"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(OccName -&gt; OccName) -&gt; Unique -&gt; Name -&gt; Name
</span><a href="GHC.Types.Name.html#mkDerivedInternalName"><span class="hs-identifier hs-var">mkDerivedInternalName</span></a></span><span> </span><span class="annot"><span class="annottext">OccName -&gt; OccName
</span><a href="GHC.Types.Name.Occurrence.html#mkRepEqOcc"><span class="hs-identifier hs-var">mkRepEqOcc</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621683151783"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Name
forall a. NamedThing a =&gt; a -&gt; Name
</span><a href="GHC.Types.Name.html#getName"><span class="hs-identifier hs-var">getName</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151773"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683151785"><span class="hs-identifier hs-var">ty'</span></a></span><span>
</span><span id="line-528"></span><span>                </span><span id="local-6989586621683151793"><span class="annot"><a href="#local-6989586621683151793"><span class="hs-identifier hs-var hs-var">box</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; Id
</span><a href="GHC.Core.DataCon.html#dataConWrapId"><span class="hs-identifier hs-var">dataConWrapId</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="GHC.Builtin.Types.html#coercibleDataCon"><span class="hs-identifier hs-var">coercibleDataCon</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; [Type] -&gt; CoreExpr
forall b. Expr b -&gt; [Type] -&gt; Expr b
</span><a href="GHC.Core.html#mkTyApps"><span class="hs-operator hs-var">`mkTyApps`</span></a></span><span>
</span><span id="line-529"></span><span>                      </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683151776"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683151777"><span class="hs-identifier hs-var">t1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683151778"><span class="hs-identifier hs-var">t2</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr -&gt; CoreExpr
forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-operator hs-var">`App`</span></a></span><span>
</span><span id="line-530"></span><span>                      </span><span class="annot"><span class="annottext">Coercion -&gt; CoreExpr
forall b. Coercion -&gt; Expr b
</span><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkCoVarCo"><span class="hs-identifier hs-var">mkCoVarCo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151788"><span class="hs-identifier hs-var">v'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-531"></span><span>
</span><span id="line-532"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621683151800"><span class="annot"><a href="#local-6989586621683151800"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683151801"><span class="annot"><a href="#local-6989586621683151801"><span class="hs-identifier hs-var">wrap</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621683151771"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151774"><span class="hs-identifier hs-type">vs</span></a></span><span>
</span><span id="line-533"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683151788"><span class="hs-identifier hs-type">v'</span></a></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><a href="#local-6989586621683151800"><span class="hs-identifier hs-type">bndrs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Make.html#mkCoreLet"><span class="hs-identifier hs-type">mkCoreLet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151773"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151793"><span class="hs-identifier hs-type">box</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><a href="#local-6989586621683151801"><span class="hs-identifier hs-type">wrap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-534"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-535"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621683151803"><span class="annot"><a href="#local-6989586621683151803"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621683151804"><span class="annot"><a href="#local-6989586621683151804"><span class="hs-identifier hs-var">wrap</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; DsM ([Id], CoreExpr -&gt; CoreExpr)
</span><a href="#local-6989586621683151771"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621683151774"><span class="hs-identifier hs-var">vs</span></a></span><span>
</span><span id="line-536"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683151773"><span class="hs-identifier hs-type">v</span></a></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><a href="#local-6989586621683151803"><span class="hs-identifier hs-type">bndrs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683151804"><span class="hs-identifier hs-type">wrap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-537"></span><span>
</span><span id="line-538"></span><span class="hs-comment">{- Note [Desugaring RULE left hand sides]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For the LHS of a RULE we do *not* want to desugar
    [x]   to    build (\cn. x `c` n)
We want to leave explicit lists simply as chains
of cons's. We can achieve that slightly indirectly by
switching off EnableRewriteRules.  See GHC.HsToCore.Expr.dsExplicitList.

That keeps the desugaring of list comprehensions simple too.

Nor do we want to warn of conversion identities on the LHS;
the rule is precisely to optimise them:
  {-# RULES &quot;fromRational/id&quot; fromRational = id :: Rational -&gt; Rational #-}

Note [Desugaring coerce as cast]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We want the user to express a rule saying roughly &#8220;mapping a coercion over a
list can be replaced by a coercion&#8221;. But the cast operator of Core (&#9655;) cannot
be written in Haskell. So we use `coerce` for that (#2110). The user writes
    map coerce = coerce
as a RULE, and this optimizes any kind of mapped' casts away, including `map
MkNewtype`.

For that we replace any forall'ed `c :: Coercible a b` value in a RULE by
corresponding `co :: a ~#R b` and wrap the LHS and the RHS in
`let c = MkCoercible co in ...`. This is later simplified to the desired form
by simpleOptExpr (for the LHS) resp. the simplifiers (for the RHS).
See also Note [Getting the map/coerce RULE to work] in GHC.Core.SimpleOpt.

Note [Rules and inlining/other rules]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If you have
  f x = ...
  g x = ...
  {-# RULES &quot;rule-for-f&quot; forall x. f (g x) = ... #-}
then there's a good chance that in a potential rule redex
    ...f (g e)...
then 'f' or 'g' will inline before the rule can fire.  Solution: add an
INLINE [n] or NOINLINE [n] pragma to 'f' and 'g'.

Note that this applies to all the free variables on the LHS, both the
main function and things in its arguments.

We also check if there are Ids on the LHS that have competing RULES.
In the above example, suppose we had
  {-# RULES &quot;rule-for-g&quot; forally. g [y] = ... #-}
Then &quot;rule-for-f&quot; and &quot;rule-for-g&quot; would compete.  Better to add phase
control, so &quot;rule-for-f&quot; has a chance to fire before &quot;rule-for-g&quot; becomes
active; or perhaps after &quot;rule-for-g&quot; has become inactive. This is checked
by 'competesWith'

Class methods have a built-in RULE to select the method from the dictionary,
so you can't change the phase on this.  That makes id very dubious to
match on class methods in RULE lhs's.   See #10595.   I'm not happy
about this. For example in Control.Arrow we have

{-# RULES &quot;compose/arr&quot;   forall f g .
                          (arr f) . (arr g) = arr (f . g) #-}

and similar, which will elicit exactly these warnings, and risk never
firing.  But it's not clear what to do instead.  We could make the
class method rules inactive in phase 2, but that would delay when
subsequent transformations could fire.
-}</span><span>
</span><span id="line-602"></span><span>
</span><span id="line-603"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
*              Magic definitions
*                                                                      *
************************************************************************

Note [Patching magic definitions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We sometimes need to have access to defined Ids in pure contexts. Usually, we
simply &quot;wire in&quot; these entities, as we do for types in GHC.Builtin.Types and for Ids
in GHC.Types.Id.Make. See Note [Wired-in Ids] in GHC.Types.Id.Make.

However, it is sometimes *much* easier to define entities in Haskell,
even if we need pure access; note that wiring-in an Id requires all
entities used in its definition *also* to be wired in, transitively
and recursively.  This can be a huge pain.  The little trick
documented here allows us to have the best of both worlds.

Motivating example: unsafeCoerce#. See [Wiring in unsafeCoerce#] for the
details.

The trick is to

* Define the known-key Id in a library module, with a stub definition,
     unsafeCoerce# :: ..a suitable type signature..
     unsafeCoerce# = error &quot;urk&quot;

* Magically over-write its RHS here in the desugarer, in
  patchMagicDefns.  This update can be done with full access to the
  DsM monad, and hence, dsLookupGlobal. We thus do not have to wire in
  all the entities used internally, a potentially big win.

  This step should not change the Name or type of the Id.

Because an Id stores its unfolding directly (as opposed to in the second
component of a (Id, CoreExpr) pair), the patchMagicDefns function returns
a new Id to use.

Here are the moving parts:

- patchMagicDefns checks whether we're in a module with magic definitions;
  if so, patch the magic definitions. If not, skip.

- patchMagicDefn just looks up in an environment to find a magic defn and
  patches it in.

- magicDefns holds the magic definitions.

- magicDefnsEnv allows for quick access to magicDefns.

- magicDefnModules, built also from magicDefns, contains the modules that
  need careful attention.

Note [Wiring in unsafeCoerce#]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We want (Haskell)

  unsafeCoerce# :: forall (r1 :: RuntimeRep) (r2 :: RuntimeRep)
                          (a :: TYPE r1) (b :: TYPE r2).
                   a -&gt; b
  unsafeCoerce# x = case unsafeEqualityProof @r1 @r2 of
    UnsafeRefl -&gt; case unsafeEqualityProof @a @b of
      UnsafeRefl -&gt; x

or (Core)

  unsafeCoerce# :: forall (r1 :: RuntimeRep) (r2 :: RuntimeRep)
                          (a :: TYPE r1) (b :: TYPE r2).
                   a -&gt; b
  unsafeCoerce# = \ @r1 @r2 @a @b (x :: a).
    case unsafeEqualityProof @RuntimeRep @r1 @r2 of
      UnsafeRefl (co1 :: r1 ~# r2) -&gt;
        case unsafeEqualityProof @(TYPE r2) @(a |&gt; TYPE co1) @b of
          UnsafeRefl (co2 :: (a |&gt; TYPE co1) ~# b) -&gt;
            (x |&gt; (GRefl :: a ~# (a |&gt; TYPE co1)) ; co2)

It looks like we can write this in Haskell directly, but we can't:
the representation polymorphism checks defeat us. Note that `x` is a
representation-polymorphic variable. So we must wire it in with a
compulsory unfolding, like other representation-polymorphic primops.

The challenge is that UnsafeEquality is a GADT, and wiring in a GADT
is *hard*: it has a worker separate from its wrapper, with all manner
of complications. (Simon and Richard tried to do this. We nearly wept.)

The solution is documented in Note [Patching magic definitions]. We now
simply look up the UnsafeEquality GADT in the environment, leaving us
only to wire in unsafeCoerce# directly.

Wrinkle: see Note [Always expose compulsory unfoldings] in GHC.Iface.Tidy
-}</span><span>
</span><span id="line-695"></span><span>
</span><span id="line-696"></span><span>
</span><span id="line-697"></span><span class="hs-comment">-- Postcondition: the returned Ids are in one-to-one correspondence as the</span><span>
</span><span id="line-698"></span><span class="hs-comment">-- input Ids; each returned Id has the same type as the passed-in Id.</span><span>
</span><span id="line-699"></span><span class="hs-comment">-- See Note [Patching magic definitions]</span><span>
</span><span id="line-700"></span><span class="annot"><a href="GHC.HsToCore.html#patchMagicDefns"><span class="hs-identifier hs-type">patchMagicDefns</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Data.OrdList.html#OrdList"><span class="hs-identifier hs-type">OrdList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-701"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.HsToCore.Types.html#DsM"><span class="hs-identifier hs-type">DsM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.OrdList.html#OrdList"><span class="hs-identifier hs-type">OrdList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-702"></span><span id="patchMagicDefns"><span class="annot"><span class="annottext">patchMagicDefns :: OrdList Binding -&gt; DsM (OrdList Binding)
</span><a href="GHC.HsToCore.html#patchMagicDefns"><span class="hs-identifier hs-var hs-var">patchMagicDefns</span></a></span></span><span> </span><span id="local-6989586621683151805"><span class="annot"><span class="annottext">OrdList Binding
</span><a href="#local-6989586621683151805"><span class="hs-identifier hs-var">pairs</span></a></span></span><span>
</span><span id="line-703"></span><span>  </span><span class="hs-comment">-- optimization: check whether we're in a magic module before looking</span><span>
</span><span id="line-704"></span><span>  </span><span class="hs-comment">-- at all the ids</span><span>
</span><span id="line-705"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683151806"><span class="annot"><a href="#local-6989586621683151806"><span class="hs-identifier hs-var">this_mod</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IOEnv (Env DsGblEnv DsLclEnv) Module
forall (m :: * -&gt; *). HasModule m =&gt; m Module
</span><a href="GHC.Unit.Module.html#getModule"><span class="hs-identifier hs-var">getModule</span></a></span><span>
</span><span id="line-706"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621683151806"><span class="hs-identifier hs-type">this_mod</span></a></span><span> </span><span class="annot"><a href="GHC.Unit.Module.Env.html#elemModuleSet"><span class="hs-operator hs-type">`elemModuleSet`</span></a></span><span> </span><span class="annot"><a href="GHC.HsToCore.html#magicDefnModules"><span class="hs-identifier hs-type">magicDefnModules</span></a></span><span>
</span><span id="line-707"></span><span>         </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">traverse</span></span><span> </span><span class="annot"><a href="GHC.HsToCore.html#patchMagicDefn"><span class="hs-identifier hs-type">patchMagicDefn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151805"><span class="hs-identifier hs-type">pairs</span></a></span><span>
</span><span id="line-708"></span><span>         </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683151805"><span class="hs-identifier hs-type">pairs</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-709"></span><span>
</span><span id="line-710"></span><span class="annot"><a href="GHC.HsToCore.html#patchMagicDefn"><span class="hs-identifier hs-type">patchMagicDefn</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.HsToCore.Types.html#DsM"><span class="hs-identifier hs-type">DsM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-711"></span><span id="patchMagicDefn"><span class="annot"><span class="annottext">patchMagicDefn :: Binding -&gt; IOEnv (Env DsGblEnv DsLclEnv) Binding
</span><a href="GHC.HsToCore.html#patchMagicDefn"><span class="hs-identifier hs-var hs-var">patchMagicDefn</span></a></span></span><span> </span><span id="local-6989586621683151811"><span class="annot"><span class="annottext">orig_pair :: Binding
</span><a href="#local-6989586621683151811"><span class="hs-identifier hs-var">orig_pair</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621683151812"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151812"><span class="hs-identifier hs-var">orig_id</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683151813"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621683151813"><span class="hs-identifier hs-var">orig_rhs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-712"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683151814"><span class="annot"><span class="annottext">Id -&gt; CoreExpr -&gt; IOEnv (Env DsGblEnv DsLclEnv) Binding
</span><a href="#local-6989586621683151814"><span class="hs-identifier hs-var">mk_magic_pair</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">NameEnv (Id -&gt; CoreExpr -&gt; IOEnv (Env DsGblEnv DsLclEnv) Binding)
-&gt; Name
-&gt; Maybe (Id -&gt; CoreExpr -&gt; IOEnv (Env DsGblEnv DsLclEnv) Binding)
forall a. NameEnv a -&gt; Name -&gt; Maybe a
</span><a href="GHC.Types.Name.Env.html#lookupNameEnv"><span class="hs-identifier hs-var">lookupNameEnv</span></a></span><span> </span><span class="annot"><span class="annottext">NameEnv (Id -&gt; CoreExpr -&gt; IOEnv (Env DsGblEnv DsLclEnv) Binding)
</span><a href="GHC.HsToCore.html#magicDefnsEnv"><span class="hs-identifier hs-var">magicDefnsEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Name
forall a. NamedThing a =&gt; a -&gt; Name
</span><a href="GHC.Types.Name.html#getName"><span class="hs-identifier hs-var">getName</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151812"><span class="hs-identifier hs-var">orig_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-713"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683151817"><span class="annot"><a href="#local-6989586621683151817"><span class="hs-identifier hs-var">magic_pair</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621683151818"><span class="annot"><a href="#local-6989586621683151818"><span class="hs-identifier hs-var">magic_id</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Id -&gt; CoreExpr -&gt; IOEnv (Env DsGblEnv DsLclEnv) Binding
</span><a href="#local-6989586621683151814"><span class="hs-identifier hs-var">mk_magic_pair</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151812"><span class="hs-identifier hs-var">orig_id</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621683151813"><span class="hs-identifier hs-var">orig_rhs</span></a></span><span>
</span><span id="line-714"></span><span>
</span><span id="line-715"></span><span>       </span><span class="hs-comment">-- Patching should not change the Name or the type of the Id</span><span>
</span><span id="line-716"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.Plain.html#massert"><span class="hs-identifier hs-type">massert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Unique.html#getUnique"><span class="hs-identifier hs-type">getUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151818"><span class="hs-identifier hs-type">magic_id</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">==</span></span><span> </span><span class="annot"><a href="GHC.Types.Unique.html#getUnique"><span class="hs-identifier hs-type">getUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151812"><span class="hs-identifier hs-type">orig_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-717"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.Plain.html#massert"><span class="hs-identifier hs-type">massert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#varType"><span class="hs-identifier hs-var">varType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151818"><span class="hs-identifier hs-type">magic_id</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Compare.html#eqType"><span class="hs-operator hs-type">`eqType`</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#varType"><span class="hs-identifier hs-var">varType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151812"><span class="hs-identifier hs-type">orig_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-718"></span><span>
</span><span id="line-719"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683151817"><span class="hs-identifier hs-type">magic_pair</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-720"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-721"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Binding -&gt; IOEnv (Env DsGblEnv DsLclEnv) Binding
forall a. a -&gt; IOEnv (Env DsGblEnv DsLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Binding
</span><a href="#local-6989586621683151811"><span class="hs-identifier hs-var">orig_pair</span></a></span><span>
</span><span id="line-722"></span><span>
</span><span id="line-723"></span><span class="annot"><a href="GHC.HsToCore.html#magicDefns"><span class="hs-identifier hs-type">magicDefns</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">,</span><span>    </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>     </span><span class="hs-comment">-- old Id and RHS</span><span>
</span><span id="line-724"></span><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.HsToCore.Types.html#DsM"><span class="hs-identifier hs-type">DsM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- new Id and RHS</span><span>
</span><span id="line-725"></span><span>               </span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-726"></span><span id="magicDefns"><span class="annot"><span class="annottext">magicDefns :: [(Name, Id -&gt; CoreExpr -&gt; IOEnv (Env DsGblEnv DsLclEnv) Binding)]
</span><a href="GHC.HsToCore.html#magicDefns"><span class="hs-identifier hs-var hs-var">magicDefns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.html#unsafeCoercePrimName"><span class="hs-identifier hs-var">unsafeCoercePrimName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; CoreExpr -&gt; IOEnv (Env DsGblEnv DsLclEnv) Binding
</span><a href="GHC.HsToCore.html#mkUnsafeCoercePrimPair"><span class="hs-identifier hs-var">mkUnsafeCoercePrimPair</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-727"></span><span>
</span><span id="line-728"></span><span class="annot"><a href="GHC.HsToCore.html#magicDefnsEnv"><span class="hs-identifier hs-type">magicDefnsEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Name.Env.html#NameEnv"><span class="hs-identifier hs-type">NameEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.HsToCore.Types.html#DsM"><span class="hs-identifier hs-type">DsM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-729"></span><span id="magicDefnsEnv"><span class="annot"><span class="annottext">magicDefnsEnv :: NameEnv (Id -&gt; CoreExpr -&gt; IOEnv (Env DsGblEnv DsLclEnv) Binding)
</span><a href="GHC.HsToCore.html#magicDefnsEnv"><span class="hs-identifier hs-var hs-var">magicDefnsEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Name, Id -&gt; CoreExpr -&gt; IOEnv (Env DsGblEnv DsLclEnv) Binding)]
-&gt; NameEnv
     (Id -&gt; CoreExpr -&gt; IOEnv (Env DsGblEnv DsLclEnv) Binding)
forall a. [(Name, a)] -&gt; NameEnv a
</span><a href="GHC.Types.Name.Env.html#mkNameEnv"><span class="hs-identifier hs-var">mkNameEnv</span></a></span><span> </span><span class="annot"><span class="annottext">[(Name, Id -&gt; CoreExpr -&gt; IOEnv (Env DsGblEnv DsLclEnv) Binding)]
</span><a href="GHC.HsToCore.html#magicDefns"><span class="hs-identifier hs-var">magicDefns</span></a></span><span>
</span><span id="line-730"></span><span>
</span><span id="line-731"></span><span class="annot"><a href="GHC.HsToCore.html#magicDefnModules"><span class="hs-identifier hs-type">magicDefnModules</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Unit.Module.Env.html#ModuleSet"><span class="hs-identifier hs-type">ModuleSet</span></a></span><span>
</span><span id="line-732"></span><span id="magicDefnModules"><span class="annot"><span class="annottext">magicDefnModules :: ModuleSet
</span><a href="GHC.HsToCore.html#magicDefnModules"><span class="hs-identifier hs-var hs-var">magicDefnModules</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Module] -&gt; ModuleSet
</span><a href="GHC.Unit.Module.Env.html#mkModuleSet"><span class="hs-identifier hs-var">mkModuleSet</span></a></span><span> </span><span class="annot"><span class="annottext">([Module] -&gt; ModuleSet) -&gt; [Module] -&gt; ModuleSet
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Name, Id -&gt; CoreExpr -&gt; IOEnv (Env DsGblEnv DsLclEnv) Binding)
 -&gt; Module)
-&gt; [(Name,
     Id -&gt; CoreExpr -&gt; IOEnv (Env DsGblEnv DsLclEnv) Binding)]
-&gt; [Module]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Name -&gt; Module
Name -&gt; Module
</span><a href="GHC.Types.Name.html#nameModule"><span class="hs-identifier hs-var">nameModule</span></a></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Module)
-&gt; ((Name, Id -&gt; CoreExpr -&gt; IOEnv (Env DsGblEnv DsLclEnv) Binding)
    -&gt; Name)
-&gt; (Name, Id -&gt; CoreExpr -&gt; IOEnv (Env DsGblEnv DsLclEnv) Binding)
-&gt; Module
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name
forall a. NamedThing a =&gt; a -&gt; Name
</span><a href="GHC.Types.Name.html#getName"><span class="hs-identifier hs-var">getName</span></a></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Name)
-&gt; ((Name, Id -&gt; CoreExpr -&gt; IOEnv (Env DsGblEnv DsLclEnv) Binding)
    -&gt; Name)
-&gt; (Name, Id -&gt; CoreExpr -&gt; IOEnv (Env DsGblEnv DsLclEnv) Binding)
-&gt; Name
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Name, Id -&gt; CoreExpr -&gt; IOEnv (Env DsGblEnv DsLclEnv) Binding)
-&gt; Name
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, Id -&gt; CoreExpr -&gt; IOEnv (Env DsGblEnv DsLclEnv) Binding)]
</span><a href="GHC.HsToCore.html#magicDefns"><span class="hs-identifier hs-var">magicDefns</span></a></span><span>
</span><span id="line-733"></span><span>
</span><span id="line-734"></span><span class="annot"><a href="GHC.HsToCore.html#mkUnsafeCoercePrimPair"><span class="hs-identifier hs-type">mkUnsafeCoercePrimPair</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.HsToCore.Types.html#DsM"><span class="hs-identifier hs-type">DsM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-735"></span><span class="hs-comment">-- See Note [Wiring in unsafeCoerce#] for the defn we are creating here</span><span>
</span><span id="line-736"></span><span id="mkUnsafeCoercePrimPair"><span class="annot"><span class="annottext">mkUnsafeCoercePrimPair :: Id -&gt; CoreExpr -&gt; IOEnv (Env DsGblEnv DsLclEnv) Binding
</span><a href="GHC.HsToCore.html#mkUnsafeCoercePrimPair"><span class="hs-identifier hs-var hs-var">mkUnsafeCoercePrimPair</span></a></span></span><span> </span><span id="local-6989586621683151828"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151828"><span class="hs-identifier hs-var">_old_id</span></a></span></span><span> </span><span id="local-6989586621683151829"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621683151829"><span class="hs-identifier hs-var">old_expr</span></a></span></span><span>
</span><span id="line-737"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683151830"><span class="annot"><a href="#local-6989586621683151830"><span class="hs-identifier hs-var">unsafe_equality_proof_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; DsM Id
</span><a href="GHC.HsToCore.Monad.html#dsLookupGlobalId"><span class="hs-identifier hs-var">dsLookupGlobalId</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.html#unsafeEqualityProofName"><span class="hs-identifier hs-var">unsafeEqualityProofName</span></a></span><span>
</span><span id="line-738"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683151833"><span class="annot"><a href="#local-6989586621683151833"><span class="hs-identifier hs-var">unsafe_equality_tc</span></a></span></span><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.HsToCore.Monad.html#dsLookupTyCon"><span class="hs-identifier hs-type">dsLookupTyCon</span></a></span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html#unsafeEqualityTyConName"><span class="hs-identifier hs-type">unsafeEqualityTyConName</span></a></span><span>
</span><span id="line-739"></span><span>
</span><span id="line-740"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">[</span><span id="local-6989586621683151836"><span class="annot"><a href="#local-6989586621683151836"><span class="hs-identifier hs-var">unsafe_refl_data_con</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#tyConDataCons"><span class="hs-identifier hs-type">tyConDataCons</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151833"><span class="hs-identifier hs-type">unsafe_equality_tc</span></a></span><span>
</span><span id="line-741"></span><span>
</span><span id="line-742"></span><span>             </span><span id="local-6989586621683151837"><span class="annot"><a href="#local-6989586621683151837"><span class="hs-identifier hs-var hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; CoreExpr -&gt; CoreExpr
forall b. [b] -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#mkLams"><span class="hs-identifier hs-var">mkLams</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="GHC.Builtin.Types.Prim.html#runtimeRep1TyVar"><span class="hs-identifier hs-var">runtimeRep1TyVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="GHC.Builtin.Types.Prim.html#runtimeRep2TyVar"><span class="hs-identifier hs-var">runtimeRep2TyVar</span></a></span><span>
</span><span id="line-743"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="GHC.Builtin.Types.Prim.html#openAlphaTyVar"><span class="hs-identifier hs-var">openAlphaTyVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="GHC.Builtin.Types.Prim.html#openBetaTyVar"><span class="hs-identifier hs-var">openBetaTyVar</span></a></span><span>
</span><span id="line-744"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151843"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr) -&gt; CoreExpr -&gt; CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-745"></span><span>                   </span><span class="annot"><span class="annottext">CoreExpr -&gt; Id -&gt; AltCon -&gt; [Id] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkSingleAltCase"><span class="hs-identifier hs-var">mkSingleAltCase</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621683151845"><span class="hs-identifier hs-var">scrut1</span></a></span><span>
</span><span id="line-746"></span><span>                                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Id
</span><a href="GHC.Core.Make.html#mkWildValBinder"><span class="hs-identifier hs-var">mkWildValBinder</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Core.Type.html#ManyTy"><span class="hs-identifier hs-var">ManyTy</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683151848"><span class="hs-identifier hs-var">scrut1_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-747"></span><span>                                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; AltCon
</span><a href="GHC.Core.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621683151836"><span class="hs-identifier hs-var">unsafe_refl_data_con</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-748"></span><span>                                   </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151850"><span class="hs-identifier hs-var">rr_cv</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr) -&gt; CoreExpr -&gt; CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-749"></span><span>                   </span><span class="annot"><span class="annottext">CoreExpr -&gt; Id -&gt; AltCon -&gt; [Id] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkSingleAltCase"><span class="hs-identifier hs-var">mkSingleAltCase</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621683151851"><span class="hs-identifier hs-var">scrut2</span></a></span><span>
</span><span id="line-750"></span><span>                                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Id
</span><a href="GHC.Core.Make.html#mkWildValBinder"><span class="hs-identifier hs-var">mkWildValBinder</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Core.Type.html#ManyTy"><span class="hs-identifier hs-var">ManyTy</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683151852"><span class="hs-identifier hs-var">scrut2_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-751"></span><span>                                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; AltCon
</span><a href="GHC.Core.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621683151836"><span class="hs-identifier hs-var">unsafe_refl_data_con</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-752"></span><span>                                   </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151853"><span class="hs-identifier hs-var">ab_cv</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr) -&gt; CoreExpr -&gt; CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-753"></span><span>                   </span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151843"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; Coercion -&gt; CoreExpr
CoreExpr -&gt; Coercion -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkCast"><span class="hs-operator hs-var">`mkCast`</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683151855"><span class="hs-identifier hs-var">x_co</span></a></span><span>
</span><span id="line-754"></span><span>
</span><span id="line-755"></span><span>             </span><span class="hs-special">[</span><span id="local-6989586621683151843"><span class="annot"><a href="#local-6989586621683151843"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683151850"><span class="annot"><a href="#local-6989586621683151850"><span class="hs-identifier hs-var">rr_cv</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683151853"><span class="annot"><a href="#local-6989586621683151853"><span class="hs-identifier hs-var">ab_cv</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Id.html#mkTemplateLocals"><span class="hs-identifier hs-type">mkTemplateLocals</span></a></span><span>
</span><span id="line-756"></span><span>               </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.Prim.html#openAlphaTy"><span class="hs-identifier hs-type">openAlphaTy</span></a></span><span> </span><span class="hs-comment">-- x :: a</span><span>
</span><span id="line-757"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683151858"><span class="hs-identifier hs-type">rr_cv_ty</span></a></span><span>    </span><span class="hs-comment">-- rr_cv :: r1 ~# r2</span><span>
</span><span id="line-758"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683151859"><span class="hs-identifier hs-type">ab_cv_ty</span></a></span><span>    </span><span class="hs-comment">-- ab_cv :: (alpha |&gt; alpha_co ~# beta)</span><span>
</span><span id="line-759"></span><span>               </span><span class="hs-special">]</span><span>
</span><span id="line-760"></span><span>
</span><span id="line-761"></span><span>             </span><span class="hs-comment">-- Returns (scrutinee, scrutinee type, type of covar in AltCon)</span><span>
</span><span id="line-762"></span><span>             </span><span id="local-6989586621683151860"><span class="annot"><a href="#local-6989586621683151860"><span class="hs-identifier hs-var hs-var">unsafe_equality</span></a></span></span><span> </span><span id="local-6989586621683151861"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683151861"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621683151862"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683151862"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621683151863"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683151863"><span class="hs-identifier hs-var">b</span></a></span></span><span>
</span><span id="line-763"></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; [Type] -&gt; CoreExpr
forall b. Expr b -&gt; [Type] -&gt; Expr b
</span><a href="GHC.Core.html#mkTyApps"><span class="hs-identifier hs-var">mkTyApps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151830"><span class="hs-identifier hs-var">unsafe_equality_proof_id</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683151861"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683151863"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683151862"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-764"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; Type
</span><a href="GHC.Core.Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683151833"><span class="hs-identifier hs-var">unsafe_equality_tc</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683151861"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683151863"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683151862"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-765"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Type -&gt; Type
</span><a href="GHC.Core.Coercion.html#mkNomPrimEqPred"><span class="hs-identifier hs-var">mkNomPrimEqPred</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683151861"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683151862"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683151863"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-766"></span><span>                 </span><span class="hs-special">)</span><span>
</span><span id="line-767"></span><span>             </span><span class="hs-comment">-- NB: UnsafeRefl :: (b ~# a) -&gt; UnsafeEquality a b, so we have to</span><span>
</span><span id="line-768"></span><span>             </span><span class="hs-comment">-- carefully swap the arguments above</span><span>
</span><span id="line-769"></span><span>
</span><span id="line-770"></span><span>             </span><span class="hs-special">(</span><span id="local-6989586621683151845"><span class="annot"><a href="#local-6989586621683151845"><span class="hs-identifier hs-var">scrut1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683151848"><span class="annot"><a href="#local-6989586621683151848"><span class="hs-identifier hs-var">scrut1_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683151858"><span class="annot"><a href="#local-6989586621683151858"><span class="hs-identifier hs-var">rr_cv_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683151860"><span class="hs-identifier hs-type">unsafe_equality</span></a></span><span> </span><span class="annot"><a href="GHC.Builtin.Types.html#runtimeRepTy"><span class="hs-identifier hs-type">runtimeRepTy</span></a></span><span>
</span><span id="line-771"></span><span>                                                             </span><span class="annot"><a href="GHC.Builtin.Types.Prim.html#runtimeRep1Ty"><span class="hs-identifier hs-type">runtimeRep1Ty</span></a></span><span>
</span><span id="line-772"></span><span>                                                             </span><span class="annot"><a href="GHC.Builtin.Types.Prim.html#runtimeRep2Ty"><span class="hs-identifier hs-type">runtimeRep2Ty</span></a></span><span>
</span><span id="line-773"></span><span>             </span><span class="hs-special">(</span><span id="local-6989586621683151851"><span class="annot"><a href="#local-6989586621683151851"><span class="hs-identifier hs-var">scrut2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683151852"><span class="annot"><a href="#local-6989586621683151852"><span class="hs-identifier hs-var">scrut2_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683151859"><span class="annot"><a href="#local-6989586621683151859"><span class="hs-identifier hs-var">ab_cv_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683151860"><span class="hs-identifier hs-type">unsafe_equality</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Type.html#mkTYPEapp"><span class="hs-identifier hs-type">mkTYPEapp</span></a></span><span> </span><span class="annot"><a href="GHC.Builtin.Types.Prim.html#runtimeRep2Ty"><span class="hs-identifier hs-type">runtimeRep2Ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-774"></span><span>                                                             </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Builtin.Types.Prim.html#openAlphaTy"><span class="hs-identifier hs-type">openAlphaTy</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Type.html#mkCastTy"><span class="hs-operator hs-type">`mkCastTy`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683151870"><span class="hs-identifier hs-type">alpha_co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-775"></span><span>                                                             </span><span class="annot"><a href="GHC.Builtin.Types.Prim.html#openBetaTy"><span class="hs-identifier hs-type">openBetaTy</span></a></span><span>
</span><span id="line-776"></span><span>
</span><span id="line-777"></span><span>             </span><span class="hs-comment">-- alpha_co :: TYPE r1 ~# TYPE r2</span><span>
</span><span id="line-778"></span><span>             </span><span class="hs-comment">-- alpha_co = TYPE rr_cv</span><span>
</span><span id="line-779"></span><span>             </span><span id="local-6989586621683151870"><span class="annot"><a href="#local-6989586621683151870"><span class="hs-identifier hs-var hs-var">alpha_co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Role -&gt; TyCon -&gt; [Coercion] -&gt; Coercion
Role -&gt; TyCon -&gt; [Coercion] -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-var">mkTyConAppCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="GHC.Builtin.Types.Prim.html#tYPETyCon"><span class="hs-identifier hs-var">tYPETyCon</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Id -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkCoVarCo"><span class="hs-identifier hs-var">mkCoVarCo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151850"><span class="hs-identifier hs-var">rr_cv</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-780"></span><span>
</span><span id="line-781"></span><span>             </span><span class="hs-comment">-- x_co :: alpha ~R# beta</span><span>
</span><span id="line-782"></span><span>             </span><span id="local-6989586621683151855"><span class="annot"><a href="#local-6989586621683151855"><span class="hs-identifier hs-var hs-var">x_co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Role -&gt; Type -&gt; Coercion -&gt; Coercion
Role -&gt; Type -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkGReflMCo"><span class="hs-identifier hs-var">mkGReflMCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Representational"><span class="hs-identifier hs-var">Representational</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Builtin.Types.Prim.html#openAlphaTy"><span class="hs-identifier hs-var">openAlphaTy</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683151870"><span class="hs-identifier hs-var">alpha_co</span></a></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Coercion -&gt; Coercion
Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkTransCo"><span class="hs-operator hs-var">`mkTransCo`</span></a></span><span>
</span><span id="line-783"></span><span>                    </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Coercion
Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkSubCo"><span class="hs-identifier hs-var">mkSubCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkCoVarCo"><span class="hs-identifier hs-var">mkCoVarCo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683151853"><span class="hs-identifier hs-var">ab_cv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-784"></span><span>
</span><span id="line-785"></span><span>
</span><span id="line-786"></span><span>             </span><span id="local-6989586621683151879"><span class="annot"><a href="#local-6989586621683151879"><span class="hs-identifier hs-var hs-var">info</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="GHC.Types.Id.Info.html#noCafIdInfo"><span class="hs-identifier hs-var">noCafIdInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo -&gt; InlinePragma -&gt; IdInfo
</span><a href="GHC.Types.Id.Info.html#setInlinePragInfo"><span class="hs-operator hs-var">`setInlinePragInfo`</span></a></span><span> </span><span class="annot"><span class="annottext">InlinePragma
</span><a href="GHC.Types.Basic.html#alwaysInlinePragma"><span class="hs-identifier hs-var">alwaysInlinePragma</span></a></span><span>
</span><span id="line-787"></span><span>                                </span><span class="annot"><span class="annottext">IdInfo -&gt; Unfolding -&gt; IdInfo
</span><a href="GHC.Types.Id.Info.html#setUnfoldingInfo"><span class="hs-operator hs-var">`setUnfoldingInfo`</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkCompulsoryUnfolding"><span class="hs-identifier hs-var">mkCompulsoryUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621683151837"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-788"></span><span>                                </span><span class="annot"><span class="annottext">IdInfo -&gt; Int -&gt; IdInfo
</span><a href="GHC.Types.Id.Info.html#setArityInfo"><span class="hs-operator hs-var">`setArityInfo`</span></a></span><span>     </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683151886"><span class="hs-identifier hs-var">arity</span></a></span><span>
</span><span id="line-789"></span><span>
</span><span id="line-790"></span><span>             </span><span id="local-6989586621683151888"><span class="annot"><a href="#local-6989586621683151888"><span class="hs-identifier hs-var hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; Type -&gt; Type
</span><a href="GHC.Core.Type.html#mkSpecForAllTys"><span class="hs-identifier hs-var">mkSpecForAllTys</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="GHC.Builtin.Types.Prim.html#runtimeRep1TyVar"><span class="hs-identifier hs-var">runtimeRep1TyVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="GHC.Builtin.Types.Prim.html#runtimeRep2TyVar"><span class="hs-identifier hs-var">runtimeRep2TyVar</span></a></span><span>
</span><span id="line-791"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="GHC.Builtin.Types.Prim.html#openAlphaTyVar"><span class="hs-identifier hs-var">openAlphaTyVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="GHC.Builtin.Types.Prim.html#openBetaTyVar"><span class="hs-identifier hs-var">openBetaTyVar</span></a></span><span> </span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Type) -&gt; Type -&gt; Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-792"></span><span>                  </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Type -&gt; Type
Type -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#mkVisFunTyMany"><span class="hs-identifier hs-var">mkVisFunTyMany</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Builtin.Types.Prim.html#openAlphaTy"><span class="hs-identifier hs-var">openAlphaTy</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Builtin.Types.Prim.html#openBetaTy"><span class="hs-identifier hs-var">openBetaTy</span></a></span><span>
</span><span id="line-793"></span><span>
</span><span id="line-794"></span><span>             </span><span id="local-6989586621683151886"><span class="annot"><a href="#local-6989586621683151886"><span class="hs-identifier hs-var hs-var">arity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-795"></span><span>
</span><span id="line-796"></span><span>             </span><span id="local-6989586621683151892"><span class="annot"><a href="#local-6989586621683151892"><span class="hs-identifier hs-var hs-var">concs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[((Type, Position 'Neg), Id)] -&gt; Name -&gt; ConcreteTyVars
</span><a href="GHC.Types.Id.Make.html#mkRepPolyIdConcreteTyVars"><span class="hs-identifier hs-var">mkRepPolyIdConcreteTyVars</span></a></span><span>
</span><span id="line-797"></span><span>                     </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="GHC.Builtin.Types.Prim.html#openAlphaTyVar"><span class="hs-identifier hs-var">openAlphaTyVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Position (FlipPolarity 'Neg) -&gt; Position 'Neg
forall (p :: Polarity).
Int -&gt; Position (FlipPolarity p) -&gt; Position p
</span><a href="GHC.Tc.Types.Origin.html#Argument"><span class="hs-identifier hs-var">Argument</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Position (FlipPolarity 'Neg)
Position 'Pos
</span><a href="GHC.Tc.Types.Origin.html#Top"><span class="hs-identifier hs-var">Top</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="GHC.Builtin.Types.Prim.html#runtimeRep1TyVar"><span class="hs-identifier hs-var">runtimeRep1TyVar</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-798"></span><span>                     </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.html#unsafeCoercePrimName"><span class="hs-identifier hs-var">unsafeCoercePrimName</span></a></span><span>
</span><span id="line-799"></span><span>
</span><span id="line-800"></span><span>             </span><span id="local-6989586621683151896"><span class="annot"><a href="#local-6989586621683151896"><span class="hs-identifier hs-var hs-var">id</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdDetails -&gt; Name -&gt; Type -&gt; Id
</span><a href="GHC.Types.Id.html#mkExportedLocalId"><span class="hs-identifier hs-var">mkExportedLocalId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConcreteTyVars -&gt; IdDetails
</span><a href="GHC.Types.Id.Info.html#RepPolyId"><span class="hs-identifier hs-var">RepPolyId</span></a></span><span> </span><span class="annot"><span class="annottext">ConcreteTyVars
</span><a href="#local-6989586621683151892"><span class="hs-identifier hs-var">concs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.html#unsafeCoercePrimName"><span class="hs-identifier hs-var">unsafeCoercePrimName</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683151888"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; IdInfo -&gt; Id
</span><a href="GHC.Types.Id.html#setIdInfo"><span class="hs-operator hs-var">`setIdInfo`</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621683151879"><span class="hs-identifier hs-var">info</span></a></span><span>
</span><span id="line-801"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683151896"><span class="hs-identifier hs-type">id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683151829"><span class="hs-identifier hs-type">old_expr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-802"></span></pre></body></html>