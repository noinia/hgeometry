<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The AQUA Project, Glasgow University, 1994-1998


Core-syntax unfoldings

Unfoldings (which can travel across module boundaries) are in Core
syntax (namely @CoreExpr@s).

The type @Unfolding@ sits ``above'' simply-Core-expressions
unfoldings, capturing ``higher-level'' things we know about a binding,
usually things that the simplifier found out (e.g., ``it's a
literal'').  In the corner of a @CoreUnfolding@ unfolding, you will
find, unsurprisingly, a Core expression.
-}</span><span>
</span><span id="line-17"></span><span>
</span><span id="line-18"></span><span>
</span><span id="line-19"></span><span>
</span><span id="line-20"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html"><span class="hs-identifier">GHC.Core.Unfold</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-21"></span><span>        </span><span class="annot"><a href="GHC.Core.html#Unfolding"><span class="hs-identifier">Unfolding</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#UnfoldingGuidance"><span class="hs-identifier">UnfoldingGuidance</span></a></span><span class="hs-special">,</span><span>   </span><span class="hs-comment">-- Abstract types</span><span>
</span><span id="line-22"></span><span>
</span><span id="line-23"></span><span>        </span><span class="annot"><a href="GHC.Core.Unfold.html#ExprSize"><span class="hs-identifier">ExprSize</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#sizeExpr"><span class="hs-identifier">sizeExpr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-24"></span><span>
</span><span id="line-25"></span><span>        </span><span class="annot"><a href="GHC.Core.Unfold.html#ArgSummary"><span class="hs-identifier">ArgSummary</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#nonTriv"><span class="hs-identifier">nonTriv</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-26"></span><span>        </span><span class="annot"><a href="GHC.Core.Unfold.html#CallCtxt"><span class="hs-identifier">CallCtxt</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-27"></span><span>
</span><span id="line-28"></span><span>        </span><span class="annot"><a href="GHC.Core.Unfold.html#UnfoldingOpts"><span class="hs-identifier">UnfoldingOpts</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#defaultUnfoldingOpts"><span class="hs-identifier">defaultUnfoldingOpts</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>        </span><span class="annot"><a href="GHC.Core.Unfold.html#updateCreationThreshold"><span class="hs-identifier">updateCreationThreshold</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#updateUseThreshold"><span class="hs-identifier">updateUseThreshold</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>        </span><span class="annot"><a href="GHC.Core.Unfold.html#updateFunAppDiscount"><span class="hs-identifier">updateFunAppDiscount</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#updateDictDiscount"><span class="hs-identifier">updateDictDiscount</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-31"></span><span>        </span><span class="annot"><a href="GHC.Core.Unfold.html#updateVeryAggressive"><span class="hs-identifier">updateVeryAggressive</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#updateCaseScaling"><span class="hs-identifier">updateCaseScaling</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-32"></span><span>        </span><span class="annot"><a href="GHC.Core.Unfold.html#updateCaseThreshold"><span class="hs-identifier">updateCaseThreshold</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#updateReportPrefix"><span class="hs-identifier">updateReportPrefix</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-33"></span><span>
</span><span id="line-34"></span><span>        </span><span class="annot"><a href="GHC.Core.Unfold.html#inlineBoringOk"><span class="hs-identifier">inlineBoringOk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#calcUnfoldingGuidance"><span class="hs-identifier">calcUnfoldingGuidance</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-35"></span><span>        </span><span class="annot"><a href="GHC.Core.Unfold.html#uncondInlineJoin"><span class="hs-identifier">uncondInlineJoin</span></a></span><span>
</span><span id="line-36"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-37"></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.html"><span class="hs-identifier">GHC.Core</span></a></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html"><span class="hs-identifier">GHC.Core.Utils</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html"><span class="hs-identifier">GHC.Core.DataCon</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Type.html"><span class="hs-identifier">GHC.Core.Type</span></a></span><span>
</span><span id="line-44"></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.html"><span class="hs-identifier">GHC.Types.Id</span></a></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Literal.html"><span class="hs-identifier">GHC.Types.Literal</span></a></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.Info.html"><span class="hs-identifier">GHC.Types.Id.Info</span></a></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.RepType.html"><span class="hs-identifier">GHC.Types.RepType</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.RepType.html#isZeroBitTy"><span class="hs-identifier">isZeroBitTy</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html"><span class="hs-identifier">GHC.Types.Basic</span></a></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier">Arity</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#RecFlag"><span class="hs-identifier">RecFlag</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.ForeignCall.html"><span class="hs-identifier">GHC.Types.ForeignCall</span></a></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Tickish.html"><span class="hs-identifier">GHC.Types.Tickish</span></a></span><span>
</span><span id="line-52"></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.PrimOps.html"><span class="hs-identifier">GHC.Builtin.PrimOps</span></a></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html"><span class="hs-identifier">GHC.Builtin.Names</span></a></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Bag.html"><span class="hs-identifier">GHC.Data.Bag</span></a></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-58"></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../bytestring-0.12.2.0-7dd0/src/Data.ByteString.html"><span class="hs-identifier">Data.ByteString</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span>
</span><span id="line-60"></span><span>
</span><span id="line-61"></span><span class="annot"><span class="hs-comment">-- | Unfolding options</span></span><span>
</span><span id="line-62"></span><span class="hs-keyword">data</span><span> </span><span id="UnfoldingOpts"><span class="annot"><a href="GHC.Core.Unfold.html#UnfoldingOpts"><span class="hs-identifier hs-var">UnfoldingOpts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="UnfoldingOpts"><span class="annot"><a href="GHC.Core.Unfold.html#UnfoldingOpts"><span class="hs-identifier hs-var">UnfoldingOpts</span></a></span></span><span>
</span><span id="line-63"></span><span>   </span><span class="hs-special">{</span><span> </span><span id="unfoldingCreationThreshold"><span class="annot"><span class="annottext">UnfoldingOpts -&gt; Int
</span><a href="GHC.Core.Unfold.html#unfoldingCreationThreshold"><span class="hs-identifier hs-var hs-var">unfoldingCreationThreshold</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-64"></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ Threshold above which unfoldings are not *created*</span></span><span>
</span><span id="line-65"></span><span>
</span><span id="line-66"></span><span>   </span><span class="hs-special">,</span><span> </span><span id="unfoldingUseThreshold"><span class="annot"><span class="annottext">UnfoldingOpts -&gt; Int
</span><a href="GHC.Core.Unfold.html#unfoldingUseThreshold"><span class="hs-identifier hs-var hs-var">unfoldingUseThreshold</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-67"></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ Threshold above which unfoldings are not *inlined*</span></span><span>
</span><span id="line-68"></span><span>
</span><span id="line-69"></span><span>   </span><span class="hs-special">,</span><span> </span><span id="unfoldingFunAppDiscount"><span class="annot"><span class="annottext">UnfoldingOpts -&gt; Int
</span><a href="GHC.Core.Unfold.html#unfoldingFunAppDiscount"><span class="hs-identifier hs-var hs-var">unfoldingFunAppDiscount</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-70"></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ Discount for lambdas that are used (applied)</span></span><span>
</span><span id="line-71"></span><span>
</span><span id="line-72"></span><span>   </span><span class="hs-special">,</span><span> </span><span id="unfoldingDictDiscount"><span class="annot"><span class="annottext">UnfoldingOpts -&gt; Int
</span><a href="GHC.Core.Unfold.html#unfoldingDictDiscount"><span class="hs-identifier hs-var hs-var">unfoldingDictDiscount</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-73"></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ Discount for dictionaries</span></span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span>   </span><span class="hs-special">,</span><span> </span><span id="unfoldingVeryAggressive"><span class="annot"><span class="annottext">UnfoldingOpts -&gt; Bool
</span><a href="GHC.Core.Unfold.html#unfoldingVeryAggressive"><span class="hs-identifier hs-var hs-var">unfoldingVeryAggressive</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-76"></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ Force inlining in many more cases</span></span><span>
</span><span id="line-77"></span><span>
</span><span id="line-78"></span><span>   </span><span class="hs-special">,</span><span> </span><span id="unfoldingCaseThreshold"><span class="annot"><span class="annottext">UnfoldingOpts -&gt; Int
</span><a href="GHC.Core.Unfold.html#unfoldingCaseThreshold"><span class="hs-identifier hs-var hs-var">unfoldingCaseThreshold</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-79"></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ Don't consider depth up to x</span></span><span>
</span><span id="line-80"></span><span>
</span><span id="line-81"></span><span>   </span><span class="hs-special">,</span><span> </span><span id="unfoldingCaseScaling"><span class="annot"><span class="annottext">UnfoldingOpts -&gt; Int
</span><a href="GHC.Core.Unfold.html#unfoldingCaseScaling"><span class="hs-identifier hs-var hs-var">unfoldingCaseScaling</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-82"></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ Penalize depth with 1/x</span></span><span>
</span><span id="line-83"></span><span>
</span><span id="line-84"></span><span>   </span><span class="hs-special">,</span><span> </span><span id="unfoldingReportPrefix"><span class="annot"><span class="annottext">UnfoldingOpts -&gt; Maybe String
</span><a href="GHC.Core.Unfold.html#unfoldingReportPrefix"><span class="hs-identifier hs-var hs-var">unfoldingReportPrefix</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ Only report inlining decisions for names with this prefix</span></span><span>
</span><span id="line-86"></span><span>   </span><span class="hs-special">}</span><span>
</span><span id="line-87"></span><span>
</span><span id="line-88"></span><span class="annot"><a href="GHC.Core.Unfold.html#defaultUnfoldingOpts"><span class="hs-identifier hs-type">defaultUnfoldingOpts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#UnfoldingOpts"><span class="hs-identifier hs-type">UnfoldingOpts</span></a></span><span>
</span><span id="line-89"></span><span id="defaultUnfoldingOpts"><span class="annot"><span class="annottext">defaultUnfoldingOpts :: UnfoldingOpts
</span><a href="GHC.Core.Unfold.html#defaultUnfoldingOpts"><span class="hs-identifier hs-var hs-var">defaultUnfoldingOpts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#UnfoldingOpts"><span class="hs-identifier hs-type">UnfoldingOpts</span></a></span><span>
</span><span id="line-90"></span><span>   </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">unfoldingCreationThreshold :: Int
</span><a href="GHC.Core.Unfold.html#unfoldingCreationThreshold"><span class="hs-identifier hs-var">unfoldingCreationThreshold</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">750</span></span><span>
</span><span id="line-91"></span><span>      </span><span class="hs-comment">-- The unfoldingCreationThreshold threshold must be reasonably high</span><span>
</span><span id="line-92"></span><span>      </span><span class="hs-comment">-- to take account of possible discounts.</span><span>
</span><span id="line-93"></span><span>      </span><span class="hs-comment">-- E.g. 450 is not enough in 'fulsom' for Interval.sqr to</span><span>
</span><span id="line-94"></span><span>      </span><span class="hs-comment">-- inline into Csg.calc (The unfolding for sqr never makes it</span><span>
</span><span id="line-95"></span><span>      </span><span class="hs-comment">-- into the interface file.)</span><span>
</span><span id="line-96"></span><span>
</span><span id="line-97"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">unfoldingUseThreshold :: Int
</span><a href="GHC.Core.Unfold.html#unfoldingUseThreshold"><span class="hs-identifier hs-var">unfoldingUseThreshold</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">90</span></span><span>
</span><span id="line-98"></span><span>      </span><span class="hs-comment">-- Last adjusted upwards in #18282, when I reduced</span><span>
</span><span id="line-99"></span><span>      </span><span class="hs-comment">-- the result discount for constructors.</span><span>
</span><span id="line-100"></span><span>
</span><span id="line-101"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">unfoldingFunAppDiscount :: Int
</span><a href="GHC.Core.Unfold.html#unfoldingFunAppDiscount"><span class="hs-identifier hs-var">unfoldingFunAppDiscount</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">60</span></span><span>
</span><span id="line-102"></span><span>      </span><span class="hs-comment">-- Be fairly keen to inline a function if that means</span><span>
</span><span id="line-103"></span><span>      </span><span class="hs-comment">-- we'll be able to pick the right method from a dictionary</span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">unfoldingDictDiscount :: Int
</span><a href="GHC.Core.Unfold.html#unfoldingDictDiscount"><span class="hs-identifier hs-var">unfoldingDictDiscount</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">30</span></span><span>
</span><span id="line-106"></span><span>      </span><span class="hs-comment">-- Be fairly keen to inline a function if that means</span><span>
</span><span id="line-107"></span><span>      </span><span class="hs-comment">-- we'll be able to pick the right method from a dictionary</span><span>
</span><span id="line-108"></span><span>
</span><span id="line-109"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">unfoldingVeryAggressive :: Bool
</span><a href="GHC.Core.Unfold.html#unfoldingVeryAggressive"><span class="hs-identifier hs-var">unfoldingVeryAggressive</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-110"></span><span>
</span><span id="line-111"></span><span>      </span><span class="hs-comment">-- Only apply scaling once we are deeper than threshold cases</span><span>
</span><span id="line-112"></span><span>      </span><span class="hs-comment">-- in an RHS.</span><span>
</span><span id="line-113"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">unfoldingCaseThreshold :: Int
</span><a href="GHC.Core.Unfold.html#unfoldingCaseThreshold"><span class="hs-identifier hs-var">unfoldingCaseThreshold</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span>
</span><span id="line-114"></span><span>
</span><span id="line-115"></span><span>      </span><span class="hs-comment">-- Penalize depth with (size*depth)/scaling</span><span>
</span><span id="line-116"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">unfoldingCaseScaling :: Int
</span><a href="GHC.Core.Unfold.html#unfoldingCaseScaling"><span class="hs-identifier hs-var">unfoldingCaseScaling</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">30</span></span><span>
</span><span id="line-117"></span><span>
</span><span id="line-118"></span><span>      </span><span class="hs-comment">-- Don't filter inlining decision reports</span><span>
</span><span id="line-119"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">unfoldingReportPrefix :: Maybe String
</span><a href="GHC.Core.Unfold.html#unfoldingReportPrefix"><span class="hs-identifier hs-var">unfoldingReportPrefix</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe String
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-120"></span><span>   </span><span class="hs-special">}</span><span>
</span><span id="line-121"></span><span>
</span><span id="line-122"></span><span class="hs-comment">-- Helpers for &quot;GHC.Driver.Session&quot;</span><span>
</span><span id="line-123"></span><span>
</span><span id="line-124"></span><span class="annot"><a href="GHC.Core.Unfold.html#updateCreationThreshold"><span class="hs-identifier hs-type">updateCreationThreshold</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#UnfoldingOpts"><span class="hs-identifier hs-type">UnfoldingOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#UnfoldingOpts"><span class="hs-identifier hs-type">UnfoldingOpts</span></a></span><span>
</span><span id="line-125"></span><span id="updateCreationThreshold"><span class="annot"><span class="annottext">updateCreationThreshold :: Int -&gt; UnfoldingOpts -&gt; UnfoldingOpts
</span><a href="GHC.Core.Unfold.html#updateCreationThreshold"><span class="hs-identifier hs-var hs-var">updateCreationThreshold</span></a></span></span><span> </span><span id="local-6989586621682732660"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732660"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621682732661"><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682732661"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682732661"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#unfoldingCreationThreshold"><span class="hs-identifier hs-var">unfoldingCreationThreshold</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682732660"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-126"></span><span>
</span><span id="line-127"></span><span class="annot"><a href="GHC.Core.Unfold.html#updateUseThreshold"><span class="hs-identifier hs-type">updateUseThreshold</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#UnfoldingOpts"><span class="hs-identifier hs-type">UnfoldingOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#UnfoldingOpts"><span class="hs-identifier hs-type">UnfoldingOpts</span></a></span><span>
</span><span id="line-128"></span><span id="updateUseThreshold"><span class="annot"><span class="annottext">updateUseThreshold :: Int -&gt; UnfoldingOpts -&gt; UnfoldingOpts
</span><a href="GHC.Core.Unfold.html#updateUseThreshold"><span class="hs-identifier hs-var hs-var">updateUseThreshold</span></a></span></span><span> </span><span id="local-6989586621682732662"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732662"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621682732663"><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682732663"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682732663"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#unfoldingUseThreshold"><span class="hs-identifier hs-var">unfoldingUseThreshold</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682732662"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-129"></span><span>
</span><span id="line-130"></span><span class="annot"><a href="GHC.Core.Unfold.html#updateFunAppDiscount"><span class="hs-identifier hs-type">updateFunAppDiscount</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#UnfoldingOpts"><span class="hs-identifier hs-type">UnfoldingOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#UnfoldingOpts"><span class="hs-identifier hs-type">UnfoldingOpts</span></a></span><span>
</span><span id="line-131"></span><span id="updateFunAppDiscount"><span class="annot"><span class="annottext">updateFunAppDiscount :: Int -&gt; UnfoldingOpts -&gt; UnfoldingOpts
</span><a href="GHC.Core.Unfold.html#updateFunAppDiscount"><span class="hs-identifier hs-var hs-var">updateFunAppDiscount</span></a></span></span><span> </span><span id="local-6989586621682732664"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732664"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621682732665"><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682732665"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682732665"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#unfoldingFunAppDiscount"><span class="hs-identifier hs-var">unfoldingFunAppDiscount</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682732664"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-132"></span><span>
</span><span id="line-133"></span><span class="annot"><a href="GHC.Core.Unfold.html#updateDictDiscount"><span class="hs-identifier hs-type">updateDictDiscount</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#UnfoldingOpts"><span class="hs-identifier hs-type">UnfoldingOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#UnfoldingOpts"><span class="hs-identifier hs-type">UnfoldingOpts</span></a></span><span>
</span><span id="line-134"></span><span id="updateDictDiscount"><span class="annot"><span class="annottext">updateDictDiscount :: Int -&gt; UnfoldingOpts -&gt; UnfoldingOpts
</span><a href="GHC.Core.Unfold.html#updateDictDiscount"><span class="hs-identifier hs-var hs-var">updateDictDiscount</span></a></span></span><span> </span><span id="local-6989586621682732666"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732666"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621682732667"><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682732667"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682732667"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#unfoldingDictDiscount"><span class="hs-identifier hs-var">unfoldingDictDiscount</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682732666"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-135"></span><span>
</span><span id="line-136"></span><span class="annot"><a href="GHC.Core.Unfold.html#updateVeryAggressive"><span class="hs-identifier hs-type">updateVeryAggressive</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#UnfoldingOpts"><span class="hs-identifier hs-type">UnfoldingOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#UnfoldingOpts"><span class="hs-identifier hs-type">UnfoldingOpts</span></a></span><span>
</span><span id="line-137"></span><span id="updateVeryAggressive"><span class="annot"><span class="annottext">updateVeryAggressive :: Bool -&gt; UnfoldingOpts -&gt; UnfoldingOpts
</span><a href="GHC.Core.Unfold.html#updateVeryAggressive"><span class="hs-identifier hs-var hs-var">updateVeryAggressive</span></a></span></span><span> </span><span id="local-6989586621682732668"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682732668"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621682732669"><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682732669"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682732669"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#unfoldingVeryAggressive"><span class="hs-identifier hs-var">unfoldingVeryAggressive</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682732668"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-138"></span><span>
</span><span id="line-139"></span><span>
</span><span id="line-140"></span><span class="annot"><a href="GHC.Core.Unfold.html#updateCaseThreshold"><span class="hs-identifier hs-type">updateCaseThreshold</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#UnfoldingOpts"><span class="hs-identifier hs-type">UnfoldingOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#UnfoldingOpts"><span class="hs-identifier hs-type">UnfoldingOpts</span></a></span><span>
</span><span id="line-141"></span><span id="updateCaseThreshold"><span class="annot"><span class="annottext">updateCaseThreshold :: Int -&gt; UnfoldingOpts -&gt; UnfoldingOpts
</span><a href="GHC.Core.Unfold.html#updateCaseThreshold"><span class="hs-identifier hs-var hs-var">updateCaseThreshold</span></a></span></span><span> </span><span id="local-6989586621682732670"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732670"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621682732671"><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682732671"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682732671"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#unfoldingCaseThreshold"><span class="hs-identifier hs-var">unfoldingCaseThreshold</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682732670"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-142"></span><span>
</span><span id="line-143"></span><span class="annot"><a href="GHC.Core.Unfold.html#updateCaseScaling"><span class="hs-identifier hs-type">updateCaseScaling</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#UnfoldingOpts"><span class="hs-identifier hs-type">UnfoldingOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#UnfoldingOpts"><span class="hs-identifier hs-type">UnfoldingOpts</span></a></span><span>
</span><span id="line-144"></span><span id="updateCaseScaling"><span class="annot"><span class="annottext">updateCaseScaling :: Int -&gt; UnfoldingOpts -&gt; UnfoldingOpts
</span><a href="GHC.Core.Unfold.html#updateCaseScaling"><span class="hs-identifier hs-var hs-var">updateCaseScaling</span></a></span></span><span> </span><span id="local-6989586621682732672"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732672"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621682732673"><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682732673"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682732673"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#unfoldingCaseScaling"><span class="hs-identifier hs-var">unfoldingCaseScaling</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682732672"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span class="annot"><a href="GHC.Core.Unfold.html#updateReportPrefix"><span class="hs-identifier hs-type">updateReportPrefix</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#UnfoldingOpts"><span class="hs-identifier hs-type">UnfoldingOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#UnfoldingOpts"><span class="hs-identifier hs-type">UnfoldingOpts</span></a></span><span>
</span><span id="line-147"></span><span id="updateReportPrefix"><span class="annot"><span class="annottext">updateReportPrefix :: Maybe String -&gt; UnfoldingOpts -&gt; UnfoldingOpts
</span><a href="GHC.Core.Unfold.html#updateReportPrefix"><span class="hs-identifier hs-var hs-var">updateReportPrefix</span></a></span></span><span> </span><span id="local-6989586621682732674"><span class="annot"><span class="annottext">Maybe String
</span><a href="#local-6989586621682732674"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621682732675"><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682732675"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682732675"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#unfoldingReportPrefix"><span class="hs-identifier hs-var">unfoldingReportPrefix</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682732674"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-148"></span><span>
</span><span id="line-149"></span><span class="hs-keyword">data</span><span> </span><span id="ArgSummary"><span class="annot"><a href="GHC.Core.Unfold.html#ArgSummary"><span class="hs-identifier hs-var">ArgSummary</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="TrivArg"><span class="annot"><a href="GHC.Core.Unfold.html#TrivArg"><span class="hs-identifier hs-var">TrivArg</span></a></span></span><span>       </span><span class="hs-comment">-- Nothing interesting</span><span>
</span><span id="line-150"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span id="NonTrivArg"><span class="annot"><a href="GHC.Core.Unfold.html#NonTrivArg"><span class="hs-identifier hs-var">NonTrivArg</span></a></span></span><span>    </span><span class="hs-comment">-- Arg has structure</span><span>
</span><span id="line-151"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span id="ValueArg"><span class="annot"><a href="GHC.Core.Unfold.html#ValueArg"><span class="hs-identifier hs-var">ValueArg</span></a></span></span><span>      </span><span class="hs-comment">-- Arg is a con-app or PAP</span><span>
</span><span id="line-152"></span><span>                                </span><span class="hs-comment">-- ..or con-like. Note [Conlike is interesting]</span><span>
</span><span id="line-153"></span><span>
</span><span id="line-154"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#ArgSummary"><span class="hs-identifier hs-type">ArgSummary</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-155"></span><span>  </span><span id="local-6989586621682732686"><span class="annot"><span class="annottext">ppr :: ArgSummary -&gt; SDoc
</span><a href="#local-6989586621682732686"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="annot"><span class="annottext">ArgSummary
</span><a href="GHC.Core.Unfold.html#TrivArg"><span class="hs-identifier hs-var">TrivArg</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;TrivArg&quot;</span></span><span>
</span><span id="line-156"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">ArgSummary
</span><a href="GHC.Core.Unfold.html#NonTrivArg"><span class="hs-identifier hs-var">NonTrivArg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;NonTrivArg&quot;</span></span><span>
</span><span id="line-157"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">ArgSummary
</span><a href="GHC.Core.Unfold.html#ValueArg"><span class="hs-identifier hs-var">ValueArg</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ValueArg&quot;</span></span><span>
</span><span id="line-158"></span><span>
</span><span id="line-159"></span><span class="annot"><a href="GHC.Core.Unfold.html#nonTriv"><span class="hs-identifier hs-type">nonTriv</span></a></span><span> </span><span class="hs-glyph">::</span><span>  </span><span class="annot"><a href="GHC.Core.Unfold.html#ArgSummary"><span class="hs-identifier hs-type">ArgSummary</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-160"></span><span id="nonTriv"><span class="annot"><span class="annottext">nonTriv :: ArgSummary -&gt; Bool
</span><a href="GHC.Core.Unfold.html#nonTriv"><span class="hs-identifier hs-var hs-var">nonTriv</span></a></span></span><span> </span><span class="annot"><span class="annottext">ArgSummary
</span><a href="GHC.Core.Unfold.html#TrivArg"><span class="hs-identifier hs-var">TrivArg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-161"></span><span class="annot"><a href="GHC.Core.Unfold.html#nonTriv"><span class="hs-identifier hs-var">nonTriv</span></a></span><span> </span><span class="annot"><span class="annottext">ArgSummary
</span><span class="hs-identifier">_</span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-162"></span><span>
</span><span id="line-163"></span><span class="hs-keyword">data</span><span> </span><span id="CallCtxt"><span class="annot"><a href="GHC.Core.Unfold.html#CallCtxt"><span class="hs-identifier hs-var">CallCtxt</span></a></span></span><span>
</span><span id="line-164"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="BoringCtxt"><span class="annot"><a href="GHC.Core.Unfold.html#BoringCtxt"><span class="hs-identifier hs-var">BoringCtxt</span></a></span></span><span>
</span><span id="line-165"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="RhsCtxt"><span class="annot"><a href="GHC.Core.Unfold.html#RhsCtxt"><span class="hs-identifier hs-var">RhsCtxt</span></a></span></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#RecFlag"><span class="hs-identifier hs-type">RecFlag</span></a></span><span>     </span><span class="hs-comment">-- Rhs of a let-binding; see Note [RHS of lets]</span><span>
</span><span id="line-166"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="DiscArgCtxt"><span class="annot"><a href="GHC.Core.Unfold.html#DiscArgCtxt"><span class="hs-identifier hs-var">DiscArgCtxt</span></a></span></span><span>         </span><span class="hs-comment">-- Argument of a function with non-zero arg discount</span><span>
</span><span id="line-167"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="RuleArgCtxt"><span class="annot"><a href="GHC.Core.Unfold.html#RuleArgCtxt"><span class="hs-identifier hs-var">RuleArgCtxt</span></a></span></span><span>         </span><span class="hs-comment">-- We are somewhere in the argument of a function with rules</span><span>
</span><span id="line-168"></span><span>
</span><span id="line-169"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="ValAppCtxt"><span class="annot"><a href="GHC.Core.Unfold.html#ValAppCtxt"><span class="hs-identifier hs-var">ValAppCtxt</span></a></span></span><span>          </span><span class="hs-comment">-- We're applied to at least one value arg</span><span>
</span><span id="line-170"></span><span>                        </span><span class="hs-comment">-- This arises when we have ((f x |&gt; co) y)</span><span>
</span><span id="line-171"></span><span>                        </span><span class="hs-comment">-- Then the (f x) has argument 'x' but in a ValAppCtxt</span><span>
</span><span id="line-172"></span><span>
</span><span id="line-173"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="CaseCtxt"><span class="annot"><a href="GHC.Core.Unfold.html#CaseCtxt"><span class="hs-identifier hs-var">CaseCtxt</span></a></span></span><span>            </span><span class="hs-comment">-- We're the scrutinee of a case</span><span>
</span><span id="line-174"></span><span>                        </span><span class="hs-comment">-- that decomposes its scrutinee</span><span>
</span><span id="line-175"></span><span>
</span><span id="line-176"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#CallCtxt"><span class="hs-identifier hs-type">CallCtxt</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-177"></span><span>  </span><span id="local-6989586621682732707"><span class="annot"><span class="annottext">ppr :: CallCtxt -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="annot"><span class="annottext">CallCtxt
</span><a href="GHC.Core.Unfold.html#CaseCtxt"><span class="hs-identifier hs-var">CaseCtxt</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;CaseCtxt&quot;</span></span><span>
</span><span id="line-178"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CallCtxt
</span><a href="GHC.Core.Unfold.html#ValAppCtxt"><span class="hs-identifier hs-var">ValAppCtxt</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ValAppCtxt&quot;</span></span><span>
</span><span id="line-179"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CallCtxt
</span><a href="GHC.Core.Unfold.html#BoringCtxt"><span class="hs-identifier hs-var">BoringCtxt</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;BoringCtxt&quot;</span></span><span>
</span><span id="line-180"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Unfold.html#RhsCtxt"><span class="hs-identifier hs-type">RhsCtxt</span></a></span><span> </span><span id="local-6989586621682732708"><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621682732708"><span class="hs-identifier hs-var">ir</span></a></span></span><span class="hs-special">)</span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;RhsCtxt&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RecFlag -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621682732708"><span class="hs-identifier hs-var">ir</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-181"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CallCtxt
</span><a href="GHC.Core.Unfold.html#DiscArgCtxt"><span class="hs-identifier hs-var">DiscArgCtxt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;DiscArgCtxt&quot;</span></span><span>
</span><span id="line-182"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CallCtxt
</span><a href="GHC.Core.Unfold.html#RuleArgCtxt"><span class="hs-identifier hs-var">RuleArgCtxt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;RuleArgCtxt&quot;</span></span><span>
</span><span id="line-183"></span><span>
</span><span id="line-184"></span><span class="hs-comment">{-
Note [Calculate unfolding guidance on the non-occ-anal'd expression]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Notice that we give the non-occur-analysed expression to
calcUnfoldingGuidance.  In some ways it'd be better to occur-analyse
first; for example, sometimes during simplification, there's a large
let-bound thing which has been substituted, and so is now dead; so
'expr' contains two copies of the thing while the occurrence-analysed
expression doesn't.

Nevertheless, we *don't* and *must not* occ-analyse before computing
the size because

a) The size computation bales out after a while, whereas occurrence
   analysis does not.

b) Residency increases sharply if you occ-anal first.  I'm not
   100% sure why, but it's a large effect.  Compiling Cabal went
   from residency of 534M to over 800M with this one change.

This can occasionally mean that the guidance is very pessimistic;
it gets fixed up next round.  And it should be rare, because large
let-bound things that are dead are usually caught by preInlineUnconditionally


************************************************************************
*                                                                      *
\subsection{The UnfoldingGuidance type}
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-215"></span><span>
</span><span id="line-216"></span><span class="annot"><a href="GHC.Core.Unfold.html#inlineBoringOk"><span class="hs-identifier hs-type">inlineBoringOk</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-217"></span><span class="hs-comment">-- See Note [INLINE for small functions]</span><span>
</span><span id="line-218"></span><span class="hs-comment">-- True =&gt; the result of inlining the expression is</span><span>
</span><span id="line-219"></span><span class="hs-comment">--         no bigger than the expression itself</span><span>
</span><span id="line-220"></span><span class="hs-comment">--     eg      (\x y -&gt; f y x)</span><span>
</span><span id="line-221"></span><span class="hs-comment">-- This is a quick and dirty version. It doesn't attempt</span><span>
</span><span id="line-222"></span><span class="hs-comment">-- to deal with  (\x y z -&gt; x (y z))</span><span>
</span><span id="line-223"></span><span class="hs-comment">-- The really important one is (x `cast` c)</span><span>
</span><span id="line-224"></span><span id="inlineBoringOk"><span class="annot"><span class="annottext">inlineBoringOk :: CoreExpr -&gt; Bool
</span><a href="GHC.Core.Unfold.html#inlineBoringOk"><span class="hs-identifier hs-var hs-var">inlineBoringOk</span></a></span></span><span> </span><span id="local-6989586621682732711"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732711"><span class="hs-identifier hs-var">e</span></a></span></span><span>
</span><span id="line-225"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CoreExpr -&gt; Bool
</span><a href="#local-6989586621682732712"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732711"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-226"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-227"></span><span>    </span><span class="annot"><a href="#local-6989586621682732712"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-228"></span><span>    </span><span id="local-6989586621682732712"><span class="annot"><span class="annottext">go :: Int -&gt; CoreExpr -&gt; Bool
</span><a href="#local-6989586621682732712"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621682732713"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732713"><span class="hs-identifier hs-var">credit</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621682732715"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732715"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621682732716"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732716"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732715"><span class="hs-identifier hs-var">x</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CoreExpr -&gt; Bool
</span><a href="#local-6989586621682732712"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732713"><span class="hs-identifier hs-var">credit</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732716"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-229"></span><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CoreExpr -&gt; Bool
</span><a href="#local-6989586621682732712"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732713"><span class="hs-identifier hs-var">credit</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732716"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-230"></span><span>        </span><span class="hs-comment">-- See Note [Count coercion arguments in boring contexts]</span><span>
</span><span id="line-231"></span><span>    </span><span class="annot"><a href="#local-6989586621682732712"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682732719"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732719"><span class="hs-identifier hs-var">credit</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621682732721"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732721"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CoreExpr -&gt; Bool
</span><a href="#local-6989586621682732712"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732719"><span class="hs-identifier hs-var">credit</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732721"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-232"></span><span>    </span><span class="annot"><a href="#local-6989586621682732712"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682732723"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732723"><span class="hs-identifier hs-var">credit</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621682732724"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732724"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621682732725"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732725"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732723"><span class="hs-identifier hs-var">credit</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-233"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732725"><span class="hs-identifier hs-var">a</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CoreExpr -&gt; Bool
</span><a href="#local-6989586621682732712"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732723"><span class="hs-identifier hs-var">credit</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732724"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-234"></span><span>    </span><span class="annot"><a href="#local-6989586621682732712"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682732728"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732728"><span class="hs-identifier hs-var">credit</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682732730"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732730"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CoreExpr -&gt; Bool
</span><a href="#local-6989586621682732712"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732728"><span class="hs-identifier hs-var">credit</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732730"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-comment">-- dubious</span><span>
</span><span id="line-235"></span><span>    </span><span class="annot"><a href="#local-6989586621682732712"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682732731"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732731"><span class="hs-identifier hs-var">credit</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682732733"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732733"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CoreExpr -&gt; Bool
</span><a href="#local-6989586621682732712"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732731"><span class="hs-identifier hs-var">credit</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732733"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-236"></span><span>    </span><span class="annot"><a href="#local-6989586621682732712"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682732734"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732734"><span class="hs-identifier hs-var">credit</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span id="local-6989586621682732736"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732736"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621682732737"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732737"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682732738"><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621682732738"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-237"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Alt Id] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621682732738"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-238"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CoreExpr -&gt; Bool
</span><a href="#local-6989586621682732712"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732734"><span class="hs-identifier hs-var">credit</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732736"><span class="hs-identifier hs-var">e</span></a></span><span>   </span><span class="hs-comment">-- EmptyCase is like e</span><span>
</span><span id="line-239"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682732740"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732740"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Id -&gt; [Alt Id] -&gt; Maybe CoreExpr
</span><a href="GHC.Core.Utils.html#isUnsafeEqualityCase"><span class="hs-identifier hs-var">isUnsafeEqualityCase</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732736"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732737"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621682732738"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-240"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CoreExpr -&gt; Bool
</span><a href="#local-6989586621682732712"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732734"><span class="hs-identifier hs-var">credit</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732740"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="hs-comment">-- See Note [Inline unsafeCoerce]</span><span>
</span><span id="line-241"></span><span>    </span><span class="annot"><a href="#local-6989586621682732712"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Core.html#boringCxtOk"><span class="hs-identifier hs-var">boringCxtOk</span></a></span><span>
</span><span id="line-242"></span><span>    </span><span class="annot"><a href="#local-6989586621682732712"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-type">Lit</span></a></span><span> </span><span id="local-6989586621682732745"><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621682732745"><span class="hs-identifier hs-var">l</span></a></span></span><span class="hs-special">)</span><span>                      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Literal -&gt; Bool
</span><a href="GHC.Types.Literal.html#litIsTrivial"><span class="hs-identifier hs-var">litIsTrivial</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621682732745"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Core.html#boringCxtOk"><span class="hs-identifier hs-var">boringCxtOk</span></a></span><span>
</span><span id="line-243"></span><span>    </span><span class="annot"><a href="#local-6989586621682732712"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span>      </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span>                            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Core.html#boringCxtNotOk"><span class="hs-identifier hs-var">boringCxtNotOk</span></a></span><span>
</span><span id="line-244"></span><span>
</span><span id="line-245"></span><span class="annot"><a href="GHC.Core.Unfold.html#calcUnfoldingGuidance"><span class="hs-identifier hs-type">calcUnfoldingGuidance</span></a></span><span>
</span><span id="line-246"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#UnfoldingOpts"><span class="hs-identifier hs-type">UnfoldingOpts</span></a></span><span>
</span><span id="line-247"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>          </span><span class="hs-comment">-- Definitely a top-level, bottoming binding</span><span>
</span><span id="line-248"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>          </span><span class="hs-comment">-- True &lt;=&gt; join point</span><span>
</span><span id="line-249"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>      </span><span class="hs-comment">-- Expression to look at</span><span>
</span><span id="line-250"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#UnfoldingGuidance"><span class="hs-identifier hs-type">UnfoldingGuidance</span></a></span><span>
</span><span id="line-251"></span><span id="calcUnfoldingGuidance"><span class="annot"><span class="annottext">calcUnfoldingGuidance :: UnfoldingOpts -&gt; Bool -&gt; Bool -&gt; CoreExpr -&gt; UnfoldingGuidance
</span><a href="GHC.Core.Unfold.html#calcUnfoldingGuidance"><span class="hs-identifier hs-var hs-var">calcUnfoldingGuidance</span></a></span></span><span> </span><span id="local-6989586621682732749"><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682732749"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621682732750"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682732750"><span class="hs-identifier hs-var">is_top_bottoming</span></a></span></span><span> </span><span id="local-6989586621682732751"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682732751"><span class="hs-identifier hs-var">is_join</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621682732752"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682732752"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621682732753"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732753"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-252"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishIsCode"><span class="hs-identifier hs-var">tickishIsCode</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682732752"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- non-code ticks don't matter for unfolding</span><span>
</span><span id="line-253"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts -&gt; Bool -&gt; Bool -&gt; CoreExpr -&gt; UnfoldingGuidance
</span><a href="GHC.Core.Unfold.html#calcUnfoldingGuidance"><span class="hs-identifier hs-var">calcUnfoldingGuidance</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682732749"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682732750"><span class="hs-identifier hs-var">is_top_bottoming</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682732751"><span class="hs-identifier hs-var">is_join</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732753"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-254"></span><span class="annot"><a href="GHC.Core.Unfold.html#calcUnfoldingGuidance"><span class="hs-identifier hs-var">calcUnfoldingGuidance</span></a></span><span> </span><span id="local-6989586621682732756"><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682732756"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621682732757"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682732757"><span class="hs-identifier hs-var">is_top_bottoming</span></a></span></span><span> </span><span id="local-6989586621682732758"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682732758"><span class="hs-identifier hs-var">is_join</span></a></span></span><span> </span><span id="local-6989586621682732759"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732759"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-255"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts -&gt; Int -&gt; [Id] -&gt; CoreExpr -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#sizeExpr"><span class="hs-identifier hs-var">sizeExpr</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682732756"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732760"><span class="hs-identifier hs-var">bOMB_OUT_SIZE</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682732761"><span class="hs-identifier hs-var">val_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732762"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-256"></span><span>      </span><span class="annot"><span class="annottext">ExprSize
</span><a href="GHC.Core.Unfold.html#TooBig"><span class="hs-identifier hs-var">TooBig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UnfoldingGuidance
</span><a href="GHC.Core.html#UnfNever"><span class="hs-identifier hs-var">UnfNever</span></a></span><span>
</span><span id="line-257"></span><span>      </span><span class="annot"><a href="GHC.Core.Unfold.html#SizeIs"><span class="hs-identifier hs-type">SizeIs</span></a></span><span> </span><span id="local-6989586621682732766"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732766"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span id="local-6989586621682732767"><span class="annot"><span class="annottext">Bag (Id, Int)
</span><a href="#local-6989586621682732767"><span class="hs-identifier hs-var">cased_bndrs</span></a></span></span><span> </span><span id="local-6989586621682732768"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732768"><span class="hs-identifier hs-var">scrut_discount</span></a></span></span><span>
</span><span id="line-258"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; CoreExpr -&gt; [Id] -&gt; Int -&gt; CoreExpr -&gt; Int -&gt; Bool
</span><a href="GHC.Core.Unfold.html#uncondInline"><span class="hs-identifier hs-var">uncondInline</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682732758"><span class="hs-identifier hs-var">is_join</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732759"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682732770"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732771"><span class="hs-identifier hs-var">n_val_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732762"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732766"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-259"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#UnfWhen"><span class="hs-identifier hs-type">UnfWhen</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ug_unsat_ok :: Bool
</span><a href="GHC.Core.html#ug_unsat_ok"><span class="hs-identifier hs-var">ug_unsat_ok</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Core.html#unSaturatedOk"><span class="hs-identifier hs-var">unSaturatedOk</span></a></span><span>
</span><span id="line-260"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ug_boring_ok :: Bool
</span><a href="GHC.Core.html#ug_boring_ok"><span class="hs-identifier hs-var">ug_boring_ok</span></a></span><span> </span><span class="hs-glyph">=</span><span>  </span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Core.html#boringCxtOk"><span class="hs-identifier hs-var">boringCxtOk</span></a></span><span>
</span><span id="line-261"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ug_arity :: Int
</span><a href="GHC.Core.html#ug_arity"><span class="hs-identifier hs-var">ug_arity</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732771"><span class="hs-identifier hs-var">n_val_bndrs</span></a></span><span> </span><span class="hs-special">}</span><span>   </span><span class="hs-comment">-- Note [INLINE for small functions]</span><span>
</span><span id="line-262"></span><span>
</span><span id="line-263"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682732757"><span class="hs-identifier hs-var">is_top_bottoming</span></a></span><span>
</span><span id="line-264"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UnfoldingGuidance
</span><a href="GHC.Core.html#UnfNever"><span class="hs-identifier hs-var">UnfNever</span></a></span><span>   </span><span class="hs-comment">-- See Note [Do not inline top-level bottoming functions]</span><span>
</span><span id="line-265"></span><span>
</span><span id="line-266"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-267"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#UnfIfGoodArgs"><span class="hs-identifier hs-type">UnfIfGoodArgs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ug_args :: [Int]
</span><a href="GHC.Core.html#ug_args"><span class="hs-identifier hs-var">ug_args</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Int) -&gt; [Id] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bag (Id, Int) -&gt; Id -&gt; Int
</span><a href="#local-6989586621682732779"><span class="hs-identifier hs-var">mk_discount</span></a></span><span> </span><span class="annot"><span class="annottext">Bag (Id, Int)
</span><a href="#local-6989586621682732767"><span class="hs-identifier hs-var">cased_bndrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682732761"><span class="hs-identifier hs-var">val_bndrs</span></a></span><span>
</span><span id="line-268"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ug_size :: Int
</span><a href="GHC.Core.html#ug_size"><span class="hs-identifier hs-var">ug_size</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732766"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-269"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ug_res :: Int
</span><a href="GHC.Core.html#ug_res"><span class="hs-identifier hs-var">ug_res</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732768"><span class="hs-identifier hs-var">scrut_discount</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-270"></span><span>
</span><span id="line-271"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-272"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682732770"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682732770"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682732762"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732762"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; ([Id], CoreExpr)
forall b. Expr b -&gt; ([b], Expr b)
</span><a href="GHC.Core.html#collectBinders"><span class="hs-identifier hs-var">collectBinders</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732759"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-273"></span><span>    </span><span id="local-6989586621682732760"><span class="annot"><span class="annottext">bOMB_OUT_SIZE :: Int
</span><a href="#local-6989586621682732760"><span class="hs-identifier hs-var hs-var">bOMB_OUT_SIZE</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts -&gt; Int
</span><a href="GHC.Core.Unfold.html#unfoldingCreationThreshold"><span class="hs-identifier hs-var">unfoldingCreationThreshold</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682732756"><span class="hs-identifier hs-var">opts</span></a></span><span>
</span><span id="line-274"></span><span>           </span><span class="hs-comment">-- Bomb out if size gets bigger than this</span><span>
</span><span id="line-275"></span><span>    </span><span id="local-6989586621682732761"><span class="annot"><span class="annottext">val_bndrs :: [Id]
</span><a href="#local-6989586621682732761"><span class="hs-identifier hs-var hs-var">val_bndrs</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; [Id] -&gt; [Id]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682732770"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-276"></span><span>    </span><span id="local-6989586621682732771"><span class="annot"><span class="annottext">n_val_bndrs :: Int
</span><a href="#local-6989586621682732771"><span class="hs-identifier hs-var hs-var">n_val_bndrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682732761"><span class="hs-identifier hs-var">val_bndrs</span></a></span><span>
</span><span id="line-277"></span><span>
</span><span id="line-278"></span><span>    </span><span class="annot"><a href="#local-6989586621682732779"><span class="hs-identifier hs-type">mk_discount</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Data.Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-279"></span><span>    </span><span id="local-6989586621682732779"><span class="annot"><span class="annottext">mk_discount :: Bag (Id, Int) -&gt; Id -&gt; Int
</span><a href="#local-6989586621682732779"><span class="hs-identifier hs-var hs-var">mk_discount</span></a></span></span><span> </span><span id="local-6989586621682732784"><span class="annot"><span class="annottext">Bag (Id, Int)
</span><a href="#local-6989586621682732784"><span class="hs-identifier hs-var">cbs</span></a></span></span><span> </span><span id="local-6989586621682732785"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732785"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; (Id, Int) -&gt; Int) -&gt; Int -&gt; Bag (Id, Int) -&gt; Int
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; Bag a -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; (Id, Int) -&gt; Int
</span><a href="#local-6989586621682732787"><span class="hs-identifier hs-var">combine</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bag (Id, Int)
</span><a href="#local-6989586621682732784"><span class="hs-identifier hs-var">cbs</span></a></span><span>
</span><span id="line-280"></span><span>           </span><span class="hs-keyword">where</span><span>
</span><span id="line-281"></span><span>             </span><span id="local-6989586621682732787"><span class="annot"><span class="annottext">combine :: Int -&gt; (Id, Int) -&gt; Int
</span><a href="#local-6989586621682732787"><span class="hs-identifier hs-var hs-var">combine</span></a></span></span><span> </span><span id="local-6989586621682732788"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732788"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682732789"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732789"><span class="hs-identifier hs-var">bndr'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682732790"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732790"><span class="hs-identifier hs-var">disc</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-282"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732785"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Id -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732789"><span class="hs-identifier hs-var">bndr'</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732788"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
</span><a href="#local-6989586621682732791"><span class="hs-operator hs-var">`plus_disc`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732790"><span class="hs-identifier hs-var">disc</span></a></span><span>
</span><span id="line-283"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732788"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-284"></span><span>
</span><span id="line-285"></span><span>             </span><span class="annot"><a href="#local-6989586621682732791"><span class="hs-identifier hs-type">plus_disc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-286"></span><span>             </span><span id="local-6989586621682732791"><span class="annot"><span class="annottext">plus_disc :: Int -&gt; Int -&gt; Int
</span><a href="#local-6989586621682732791"><span class="hs-identifier hs-var hs-var">plus_disc</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isFunTy"><span class="hs-identifier hs-var">isFunTy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732785"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span>
</span><span id="line-287"></span><span>                       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">(+)</span></span><span>
</span><span id="line-288"></span><span>             </span><span class="hs-comment">-- See Note [Function and non-function discounts]</span><span>
</span><span id="line-289"></span><span>
</span><span id="line-290"></span><span class="hs-comment">{- Note [Inline unsafeCoerce]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We really want to inline unsafeCoerce, even when applied to boring
arguments.  It doesn't look as if its RHS is smaller than the call
   unsafeCoerce x = case unsafeEqualityProof @a @b of UnsafeRefl -&gt; x
but that case is discarded in CoreToStg -- see Note [Implementing unsafeCoerce]
in base:Unsafe.Coerce.

Moreover, if we /don't/ inline it, we may be left with
          f (unsafeCoerce x)
which will build a thunk -- bad, bad, bad.

Conclusion: we really want inlineBoringOk to be True of the RHS of
unsafeCoerce. And it really is, because we regard
  case unsafeEqualityProof @a @b of UnsafeRefl -&gt; rhs
as trivial iff rhs is. This is (U4) in Note [Implementing unsafeCoerce].

Note [Computing the size of an expression]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The basic idea of sizeExpr is obvious enough: count nodes.  But getting the
heuristics right has taken a long time.  Here's the basic strategy:

    * Variables, literals: 0
      (Exception for string literals, see litSize.)

    * Function applications (f e1 .. en): 1 + #value args

    * Constructor applications: 1, regardless of #args

    * Let(rec): 1 + size of components

    * Note, cast: 0

Examples

  Size  Term
  --------------
    0     42#
    0     x
    0     True
    2     f x
    1     Just x
    4     f (g x)

Notice that 'x' counts 0, while (f x) counts 2.  That's deliberate: there's
a function call to account for.  Notice also that constructor applications
are very cheap, because exposing them to a caller is so valuable.

[25/5/11] All sizes are now multiplied by 10, except for primops
(which have sizes like 1 or 4.  This makes primops look fantastically
cheap, and seems to be almost universally beneficial.  Done partly as a
result of #4978.

Note [Do not inline top-level bottoming functions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The FloatOut pass has gone to some trouble to float out calls to 'error'
and similar friends.  See Note [Bottoming floats] in GHC.Core.Opt.SetLevels.
Do not re-inline them!  But we *do* still inline if they are very small
(the uncondInline stuff).

Note [INLINE for small functions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider        {-# INLINE f #-}
                f x = Just x
                g y = f y
Then f's RHS is no larger than its LHS, so we should inline it into
even the most boring context.  In general, f the function is
sufficiently small that its body is as small as the call itself, the
inline unconditionally, regardless of how boring the context is.

Things to note:

(1) We inline *unconditionally* if inlined thing is smaller (using sizeExpr)
    than the thing it's replacing.  Notice that
      (f x) --&gt; (g 3)             -- YES, unconditionally
      (f x) --&gt; x : []            -- YES, *even though* there are two
                                  --      arguments to the cons
      x     --&gt; g 3               -- NO
      x     --&gt; Just v            -- NO

    It's very important not to unconditionally replace a variable by
    a non-atomic term.

(2) We do this even if the thing isn't saturated, else we end up with the
    silly situation that
       f x y = x
       ...map (f 3)...
    doesn't inline.  Even in a boring context, inlining without being
    saturated will give a lambda instead of a PAP, and will be more
    efficient at runtime.

(3) However, when the function's arity &gt; 0, we do insist that it
    has at least one value argument at the call site.  (This check is
    made in the UnfWhen case of callSiteInline.) Otherwise we find this:
         f = /\a \x:a. x
         d = /\b. MkD (f b)
    If we inline f here we get
         d = /\b. MkD (\x:b. x)
    and then prepareRhs floats out the argument, abstracting the type
    variables, so we end up with the original again!

(4) We must be much more cautious about arity-zero things. Consider
       let x = y +# z in ...
    In *size* terms primops look very small, because the generate a
    single instruction, but we do not want to unconditionally replace
    every occurrence of x with (y +# z).  So we only do the
    unconditional-inline thing for *trivial* expressions.

    NB: you might think that PostInlineUnconditionally would do this
    but it doesn't fire for top-level things; see GHC.Core.Opt.Simplify.Utils
    Note [Top level and postInlineUnconditionally]

Note [Count coercion arguments in boring contexts]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In inlineBoringOK, we ignore type arguments when deciding whether an
expression is okay to inline into boring contexts. This is good, since
if we have a definition like

  let y = x @Int in f y y

there&#8217;s no reason not to inline y at both use sites &#8212; no work is
actually duplicated. It may seem like the same reasoning applies to
coercion arguments, and indeed, in #17182 we changed inlineBoringOK to
treat coercions the same way.

However, this isn&#8217;t a good idea: unlike type arguments, which have
no runtime representation, coercion arguments *do* have a runtime
representation (albeit the zero-width VoidRep, see Note [Coercion tokens]
in &quot;GHC.CoreToStg&quot;). This caused trouble in #17787 for DataCon wrappers for
nullary GADT constructors: the wrappers would be inlined and each use of
the constructor would lead to a separate allocation instead of just
sharing the wrapper closure.

The solution: don&#8217;t ignore coercion arguments after all.
-}</span><span>
</span><span id="line-425"></span><span>
</span><span id="line-426"></span><span class="annot"><a href="GHC.Core.Unfold.html#uncondInline"><span class="hs-identifier hs-type">uncondInline</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-427"></span><span class="hs-comment">-- Inline unconditionally if there no size increase</span><span>
</span><span id="line-428"></span><span class="hs-comment">-- Size of call is arity (+1 for the function)</span><span>
</span><span id="line-429"></span><span class="hs-comment">-- See Note [INLINE for small functions]</span><span>
</span><span id="line-430"></span><span id="uncondInline"><span class="annot"><span class="annottext">uncondInline :: Bool -&gt; CoreExpr -&gt; [Id] -&gt; Int -&gt; CoreExpr -&gt; Int -&gt; Bool
</span><a href="GHC.Core.Unfold.html#uncondInline"><span class="hs-identifier hs-var hs-var">uncondInline</span></a></span></span><span> </span><span id="local-6989586621682732796"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682732796"><span class="hs-identifier hs-var">is_join</span></a></span></span><span> </span><span id="local-6989586621682732797"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732797"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span id="local-6989586621682732798"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682732798"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span id="local-6989586621682732799"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732799"><span class="hs-identifier hs-var">arity</span></a></span></span><span> </span><span id="local-6989586621682732800"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732800"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621682732801"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732801"><span class="hs-identifier hs-var">size</span></a></span></span><span>
</span><span id="line-431"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682732796"><span class="hs-identifier hs-var">is_join</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; CoreExpr -&gt; Bool
</span><a href="GHC.Core.Unfold.html#uncondInlineJoin"><span class="hs-identifier hs-var">uncondInlineJoin</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682732798"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732800"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-432"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732799"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732801"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">10</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732799"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- See Note [INLINE for small functions] (1)</span><span>
</span><span id="line-433"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732797"><span class="hs-identifier hs-var">rhs</span></a></span><span>        </span><span class="hs-comment">-- See Note [INLINE for small functions] (4)</span><span>
</span><span id="line-434"></span><span>
</span><span id="line-435"></span><span class="annot"><a href="GHC.Core.Unfold.html#uncondInlineJoin"><span class="hs-identifier hs-type">uncondInlineJoin</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-436"></span><span class="hs-comment">-- See Note [Duplicating join points] point (DJ3) in GHC.Core.Opt.Simplify.Iteration</span><span>
</span><span id="line-437"></span><span id="uncondInlineJoin"><span class="annot"><span class="annottext">uncondInlineJoin :: [Id] -&gt; CoreExpr -&gt; Bool
</span><a href="GHC.Core.Unfold.html#uncondInlineJoin"><span class="hs-identifier hs-var hs-var">uncondInlineJoin</span></a></span></span><span> </span><span id="local-6989586621682732804"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682732804"><span class="hs-identifier hs-var">_bndrs</span></a></span></span><span> </span><span id="local-6989586621682732805"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732805"><span class="hs-identifier hs-var">body</span></a></span></span><span>
</span><span id="line-438"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732805"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-439"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>   </span><span class="hs-comment">-- Nullary constructors, literals</span><span>
</span><span id="line-440"></span><span>
</span><span id="line-441"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682732806"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732806"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682732807"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682732807"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; (CoreExpr, [CoreExpr])
forall b. Expr b -&gt; (Expr b, [Expr b])
</span><a href="GHC.Core.html#collectArgs"><span class="hs-identifier hs-var">collectArgs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732805"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-442"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; Bool) -&gt; [CoreExpr] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682732807"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-443"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732806"><span class="hs-identifier hs-var">v</span></a></span><span>   </span><span class="hs-comment">-- Indirection to another join point; always inline</span><span>
</span><span id="line-444"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-445"></span><span>
</span><span id="line-446"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-447"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-448"></span><span>
</span><span id="line-449"></span><span>
</span><span id="line-450"></span><span class="annot"><a href="GHC.Core.Unfold.html#sizeExpr"><span class="hs-identifier hs-type">sizeExpr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#UnfoldingOpts"><span class="hs-identifier hs-type">UnfoldingOpts</span></a></span><span>
</span><span id="line-451"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>             </span><span class="hs-comment">-- Bomb out if it gets bigger than this</span><span>
</span><span id="line-452"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span>            </span><span class="hs-comment">-- Arguments; we're interested in which of these</span><span>
</span><span id="line-453"></span><span>                            </span><span class="hs-comment">-- get case'd</span><span>
</span><span id="line-454"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-455"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#ExprSize"><span class="hs-identifier hs-type">ExprSize</span></a></span><span>
</span><span id="line-456"></span><span>
</span><span id="line-457"></span><span class="hs-comment">-- Note [Computing the size of an expression]</span><span>
</span><span id="line-458"></span><span>
</span><span id="line-459"></span><span class="hs-comment">-- Forcing bOMB_OUT_SIZE early prevents repeated</span><span>
</span><span id="line-460"></span><span class="hs-comment">-- unboxing of the Int argument.</span><span>
</span><span id="line-461"></span><span id="sizeExpr"><span class="annot"><span class="annottext">sizeExpr :: UnfoldingOpts -&gt; Int -&gt; [Id] -&gt; CoreExpr -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#sizeExpr"><span class="hs-identifier hs-var hs-var">sizeExpr</span></a></span></span><span> </span><span id="local-6989586621682732811"><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682732811"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682732812"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732812"><span class="hs-identifier hs-var">bOMB_OUT_SIZE</span></a></span></span><span> </span><span id="local-6989586621682732813"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682732813"><span class="hs-identifier hs-var">top_args</span></a></span></span><span> </span><span id="local-6989586621682732814"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732814"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-462"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; ExprSize
</span><a href="#local-6989586621682732815"><span class="hs-identifier hs-var">size_up</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732814"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-463"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-464"></span><span>    </span><span id="local-6989586621682732815"><span class="annot"><span class="annottext">size_up :: CoreExpr -&gt; ExprSize
</span><a href="#local-6989586621682732815"><span class="hs-identifier hs-var hs-var">size_up</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682732816"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732816"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; ExprSize
</span><a href="#local-6989586621682732815"><span class="hs-identifier hs-var">size_up</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732816"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-465"></span><span>    </span><span class="annot"><a href="#local-6989586621682732815"><span class="hs-identifier hs-var">size_up</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682732817"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732817"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; ExprSize
</span><a href="#local-6989586621682732815"><span class="hs-identifier hs-var">size_up</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732817"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-466"></span><span>    </span><span class="annot"><a href="#local-6989586621682732815"><span class="hs-identifier hs-var">size_up</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExprSize
</span><a href="GHC.Core.Unfold.html#sizeZero"><span class="hs-identifier hs-var">sizeZero</span></a></span><span>           </span><span class="hs-comment">-- Types cost nothing</span><span>
</span><span id="line-467"></span><span>    </span><span class="annot"><a href="#local-6989586621682732815"><span class="hs-identifier hs-var">size_up</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExprSize
</span><a href="GHC.Core.Unfold.html#sizeZero"><span class="hs-identifier hs-var">sizeZero</span></a></span><span>
</span><span id="line-468"></span><span>    </span><span class="annot"><a href="#local-6989586621682732815"><span class="hs-identifier hs-var">size_up</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-type">Lit</span></a></span><span> </span><span id="local-6989586621682732820"><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621682732820"><span class="hs-identifier hs-var">lit</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#sizeN"><span class="hs-identifier hs-var">sizeN</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Literal -&gt; Int
</span><a href="GHC.Core.Unfold.html#litSize"><span class="hs-identifier hs-var">litSize</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621682732820"><span class="hs-identifier hs-var">lit</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-469"></span><span>    </span><span class="annot"><a href="#local-6989586621682732815"><span class="hs-identifier hs-var">size_up</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682732823"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732823"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="#local-6989586621682732824"><span class="hs-identifier hs-var">isZeroBitId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732823"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExprSize
</span><a href="GHC.Core.Unfold.html#sizeZero"><span class="hs-identifier hs-var">sizeZero</span></a></span><span>
</span><span id="line-470"></span><span>                      </span><span class="hs-comment">-- Make sure we get constructor discounts even</span><span>
</span><span id="line-471"></span><span>                      </span><span class="hs-comment">-- on nullary constructors</span><span>
</span><span id="line-472"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; [CoreExpr] -&gt; Int -&gt; ExprSize
</span><a href="#local-6989586621682732825"><span class="hs-identifier hs-var">size_up_call</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732823"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-473"></span><span>
</span><span id="line-474"></span><span>    </span><span class="annot"><a href="#local-6989586621682732815"><span class="hs-identifier hs-var">size_up</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621682732826"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732826"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621682732827"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732827"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-475"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
forall b. Expr b -&gt; Bool
</span><a href="GHC.Core.html#isTyCoArg"><span class="hs-identifier hs-var">isTyCoArg</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732827"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; ExprSize
</span><a href="#local-6989586621682732815"><span class="hs-identifier hs-var">size_up</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732826"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-476"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; ExprSize
</span><a href="#local-6989586621682732815"><span class="hs-identifier hs-var">size_up</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732827"><span class="hs-identifier hs-var">arg</span></a></span><span>  </span><span class="annot"><span class="annottext">ExprSize -&gt; ExprSize -&gt; ExprSize
</span><a href="#local-6989586621682732829"><span class="hs-operator hs-var">`addSizeNSD`</span></a></span><span>
</span><span id="line-477"></span><span>                        </span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; Int -&gt; ExprSize
</span><a href="#local-6989586621682732830"><span class="hs-identifier hs-var">size_up_app</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732826"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732827"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
forall b. Expr b -&gt; Bool
</span><a href="#local-6989586621682732831"><span class="hs-identifier hs-var">isZeroBitExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732827"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-478"></span><span>
</span><span id="line-479"></span><span>    </span><span class="annot"><a href="#local-6989586621682732815"><span class="hs-identifier hs-var">size_up</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621682732832"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732832"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682732833"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732833"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-480"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732832"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="#local-6989586621682732824"><span class="hs-identifier hs-var">isZeroBitId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732832"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts -&gt; ExprSize -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#lamScrutDiscount"><span class="hs-identifier hs-var">lamScrutDiscount</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682732811"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; ExprSize
</span><a href="#local-6989586621682732815"><span class="hs-identifier hs-var">size_up</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732833"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">ExprSize -&gt; Int -&gt; ExprSize
</span><a href="#local-6989586621682732835"><span class="hs-operator hs-var">`addSizeN`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">10</span></span><span class="hs-special">)</span><span>
</span><span id="line-481"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; ExprSize
</span><a href="#local-6989586621682732815"><span class="hs-identifier hs-var">size_up</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732833"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-482"></span><span>
</span><span id="line-483"></span><span>    </span><span class="annot"><a href="#local-6989586621682732815"><span class="hs-identifier hs-var">size_up</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span id="local-6989586621682732838"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732838"><span class="hs-identifier hs-var">binder</span></a></span></span><span> </span><span id="local-6989586621682732839"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732839"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682732840"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732840"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-484"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id, CoreExpr) -&gt; ExprSize
</span><a href="#local-6989586621682732841"><span class="hs-identifier hs-var">size_up_rhs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732838"><span class="hs-identifier hs-var">binder</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732839"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ExprSize -&gt; ExprSize -&gt; ExprSize
</span><a href="#local-6989586621682732829"><span class="hs-operator hs-var">`addSizeNSD`</span></a></span><span>
</span><span id="line-485"></span><span>        </span><span class="annot"><span class="annottext">CoreExpr -&gt; ExprSize
</span><a href="#local-6989586621682732815"><span class="hs-identifier hs-var">size_up</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732840"><span class="hs-identifier hs-var">body</span></a></span><span>              </span><span class="annot"><span class="annottext">ExprSize -&gt; Int -&gt; ExprSize
</span><a href="#local-6989586621682732835"><span class="hs-operator hs-var">`addSizeN`</span></a></span><span>
</span><span id="line-486"></span><span>        </span><span class="annot"><span class="annottext">Id -&gt; Int
forall {a}. Num a =&gt; Id -&gt; a
</span><a href="#local-6989586621682732842"><span class="hs-identifier hs-var">size_up_alloc</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732838"><span class="hs-identifier hs-var">binder</span></a></span><span>
</span><span id="line-487"></span><span>
</span><span id="line-488"></span><span>    </span><span class="annot"><a href="#local-6989586621682732815"><span class="hs-identifier hs-var">size_up</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span id="local-6989586621682732844"><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621682732844"><span class="hs-identifier hs-var">pairs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682732845"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732845"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-489"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Id, CoreExpr) -&gt; ExprSize -&gt; ExprSize)
-&gt; ExprSize -&gt; [(Id, CoreExpr)] -&gt; ExprSize
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExprSize -&gt; ExprSize -&gt; ExprSize
</span><a href="#local-6989586621682732829"><span class="hs-identifier hs-var">addSizeNSD</span></a></span><span> </span><span class="annot"><span class="annottext">(ExprSize -&gt; ExprSize -&gt; ExprSize)
-&gt; ((Id, CoreExpr) -&gt; ExprSize)
-&gt; (Id, CoreExpr)
-&gt; ExprSize
-&gt; ExprSize
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Id, CoreExpr) -&gt; ExprSize
</span><a href="#local-6989586621682732841"><span class="hs-identifier hs-var">size_up_rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-490"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; ExprSize
</span><a href="#local-6989586621682732815"><span class="hs-identifier hs-var">size_up</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732845"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">ExprSize -&gt; Int -&gt; ExprSize
</span><a href="#local-6989586621682732835"><span class="hs-operator hs-var">`addSizeN`</span></a></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Int
forall a. Num a =&gt; [a] -&gt; a
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">sum</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Id, CoreExpr) -&gt; Int) -&gt; [(Id, CoreExpr)] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Int
forall {a}. Num a =&gt; Id -&gt; a
</span><a href="#local-6989586621682732842"><span class="hs-identifier hs-var">size_up_alloc</span></a></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Int) -&gt; ((Id, CoreExpr) -&gt; Id) -&gt; (Id, CoreExpr) -&gt; Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Id, CoreExpr) -&gt; Id
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621682732844"><span class="hs-identifier hs-var">pairs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-491"></span><span>              </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621682732844"><span class="hs-identifier hs-var">pairs</span></a></span><span>
</span><span id="line-492"></span><span>
</span><span id="line-493"></span><span>    </span><span class="annot"><a href="#local-6989586621682732815"><span class="hs-identifier hs-var">size_up</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span id="local-6989586621682732850"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732850"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">Id
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682732851"><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621682732851"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-494"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Alt Id] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621682732851"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-495"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; ExprSize
</span><a href="#local-6989586621682732815"><span class="hs-identifier hs-var">size_up</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732850"><span class="hs-identifier hs-var">e</span></a></span><span>    </span><span class="hs-comment">-- case e of {} never returns, so take size of scrutinee</span><span>
</span><span id="line-496"></span><span>
</span><span id="line-497"></span><span>    </span><span class="annot"><a href="#local-6989586621682732815"><span class="hs-identifier hs-var">size_up</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span id="local-6989586621682732852"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732852"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">Id
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682732853"><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621682732853"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-498"></span><span>        </span><span class="hs-comment">-- Now alts is non-empty</span><span>
</span><span id="line-499"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682732854"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732854"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Maybe Id
</span><a href="#local-6989586621682732855"><span class="hs-identifier hs-var">is_top_arg</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732852"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-comment">-- We are scrutinising an argument variable</span><span>
</span><span id="line-500"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><span id="line-501"></span><span>            </span><span id="local-6989586621682732856"><span class="annot"><span class="annottext">alt_sizes :: [ExprSize]
</span><a href="#local-6989586621682732856"><span class="hs-identifier hs-var hs-var">alt_sizes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Alt Id -&gt; ExprSize) -&gt; [Alt Id] -&gt; [ExprSize]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Alt Id -&gt; ExprSize
</span><a href="#local-6989586621682732857"><span class="hs-identifier hs-var">size_up_alt</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621682732853"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-502"></span><span>
</span><span id="line-503"></span><span>                  </span><span class="hs-comment">-- alts_size tries to compute a good discount for</span><span>
</span><span id="line-504"></span><span>                  </span><span class="hs-comment">-- the case when we are scrutinising an argument variable</span><span>
</span><span id="line-505"></span><span>            </span><span id="local-6989586621682732858"><span class="annot"><span class="annottext">alts_size :: ExprSize -&gt; ExprSize -&gt; ExprSize
</span><a href="#local-6989586621682732858"><span class="hs-identifier hs-var hs-var">alts_size</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Unfold.html#SizeIs"><span class="hs-identifier hs-type">SizeIs</span></a></span><span> </span><span id="local-6989586621682732859"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732859"><span class="hs-identifier hs-var">tot</span></a></span></span><span> </span><span id="local-6989586621682732860"><span class="annot"><span class="annottext">Bag (Id, Int)
</span><a href="#local-6989586621682732860"><span class="hs-identifier hs-var">tot_disc</span></a></span></span><span> </span><span id="local-6989586621682732861"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732861"><span class="hs-identifier hs-var">tot_scrut</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-506"></span><span>                          </span><span class="hs-comment">-- Size of all alternatives</span><span>
</span><span id="line-507"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Unfold.html#SizeIs"><span class="hs-identifier hs-type">SizeIs</span></a></span><span> </span><span id="local-6989586621682732862"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732862"><span class="hs-identifier hs-var">max</span></a></span></span><span> </span><span class="annot"><span class="annottext">Bag (Id, Int)
</span><span class="hs-identifier">_</span></span><span>        </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-508"></span><span>                          </span><span class="hs-comment">-- Size of biggest alternative</span><span>
</span><span id="line-509"></span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Bag (Id, Int) -&gt; Int -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#SizeIs"><span class="hs-identifier hs-var">SizeIs</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732859"><span class="hs-identifier hs-var">tot</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Id, Int) -&gt; Bag (Id, Int)
forall a. a -&gt; Bag a
</span><a href="GHC.Data.Bag.html#unitBag"><span class="hs-identifier hs-var">unitBag</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732854"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">20</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732859"><span class="hs-identifier hs-var">tot</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732862"><span class="hs-identifier hs-var">max</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-510"></span><span>                      </span><span class="annot"><span class="annottext">Bag (Id, Int) -&gt; Bag (Id, Int) -&gt; Bag (Id, Int)
forall a. Bag a -&gt; Bag a -&gt; Bag a
</span><a href="GHC.Data.Bag.html#unionBags"><span class="hs-operator hs-var">`unionBags`</span></a></span><span> </span><span class="annot"><span class="annottext">Bag (Id, Int)
</span><a href="#local-6989586621682732860"><span class="hs-identifier hs-var">tot_disc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732861"><span class="hs-identifier hs-var">tot_scrut</span></a></span><span>
</span><span id="line-511"></span><span>                          </span><span class="hs-comment">-- If the variable is known, we produce a</span><span>
</span><span id="line-512"></span><span>                          </span><span class="hs-comment">-- discount that will take us back to 'max',</span><span>
</span><span id="line-513"></span><span>                          </span><span class="hs-comment">-- the size of the largest alternative The</span><span>
</span><span id="line-514"></span><span>                          </span><span class="hs-comment">-- 1+ is a little discount for reduced</span><span>
</span><span id="line-515"></span><span>                          </span><span class="hs-comment">-- allocation in the caller</span><span>
</span><span id="line-516"></span><span>                          </span><span class="hs-comment">--</span><span>
</span><span id="line-517"></span><span>                          </span><span class="hs-comment">-- Notice though, that we return tot_disc,</span><span>
</span><span id="line-518"></span><span>                          </span><span class="hs-comment">-- the total discount from all branches.  I</span><span>
</span><span id="line-519"></span><span>                          </span><span class="hs-comment">-- think that's right.</span><span>
</span><span id="line-520"></span><span>
</span><span id="line-521"></span><span>            </span><span class="annot"><a href="#local-6989586621682732858"><span class="hs-identifier hs-var">alts_size</span></a></span><span> </span><span id="local-6989586621682732865"><span class="annot"><span class="annottext">ExprSize
</span><a href="#local-6989586621682732865"><span class="hs-identifier hs-var">tot_size</span></a></span></span><span> </span><span class="annot"><span class="annottext">ExprSize
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExprSize
</span><a href="#local-6989586621682732865"><span class="hs-identifier hs-var">tot_size</span></a></span><span>
</span><span id="line-522"></span><span>          </span><span class="hs-keyword">in</span><span>
</span><span id="line-523"></span><span>          </span><span class="annot"><span class="annottext">ExprSize -&gt; ExprSize -&gt; ExprSize
</span><a href="#local-6989586621682732858"><span class="hs-identifier hs-var">alts_size</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ExprSize -&gt; ExprSize -&gt; ExprSize) -&gt; [ExprSize] -&gt; ExprSize
forall a. (a -&gt; a -&gt; a) -&gt; [a] -&gt; a
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; a -&gt; a) -&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">foldr1</span></span><span> </span><span class="annot"><span class="annottext">ExprSize -&gt; ExprSize -&gt; ExprSize
</span><a href="#local-6989586621682732867"><span class="hs-identifier hs-var">addAltSize</span></a></span><span> </span><span class="annot"><span class="annottext">[ExprSize]
</span><a href="#local-6989586621682732856"><span class="hs-identifier hs-var">alt_sizes</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- alts is non-empty</span><span>
</span><span id="line-524"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ExprSize -&gt; ExprSize -&gt; ExprSize) -&gt; [ExprSize] -&gt; ExprSize
forall a. (a -&gt; a -&gt; a) -&gt; [a] -&gt; a
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; a -&gt; a) -&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">foldr1</span></span><span> </span><span class="annot"><span class="annottext">ExprSize -&gt; ExprSize -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#maxSize"><span class="hs-identifier hs-var">maxSize</span></a></span><span>    </span><span class="annot"><span class="annottext">[ExprSize]
</span><a href="#local-6989586621682732856"><span class="hs-identifier hs-var">alt_sizes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-525"></span><span>                </span><span class="hs-comment">-- Good to inline if an arg is scrutinised, because</span><span>
</span><span id="line-526"></span><span>                </span><span class="hs-comment">-- that may eliminate allocation in the caller</span><span>
</span><span id="line-527"></span><span>                </span><span class="hs-comment">-- And it eliminates the case itself</span><span>
</span><span id="line-528"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-529"></span><span>          </span><span id="local-6989586621682732855"><span class="annot"><span class="annottext">is_top_arg :: CoreExpr -&gt; Maybe Id
</span><a href="#local-6989586621682732855"><span class="hs-identifier hs-var hs-var">is_top_arg</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682732869"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732869"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732869"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; [Id] -&gt; Bool
forall a. Eq a =&gt; a -&gt; [a] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682732813"><span class="hs-identifier hs-var">top_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Maybe Id
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732869"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-530"></span><span>          </span><span class="annot"><a href="#local-6989586621682732855"><span class="hs-identifier hs-var">is_top_arg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682732871"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732871"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Maybe Id
</span><a href="#local-6989586621682732855"><span class="hs-identifier hs-var">is_top_arg</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732871"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-531"></span><span>          </span><span class="annot"><a href="#local-6989586621682732855"><span class="hs-identifier hs-var">is_top_arg</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Id
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-532"></span><span>
</span><span id="line-533"></span><span>
</span><span id="line-534"></span><span>    </span><span class="annot"><a href="#local-6989586621682732815"><span class="hs-identifier hs-var">size_up</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span id="local-6989586621682732872"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732872"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">Id
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682732873"><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621682732873"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; ExprSize
</span><a href="#local-6989586621682732815"><span class="hs-identifier hs-var">size_up</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732872"><span class="hs-identifier hs-var">e</span></a></span><span>  </span><span class="annot"><span class="annottext">ExprSize -&gt; ExprSize -&gt; ExprSize
</span><a href="#local-6989586621682732829"><span class="hs-operator hs-var">`addSizeNSD`</span></a></span><span>
</span><span id="line-535"></span><span>                                </span><span class="annot"><span class="annottext">(Alt Id -&gt; ExprSize -&gt; ExprSize)
-&gt; ExprSize -&gt; [Alt Id] -&gt; ExprSize
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExprSize -&gt; ExprSize -&gt; ExprSize
</span><a href="#local-6989586621682732867"><span class="hs-identifier hs-var">addAltSize</span></a></span><span> </span><span class="annot"><span class="annottext">(ExprSize -&gt; ExprSize -&gt; ExprSize)
-&gt; (Alt Id -&gt; ExprSize) -&gt; Alt Id -&gt; ExprSize -&gt; ExprSize
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Alt Id -&gt; ExprSize
</span><a href="#local-6989586621682732857"><span class="hs-identifier hs-var">size_up_alt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ExprSize
</span><a href="#local-6989586621682732874"><span class="hs-identifier hs-var">case_size</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621682732873"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-536"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-537"></span><span>          </span><span id="local-6989586621682732874"><span class="annot"><span class="annottext">case_size :: ExprSize
</span><a href="#local-6989586621682732874"><span class="hs-identifier hs-var hs-var">case_size</span></a></span></span><span>
</span><span id="line-538"></span><span>           </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
forall b. Expr b -&gt; Bool
</span><a href="#local-6989586621682732875"><span class="hs-identifier hs-var">is_inline_scrut</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732872"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Alt Id] -&gt; Int -&gt; Bool
forall a. [a] -&gt; Int -&gt; Bool
</span><a href="GHC.Utils.Misc.html#lengthAtMost"><span class="hs-identifier hs-var">lengthAtMost</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621682732873"><span class="hs-identifier hs-var">alts</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#sizeN"><span class="hs-identifier hs-var">sizeN</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">10</span></span><span class="hs-special">)</span><span>
</span><span id="line-539"></span><span>           </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExprSize
</span><a href="GHC.Core.Unfold.html#sizeZero"><span class="hs-identifier hs-var">sizeZero</span></a></span><span>
</span><span id="line-540"></span><span>                </span><span class="hs-comment">-- Normally we don't charge for the case itself, but</span><span>
</span><span id="line-541"></span><span>                </span><span class="hs-comment">-- we charge one per alternative (see size_up_alt,</span><span>
</span><span id="line-542"></span><span>                </span><span class="hs-comment">-- below) to account for the cost of the info table</span><span>
</span><span id="line-543"></span><span>                </span><span class="hs-comment">-- and comparisons.</span><span>
</span><span id="line-544"></span><span>                </span><span class="hs-comment">--</span><span>
</span><span id="line-545"></span><span>                </span><span class="hs-comment">-- However, in certain cases (see is_inline_scrut</span><span>
</span><span id="line-546"></span><span>                </span><span class="hs-comment">-- below), no code is generated for the case unless</span><span>
</span><span id="line-547"></span><span>                </span><span class="hs-comment">-- there are multiple alts.  In these cases we</span><span>
</span><span id="line-548"></span><span>                </span><span class="hs-comment">-- subtract one, making the first alt free.</span><span>
</span><span id="line-549"></span><span>                </span><span class="hs-comment">-- e.g. case x# +# y# of _ -&gt; ...   should cost 1</span><span>
</span><span id="line-550"></span><span>                </span><span class="hs-comment">--      case touch# x# of _ -&gt; ...  should cost 0</span><span>
</span><span id="line-551"></span><span>                </span><span class="hs-comment">-- (see #4978)</span><span>
</span><span id="line-552"></span><span>                </span><span class="hs-comment">--</span><span>
</span><span id="line-553"></span><span>                </span><span class="hs-comment">-- I would like to not have the &quot;lengthAtMost alts 1&quot;</span><span>
</span><span id="line-554"></span><span>                </span><span class="hs-comment">-- condition above, but without that some programs got worse</span><span>
</span><span id="line-555"></span><span>                </span><span class="hs-comment">-- (spectral/hartel/event and spectral/para).  I don't fully</span><span>
</span><span id="line-556"></span><span>                </span><span class="hs-comment">-- understand why. (SDM 24/5/11)</span><span>
</span><span id="line-557"></span><span>
</span><span id="line-558"></span><span>                </span><span class="hs-comment">-- unboxed variables, inline primops and unsafe foreign calls</span><span>
</span><span id="line-559"></span><span>                </span><span class="hs-comment">-- are all &quot;inline&quot; things:</span><span>
</span><span id="line-560"></span><span>          </span><span id="local-6989586621682732875"><span class="annot"><span class="annottext">is_inline_scrut :: Expr b -&gt; Bool
</span><a href="#local-6989586621682732875"><span class="hs-identifier hs-var hs-var">is_inline_scrut</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682732878"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732878"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-561"></span><span>            </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Bool
Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isUnliftedType"><span class="hs-identifier hs-var">isUnliftedType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732878"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-562"></span><span>              </span><span class="hs-comment">-- isUnliftedType is OK here: scrutinees have a fixed RuntimeRep (search for FRRCase)</span><span>
</span><span id="line-563"></span><span>          </span><span class="annot"><a href="#local-6989586621682732875"><span class="hs-identifier hs-var">is_inline_scrut</span></a></span><span> </span><span id="local-6989586621682732880"><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621682732880"><span class="hs-identifier hs-var">scrut</span></a></span></span><span>
</span><span id="line-564"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682732881"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732881"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Expr b]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr b -&gt; (Expr b, [Expr b])
forall b. Expr b -&gt; (Expr b, [Expr b])
</span><a href="GHC.Core.html#collectArgs"><span class="hs-identifier hs-var">collectArgs</span></a></span><span> </span><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621682732880"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-565"></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Id -&gt; IdDetails
</span><a href="GHC.Types.Var.html#idDetails"><span class="hs-identifier hs-var">idDetails</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732881"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-566"></span><span>                    </span><span class="annot"><a href="GHC.Types.Id.Info.html#FCallId"><span class="hs-identifier hs-type">FCallId</span></a></span><span> </span><span id="local-6989586621682732884"><span class="annot"><span class="annottext">ForeignCall
</span><a href="#local-6989586621682732884"><span class="hs-identifier hs-var">fc</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ForeignCall -&gt; Bool
</span><a href="GHC.Types.ForeignCall.html#isSafeForeignCall"><span class="hs-identifier hs-var">isSafeForeignCall</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignCall
</span><a href="#local-6989586621682732884"><span class="hs-identifier hs-var">fc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-567"></span><span>                    </span><span class="annot"><a href="GHC.Types.Id.Info.html#PrimOpId"><span class="hs-identifier hs-type">PrimOpId</span></a></span><span> </span><span id="local-6989586621682732887"><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621682732887"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="annot"><span class="annottext">ConcreteTyVars
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimOp -&gt; Bool
</span><a href="GHC.Builtin.PrimOps.html#primOpOutOfLine"><span class="hs-identifier hs-var">primOpOutOfLine</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621682732887"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-568"></span><span>                    </span><span id="local-6989586621682732889"><span class="annot"><span class="annottext">IdDetails
</span><a href="#local-6989586621682732889"><span class="hs-identifier hs-var">_other</span></a></span></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-569"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-570"></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-571"></span><span>
</span><span id="line-572"></span><span>    </span><span id="local-6989586621682732841"><span class="annot"><span class="annottext">size_up_rhs :: (Id, CoreExpr) -&gt; ExprSize
</span><a href="#local-6989586621682732841"><span class="hs-identifier hs-var hs-var">size_up_rhs</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682732890"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732890"><span class="hs-identifier hs-var">bndr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682732891"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732891"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-573"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#JoinPoint"><span class="hs-identifier hs-type">JoinPoint</span></a></span><span> </span><span id="local-6989586621682732893"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732893"><span class="hs-identifier hs-var">join_arity</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Id -&gt; JoinPointHood
</span><a href="GHC.Types.Id.html#idJoinPointHood"><span class="hs-identifier hs-var">idJoinPointHood</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732890"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-574"></span><span>        </span><span class="hs-comment">-- Skip arguments to join point</span><span>
</span><span id="line-575"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682732895"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682732895"><span class="hs-identifier hs-var">_bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682732896"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732896"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CoreExpr -&gt; ([Id], CoreExpr)
forall b. Int -&gt; Expr b -&gt; ([b], Expr b)
</span><a href="GHC.Core.html#collectNBinders"><span class="hs-identifier hs-var">collectNBinders</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732893"><span class="hs-identifier hs-var">join_arity</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732891"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-576"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; ExprSize
</span><a href="#local-6989586621682732815"><span class="hs-identifier hs-var">size_up</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732896"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-577"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-578"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; ExprSize
</span><a href="#local-6989586621682732815"><span class="hs-identifier hs-var">size_up</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732891"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-579"></span><span>
</span><span id="line-580"></span><span>    </span><span class="hs-comment">------------</span><span>
</span><span id="line-581"></span><span>    </span><span class="hs-comment">-- size_up_app is used when there's ONE OR MORE value args</span><span>
</span><span id="line-582"></span><span>    </span><span id="local-6989586621682732830"><span class="annot"><span class="annottext">size_up_app :: CoreExpr -&gt; [CoreExpr] -&gt; Int -&gt; ExprSize
</span><a href="#local-6989586621682732830"><span class="hs-identifier hs-var hs-var">size_up_app</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621682732898"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732898"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621682732899"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732899"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682732900"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682732900"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621682732901"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732901"><span class="hs-identifier hs-var">voids</span></a></span></span><span>
</span><span id="line-583"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
forall b. Expr b -&gt; Bool
</span><a href="GHC.Core.html#isTyCoArg"><span class="hs-identifier hs-var">isTyCoArg</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732899"><span class="hs-identifier hs-var">arg</span></a></span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; Int -&gt; ExprSize
</span><a href="#local-6989586621682732830"><span class="hs-identifier hs-var">size_up_app</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732898"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682732900"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732901"><span class="hs-identifier hs-var">voids</span></a></span><span>
</span><span id="line-584"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
forall b. Expr b -&gt; Bool
</span><a href="#local-6989586621682732831"><span class="hs-identifier hs-var">isZeroBitExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732899"><span class="hs-identifier hs-var">arg</span></a></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; Int -&gt; ExprSize
</span><a href="#local-6989586621682732830"><span class="hs-identifier hs-var">size_up_app</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732898"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732899"><span class="hs-identifier hs-var">arg</span></a></span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; [CoreExpr]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682732900"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732901"><span class="hs-identifier hs-var">voids</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-585"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; ExprSize
</span><a href="#local-6989586621682732815"><span class="hs-identifier hs-var">size_up</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732899"><span class="hs-identifier hs-var">arg</span></a></span><span>  </span><span class="annot"><span class="annottext">ExprSize -&gt; ExprSize -&gt; ExprSize
</span><a href="#local-6989586621682732829"><span class="hs-operator hs-var">`addSizeNSD`</span></a></span><span>
</span><span id="line-586"></span><span>                                           </span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; Int -&gt; ExprSize
</span><a href="#local-6989586621682732830"><span class="hs-identifier hs-var">size_up_app</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732898"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732899"><span class="hs-identifier hs-var">arg</span></a></span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; [CoreExpr]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682732900"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732901"><span class="hs-identifier hs-var">voids</span></a></span><span>
</span><span id="line-587"></span><span>    </span><span class="annot"><a href="#local-6989586621682732830"><span class="hs-identifier hs-var">size_up_app</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682732902"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732902"><span class="hs-identifier hs-var">fun</span></a></span></span><span class="hs-special">)</span><span>     </span><span id="local-6989586621682732903"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682732903"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621682732904"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732904"><span class="hs-identifier hs-var">voids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; [CoreExpr] -&gt; Int -&gt; ExprSize
</span><a href="#local-6989586621682732825"><span class="hs-identifier hs-var">size_up_call</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732902"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682732903"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732904"><span class="hs-identifier hs-var">voids</span></a></span><span>
</span><span id="line-588"></span><span>    </span><span class="annot"><a href="#local-6989586621682732830"><span class="hs-identifier hs-var">size_up_app</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682732905"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732905"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682732906"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682732906"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621682732907"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732907"><span class="hs-identifier hs-var">voids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; Int -&gt; ExprSize
</span><a href="#local-6989586621682732830"><span class="hs-identifier hs-var">size_up_app</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732905"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682732906"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732907"><span class="hs-identifier hs-var">voids</span></a></span><span>
</span><span id="line-589"></span><span>    </span><span class="annot"><a href="#local-6989586621682732830"><span class="hs-identifier hs-var">size_up_app</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682732908"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732908"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682732909"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682732909"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621682732910"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732910"><span class="hs-identifier hs-var">voids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; Int -&gt; ExprSize
</span><a href="#local-6989586621682732830"><span class="hs-identifier hs-var">size_up_app</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732908"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682732909"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732910"><span class="hs-identifier hs-var">voids</span></a></span><span>
</span><span id="line-590"></span><span>    </span><span class="annot"><a href="#local-6989586621682732830"><span class="hs-identifier hs-var">size_up_app</span></a></span><span> </span><span id="local-6989586621682732911"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732911"><span class="hs-identifier hs-var">other</span></a></span></span><span>         </span><span id="local-6989586621682732912"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682732912"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621682732913"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732913"><span class="hs-identifier hs-var">voids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; ExprSize
</span><a href="#local-6989586621682732815"><span class="hs-identifier hs-var">size_up</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732911"><span class="hs-identifier hs-var">other</span></a></span><span> </span><span class="annot"><span class="annottext">ExprSize -&gt; Int -&gt; ExprSize
</span><a href="#local-6989586621682732835"><span class="hs-operator hs-var">`addSizeN`</span></a></span><span>
</span><span id="line-591"></span><span>                                           </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
</span><a href="GHC.Core.Unfold.html#callSize"><span class="hs-identifier hs-var">callSize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreExpr] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682732912"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732913"><span class="hs-identifier hs-var">voids</span></a></span><span>
</span><span id="line-592"></span><span>       </span><span class="hs-comment">-- if the lhs is not an App or a Var, or an invisible thing like a</span><span>
</span><span id="line-593"></span><span>       </span><span class="hs-comment">-- Tick or Cast, then we should charge for a complete call plus the</span><span>
</span><span id="line-594"></span><span>       </span><span class="hs-comment">-- size of the lhs itself.</span><span>
</span><span id="line-595"></span><span>
</span><span id="line-596"></span><span>    </span><span class="hs-comment">------------</span><span>
</span><span id="line-597"></span><span>    </span><span class="annot"><a href="#local-6989586621682732825"><span class="hs-identifier hs-type">size_up_call</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#ExprSize"><span class="hs-identifier hs-type">ExprSize</span></a></span><span>
</span><span id="line-598"></span><span>    </span><span id="local-6989586621682732825"><span class="annot"><span class="annottext">size_up_call :: Id -&gt; [CoreExpr] -&gt; Int -&gt; ExprSize
</span><a href="#local-6989586621682732825"><span class="hs-identifier hs-var hs-var">size_up_call</span></a></span></span><span> </span><span id="local-6989586621682732915"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732915"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621682732916"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682732916"><span class="hs-identifier hs-var">val_args</span></a></span></span><span> </span><span id="local-6989586621682732917"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732917"><span class="hs-identifier hs-var">voids</span></a></span></span><span>
</span><span id="line-599"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Id -&gt; IdDetails
</span><a href="GHC.Types.Var.html#idDetails"><span class="hs-identifier hs-var">idDetails</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732915"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-600"></span><span>           </span><span class="annot"><a href="GHC.Types.Id.Info.html#FCallId"><span class="hs-identifier hs-type">FCallId</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignCall
</span><span class="hs-identifier">_</span></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#sizeN"><span class="hs-identifier hs-var">sizeN</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
</span><a href="GHC.Core.Unfold.html#callSize"><span class="hs-identifier hs-var">callSize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreExpr] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682732916"><span class="hs-identifier hs-var">val_args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732917"><span class="hs-identifier hs-var">voids</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-601"></span><span>           </span><span class="annot"><a href="GHC.Types.Id.Info.html#DataConWorkId"><span class="hs-identifier hs-type">DataConWorkId</span></a></span><span> </span><span id="local-6989586621682732919"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682732919"><span class="hs-identifier hs-var">dc</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; Int -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#conSize"><span class="hs-identifier hs-var">conSize</span></a></span><span>    </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682732919"><span class="hs-identifier hs-var">dc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreExpr] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682732916"><span class="hs-identifier hs-var">val_args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-602"></span><span>           </span><span class="annot"><a href="GHC.Types.Id.Info.html#PrimOpId"><span class="hs-identifier hs-type">PrimOpId</span></a></span><span> </span><span id="local-6989586621682732921"><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621682732921"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="annot"><span class="annottext">ConcreteTyVars
</span><span class="hs-identifier">_</span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; Int -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#primOpSize"><span class="hs-identifier hs-var">primOpSize</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621682732921"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreExpr] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682732916"><span class="hs-identifier hs-var">val_args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-603"></span><span>           </span><span class="annot"><a href="GHC.Types.Id.Info.html#ClassOpId"><span class="hs-identifier hs-type">ClassOpId</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts -&gt; [Id] -&gt; [CoreExpr] -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#classOpSize"><span class="hs-identifier hs-var">classOpSize</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682732811"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682732813"><span class="hs-identifier hs-var">top_args</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682732916"><span class="hs-identifier hs-var">val_args</span></a></span><span>
</span><span id="line-604"></span><span>           </span><span class="annot"><span class="annottext">IdDetails
</span><span class="hs-identifier">_</span></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts -&gt; [Id] -&gt; Id -&gt; Int -&gt; Int -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#funSize"><span class="hs-identifier hs-var">funSize</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682732811"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682732813"><span class="hs-identifier hs-var">top_args</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732915"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreExpr] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682732916"><span class="hs-identifier hs-var">val_args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732917"><span class="hs-identifier hs-var">voids</span></a></span><span>
</span><span id="line-605"></span><span>
</span><span id="line-606"></span><span>    </span><span class="hs-comment">------------</span><span>
</span><span id="line-607"></span><span>    </span><span id="local-6989586621682732857"><span class="annot"><span class="annottext">size_up_alt :: Alt Id -&gt; ExprSize
</span><a href="#local-6989586621682732857"><span class="hs-identifier hs-var hs-var">size_up_alt</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span id="local-6989586621682732927"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682732927"><span class="hs-identifier hs-var">_con</span></a></span></span><span> </span><span id="local-6989586621682732928"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682732928"><span class="hs-identifier hs-var">_bndrs</span></a></span></span><span> </span><span id="local-6989586621682732929"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732929"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; ExprSize
</span><a href="#local-6989586621682732815"><span class="hs-identifier hs-var">size_up</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732929"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">ExprSize -&gt; Int -&gt; ExprSize
</span><a href="#local-6989586621682732835"><span class="hs-operator hs-var">`addSizeN`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">10</span></span><span>
</span><span id="line-608"></span><span>        </span><span class="hs-comment">-- Don't charge for args, so that wrappers look cheap</span><span>
</span><span id="line-609"></span><span>        </span><span class="hs-comment">-- (See comments about wrappers with Case)</span><span>
</span><span id="line-610"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-611"></span><span>        </span><span class="hs-comment">-- IMPORTANT: *do* charge 1 for the alternative, else we</span><span>
</span><span id="line-612"></span><span>        </span><span class="hs-comment">-- find that giant case nests are treated as practically free</span><span>
</span><span id="line-613"></span><span>        </span><span class="hs-comment">-- A good example is Foreign.C.Error.errnoToIOError</span><span>
</span><span id="line-614"></span><span>
</span><span id="line-615"></span><span>    </span><span class="hs-comment">------------</span><span>
</span><span id="line-616"></span><span>    </span><span class="hs-comment">-- Cost to allocate binding with given binder</span><span>
</span><span id="line-617"></span><span>    </span><span id="local-6989586621682732842"><span class="annot"><span class="annottext">size_up_alloc :: Id -&gt; a
</span><a href="#local-6989586621682732842"><span class="hs-identifier hs-var hs-var">size_up_alloc</span></a></span></span><span> </span><span id="local-6989586621682732933"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732933"><span class="hs-identifier hs-var">bndr</span></a></span></span><span>
</span><span id="line-618"></span><span>      </span><span class="hs-glyph">|</span><span>  </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732933"><span class="hs-identifier hs-var">bndr</span></a></span><span>                    </span><span class="hs-comment">-- Doesn't exist at runtime</span><span>
</span><span id="line-619"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732933"><span class="hs-identifier hs-var">bndr</span></a></span><span>                   </span><span class="hs-comment">-- Not allocated at all</span><span>
</span><span id="line-620"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isBoxedType"><span class="hs-identifier hs-var">isBoxedType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732933"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Doesn't live in heap</span><span>
</span><span id="line-621"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">0</span></span><span>
</span><span id="line-622"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-623"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">10</span></span><span>
</span><span id="line-624"></span><span>
</span><span id="line-625"></span><span>    </span><span class="hs-comment">------------</span><span>
</span><span id="line-626"></span><span>        </span><span class="hs-comment">-- These addSize things have to be here because</span><span>
</span><span id="line-627"></span><span>        </span><span class="hs-comment">-- I don't want to give them bOMB_OUT_SIZE as an argument</span><span>
</span><span id="line-628"></span><span>    </span><span id="local-6989586621682732835"><span class="annot"><span class="annottext">addSizeN :: ExprSize -&gt; Int -&gt; ExprSize
</span><a href="#local-6989586621682732835"><span class="hs-identifier hs-var hs-var">addSizeN</span></a></span></span><span> </span><span class="annot"><span class="annottext">ExprSize
</span><a href="GHC.Core.Unfold.html#TooBig"><span class="hs-identifier hs-var">TooBig</span></a></span><span>          </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExprSize
</span><a href="GHC.Core.Unfold.html#TooBig"><span class="hs-identifier hs-var">TooBig</span></a></span><span>
</span><span id="line-629"></span><span>    </span><span class="annot"><a href="#local-6989586621682732835"><span class="hs-identifier hs-var">addSizeN</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Unfold.html#SizeIs"><span class="hs-identifier hs-type">SizeIs</span></a></span><span> </span><span id="local-6989586621682732937"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732937"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621682732938"><span class="annot"><span class="annottext">Bag (Id, Int)
</span><a href="#local-6989586621682732938"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span id="local-6989586621682732939"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732939"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682732940"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732940"><span class="hs-identifier hs-var">m</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bag (Id, Int) -&gt; Int -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#mkSizeIs"><span class="hs-identifier hs-var">mkSizeIs</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732812"><span class="hs-identifier hs-var">bOMB_OUT_SIZE</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732937"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732940"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bag (Id, Int)
</span><a href="#local-6989586621682732938"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732939"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-630"></span><span>
</span><span id="line-631"></span><span>        </span><span class="hs-comment">-- addAltSize is used to add the sizes of case alternatives</span><span>
</span><span id="line-632"></span><span>    </span><span id="local-6989586621682732867"><span class="annot"><span class="annottext">addAltSize :: ExprSize -&gt; ExprSize -&gt; ExprSize
</span><a href="#local-6989586621682732867"><span class="hs-identifier hs-var hs-var">addAltSize</span></a></span></span><span> </span><span class="annot"><span class="annottext">ExprSize
</span><a href="GHC.Core.Unfold.html#TooBig"><span class="hs-identifier hs-var">TooBig</span></a></span><span>            </span><span class="annot"><span class="annottext">ExprSize
</span><span class="hs-identifier">_</span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExprSize
</span><a href="GHC.Core.Unfold.html#TooBig"><span class="hs-identifier hs-var">TooBig</span></a></span><span>
</span><span id="line-633"></span><span>    </span><span class="annot"><a href="#local-6989586621682732867"><span class="hs-identifier hs-var">addAltSize</span></a></span><span> </span><span class="annot"><span class="annottext">ExprSize
</span><span class="hs-identifier">_</span></span><span>                 </span><span class="annot"><span class="annottext">ExprSize
</span><a href="GHC.Core.Unfold.html#TooBig"><span class="hs-identifier hs-var">TooBig</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExprSize
</span><a href="GHC.Core.Unfold.html#TooBig"><span class="hs-identifier hs-var">TooBig</span></a></span><span>
</span><span id="line-634"></span><span>    </span><span class="annot"><a href="#local-6989586621682732867"><span class="hs-identifier hs-var">addAltSize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Unfold.html#SizeIs"><span class="hs-identifier hs-type">SizeIs</span></a></span><span> </span><span id="local-6989586621682732942"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732942"><span class="hs-identifier hs-var">n1</span></a></span></span><span> </span><span id="local-6989586621682732943"><span class="annot"><span class="annottext">Bag (Id, Int)
</span><a href="#local-6989586621682732943"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span id="local-6989586621682732944"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732944"><span class="hs-identifier hs-var">d1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Unfold.html#SizeIs"><span class="hs-identifier hs-type">SizeIs</span></a></span><span> </span><span id="local-6989586621682732945"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732945"><span class="hs-identifier hs-var">n2</span></a></span></span><span> </span><span id="local-6989586621682732946"><span class="annot"><span class="annottext">Bag (Id, Int)
</span><a href="#local-6989586621682732946"><span class="hs-identifier hs-var">ys</span></a></span></span><span> </span><span id="local-6989586621682732947"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732947"><span class="hs-identifier hs-var">d2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-635"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bag (Id, Int) -&gt; Int -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#mkSizeIs"><span class="hs-identifier hs-var">mkSizeIs</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732812"><span class="hs-identifier hs-var">bOMB_OUT_SIZE</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732942"><span class="hs-identifier hs-var">n1</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732945"><span class="hs-identifier hs-var">n2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-636"></span><span>                                 </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bag (Id, Int)
</span><a href="#local-6989586621682732943"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">Bag (Id, Int) -&gt; Bag (Id, Int) -&gt; Bag (Id, Int)
forall a. Bag a -&gt; Bag a -&gt; Bag a
</span><a href="GHC.Data.Bag.html#unionBags"><span class="hs-operator hs-var">`unionBags`</span></a></span><span> </span><span class="annot"><span class="annottext">Bag (Id, Int)
</span><a href="#local-6989586621682732946"><span class="hs-identifier hs-var">ys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-637"></span><span>                                 </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732944"><span class="hs-identifier hs-var">d1</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732947"><span class="hs-identifier hs-var">d2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Note [addAltSize result discounts]</span><span>
</span><span id="line-638"></span><span>
</span><span id="line-639"></span><span>        </span><span class="hs-comment">-- This variant ignores the result discount from its LEFT argument</span><span>
</span><span id="line-640"></span><span>        </span><span class="hs-comment">-- It's used when the second argument isn't part of the result</span><span>
</span><span id="line-641"></span><span>    </span><span id="local-6989586621682732829"><span class="annot"><span class="annottext">addSizeNSD :: ExprSize -&gt; ExprSize -&gt; ExprSize
</span><a href="#local-6989586621682732829"><span class="hs-identifier hs-var hs-var">addSizeNSD</span></a></span></span><span> </span><span class="annot"><span class="annottext">ExprSize
</span><a href="GHC.Core.Unfold.html#TooBig"><span class="hs-identifier hs-var">TooBig</span></a></span><span>            </span><span class="annot"><span class="annottext">ExprSize
</span><span class="hs-identifier">_</span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExprSize
</span><a href="GHC.Core.Unfold.html#TooBig"><span class="hs-identifier hs-var">TooBig</span></a></span><span>
</span><span id="line-642"></span><span>    </span><span class="annot"><a href="#local-6989586621682732829"><span class="hs-identifier hs-var">addSizeNSD</span></a></span><span> </span><span class="annot"><span class="annottext">ExprSize
</span><span class="hs-identifier">_</span></span><span>                 </span><span class="annot"><span class="annottext">ExprSize
</span><a href="GHC.Core.Unfold.html#TooBig"><span class="hs-identifier hs-var">TooBig</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExprSize
</span><a href="GHC.Core.Unfold.html#TooBig"><span class="hs-identifier hs-var">TooBig</span></a></span><span>
</span><span id="line-643"></span><span>    </span><span class="annot"><a href="#local-6989586621682732829"><span class="hs-identifier hs-var">addSizeNSD</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Unfold.html#SizeIs"><span class="hs-identifier hs-type">SizeIs</span></a></span><span> </span><span id="local-6989586621682732948"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732948"><span class="hs-identifier hs-var">n1</span></a></span></span><span> </span><span id="local-6989586621682732949"><span class="annot"><span class="annottext">Bag (Id, Int)
</span><a href="#local-6989586621682732949"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Unfold.html#SizeIs"><span class="hs-identifier hs-type">SizeIs</span></a></span><span> </span><span id="local-6989586621682732950"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732950"><span class="hs-identifier hs-var">n2</span></a></span></span><span> </span><span id="local-6989586621682732951"><span class="annot"><span class="annottext">Bag (Id, Int)
</span><a href="#local-6989586621682732951"><span class="hs-identifier hs-var">ys</span></a></span></span><span> </span><span id="local-6989586621682732952"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732952"><span class="hs-identifier hs-var">d2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-644"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bag (Id, Int) -&gt; Int -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#mkSizeIs"><span class="hs-identifier hs-var">mkSizeIs</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732812"><span class="hs-identifier hs-var">bOMB_OUT_SIZE</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732948"><span class="hs-identifier hs-var">n1</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732950"><span class="hs-identifier hs-var">n2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-645"></span><span>                                 </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bag (Id, Int)
</span><a href="#local-6989586621682732949"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">Bag (Id, Int) -&gt; Bag (Id, Int) -&gt; Bag (Id, Int)
forall a. Bag a -&gt; Bag a -&gt; Bag a
</span><a href="GHC.Data.Bag.html#unionBags"><span class="hs-operator hs-var">`unionBags`</span></a></span><span> </span><span class="annot"><span class="annottext">Bag (Id, Int)
</span><a href="#local-6989586621682732951"><span class="hs-identifier hs-var">ys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-646"></span><span>                                 </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732952"><span class="hs-identifier hs-var">d2</span></a></span><span>  </span><span class="hs-comment">-- Ignore d1</span><span>
</span><span id="line-647"></span><span>
</span><span id="line-648"></span><span>    </span><span class="hs-comment">-- don't count expressions such as State# RealWorld</span><span>
</span><span id="line-649"></span><span>    </span><span class="hs-comment">-- exclude join points, because they can be rep-polymorphic</span><span>
</span><span id="line-650"></span><span>    </span><span class="hs-comment">-- and typePrimRep will crash</span><span>
</span><span id="line-651"></span><span>    </span><span id="local-6989586621682732824"><span class="annot"><span class="annottext">isZeroBitId :: Id -&gt; Bool
</span><a href="#local-6989586621682732824"><span class="hs-identifier hs-var hs-var">isZeroBitId</span></a></span></span><span> </span><span id="local-6989586621682732954"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732954"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732954"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Bool
Type -&gt; Bool
</span><a href="GHC.Types.RepType.html#isZeroBitTy"><span class="hs-identifier hs-var">isZeroBitTy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732954"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-652"></span><span>
</span><span id="line-653"></span><span>    </span><span id="local-6989586621682732831"><span class="annot"><span class="annottext">isZeroBitExpr :: Expr b -&gt; Bool
</span><a href="#local-6989586621682732831"><span class="hs-identifier hs-var hs-var">isZeroBitExpr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682732955"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732955"><span class="hs-identifier hs-var">id</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="#local-6989586621682732824"><span class="hs-identifier hs-var">isZeroBitId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732955"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-654"></span><span>    </span><span class="annot"><a href="#local-6989586621682732831"><span class="hs-identifier hs-var">isZeroBitExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682732956"><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621682732956"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr b -&gt; Bool
</span><a href="#local-6989586621682732831"><span class="hs-identifier hs-var">isZeroBitExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621682732956"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-655"></span><span>    </span><span class="annot"><a href="#local-6989586621682732831"><span class="hs-identifier hs-var">isZeroBitExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr b
</span><span class="hs-identifier">_</span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-656"></span><span>
</span><span id="line-657"></span><span class="annot"><span class="hs-comment">-- | Finds a nominal size of a string literal.</span></span><span>
</span><span id="line-658"></span><span class="annot"><a href="GHC.Core.Unfold.html#litSize"><span class="hs-identifier hs-type">litSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Literal.html#Literal"><span class="hs-identifier hs-type">Literal</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-659"></span><span class="hs-comment">-- Used by GHC.Core.Unfold.sizeExpr</span><span>
</span><span id="line-660"></span><span id="litSize"><span class="annot"><span class="annottext">litSize :: Literal -&gt; Int
</span><a href="GHC.Core.Unfold.html#litSize"><span class="hs-identifier hs-var hs-var">litSize</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Literal.html#LitNumber"><span class="hs-identifier hs-type">LitNumber</span></a></span><span> </span><span class="annot"><span class="annottext">LitNumType
</span><a href="GHC.Types.Literal.html#LitNumBigNat"><span class="hs-identifier hs-var">LitNumBigNat</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">100</span></span><span>
</span><span id="line-661"></span><span class="annot"><a href="GHC.Core.Unfold.html#litSize"><span class="hs-identifier hs-var">litSize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Literal.html#LitString"><span class="hs-identifier hs-type">LitString</span></a></span><span> </span><span id="local-6989586621682732960"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621682732960"><span class="hs-identifier hs-var">str</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">10</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">10</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><a href="../../bytestring-0.12.2.0-7dd0/src/Data.ByteString.html#length"><span class="hs-identifier hs-var">BS.length</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621682732960"><span class="hs-identifier hs-var">str</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">3</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`div`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">4</span></span><span class="hs-special">)</span><span>
</span><span id="line-662"></span><span>        </span><span class="hs-comment">-- If size could be 0 then @f &quot;x&quot;@ might be too small</span><span>
</span><span id="line-663"></span><span>        </span><span class="hs-comment">-- [Sept03: make literal strings a bit bigger to avoid fruitless</span><span>
</span><span id="line-664"></span><span>        </span><span class="hs-comment">--  duplication of little strings]</span><span>
</span><span id="line-665"></span><span class="annot"><a href="GHC.Core.Unfold.html#litSize"><span class="hs-identifier hs-var">litSize</span></a></span><span> </span><span id="local-6989586621682732963"><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621682732963"><span class="hs-identifier hs-var">_other</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>    </span><span class="hs-comment">-- Must match size of nullary constructors</span><span>
</span><span id="line-666"></span><span>                      </span><span class="hs-comment">-- Key point: if  x |-&gt; 4, then x must inline unconditionally</span><span>
</span><span id="line-667"></span><span>                      </span><span class="hs-comment">--            (eg via case binding)</span><span>
</span><span id="line-668"></span><span>
</span><span id="line-669"></span><span class="annot"><a href="GHC.Core.Unfold.html#classOpSize"><span class="hs-identifier hs-type">classOpSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#UnfoldingOpts"><span class="hs-identifier hs-type">UnfoldingOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#ExprSize"><span class="hs-identifier hs-type">ExprSize</span></a></span><span>
</span><span id="line-670"></span><span class="hs-comment">-- See Note [Conlike is interesting]</span><span>
</span><span id="line-671"></span><span id="classOpSize"><span class="annot"><span class="annottext">classOpSize :: UnfoldingOpts -&gt; [Id] -&gt; [CoreExpr] -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#classOpSize"><span class="hs-identifier hs-var hs-var">classOpSize</span></a></span></span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-672"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExprSize
</span><a href="GHC.Core.Unfold.html#sizeZero"><span class="hs-identifier hs-var">sizeZero</span></a></span><span>
</span><span id="line-673"></span><span class="annot"><a href="GHC.Core.Unfold.html#classOpSize"><span class="hs-identifier hs-var">classOpSize</span></a></span><span> </span><span id="local-6989586621682732964"><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682732964"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621682732965"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682732965"><span class="hs-identifier hs-var">top_args</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682732966"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732966"><span class="hs-identifier hs-var">arg1</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682732967"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682732967"><span class="hs-identifier hs-var">other_args</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-674"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Bag (Id, Int) -&gt; Int -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#SizeIs"><span class="hs-identifier hs-var">SizeIs</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732968"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Bag (Id, Int)
</span><a href="#local-6989586621682732969"><span class="hs-identifier hs-var">arg_discount</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-675"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-676"></span><span>    </span><span id="local-6989586621682732968"><span class="annot"><span class="annottext">size :: Int
</span><a href="#local-6989586621682732968"><span class="hs-identifier hs-var hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">20</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">10</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">[CoreExpr] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682732967"><span class="hs-identifier hs-var">other_args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-677"></span><span>    </span><span class="hs-comment">-- If the class op is scrutinising a lambda bound dictionary then</span><span>
</span><span id="line-678"></span><span>    </span><span class="hs-comment">-- give it a discount, to encourage the inlining of this function</span><span>
</span><span id="line-679"></span><span>    </span><span class="hs-comment">-- The actual discount is rather arbitrarily chosen</span><span>
</span><span id="line-680"></span><span>    </span><span id="local-6989586621682732969"><span class="annot"><span class="annottext">arg_discount :: Bag (Id, Int)
</span><a href="#local-6989586621682732969"><span class="hs-identifier hs-var hs-var">arg_discount</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732966"><span class="hs-identifier hs-var">arg1</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-681"></span><span>                     </span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682732970"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732970"><span class="hs-identifier hs-var">dict</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732970"><span class="hs-identifier hs-var">dict</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; [Id] -&gt; Bool
forall a. Eq a =&gt; a -&gt; [a] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682732965"><span class="hs-identifier hs-var">top_args</span></a></span><span>
</span><span id="line-682"></span><span>                              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Id, Int) -&gt; Bag (Id, Int)
forall a. a -&gt; Bag a
</span><a href="GHC.Data.Bag.html#unitBag"><span class="hs-identifier hs-var">unitBag</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732970"><span class="hs-identifier hs-var">dict</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts -&gt; Int
</span><a href="GHC.Core.Unfold.html#unfoldingDictDiscount"><span class="hs-identifier hs-var">unfoldingDictDiscount</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682732964"><span class="hs-identifier hs-var">opts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-683"></span><span>                     </span><span id="local-6989586621682732971"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682732971"><span class="hs-identifier hs-var">_other</span></a></span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bag (Id, Int)
forall a. Bag a
</span><a href="GHC.Data.Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a></span><span>
</span><span id="line-684"></span><span>
</span><span id="line-685"></span><span class="annot"><span class="hs-comment">-- | The size of a function call</span></span><span>
</span><span id="line-686"></span><span class="annot"><a href="GHC.Core.Unfold.html#callSize"><span class="hs-identifier hs-type">callSize</span></a></span><span>
</span><span id="line-687"></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ number of value args</span></span><span>
</span><span id="line-688"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ number of value args that are void</span></span><span>
</span><span id="line-689"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-690"></span><span id="callSize"><span class="annot"><span class="annottext">callSize :: Int -&gt; Int -&gt; Int
</span><a href="GHC.Core.Unfold.html#callSize"><span class="hs-identifier hs-var hs-var">callSize</span></a></span></span><span> </span><span id="local-6989586621682732973"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732973"><span class="hs-identifier hs-var">n_val_args</span></a></span></span><span> </span><span id="local-6989586621682732974"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732974"><span class="hs-identifier hs-var">voids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">10</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732973"><span class="hs-identifier hs-var">n_val_args</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732974"><span class="hs-identifier hs-var">voids</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-691"></span><span>        </span><span class="hs-comment">-- The 1+ is for the function itself</span><span>
</span><span id="line-692"></span><span>        </span><span class="hs-comment">-- Add 1 for each non-trivial arg;</span><span>
</span><span id="line-693"></span><span>        </span><span class="hs-comment">-- the allocation cost, as in let(rec)</span><span>
</span><span id="line-694"></span><span>
</span><span id="line-695"></span><span class="annot"><span class="hs-comment">-- | The size of a jump to a join point</span></span><span>
</span><span id="line-696"></span><span class="annot"><a href="GHC.Core.Unfold.html#jumpSize"><span class="hs-identifier hs-type">jumpSize</span></a></span><span>
</span><span id="line-697"></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ number of value args</span></span><span>
</span><span id="line-698"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ number of value args that are void</span></span><span>
</span><span id="line-699"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-700"></span><span id="jumpSize"><span class="annot"><span class="annottext">jumpSize :: Int -&gt; Int -&gt; Int
</span><a href="GHC.Core.Unfold.html#jumpSize"><span class="hs-identifier hs-var hs-var">jumpSize</span></a></span></span><span> </span><span id="local-6989586621682732976"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732976"><span class="hs-identifier hs-var">_n_val_args</span></a></span></span><span> </span><span id="local-6989586621682732977"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732977"><span class="hs-identifier hs-var">_voids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>   </span><span class="hs-comment">-- Jumps are small, and we don't want penalise them</span><span>
</span><span id="line-701"></span><span>
</span><span id="line-702"></span><span>  </span><span class="hs-comment">-- Old version:</span><span>
</span><span id="line-703"></span><span>  </span><span class="hs-comment">-- 2 * (1 + n_val_args - voids)</span><span>
</span><span id="line-704"></span><span>  </span><span class="hs-comment">-- A jump is 20% the size of a function call. Making jumps free reopens</span><span>
</span><span id="line-705"></span><span>  </span><span class="hs-comment">-- bug #6048, but making them any more expensive loses a 21% improvement in</span><span>
</span><span id="line-706"></span><span>  </span><span class="hs-comment">-- spectral/puzzle. TODO Perhaps adjusting the default threshold would be a</span><span>
</span><span id="line-707"></span><span>  </span><span class="hs-comment">-- better solution?</span><span>
</span><span id="line-708"></span><span>
</span><span id="line-709"></span><span class="annot"><a href="GHC.Core.Unfold.html#funSize"><span class="hs-identifier hs-type">funSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#UnfoldingOpts"><span class="hs-identifier hs-type">UnfoldingOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#ExprSize"><span class="hs-identifier hs-type">ExprSize</span></a></span><span>
</span><span id="line-710"></span><span class="hs-comment">-- Size for functions that are not constructors or primops</span><span>
</span><span id="line-711"></span><span class="hs-comment">-- Note [Function applications]</span><span>
</span><span id="line-712"></span><span id="funSize"><span class="annot"><span class="annottext">funSize :: UnfoldingOpts -&gt; [Id] -&gt; Id -&gt; Int -&gt; Int -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#funSize"><span class="hs-identifier hs-var hs-var">funSize</span></a></span></span><span> </span><span id="local-6989586621682732978"><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682732978"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621682732979"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682732979"><span class="hs-identifier hs-var">top_args</span></a></span></span><span> </span><span id="local-6989586621682732980"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732980"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621682732981"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732981"><span class="hs-identifier hs-var">n_val_args</span></a></span></span><span> </span><span id="local-6989586621682732982"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732982"><span class="hs-identifier hs-var">voids</span></a></span></span><span>
</span><span id="line-713"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732980"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#buildIdKey"><span class="hs-identifier hs-var">buildIdKey</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExprSize
</span><a href="GHC.Core.Unfold.html#buildSize"><span class="hs-identifier hs-var">buildSize</span></a></span><span>
</span><span id="line-714"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732980"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#augmentIdKey"><span class="hs-identifier hs-var">augmentIdKey</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExprSize
</span><a href="GHC.Core.Unfold.html#augmentSize"><span class="hs-identifier hs-var">augmentSize</span></a></span><span>
</span><span id="line-715"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Bag (Id, Int) -&gt; Int -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#SizeIs"><span class="hs-identifier hs-var">SizeIs</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732988"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Bag (Id, Int)
</span><a href="#local-6989586621682732989"><span class="hs-identifier hs-var">arg_discount</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732990"><span class="hs-identifier hs-var">res_discount</span></a></span><span>
</span><span id="line-716"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-717"></span><span>    </span><span id="local-6989586621682732991"><span class="annot"><span class="annottext">some_val_args :: Bool
</span><a href="#local-6989586621682732991"><span class="hs-identifier hs-var hs-var">some_val_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732981"><span class="hs-identifier hs-var">n_val_args</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-718"></span><span>    </span><span id="local-6989586621682732992"><span class="annot"><span class="annottext">is_join :: Bool
</span><a href="#local-6989586621682732992"><span class="hs-identifier hs-var hs-var">is_join</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732980"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-719"></span><span>
</span><span id="line-720"></span><span>    </span><span id="local-6989586621682732988"><span class="annot"><span class="annottext">size :: Int
</span><a href="#local-6989586621682732988"><span class="hs-identifier hs-var hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682732992"><span class="hs-identifier hs-var">is_join</span></a></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
</span><a href="GHC.Core.Unfold.html#jumpSize"><span class="hs-identifier hs-var">jumpSize</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732981"><span class="hs-identifier hs-var">n_val_args</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732982"><span class="hs-identifier hs-var">voids</span></a></span><span>
</span><span id="line-721"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682732991"><span class="hs-identifier hs-var">some_val_args</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-722"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
</span><a href="GHC.Core.Unfold.html#callSize"><span class="hs-identifier hs-var">callSize</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732981"><span class="hs-identifier hs-var">n_val_args</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732982"><span class="hs-identifier hs-var">voids</span></a></span><span>
</span><span id="line-723"></span><span>
</span><span id="line-724"></span><span>        </span><span class="hs-comment">--                  DISCOUNTS</span><span>
</span><span id="line-725"></span><span>        </span><span class="hs-comment">--  See Note [Function and non-function discounts]</span><span>
</span><span id="line-726"></span><span>    </span><span id="local-6989586621682732989"><span class="annot"><span class="annottext">arg_discount :: Bag (Id, Int)
</span><a href="#local-6989586621682732989"><span class="hs-identifier hs-var hs-var">arg_discount</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682732991"><span class="hs-identifier hs-var">some_val_args</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732980"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; [Id] -&gt; Bool
forall a. Eq a =&gt; a -&gt; [a] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682732979"><span class="hs-identifier hs-var">top_args</span></a></span><span>
</span><span id="line-727"></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id, Int) -&gt; Bag (Id, Int)
forall a. a -&gt; Bag a
</span><a href="GHC.Data.Bag.html#unitBag"><span class="hs-identifier hs-var">unitBag</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732980"><span class="hs-identifier hs-var">fun</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts -&gt; Int
</span><a href="GHC.Core.Unfold.html#unfoldingFunAppDiscount"><span class="hs-identifier hs-var">unfoldingFunAppDiscount</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682732978"><span class="hs-identifier hs-var">opts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-728"></span><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bag (Id, Int)
forall a. Bag a
</span><a href="GHC.Data.Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a></span><span>
</span><span id="line-729"></span><span>        </span><span class="hs-comment">-- If the function is an argument and is applied</span><span>
</span><span id="line-730"></span><span>        </span><span class="hs-comment">-- to some values, give it an arg-discount</span><span>
</span><span id="line-731"></span><span>
</span><span id="line-732"></span><span>    </span><span id="local-6989586621682732990"><span class="annot"><span class="annottext">res_discount :: Int
</span><a href="#local-6989586621682732990"><span class="hs-identifier hs-var hs-var">res_discount</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Int
</span><a href="GHC.Types.Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682732980"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732981"><span class="hs-identifier hs-var">n_val_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts -&gt; Int
</span><a href="GHC.Core.Unfold.html#unfoldingFunAppDiscount"><span class="hs-identifier hs-var">unfoldingFunAppDiscount</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682732978"><span class="hs-identifier hs-var">opts</span></a></span><span>
</span><span id="line-733"></span><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-734"></span><span>        </span><span class="hs-comment">-- If the function is partially applied, show a result discount</span><span>
</span><span id="line-735"></span><span class="hs-comment">-- XXX maybe behave like ConSize for eval'd variable</span><span>
</span><span id="line-736"></span><span>
</span><span id="line-737"></span><span class="annot"><a href="GHC.Core.Unfold.html#conSize"><span class="hs-identifier hs-type">conSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#ExprSize"><span class="hs-identifier hs-type">ExprSize</span></a></span><span>
</span><span id="line-738"></span><span id="conSize"><span class="annot"><span class="annottext">conSize :: DataCon -&gt; Int -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#conSize"><span class="hs-identifier hs-var hs-var">conSize</span></a></span></span><span> </span><span id="local-6989586621682732994"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682732994"><span class="hs-identifier hs-var">dc</span></a></span></span><span> </span><span id="local-6989586621682732995"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732995"><span class="hs-identifier hs-var">n_val_args</span></a></span></span><span>
</span><span id="line-739"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732995"><span class="hs-identifier hs-var">n_val_args</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Bag (Id, Int) -&gt; Int -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#SizeIs"><span class="hs-identifier hs-var">SizeIs</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bag (Id, Int)
forall a. Bag a
</span><a href="GHC.Data.Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">10</span></span><span>    </span><span class="hs-comment">-- Like variables</span><span>
</span><span id="line-740"></span><span>
</span><span id="line-741"></span><span class="hs-comment">-- See Note [Unboxed tuple size and result discount]</span><span>
</span><span id="line-742"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; Bool
</span><a href="GHC.Core.DataCon.html#isUnboxedTupleDataCon"><span class="hs-identifier hs-var">isUnboxedTupleDataCon</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682732994"><span class="hs-identifier hs-var">dc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Bag (Id, Int) -&gt; Int -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#SizeIs"><span class="hs-identifier hs-var">SizeIs</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bag (Id, Int)
forall a. Bag a
</span><a href="GHC.Data.Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">10</span></span><span>
</span><span id="line-743"></span><span>
</span><span id="line-744"></span><span class="hs-comment">-- See Note [Constructor size and result discount]</span><span>
</span><span id="line-745"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Bag (Id, Int) -&gt; Int -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#SizeIs"><span class="hs-identifier hs-var">SizeIs</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">10</span></span><span> </span><span class="annot"><span class="annottext">Bag (Id, Int)
forall a. Bag a
</span><a href="GHC.Data.Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">10</span></span><span>
</span><span id="line-746"></span><span>
</span><span id="line-747"></span><span class="hs-comment">{- Note [Constructor size and result discount]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Treat a constructors application as size 10, regardless of how many
arguments it has; we are keen to expose them (and we charge separately
for their args).  We can't treat them as size zero, else we find that
(Just x) has size 0, which is the same as a lone variable; and hence
'v' will always be replaced by (Just x), where v is bound to Just x.

The &quot;result discount&quot; is applied if the result of the call is
scrutinised (say by a case).  For a constructor application that will
mean the constructor application will disappear, so we don't need to
charge it to the function.  So the discount should at least match the
cost of the constructor application, namely 10.

Historical note 1: Until Jun 2020 we gave it a &quot;bit of extra
incentive&quot; via a discount of 10*(1 + n_val_args), but that was FAR too
much (#18282).  In particular, consider a huge case tree like

   let r = case y1 of
          Nothing -&gt; B1 a b c
          Just v1 -&gt; case y2 of
                      Nothing -&gt; B1 c b a
                      Just v2 -&gt; ...

If conSize gives a cost of 10 (regardless of n_val_args) and a
discount of 10, that'll make each alternative RHS cost zero.  We
charge 10 for each case alternative (see size_up_alt).  If we give a
bigger discount (say 20) in conSize, we'll make the case expression
cost *nothing*, and that can make a huge case tree cost nothing. This
leads to massive, sometimes exponential inlinings (#18282).  In short,
don't give a discount that give a negative size to a sub-expression!

Historical note 2: Much longer ago, Simon M tried a MUCH bigger
discount: (10 * (10 + n_val_args)), and said it was an &quot;unambiguous
win&quot;, but its terribly dangerous because a function with many many
case branches, each finishing with a constructor, can have an
arbitrarily large discount.  This led to terrible code bloat: see #6099.

Note [Unboxed tuple size and result discount]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
However, unboxed tuples count as size zero. I found occasions where we had
        f x y z = case op# x y z of { s -&gt; (# s, () #) }
and f wasn't getting inlined.

I tried giving unboxed tuples a *result discount* of zero (see the
commented-out line).  Why?  When returned as a result they do not
allocate, so maybe we don't want to charge so much for them. If you
have a non-zero discount here, we find that workers often get inlined
back into wrappers, because it look like
    f x = case $wf x of (# a,b #) -&gt; (a,b)
and we are keener because of the case.  However while this change
shrank binary sizes by 0.5% it also made spectral/boyer allocate 5%
more. All other changes were very small. So it's not a big deal but I
didn't adopt the idea.

When fixing #18282 (see Note [Constructor size and result discount])
I changed the result discount to be just 10, not 10*(1+n_val_args).

Note [Function and non-function discounts]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We want a discount if the function is applied. A good example is
monadic combinators with continuation arguments, where inlining is
quite important.

But we don't want a big discount when a function is called many times
(see the detailed comments with #6048) because if the function is
big it won't be inlined at its many call sites and no benefit results.
Indeed, we can get exponentially big inlinings this way; that is what
#6048 is about.

On the other hand, for data-valued arguments, if there are lots of
case expressions in the body, each one will get smaller if we apply
the function to a constructor application, so we *want* a big discount
if the argument is scrutinised by many case expressions.

Conclusion:
  - For functions, take the max of the discounts
  - For data values, take the sum of the discounts


Note [Literal integer size]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
Literal integers *can* be big (mkInteger [...coefficients...]), but
need not be (IS n).  We just use an arbitrary big-ish constant here
so that, in particular, we don't inline top-level defns like
   n = IS 5
There's no point in doing so -- any optimisations will see the IS
through n's unfolding.  Nor will a big size inhibit unfoldings functions
that mention a literal Integer, because the float-out pass will float
all those constants to top level.
-}</span><span>
</span><span id="line-838"></span><span>
</span><span id="line-839"></span><span class="annot"><a href="GHC.Core.Unfold.html#primOpSize"><span class="hs-identifier hs-type">primOpSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Builtin.PrimOps.html#PrimOp"><span class="hs-identifier hs-type">PrimOp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#ExprSize"><span class="hs-identifier hs-type">ExprSize</span></a></span><span>
</span><span id="line-840"></span><span id="primOpSize"><span class="annot"><span class="annottext">primOpSize :: PrimOp -&gt; Int -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#primOpSize"><span class="hs-identifier hs-var hs-var">primOpSize</span></a></span></span><span> </span><span id="local-6989586621682732997"><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621682732997"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span id="local-6989586621682732998"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732998"><span class="hs-identifier hs-var">n_val_args</span></a></span></span><span>
</span><span id="line-841"></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; Bool
</span><a href="GHC.Builtin.PrimOps.html#primOpOutOfLine"><span class="hs-identifier hs-var">primOpOutOfLine</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621682732997"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-842"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#sizeN"><span class="hs-identifier hs-var">sizeN</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732999"><span class="hs-identifier hs-var">op_size</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732998"><span class="hs-identifier hs-var">n_val_args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-843"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#sizeN"><span class="hs-identifier hs-var">sizeN</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682732999"><span class="hs-identifier hs-var">op_size</span></a></span><span>
</span><span id="line-844"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-845"></span><span>   </span><span id="local-6989586621682732999"><span class="annot"><span class="annottext">op_size :: Int
</span><a href="#local-6989586621682732999"><span class="hs-identifier hs-var hs-var">op_size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; Int
</span><a href="GHC.Builtin.PrimOps.html#primOpCodeSize"><span class="hs-identifier hs-var">primOpCodeSize</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621682732997"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-846"></span><span>
</span><span id="line-847"></span><span>
</span><span id="line-848"></span><span class="annot"><a href="GHC.Core.Unfold.html#buildSize"><span class="hs-identifier hs-type">buildSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#ExprSize"><span class="hs-identifier hs-type">ExprSize</span></a></span><span>
</span><span id="line-849"></span><span id="buildSize"><span class="annot"><span class="annottext">buildSize :: ExprSize
</span><a href="GHC.Core.Unfold.html#buildSize"><span class="hs-identifier hs-var hs-var">buildSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Bag (Id, Int) -&gt; Int -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#SizeIs"><span class="hs-identifier hs-var">SizeIs</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bag (Id, Int)
forall a. Bag a
</span><a href="GHC.Data.Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">40</span></span><span>
</span><span id="line-850"></span><span>        </span><span class="hs-comment">-- We really want to inline applications of build</span><span>
</span><span id="line-851"></span><span>        </span><span class="hs-comment">-- build t (\cn -&gt; e) should cost only the cost of e (because build will be inlined later)</span><span>
</span><span id="line-852"></span><span>        </span><span class="hs-comment">-- Indeed, we should add a result_discount because build is</span><span>
</span><span id="line-853"></span><span>        </span><span class="hs-comment">-- very like a constructor.  We don't bother to check that the</span><span>
</span><span id="line-854"></span><span>        </span><span class="hs-comment">-- build is saturated (it usually is).  The &quot;-2&quot; discounts for the \c n,</span><span>
</span><span id="line-855"></span><span>        </span><span class="hs-comment">-- The &quot;4&quot; is rather arbitrary.</span><span>
</span><span id="line-856"></span><span>
</span><span id="line-857"></span><span class="annot"><a href="GHC.Core.Unfold.html#augmentSize"><span class="hs-identifier hs-type">augmentSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#ExprSize"><span class="hs-identifier hs-type">ExprSize</span></a></span><span>
</span><span id="line-858"></span><span id="augmentSize"><span class="annot"><span class="annottext">augmentSize :: ExprSize
</span><a href="GHC.Core.Unfold.html#augmentSize"><span class="hs-identifier hs-var hs-var">augmentSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Bag (Id, Int) -&gt; Int -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#SizeIs"><span class="hs-identifier hs-var">SizeIs</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bag (Id, Int)
forall a. Bag a
</span><a href="GHC.Data.Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">40</span></span><span>
</span><span id="line-859"></span><span>        </span><span class="hs-comment">-- Ditto (augment t (\cn -&gt; e) ys) should cost only the cost of</span><span>
</span><span id="line-860"></span><span>        </span><span class="hs-comment">-- e plus ys. The -2 accounts for the \cn</span><span>
</span><span id="line-861"></span><span>
</span><span id="line-862"></span><span class="hs-comment">-- When we return a lambda, give a discount if it's used (applied)</span><span>
</span><span id="line-863"></span><span class="annot"><a href="GHC.Core.Unfold.html#lamScrutDiscount"><span class="hs-identifier hs-type">lamScrutDiscount</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#UnfoldingOpts"><span class="hs-identifier hs-type">UnfoldingOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#ExprSize"><span class="hs-identifier hs-type">ExprSize</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#ExprSize"><span class="hs-identifier hs-type">ExprSize</span></a></span><span>
</span><span id="line-864"></span><span id="lamScrutDiscount"><span class="annot"><span class="annottext">lamScrutDiscount :: UnfoldingOpts -&gt; ExprSize -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#lamScrutDiscount"><span class="hs-identifier hs-var hs-var">lamScrutDiscount</span></a></span></span><span> </span><span id="local-6989586621682733001"><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682733001"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Unfold.html#SizeIs"><span class="hs-identifier hs-type">SizeIs</span></a></span><span> </span><span id="local-6989586621682733002"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682733002"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621682733003"><span class="annot"><span class="annottext">Bag (Id, Int)
</span><a href="#local-6989586621682733003"><span class="hs-identifier hs-var">vs</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Bag (Id, Int) -&gt; Int -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#SizeIs"><span class="hs-identifier hs-var">SizeIs</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682733002"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Bag (Id, Int)
</span><a href="#local-6989586621682733003"><span class="hs-identifier hs-var">vs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UnfoldingOpts -&gt; Int
</span><a href="GHC.Core.Unfold.html#unfoldingFunAppDiscount"><span class="hs-identifier hs-var">unfoldingFunAppDiscount</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682733001"><span class="hs-identifier hs-var">opts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-865"></span><span class="annot"><a href="GHC.Core.Unfold.html#lamScrutDiscount"><span class="hs-identifier hs-var">lamScrutDiscount</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
</span><span class="hs-identifier">_</span></span><span>      </span><span class="annot"><span class="annottext">ExprSize
</span><a href="GHC.Core.Unfold.html#TooBig"><span class="hs-identifier hs-var">TooBig</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExprSize
</span><a href="GHC.Core.Unfold.html#TooBig"><span class="hs-identifier hs-var">TooBig</span></a></span><span>
</span><span id="line-866"></span><span>
</span><span id="line-867"></span><span class="hs-comment">{-
Note [addAltSize result discounts]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When adding the size of alternatives, we *add* the result discounts
too, rather than take the *maximum*.  For a multi-branch case, this
gives a discount for each branch that returns a constructor, making us
keener to inline.  I did try using 'max' instead, but it makes nofib
'rewrite' and 'puzzle' allocate significantly more, and didn't make
binary sizes shrink significantly either.

Note [Discounts and thresholds]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Constants for discounts and thresholds are defined in 'UnfoldingOpts'. They are:

unfoldingCreationThreshold
     At a definition site, if the unfolding is bigger than this, we
     may discard it altogether

unfoldingUseThreshold
     At a call site, if the unfolding, less discounts, is smaller than
     this, then it's small enough inline

unfoldingDictDiscount
     The discount for each occurrence of a dictionary argument
     as an argument of a class method.  Should be pretty small
     else big functions may get inlined

unfoldingFunAppDiscount
     Discount for a function argument that is applied.  Quite
     large, because if we inline we avoid the higher-order call.

unfoldingVeryAggressive
     If True, the compiler ignores all the thresholds and inlines very
     aggressively. It still adheres to arity, simplifier phase control and
     loop breakers.


Historical Note: Before April 2020 we had another factor,
ufKeenessFactor, which would scale the discounts before they were subtracted
from the size. This was justified with the following comment:

  -- We multiply the raw discounts (args_discount and result_discount)
  -- ty opt_UnfoldingKeenessFactor because the former have to do with
  --  *size* whereas the discounts imply that there's some extra
  --  *efficiency* to be gained (e.g. beta reductions, case reductions)
  -- by inlining.

However, this is highly suspect since it means that we subtract a *scaled* size
from an absolute size, resulting in crazy (e.g. negative) scores in some cases
(#15304). We consequently killed off ufKeenessFactor and bumped up the
ufUseThreshold to compensate.


Note [Function applications]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In a function application (f a b)

  - If 'f' is an argument to the function being analysed,
    and there's at least one value arg, record a FunAppDiscount for f

  - If the application if a PAP (arity &gt; 2 in this example)
    record a *result* discount (because inlining
    with &quot;extra&quot; args in the call may mean that we now
    get a saturated application)

Code for manipulating sizes
-}</span><span>
</span><span id="line-935"></span><span>
</span><span id="line-936"></span><span class="annot"><span class="hs-comment">-- | The size of a candidate expression for unfolding</span></span><span>
</span><span id="line-937"></span><span class="hs-keyword">data</span><span> </span><span id="ExprSize"><span class="annot"><a href="GHC.Core.Unfold.html#ExprSize"><span class="hs-identifier hs-var">ExprSize</span></a></span></span><span>
</span><span id="line-938"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="TooBig"><span class="annot"><a href="GHC.Core.Unfold.html#TooBig"><span class="hs-identifier hs-var">TooBig</span></a></span></span><span>
</span><span id="line-939"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="SizeIs"><span class="annot"><a href="GHC.Core.Unfold.html#SizeIs"><span class="hs-identifier hs-var">SizeIs</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="_es_size_is"><span class="annot"><span class="annottext">ExprSize -&gt; Int
</span><a href="GHC.Core.Unfold.html#_es_size_is"><span class="hs-identifier hs-var hs-var">_es_size_is</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="annot"><span class="hs-comment">-- ^ Size found</span></span><span>
</span><span id="line-940"></span><span>             </span><span class="hs-special">,</span><span> </span><span id="_es_args"><span class="annot"><span class="annottext">ExprSize -&gt; Bag (Id, Int)
</span><a href="GHC.Core.Unfold.html#_es_args"><span class="hs-identifier hs-var hs-var">_es_args</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-941"></span><span>               </span><span class="annot"><span class="hs-comment">-- ^ Arguments cased herein, and discount for each such</span></span><span>
</span><span id="line-942"></span><span>             </span><span class="hs-special">,</span><span> </span><span id="_es_discount"><span class="annot"><span class="annottext">ExprSize -&gt; Int
</span><a href="GHC.Core.Unfold.html#_es_discount"><span class="hs-identifier hs-var hs-var">_es_discount</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-943"></span><span>               </span><span class="hs-comment">-- ^ Size to subtract if result is scrutinised by a case</span><span>
</span><span id="line-944"></span><span>               </span><span class="hs-comment">-- expression</span><span>
</span><span id="line-945"></span><span>             </span><span class="hs-special">}</span><span>
</span><span id="line-946"></span><span>
</span><span id="line-947"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#ExprSize"><span class="hs-identifier hs-type">ExprSize</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-948"></span><span>  </span><span id="local-6989586621682733014"><span class="annot"><span class="annottext">ppr :: ExprSize -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="annot"><span class="annottext">ExprSize
</span><a href="GHC.Core.Unfold.html#TooBig"><span class="hs-identifier hs-var">TooBig</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;TooBig&quot;</span></span><span>
</span><span id="line-949"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Unfold.html#SizeIs"><span class="hs-identifier hs-type">SizeIs</span></a></span><span> </span><span id="local-6989586621682733015"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682733015"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="annot"><span class="annottext">Bag (Id, Int)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682733016"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682733016"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#brackets"><span class="hs-identifier hs-var">brackets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; SDoc
forall doc. IsLine doc =&gt; Int -&gt; doc
</span><a href="GHC.Utils.Outputable.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682733015"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SDoc
forall doc. IsLine doc =&gt; Int -&gt; doc
</span><a href="GHC.Utils.Outputable.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682733016"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-950"></span><span>
</span><span id="line-951"></span><span class="hs-comment">-- subtract the discount before deciding whether to bale out. eg. we</span><span>
</span><span id="line-952"></span><span class="hs-comment">-- want to inline a large constructor application into a selector:</span><span>
</span><span id="line-953"></span><span class="hs-comment">--      tup = (a_1, ..., a_99)</span><span>
</span><span id="line-954"></span><span class="hs-comment">--      x = case tup of ...</span><span>
</span><span id="line-955"></span><span class="hs-comment">--</span><span>
</span><span id="line-956"></span><span class="annot"><a href="GHC.Core.Unfold.html#mkSizeIs"><span class="hs-identifier hs-type">mkSizeIs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Data.Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#ExprSize"><span class="hs-identifier hs-type">ExprSize</span></a></span><span>
</span><span id="line-957"></span><span id="mkSizeIs"><span class="annot"><span class="annottext">mkSizeIs :: Int -&gt; Int -&gt; Bag (Id, Int) -&gt; Int -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#mkSizeIs"><span class="hs-identifier hs-var hs-var">mkSizeIs</span></a></span></span><span> </span><span id="local-6989586621682733020"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682733020"><span class="hs-identifier hs-var">max</span></a></span></span><span> </span><span id="local-6989586621682733021"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682733021"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621682733022"><span class="annot"><span class="annottext">Bag (Id, Int)
</span><a href="#local-6989586621682733022"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span id="local-6989586621682733023"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682733023"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682733021"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682733023"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682733020"><span class="hs-identifier hs-var">max</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExprSize
</span><a href="GHC.Core.Unfold.html#TooBig"><span class="hs-identifier hs-var">TooBig</span></a></span><span>
</span><span id="line-958"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Bag (Id, Int) -&gt; Int -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#SizeIs"><span class="hs-identifier hs-var">SizeIs</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682733021"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Bag (Id, Int)
</span><a href="#local-6989586621682733022"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682733023"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-959"></span><span>
</span><span id="line-960"></span><span class="annot"><a href="GHC.Core.Unfold.html#maxSize"><span class="hs-identifier hs-type">maxSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#ExprSize"><span class="hs-identifier hs-type">ExprSize</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#ExprSize"><span class="hs-identifier hs-type">ExprSize</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#ExprSize"><span class="hs-identifier hs-type">ExprSize</span></a></span><span>
</span><span id="line-961"></span><span id="maxSize"><span class="annot"><span class="annottext">maxSize :: ExprSize -&gt; ExprSize -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#maxSize"><span class="hs-identifier hs-var hs-var">maxSize</span></a></span></span><span> </span><span class="annot"><span class="annottext">ExprSize
</span><a href="GHC.Core.Unfold.html#TooBig"><span class="hs-identifier hs-var">TooBig</span></a></span><span>         </span><span class="annot"><span class="annottext">ExprSize
</span><span class="hs-identifier">_</span></span><span>                                  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExprSize
</span><a href="GHC.Core.Unfold.html#TooBig"><span class="hs-identifier hs-var">TooBig</span></a></span><span>
</span><span id="line-962"></span><span class="annot"><a href="GHC.Core.Unfold.html#maxSize"><span class="hs-identifier hs-var">maxSize</span></a></span><span> </span><span class="annot"><span class="annottext">ExprSize
</span><span class="hs-identifier">_</span></span><span>              </span><span class="annot"><span class="annottext">ExprSize
</span><a href="GHC.Core.Unfold.html#TooBig"><span class="hs-identifier hs-var">TooBig</span></a></span><span>                             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExprSize
</span><a href="GHC.Core.Unfold.html#TooBig"><span class="hs-identifier hs-var">TooBig</span></a></span><span>
</span><span id="line-963"></span><span class="annot"><a href="GHC.Core.Unfold.html#maxSize"><span class="hs-identifier hs-var">maxSize</span></a></span><span> </span><span id="local-6989586621682733024"><span class="annot"><span class="annottext">s1 :: ExprSize
</span><a href="#local-6989586621682733024"><span class="hs-identifier hs-var">s1</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Unfold.html#SizeIs"><span class="hs-identifier hs-type">SizeIs</span></a></span><span> </span><span id="local-6989586621682733025"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682733025"><span class="hs-identifier hs-var">n1</span></a></span></span><span> </span><span class="annot"><span class="annottext">Bag (Id, Int)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682733026"><span class="annot"><span class="annottext">s2 :: ExprSize
</span><a href="#local-6989586621682733026"><span class="hs-identifier hs-var">s2</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Unfold.html#SizeIs"><span class="hs-identifier hs-type">SizeIs</span></a></span><span> </span><span id="local-6989586621682733027"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682733027"><span class="hs-identifier hs-var">n2</span></a></span></span><span> </span><span class="annot"><span class="annottext">Bag (Id, Int)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682733025"><span class="hs-identifier hs-var">n1</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682733027"><span class="hs-identifier hs-var">n2</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExprSize
</span><a href="#local-6989586621682733024"><span class="hs-identifier hs-var">s1</span></a></span><span>
</span><span id="line-964"></span><span>                                              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExprSize
</span><a href="#local-6989586621682733026"><span class="hs-identifier hs-var">s2</span></a></span><span>
</span><span id="line-965"></span><span>
</span><span id="line-966"></span><span class="annot"><a href="GHC.Core.Unfold.html#sizeZero"><span class="hs-identifier hs-type">sizeZero</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#ExprSize"><span class="hs-identifier hs-type">ExprSize</span></a></span><span>
</span><span id="line-967"></span><span class="annot"><a href="GHC.Core.Unfold.html#sizeN"><span class="hs-identifier hs-type">sizeN</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#ExprSize"><span class="hs-identifier hs-type">ExprSize</span></a></span><span>
</span><span id="line-968"></span><span>
</span><span id="line-969"></span><span id="sizeZero"><span class="annot"><span class="annottext">sizeZero :: ExprSize
</span><a href="GHC.Core.Unfold.html#sizeZero"><span class="hs-identifier hs-var hs-var">sizeZero</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Bag (Id, Int) -&gt; Int -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#SizeIs"><span class="hs-identifier hs-var">SizeIs</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bag (Id, Int)
forall a. Bag a
</span><a href="GHC.Data.Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-970"></span><span id="sizeN"><span class="annot"><span class="annottext">sizeN :: Int -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#sizeN"><span class="hs-identifier hs-var hs-var">sizeN</span></a></span></span><span> </span><span id="local-6989586621682733028"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682733028"><span class="hs-identifier hs-var">n</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Bag (Id, Int) -&gt; Int -&gt; ExprSize
</span><a href="GHC.Core.Unfold.html#SizeIs"><span class="hs-identifier hs-var">SizeIs</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682733028"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Bag (Id, Int)
forall a. Bag a
</span><a href="GHC.Data.Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-971"></span></pre></body></html>