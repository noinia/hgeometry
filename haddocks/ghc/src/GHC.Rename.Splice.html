<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE MultiWayIf #-}</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="GHC.Rename.Splice.html"><span class="hs-identifier">GHC.Rename.Splice</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-6"></span><span>        </span><span class="annot"><a href="GHC.Rename.Splice.html#rnTopSpliceDecls"><span class="hs-identifier">rnTopSpliceDecls</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span>        </span><span class="hs-comment">-- Typed splices</span><span>
</span><span id="line-9"></span><span>        </span><span class="annot"><a href="GHC.Rename.Splice.html#rnTypedSplice"><span class="hs-identifier">rnTypedSplice</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>        </span><span class="hs-comment">-- Untyped splices</span><span>
</span><span id="line-11"></span><span>        </span><span class="annot"><a href="GHC.Rename.Splice.html#rnSpliceType"><span class="hs-identifier">rnSpliceType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Rename.Splice.html#rnUntypedSpliceExpr"><span class="hs-identifier">rnUntypedSpliceExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Rename.Splice.html#rnSplicePat"><span class="hs-identifier">rnSplicePat</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Rename.Splice.html#rnSpliceTyPat"><span class="hs-identifier">rnSpliceTyPat</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Rename.Splice.html#rnSpliceDecl"><span class="hs-identifier">rnSpliceDecl</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>
</span><span id="line-13"></span><span>        </span><span class="hs-comment">-- Brackets</span><span>
</span><span id="line-14"></span><span>        </span><span class="annot"><a href="GHC.Rename.Splice.html#rnTypedBracket"><span class="hs-identifier">rnTypedBracket</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Rename.Splice.html#rnUntypedBracket"><span class="hs-identifier">rnUntypedBracket</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span>        </span><span class="annot"><a href="GHC.Rename.Splice.html#checkThLocalName"><span class="hs-identifier">checkThLocalName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Rename.Splice.html#traceSplice"><span class="hs-identifier">traceSplice</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Rename.Splice.html#SpliceInfo"><span class="hs-identifier">SpliceInfo</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>        </span><span class="annot"><a href="GHC.Rename.Splice.html#checkThLocalTyName"><span class="hs-identifier">checkThLocalTyName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-19"></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-21"></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.html"><span class="hs-identifier">GHC.Types.Name</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html"><span class="hs-identifier">GHC.Types.Name.Set</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Hs.html"><span class="hs-identifier">GHC.Hs</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.Reader.html"><span class="hs-identifier">GHC.Types.Name.Reader</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Errors.Types.html"><span class="hs-identifier">GHC.Tc.Errors.Types</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html"><span class="hs-identifier">GHC.Tc.Utils.Monad</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html"><span class="hs-identifier">GHC.Driver.Env.Types</span></a></span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Rename.Env.html"><span class="hs-identifier">GHC.Rename.Env</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Rename.Utils.html"><span class="hs-identifier">GHC.Rename.Utils</span></a></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Rename.Utils.html#newLocalBndrRn"><span class="hs-identifier">newLocalBndrRn</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Rename.Unbound.html"><span class="hs-identifier">GHC.Rename.Unbound</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html#isUnboundName"><span class="hs-identifier">isUnboundName</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Rename.Module.html"><span class="hs-identifier">GHC.Rename.Module</span></a></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Rename.Module.html#rnSrcDecls"><span class="hs-identifier">rnSrcDecls</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Rename.Module.html#findSplice"><span class="hs-identifier">findSplice</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Rename.Pat.html"><span class="hs-identifier">GHC.Rename.Pat</span></a></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Rename.Pat.html#rnPat"><span class="hs-identifier">rnPat</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Error.html"><span class="hs-identifier">GHC.Types.Error</span></a></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html"><span class="hs-identifier">GHC.Types.Basic</span></a></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier">TopLevelFlag</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#isTopLevel"><span class="hs-identifier">isTopLevel</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#maxPrec"><span class="hs-identifier">maxPrec</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.SourceText.html"><span class="hs-identifier">GHC.Types.SourceText</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.SourceText.html#SourceText"><span class="hs-identifier">SourceText</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Module.html"><span class="hs-identifier">GHC.Unit.Module</span></a></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html"><span class="hs-identifier">GHC.Types.SrcLoc</span></a></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Rename.HsType.html"><span class="hs-identifier">GHC.Rename.HsType</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Rename.HsType.html#rnLHsType"><span class="hs-identifier">rnLHsType</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">unless</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">when</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="hs-pragma">{-# SOURCE</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="annot"><a href="GHC.Rename.Expr.html"><span class="hs-identifier">GHC.Rename.Expr</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Rename.Expr.html#rnLExpr"><span class="hs-identifier">rnLExpr</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Env.html"><span class="hs-identifier">GHC.Tc.Utils.Env</span></a></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Env.html#checkWellStaged"><span class="hs-identifier">checkWellStaged</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Env.html#tcMetaTy"><span class="hs-identifier">tcMetaTy</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.DynFlags.html"><span class="hs-identifier">GHC.Driver.DynFlags</span></a></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html"><span class="hs-identifier">GHC.Data.FastString</span></a></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html"><span class="hs-identifier">GHC.Utils.Logger</span></a></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Hooks.html"><span class="hs-identifier">GHC.Driver.Hooks</span></a></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.TH.html"><span class="hs-identifier">GHC.Builtin.Names.TH</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.TH.html#decsQTyConName"><span class="hs-identifier">decsQTyConName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.TH.html#expQTyConName"><span class="hs-identifier">expQTyConName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.TH.html#liftName"><span class="hs-identifier">liftName</span></a></span><span>
</span><span id="line-55"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.TH.html#patQTyConName"><span class="hs-identifier">patQTyConName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.TH.html#quoteDecName"><span class="hs-identifier">quoteDecName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.TH.html#quoteExpName"><span class="hs-identifier">quoteExpName</span></a></span><span>
</span><span id="line-56"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.TH.html#quotePatName"><span class="hs-identifier">quotePatName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.TH.html#quoteTypeName"><span class="hs-identifier">quoteTypeName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.TH.html#typeQTyConName"><span class="hs-identifier">typeQTyConName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="hs-pragma">{-# SOURCE</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Expr.html"><span class="hs-identifier">GHC.Tc.Gen.Expr</span></a></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Expr.html#tcCheckPolyExpr"><span class="hs-identifier">tcCheckPolyExpr</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="hs-pragma">{-# SOURCE</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html"><span class="hs-identifier">GHC.Tc.Gen.Splice</span></a></span><span>
</span><span id="line-60"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runMetaD"><span class="hs-identifier">runMetaD</span></a></span><span>
</span><span id="line-61"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runMetaE"><span class="hs-identifier">runMetaE</span></a></span><span>
</span><span id="line-62"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runMetaP"><span class="hs-identifier">runMetaP</span></a></span><span>
</span><span id="line-63"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runMetaT"><span class="hs-identifier">runMetaT</span></a></span><span>
</span><span id="line-64"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#tcTopSpliceExpr"><span class="hs-identifier">tcTopSpliceExpr</span></a></span><span>
</span><span id="line-65"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Zonk.Type.html"><span class="hs-identifier">GHC.Tc.Zonk.Type</span></a></span><span>
</span><span id="line-68"></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html"><span class="hs-identifier">GHCi.RemoteTypes</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html#ForeignRef"><span class="hs-identifier">ForeignRef</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Internal.TH.Syntax</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TH</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Q</span></span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../ghc-boot-9.12.2-1a37/src/GHC.LanguageExtensions.html"><span class="hs-identifier">GHC.LanguageExtensions</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LangExt</span></span><span>
</span><span id="line-73"></span><span>
</span><span id="line-74"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Template Haskell brackets
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span class="hs-comment">-- Check that -XTemplateHaskellQuotes is enabled and available</span><span>
</span><span id="line-83"></span><span class="annot"><a href="GHC.Rename.Splice.html#checkForTemplateHaskellQuotes"><span class="hs-identifier hs-type">checkForTemplateHaskellQuotes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcPs"><span class="hs-identifier hs-type">GhcPs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#RnM"><span class="hs-identifier hs-type">RnM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span id="checkForTemplateHaskellQuotes"><span class="annot"><span class="annottext">checkForTemplateHaskellQuotes :: HsExpr GhcPs -&gt; RnM ()
</span><a href="GHC.Rename.Splice.html#checkForTemplateHaskellQuotes"><span class="hs-identifier hs-var hs-var">checkForTemplateHaskellQuotes</span></a></span></span><span> </span><span id="local-6989586621683065297"><span class="annot"><span class="annottext">HsExpr GhcPs
</span><a href="#local-6989586621683065297"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-85"></span><span>  </span><span class="annot"><span class="annottext">Extension -&gt; RnM () -&gt; RnM ()
forall gbl lcl. Extension -&gt; TcRnIf gbl lcl () -&gt; TcRnIf gbl lcl ()
</span><a href="GHC.Tc.Utils.Monad.html#unlessXOptM"><span class="hs-identifier hs-var">unlessXOptM</span></a></span><span> </span><span class="annot"><span class="annottext">Extension
</span><span class="hs-identifier hs-var">LangExt.TemplateHaskellQuotes</span></span><span> </span><span class="annot"><span class="annottext">(RnM () -&gt; RnM ()) -&gt; RnM () -&gt; RnM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-86"></span><span>    </span><span class="annot"><span class="annottext">TcRnMessage -&gt; RnM ()
forall a. TcRnMessage -&gt; TcRn a
</span><a href="GHC.Tc.Utils.Monad.html#failWith"><span class="hs-identifier hs-var">failWith</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; RnM ()) -&gt; TcRnMessage -&gt; RnM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">THSyntaxError -&gt; TcRnMessage
</span><a href="GHC.Rename.Splice.html#thSyntaxError"><span class="hs-identifier hs-var">thSyntaxError</span></a></span><span> </span><span class="annot"><span class="annottext">(THSyntaxError -&gt; TcRnMessage) -&gt; THSyntaxError -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HsExpr GhcPs -&gt; THSyntaxError
</span><a href="GHC.Tc.Errors.Types.html#IllegalTHQuotes"><span class="hs-identifier hs-var">IllegalTHQuotes</span></a></span><span> </span><span class="annot"><span class="annottext">HsExpr GhcPs
</span><a href="#local-6989586621683065297"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-87"></span><span>
</span><span id="line-88"></span><span class="hs-comment">{-

Note [Untyped quotes in typed splices and vice versa]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this typed splice
   $$(f [| x |])

Is there anything wrong with that /typed/ splice containing an /untyped/
quote [| x |]?   One could ask the same about an /untyped/ slice containing a
/typed/ quote.

In fact, both are fine (#24190). Presumably f's type looks something like:
   f :: Q Expr -&gt; Code Q Int

It is pretty hard for `f` to use its (untyped code) argument to build a typed
syntax tree, but not impossible:
* `f` could use `unsafeCodeCoerce :: Q Exp -&gt; Code Q a`
* `f` could just perform case analysis on the tree

But in the end all that matters is that in $$( e ), the expression `e` has the
right type.  It doesn't matter how `e` is built.  To put it another way, the
untyped quote `[| x |]` could also be written `varE 'x`, which is an ordinary
expression.

Moreover the ticked variable, 'x :: Name, is itself treated as an untyped quote;
but it is a perfectly fine sub-expression to have in a typed splice.

(Historical note: GHC used to unnecessarily  check that a typed quote only
occurred in a typed splice: #24190.)

-}</span><span>
</span><span id="line-119"></span><span>
</span><span id="line-120"></span><span class="annot"><a href="GHC.Rename.Splice.html#rnTypedBracket"><span class="hs-identifier hs-type">rnTypedBracket</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcPs"><span class="hs-identifier hs-type">GhcPs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#LHsExpr"><span class="hs-identifier hs-type">LHsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcPs"><span class="hs-identifier hs-type">GhcPs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#RnM"><span class="hs-identifier hs-type">RnM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html#FreeVars"><span class="hs-identifier hs-type">FreeVars</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-121"></span><span id="rnTypedBracket"><span class="annot"><span class="annottext">rnTypedBracket :: HsExpr GhcPs
-&gt; LHsExpr GhcPs -&gt; RnM (HsExpr (GhcPass 'Renamed), Uses)
</span><a href="GHC.Rename.Splice.html#rnTypedBracket"><span class="hs-identifier hs-var hs-var">rnTypedBracket</span></a></span></span><span> </span><span id="local-6989586621683065305"><span class="annot"><span class="annottext">HsExpr GhcPs
</span><a href="#local-6989586621683065305"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621683065306"><span class="annot"><span class="annottext">LHsExpr GhcPs
</span><a href="#local-6989586621683065306"><span class="hs-identifier hs-var">br_body</span></a></span></span><span>
</span><span id="line-122"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SDoc
-&gt; RnM (HsExpr (GhcPass 'Renamed), Uses)
-&gt; RnM (HsExpr (GhcPass 'Renamed), Uses)
forall a. SDoc -&gt; TcM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LHsExpr GhcPs -&gt; SDoc
</span><a href="GHC.Rename.Splice.html#typedQuotationCtxtDoc"><span class="hs-identifier hs-var">typedQuotationCtxtDoc</span></a></span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcPs
</span><a href="#local-6989586621683065306"><span class="hs-identifier hs-var">br_body</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(RnM (HsExpr (GhcPass 'Renamed), Uses)
 -&gt; RnM (HsExpr (GhcPass 'Renamed), Uses))
-&gt; RnM (HsExpr (GhcPass 'Renamed), Uses)
-&gt; RnM (HsExpr (GhcPass 'Renamed), Uses)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-123"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">HsExpr GhcPs -&gt; RnM ()
</span><a href="GHC.Rename.Splice.html#checkForTemplateHaskellQuotes"><span class="hs-identifier hs-var">checkForTemplateHaskellQuotes</span></a></span><span> </span><span class="annot"><span class="annottext">HsExpr GhcPs
</span><a href="#local-6989586621683065305"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-124"></span><span>
</span><span id="line-125"></span><span>         </span><span class="hs-comment">-- Check for nested brackets</span><span>
</span><span id="line-126"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683065309"><span class="annot"><a href="#local-6989586621683065309"><span class="hs-identifier hs-var">cur_stage</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM ThStage
</span><a href="GHC.Tc.Utils.Monad.html#getStage"><span class="hs-identifier hs-var">getStage</span></a></span><span>
</span><span id="line-127"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683065309"><span class="hs-identifier hs-type">cur_stage</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-128"></span><span>           </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TH.html#Splice"><span class="hs-identifier hs-type">Splice</span></a></span><span> </span><span class="annot"><span class="annottext">SpliceType
</span><span class="hs-identifier">_</span></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; RnM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-129"></span><span>               </span><span class="hs-comment">-- See Note [Untyped quotes in typed splices and vice versa]</span><span>
</span><span id="line-130"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TH.html#RunSplice"><span class="hs-identifier hs-type">RunSplice</span></a></span><span> </span><span class="annot"><span class="annottext">TcRef [ForeignRef (Q ())]
</span><span class="hs-identifier">_</span></span><span>    </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-131"></span><span>               </span><span class="hs-comment">-- See Note [RunSplice ThLevel] in GHC.Tc.Types.</span><span>
</span><span id="line-132"></span><span>               </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; RnM ()
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rnTypedBracket: Renaming typed bracket when running a splice&quot;</span></span><span>
</span><span id="line-133"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HsExpr GhcPs -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">HsExpr GhcPs
</span><a href="#local-6989586621683065305"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-134"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">ThStage
</span><a href="GHC.Tc.Types.TH.html#Comp"><span class="hs-identifier hs-var">Comp</span></a></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; RnM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-135"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TH.html#Brack"><span class="hs-identifier hs-type">Brack</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; RnM ()
forall a. TcRnMessage -&gt; TcRn a
</span><a href="GHC.Tc.Utils.Monad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; RnM ()) -&gt; TcRnMessage -&gt; RnM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">THSyntaxError -&gt; TcRnMessage
</span><a href="GHC.Rename.Splice.html#thSyntaxError"><span class="hs-identifier hs-var">thSyntaxError</span></a></span><span>
</span><span id="line-136"></span><span>                                          </span><span class="annot"><span class="annottext">(THSyntaxError -&gt; TcRnMessage) -&gt; THSyntaxError -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">THSyntaxError
</span><a href="GHC.Tc.Errors.Types.html#NestedTHBrackets"><span class="hs-identifier hs-var">NestedTHBrackets</span></a></span><span>
</span><span id="line-137"></span><span>           </span><span class="hs-special">}</span><span>
</span><span id="line-138"></span><span>
</span><span id="line-139"></span><span>         </span><span class="hs-comment">-- Brackets are desugared to code that mentions the TH package</span><span>
</span><span id="line-140"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#recordThUse"><span class="hs-identifier hs-type">recordThUse</span></a></span><span>
</span><span id="line-141"></span><span>
</span><span id="line-142"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceRn"><span class="hs-identifier hs-type">traceRn</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Renaming typed TH bracket&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#empty"><span class="hs-identifier hs-type">empty</span></a></span><span>
</span><span id="line-143"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683065322"><span class="annot"><a href="#local-6989586621683065322"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683065323"><span class="annot"><a href="#local-6989586621683065323"><span class="hs-identifier hs-var">fvs_e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#setStage"><span class="hs-identifier hs-type">setStage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.TH.html#Brack"><span class="hs-identifier hs-type">Brack</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065309"><span class="hs-identifier hs-type">cur_stage</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.TH.html#RnPendingTyped"><span class="hs-identifier hs-type">RnPendingTyped</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Rename.Expr.html#rnLExpr"><span class="hs-identifier hs-type">rnLExpr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065306"><span class="hs-identifier hs-type">br_body</span></a></span><span>
</span><span id="line-144"></span><span>
</span><span id="line-145"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsTypedBracket"><span class="hs-identifier hs-type">HsTypedBracket</span></a></span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Extension.html#noExtField"><span class="hs-identifier hs-type">noExtField</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065322"><span class="hs-identifier hs-type">body'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683065323"><span class="hs-identifier hs-type">fvs_e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-146"></span><span>
</span><span id="line-147"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-148"></span><span>
</span><span id="line-149"></span><span class="annot"><a href="GHC.Rename.Splice.html#rnUntypedBracket"><span class="hs-identifier hs-type">rnUntypedBracket</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcPs"><span class="hs-identifier hs-type">GhcPs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsQuote"><span class="hs-identifier hs-type">HsQuote</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcPs"><span class="hs-identifier hs-type">GhcPs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#RnM"><span class="hs-identifier hs-type">RnM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html#FreeVars"><span class="hs-identifier hs-type">FreeVars</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-150"></span><span id="rnUntypedBracket"><span class="annot"><span class="annottext">rnUntypedBracket :: HsExpr GhcPs
-&gt; HsQuote GhcPs -&gt; RnM (HsExpr (GhcPass 'Renamed), Uses)
</span><a href="GHC.Rename.Splice.html#rnUntypedBracket"><span class="hs-identifier hs-var hs-var">rnUntypedBracket</span></a></span></span><span> </span><span id="local-6989586621683065328"><span class="annot"><span class="annottext">HsExpr GhcPs
</span><a href="#local-6989586621683065328"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621683065329"><span class="annot"><span class="annottext">HsQuote GhcPs
</span><a href="#local-6989586621683065329"><span class="hs-identifier hs-var">br_body</span></a></span></span><span>
</span><span id="line-151"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SDoc
-&gt; RnM (HsExpr (GhcPass 'Renamed), Uses)
-&gt; RnM (HsExpr (GhcPass 'Renamed), Uses)
forall a. SDoc -&gt; TcM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HsQuote GhcPs -&gt; SDoc
</span><a href="GHC.Rename.Splice.html#untypedQuotationCtxtDoc"><span class="hs-identifier hs-var">untypedQuotationCtxtDoc</span></a></span><span> </span><span class="annot"><span class="annottext">HsQuote GhcPs
</span><a href="#local-6989586621683065329"><span class="hs-identifier hs-var">br_body</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(RnM (HsExpr (GhcPass 'Renamed), Uses)
 -&gt; RnM (HsExpr (GhcPass 'Renamed), Uses))
-&gt; RnM (HsExpr (GhcPass 'Renamed), Uses)
-&gt; RnM (HsExpr (GhcPass 'Renamed), Uses)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-152"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">HsExpr GhcPs -&gt; RnM ()
</span><a href="GHC.Rename.Splice.html#checkForTemplateHaskellQuotes"><span class="hs-identifier hs-var">checkForTemplateHaskellQuotes</span></a></span><span> </span><span class="annot"><span class="annottext">HsExpr GhcPs
</span><a href="#local-6989586621683065328"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-153"></span><span>
</span><span id="line-154"></span><span>         </span><span class="hs-comment">-- Check for nested brackets</span><span>
</span><span id="line-155"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683065331"><span class="annot"><a href="#local-6989586621683065331"><span class="hs-identifier hs-var">cur_stage</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM ThStage
</span><a href="GHC.Tc.Utils.Monad.html#getStage"><span class="hs-identifier hs-var">getStage</span></a></span><span>
</span><span id="line-156"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683065331"><span class="hs-identifier hs-type">cur_stage</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-157"></span><span>           </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TH.html#Splice"><span class="hs-identifier hs-type">Splice</span></a></span><span> </span><span class="annot"><span class="annottext">SpliceType
</span><span class="hs-identifier">_</span></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; RnM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span>               </span><span class="hs-comment">-- See Note [Untyped quotes in typed splices and vice versa]</span><span>
</span><span id="line-159"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TH.html#RunSplice"><span class="hs-identifier hs-type">RunSplice</span></a></span><span> </span><span class="annot"><span class="annottext">TcRef [ForeignRef (Q ())]
</span><span class="hs-identifier">_</span></span><span>    </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-160"></span><span>               </span><span class="hs-comment">-- See Note [RunSplice ThLevel] in GHC.Tc.Types.</span><span>
</span><span id="line-161"></span><span>               </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; RnM ()
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rnUntypedBracket: Renaming untyped bracket when running a splice&quot;</span></span><span>
</span><span id="line-162"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HsExpr GhcPs -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">HsExpr GhcPs
</span><a href="#local-6989586621683065328"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-163"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">ThStage
</span><a href="GHC.Tc.Types.TH.html#Comp"><span class="hs-identifier hs-var">Comp</span></a></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; RnM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-164"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TH.html#Brack"><span class="hs-identifier hs-type">Brack</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; RnM ()
forall a. TcRnMessage -&gt; TcRn a
</span><a href="GHC.Tc.Utils.Monad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; RnM ()) -&gt; TcRnMessage -&gt; RnM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">THSyntaxError -&gt; TcRnMessage
</span><a href="GHC.Rename.Splice.html#thSyntaxError"><span class="hs-identifier hs-var">thSyntaxError</span></a></span><span>
</span><span id="line-165"></span><span>                                          </span><span class="annot"><span class="annottext">(THSyntaxError -&gt; TcRnMessage) -&gt; THSyntaxError -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">THSyntaxError
</span><a href="GHC.Tc.Errors.Types.html#NestedTHBrackets"><span class="hs-identifier hs-var">NestedTHBrackets</span></a></span><span>
</span><span id="line-166"></span><span>           </span><span class="hs-special">}</span><span>
</span><span id="line-167"></span><span>
</span><span id="line-168"></span><span>         </span><span class="hs-comment">-- Brackets are desugared to code that mentions the TH package</span><span>
</span><span id="line-169"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#recordThUse"><span class="hs-identifier hs-type">recordThUse</span></a></span><span>
</span><span id="line-170"></span><span>
</span><span id="line-171"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceRn"><span class="hs-identifier hs-type">traceRn</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Renaming untyped TH bracket&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#empty"><span class="hs-identifier hs-type">empty</span></a></span><span>
</span><span id="line-172"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683065332"><span class="annot"><a href="#local-6989586621683065332"><span class="hs-identifier hs-var">ps_var</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Data.IOEnv.html#newMutVar"><span class="hs-identifier hs-type">newMutVar</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-173"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683065334"><span class="annot"><a href="#local-6989586621683065334"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683065335"><span class="annot"><a href="#local-6989586621683065335"><span class="hs-identifier hs-var">fvs_e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-174"></span><span>         </span><span class="hs-comment">-- See Note [Rebindable syntax and Template Haskell]</span><span>
</span><span id="line-175"></span><span>         </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#unsetXOptM"><span class="hs-identifier hs-type">unsetXOptM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">LangExt.RebindableSyntax</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-176"></span><span>         </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#setStage"><span class="hs-identifier hs-type">setStage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.TH.html#Brack"><span class="hs-identifier hs-type">Brack</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065331"><span class="hs-identifier hs-type">cur_stage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.TH.html#RnPendingUntyped"><span class="hs-identifier hs-type">RnPendingUntyped</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065332"><span class="hs-identifier hs-type">ps_var</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-177"></span><span>                  </span><span class="annot"><a href="GHC.Rename.Splice.html#rn_utbracket"><span class="hs-identifier hs-type">rn_utbracket</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065331"><span class="hs-identifier hs-type">cur_stage</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065329"><span class="hs-identifier hs-type">br_body</span></a></span><span>
</span><span id="line-178"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683065340"><span class="annot"><a href="#local-6989586621683065340"><span class="hs-identifier hs-var">pendings</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Data.IOEnv.html#readMutVar"><span class="hs-identifier hs-type">readMutVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065332"><span class="hs-identifier hs-type">ps_var</span></a></span><span>
</span><span id="line-179"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsUntypedBracket"><span class="hs-identifier hs-type">HsUntypedBracket</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065340"><span class="hs-identifier hs-type">pendings</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065334"><span class="hs-identifier hs-type">body'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683065335"><span class="hs-identifier hs-type">fvs_e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-180"></span><span>
</span><span id="line-181"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-182"></span><span>
</span><span id="line-183"></span><span class="annot"><a href="GHC.Rename.Splice.html#rn_utbracket"><span class="hs-identifier hs-type">rn_utbracket</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TH.html#ThStage"><span class="hs-identifier hs-type">ThStage</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsQuote"><span class="hs-identifier hs-type">HsQuote</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcPs"><span class="hs-identifier hs-type">GhcPs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#RnM"><span class="hs-identifier hs-type">RnM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsQuote"><span class="hs-identifier hs-type">HsQuote</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html#FreeVars"><span class="hs-identifier hs-type">FreeVars</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-184"></span><span id="rn_utbracket"><span class="annot"><span class="annottext">rn_utbracket :: ThStage
-&gt; HsQuote GhcPs
-&gt; TcRnIf TcGblEnv TcLclEnv (HsQuote (GhcPass 'Renamed), Uses)
</span><a href="GHC.Rename.Splice.html#rn_utbracket"><span class="hs-identifier hs-var hs-var">rn_utbracket</span></a></span></span><span> </span><span id="local-6989586621683065343"><span class="annot"><span class="annottext">ThStage
</span><a href="#local-6989586621683065343"><span class="hs-identifier hs-var">outer_stage</span></a></span></span><span> </span><span id="local-6989586621683065344"><span class="annot"><span class="annottext">br :: HsQuote GhcPs
</span><a href="#local-6989586621683065344"><span class="hs-identifier hs-var">br</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#VarBr"><span class="hs-identifier hs-type">VarBr</span></a></span><span> </span><span class="annot"><span class="annottext">XVarBr GhcPs
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683065346"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683065346"><span class="hs-identifier hs-var">flg</span></a></span></span><span> </span><span id="local-6989586621683065347"><span class="annot"><span class="annottext">LIdP GhcPs
</span><a href="#local-6989586621683065347"><span class="hs-identifier hs-var">rdr_name</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-185"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683065348"><span class="annot"><a href="#local-6989586621683065348"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RdrName -&gt; RnM Name
</span><a href="GHC.Rename.Env.html#lookupOccRn"><span class="hs-identifier hs-var">lookupOccRn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GenLocated SrcSpanAnnN RdrName -&gt; RdrName
forall l e. GenLocated l e -&gt; e
</span><a href="GHC.Types.SrcLoc.html#unLoc"><span class="hs-identifier hs-var">unLoc</span></a></span><span> </span><span class="annot"><span class="annottext">LIdP GhcPs
GenLocated SrcSpanAnnN RdrName
</span><a href="#local-6989586621683065347"><span class="hs-identifier hs-var">rdr_name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-186"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Rename.Splice.html#check_namespace"><span class="hs-identifier hs-type">check_namespace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065346"><span class="hs-identifier hs-type">flg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065348"><span class="hs-identifier hs-type">name</span></a></span><span>
</span><span id="line-187"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683065352"><span class="annot"><a href="#local-6989586621683065352"><span class="hs-identifier hs-var">this_mod</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Unit.Module.html#getModule"><span class="hs-identifier hs-type">getModule</span></a></span><span>
</span><span id="line-188"></span><span>
</span><span id="line-189"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683065346"><span class="hs-identifier hs-type">flg</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&amp;&amp;</span></span><span> </span><span class="annot"><a href="GHC.Types.Name.html#nameIsLocalOrFrom"><span class="hs-identifier hs-type">nameIsLocalOrFrom</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065352"><span class="hs-identifier hs-type">this_mod</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065348"><span class="hs-identifier hs-type">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-190"></span><span>             </span><span class="hs-comment">-- Type variables can be quoted in TH. See #5721.</span><span>
</span><span id="line-191"></span><span>                 </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683065356"><span class="annot"><a href="#local-6989586621683065356"><span class="hs-identifier hs-var">mb_bind_lvl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Rename.Env.html#lookupLocalOccThLvl_maybe"><span class="hs-identifier hs-type">lookupLocalOccThLvl_maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065348"><span class="hs-identifier hs-type">name</span></a></span><span>
</span><span id="line-192"></span><span>                    </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683065356"><span class="hs-identifier hs-type">mb_bind_lvl</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-193"></span><span>                        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Maybe (TopLevelFlag, ThLevel)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; RnM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>      </span><span class="hs-comment">-- Can happen for data constructors,</span><span>
</span><span id="line-194"></span><span>                                                    </span><span class="hs-comment">-- but nothing needs to be done for them</span><span>
</span><span id="line-195"></span><span>
</span><span id="line-196"></span><span>                        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683065358"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621683065358"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683065359"><span class="annot"><span class="annottext">ThLevel
</span><a href="#local-6989586621683065359"><span class="hs-identifier hs-var">bind_lvl</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- See Note [Quoting names]</span><span>
</span><span id="line-197"></span><span>                             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; Bool
</span><a href="GHC.Types.Basic.html#isTopLevel"><span class="hs-identifier hs-var">isTopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621683065358"><span class="hs-identifier hs-var">top_lvl</span></a></span><span>
</span><span id="line-198"></span><span>                             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; RnM () -&gt; RnM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Bool
</span><a href="GHC.Types.Name.html#isExternalName"><span class="hs-identifier hs-var">isExternalName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065348"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; RnM ()
</span><a href="GHC.Tc.Utils.Monad.html#keepAlive"><span class="hs-identifier hs-var">keepAlive</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065348"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-199"></span><span>                             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-200"></span><span>                             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; RnM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rn_utbracket VarBr&quot;</span></span><span>
</span><span id="line-201"></span><span>                                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065348"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ThLevel -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">ThLevel
</span><a href="#local-6989586621683065359"><span class="hs-identifier hs-var">bind_lvl</span></a></span><span>
</span><span id="line-202"></span><span>                                                </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ThStage -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">ThStage
</span><a href="#local-6989586621683065343"><span class="hs-identifier hs-var">outer_stage</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-203"></span><span>                                   </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcRnMessage -&gt; RnM ()
</span><a href="GHC.Tc.Utils.Monad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThStage -&gt; ThLevel
</span><a href="GHC.Tc.Types.TH.html#thLevel"><span class="hs-identifier hs-var">thLevel</span></a></span><span> </span><span class="annot"><span class="annottext">ThStage
</span><a href="#local-6989586621683065343"><span class="hs-identifier hs-var">outer_stage</span></a></span><span> </span><span class="annot"><span class="annottext">ThLevel -&gt; ThLevel -&gt; ThLevel
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">ThLevel
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">ThLevel -&gt; ThLevel -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ThLevel
</span><a href="#local-6989586621683065359"><span class="hs-identifier hs-var">bind_lvl</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; RnM ()) -&gt; TcRnMessage -&gt; RnM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-204"></span><span>                                      </span><span class="annot"><span class="annottext">THError -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnTHError"><span class="hs-identifier hs-var">TcRnTHError</span></a></span><span> </span><span class="annot"><span class="annottext">(THError -&gt; TcRnMessage) -&gt; THError -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">THNameError -&gt; THError
</span><a href="GHC.Tc.Errors.Types.html#THNameError"><span class="hs-identifier hs-var">THNameError</span></a></span><span> </span><span class="annot"><span class="annottext">(THNameError -&gt; THError) -&gt; THNameError -&gt; THError
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HsQuote GhcPs -&gt; THNameError
</span><a href="GHC.Tc.Errors.Types.html#QuotedNameWrongStage"><span class="hs-identifier hs-var">QuotedNameWrongStage</span></a></span><span> </span><span class="annot"><span class="annottext">HsQuote GhcPs
</span><a href="#local-6989586621683065344"><span class="hs-identifier hs-var">br</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-205"></span><span>                        </span><span class="hs-special">}</span><span>
</span><span id="line-206"></span><span>                    </span><span class="hs-special">}</span><span>
</span><span id="line-207"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#VarBr"><span class="hs-identifier hs-type">VarBr</span></a></span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Extension.html#noExtField"><span class="hs-identifier hs-type">noExtField</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065346"><span class="hs-identifier hs-type">flg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Parser.Annotation.html#noLocA"><span class="hs-identifier hs-type">noLocA</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065348"><span class="hs-identifier hs-type">name</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html#unitFV"><span class="hs-identifier hs-type">unitFV</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065348"><span class="hs-identifier hs-type">name</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-208"></span><span>
</span><span id="line-209"></span><span class="annot"><a href="GHC.Rename.Splice.html#rn_utbracket"><span class="hs-identifier hs-var">rn_utbracket</span></a></span><span> </span><span class="annot"><span class="annottext">ThStage
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#ExpBr"><span class="hs-identifier hs-type">ExpBr</span></a></span><span> </span><span class="annot"><span class="annottext">XExpBr GhcPs
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683065372"><span class="annot"><span class="annottext">LHsExpr GhcPs
</span><a href="#local-6989586621683065372"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683065373"><span class="annot"><a href="#local-6989586621683065373"><span class="hs-identifier hs-var">e'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683065374"><span class="annot"><a href="#local-6989586621683065374"><span class="hs-identifier hs-var">fvs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcPs -&gt; TcM (LHsExpr (GhcPass 'Renamed), Uses)
</span><a href="GHC.Rename.Expr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a></span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcPs
</span><a href="#local-6989586621683065372"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-210"></span><span>                                </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#ExpBr"><span class="hs-identifier hs-type">ExpBr</span></a></span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Extension.html#noExtField"><span class="hs-identifier hs-type">noExtField</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065373"><span class="hs-identifier hs-type">e'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683065374"><span class="hs-identifier hs-type">fvs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-211"></span><span>
</span><span id="line-212"></span><span class="annot"><a href="GHC.Rename.Splice.html#rn_utbracket"><span class="hs-identifier hs-var">rn_utbracket</span></a></span><span> </span><span class="annot"><span class="annottext">ThStage
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#PatBr"><span class="hs-identifier hs-type">PatBr</span></a></span><span> </span><span class="annot"><span class="annottext">XPatBr GhcPs
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683065376"><span class="annot"><span class="annottext">LPat GhcPs
</span><a href="#local-6989586621683065376"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-213"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HsMatchContextRn
-&gt; LPat GhcPs
-&gt; (LPat (GhcPass 'Renamed)
    -&gt; TcRnIf TcGblEnv TcLclEnv (HsQuote (GhcPass 'Renamed), Uses))
-&gt; TcRnIf TcGblEnv TcLclEnv (HsQuote (GhcPass 'Renamed), Uses)
forall a.
HsMatchContextRn
-&gt; LPat GhcPs
-&gt; (LPat (GhcPass 'Renamed) -&gt; RnM (a, Uses))
-&gt; RnM (a, Uses)
</span><a href="GHC.Rename.Pat.html#rnPat"><span class="hs-identifier hs-var">rnPat</span></a></span><span> </span><span class="annot"><span class="annottext">HsMatchContextRn
HsMatchContext (GenLocated SrcSpanAnnN Name)
forall fn. HsMatchContext fn
</span><a href="Language.Haskell.Syntax.Expr.html#ThPatQuote"><span class="hs-identifier hs-var">ThPatQuote</span></a></span><span> </span><span class="annot"><span class="annottext">LPat GhcPs
</span><a href="#local-6989586621683065376"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">((LPat (GhcPass 'Renamed)
  -&gt; TcRnIf TcGblEnv TcLclEnv (HsQuote (GhcPass 'Renamed), Uses))
 -&gt; TcRnIf TcGblEnv TcLclEnv (HsQuote (GhcPass 'Renamed), Uses))
-&gt; (LPat (GhcPass 'Renamed)
    -&gt; TcRnIf TcGblEnv TcLclEnv (HsQuote (GhcPass 'Renamed), Uses))
-&gt; TcRnIf TcGblEnv TcLclEnv (HsQuote (GhcPass 'Renamed), Uses)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621683065378"><span class="annot"><span class="annottext">LPat (GhcPass 'Renamed)
</span><a href="#local-6989586621683065378"><span class="hs-identifier hs-var">p'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(HsQuote (GhcPass 'Renamed), Uses)
-&gt; TcRnIf TcGblEnv TcLclEnv (HsQuote (GhcPass 'Renamed), Uses)
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">XPatBr (GhcPass 'Renamed)
-&gt; LPat (GhcPass 'Renamed) -&gt; HsQuote (GhcPass 'Renamed)
forall p. XPatBr p -&gt; LPat p -&gt; HsQuote p
</span><a href="Language.Haskell.Syntax.Expr.html#PatBr"><span class="hs-identifier hs-var">PatBr</span></a></span><span> </span><span class="annot"><span class="annottext">XPatBr (GhcPass 'Renamed)
NoExtField
</span><a href="Language.Haskell.Syntax.Extension.html#noExtField"><span class="hs-identifier hs-var">noExtField</span></a></span><span> </span><span class="annot"><span class="annottext">LPat (GhcPass 'Renamed)
</span><a href="#local-6989586621683065378"><span class="hs-identifier hs-var">p'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Uses
</span><a href="GHC.Types.Name.Set.html#emptyFVs"><span class="hs-identifier hs-var">emptyFVs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-214"></span><span>
</span><span id="line-215"></span><span class="annot"><a href="GHC.Rename.Splice.html#rn_utbracket"><span class="hs-identifier hs-var">rn_utbracket</span></a></span><span> </span><span class="annot"><span class="annottext">ThStage
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#TypBr"><span class="hs-identifier hs-type">TypBr</span></a></span><span> </span><span class="annot"><span class="annottext">XTypBr GhcPs
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683065381"><span class="annot"><span class="annottext">LHsType GhcPs
</span><a href="#local-6989586621683065381"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683065382"><span class="annot"><a href="#local-6989586621683065382"><span class="hs-identifier hs-var">t'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683065383"><span class="annot"><a href="#local-6989586621683065383"><span class="hs-identifier hs-var">fvs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HsDocContext
-&gt; LHsType GhcPs -&gt; RnM (LHsType (GhcPass 'Renamed), Uses)
</span><a href="GHC.Rename.HsType.html#rnLHsType"><span class="hs-identifier hs-var">rnLHsType</span></a></span><span> </span><span class="annot"><span class="annottext">HsDocContext
</span><a href="GHC.Tc.Errors.Types.html#TypBrCtx"><span class="hs-identifier hs-var">TypBrCtx</span></a></span><span> </span><span class="annot"><span class="annottext">LHsType GhcPs
</span><a href="#local-6989586621683065381"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-216"></span><span>                                </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#TypBr"><span class="hs-identifier hs-type">TypBr</span></a></span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Extension.html#noExtField"><span class="hs-identifier hs-type">noExtField</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065382"><span class="hs-identifier hs-type">t'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683065383"><span class="hs-identifier hs-type">fvs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-217"></span><span>
</span><span id="line-218"></span><span class="annot"><a href="GHC.Rename.Splice.html#rn_utbracket"><span class="hs-identifier hs-var">rn_utbracket</span></a></span><span> </span><span class="annot"><span class="annottext">ThStage
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#DecBrL"><span class="hs-identifier hs-type">DecBrL</span></a></span><span> </span><span class="annot"><span class="annottext">XDecBrL GhcPs
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683065386"><span class="annot"><span class="annottext">[LHsDecl GhcPs]
</span><a href="#local-6989586621683065386"><span class="hs-identifier hs-var">decls</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-219"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683065387"><span class="annot"><a href="#local-6989586621683065387"><span class="hs-identifier hs-var">group</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[LHsDecl GhcPs] -&gt; RnM (HsGroup GhcPs)
</span><a href="#local-6989586621683065388"><span class="hs-identifier hs-var">groupDecls</span></a></span><span> </span><span class="annot"><span class="annottext">[LHsDecl GhcPs]
</span><a href="#local-6989586621683065386"><span class="hs-identifier hs-var">decls</span></a></span><span>
</span><span id="line-220"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683065389"><span class="annot"><a href="#local-6989586621683065389"><span class="hs-identifier hs-var">gbl_env</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#getGblEnv"><span class="hs-identifier hs-type">getGblEnv</span></a></span><span>
</span><span id="line-221"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683065391"><span class="annot"><a href="#local-6989586621683065391"><span class="hs-identifier hs-var hs-var">new_gbl_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcGblEnv
</span><a href="#local-6989586621683065389"><span class="hs-identifier hs-var">gbl_env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#tcg_dus"><span class="hs-identifier hs-var">tcg_dus</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html#emptyDUs"><span class="hs-identifier hs-type">emptyDUs</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-222"></span><span>                          </span><span class="hs-comment">-- The emptyDUs is so that we just collect uses for this</span><span>
</span><span id="line-223"></span><span>                          </span><span class="hs-comment">-- group alone in the call to rnSrcDecls below</span><span>
</span><span id="line-224"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683065394"><span class="annot"><a href="#local-6989586621683065394"><span class="hs-identifier hs-var">tcg_env</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683065395"><span class="annot"><a href="#local-6989586621683065395"><span class="hs-identifier hs-var">group'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#setGblEnv"><span class="hs-identifier hs-type">setGblEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065391"><span class="hs-identifier hs-type">new_gbl_env</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-225"></span><span>                              </span><span class="annot"><a href="GHC.Rename.Module.html#rnSrcDecls"><span class="hs-identifier hs-type">rnSrcDecls</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065387"><span class="hs-identifier hs-type">group</span></a></span><span>
</span><span id="line-226"></span><span>
</span><span id="line-227"></span><span>              </span><span class="hs-comment">-- Discard the tcg_env; it contains only extra info about fixity</span><span>
</span><span id="line-228"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceRn"><span class="hs-identifier hs-type">traceRn</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;rn_utbracket dec&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.html#tcg_dus"><span class="hs-identifier hs-var">tcg_dus</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065394"><span class="hs-identifier hs-type">tcg_env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-type">$$</span></a></span><span>
</span><span id="line-229"></span><span>                   </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Name.Set.html#duUses"><span class="hs-identifier hs-type">duUses</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.html#tcg_dus"><span class="hs-identifier hs-var">tcg_dus</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065394"><span class="hs-identifier hs-type">tcg_env</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-230"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#DecBrG"><span class="hs-identifier hs-type">DecBrG</span></a></span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Extension.html#noExtField"><span class="hs-identifier hs-type">noExtField</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065395"><span class="hs-identifier hs-type">group'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html#duUses"><span class="hs-identifier hs-type">duUses</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.html#tcg_dus"><span class="hs-identifier hs-var">tcg_dus</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065394"><span class="hs-identifier hs-type">tcg_env</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-231"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-232"></span><span>    </span><span class="annot"><a href="#local-6989586621683065388"><span class="hs-identifier hs-type">groupDecls</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Haskell.Syntax.Decls.html#LHsDecl"><span class="hs-identifier hs-type">LHsDecl</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcPs"><span class="hs-identifier hs-type">GhcPs</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#RnM"><span class="hs-identifier hs-type">RnM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Decls.html#HsGroup"><span class="hs-identifier hs-type">HsGroup</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcPs"><span class="hs-identifier hs-type">GhcPs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-233"></span><span>    </span><span id="local-6989586621683065388"><span class="annot"><span class="annottext">groupDecls :: [LHsDecl GhcPs] -&gt; RnM (HsGroup GhcPs)
</span><a href="#local-6989586621683065388"><span class="hs-identifier hs-var hs-var">groupDecls</span></a></span></span><span> </span><span id="local-6989586621683065400"><span class="annot"><span class="annottext">[LHsDecl GhcPs]
</span><a href="#local-6989586621683065400"><span class="hs-identifier hs-var">decls</span></a></span></span><span>
</span><span id="line-234"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683065401"><span class="annot"><a href="#local-6989586621683065401"><span class="hs-identifier hs-var">group</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683065402"><span class="annot"><a href="#local-6989586621683065402"><span class="hs-identifier hs-var">mb_splice</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[LHsDecl GhcPs]
-&gt; RnM (HsGroup GhcPs, Maybe (SpliceDecl GhcPs, [LHsDecl GhcPs]))
</span><a href="GHC.Rename.Module.html#findSplice"><span class="hs-identifier hs-var">findSplice</span></a></span><span> </span><span class="annot"><span class="annottext">[LHsDecl GhcPs]
</span><a href="#local-6989586621683065400"><span class="hs-identifier hs-var">decls</span></a></span><span>
</span><span id="line-235"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683065402"><span class="hs-identifier hs-type">mb_splice</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-236"></span><span>           </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Maybe (SpliceDecl GhcPs, [GenLocated SrcSpanAnnA (HsDecl GhcPs)])
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HsGroup GhcPs -&gt; RnM (HsGroup GhcPs)
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">HsGroup GhcPs
</span><a href="#local-6989586621683065401"><span class="hs-identifier hs-var">group</span></a></span><span>
</span><span id="line-237"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683065403"><span class="annot"><span class="annottext">SpliceDecl GhcPs
</span><a href="#local-6989586621683065403"><span class="hs-identifier hs-var">splice</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683065404"><span class="annot"><span class="annottext">[GenLocated SrcSpanAnnA (HsDecl GhcPs)]
</span><a href="#local-6989586621683065404"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-238"></span><span>               </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683065405"><span class="annot"><a href="#local-6989586621683065405"><span class="hs-identifier hs-var">group'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[LHsDecl GhcPs] -&gt; RnM (HsGroup GhcPs)
</span><a href="#local-6989586621683065388"><span class="hs-identifier hs-var">groupDecls</span></a></span><span> </span><span class="annot"><span class="annottext">[LHsDecl GhcPs]
[GenLocated SrcSpanAnnA (HsDecl GhcPs)]
</span><a href="#local-6989586621683065404"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-239"></span><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683065406"><span class="annot"><a href="#local-6989586621683065406"><span class="hs-identifier hs-var hs-var">group''</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HsGroup GhcPs -&gt; HsGroup GhcPs -&gt; HsGroup GhcPs
forall (p :: Pass).
HsGroup (GhcPass p) -&gt; HsGroup (GhcPass p) -&gt; HsGroup (GhcPass p)
</span><a href="GHC.Hs.Decls.html#appendGroups"><span class="hs-identifier hs-var">appendGroups</span></a></span><span> </span><span class="annot"><span class="annottext">HsGroup GhcPs
</span><a href="#local-6989586621683065401"><span class="hs-identifier hs-var">group</span></a></span><span> </span><span class="annot"><span class="annottext">HsGroup GhcPs
</span><a href="#local-6989586621683065405"><span class="hs-identifier hs-var">group'</span></a></span><span>
</span><span id="line-240"></span><span>                  </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683065406"><span class="hs-identifier hs-type">group''</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Decls.html#hs_splcds"><span class="hs-identifier hs-var">hs_splcds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Parser.Annotation.html#noLocA"><span class="hs-identifier hs-type">noLocA</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065403"><span class="hs-identifier hs-type">splice</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Decls.html#hs_splcds"><span class="hs-identifier hs-var">hs_splcds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065405"><span class="hs-identifier hs-type">group'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-241"></span><span>                  </span><span class="hs-special">}</span><span>
</span><span id="line-242"></span><span>           </span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><span id="line-243"></span><span>
</span><span id="line-244"></span><span class="annot"><a href="GHC.Rename.Splice.html#rn_utbracket"><span class="hs-identifier hs-var">rn_utbracket</span></a></span><span> </span><span class="annot"><span class="annottext">ThStage
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#DecBrG"><span class="hs-identifier hs-type">DecBrG</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
-&gt; TcRnIf TcGblEnv TcLclEnv (HsQuote (GhcPass 'Renamed), Uses)
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rn_ut_bracket: unexpected DecBrG&quot;</span></span><span>
</span><span id="line-245"></span><span>
</span><span id="line-246"></span><span>
</span><span id="line-247"></span><span class="hs-comment">-- | Ensure that we are not using a term-level name in a type-level namespace</span><span>
</span><span id="line-248"></span><span class="hs-comment">-- or vice-versa. Throws a 'TcRnIncorrectNameSpace' error if there is a problem.</span><span>
</span><span id="line-249"></span><span class="annot"><a href="GHC.Rename.Splice.html#check_namespace"><span class="hs-identifier hs-type">check_namespace</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#RnM"><span class="hs-identifier hs-type">RnM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-250"></span><span id="check_namespace"><span class="annot"><span class="annottext">check_namespace :: Bool -&gt; Name -&gt; RnM ()
</span><a href="GHC.Rename.Splice.html#check_namespace"><span class="hs-identifier hs-var hs-var">check_namespace</span></a></span></span><span> </span><span id="local-6989586621683065411"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683065411"><span class="hs-identifier hs-var">is_single_tick</span></a></span></span><span> </span><span id="local-6989586621683065412"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065412"><span class="hs-identifier hs-var">nm</span></a></span></span><span>
</span><span id="line-251"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; RnM () -&gt; RnM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NameSpace -&gt; Bool
</span><a href="GHC.Types.Name.Occurrence.html#isValNameSpace"><span class="hs-identifier hs-var">isValNameSpace</span></a></span><span> </span><span class="annot"><span class="annottext">NameSpace
</span><a href="#local-6989586621683065414"><span class="hs-identifier hs-var">ns</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683065411"><span class="hs-identifier hs-var">is_single_tick</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(RnM () -&gt; RnM ()) -&gt; RnM () -&gt; RnM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-252"></span><span>      </span><span class="annot"><span class="annottext">TcRnMessage -&gt; RnM ()
forall a. TcRnMessage -&gt; TcRn a
</span><a href="GHC.Tc.Utils.Monad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; RnM ()) -&gt; TcRnMessage -&gt; RnM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Bool -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnIncorrectNameSpace"><span class="hs-identifier hs-var">TcRnIncorrectNameSpace</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065412"><span class="hs-identifier hs-var">nm</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>
</span><span id="line-253"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-254"></span><span>    </span><span id="local-6989586621683065414"><span class="annot"><span class="annottext">ns :: NameSpace
</span><a href="#local-6989586621683065414"><span class="hs-identifier hs-var hs-var">ns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; NameSpace
</span><a href="GHC.Types.Name.html#nameNameSpace"><span class="hs-identifier hs-var">nameNameSpace</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065412"><span class="hs-identifier hs-var">nm</span></a></span><span>
</span><span id="line-255"></span><span>
</span><span id="line-256"></span><span class="annot"><a href="GHC.Rename.Splice.html#typedQuotationCtxtDoc"><span class="hs-identifier hs-type">typedQuotationCtxtDoc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#LHsExpr"><span class="hs-identifier hs-type">LHsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcPs"><span class="hs-identifier hs-type">GhcPs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span>
</span><span id="line-257"></span><span id="typedQuotationCtxtDoc"><span class="annot"><span class="annottext">typedQuotationCtxtDoc :: LHsExpr GhcPs -&gt; SDoc
</span><a href="GHC.Rename.Splice.html#typedQuotationCtxtDoc"><span class="hs-identifier hs-var hs-var">typedQuotationCtxtDoc</span></a></span></span><span> </span><span id="local-6989586621683065416"><span class="annot"><span class="annottext">LHsExpr GhcPs
</span><a href="#local-6989586621683065416"><span class="hs-identifier hs-var">br_body</span></a></span></span><span>
</span><span id="line-258"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; ThLevel -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;In the Template Haskell typed quotation&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-259"></span><span>         </span><span class="annot"><span class="annottext">ThLevel
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
</span><a href="GHC.Hs.Expr.html#thTyBrackets"><span class="hs-identifier hs-var">thTyBrackets</span></a></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; SDoc) -&gt; (LHsExpr GhcPs -&gt; SDoc) -&gt; LHsExpr GhcPs -&gt; SDoc
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcPs -&gt; SDoc
GenLocated SrcSpanAnnA (HsExpr GhcPs) -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">(LHsExpr GhcPs -&gt; SDoc) -&gt; LHsExpr GhcPs -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcPs
</span><a href="#local-6989586621683065416"><span class="hs-identifier hs-var">br_body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-260"></span><span>
</span><span id="line-261"></span><span class="annot"><a href="GHC.Rename.Splice.html#untypedQuotationCtxtDoc"><span class="hs-identifier hs-type">untypedQuotationCtxtDoc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsQuote"><span class="hs-identifier hs-type">HsQuote</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcPs"><span class="hs-identifier hs-type">GhcPs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span>
</span><span id="line-262"></span><span id="untypedQuotationCtxtDoc"><span class="annot"><span class="annottext">untypedQuotationCtxtDoc :: HsQuote GhcPs -&gt; SDoc
</span><a href="GHC.Rename.Splice.html#untypedQuotationCtxtDoc"><span class="hs-identifier hs-var hs-var">untypedQuotationCtxtDoc</span></a></span></span><span> </span><span id="local-6989586621683065421"><span class="annot"><span class="annottext">HsQuote GhcPs
</span><a href="#local-6989586621683065421"><span class="hs-identifier hs-var">br_body</span></a></span></span><span>
</span><span id="line-263"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; ThLevel -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;In the Template Haskell quotation&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-264"></span><span>         </span><span class="annot"><span class="annottext">ThLevel
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HsQuote GhcPs -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">HsQuote GhcPs
</span><a href="#local-6989586621683065421"><span class="hs-identifier hs-var">br_body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-265"></span><span>
</span><span id="line-266"></span><span class="hs-comment">{-
*********************************************************
*                                                      *
                Splices
*                                                      *
*********************************************************

Note [Free variables of typed splices]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider renaming this:
        f = ...
        h = ...$(thing &quot;f&quot;)...

where the splice is a *typed* splice.  The splice can expand into
literally anything, so when we do dependency analysis we must assume
that it might mention 'f'.  So we simply treat all locally-defined
names as mentioned by any splice.  This is terribly brutal, but I
don't see what else to do.  For example, it'll mean that every
locally-defined thing will appear to be used, so no unused-binding
warnings.  But if we miss the dependency, then we might typecheck 'h'
before 'f', and that will crash the type checker because 'f' isn't in
scope.

Currently, I'm not treating a splice as also mentioning every import,
which is a bit inconsistent -- but there are a lot of them.  We might
thereby get some bogus unused-import warnings, but we won't crash the
type checker.  Not very satisfactory really.

Note [Renamer errors]
~~~~~~~~~~~~~~~~~~~~~
It's important to wrap renamer calls in checkNoErrs, because the
renamer does not fail for out of scope variables etc. Instead it
returns a bogus term/type, so that it can report more than one error.
We don't want the type checker to see these bogus unbound variables.
-}</span><span>
</span><span id="line-301"></span><span>
</span><span id="line-302"></span><span id="local-6989586621683064868"><span class="annot"><a href="GHC.Rename.Splice.html#rnUntypedSpliceGen"><span class="hs-identifier hs-type">rnUntypedSpliceGen</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsUntypedSplice"><span class="hs-identifier hs-type">HsUntypedSplice</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#RnM"><span class="hs-identifier hs-type">RnM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683064868"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html#FreeVars"><span class="hs-identifier hs-type">FreeVars</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-303"></span><span>                                                    </span><span class="hs-comment">-- Outside brackets, run splice</span><span>
</span><span id="line-304"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsUntypedSplice"><span class="hs-identifier hs-type">HsUntypedSplice</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Hs.Expr.html#PendingRnSplice"><span class="hs-identifier hs-type">PendingRnSplice</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683064868"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-305"></span><span>                                                   </span><span class="hs-comment">-- Inside brackets, make it pending</span><span>
</span><span id="line-306"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsUntypedSplice"><span class="hs-identifier hs-type">HsUntypedSplice</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcPs"><span class="hs-identifier hs-type">GhcPs</span></a></span><span>
</span><span id="line-307"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#RnM"><span class="hs-identifier hs-type">RnM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683064868"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html#FreeVars"><span class="hs-identifier hs-type">FreeVars</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-308"></span><span id="rnUntypedSpliceGen"><span class="annot"><span class="annottext">rnUntypedSpliceGen :: forall a.
(HsUntypedSplice (GhcPass 'Renamed) -&gt; RnM (a, Uses))
-&gt; (Name
    -&gt; HsUntypedSplice (GhcPass 'Renamed) -&gt; (PendingRnSplice, a))
-&gt; HsUntypedSplice GhcPs
-&gt; RnM (a, Uses)
</span><a href="GHC.Rename.Splice.html#rnUntypedSpliceGen"><span class="hs-identifier hs-var hs-var">rnUntypedSpliceGen</span></a></span></span><span> </span><span id="local-6989586621683065435"><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed) -&gt; RnM (a, Uses)
</span><a href="#local-6989586621683065435"><span class="hs-identifier hs-var">run_splice</span></a></span></span><span> </span><span id="local-6989586621683065436"><span class="annot"><span class="annottext">Name -&gt; HsUntypedSplice (GhcPass 'Renamed) -&gt; (PendingRnSplice, a)
</span><a href="#local-6989586621683065436"><span class="hs-identifier hs-var">pend_splice</span></a></span></span><span> </span><span id="local-6989586621683065437"><span class="annot"><span class="annottext">HsUntypedSplice GhcPs
</span><a href="#local-6989586621683065437"><span class="hs-identifier hs-var">splice</span></a></span></span><span>
</span><span id="line-309"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; RnM (a, Uses) -&gt; RnM (a, Uses)
forall a. SDoc -&gt; TcM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HsUntypedSplice GhcPs -&gt; SDoc
</span><a href="GHC.Rename.Splice.html#spliceCtxt"><span class="hs-identifier hs-var">spliceCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice GhcPs
</span><a href="#local-6989586621683065437"><span class="hs-identifier hs-var">splice</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(RnM (a, Uses) -&gt; RnM (a, Uses)) -&gt; RnM (a, Uses) -&gt; RnM (a, Uses)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-310"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683065439"><span class="annot"><a href="#local-6989586621683065439"><span class="hs-identifier hs-var">stage</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM ThStage
</span><a href="GHC.Tc.Utils.Monad.html#getStage"><span class="hs-identifier hs-var">getStage</span></a></span><span>
</span><span id="line-311"></span><span>    </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683065439"><span class="hs-identifier hs-type">stage</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-312"></span><span>        </span><span class="annot"><a href="GHC.Tc.Types.TH.html#Brack"><span class="hs-identifier hs-type">Brack</span></a></span><span> </span><span class="annot"><span class="annottext">ThStage
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">PendingStuff
</span><a href="GHC.Tc.Types.TH.html#RnPendingTyped"><span class="hs-identifier hs-var">RnPendingTyped</span></a></span><span>
</span><span id="line-313"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; RnM (a, Uses)
forall a. TcRnMessage -&gt; TcRn a
</span><a href="GHC.Tc.Utils.Monad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; RnM (a, Uses)) -&gt; TcRnMessage -&gt; RnM (a, Uses)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">THSyntaxError -&gt; TcRnMessage
</span><a href="GHC.Rename.Splice.html#thSyntaxError"><span class="hs-identifier hs-var">thSyntaxError</span></a></span><span>
</span><span id="line-314"></span><span>                        </span><span class="annot"><span class="annottext">(THSyntaxError -&gt; TcRnMessage) -&gt; THSyntaxError -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SpliceType -&gt; SpliceOrBracket -&gt; THSyntaxError
</span><a href="GHC.Tc.Errors.Types.html#MismatchedSpliceType"><span class="hs-identifier hs-var">MismatchedSpliceType</span></a></span><span> </span><span class="annot"><span class="annottext">SpliceType
</span><a href="GHC.Tc.Types.TH.html#Untyped"><span class="hs-identifier hs-var">Untyped</span></a></span><span> </span><span class="annot"><span class="annottext">SpliceOrBracket
</span><a href="GHC.Tc.Types.TH.html#IsSplice"><span class="hs-identifier hs-var">IsSplice</span></a></span><span>
</span><span id="line-315"></span><span>
</span><span id="line-316"></span><span>        </span><span class="annot"><a href="GHC.Tc.Types.TH.html#Brack"><span class="hs-identifier hs-type">Brack</span></a></span><span> </span><span id="local-6989586621683065443"><span class="annot"><span class="annottext">ThStage
</span><a href="#local-6989586621683065443"><span class="hs-identifier hs-var">pop_stage</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.TH.html#RnPendingUntyped"><span class="hs-identifier hs-type">RnPendingUntyped</span></a></span><span> </span><span id="local-6989586621683065444"><span class="annot"><span class="annottext">IORef [PendingRnSplice]
</span><a href="#local-6989586621683065444"><span class="hs-identifier hs-var">ps_var</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-317"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683065445"><span class="annot"><a href="#local-6989586621683065445"><span class="hs-identifier hs-var">splice'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683065446"><span class="annot"><a href="#local-6989586621683065446"><span class="hs-identifier hs-var">fvs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ThStage
-&gt; TcM (HsUntypedSplice (GhcPass 'Renamed), Uses)
-&gt; TcM (HsUntypedSplice (GhcPass 'Renamed), Uses)
forall a. ThStage -&gt; TcM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#setStage"><span class="hs-identifier hs-var">setStage</span></a></span><span> </span><span class="annot"><span class="annottext">ThStage
</span><a href="#local-6989586621683065443"><span class="hs-identifier hs-var">pop_stage</span></a></span><span> </span><span class="annot"><span class="annottext">(TcM (HsUntypedSplice (GhcPass 'Renamed), Uses)
 -&gt; TcM (HsUntypedSplice (GhcPass 'Renamed), Uses))
-&gt; TcM (HsUntypedSplice (GhcPass 'Renamed), Uses)
-&gt; TcM (HsUntypedSplice (GhcPass 'Renamed), Uses)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-318"></span><span>                                    </span><span class="annot"><span class="annottext">HsUntypedSplice GhcPs
-&gt; TcM (HsUntypedSplice (GhcPass 'Renamed), Uses)
</span><a href="GHC.Rename.Splice.html#rnUntypedSplice"><span class="hs-identifier hs-var">rnUntypedSplice</span></a></span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice GhcPs
</span><a href="#local-6989586621683065437"><span class="hs-identifier hs-var">splice</span></a></span><span>
</span><span id="line-319"></span><span>                </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683065448"><span class="annot"><a href="#local-6989586621683065448"><span class="hs-identifier hs-var">loc</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#getSrcSpanM"><span class="hs-identifier hs-type">getSrcSpanM</span></a></span><span>
</span><span id="line-320"></span><span>                </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683065450"><span class="annot"><a href="#local-6989586621683065450"><span class="hs-identifier hs-var">splice_name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Rename.Utils.html#newLocalBndrRn"><span class="hs-identifier hs-type">newLocalBndrRn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.SrcLoc.html#L"><span class="hs-identifier hs-type">L</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Parser.Annotation.html#noAnnSrcSpan"><span class="hs-identifier hs-type">noAnnSrcSpan</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065448"><span class="hs-identifier hs-type">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="GHC.Rename.Splice.html#unqualSplice"><span class="hs-identifier hs-type">unqualSplice</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-321"></span><span>                </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683065454"><span class="annot"><a href="#local-6989586621683065454"><span class="hs-identifier hs-var">pending_splice</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683065455"><span class="annot"><a href="#local-6989586621683065455"><span class="hs-identifier hs-var">result</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683065436"><span class="hs-identifier hs-type">pend_splice</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065450"><span class="hs-identifier hs-type">splice_name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065445"><span class="hs-identifier hs-type">splice'</span></a></span><span>
</span><span id="line-322"></span><span>                </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683065456"><span class="annot"><a href="#local-6989586621683065456"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Data.IOEnv.html#readMutVar"><span class="hs-identifier hs-type">readMutVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065444"><span class="hs-identifier hs-type">ps_var</span></a></span><span>
</span><span id="line-323"></span><span>                </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Data.IOEnv.html#writeMutVar"><span class="hs-identifier hs-type">writeMutVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065444"><span class="hs-identifier hs-type">ps_var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683065454"><span class="hs-identifier hs-type">pending_splice</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="#local-6989586621683065456"><span class="hs-identifier hs-type">ps</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-324"></span><span>                </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683065455"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683065446"><span class="hs-identifier hs-type">fvs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-325"></span><span>
</span><span id="line-326"></span><span>        </span><span class="annot"><span class="annottext">ThStage
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice GhcPs -&gt; RnM ()
</span><a href="GHC.Rename.Splice.html#checkTopSpliceAllowed"><span class="hs-identifier hs-var">checkTopSpliceAllowed</span></a></span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice GhcPs
</span><a href="#local-6989586621683065437"><span class="hs-identifier hs-var">splice</span></a></span><span>
</span><span id="line-327"></span><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683065459"><span class="annot"><a href="#local-6989586621683065459"><span class="hs-identifier hs-var">splice'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683065460"><span class="annot"><a href="#local-6989586621683065460"><span class="hs-identifier hs-var">fvs1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM (HsUntypedSplice (GhcPass 'Renamed), Uses)
-&gt; TcM (HsUntypedSplice (GhcPass 'Renamed), Uses)
forall r. TcM r -&gt; TcM r
</span><a href="GHC.Tc.Utils.Monad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a></span><span> </span><span class="annot"><span class="annottext">(TcM (HsUntypedSplice (GhcPass 'Renamed), Uses)
 -&gt; TcM (HsUntypedSplice (GhcPass 'Renamed), Uses))
-&gt; TcM (HsUntypedSplice (GhcPass 'Renamed), Uses)
-&gt; TcM (HsUntypedSplice (GhcPass 'Renamed), Uses)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-328"></span><span>                                      </span><span class="annot"><span class="annottext">ThStage
-&gt; TcM (HsUntypedSplice (GhcPass 'Renamed), Uses)
-&gt; TcM (HsUntypedSplice (GhcPass 'Renamed), Uses)
forall a. ThStage -&gt; TcM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#setStage"><span class="hs-identifier hs-var">setStage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpliceType -&gt; ThStage
</span><a href="GHC.Tc.Types.TH.html#Splice"><span class="hs-identifier hs-var">Splice</span></a></span><span> </span><span class="annot"><span class="annottext">SpliceType
</span><a href="GHC.Tc.Types.TH.html#Untyped"><span class="hs-identifier hs-var">Untyped</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcM (HsUntypedSplice (GhcPass 'Renamed), Uses)
 -&gt; TcM (HsUntypedSplice (GhcPass 'Renamed), Uses))
-&gt; TcM (HsUntypedSplice (GhcPass 'Renamed), Uses)
-&gt; TcM (HsUntypedSplice (GhcPass 'Renamed), Uses)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-329"></span><span>                                      </span><span class="annot"><span class="annottext">HsUntypedSplice GhcPs
-&gt; TcM (HsUntypedSplice (GhcPass 'Renamed), Uses)
</span><a href="GHC.Rename.Splice.html#rnUntypedSplice"><span class="hs-identifier hs-var">rnUntypedSplice</span></a></span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice GhcPs
</span><a href="#local-6989586621683065437"><span class="hs-identifier hs-var">splice</span></a></span><span>
</span><span id="line-330"></span><span>                   </span><span class="hs-comment">-- checkNoErrs: don't attempt to run the splice if</span><span>
</span><span id="line-331"></span><span>                   </span><span class="hs-comment">-- renaming it failed; otherwise we get a cascade of</span><span>
</span><span id="line-332"></span><span>                   </span><span class="hs-comment">-- errors from e.g. unbound variables</span><span>
</span><span id="line-333"></span><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683065462"><span class="annot"><a href="#local-6989586621683065462"><span class="hs-identifier hs-var">result</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683065463"><span class="annot"><a href="#local-6989586621683065463"><span class="hs-identifier hs-var">fvs2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621683065435"><span class="hs-identifier hs-type">run_splice</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065459"><span class="hs-identifier hs-type">splice'</span></a></span><span>
</span><span id="line-334"></span><span>                 </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683065462"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683065460"><span class="hs-identifier hs-type">fvs1</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html#plusFV"><span class="hs-operator hs-type">`plusFV`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065463"><span class="hs-identifier hs-type">fvs2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-335"></span><span>
</span><span id="line-336"></span><span>
</span><span id="line-337"></span><span class="hs-comment">-- Nested splices are fine without TemplateHaskell because they</span><span>
</span><span id="line-338"></span><span class="hs-comment">-- are not executed until the top-level splice is run.</span><span>
</span><span id="line-339"></span><span class="annot"><a href="GHC.Rename.Splice.html#checkTopSpliceAllowed"><span class="hs-identifier hs-type">checkTopSpliceAllowed</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsUntypedSplice"><span class="hs-identifier hs-type">HsUntypedSplice</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcPs"><span class="hs-identifier hs-type">GhcPs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#RnM"><span class="hs-identifier hs-type">RnM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-340"></span><span id="checkTopSpliceAllowed"><span class="annot"><span class="annottext">checkTopSpliceAllowed :: HsUntypedSplice GhcPs -&gt; RnM ()
</span><a href="GHC.Rename.Splice.html#checkTopSpliceAllowed"><span class="hs-identifier hs-var hs-var">checkTopSpliceAllowed</span></a></span></span><span> </span><span id="local-6989586621683065465"><span class="annot"><span class="annottext">HsUntypedSplice GhcPs
</span><a href="#local-6989586621683065465"><span class="hs-identifier hs-var">splice</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-341"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683065466"><span class="annot"><span class="annottext">Extension
</span><a href="#local-6989586621683065466"><span class="hs-identifier hs-var">ext</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683065467"><span class="annot"><span class="annottext">TcRnMessage
</span><a href="#local-6989586621683065467"><span class="hs-identifier hs-var">err</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice GhcPs -&gt; (Extension, TcRnMessage)
</span><a href="#local-6989586621683065468"><span class="hs-identifier hs-var">spliceExtension</span></a></span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice GhcPs
</span><a href="#local-6989586621683065465"><span class="hs-identifier hs-var">splice</span></a></span><span>
</span><span id="line-342"></span><span>  </span><span class="annot"><span class="annottext">Extension -&gt; RnM () -&gt; RnM ()
forall gbl lcl. Extension -&gt; TcRnIf gbl lcl () -&gt; TcRnIf gbl lcl ()
</span><a href="GHC.Tc.Utils.Monad.html#unlessXOptM"><span class="hs-identifier hs-var">unlessXOptM</span></a></span><span> </span><span class="annot"><span class="annottext">Extension
</span><a href="#local-6989586621683065466"><span class="hs-identifier hs-var">ext</span></a></span><span> </span><span class="annot"><span class="annottext">(RnM () -&gt; RnM ()) -&gt; RnM () -&gt; RnM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; RnM ()
forall a. TcRnMessage -&gt; TcRn a
</span><a href="GHC.Tc.Utils.Monad.html#failWith"><span class="hs-identifier hs-var">failWith</span></a></span><span> </span><span class="annot"><span class="annottext">TcRnMessage
</span><a href="#local-6989586621683065467"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-343"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-344"></span><span>    </span><span class="annot"><a href="#local-6989586621683065468"><span class="hs-identifier hs-type">spliceExtension</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsUntypedSplice"><span class="hs-identifier hs-type">HsUntypedSplice</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcPs"><span class="hs-identifier hs-type">GhcPs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">LangExt.Extension</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Errors.Types.html#TcRnMessage"><span class="hs-identifier hs-type">TcRnMessage</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-345"></span><span>    </span><span id="local-6989586621683065468"><span class="annot"><span class="annottext">spliceExtension :: HsUntypedSplice GhcPs -&gt; (Extension, TcRnMessage)
</span><a href="#local-6989586621683065468"><span class="hs-identifier hs-var hs-var">spliceExtension</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsQuasiQuote"><span class="hs-identifier hs-type">HsQuasiQuote</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-346"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Extension
</span><span class="hs-identifier hs-var">LangExt.QuasiQuotes</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnIllegalQuasiQuotes"><span class="hs-identifier hs-var">TcRnIllegalQuasiQuotes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-347"></span><span>    </span><span class="annot"><a href="#local-6989586621683065468"><span class="hs-identifier hs-var">spliceExtension</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsUntypedSpliceExpr"><span class="hs-identifier hs-type">HsUntypedSpliceExpr</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-348"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Extension
</span><span class="hs-identifier hs-var">LangExt.TemplateHaskell</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">THSyntaxError -&gt; TcRnMessage
</span><a href="GHC.Rename.Splice.html#thSyntaxError"><span class="hs-identifier hs-var">thSyntaxError</span></a></span><span> </span><span class="annot"><span class="annottext">(THSyntaxError -&gt; TcRnMessage) -&gt; THSyntaxError -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">THSyntaxError
</span><a href="GHC.Tc.Errors.Types.html#IllegalTHSplice"><span class="hs-identifier hs-var">IllegalTHSplice</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-349"></span><span>
</span><span id="line-350"></span><span class="hs-comment">------------------</span><span>
</span><span id="line-351"></span><span>
</span><span id="line-352"></span><span class="hs-comment">-- | Returns the result of running a splice and the modFinalizers collected</span><span>
</span><span id="line-353"></span><span class="hs-comment">-- during the execution.</span><span>
</span><span id="line-354"></span><span class="hs-comment">--</span><span>
</span><span id="line-355"></span><span class="hs-comment">-- See Note [Delaying modFinalizers in untyped splices].</span><span>
</span><span id="line-356"></span><span id="local-6989586621683064879"><span class="annot"><a href="GHC.Rename.Splice.html#runRnSplice"><span class="hs-identifier hs-type">runRnSplice</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Hs.Expr.html#UntypedSpliceFlavour"><span class="hs-identifier hs-type">UntypedSpliceFlavour</span></a></span><span>
</span><span id="line-357"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#LHsExpr"><span class="hs-identifier hs-type">LHsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcTc"><span class="hs-identifier hs-type">GhcTc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcRn"><span class="hs-identifier hs-type">TcRn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683064879"><span class="hs-identifier hs-type">res</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-358"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683064879"><span class="hs-identifier hs-type">res</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- How to pretty-print res</span><span>
</span><span id="line-359"></span><span>                                </span><span class="hs-comment">-- Usually just ppr, but not for [Decl]</span><span>
</span><span id="line-360"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsUntypedSplice"><span class="hs-identifier hs-type">HsUntypedSplice</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span>
</span><span id="line-361"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcRn"><span class="hs-identifier hs-type">TcRn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683064879"><span class="hs-identifier hs-type">res</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html#ForeignRef"><span class="hs-identifier hs-type">ForeignRef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.Q</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-362"></span><span id="runRnSplice"><span class="annot"><span class="annottext">runRnSplice :: forall res.
UntypedSpliceFlavour
-&gt; (LHsExpr GhcTc -&gt; TcRn res)
-&gt; (res -&gt; SDoc)
-&gt; HsUntypedSplice (GhcPass 'Renamed)
-&gt; TcRn (res, [ForeignRef (Q ())])
</span><a href="GHC.Rename.Splice.html#runRnSplice"><span class="hs-identifier hs-var hs-var">runRnSplice</span></a></span></span><span> </span><span id="local-6989586621683065490"><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="#local-6989586621683065490"><span class="hs-identifier hs-var">flavour</span></a></span></span><span> </span><span id="local-6989586621683065491"><span class="annot"><span class="annottext">LHsExpr GhcTc -&gt; TcRn res
</span><a href="#local-6989586621683065491"><span class="hs-identifier hs-var">run_meta</span></a></span></span><span> </span><span id="local-6989586621683065492"><span class="annot"><span class="annottext">res -&gt; SDoc
</span><a href="#local-6989586621683065492"><span class="hs-identifier hs-var">ppr_res</span></a></span></span><span> </span><span id="local-6989586621683065493"><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
</span><a href="#local-6989586621683065493"><span class="hs-identifier hs-var">splice</span></a></span></span><span>
</span><span id="line-363"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683065494"><span class="annot"><a href="#local-6989586621683065494"><span class="hs-identifier hs-var">hooks</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; Hooks
</span><a href="GHC.Driver.Env.Types.html#hsc_hooks"><span class="hs-identifier hs-var">hsc_hooks</span></a></span><span> </span><span class="annot"><span class="annottext">(HscEnv -&gt; Hooks)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) HscEnv
-&gt; IOEnv (Env TcGblEnv TcLclEnv) Hooks
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IOEnv (Env TcGblEnv TcLclEnv) HscEnv
forall gbl lcl. TcRnIf gbl lcl HscEnv
</span><a href="GHC.Tc.Utils.Monad.html#getTopEnv"><span class="hs-identifier hs-var">getTopEnv</span></a></span><span>
</span><span id="line-364"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683065498"><span class="annot"><a href="#local-6989586621683065498"><span class="hs-identifier hs-var">splice'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="GHC.Driver.Hooks.html#runRnSpliceHook"><span class="hs-identifier hs-var">runRnSpliceHook</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065494"><span class="hs-identifier hs-type">hooks</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-365"></span><span>            </span><span class="annot"><span class="annottext">Maybe
  (HsUntypedSplice (GhcPass 'Renamed)
   -&gt; IOEnv
        (Env TcGblEnv TcLclEnv) (HsUntypedSplice (GhcPass 'Renamed)))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
-&gt; IOEnv
     (Env TcGblEnv TcLclEnv) (HsUntypedSplice (GhcPass 'Renamed))
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
</span><a href="#local-6989586621683065493"><span class="hs-identifier hs-var">splice</span></a></span><span>
</span><span id="line-366"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683065500"><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
-&gt; IOEnv
     (Env TcGblEnv TcLclEnv) (HsUntypedSplice (GhcPass 'Renamed))
</span><a href="#local-6989586621683065500"><span class="hs-identifier hs-var">h</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
-&gt; IOEnv
     (Env TcGblEnv TcLclEnv) (HsUntypedSplice (GhcPass 'Renamed))
</span><a href="#local-6989586621683065500"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
</span><a href="#local-6989586621683065493"><span class="hs-identifier hs-var">splice</span></a></span><span>
</span><span id="line-367"></span><span>
</span><span id="line-368"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683065501"><span class="annot"><a href="#local-6989586621683065501"><span class="hs-identifier hs-var hs-var">the_expr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
</span><a href="#local-6989586621683065498"><span class="hs-identifier hs-var">splice'</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-369"></span><span>                </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsUntypedSpliceExpr"><span class="hs-identifier hs-type">HsUntypedSpliceExpr</span></a></span><span> </span><span class="annot"><span class="annottext">XUntypedSpliceExpr (GhcPass 'Renamed)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683065502"><span class="annot"><span class="annottext">LHsExpr (GhcPass 'Renamed)
</span><a href="#local-6989586621683065502"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="annot"><span class="annottext">LHsExpr (GhcPass 'Renamed)
</span><a href="#local-6989586621683065502"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-370"></span><span>                </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsQuasiQuote"><span class="hs-identifier hs-type">HsQuasiQuote</span></a></span><span> </span><span class="annot"><span class="annottext">XQuasiQuote (GhcPass 'Renamed)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683065503"><span class="annot"><span class="annottext">IdP (GhcPass 'Renamed)
</span><a href="#local-6989586621683065503"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span id="local-6989586621683065504"><span class="annot"><span class="annottext">XRec (GhcPass 'Renamed) FastString
</span><a href="#local-6989586621683065504"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
-&gt; Name -&gt; XRec GhcPs FastString -&gt; LHsExpr (GhcPass 'Renamed)
</span><a href="GHC.Rename.Splice.html#mkQuasiQuoteExpr"><span class="hs-identifier hs-var">mkQuasiQuoteExpr</span></a></span><span> </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="#local-6989586621683065490"><span class="hs-identifier hs-var">flavour</span></a></span><span> </span><span class="annot"><span class="annottext">IdP (GhcPass 'Renamed)
Name
</span><a href="#local-6989586621683065503"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">XRec GhcPs FastString
XRec (GhcPass 'Renamed) FastString
</span><a href="#local-6989586621683065504"><span class="hs-identifier hs-var">str</span></a></span><span>
</span><span id="line-371"></span><span>
</span><span id="line-372"></span><span>             </span><span class="hs-comment">-- Typecheck the expression</span><span>
</span><span id="line-373"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683065506"><span class="annot"><a href="#local-6989586621683065506"><span class="hs-identifier hs-var">meta_exp_ty</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Env.html#tcMetaTy"><span class="hs-identifier hs-type">tcMetaTy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065507"><span class="hs-identifier hs-type">meta_ty_name</span></a></span><span>
</span><span id="line-374"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683065508"><span class="annot"><a href="#local-6989586621683065508"><span class="hs-identifier hs-var">zonked_q_expr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Zonk.Type.html#zonkTopLExpr"><span class="hs-identifier hs-type">zonkTopLExpr</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">=&lt;&lt;</span></span><span>
</span><span id="line-375"></span><span>                            </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#tcTopSpliceExpr"><span class="hs-identifier hs-type">tcTopSpliceExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.TH.html#Untyped"><span class="hs-identifier hs-type">Untyped</span></a></span><span>
</span><span id="line-376"></span><span>                              </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Gen.Expr.html#tcCheckPolyExpr"><span class="hs-identifier hs-type">tcCheckPolyExpr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065501"><span class="hs-identifier hs-type">the_expr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065506"><span class="hs-identifier hs-type">meta_exp_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-377"></span><span>
</span><span id="line-378"></span><span>             </span><span class="hs-comment">-- Run the expression</span><span>
</span><span id="line-379"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683065511"><span class="annot"><a href="#local-6989586621683065511"><span class="hs-identifier hs-var">mod_finalizers_ref</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TcRef.html#newTcRef"><span class="hs-identifier hs-type">newTcRef</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-380"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683065513"><span class="annot"><a href="#local-6989586621683065513"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#setStage"><span class="hs-identifier hs-type">setStage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.TH.html#RunSplice"><span class="hs-identifier hs-type">RunSplice</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065511"><span class="hs-identifier hs-type">mod_finalizers_ref</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-381"></span><span>                     </span><span class="annot"><a href="#local-6989586621683065491"><span class="hs-identifier hs-type">run_meta</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065508"><span class="hs-identifier hs-type">zonked_q_expr</span></a></span><span>
</span><span id="line-382"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683065514"><span class="annot"><a href="#local-6989586621683065514"><span class="hs-identifier hs-var">mod_finalizers</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TcRef.html#readTcRef"><span class="hs-identifier hs-type">readTcRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065511"><span class="hs-identifier hs-type">mod_finalizers_ref</span></a></span><span>
</span><span id="line-383"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Rename.Splice.html#traceSplice"><span class="hs-identifier hs-type">traceSplice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Rename.Splice.html#SpliceInfo"><span class="hs-identifier hs-type">SpliceInfo</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Rename.Splice.html#spliceDescription"><span class="hs-identifier hs-var">spliceDescription</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683065518"><span class="hs-identifier hs-type">what</span></a></span><span>
</span><span id="line-384"></span><span>                                 </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Rename.Splice.html#spliceIsDecl"><span class="hs-identifier hs-var">spliceIsDecl</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683065520"><span class="hs-identifier hs-type">is_decl</span></a></span><span>
</span><span id="line-385"></span><span>                                 </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Rename.Splice.html#spliceSource"><span class="hs-identifier hs-var">spliceSource</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="#local-6989586621683065501"><span class="hs-identifier hs-type">the_expr</span></a></span><span>
</span><span id="line-386"></span><span>                                 </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Rename.Splice.html#spliceGenerated"><span class="hs-identifier hs-var">spliceGenerated</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683065492"><span class="hs-identifier hs-type">ppr_res</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065513"><span class="hs-identifier hs-type">result</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-387"></span><span>
</span><span id="line-388"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683065513"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683065514"><span class="hs-identifier hs-type">mod_finalizers</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-389"></span><span>
</span><span id="line-390"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-391"></span><span>    </span><span id="local-6989586621683065507"><span class="annot"><span class="annottext">meta_ty_name :: Name
</span><a href="#local-6989586621683065507"><span class="hs-identifier hs-var hs-var">meta_ty_name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="#local-6989586621683065490"><span class="hs-identifier hs-var">flavour</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-392"></span><span>                       </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="GHC.Hs.Expr.html#UntypedExpSplice"><span class="hs-identifier hs-var">UntypedExpSplice</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.TH.html#expQTyConName"><span class="hs-identifier hs-var">expQTyConName</span></a></span><span>
</span><span id="line-393"></span><span>                       </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="GHC.Hs.Expr.html#UntypedPatSplice"><span class="hs-identifier hs-var">UntypedPatSplice</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.TH.html#patQTyConName"><span class="hs-identifier hs-var">patQTyConName</span></a></span><span>
</span><span id="line-394"></span><span>                       </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="GHC.Hs.Expr.html#UntypedTypeSplice"><span class="hs-identifier hs-var">UntypedTypeSplice</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.TH.html#typeQTyConName"><span class="hs-identifier hs-var">typeQTyConName</span></a></span><span>
</span><span id="line-395"></span><span>                       </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="GHC.Hs.Expr.html#UntypedDeclSplice"><span class="hs-identifier hs-var">UntypedDeclSplice</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.TH.html#decsQTyConName"><span class="hs-identifier hs-var">decsQTyConName</span></a></span><span>
</span><span id="line-396"></span><span>    </span><span id="local-6989586621683065518"><span class="annot"><span class="annottext">what :: String
</span><a href="#local-6989586621683065518"><span class="hs-identifier hs-var hs-var">what</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="#local-6989586621683065490"><span class="hs-identifier hs-var">flavour</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-397"></span><span>                  </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="GHC.Hs.Expr.html#UntypedExpSplice"><span class="hs-identifier hs-var">UntypedExpSplice</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;expression&quot;</span></span><span>
</span><span id="line-398"></span><span>                  </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="GHC.Hs.Expr.html#UntypedPatSplice"><span class="hs-identifier hs-var">UntypedPatSplice</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;pattern&quot;</span></span><span>
</span><span id="line-399"></span><span>                  </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="GHC.Hs.Expr.html#UntypedTypeSplice"><span class="hs-identifier hs-var">UntypedTypeSplice</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;type&quot;</span></span><span>
</span><span id="line-400"></span><span>                  </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="GHC.Hs.Expr.html#UntypedDeclSplice"><span class="hs-identifier hs-var">UntypedDeclSplice</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;declarations&quot;</span></span><span>
</span><span id="line-401"></span><span>    </span><span id="local-6989586621683065520"><span class="annot"><span class="annottext">is_decl :: Bool
</span><a href="#local-6989586621683065520"><span class="hs-identifier hs-var hs-var">is_decl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="#local-6989586621683065490"><span class="hs-identifier hs-var">flavour</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-402"></span><span>                 </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="GHC.Hs.Expr.html#UntypedDeclSplice"><span class="hs-identifier hs-var">UntypedDeclSplice</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-403"></span><span>                 </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><span class="hs-identifier">_</span></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-404"></span><span>
</span><span id="line-405"></span><span class="hs-comment">------------------</span><span>
</span><span id="line-406"></span><span class="annot"><a href="GHC.Rename.Splice.html#makePending"><span class="hs-identifier hs-type">makePending</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Hs.Expr.html#UntypedSpliceFlavour"><span class="hs-identifier hs-type">UntypedSpliceFlavour</span></a></span><span>
</span><span id="line-407"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span>
</span><span id="line-408"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsUntypedSplice"><span class="hs-identifier hs-type">HsUntypedSplice</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span>
</span><span id="line-409"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Hs.Expr.html#PendingRnSplice"><span class="hs-identifier hs-type">PendingRnSplice</span></a></span><span>
</span><span id="line-410"></span><span id="makePending"><span class="annot"><span class="annottext">makePending :: UntypedSpliceFlavour
-&gt; Name -&gt; HsUntypedSplice (GhcPass 'Renamed) -&gt; PendingRnSplice
</span><a href="GHC.Rename.Splice.html#makePending"><span class="hs-identifier hs-var hs-var">makePending</span></a></span></span><span> </span><span id="local-6989586621683065528"><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="#local-6989586621683065528"><span class="hs-identifier hs-var">flavour</span></a></span></span><span> </span><span id="local-6989586621683065529"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065529"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsUntypedSpliceExpr"><span class="hs-identifier hs-type">HsUntypedSpliceExpr</span></a></span><span> </span><span class="annot"><span class="annottext">XUntypedSpliceExpr (GhcPass 'Renamed)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683065530"><span class="annot"><span class="annottext">LHsExpr (GhcPass 'Renamed)
</span><a href="#local-6989586621683065530"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-411"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
-&gt; Name -&gt; LHsExpr (GhcPass 'Renamed) -&gt; PendingRnSplice
</span><a href="GHC.Hs.Expr.html#PendingRnSplice"><span class="hs-identifier hs-var">PendingRnSplice</span></a></span><span> </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="#local-6989586621683065528"><span class="hs-identifier hs-var">flavour</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065529"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">LHsExpr (GhcPass 'Renamed)
</span><a href="#local-6989586621683065530"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-412"></span><span class="annot"><a href="GHC.Rename.Splice.html#makePending"><span class="hs-identifier hs-var">makePending</span></a></span><span> </span><span id="local-6989586621683065532"><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="#local-6989586621683065532"><span class="hs-identifier hs-var">flavour</span></a></span></span><span> </span><span id="local-6989586621683065533"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065533"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsQuasiQuote"><span class="hs-identifier hs-type">HsQuasiQuote</span></a></span><span> </span><span class="annot"><span class="annottext">XQuasiQuote (GhcPass 'Renamed)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683065534"><span class="annot"><span class="annottext">IdP (GhcPass 'Renamed)
</span><a href="#local-6989586621683065534"><span class="hs-identifier hs-var">quoter</span></a></span></span><span> </span><span id="local-6989586621683065535"><span class="annot"><span class="annottext">XRec (GhcPass 'Renamed) FastString
</span><a href="#local-6989586621683065535"><span class="hs-identifier hs-var">quote</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-413"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
-&gt; Name -&gt; LHsExpr (GhcPass 'Renamed) -&gt; PendingRnSplice
</span><a href="GHC.Hs.Expr.html#PendingRnSplice"><span class="hs-identifier hs-var">PendingRnSplice</span></a></span><span> </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="#local-6989586621683065532"><span class="hs-identifier hs-var">flavour</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065533"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UntypedSpliceFlavour
-&gt; Name -&gt; XRec GhcPs FastString -&gt; LHsExpr (GhcPass 'Renamed)
</span><a href="GHC.Rename.Splice.html#mkQuasiQuoteExpr"><span class="hs-identifier hs-var">mkQuasiQuoteExpr</span></a></span><span> </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="#local-6989586621683065532"><span class="hs-identifier hs-var">flavour</span></a></span><span> </span><span class="annot"><span class="annottext">IdP (GhcPass 'Renamed)
Name
</span><a href="#local-6989586621683065534"><span class="hs-identifier hs-var">quoter</span></a></span><span> </span><span class="annot"><span class="annottext">XRec GhcPs FastString
XRec (GhcPass 'Renamed) FastString
</span><a href="#local-6989586621683065535"><span class="hs-identifier hs-var">quote</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-414"></span><span>
</span><span id="line-415"></span><span class="hs-comment">------------------</span><span>
</span><span id="line-416"></span><span class="annot"><a href="GHC.Rename.Splice.html#mkQuasiQuoteExpr"><span class="hs-identifier hs-type">mkQuasiQuoteExpr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Hs.Expr.html#UntypedSpliceFlavour"><span class="hs-identifier hs-type">UntypedSpliceFlavour</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span>
</span><span id="line-417"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Extension.html#XRec"><span class="hs-identifier hs-type">XRec</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcPs"><span class="hs-identifier hs-type">GhcPs</span></a></span><span> </span><span class="annot"><a href="GHC.Data.FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a></span><span>
</span><span id="line-418"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#LHsExpr"><span class="hs-identifier hs-type">LHsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span>
</span><span id="line-419"></span><span class="hs-comment">-- Return the expression (quoter &quot;...quote...&quot;)</span><span>
</span><span id="line-420"></span><span class="hs-comment">-- which is what we must run in a quasi-quote</span><span>
</span><span id="line-421"></span><span id="mkQuasiQuoteExpr"><span class="annot"><span class="annottext">mkQuasiQuoteExpr :: UntypedSpliceFlavour
-&gt; Name -&gt; XRec GhcPs FastString -&gt; LHsExpr (GhcPass 'Renamed)
</span><a href="GHC.Rename.Splice.html#mkQuasiQuoteExpr"><span class="hs-identifier hs-var hs-var">mkQuasiQuoteExpr</span></a></span></span><span> </span><span id="local-6989586621683065536"><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="#local-6989586621683065536"><span class="hs-identifier hs-var">flavour</span></a></span></span><span> </span><span id="local-6989586621683065537"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065537"><span class="hs-identifier hs-var">quoter</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.SrcLoc.html#L"><span class="hs-identifier hs-type">L</span></a></span><span> </span><span id="local-6989586621683065538"><span class="annot"><span class="annottext">EpAnnCO
</span><a href="#local-6989586621683065538"><span class="hs-identifier hs-var">q_span'</span></a></span></span><span> </span><span id="local-6989586621683065539"><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683065539"><span class="hs-identifier hs-var">quote</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-422"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SrcSpanAnnA
-&gt; HsExpr (GhcPass 'Renamed)
-&gt; GenLocated SrcSpanAnnA (HsExpr (GhcPass 'Renamed))
forall l e. l -&gt; e -&gt; GenLocated l e
</span><a href="GHC.Types.SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpanAnnA
</span><a href="#local-6989586621683065540"><span class="hs-identifier hs-var">q_span</span></a></span><span> </span><span class="annot"><span class="annottext">(HsExpr (GhcPass 'Renamed)
 -&gt; GenLocated SrcSpanAnnA (HsExpr (GhcPass 'Renamed)))
-&gt; HsExpr (GhcPass 'Renamed)
-&gt; GenLocated SrcSpanAnnA (HsExpr (GhcPass 'Renamed))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">XApp (GhcPass 'Renamed)
-&gt; LHsExpr (GhcPass 'Renamed)
-&gt; LHsExpr (GhcPass 'Renamed)
-&gt; HsExpr (GhcPass 'Renamed)
forall p. XApp p -&gt; LHsExpr p -&gt; LHsExpr p -&gt; HsExpr p
</span><a href="Language.Haskell.Syntax.Expr.html#HsApp"><span class="hs-identifier hs-var">HsApp</span></a></span><span> </span><span class="annot"><span class="annottext">XApp (GhcPass 'Renamed)
NoExtField
</span><a href="Language.Haskell.Syntax.Extension.html#noExtField"><span class="hs-identifier hs-var">noExtField</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SrcSpanAnnA
-&gt; HsExpr (GhcPass 'Renamed)
-&gt; GenLocated SrcSpanAnnA (HsExpr (GhcPass 'Renamed))
forall l e. l -&gt; e -&gt; GenLocated l e
</span><a href="GHC.Types.SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpanAnnA
</span><a href="#local-6989586621683065540"><span class="hs-identifier hs-var">q_span</span></a></span><span>
</span><span id="line-423"></span><span>             </span><span class="annot"><span class="annottext">(HsExpr (GhcPass 'Renamed)
 -&gt; GenLocated SrcSpanAnnA (HsExpr (GhcPass 'Renamed)))
-&gt; HsExpr (GhcPass 'Renamed)
-&gt; GenLocated SrcSpanAnnA (HsExpr (GhcPass 'Renamed))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">XApp (GhcPass 'Renamed)
-&gt; LHsExpr (GhcPass 'Renamed)
-&gt; LHsExpr (GhcPass 'Renamed)
-&gt; HsExpr (GhcPass 'Renamed)
forall p. XApp p -&gt; LHsExpr p -&gt; LHsExpr p -&gt; HsExpr p
</span><a href="Language.Haskell.Syntax.Expr.html#HsApp"><span class="hs-identifier hs-var">HsApp</span></a></span><span> </span><span class="annot"><span class="annottext">XApp (GhcPass 'Renamed)
NoExtField
</span><a href="Language.Haskell.Syntax.Extension.html#noExtField"><span class="hs-identifier hs-var">noExtField</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SrcSpanAnnA
-&gt; HsExpr (GhcPass 'Renamed)
-&gt; GenLocated SrcSpanAnnA (HsExpr (GhcPass 'Renamed))
forall l e. l -&gt; e -&gt; GenLocated l e
</span><a href="GHC.Types.SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpanAnnA
</span><a href="#local-6989586621683065540"><span class="hs-identifier hs-var">q_span</span></a></span><span>
</span><span id="line-424"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">XVar (GhcPass 'Renamed)
-&gt; LIdP (GhcPass 'Renamed) -&gt; HsExpr (GhcPass 'Renamed)
forall p. XVar p -&gt; LIdP p -&gt; HsExpr p
</span><a href="Language.Haskell.Syntax.Expr.html#HsVar"><span class="hs-identifier hs-var">HsVar</span></a></span><span> </span><span class="annot"><span class="annottext">XVar (GhcPass 'Renamed)
NoExtField
</span><a href="Language.Haskell.Syntax.Extension.html#noExtField"><span class="hs-identifier hs-var">noExtField</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SrcSpanAnnN -&gt; Name -&gt; GenLocated SrcSpanAnnN Name
forall l e. l -&gt; e -&gt; GenLocated l e
</span><a href="GHC.Types.SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SrcSpanAnnA -&gt; SrcSpanAnnN
forall a b. (HasLoc a, HasAnnotation b) =&gt; a -&gt; b
</span><a href="GHC.Parser.Annotation.html#l2l"><span class="hs-identifier hs-var">l2l</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpanAnnA
</span><a href="#local-6989586621683065540"><span class="hs-identifier hs-var">q_span</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065544"><span class="hs-identifier hs-var">quote_selector</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-425"></span><span>                                </span><span class="annot"><span class="annottext">LHsExpr (GhcPass 'Renamed)
GenLocated SrcSpanAnnA (HsExpr (GhcPass 'Renamed))
</span><a href="#local-6989586621683065545"><span class="hs-identifier hs-var">quoterExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-426"></span><span>                    </span><span class="annot"><span class="annottext">LHsExpr (GhcPass 'Renamed)
GenLocated SrcSpanAnnA (HsExpr (GhcPass 'Renamed))
</span><a href="#local-6989586621683065546"><span class="hs-identifier hs-var">quoteExpr</span></a></span><span>
</span><span id="line-427"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-428"></span><span>    </span><span id="local-6989586621683065540"><span class="annot"><span class="annottext">q_span :: SrcSpanAnnA
</span><a href="#local-6989586621683065540"><span class="hs-identifier hs-var hs-var">q_span</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SrcSpan -&gt; SrcSpanAnnA
forall e. HasAnnotation e =&gt; SrcSpan -&gt; e
</span><a href="GHC.Parser.Annotation.html#noAnnSrcSpan"><span class="hs-identifier hs-var">noAnnSrcSpan</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EpAnnCO -&gt; SrcSpan
forall a. HasLoc a =&gt; a -&gt; SrcSpan
</span><a href="GHC.Parser.Annotation.html#locA"><span class="hs-identifier hs-var">locA</span></a></span><span> </span><span class="annot"><span class="annottext">EpAnnCO
</span><a href="#local-6989586621683065538"><span class="hs-identifier hs-var">q_span'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-429"></span><span>    </span><span id="local-6989586621683065545"><span class="annot"><span class="annottext">quoterExpr :: GenLocated SrcSpanAnnA (HsExpr (GhcPass 'Renamed))
</span><a href="#local-6989586621683065545"><span class="hs-identifier hs-var hs-var">quoterExpr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SrcSpanAnnA
-&gt; HsExpr (GhcPass 'Renamed)
-&gt; GenLocated SrcSpanAnnA (HsExpr (GhcPass 'Renamed))
forall l e. l -&gt; e -&gt; GenLocated l e
</span><a href="GHC.Types.SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpanAnnA
</span><a href="#local-6989586621683065540"><span class="hs-identifier hs-var">q_span</span></a></span><span> </span><span class="annot"><span class="annottext">(HsExpr (GhcPass 'Renamed)
 -&gt; GenLocated SrcSpanAnnA (HsExpr (GhcPass 'Renamed)))
-&gt; HsExpr (GhcPass 'Renamed)
-&gt; GenLocated SrcSpanAnnA (HsExpr (GhcPass 'Renamed))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">XVar (GhcPass 'Renamed)
-&gt; LIdP (GhcPass 'Renamed) -&gt; HsExpr (GhcPass 'Renamed)
forall p. XVar p -&gt; LIdP p -&gt; HsExpr p
</span><a href="Language.Haskell.Syntax.Expr.html#HsVar"><span class="hs-identifier hs-var">HsVar</span></a></span><span> </span><span class="annot"><span class="annottext">XVar (GhcPass 'Renamed)
NoExtField
</span><a href="Language.Haskell.Syntax.Extension.html#noExtField"><span class="hs-identifier hs-var">noExtField</span></a></span><span> </span><span class="annot"><span class="annottext">(GenLocated SrcSpanAnnN Name -&gt; HsExpr (GhcPass 'Renamed))
-&gt; GenLocated SrcSpanAnnN Name -&gt; HsExpr (GhcPass 'Renamed)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SrcSpanAnnN -&gt; Name -&gt; GenLocated SrcSpanAnnN Name
forall l e. l -&gt; e -&gt; GenLocated l e
</span><a href="GHC.Types.SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SrcSpanAnnA -&gt; SrcSpanAnnN
forall a b. (HasLoc a, HasAnnotation b) =&gt; a -&gt; b
</span><a href="GHC.Parser.Annotation.html#l2l"><span class="hs-identifier hs-var">l2l</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpanAnnA
</span><a href="#local-6989586621683065540"><span class="hs-identifier hs-var">q_span</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065537"><span class="hs-identifier hs-var">quoter</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-430"></span><span>    </span><span id="local-6989586621683065546"><span class="annot"><span class="annottext">quoteExpr :: GenLocated SrcSpanAnnA (HsExpr (GhcPass 'Renamed))
</span><a href="#local-6989586621683065546"><span class="hs-identifier hs-var hs-var">quoteExpr</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SrcSpanAnnA
-&gt; HsExpr (GhcPass 'Renamed)
-&gt; GenLocated SrcSpanAnnA (HsExpr (GhcPass 'Renamed))
forall l e. l -&gt; e -&gt; GenLocated l e
</span><a href="GHC.Types.SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpanAnnA
</span><a href="#local-6989586621683065540"><span class="hs-identifier hs-var">q_span</span></a></span><span> </span><span class="annot"><span class="annottext">(HsExpr (GhcPass 'Renamed)
 -&gt; GenLocated SrcSpanAnnA (HsExpr (GhcPass 'Renamed)))
-&gt; HsExpr (GhcPass 'Renamed)
-&gt; GenLocated SrcSpanAnnA (HsExpr (GhcPass 'Renamed))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">XLitE (GhcPass 'Renamed)
-&gt; HsLit (GhcPass 'Renamed) -&gt; HsExpr (GhcPass 'Renamed)
forall p. XLitE p -&gt; HsLit p -&gt; HsExpr p
</span><a href="Language.Haskell.Syntax.Expr.html#HsLit"><span class="hs-identifier hs-var">HsLit</span></a></span><span> </span><span class="annot"><span class="annottext">XLitE (GhcPass 'Renamed)
NoExtField
</span><a href="Language.Haskell.Syntax.Extension.html#noExtField"><span class="hs-identifier hs-var">noExtField</span></a></span><span> </span><span class="annot"><span class="annottext">(HsLit (GhcPass 'Renamed) -&gt; HsExpr (GhcPass 'Renamed))
-&gt; HsLit (GhcPass 'Renamed) -&gt; HsExpr (GhcPass 'Renamed)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">XHsString (GhcPass 'Renamed)
-&gt; FastString -&gt; HsLit (GhcPass 'Renamed)
forall x. XHsString x -&gt; FastString -&gt; HsLit x
</span><a href="Language.Haskell.Syntax.Lit.html#HsString"><span class="hs-identifier hs-var">HsString</span></a></span><span> </span><span class="annot"><span class="annottext">XHsString (GhcPass 'Renamed)
SourceText
</span><a href="GHC.Types.SourceText.html#NoSourceText"><span class="hs-identifier hs-var">NoSourceText</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683065539"><span class="hs-identifier hs-var">quote</span></a></span><span>
</span><span id="line-431"></span><span>    </span><span id="local-6989586621683065544"><span class="annot"><span class="annottext">quote_selector :: Name
</span><a href="#local-6989586621683065544"><span class="hs-identifier hs-var hs-var">quote_selector</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="#local-6989586621683065536"><span class="hs-identifier hs-var">flavour</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-432"></span><span>                       </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="GHC.Hs.Expr.html#UntypedExpSplice"><span class="hs-identifier hs-var">UntypedExpSplice</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.TH.html#quoteExpName"><span class="hs-identifier hs-var">quoteExpName</span></a></span><span>
</span><span id="line-433"></span><span>                       </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="GHC.Hs.Expr.html#UntypedPatSplice"><span class="hs-identifier hs-var">UntypedPatSplice</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.TH.html#quotePatName"><span class="hs-identifier hs-var">quotePatName</span></a></span><span>
</span><span id="line-434"></span><span>                       </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="GHC.Hs.Expr.html#UntypedTypeSplice"><span class="hs-identifier hs-var">UntypedTypeSplice</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.TH.html#quoteTypeName"><span class="hs-identifier hs-var">quoteTypeName</span></a></span><span>
</span><span id="line-435"></span><span>                       </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="GHC.Hs.Expr.html#UntypedDeclSplice"><span class="hs-identifier hs-var">UntypedDeclSplice</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.TH.html#quoteDecName"><span class="hs-identifier hs-var">quoteDecName</span></a></span><span>
</span><span id="line-436"></span><span>
</span><span id="line-437"></span><span class="hs-comment">---------------------</span><span>
</span><span id="line-438"></span><span class="annot"><a href="GHC.Rename.Splice.html#unqualSplice"><span class="hs-identifier hs-type">unqualSplice</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Name.Reader.html#RdrName"><span class="hs-identifier hs-type">RdrName</span></a></span><span>
</span><span id="line-439"></span><span class="hs-comment">-- The RdrName for a SplicePointName.  See GHC.Hs.Expr</span><span>
</span><span id="line-440"></span><span class="hs-comment">-- Note [Lifecycle of an untyped splice, and PendingRnSplice]</span><span>
</span><span id="line-441"></span><span class="hs-comment">-- We use &quot;spn&quot; (which is arbitrary) because it is brief but grepable-for.</span><span>
</span><span id="line-442"></span><span id="unqualSplice"><span class="annot"><span class="annottext">unqualSplice :: RdrName
</span><a href="GHC.Rename.Splice.html#unqualSplice"><span class="hs-identifier hs-var hs-var">unqualSplice</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccName -&gt; RdrName
</span><a href="GHC.Types.Name.Reader.html#mkRdrUnqual"><span class="hs-identifier hs-var">mkRdrUnqual</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FastString -&gt; OccName
</span><a href="GHC.Types.Name.Occurrence.html#mkVarOccFS"><span class="hs-identifier hs-var">mkVarOccFS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; FastString
</span><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;spn&quot;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-443"></span><span>
</span><span id="line-444"></span><span class="annot"><a href="GHC.Rename.Splice.html#rnUntypedSplice"><span class="hs-identifier hs-type">rnUntypedSplice</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsUntypedSplice"><span class="hs-identifier hs-type">HsUntypedSplice</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcPs"><span class="hs-identifier hs-type">GhcPs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#RnM"><span class="hs-identifier hs-type">RnM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsUntypedSplice"><span class="hs-identifier hs-type">HsUntypedSplice</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html#FreeVars"><span class="hs-identifier hs-type">FreeVars</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-445"></span><span class="hs-comment">-- Not exported...used for all</span><span>
</span><span id="line-446"></span><span id="rnUntypedSplice"><span class="annot"><span class="annottext">rnUntypedSplice :: HsUntypedSplice GhcPs
-&gt; TcM (HsUntypedSplice (GhcPass 'Renamed), Uses)
</span><a href="GHC.Rename.Splice.html#rnUntypedSplice"><span class="hs-identifier hs-var hs-var">rnUntypedSplice</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsUntypedSpliceExpr"><span class="hs-identifier hs-type">HsUntypedSpliceExpr</span></a></span><span> </span><span id="local-6989586621683065555"><span class="annot"><span class="annottext">XUntypedSpliceExpr GhcPs
</span><a href="#local-6989586621683065555"><span class="hs-identifier hs-var">annCo</span></a></span></span><span> </span><span id="local-6989586621683065556"><span class="annot"><span class="annottext">LHsExpr GhcPs
</span><a href="#local-6989586621683065556"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-447"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683065557"><span class="annot"><a href="#local-6989586621683065557"><span class="hs-identifier hs-var">expr'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683065558"><span class="annot"><a href="#local-6989586621683065558"><span class="hs-identifier hs-var">fvs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcPs -&gt; TcM (LHsExpr (GhcPass 'Renamed), Uses)
</span><a href="GHC.Rename.Expr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a></span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcPs
</span><a href="#local-6989586621683065556"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-448"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsUntypedSpliceExpr"><span class="hs-identifier hs-type">HsUntypedSpliceExpr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065555"><span class="hs-identifier hs-type">annCo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065557"><span class="hs-identifier hs-type">expr'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683065558"><span class="hs-identifier hs-type">fvs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-449"></span><span>
</span><span id="line-450"></span><span class="annot"><a href="GHC.Rename.Splice.html#rnUntypedSplice"><span class="hs-identifier hs-var">rnUntypedSplice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsQuasiQuote"><span class="hs-identifier hs-type">HsQuasiQuote</span></a></span><span> </span><span id="local-6989586621683065559"><span class="annot"><span class="annottext">XQuasiQuote GhcPs
</span><a href="#local-6989586621683065559"><span class="hs-identifier hs-var">ext</span></a></span></span><span> </span><span id="local-6989586621683065560"><span class="annot"><span class="annottext">IdP GhcPs
</span><a href="#local-6989586621683065560"><span class="hs-identifier hs-var">quoter</span></a></span></span><span> </span><span id="local-6989586621683065561"><span class="annot"><span class="annottext">XRec GhcPs FastString
</span><a href="#local-6989586621683065561"><span class="hs-identifier hs-var">quote</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-451"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Rename the quoter; akin to the HsVar case of rnExpr</span><span>
</span><span id="line-452"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683065562"><span class="annot"><a href="#local-6989586621683065562"><span class="hs-identifier hs-var">quoter'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RdrName -&gt; RnM Name
</span><a href="GHC.Rename.Env.html#lookupOccRn"><span class="hs-identifier hs-var">lookupOccRn</span></a></span><span> </span><span class="annot"><span class="annottext">IdP GhcPs
RdrName
</span><a href="#local-6989586621683065560"><span class="hs-identifier hs-var">quoter</span></a></span><span>
</span><span id="line-453"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683065563"><span class="annot"><a href="#local-6989586621683065563"><span class="hs-identifier hs-var">this_mod</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Unit.Module.html#getModule"><span class="hs-identifier hs-type">getModule</span></a></span><span>
</span><span id="line-454"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Name.html#nameIsLocalOrFrom"><span class="hs-identifier hs-type">nameIsLocalOrFrom</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065563"><span class="hs-identifier hs-type">this_mod</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065562"><span class="hs-identifier hs-type">quoter'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-455"></span><span>          </span><span class="annot"><a href="GHC.Rename.Splice.html#checkThLocalName"><span class="hs-identifier hs-type">checkThLocalName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065562"><span class="hs-identifier hs-type">quoter'</span></a></span><span>
</span><span id="line-456"></span><span>
</span><span id="line-457"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsQuasiQuote"><span class="hs-identifier hs-type">HsQuasiQuote</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065559"><span class="hs-identifier hs-type">ext</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065562"><span class="hs-identifier hs-type">quoter'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065561"><span class="hs-identifier hs-type">quote</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html#unitFV"><span class="hs-identifier hs-type">unitFV</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065562"><span class="hs-identifier hs-type">quoter'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-458"></span><span>
</span><span id="line-459"></span><span class="hs-comment">---------------------</span><span>
</span><span id="line-460"></span><span class="annot"><a href="GHC.Rename.Splice.html#rnTypedSplice"><span class="hs-identifier hs-type">rnTypedSplice</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#LHsExpr"><span class="hs-identifier hs-type">LHsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcPs"><span class="hs-identifier hs-type">GhcPs</span></a></span><span> </span><span class="hs-comment">-- Typed splice expression</span><span>
</span><span id="line-461"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#RnM"><span class="hs-identifier hs-type">RnM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html#FreeVars"><span class="hs-identifier hs-type">FreeVars</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-462"></span><span id="rnTypedSplice"><span class="annot"><span class="annottext">rnTypedSplice :: LHsExpr GhcPs -&gt; RnM (HsExpr (GhcPass 'Renamed), Uses)
</span><a href="GHC.Rename.Splice.html#rnTypedSplice"><span class="hs-identifier hs-var hs-var">rnTypedSplice</span></a></span></span><span> </span><span id="local-6989586621683065564"><span class="annot"><span class="annottext">LHsExpr GhcPs
</span><a href="#local-6989586621683065564"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-463"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SDoc
-&gt; RnM (HsExpr (GhcPass 'Renamed), Uses)
-&gt; RnM (HsExpr (GhcPass 'Renamed), Uses)
forall a. SDoc -&gt; TcM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SDoc -&gt; ThLevel -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;In the typed splice:&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ThLevel
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Name -&gt; LHsExpr GhcPs -&gt; SDoc
forall (p :: Pass).
OutputableBndrId p =&gt;
Maybe Name -&gt; LHsExpr (GhcPass p) -&gt; SDoc
</span><a href="GHC.Hs.Expr.html#pprTypedSplice"><span class="hs-identifier hs-var">pprTypedSplice</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Name
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcPs
</span><a href="#local-6989586621683065564"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(RnM (HsExpr (GhcPass 'Renamed), Uses)
 -&gt; RnM (HsExpr (GhcPass 'Renamed), Uses))
-&gt; RnM (HsExpr (GhcPass 'Renamed), Uses)
-&gt; RnM (HsExpr (GhcPass 'Renamed), Uses)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-464"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683065566"><span class="annot"><a href="#local-6989586621683065566"><span class="hs-identifier hs-var">stage</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM ThStage
</span><a href="GHC.Tc.Utils.Monad.html#getStage"><span class="hs-identifier hs-var">getStage</span></a></span><span>
</span><span id="line-465"></span><span>    </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683065566"><span class="hs-identifier hs-type">stage</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-466"></span><span>        </span><span class="annot"><a href="GHC.Tc.Types.TH.html#Brack"><span class="hs-identifier hs-type">Brack</span></a></span><span> </span><span id="local-6989586621683065567"><span class="annot"><span class="annottext">ThStage
</span><a href="#local-6989586621683065567"><span class="hs-identifier hs-var">pop_stage</span></a></span></span><span> </span><span class="annot"><span class="annottext">PendingStuff
</span><a href="GHC.Tc.Types.TH.html#RnPendingTyped"><span class="hs-identifier hs-var">RnPendingTyped</span></a></span><span>
</span><span id="line-467"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ThStage
-&gt; RnM (HsExpr (GhcPass 'Renamed), Uses)
-&gt; RnM (HsExpr (GhcPass 'Renamed), Uses)
forall a. ThStage -&gt; TcM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#setStage"><span class="hs-identifier hs-var">setStage</span></a></span><span> </span><span class="annot"><span class="annottext">ThStage
</span><a href="#local-6989586621683065567"><span class="hs-identifier hs-var">pop_stage</span></a></span><span> </span><span class="annot"><span class="annottext">RnM (HsExpr (GhcPass 'Renamed), Uses)
</span><a href="#local-6989586621683065568"><span class="hs-identifier hs-var">rn_splice</span></a></span><span>
</span><span id="line-468"></span><span>
</span><span id="line-469"></span><span>        </span><span class="annot"><a href="GHC.Tc.Types.TH.html#Brack"><span class="hs-identifier hs-type">Brack</span></a></span><span> </span><span class="annot"><span class="annottext">ThStage
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.TH.html#RnPendingUntyped"><span class="hs-identifier hs-type">RnPendingUntyped</span></a></span><span> </span><span class="annot"><span class="annottext">IORef [PendingRnSplice]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-470"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; RnM (HsExpr (GhcPass 'Renamed), Uses)
forall a. TcRnMessage -&gt; TcRn a
</span><a href="GHC.Tc.Utils.Monad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; RnM (HsExpr (GhcPass 'Renamed), Uses))
-&gt; TcRnMessage -&gt; RnM (HsExpr (GhcPass 'Renamed), Uses)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">THSyntaxError -&gt; TcRnMessage
</span><a href="GHC.Rename.Splice.html#thSyntaxError"><span class="hs-identifier hs-var">thSyntaxError</span></a></span><span> </span><span class="annot"><span class="annottext">(THSyntaxError -&gt; TcRnMessage) -&gt; THSyntaxError -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SpliceType -&gt; SpliceOrBracket -&gt; THSyntaxError
</span><a href="GHC.Tc.Errors.Types.html#MismatchedSpliceType"><span class="hs-identifier hs-var">MismatchedSpliceType</span></a></span><span> </span><span class="annot"><span class="annottext">SpliceType
</span><a href="GHC.Tc.Types.TH.html#Typed"><span class="hs-identifier hs-var">Typed</span></a></span><span> </span><span class="annot"><span class="annottext">SpliceOrBracket
</span><a href="GHC.Tc.Types.TH.html#IsSplice"><span class="hs-identifier hs-var">IsSplice</span></a></span><span>
</span><span id="line-471"></span><span>
</span><span id="line-472"></span><span>        </span><span class="annot"><span class="annottext">ThStage
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Extension -&gt; RnM () -&gt; RnM ()
forall gbl lcl. Extension -&gt; TcRnIf gbl lcl () -&gt; TcRnIf gbl lcl ()
</span><a href="GHC.Tc.Utils.Monad.html#unlessXOptM"><span class="hs-identifier hs-var">unlessXOptM</span></a></span><span> </span><span class="annot"><span class="annottext">Extension
</span><span class="hs-identifier hs-var">LangExt.TemplateHaskell</span></span><span>
</span><span id="line-473"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcRnMessage -&gt; RnM ()
forall a. TcRnMessage -&gt; TcRn a
</span><a href="GHC.Tc.Utils.Monad.html#failWith"><span class="hs-identifier hs-var">failWith</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; RnM ()) -&gt; TcRnMessage -&gt; RnM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">THSyntaxError -&gt; TcRnMessage
</span><a href="GHC.Rename.Splice.html#thSyntaxError"><span class="hs-identifier hs-var">thSyntaxError</span></a></span><span> </span><span class="annot"><span class="annottext">THSyntaxError
</span><a href="GHC.Tc.Errors.Types.html#IllegalTHSplice"><span class="hs-identifier hs-var">IllegalTHSplice</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-474"></span><span>
</span><span id="line-475"></span><span>                </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683065570"><span class="annot"><a href="#local-6989586621683065570"><span class="hs-identifier hs-var">result</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683065571"><span class="annot"><a href="#local-6989586621683065571"><span class="hs-identifier hs-var">fvs1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RnM (HsExpr (GhcPass 'Renamed), Uses)
-&gt; RnM (HsExpr (GhcPass 'Renamed), Uses)
forall r. TcM r -&gt; TcM r
</span><a href="GHC.Tc.Utils.Monad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a></span><span> </span><span class="annot"><span class="annottext">(RnM (HsExpr (GhcPass 'Renamed), Uses)
 -&gt; RnM (HsExpr (GhcPass 'Renamed), Uses))
-&gt; RnM (HsExpr (GhcPass 'Renamed), Uses)
-&gt; RnM (HsExpr (GhcPass 'Renamed), Uses)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ThStage
-&gt; RnM (HsExpr (GhcPass 'Renamed), Uses)
-&gt; RnM (HsExpr (GhcPass 'Renamed), Uses)
forall a. ThStage -&gt; TcM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#setStage"><span class="hs-identifier hs-var">setStage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpliceType -&gt; ThStage
</span><a href="GHC.Tc.Types.TH.html#Splice"><span class="hs-identifier hs-var">Splice</span></a></span><span> </span><span class="annot"><span class="annottext">SpliceType
</span><a href="GHC.Tc.Types.TH.html#Typed"><span class="hs-identifier hs-var">Typed</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">RnM (HsExpr (GhcPass 'Renamed), Uses)
</span><a href="#local-6989586621683065568"><span class="hs-identifier hs-var">rn_splice</span></a></span><span>
</span><span id="line-476"></span><span>                  </span><span class="hs-comment">-- checkNoErrs: don't attempt to run the splice if</span><span>
</span><span id="line-477"></span><span>                  </span><span class="hs-comment">-- renaming it failed; otherwise we get a cascade of</span><span>
</span><span id="line-478"></span><span>                  </span><span class="hs-comment">-- errors from e.g. unbound variables</span><span>
</span><span id="line-479"></span><span>
</span><span id="line-480"></span><span>                  </span><span class="hs-comment">-- Run typed splice later, in the type checker</span><span>
</span><span id="line-481"></span><span>                  </span><span class="hs-comment">-- Ugh!  See Note [Free variables of typed splices] above</span><span>
</span><span id="line-482"></span><span>                </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceRn"><span class="hs-identifier hs-type">traceRn</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;rnTypedSplice: typed expression splice&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#empty"><span class="hs-identifier hs-type">empty</span></a></span><span>
</span><span id="line-483"></span><span>                </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683065572"><span class="annot"><a href="#local-6989586621683065572"><span class="hs-identifier hs-var">lcl_rdr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#getLocalRdrEnv"><span class="hs-identifier hs-type">getLocalRdrEnv</span></a></span><span>
</span><span id="line-484"></span><span>                </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683065574"><span class="annot"><a href="#local-6989586621683065574"><span class="hs-identifier hs-var">gbl_rdr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#getGlobalRdrEnv"><span class="hs-identifier hs-type">getGlobalRdrEnv</span></a></span><span>
</span><span id="line-485"></span><span>                </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683065576"><span class="annot"><a href="#local-6989586621683065576"><span class="hs-identifier hs-var hs-var">gbl_names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; Uses
</span><a href="GHC.Types.Name.Set.html#mkNameSet"><span class="hs-identifier hs-var">mkNameSet</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">GlobalRdrEltX GREInfo -&gt; Name
forall info. GlobalRdrEltX info -&gt; Name
</span><a href="GHC.Types.Name.Reader.html#greName"><span class="hs-identifier hs-var">greName</span></a></span><span> </span><span class="annot"><span class="annottext">GlobalRdrEltX GREInfo
</span><a href="#local-6989586621683065579"><span class="hs-identifier hs-var">gre</span></a></span><span>
</span><span id="line-486"></span><span>                                            </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621683065579"><span class="annot"><span class="annottext">GlobalRdrEltX GREInfo
</span><a href="#local-6989586621683065579"><span class="hs-identifier hs-var">gre</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">GlobalRdrEnv -&gt; [GlobalRdrEltX GREInfo]
forall info. GlobalRdrEnvX info -&gt; [GlobalRdrEltX info]
</span><a href="GHC.Types.Name.Reader.html#globalRdrEnvElts"><span class="hs-identifier hs-var">globalRdrEnvElts</span></a></span><span> </span><span class="annot"><span class="annottext">GlobalRdrEnv
</span><a href="#local-6989586621683065574"><span class="hs-identifier hs-var">gbl_rdr</span></a></span><span>
</span><span id="line-487"></span><span>                                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">GlobalRdrEltX GREInfo -&gt; Bool
forall info. GlobalRdrEltX info -&gt; Bool
</span><a href="GHC.Types.Name.Reader.html#isLocalGRE"><span class="hs-identifier hs-var">isLocalGRE</span></a></span><span> </span><span class="annot"><span class="annottext">GlobalRdrEltX GREInfo
</span><a href="#local-6989586621683065579"><span class="hs-identifier hs-var">gre</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-488"></span><span>                      </span><span id="local-6989586621683065582"><span class="annot"><a href="#local-6989586621683065582"><span class="hs-identifier hs-var hs-var">lcl_names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; Uses
</span><a href="GHC.Types.Name.Set.html#mkNameSet"><span class="hs-identifier hs-var">mkNameSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LocalRdrEnv -&gt; [Name]
</span><a href="GHC.Types.Name.Reader.html#localRdrEnvElts"><span class="hs-identifier hs-var">localRdrEnvElts</span></a></span><span> </span><span class="annot"><span class="annottext">LocalRdrEnv
</span><a href="#local-6989586621683065572"><span class="hs-identifier hs-var">lcl_rdr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-489"></span><span>                      </span><span id="local-6989586621683065584"><span class="annot"><a href="#local-6989586621683065584"><span class="hs-identifier hs-var hs-var">fvs2</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Uses
</span><a href="#local-6989586621683065582"><span class="hs-identifier hs-var">lcl_names</span></a></span><span> </span><span class="annot"><span class="annottext">Uses -&gt; Uses -&gt; Uses
</span><a href="GHC.Types.Name.Set.html#plusFV"><span class="hs-operator hs-var">`plusFV`</span></a></span><span> </span><span class="annot"><span class="annottext">Uses
</span><a href="#local-6989586621683065576"><span class="hs-identifier hs-var">gbl_names</span></a></span><span>
</span><span id="line-490"></span><span>
</span><span id="line-491"></span><span>                </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683065570"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683065571"><span class="hs-identifier hs-type">fvs1</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html#plusFV"><span class="hs-operator hs-type">`plusFV`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065584"><span class="hs-identifier hs-type">fvs2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-492"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-493"></span><span>    </span><span class="annot"><a href="#local-6989586621683065568"><span class="hs-identifier hs-type">rn_splice</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#RnM"><span class="hs-identifier hs-type">RnM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html#FreeVars"><span class="hs-identifier hs-type">FreeVars</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-494"></span><span>    </span><span id="local-6989586621683065568"><span class="annot"><span class="annottext">rn_splice :: RnM (HsExpr (GhcPass 'Renamed), Uses)
</span><a href="#local-6989586621683065568"><span class="hs-identifier hs-var hs-var">rn_splice</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-495"></span><span>      </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683065585"><span class="annot"><a href="#local-6989586621683065585"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcRn SrcSpan
</span><a href="GHC.Tc.Utils.Monad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a></span><span>
</span><span id="line-496"></span><span>         </span><span class="hs-comment">-- The renamer allocates a splice-point name to every typed splice</span><span>
</span><span id="line-497"></span><span>         </span><span class="hs-comment">-- (incl the top level ones for which it will not ultimately be used)</span><span>
</span><span id="line-498"></span><span>         </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683065586"><span class="annot"><a href="#local-6989586621683065586"><span class="hs-identifier hs-var">n'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Rename.Utils.html#newLocalBndrRn"><span class="hs-identifier hs-type">newLocalBndrRn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.SrcLoc.html#L"><span class="hs-identifier hs-type">L</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Parser.Annotation.html#noAnnSrcSpan"><span class="hs-identifier hs-type">noAnnSrcSpan</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065585"><span class="hs-identifier hs-type">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="GHC.Rename.Splice.html#unqualSplice"><span class="hs-identifier hs-type">unqualSplice</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-499"></span><span>         </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683065587"><span class="annot"><a href="#local-6989586621683065587"><span class="hs-identifier hs-var">expr'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683065588"><span class="annot"><a href="#local-6989586621683065588"><span class="hs-identifier hs-var">fvs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Rename.Expr.html#rnLExpr"><span class="hs-identifier hs-type">rnLExpr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065564"><span class="hs-identifier hs-type">expr</span></a></span><span>
</span><span id="line-500"></span><span>         </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsTypedSplice"><span class="hs-identifier hs-type">HsTypedSplice</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065586"><span class="hs-identifier hs-type">n'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065587"><span class="hs-identifier hs-type">expr'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683065588"><span class="hs-identifier hs-type">fvs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-501"></span><span>
</span><span id="line-502"></span><span class="annot"><a href="GHC.Rename.Splice.html#rnUntypedSpliceExpr"><span class="hs-identifier hs-type">rnUntypedSpliceExpr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsUntypedSplice"><span class="hs-identifier hs-type">HsUntypedSplice</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcPs"><span class="hs-identifier hs-type">GhcPs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#RnM"><span class="hs-identifier hs-type">RnM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html#FreeVars"><span class="hs-identifier hs-type">FreeVars</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-503"></span><span id="rnUntypedSpliceExpr"><span class="annot"><span class="annottext">rnUntypedSpliceExpr :: HsUntypedSplice GhcPs -&gt; RnM (HsExpr (GhcPass 'Renamed), Uses)
</span><a href="GHC.Rename.Splice.html#rnUntypedSpliceExpr"><span class="hs-identifier hs-var hs-var">rnUntypedSpliceExpr</span></a></span></span><span> </span><span id="local-6989586621683065590"><span class="annot"><span class="annottext">HsUntypedSplice GhcPs
</span><a href="#local-6989586621683065590"><span class="hs-identifier hs-var">splice</span></a></span></span><span>
</span><span id="line-504"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(HsUntypedSplice (GhcPass 'Renamed)
 -&gt; RnM (HsExpr (GhcPass 'Renamed), Uses))
-&gt; (Name
    -&gt; HsUntypedSplice (GhcPass 'Renamed)
    -&gt; (PendingRnSplice, HsExpr (GhcPass 'Renamed)))
-&gt; HsUntypedSplice GhcPs
-&gt; RnM (HsExpr (GhcPass 'Renamed), Uses)
forall a.
(HsUntypedSplice (GhcPass 'Renamed) -&gt; RnM (a, Uses))
-&gt; (Name
    -&gt; HsUntypedSplice (GhcPass 'Renamed) -&gt; (PendingRnSplice, a))
-&gt; HsUntypedSplice GhcPs
-&gt; RnM (a, Uses)
</span><a href="GHC.Rename.Splice.html#rnUntypedSpliceGen"><span class="hs-identifier hs-var">rnUntypedSpliceGen</span></a></span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
-&gt; RnM (HsExpr (GhcPass 'Renamed), Uses)
</span><a href="#local-6989586621683065591"><span class="hs-identifier hs-var">run_expr_splice</span></a></span><span> </span><span class="annot"><span class="annottext">Name
-&gt; HsUntypedSplice (GhcPass 'Renamed)
-&gt; (PendingRnSplice, HsExpr (GhcPass 'Renamed))
</span><a href="#local-6989586621683065592"><span class="hs-identifier hs-var">pend_expr_splice</span></a></span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice GhcPs
</span><a href="#local-6989586621683065590"><span class="hs-identifier hs-var">splice</span></a></span><span>
</span><span id="line-505"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-506"></span><span>    </span><span class="annot"><a href="#local-6989586621683065592"><span class="hs-identifier hs-type">pend_expr_splice</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsUntypedSplice"><span class="hs-identifier hs-type">HsUntypedSplice</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Hs.Expr.html#PendingRnSplice"><span class="hs-identifier hs-type">PendingRnSplice</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-507"></span><span>    </span><span id="local-6989586621683065592"><span class="annot"><span class="annottext">pend_expr_splice :: Name
-&gt; HsUntypedSplice (GhcPass 'Renamed)
-&gt; (PendingRnSplice, HsExpr (GhcPass 'Renamed))
</span><a href="#local-6989586621683065592"><span class="hs-identifier hs-var hs-var">pend_expr_splice</span></a></span></span><span> </span><span id="local-6989586621683065593"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065593"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621683065594"><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
</span><a href="#local-6989586621683065594"><span class="hs-identifier hs-var">rn_splice</span></a></span></span><span>
</span><span id="line-508"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UntypedSpliceFlavour
-&gt; Name -&gt; HsUntypedSplice (GhcPass 'Renamed) -&gt; PendingRnSplice
</span><a href="GHC.Rename.Splice.html#makePending"><span class="hs-identifier hs-var">makePending</span></a></span><span> </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="GHC.Hs.Expr.html#UntypedExpSplice"><span class="hs-identifier hs-var">UntypedExpSplice</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065593"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
</span><a href="#local-6989586621683065594"><span class="hs-identifier hs-var">rn_splice</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">XUntypedSplice (GhcPass 'Renamed)
-&gt; HsUntypedSplice (GhcPass 'Renamed) -&gt; HsExpr (GhcPass 'Renamed)
forall p. XUntypedSplice p -&gt; HsUntypedSplice p -&gt; HsExpr p
</span><a href="Language.Haskell.Syntax.Expr.html#HsUntypedSplice"><span class="hs-identifier hs-var">HsUntypedSplice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; HsUntypedSpliceResult (HsExpr (GhcPass 'Renamed))
forall thing. Name -&gt; HsUntypedSpliceResult thing
</span><a href="GHC.Hs.Expr.html#HsUntypedSpliceNested"><span class="hs-identifier hs-var">HsUntypedSpliceNested</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065593"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
</span><a href="#local-6989586621683065594"><span class="hs-identifier hs-var">rn_splice</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-509"></span><span>
</span><span id="line-510"></span><span>    </span><span id="local-6989586621683065591"><span class="annot"><span class="annottext">run_expr_splice :: HsUntypedSplice (GhcPass 'Renamed)
-&gt; RnM (HsExpr (GhcPass 'Renamed), Uses)
</span><a href="#local-6989586621683065591"><span class="hs-identifier hs-var hs-var">run_expr_splice</span></a></span></span><span> </span><span id="local-6989586621683065615"><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
</span><a href="#local-6989586621683065615"><span class="hs-identifier hs-var">rn_splice</span></a></span></span><span>
</span><span id="line-511"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; RnM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rnUntypedSpliceExpr: untyped expression splice&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsOutput doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a></span><span>
</span><span id="line-512"></span><span>
</span><span id="line-513"></span><span>           </span><span class="hs-comment">-- Run the splice here, see Note [Running splices in the Renamer]</span><span>
</span><span id="line-514"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683065616"><span class="annot"><a href="#local-6989586621683065616"><span class="hs-identifier hs-var">expr_ps</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683065617"><span class="annot"><a href="#local-6989586621683065617"><span class="hs-identifier hs-var">mod_finalizers</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-515"></span><span>                </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
-&gt; (LHsExpr GhcTc -&gt; TcRn (GenLocated SrcSpanAnnA (HsExpr GhcPs)))
-&gt; (GenLocated SrcSpanAnnA (HsExpr GhcPs) -&gt; SDoc)
-&gt; HsUntypedSplice (GhcPass 'Renamed)
-&gt; TcRn
     (GenLocated SrcSpanAnnA (HsExpr GhcPs), [ForeignRef (Q ())])
forall res.
UntypedSpliceFlavour
-&gt; (LHsExpr GhcTc -&gt; TcRn res)
-&gt; (res -&gt; SDoc)
-&gt; HsUntypedSplice (GhcPass 'Renamed)
-&gt; TcRn (res, [ForeignRef (Q ())])
</span><a href="GHC.Rename.Splice.html#runRnSplice"><span class="hs-identifier hs-var">runRnSplice</span></a></span><span> </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="GHC.Hs.Expr.html#UntypedExpSplice"><span class="hs-identifier hs-var">UntypedExpSplice</span></a></span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcTc -&gt; TcM (LHsExpr GhcPs)
LHsExpr GhcTc -&gt; TcRn (GenLocated SrcSpanAnnA (HsExpr GhcPs))
</span><a href="GHC.Tc.Gen.Splice.html#runMetaE"><span class="hs-identifier hs-var">runMetaE</span></a></span><span> </span><span class="annot"><span class="annottext">GenLocated SrcSpanAnnA (HsExpr GhcPs) -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
</span><a href="#local-6989586621683065615"><span class="hs-identifier hs-var">rn_splice</span></a></span><span>
</span><span id="line-516"></span><span>                </span><span class="hs-comment">-- mod_finalizers: See Note [Delaying modFinalizers in untyped splices].</span><span>
</span><span id="line-517"></span><span>
</span><span id="line-518"></span><span>           </span><span class="hs-comment">-- Rename the expanded expression</span><span>
</span><span id="line-519"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.SrcLoc.html#L"><span class="hs-identifier hs-type">L</span></a></span><span> </span><span id="local-6989586621683065618"><span class="annot"><a href="#local-6989586621683065618"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621683065619"><span class="annot"><a href="#local-6989586621683065619"><span class="hs-identifier hs-var">expr_rn</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683065620"><span class="annot"><a href="#local-6989586621683065620"><span class="hs-identifier hs-var">fvs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#checkNoErrs"><span class="hs-identifier hs-type">checkNoErrs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Rename.Expr.html#rnLExpr"><span class="hs-identifier hs-type">rnLExpr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065616"><span class="hs-identifier hs-type">expr_ps</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-520"></span><span>
</span><span id="line-521"></span><span>           </span><span class="hs-comment">-- rn_splice :: HsUntypedSplice GhcRn is the original TH expression,</span><span>
</span><span id="line-522"></span><span>           </span><span class="hs-comment">--                                       before expansion</span><span>
</span><span id="line-523"></span><span>           </span><span class="hs-comment">-- expr_ps   :: LHsExpr GhcPs is the result of running the splice</span><span>
</span><span id="line-524"></span><span>           </span><span class="hs-comment">-- expr_rn   :: HsExpr GhcRn is the result of renaming ps_expr</span><span>
</span><span id="line-525"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621683065621"><span class="hs-identifier hs-type">res</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Hs.Expr.html#HsUntypedSpliceResult"><span class="hs-identifier hs-type">HsUntypedSpliceResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-526"></span><span>                 </span><span id="local-6989586621683065621"><span class="annot"><a href="#local-6989586621683065621"><span class="hs-identifier hs-var hs-var">res</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Hs.Expr.html#HsUntypedSpliceTop"><span class="hs-identifier hs-type">HsUntypedSpliceTop</span></a></span><span>
</span><span id="line-527"></span><span>                          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">utsplice_result_finalizers :: ThModFinalizers
</span><a href="GHC.Hs.Expr.html#utsplice_result_finalizers"><span class="hs-identifier hs-var">utsplice_result_finalizers</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ForeignRef (Q ())] -&gt; ThModFinalizers
</span><a href="GHC.Hs.Expr.html#ThModFinalizers"><span class="hs-identifier hs-var">ThModFinalizers</span></a></span><span> </span><span class="annot"><span class="annottext">[ForeignRef (Q ())]
</span><a href="#local-6989586621683065617"><span class="hs-identifier hs-var">mod_finalizers</span></a></span><span>
</span><span id="line-528"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">utsplice_result :: HsExpr (GhcPass 'Renamed)
</span><a href="GHC.Hs.Expr.html#utsplice_result"><span class="hs-identifier hs-var">utsplice_result</span></a></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HsExpr (GhcPass 'Renamed)
</span><a href="#local-6989586621683065619"><span class="hs-identifier hs-var">expr_rn</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-529"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Hs.Expr.html#gHsPar"><span class="hs-identifier hs-type">gHsPar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.SrcLoc.html#L"><span class="hs-identifier hs-type">L</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065618"><span class="hs-identifier hs-type">l</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsUntypedSplice"><span class="hs-identifier hs-type">HsUntypedSplice</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065621"><span class="hs-identifier hs-type">res</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065615"><span class="hs-identifier hs-type">rn_splice</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683065620"><span class="hs-identifier hs-type">fvs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-530"></span><span>           </span><span class="hs-special">}</span><span>
</span><span id="line-531"></span><span>
</span><span id="line-532"></span><span class="annot"><a href="GHC.Rename.Splice.html#thSyntaxError"><span class="hs-identifier hs-type">thSyntaxError</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Errors.Types.html#THSyntaxError"><span class="hs-identifier hs-type">THSyntaxError</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Errors.Types.html#TcRnMessage"><span class="hs-identifier hs-type">TcRnMessage</span></a></span><span>
</span><span id="line-533"></span><span id="thSyntaxError"><span class="annot"><span class="annottext">thSyntaxError :: THSyntaxError -&gt; TcRnMessage
</span><a href="GHC.Rename.Splice.html#thSyntaxError"><span class="hs-identifier hs-var hs-var">thSyntaxError</span></a></span></span><span> </span><span id="local-6989586621683065627"><span class="annot"><span class="annottext">THSyntaxError
</span><a href="#local-6989586621683065627"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">THError -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnTHError"><span class="hs-identifier hs-var">TcRnTHError</span></a></span><span> </span><span class="annot"><span class="annottext">(THError -&gt; TcRnMessage) -&gt; THError -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">THSyntaxError -&gt; THError
</span><a href="GHC.Tc.Errors.Types.html#THSyntaxError"><span class="hs-identifier hs-var">THSyntaxError</span></a></span><span> </span><span class="annot"><span class="annottext">THSyntaxError
</span><a href="#local-6989586621683065627"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-534"></span><span>
</span><span id="line-535"></span><span class="hs-comment">{- Note [Running splices in the Renamer]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Splices used to be run in the typechecker, which led to (#4364). Since the
renamer must decide which expressions depend on which others, and it cannot
reliably do this for arbitrary splices, we used to conservatively say that
splices depend on all other expressions in scope. Unfortunately, this led to
the problem of cyclic type declarations seen in (#4364). Instead, by
running splices in the renamer, we side-step the problem of determining
dependencies: by the time the dependency analysis happens, any splices have
already been run, and expression dependencies can be determined as usual.

However, see (#9813), for an example where we would like to run splices
*after* performing dependency analysis (that is, after renaming). It would be
desirable to typecheck &quot;non-splicy&quot; expressions (those expressions that do not
contain splices directly or via dependence on an expression that does) before
&quot;splicy&quot; expressions, such that types/expressions within the same declaration
group would be available to `reify` calls, for example consider the following:

&gt; module M where
&gt;   data D = C
&gt;   f = 1
&gt;   g = $(mapM reify ['f, 'D, ''C] ...)

Compilation of this example fails since D/C/f are not in the type environment
and thus cannot be reified as they have not been typechecked by the time the
splice is renamed and thus run.

These requirements are at odds: we do not want to run splices in the renamer as
we wish to first determine dependencies and typecheck certain expressions,
making them available to reify, but cannot accurately determine dependencies
without running splices in the renamer!

Indeed, the conclusion of (#9813) was that it is not worth the complexity
to try and
 a) implement and maintain the code for renaming/typechecking non-splicy
    expressions before splicy expressions,
 b) explain to TH users which expressions are/not available to reify at any
    given point.

-}</span><span>
</span><span id="line-576"></span><span>
</span><span id="line-577"></span><span class="hs-comment">{- Note [Rebindable syntax and Template Haskell]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When processing Template Haskell quotes with Rebindable Syntax (RS) enabled,
there are two possibilities: apply the RS rules to the quotes or don't.

One might expect that with {-# LANGUAGE RebindableSyntax #-} at the top of a
module, any 'if' expression would end up being turned into a call to whatever
'ifThenElse' function is in scope, regardless of whether the said if expression
appears in &quot;normal&quot; Haskell code or in a TH quote. This however comes with its
problems. Consider the following code:

  {-# LANGUAGE TemplateHaskell, RebindableSyntax #-}

  module X where

  import Prelude ( Monad(..), Bool(..), print, ($) )
  import Language.Haskell.TH.Syntax

  $( do stuff &lt;- [| if True then 10 else 15 |]
        runIO $ print stuff
        return [] )

If we apply the RS rules, then GHC would complain about not having suitable
fromInteger/ifThenElse functions in scope. But this quote is just a bit of
Haskell syntax that has yet to be used, or, to put it differently, placed
(spliced) in some context where the said functions might be available. More
generally, untyped TH quotes are meant to work with yet-unbound identifiers.
This tends to show that untyped TH and Rebindable Syntax overall don't play
well together. Users still have the option to splice &quot;normal&quot; if expressions
into modules where RS is enabled, to turn them into applications of
an 'ifThenElse' function of their choice.

Typed TH (TTH) quotes, on the other hand, come with different constraints. They
don't quite have this &quot;delayed&quot; nature: we typecheck them while processing
them, and TTH users expect RS to Just Work in their quotes, exactly like it does
outside of the quotes. There, we do not have to accept unbound identifiers and
we can apply the RS rules both in the typechecking and desugaring of the quotes
without triggering surprising/bad behaviour for users. For instance, the
following code is expected to be rejected (because of the lack of suitable
'fromInteger'/'ifThenElse' functions in scope):

  {-# LANGUAGE TemplateHaskell, RebindableSyntax #-}

  module X where

  import Prelude ( Monad(..), Bool(..), print, ($) )
  import Language.Haskell.TH.Syntax

  $$( do stuff &lt;- [|| if True then 10 else 15 ||]
         runIO $ print stuff
         return [] )

The conclusion is that even if RS is enabled for a given module, GHC disables it
when processing untyped TH quotes from that module, to avoid the aforementioned
problems, but keeps it on while processing typed TH quotes.

This note and approach originated in #18102.

-}</span><span>
</span><span id="line-636"></span><span>
</span><span id="line-637"></span><span class="hs-comment">{- Note [Delaying modFinalizers in untyped splices]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

When splices run in the renamer, 'reify' does not have access to the local
type environment (#11832, [1]).

For instance, in

&gt; let x = e in $(reify (mkName &quot;x&quot;) &gt;&gt;= runIO . print &gt;&gt; [| return () |])

'reify' cannot find @x@, because the local type environment is not yet
populated. To address this, we allow 'reify' execution to be deferred with
'addModFinalizer'.

&gt; let x = e in $(do addModFinalizer (reify (mkName &quot;x&quot;) &gt;&gt;= runIO . print)
                    [| return () |]
                )

The finalizer is run with the local type environment when type checking is
complete.

Since the local type environment is not available in the renamer, we annotate
the tree at the splice point [2] with @HsSpliceE (HsSpliced finalizers e)@ where
@e@ is the result of splicing and @finalizers@ are the finalizers that have been
collected during evaluation of the splice [3]. In our example,

&gt; HsLet
&gt;   (x = e)
&gt;   (HsSpliceE $ HsSpliced [reify (mkName &quot;x&quot;) &gt;&gt;= runIO . print]
&gt;                          (HsSplicedExpr $ return ())
&gt;   )

When the typechecker finds the annotation, it inserts the finalizers in the
global environment and exposes the current local environment to them [4, 5, 6].

&gt; addModFinalizersWithLclEnv [reify (mkName &quot;x&quot;) &gt;&gt;= runIO . print]

References:

[1] https://gitlab.haskell.org/ghc/ghc/wikis/template-haskell/reify
[2] 'rnSpliceExpr'
[3] 'GHC.Tc.Gen.Splice.qAddModFinalizer'
[4] 'GHC.Tc.Gen.Expr.tcExpr' ('HsSpliceE' ('HsSpliced' ...))
[5] 'GHC.Tc.Gen.HsType.tcHsType' ('HsSpliceTy' ('HsSpliced' ...))
[6] 'GHC.Tc.Gen.Pat.tc_pat' ('SplicePat' ('HsSpliced' ...))

-}</span><span>
</span><span id="line-684"></span><span>
</span><span id="line-685"></span><span class="hs-comment">----------------------</span><span>
</span><span id="line-686"></span><span class="annot"><a href="GHC.Rename.Splice.html#rnSpliceType"><span class="hs-identifier hs-type">rnSpliceType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsUntypedSplice"><span class="hs-identifier hs-type">HsUntypedSplice</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcPs"><span class="hs-identifier hs-type">GhcPs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#RnM"><span class="hs-identifier hs-type">RnM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Type.html#HsType"><span class="hs-identifier hs-type">HsType</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html#FreeVars"><span class="hs-identifier hs-type">FreeVars</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-687"></span><span id="rnSpliceType"><span class="annot"><span class="annottext">rnSpliceType :: HsUntypedSplice GhcPs -&gt; RnM (HsType (GhcPass 'Renamed), Uses)
</span><a href="GHC.Rename.Splice.html#rnSpliceType"><span class="hs-identifier hs-var hs-var">rnSpliceType</span></a></span></span><span> </span><span id="local-6989586621683065629"><span class="annot"><span class="annottext">HsUntypedSplice GhcPs
</span><a href="#local-6989586621683065629"><span class="hs-identifier hs-var">splice</span></a></span></span><span>
</span><span id="line-688"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(HsUntypedSplice (GhcPass 'Renamed)
 -&gt; RnM (HsType (GhcPass 'Renamed), Uses))
-&gt; (Name
    -&gt; HsUntypedSplice (GhcPass 'Renamed)
    -&gt; (PendingRnSplice, HsType (GhcPass 'Renamed)))
-&gt; HsUntypedSplice GhcPs
-&gt; RnM (HsType (GhcPass 'Renamed), Uses)
forall a.
(HsUntypedSplice (GhcPass 'Renamed) -&gt; RnM (a, Uses))
-&gt; (Name
    -&gt; HsUntypedSplice (GhcPass 'Renamed) -&gt; (PendingRnSplice, a))
-&gt; HsUntypedSplice GhcPs
-&gt; RnM (a, Uses)
</span><a href="GHC.Rename.Splice.html#rnUntypedSpliceGen"><span class="hs-identifier hs-var">rnUntypedSpliceGen</span></a></span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
-&gt; RnM (HsType (GhcPass 'Renamed), Uses)
</span><a href="#local-6989586621683065630"><span class="hs-identifier hs-var">run_type_splice</span></a></span><span> </span><span class="annot"><span class="annottext">Name
-&gt; HsUntypedSplice (GhcPass 'Renamed)
-&gt; (PendingRnSplice, HsType (GhcPass 'Renamed))
</span><a href="#local-6989586621683065631"><span class="hs-identifier hs-var">pend_type_splice</span></a></span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice GhcPs
</span><a href="#local-6989586621683065629"><span class="hs-identifier hs-var">splice</span></a></span><span>
</span><span id="line-689"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-690"></span><span>    </span><span id="local-6989586621683065631"><span class="annot"><span class="annottext">pend_type_splice :: Name
-&gt; HsUntypedSplice (GhcPass 'Renamed)
-&gt; (PendingRnSplice, HsType (GhcPass 'Renamed))
</span><a href="#local-6989586621683065631"><span class="hs-identifier hs-var hs-var">pend_type_splice</span></a></span></span><span> </span><span id="local-6989586621683065632"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065632"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621683065633"><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
</span><a href="#local-6989586621683065633"><span class="hs-identifier hs-var">rn_splice</span></a></span></span><span>
</span><span id="line-691"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
-&gt; Name -&gt; HsUntypedSplice (GhcPass 'Renamed) -&gt; PendingRnSplice
</span><a href="GHC.Rename.Splice.html#makePending"><span class="hs-identifier hs-var">makePending</span></a></span><span> </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="GHC.Hs.Expr.html#UntypedTypeSplice"><span class="hs-identifier hs-var">UntypedTypeSplice</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065632"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
</span><a href="#local-6989586621683065633"><span class="hs-identifier hs-var">rn_splice</span></a></span><span>
</span><span id="line-692"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">XSpliceTy (GhcPass 'Renamed)
-&gt; HsUntypedSplice (GhcPass 'Renamed) -&gt; HsType (GhcPass 'Renamed)
forall pass. XSpliceTy pass -&gt; HsUntypedSplice pass -&gt; HsType pass
</span><a href="Language.Haskell.Syntax.Type.html#HsSpliceTy"><span class="hs-identifier hs-var">HsSpliceTy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
-&gt; HsUntypedSpliceResult
     (GenLocated SrcSpanAnnA (HsType (GhcPass 'Renamed)))
forall thing. Name -&gt; HsUntypedSpliceResult thing
</span><a href="GHC.Hs.Expr.html#HsUntypedSpliceNested"><span class="hs-identifier hs-var">HsUntypedSpliceNested</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065632"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
</span><a href="#local-6989586621683065633"><span class="hs-identifier hs-var">rn_splice</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-693"></span><span>
</span><span id="line-694"></span><span>    </span><span class="annot"><a href="#local-6989586621683065630"><span class="hs-identifier hs-type">run_type_splice</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsUntypedSplice"><span class="hs-identifier hs-type">HsUntypedSplice</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#RnM"><span class="hs-identifier hs-type">RnM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Type.html#HsType"><span class="hs-identifier hs-type">HsType</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html#FreeVars"><span class="hs-identifier hs-type">FreeVars</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-695"></span><span>    </span><span id="local-6989586621683065630"><span class="annot"><span class="annottext">run_type_splice :: HsUntypedSplice (GhcPass 'Renamed)
-&gt; RnM (HsType (GhcPass 'Renamed), Uses)
</span><a href="#local-6989586621683065630"><span class="hs-identifier hs-var hs-var">run_type_splice</span></a></span></span><span> </span><span id="local-6989586621683065635"><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
</span><a href="#local-6989586621683065635"><span class="hs-identifier hs-var">rn_splice</span></a></span></span><span>
</span><span id="line-696"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; RnM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rnSpliceType: untyped type splice&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsOutput doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a></span><span>
</span><span id="line-697"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683065636"><span class="annot"><a href="#local-6989586621683065636"><span class="hs-identifier hs-var">hs_ty2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683065637"><span class="annot"><a href="#local-6989586621683065637"><span class="hs-identifier hs-var">mod_finalizers</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-698"></span><span>                </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
-&gt; (LHsExpr GhcTc -&gt; TcRn (GenLocated SrcSpanAnnA (HsType GhcPs)))
-&gt; (GenLocated SrcSpanAnnA (HsType GhcPs) -&gt; SDoc)
-&gt; HsUntypedSplice (GhcPass 'Renamed)
-&gt; TcRn
     (GenLocated SrcSpanAnnA (HsType GhcPs), [ForeignRef (Q ())])
forall res.
UntypedSpliceFlavour
-&gt; (LHsExpr GhcTc -&gt; TcRn res)
-&gt; (res -&gt; SDoc)
-&gt; HsUntypedSplice (GhcPass 'Renamed)
-&gt; TcRn (res, [ForeignRef (Q ())])
</span><a href="GHC.Rename.Splice.html#runRnSplice"><span class="hs-identifier hs-var">runRnSplice</span></a></span><span> </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="GHC.Hs.Expr.html#UntypedTypeSplice"><span class="hs-identifier hs-var">UntypedTypeSplice</span></a></span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcTc -&gt; TcM (LHsType GhcPs)
LHsExpr GhcTc -&gt; TcRn (GenLocated SrcSpanAnnA (HsType GhcPs))
</span><a href="GHC.Tc.Gen.Splice.html#runMetaT"><span class="hs-identifier hs-var">runMetaT</span></a></span><span> </span><span class="annot"><span class="annottext">GenLocated SrcSpanAnnA (HsType GhcPs) -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
</span><a href="#local-6989586621683065635"><span class="hs-identifier hs-var">rn_splice</span></a></span><span>
</span><span id="line-699"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683065638"><span class="annot"><a href="#local-6989586621683065638"><span class="hs-identifier hs-var">hs_ty3</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683065639"><span class="annot"><a href="#local-6989586621683065639"><span class="hs-identifier hs-var">fvs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683065640"><span class="annot"><a href="#local-6989586621683065640"><span class="hs-identifier hs-var hs-var">doc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LHsType GhcPs -&gt; HsDocContext
</span><a href="GHC.Tc.Errors.Types.html#SpliceTypeCtx"><span class="hs-identifier hs-var">SpliceTypeCtx</span></a></span><span> </span><span class="annot"><span class="annottext">LHsType GhcPs
GenLocated SrcSpanAnnA (HsType GhcPs)
</span><a href="#local-6989586621683065636"><span class="hs-identifier hs-var">hs_ty2</span></a></span><span>
</span><span id="line-700"></span><span>                                 </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#checkNoErrs"><span class="hs-identifier hs-type">checkNoErrs</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Rename.HsType.html#rnLHsType"><span class="hs-identifier hs-type">rnLHsType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065640"><span class="hs-identifier hs-type">doc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065636"><span class="hs-identifier hs-type">hs_ty2</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-701"></span><span>                                         </span><span class="hs-comment">-- checkNoErrs: see Note [Renamer errors]</span><span>
</span><span id="line-702"></span><span>
</span><span id="line-703"></span><span>             </span><span class="hs-comment">-- See Note [Delaying modFinalizers in untyped splices].</span><span>
</span><span id="line-704"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Type.html#HsSpliceTy"><span class="hs-identifier hs-type">HsSpliceTy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Hs.Expr.html#HsUntypedSpliceTop"><span class="hs-identifier hs-type">HsUntypedSpliceTop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Hs.Expr.html#ThModFinalizers"><span class="hs-identifier hs-type">ThModFinalizers</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065637"><span class="hs-identifier hs-type">mod_finalizers</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-705"></span><span>                                                     </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683065642"><span class="hs-identifier hs-type">mb_paren</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065638"><span class="hs-identifier hs-type">hs_ty3</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-706"></span><span>                                 </span><span class="annot"><a href="#local-6989586621683065635"><span class="hs-identifier hs-type">rn_splice</span></a></span><span>
</span><span id="line-707"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683065639"><span class="hs-identifier hs-type">fvs</span></a></span><span>
</span><span id="line-708"></span><span>                    </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-709"></span><span>              </span><span class="hs-comment">-- Wrap the result of the splice in parens so that we don't</span><span>
</span><span id="line-710"></span><span>              </span><span class="hs-comment">-- lose the outermost location set by runQuasiQuote (#7918)</span><span>
</span><span id="line-711"></span><span>
</span><span id="line-712"></span><span>    </span><span class="hs-comment">-- Wrap a non-atomic result in HsParTy parens;</span><span>
</span><span id="line-713"></span><span>    </span><span class="hs-comment">-- but not if it's atomic to avoid double parens for operators</span><span>
</span><span id="line-714"></span><span>    </span><span class="hs-comment">-- This is to account for, say  foo :: $(blah) -&gt; Int</span><span>
</span><span id="line-715"></span><span>    </span><span class="hs-comment">-- when we want $(blah) to expand to (this -&gt; that), with parens.</span><span>
</span><span id="line-716"></span><span>    </span><span class="hs-comment">-- Sadly, it's awkward add precisely the correct parens, because</span><span>
</span><span id="line-717"></span><span>    </span><span class="hs-comment">-- that depends on the context.</span><span>
</span><span id="line-718"></span><span>    </span><span class="annot"><a href="#local-6989586621683065642"><span class="hs-identifier hs-type">mb_paren</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Type.html#LHsType"><span class="hs-identifier hs-type">LHsType</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Type.html#LHsType"><span class="hs-identifier hs-type">LHsType</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span>
</span><span id="line-719"></span><span>    </span><span id="local-6989586621683065642"><span class="annot"><span class="annottext">mb_paren :: LHsType (GhcPass 'Renamed) -&gt; LHsType (GhcPass 'Renamed)
</span><a href="#local-6989586621683065642"><span class="hs-identifier hs-var hs-var">mb_paren</span></a></span></span><span> </span><span id="local-6989586621683065643"><span class="annot"><span class="annottext">lhs_ty :: LHsType (GhcPass 'Renamed)
</span><a href="#local-6989586621683065643"><span class="hs-identifier hs-var">lhs_ty</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.SrcLoc.html#L"><span class="hs-identifier hs-type">L</span></a></span><span> </span><span id="local-6989586621683065644"><span class="annot"><span class="annottext">SrcSpanAnnA
</span><a href="#local-6989586621683065644"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621683065645"><span class="annot"><span class="annottext">HsType (GhcPass 'Renamed)
</span><a href="#local-6989586621683065645"><span class="hs-identifier hs-var">hs_ty</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-720"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">PprPrec -&gt; HsType (GhcPass 'Renamed) -&gt; Bool
forall (p :: Pass). PprPrec -&gt; HsType (GhcPass p) -&gt; Bool
</span><a href="GHC.Hs.Type.html#hsTypeNeedsParens"><span class="hs-identifier hs-var">hsTypeNeedsParens</span></a></span><span> </span><span class="annot"><span class="annottext">PprPrec
</span><a href="GHC.Types.Basic.html#maxPrec"><span class="hs-identifier hs-var">maxPrec</span></a></span><span> </span><span class="annot"><span class="annottext">HsType (GhcPass 'Renamed)
</span><a href="#local-6989586621683065645"><span class="hs-identifier hs-var">hs_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SrcSpanAnnA
-&gt; HsType (GhcPass 'Renamed)
-&gt; GenLocated SrcSpanAnnA (HsType (GhcPass 'Renamed))
forall l e. l -&gt; e -&gt; GenLocated l e
</span><a href="GHC.Types.SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpanAnnA
</span><a href="#local-6989586621683065644"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">XParTy (GhcPass 'Renamed)
-&gt; LHsType (GhcPass 'Renamed) -&gt; HsType (GhcPass 'Renamed)
forall pass. XParTy pass -&gt; LHsType pass -&gt; HsType pass
</span><a href="Language.Haskell.Syntax.Type.html#HsParTy"><span class="hs-identifier hs-var">HsParTy</span></a></span><span> </span><span class="annot"><span class="annottext">(EpToken &quot;(&quot;, EpToken &quot;)&quot;)
XParTy (GhcPass 'Renamed)
forall a. NoAnn a =&gt; a
</span><a href="GHC.Parser.Annotation.html#noAnn"><span class="hs-identifier hs-var">noAnn</span></a></span><span> </span><span class="annot"><span class="annottext">LHsType (GhcPass 'Renamed)
</span><a href="#local-6989586621683065643"><span class="hs-identifier hs-var">lhs_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-721"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LHsType (GhcPass 'Renamed)
</span><a href="#local-6989586621683065643"><span class="hs-identifier hs-var">lhs_ty</span></a></span><span>
</span><span id="line-722"></span><span>
</span><span id="line-723"></span><span class="hs-comment">{- Note [Partial Type Splices]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Partial Type Signatures are partially supported in TH type splices: only
anonymous wild cards are allowed.

  -- ToDo: SLPJ says: I don't understand all this

Normally, named wild cards are collected before renaming a (partial) type
signature. However, TH type splices are run during renaming, i.e. after the
initial traversal, leading to out of scope errors for named wild cards. We
can't just extend the initial traversal to collect the named wild cards in TH
type splices, as we'd need to expand them, which is supposed to happen only
once, during renaming.

Similarly, the extra-constraints wild card is handled right before renaming
too, and is therefore also not supported in a TH type splice. Another reason
to forbid extra-constraints wild cards in TH type splices is that a single
signature can contain many TH type splices, whereas it mustn't contain more
than one extra-constraints wild card. Enforcing would this be hard the way
things are currently organised.

Anonymous wild cards pose no problem, because they start out without names and
are given names during renaming. These names are collected right after
renaming. The names generated for anonymous wild cards in TH type splices will
thus be collected as well.

For more details about renaming wild cards, see GHC.Rename.HsType.rnHsSigWcType

Note that partial type signatures are fully supported in TH declaration
splices, e.g.:

     [d| foo :: _ =&gt; _
         foo x y = x == y |]

This is because in this case, the partial type signature can be treated as a
whole signature, instead of as an arbitrary type.

-}</span><span>
</span><span id="line-761"></span><span>
</span><span id="line-762"></span><span>
</span><span id="line-763"></span><span class="hs-comment">----------------------</span><span>
</span><span id="line-764"></span><span class="annot"><span class="hs-comment">-- | Rename a splice pattern. See Note [rnSplicePat]</span></span><span>
</span><span id="line-765"></span><span class="annot"><a href="GHC.Rename.Splice.html#rnSplicePat"><span class="hs-identifier hs-type">rnSplicePat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsUntypedSplice"><span class="hs-identifier hs-type">HsUntypedSplice</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcPs"><span class="hs-identifier hs-type">GhcPs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#RnM"><span class="hs-identifier hs-type">RnM</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsUntypedSplice"><span class="hs-identifier hs-type">HsUntypedSplice</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Hs.Expr.html#HsUntypedSpliceResult"><span class="hs-identifier hs-type">HsUntypedSpliceResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Pat.html#LPat"><span class="hs-identifier hs-type">LPat</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcPs"><span class="hs-identifier hs-type">GhcPs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-766"></span><span>                                            </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html#FreeVars"><span class="hs-identifier hs-type">FreeVars</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-767"></span><span id="rnSplicePat"><span class="annot"><span class="annottext">rnSplicePat :: HsUntypedSplice GhcPs
-&gt; RnM
     ((HsUntypedSplice (GhcPass 'Renamed),
       HsUntypedSpliceResult (LPat GhcPs)),
      Uses)
</span><a href="GHC.Rename.Splice.html#rnSplicePat"><span class="hs-identifier hs-var hs-var">rnSplicePat</span></a></span></span><span> </span><span id="local-6989586621683065649"><span class="annot"><span class="annottext">HsUntypedSplice GhcPs
</span><a href="#local-6989586621683065649"><span class="hs-identifier hs-var">splice</span></a></span></span><span>
</span><span id="line-768"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(HsUntypedSplice (GhcPass 'Renamed)
 -&gt; RnM
      ((HsUntypedSplice (GhcPass 'Renamed),
        HsUntypedSpliceResult (GenLocated SrcSpanAnnA (Pat GhcPs))),
       Uses))
-&gt; (Name
    -&gt; HsUntypedSplice (GhcPass 'Renamed)
    -&gt; (PendingRnSplice,
        (HsUntypedSplice (GhcPass 'Renamed),
         HsUntypedSpliceResult (GenLocated SrcSpanAnnA (Pat GhcPs)))))
-&gt; HsUntypedSplice GhcPs
-&gt; RnM
     ((HsUntypedSplice (GhcPass 'Renamed),
       HsUntypedSpliceResult (GenLocated SrcSpanAnnA (Pat GhcPs))),
      Uses)
forall a.
(HsUntypedSplice (GhcPass 'Renamed) -&gt; RnM (a, Uses))
-&gt; (Name
    -&gt; HsUntypedSplice (GhcPass 'Renamed) -&gt; (PendingRnSplice, a))
-&gt; HsUntypedSplice GhcPs
-&gt; RnM (a, Uses)
</span><a href="GHC.Rename.Splice.html#rnUntypedSpliceGen"><span class="hs-identifier hs-var">rnUntypedSpliceGen</span></a></span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
-&gt; RnM
     ((HsUntypedSplice (GhcPass 'Renamed),
       HsUntypedSpliceResult (GenLocated SrcSpanAnnA (Pat GhcPs))),
      Uses)
</span><a href="#local-6989586621683065650"><span class="hs-identifier hs-var">run_pat_splice</span></a></span><span> </span><span class="annot"><span class="annottext">Name
-&gt; HsUntypedSplice (GhcPass 'Renamed)
-&gt; (PendingRnSplice,
    (HsUntypedSplice (GhcPass 'Renamed),
     HsUntypedSpliceResult (GenLocated SrcSpanAnnA (Pat GhcPs))))
forall {thing}.
Name
-&gt; HsUntypedSplice (GhcPass 'Renamed)
-&gt; (PendingRnSplice,
    (HsUntypedSplice (GhcPass 'Renamed), HsUntypedSpliceResult thing))
</span><a href="#local-6989586621683065651"><span class="hs-identifier hs-var">pend_pat_splice</span></a></span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice GhcPs
</span><a href="#local-6989586621683065649"><span class="hs-identifier hs-var">splice</span></a></span><span>
</span><span id="line-769"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-770"></span><span>    </span><span id="local-6989586621683065651"><span class="annot"><span class="annottext">pend_pat_splice :: Name
-&gt; HsUntypedSplice (GhcPass 'Renamed)
-&gt; (PendingRnSplice,
    (HsUntypedSplice (GhcPass 'Renamed), HsUntypedSpliceResult thing))
</span><a href="#local-6989586621683065651"><span class="hs-identifier hs-var hs-var">pend_pat_splice</span></a></span></span><span> </span><span id="local-6989586621683065652"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065652"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621683065653"><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
</span><a href="#local-6989586621683065653"><span class="hs-identifier hs-var">rn_splice</span></a></span></span><span>
</span><span id="line-771"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UntypedSpliceFlavour
-&gt; Name -&gt; HsUntypedSplice (GhcPass 'Renamed) -&gt; PendingRnSplice
</span><a href="GHC.Rename.Splice.html#makePending"><span class="hs-identifier hs-var">makePending</span></a></span><span> </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="GHC.Hs.Expr.html#UntypedPatSplice"><span class="hs-identifier hs-var">UntypedPatSplice</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065652"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
</span><a href="#local-6989586621683065653"><span class="hs-identifier hs-var">rn_splice</span></a></span><span>
</span><span id="line-772"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
</span><a href="#local-6989586621683065653"><span class="hs-identifier hs-var">rn_splice</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name -&gt; HsUntypedSpliceResult thing
forall thing. Name -&gt; HsUntypedSpliceResult thing
</span><a href="GHC.Hs.Expr.html#HsUntypedSpliceNested"><span class="hs-identifier hs-var">HsUntypedSpliceNested</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065652"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Pat splice is nested and thus simply renamed</span><span>
</span><span id="line-773"></span><span>
</span><span id="line-774"></span><span>    </span><span id="local-6989586621683065650"><span class="annot"><span class="annottext">run_pat_splice :: HsUntypedSplice (GhcPass 'Renamed)
-&gt; RnM
     ((HsUntypedSplice (GhcPass 'Renamed),
       HsUntypedSpliceResult (GenLocated SrcSpanAnnA (Pat GhcPs))),
      Uses)
</span><a href="#local-6989586621683065650"><span class="hs-identifier hs-var hs-var">run_pat_splice</span></a></span></span><span> </span><span id="local-6989586621683065671"><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
</span><a href="#local-6989586621683065671"><span class="hs-identifier hs-var">rn_splice</span></a></span></span><span>
</span><span id="line-775"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; RnM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rnSplicePat: untyped pattern splice&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsOutput doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a></span><span>
</span><span id="line-776"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683065672"><span class="annot"><a href="#local-6989586621683065672"><span class="hs-identifier hs-var">pat</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683065673"><span class="annot"><a href="#local-6989586621683065673"><span class="hs-identifier hs-var">mod_finalizers</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-777"></span><span>                </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
-&gt; (LHsExpr GhcTc -&gt; TcRn (GenLocated SrcSpanAnnA (Pat GhcPs)))
-&gt; (GenLocated SrcSpanAnnA (Pat GhcPs) -&gt; SDoc)
-&gt; HsUntypedSplice (GhcPass 'Renamed)
-&gt; TcRn (GenLocated SrcSpanAnnA (Pat GhcPs), [ForeignRef (Q ())])
forall res.
UntypedSpliceFlavour
-&gt; (LHsExpr GhcTc -&gt; TcRn res)
-&gt; (res -&gt; SDoc)
-&gt; HsUntypedSplice (GhcPass 'Renamed)
-&gt; TcRn (res, [ForeignRef (Q ())])
</span><a href="GHC.Rename.Splice.html#runRnSplice"><span class="hs-identifier hs-var">runRnSplice</span></a></span><span> </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="GHC.Hs.Expr.html#UntypedPatSplice"><span class="hs-identifier hs-var">UntypedPatSplice</span></a></span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcTc -&gt; TcM (LPat GhcPs)
LHsExpr GhcTc -&gt; TcRn (GenLocated SrcSpanAnnA (Pat GhcPs))
</span><a href="GHC.Tc.Gen.Splice.html#runMetaP"><span class="hs-identifier hs-var">runMetaP</span></a></span><span> </span><span class="annot"><span class="annottext">GenLocated SrcSpanAnnA (Pat GhcPs) -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
</span><a href="#local-6989586621683065671"><span class="hs-identifier hs-var">rn_splice</span></a></span><span>
</span><span id="line-778"></span><span>             </span><span class="hs-comment">-- See Note [Delaying modFinalizers in untyped splices].</span><span>
</span><span id="line-779"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683065674"><span class="annot"><a href="#local-6989586621683065674"><span class="hs-identifier hs-var hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ThModFinalizers
-&gt; GenLocated SrcSpanAnnA (Pat GhcPs)
-&gt; HsUntypedSpliceResult (GenLocated SrcSpanAnnA (Pat GhcPs))
forall thing.
ThModFinalizers -&gt; thing -&gt; HsUntypedSpliceResult thing
</span><a href="GHC.Hs.Expr.html#HsUntypedSpliceTop"><span class="hs-identifier hs-var">HsUntypedSpliceTop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ForeignRef (Q ())] -&gt; ThModFinalizers
</span><a href="GHC.Hs.Expr.html#ThModFinalizers"><span class="hs-identifier hs-var">ThModFinalizers</span></a></span><span> </span><span class="annot"><span class="annottext">[ForeignRef (Q ())]
</span><a href="#local-6989586621683065673"><span class="hs-identifier hs-var">mod_finalizers</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">GenLocated SrcSpanAnnA (Pat GhcPs)
</span><a href="#local-6989586621683065672"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-780"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683065671"><span class="hs-identifier hs-type">rn_splice</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683065674"><span class="hs-identifier hs-type">p</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html#emptyFVs"><span class="hs-identifier hs-type">emptyFVs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-781"></span><span>              </span><span class="hs-comment">-- Wrap the result of the quasi-quoter in parens so that we don't</span><span>
</span><span id="line-782"></span><span>              </span><span class="hs-comment">-- lose the outermost location set by runQuasiQuote (#7918)</span><span>
</span><span id="line-783"></span><span>
</span><span id="line-784"></span><span class="annot"><span class="hs-comment">-- | Rename a splice type pattern. Much the same as `rnSplicePat`, but works with LHsType instead of LPat</span></span><span>
</span><span id="line-785"></span><span class="annot"><a href="GHC.Rename.Splice.html#rnSpliceTyPat"><span class="hs-identifier hs-type">rnSpliceTyPat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsUntypedSplice"><span class="hs-identifier hs-type">HsUntypedSplice</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcPs"><span class="hs-identifier hs-type">GhcPs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#RnM"><span class="hs-identifier hs-type">RnM</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsUntypedSplice"><span class="hs-identifier hs-type">HsUntypedSplice</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Hs.Expr.html#HsUntypedSpliceResult"><span class="hs-identifier hs-type">HsUntypedSpliceResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Type.html#LHsType"><span class="hs-identifier hs-type">LHsType</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcPs"><span class="hs-identifier hs-type">GhcPs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-786"></span><span>                                            </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html#FreeVars"><span class="hs-identifier hs-type">FreeVars</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-787"></span><span id="rnSpliceTyPat"><span class="annot"><span class="annottext">rnSpliceTyPat :: HsUntypedSplice GhcPs
-&gt; RnM
     ((HsUntypedSplice (GhcPass 'Renamed),
       HsUntypedSpliceResult (LHsType GhcPs)),
      Uses)
</span><a href="GHC.Rename.Splice.html#rnSpliceTyPat"><span class="hs-identifier hs-var hs-var">rnSpliceTyPat</span></a></span></span><span> </span><span id="local-6989586621683065675"><span class="annot"><span class="annottext">HsUntypedSplice GhcPs
</span><a href="#local-6989586621683065675"><span class="hs-identifier hs-var">splice</span></a></span></span><span>
</span><span id="line-788"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(HsUntypedSplice (GhcPass 'Renamed)
 -&gt; RnM
      ((HsUntypedSplice (GhcPass 'Renamed),
        HsUntypedSpliceResult (GenLocated SrcSpanAnnA (HsType GhcPs))),
       Uses))
-&gt; (Name
    -&gt; HsUntypedSplice (GhcPass 'Renamed)
    -&gt; (PendingRnSplice,
        (HsUntypedSplice (GhcPass 'Renamed),
         HsUntypedSpliceResult (GenLocated SrcSpanAnnA (HsType GhcPs)))))
-&gt; HsUntypedSplice GhcPs
-&gt; RnM
     ((HsUntypedSplice (GhcPass 'Renamed),
       HsUntypedSpliceResult (GenLocated SrcSpanAnnA (HsType GhcPs))),
      Uses)
forall a.
(HsUntypedSplice (GhcPass 'Renamed) -&gt; RnM (a, Uses))
-&gt; (Name
    -&gt; HsUntypedSplice (GhcPass 'Renamed) -&gt; (PendingRnSplice, a))
-&gt; HsUntypedSplice GhcPs
-&gt; RnM (a, Uses)
</span><a href="GHC.Rename.Splice.html#rnUntypedSpliceGen"><span class="hs-identifier hs-var">rnUntypedSpliceGen</span></a></span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
-&gt; RnM
     ((HsUntypedSplice (GhcPass 'Renamed),
       HsUntypedSpliceResult (GenLocated SrcSpanAnnA (HsType GhcPs))),
      Uses)
</span><a href="#local-6989586621683065676"><span class="hs-identifier hs-var">run_ty_pat_splice</span></a></span><span> </span><span class="annot"><span class="annottext">Name
-&gt; HsUntypedSplice (GhcPass 'Renamed)
-&gt; (PendingRnSplice,
    (HsUntypedSplice (GhcPass 'Renamed),
     HsUntypedSpliceResult (GenLocated SrcSpanAnnA (HsType GhcPs))))
forall {thing}.
Name
-&gt; HsUntypedSplice (GhcPass 'Renamed)
-&gt; (PendingRnSplice,
    (HsUntypedSplice (GhcPass 'Renamed), HsUntypedSpliceResult thing))
</span><a href="#local-6989586621683065677"><span class="hs-identifier hs-var">pend_ty_pat_splice</span></a></span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice GhcPs
</span><a href="#local-6989586621683065675"><span class="hs-identifier hs-var">splice</span></a></span><span>
</span><span id="line-789"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-790"></span><span>    </span><span id="local-6989586621683065677"><span class="annot"><span class="annottext">pend_ty_pat_splice :: Name
-&gt; HsUntypedSplice (GhcPass 'Renamed)
-&gt; (PendingRnSplice,
    (HsUntypedSplice (GhcPass 'Renamed), HsUntypedSpliceResult thing))
</span><a href="#local-6989586621683065677"><span class="hs-identifier hs-var hs-var">pend_ty_pat_splice</span></a></span></span><span> </span><span id="local-6989586621683065678"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065678"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621683065679"><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
</span><a href="#local-6989586621683065679"><span class="hs-identifier hs-var">rn_splice</span></a></span></span><span>
</span><span id="line-791"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UntypedSpliceFlavour
-&gt; Name -&gt; HsUntypedSplice (GhcPass 'Renamed) -&gt; PendingRnSplice
</span><a href="GHC.Rename.Splice.html#makePending"><span class="hs-identifier hs-var">makePending</span></a></span><span> </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="GHC.Hs.Expr.html#UntypedTypeSplice"><span class="hs-identifier hs-var">UntypedTypeSplice</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065678"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
</span><a href="#local-6989586621683065679"><span class="hs-identifier hs-var">rn_splice</span></a></span><span>
</span><span id="line-792"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
</span><a href="#local-6989586621683065679"><span class="hs-identifier hs-var">rn_splice</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name -&gt; HsUntypedSpliceResult thing
forall thing. Name -&gt; HsUntypedSpliceResult thing
</span><a href="GHC.Hs.Expr.html#HsUntypedSpliceNested"><span class="hs-identifier hs-var">HsUntypedSpliceNested</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065678"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- HsType splice is nested and thus simply renamed</span><span>
</span><span id="line-793"></span><span>
</span><span id="line-794"></span><span>    </span><span id="local-6989586621683065676"><span class="annot"><span class="annottext">run_ty_pat_splice :: HsUntypedSplice (GhcPass 'Renamed)
-&gt; RnM
     ((HsUntypedSplice (GhcPass 'Renamed),
       HsUntypedSpliceResult (GenLocated SrcSpanAnnA (HsType GhcPs))),
      Uses)
</span><a href="#local-6989586621683065676"><span class="hs-identifier hs-var hs-var">run_ty_pat_splice</span></a></span></span><span> </span><span id="local-6989586621683065696"><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
</span><a href="#local-6989586621683065696"><span class="hs-identifier hs-var">rn_splice</span></a></span></span><span>
</span><span id="line-795"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; RnM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rnSpliceTyPat: untyped pattern splice&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsOutput doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a></span><span>
</span><span id="line-796"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683065697"><span class="annot"><a href="#local-6989586621683065697"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683065698"><span class="annot"><a href="#local-6989586621683065698"><span class="hs-identifier hs-var">mod_finalizers</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-797"></span><span>                </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
-&gt; (LHsExpr GhcTc -&gt; TcRn (GenLocated SrcSpanAnnA (HsType GhcPs)))
-&gt; (GenLocated SrcSpanAnnA (HsType GhcPs) -&gt; SDoc)
-&gt; HsUntypedSplice (GhcPass 'Renamed)
-&gt; TcRn
     (GenLocated SrcSpanAnnA (HsType GhcPs), [ForeignRef (Q ())])
forall res.
UntypedSpliceFlavour
-&gt; (LHsExpr GhcTc -&gt; TcRn res)
-&gt; (res -&gt; SDoc)
-&gt; HsUntypedSplice (GhcPass 'Renamed)
-&gt; TcRn (res, [ForeignRef (Q ())])
</span><a href="GHC.Rename.Splice.html#runRnSplice"><span class="hs-identifier hs-var">runRnSplice</span></a></span><span> </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="GHC.Hs.Expr.html#UntypedTypeSplice"><span class="hs-identifier hs-var">UntypedTypeSplice</span></a></span><span> </span><span class="annot"><span class="annottext">LHsExpr GhcTc -&gt; TcM (LHsType GhcPs)
LHsExpr GhcTc -&gt; TcRn (GenLocated SrcSpanAnnA (HsType GhcPs))
</span><a href="GHC.Tc.Gen.Splice.html#runMetaT"><span class="hs-identifier hs-var">runMetaT</span></a></span><span> </span><span class="annot"><span class="annottext">GenLocated SrcSpanAnnA (HsType GhcPs) -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
</span><a href="#local-6989586621683065696"><span class="hs-identifier hs-var">rn_splice</span></a></span><span>
</span><span id="line-798"></span><span>             </span><span class="hs-comment">-- See Note [Delaying modFinalizers in untyped splices].</span><span>
</span><span id="line-799"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683065699"><span class="annot"><a href="#local-6989586621683065699"><span class="hs-identifier hs-var hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ThModFinalizers
-&gt; GenLocated SrcSpanAnnA (HsType GhcPs)
-&gt; HsUntypedSpliceResult (GenLocated SrcSpanAnnA (HsType GhcPs))
forall thing.
ThModFinalizers -&gt; thing -&gt; HsUntypedSpliceResult thing
</span><a href="GHC.Hs.Expr.html#HsUntypedSpliceTop"><span class="hs-identifier hs-var">HsUntypedSpliceTop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ForeignRef (Q ())] -&gt; ThModFinalizers
</span><a href="GHC.Hs.Expr.html#ThModFinalizers"><span class="hs-identifier hs-var">ThModFinalizers</span></a></span><span> </span><span class="annot"><span class="annottext">[ForeignRef (Q ())]
</span><a href="#local-6989586621683065698"><span class="hs-identifier hs-var">mod_finalizers</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">GenLocated SrcSpanAnnA (HsType GhcPs)
</span><a href="#local-6989586621683065697"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-800"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683065696"><span class="hs-identifier hs-type">rn_splice</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683065699"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html#emptyFVs"><span class="hs-identifier hs-type">emptyFVs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-801"></span><span>              </span><span class="hs-comment">-- Wrap the result of the quasi-quoter in parens so that we don't</span><span>
</span><span id="line-802"></span><span>              </span><span class="hs-comment">-- lose the outermost location set by runQuasiQuote (#7918)</span><span>
</span><span id="line-803"></span><span>
</span><span id="line-804"></span><span class="hs-comment">----------------------</span><span>
</span><span id="line-805"></span><span class="annot"><a href="GHC.Rename.Splice.html#rnSpliceDecl"><span class="hs-identifier hs-type">rnSpliceDecl</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Decls.html#SpliceDecl"><span class="hs-identifier hs-type">SpliceDecl</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcPs"><span class="hs-identifier hs-type">GhcPs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#RnM"><span class="hs-identifier hs-type">RnM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Decls.html#SpliceDecl"><span class="hs-identifier hs-type">SpliceDecl</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html#FreeVars"><span class="hs-identifier hs-type">FreeVars</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-806"></span><span id="rnSpliceDecl"><span class="annot"><span class="annottext">rnSpliceDecl :: SpliceDecl GhcPs -&gt; RnM (SpliceDecl (GhcPass 'Renamed), Uses)
</span><a href="GHC.Rename.Splice.html#rnSpliceDecl"><span class="hs-identifier hs-var hs-var">rnSpliceDecl</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Decls.html#SpliceDecl"><span class="hs-identifier hs-type">SpliceDecl</span></a></span><span> </span><span class="annot"><span class="annottext">XSpliceDecl GhcPs
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.SrcLoc.html#L"><span class="hs-identifier hs-type">L</span></a></span><span> </span><span id="local-6989586621683065701"><span class="annot"><span class="annottext">SrcSpanAnnA
</span><a href="#local-6989586621683065701"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621683065702"><span class="annot"><span class="annottext">HsUntypedSplice GhcPs
</span><a href="#local-6989586621683065702"><span class="hs-identifier hs-var">splice</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621683065703"><span class="annot"><span class="annottext">SpliceDecoration
</span><a href="#local-6989586621683065703"><span class="hs-identifier hs-var">flg</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-807"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(HsUntypedSplice (GhcPass 'Renamed)
 -&gt; RnM (SpliceDecl (GhcPass 'Renamed), Uses))
-&gt; (Name
    -&gt; HsUntypedSplice (GhcPass 'Renamed)
    -&gt; (PendingRnSplice, SpliceDecl (GhcPass 'Renamed)))
-&gt; HsUntypedSplice GhcPs
-&gt; RnM (SpliceDecl (GhcPass 'Renamed), Uses)
forall a.
(HsUntypedSplice (GhcPass 'Renamed) -&gt; RnM (a, Uses))
-&gt; (Name
    -&gt; HsUntypedSplice (GhcPass 'Renamed) -&gt; (PendingRnSplice, a))
-&gt; HsUntypedSplice GhcPs
-&gt; RnM (a, Uses)
</span><a href="GHC.Rename.Splice.html#rnUntypedSpliceGen"><span class="hs-identifier hs-var">rnUntypedSpliceGen</span></a></span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
-&gt; RnM (SpliceDecl (GhcPass 'Renamed), Uses)
forall {p :: Pass} {a}.
(OutputableBndr (IdGhcP p),
 OutputableBndr (IdGhcP (NoGhcTcPass p)), IsPass p,
 Outputable (GenLocated (Anno (IdGhcP p)) (IdGhcP p)),
 Outputable
   (GenLocated
      (Anno (IdGhcP (NoGhcTcPass p))) (IdGhcP (NoGhcTcPass p)))) =&gt;
HsUntypedSplice (GhcPass p) -&gt; a
</span><a href="#local-6989586621683065704"><span class="hs-identifier hs-var">run_decl_splice</span></a></span><span> </span><span class="annot"><span class="annottext">Name
-&gt; HsUntypedSplice (GhcPass 'Renamed)
-&gt; (PendingRnSplice, SpliceDecl (GhcPass 'Renamed))
</span><a href="#local-6989586621683065705"><span class="hs-identifier hs-var">pend_decl_splice</span></a></span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice GhcPs
</span><a href="#local-6989586621683065702"><span class="hs-identifier hs-var">splice</span></a></span><span>
</span><span id="line-808"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-809"></span><span>    </span><span id="local-6989586621683065705"><span class="annot"><span class="annottext">pend_decl_splice :: Name
-&gt; HsUntypedSplice (GhcPass 'Renamed)
-&gt; (PendingRnSplice, SpliceDecl (GhcPass 'Renamed))
</span><a href="#local-6989586621683065705"><span class="hs-identifier hs-var hs-var">pend_decl_splice</span></a></span></span><span> </span><span id="local-6989586621683065706"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065706"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621683065707"><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
</span><a href="#local-6989586621683065707"><span class="hs-identifier hs-var">rn_splice</span></a></span></span><span>
</span><span id="line-810"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
-&gt; Name -&gt; HsUntypedSplice (GhcPass 'Renamed) -&gt; PendingRnSplice
</span><a href="GHC.Rename.Splice.html#makePending"><span class="hs-identifier hs-var">makePending</span></a></span><span> </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="GHC.Hs.Expr.html#UntypedDeclSplice"><span class="hs-identifier hs-var">UntypedDeclSplice</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065706"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
</span><a href="#local-6989586621683065707"><span class="hs-identifier hs-var">rn_splice</span></a></span><span>
</span><span id="line-811"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">XSpliceDecl (GhcPass 'Renamed)
-&gt; XRec (GhcPass 'Renamed) (HsUntypedSplice (GhcPass 'Renamed))
-&gt; SpliceDecoration
-&gt; SpliceDecl (GhcPass 'Renamed)
forall p.
XSpliceDecl p
-&gt; XRec p (HsUntypedSplice p) -&gt; SpliceDecoration -&gt; SpliceDecl p
</span><a href="Language.Haskell.Syntax.Decls.html#SpliceDecl"><span class="hs-identifier hs-var">SpliceDecl</span></a></span><span> </span><span class="annot"><span class="annottext">XSpliceDecl (GhcPass 'Renamed)
NoExtField
</span><a href="Language.Haskell.Syntax.Extension.html#noExtField"><span class="hs-identifier hs-var">noExtField</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SrcSpanAnnA
-&gt; HsUntypedSplice (GhcPass 'Renamed)
-&gt; GenLocated SrcSpanAnnA (HsUntypedSplice (GhcPass 'Renamed))
forall l e. l -&gt; e -&gt; GenLocated l e
</span><a href="GHC.Types.SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpanAnnA
</span><a href="#local-6989586621683065701"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass 'Renamed)
</span><a href="#local-6989586621683065707"><span class="hs-identifier hs-var">rn_splice</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SpliceDecoration
</span><a href="#local-6989586621683065703"><span class="hs-identifier hs-var">flg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-812"></span><span>
</span><span id="line-813"></span><span>    </span><span id="local-6989586621683065704"><span class="annot"><span class="annottext">run_decl_splice :: HsUntypedSplice (GhcPass p) -&gt; a
</span><a href="#local-6989586621683065704"><span class="hs-identifier hs-var hs-var">run_decl_splice</span></a></span></span><span> </span><span id="local-6989586621683065733"><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass p)
</span><a href="#local-6989586621683065733"><span class="hs-identifier hs-var">rn_splice</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; a
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rnSpliceDecl&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Maybe Name -&gt; HsUntypedSplice (GhcPass p) -&gt; SDoc
forall (p :: Pass).
OutputableBndrId p =&gt;
Bool -&gt; Maybe Name -&gt; HsUntypedSplice (GhcPass p) -&gt; SDoc
</span><a href="GHC.Hs.Expr.html#pprUntypedSplice"><span class="hs-identifier hs-var">pprUntypedSplice</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">Maybe Name
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice (GhcPass p)
</span><a href="#local-6989586621683065733"><span class="hs-identifier hs-var">rn_splice</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-814"></span><span>
</span><span id="line-815"></span><span class="annot"><a href="GHC.Rename.Splice.html#rnTopSpliceDecls"><span class="hs-identifier hs-type">rnTopSpliceDecls</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsUntypedSplice"><span class="hs-identifier hs-type">HsUntypedSplice</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcPs"><span class="hs-identifier hs-type">GhcPs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#RnM"><span class="hs-identifier hs-type">RnM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Language.Haskell.Syntax.Decls.html#LHsDecl"><span class="hs-identifier hs-type">LHsDecl</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcPs"><span class="hs-identifier hs-type">GhcPs</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html#FreeVars"><span class="hs-identifier hs-type">FreeVars</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-816"></span><span class="hs-comment">-- Declaration splice at the very top level of the module</span><span>
</span><span id="line-817"></span><span id="rnTopSpliceDecls"><span class="annot"><span class="annottext">rnTopSpliceDecls :: HsUntypedSplice GhcPs -&gt; RnM ([LHsDecl GhcPs], Uses)
</span><a href="GHC.Rename.Splice.html#rnTopSpliceDecls"><span class="hs-identifier hs-var hs-var">rnTopSpliceDecls</span></a></span></span><span> </span><span id="local-6989586621683065735"><span class="annot"><span class="annottext">HsUntypedSplice GhcPs
</span><a href="#local-6989586621683065735"><span class="hs-identifier hs-var">splice</span></a></span></span><span>
</span><span id="line-818"></span><span>   </span><span class="hs-glyph">=</span><span>  </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice GhcPs -&gt; RnM ()
</span><a href="GHC.Rename.Splice.html#checkTopSpliceAllowed"><span class="hs-identifier hs-var">checkTopSpliceAllowed</span></a></span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice GhcPs
</span><a href="#local-6989586621683065735"><span class="hs-identifier hs-var">splice</span></a></span><span>
</span><span id="line-819"></span><span>         </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683065736"><span class="annot"><a href="#local-6989586621683065736"><span class="hs-identifier hs-var">rn_splice</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683065737"><span class="annot"><a href="#local-6989586621683065737"><span class="hs-identifier hs-var">fvs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM (HsUntypedSplice (GhcPass 'Renamed), Uses)
-&gt; TcM (HsUntypedSplice (GhcPass 'Renamed), Uses)
forall r. TcM r -&gt; TcM r
</span><a href="GHC.Tc.Utils.Monad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a></span><span> </span><span class="annot"><span class="annottext">(TcM (HsUntypedSplice (GhcPass 'Renamed), Uses)
 -&gt; TcM (HsUntypedSplice (GhcPass 'Renamed), Uses))
-&gt; TcM (HsUntypedSplice (GhcPass 'Renamed), Uses)
-&gt; TcM (HsUntypedSplice (GhcPass 'Renamed), Uses)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-820"></span><span>                               </span><span class="annot"><span class="annottext">ThStage
-&gt; TcM (HsUntypedSplice (GhcPass 'Renamed), Uses)
-&gt; TcM (HsUntypedSplice (GhcPass 'Renamed), Uses)
forall a. ThStage -&gt; TcM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#setStage"><span class="hs-identifier hs-var">setStage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpliceType -&gt; ThStage
</span><a href="GHC.Tc.Types.TH.html#Splice"><span class="hs-identifier hs-var">Splice</span></a></span><span> </span><span class="annot"><span class="annottext">SpliceType
</span><a href="GHC.Tc.Types.TH.html#Untyped"><span class="hs-identifier hs-var">Untyped</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcM (HsUntypedSplice (GhcPass 'Renamed), Uses)
 -&gt; TcM (HsUntypedSplice (GhcPass 'Renamed), Uses))
-&gt; TcM (HsUntypedSplice (GhcPass 'Renamed), Uses)
-&gt; TcM (HsUntypedSplice (GhcPass 'Renamed), Uses)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-821"></span><span>                               </span><span class="annot"><span class="annottext">HsUntypedSplice GhcPs
-&gt; TcM (HsUntypedSplice (GhcPass 'Renamed), Uses)
</span><a href="GHC.Rename.Splice.html#rnUntypedSplice"><span class="hs-identifier hs-var">rnUntypedSplice</span></a></span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice GhcPs
</span><a href="#local-6989586621683065735"><span class="hs-identifier hs-var">splice</span></a></span><span>
</span><span id="line-822"></span><span>           </span><span class="hs-comment">-- As always, be sure to checkNoErrs above lest we end up with</span><span>
</span><span id="line-823"></span><span>           </span><span class="hs-comment">-- holes making it to typechecking, hence #12584.</span><span>
</span><span id="line-824"></span><span>           </span><span class="hs-comment">--</span><span>
</span><span id="line-825"></span><span>           </span><span class="hs-comment">-- Note that we cannot call checkNoErrs for the whole duration</span><span>
</span><span id="line-826"></span><span>           </span><span class="hs-comment">-- of rnTopSpliceDecls. The reason is that checkNoErrs changes</span><span>
</span><span id="line-827"></span><span>           </span><span class="hs-comment">-- the local environment to temporarily contain a new</span><span>
</span><span id="line-828"></span><span>           </span><span class="hs-comment">-- reference to store errors, and add_mod_finalizers would</span><span>
</span><span id="line-829"></span><span>           </span><span class="hs-comment">-- cause this reference to be stored after checkNoErrs finishes.</span><span>
</span><span id="line-830"></span><span>           </span><span class="hs-comment">-- This is checked by test TH_finalizer.</span><span>
</span><span id="line-831"></span><span>         </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceRn"><span class="hs-identifier hs-type">traceRn</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;rnTopSpliceDecls: untyped declaration splice&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#empty"><span class="hs-identifier hs-type">empty</span></a></span><span>
</span><span id="line-832"></span><span>         </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683065738"><span class="annot"><a href="#local-6989586621683065738"><span class="hs-identifier hs-var">decls</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683065739"><span class="annot"><a href="#local-6989586621683065739"><span class="hs-identifier hs-var">mod_finalizers</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#checkNoErrs"><span class="hs-identifier hs-type">checkNoErrs</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-833"></span><span>               </span><span class="annot"><a href="GHC.Rename.Splice.html#runRnSplice"><span class="hs-identifier hs-type">runRnSplice</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Expr.html#UntypedDeclSplice"><span class="hs-identifier hs-type">UntypedDeclSplice</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Gen.Splice.html#runMetaD"><span class="hs-identifier hs-type">runMetaD</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065740"><span class="hs-identifier hs-type">ppr_decls</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065736"><span class="hs-identifier hs-type">rn_splice</span></a></span><span>
</span><span id="line-834"></span><span>         </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="#local-6989586621683065741"><span class="hs-identifier hs-type">add_mod_finalizers_now</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065739"><span class="hs-identifier hs-type">mod_finalizers</span></a></span><span>
</span><span id="line-835"></span><span>         </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683065738"><span class="hs-identifier hs-type">decls</span></a></span><span class="hs-special">,</span><span class="annot"><a href="#local-6989586621683065737"><span class="hs-identifier hs-type">fvs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-836"></span><span>   </span><span class="hs-keyword">where</span><span>
</span><span id="line-837"></span><span>     </span><span class="annot"><a href="#local-6989586621683065740"><span class="hs-identifier hs-type">ppr_decls</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Haskell.Syntax.Decls.html#LHsDecl"><span class="hs-identifier hs-type">LHsDecl</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcPs"><span class="hs-identifier hs-type">GhcPs</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span>
</span><span id="line-838"></span><span>     </span><span id="local-6989586621683065740"><span class="annot"><span class="annottext">ppr_decls :: [LHsDecl GhcPs] -&gt; SDoc
</span><a href="#local-6989586621683065740"><span class="hs-identifier hs-var hs-var">ppr_decls</span></a></span></span><span> </span><span id="local-6989586621683065742"><span class="annot"><span class="annottext">[LHsDecl GhcPs]
</span><a href="#local-6989586621683065742"><span class="hs-identifier hs-var">ds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(GenLocated SrcSpanAnnA (HsDecl GhcPs) -&gt; SDoc)
-&gt; [GenLocated SrcSpanAnnA (HsDecl GhcPs)] -&gt; [SDoc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">GenLocated SrcSpanAnnA (HsDecl GhcPs) -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[LHsDecl GhcPs]
[GenLocated SrcSpanAnnA (HsDecl GhcPs)]
</span><a href="#local-6989586621683065742"><span class="hs-identifier hs-var">ds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-839"></span><span>
</span><span id="line-840"></span><span>     </span><span class="hs-comment">-- Adds finalizers to the global environment instead of delaying them</span><span>
</span><span id="line-841"></span><span>     </span><span class="hs-comment">-- to the type checker.</span><span>
</span><span id="line-842"></span><span>     </span><span class="hs-comment">--</span><span>
</span><span id="line-843"></span><span>     </span><span class="hs-comment">-- Declaration splices do not have an interesting local environment so</span><span>
</span><span id="line-844"></span><span>     </span><span class="hs-comment">-- there is no point in delaying them.</span><span>
</span><span id="line-845"></span><span>     </span><span class="hs-comment">--</span><span>
</span><span id="line-846"></span><span>     </span><span class="hs-comment">-- See Note [Delaying modFinalizers in untyped splices].</span><span>
</span><span id="line-847"></span><span>     </span><span class="annot"><a href="#local-6989586621683065741"><span class="hs-identifier hs-type">add_mod_finalizers_now</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html#ForeignRef"><span class="hs-identifier hs-type">ForeignRef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.Q</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcRn"><span class="hs-identifier hs-type">TcRn</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-848"></span><span>     </span><span id="local-6989586621683065741"><span class="annot"><span class="annottext">add_mod_finalizers_now :: [ForeignRef (Q ())] -&gt; RnM ()
</span><a href="#local-6989586621683065741"><span class="hs-identifier hs-var hs-var">add_mod_finalizers_now</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; RnM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-849"></span><span>     </span><span class="annot"><a href="#local-6989586621683065741"><span class="hs-identifier hs-var">add_mod_finalizers_now</span></a></span><span> </span><span id="local-6989586621683065744"><span class="annot"><span class="annottext">[ForeignRef (Q ())]
</span><a href="#local-6989586621683065744"><span class="hs-identifier hs-var">mod_finalizers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-850"></span><span>       </span><span id="local-6989586621683065745"><span class="annot"><a href="#local-6989586621683065745"><span class="hs-identifier hs-var">th_modfinalizers_var</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TcGblEnv -&gt; TcRef [(TcLclEnv, ThModFinalizers)])
-&gt; TcRnIf TcGblEnv TcLclEnv TcGblEnv
-&gt; IOEnv
     (Env TcGblEnv TcLclEnv) (TcRef [(TcLclEnv, ThModFinalizers)])
forall a b.
(a -&gt; b)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) a
-&gt; IOEnv (Env TcGblEnv TcLclEnv) b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">TcGblEnv -&gt; TcRef [(TcLclEnv, ThModFinalizers)]
</span><a href="GHC.Tc.Types.html#tcg_th_modfinalizers"><span class="hs-identifier hs-var">tcg_th_modfinalizers</span></a></span><span> </span><span class="annot"><span class="annottext">TcRnIf TcGblEnv TcLclEnv TcGblEnv
forall gbl lcl. TcRnIf gbl lcl gbl
</span><a href="GHC.Tc.Utils.Monad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a></span><span>
</span><span id="line-851"></span><span>       </span><span id="local-6989586621683065747"><span class="annot"><a href="#local-6989586621683065747"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#getLclEnv"><span class="hs-identifier hs-type">getLclEnv</span></a></span><span>
</span><span id="line-852"></span><span>       </span><span class="annot"><a href="GHC.Tc.Types.TcRef.html#updTcRef"><span class="hs-identifier hs-type">updTcRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065745"><span class="hs-identifier hs-type">th_modfinalizers_var</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621683065750"><span class="annot"><span class="annottext">[(TcLclEnv, ThModFinalizers)]
</span><a href="#local-6989586621683065750"><span class="hs-identifier hs-var">fins</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-853"></span><span>         </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcLclEnv
</span><a href="#local-6989586621683065747"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[ForeignRef (Q ())] -&gt; ThModFinalizers
</span><a href="GHC.Hs.Expr.html#ThModFinalizers"><span class="hs-identifier hs-var">ThModFinalizers</span></a></span><span> </span><span class="annot"><span class="annottext">[ForeignRef (Q ())]
</span><a href="#local-6989586621683065744"><span class="hs-identifier hs-var">mod_finalizers</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcLclEnv, ThModFinalizers)
-&gt; [(TcLclEnv, ThModFinalizers)] -&gt; [(TcLclEnv, ThModFinalizers)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[(TcLclEnv, ThModFinalizers)]
</span><a href="#local-6989586621683065750"><span class="hs-identifier hs-var">fins</span></a></span><span>
</span><span id="line-854"></span><span>
</span><span id="line-855"></span><span>
</span><span id="line-856"></span><span class="hs-comment">{-
Note [rnSplicePat]
~~~~~~~~~~~~~~~~~~
Renaming a pattern splice is a bit tricky, because we need the variables
bound in the pattern to be in scope in the RHS of the pattern. This scope
management is effectively done by using continuation-passing style in
GHC.Rename.Pat, through the CpsRn monad. We don't wish to be in that monad here
(it would create import cycles and generally conflict with renaming other
splices), so we really want to return a (Pat GhcPs) -- the result of
running the splice -- which can then be further renamed in GHC.Rename.Pat, in
the CpsRn monad.

The problem is that if we're renaming a splice within a bracket, we
*don't* want to run the splice now. We really do just want to rename
it to an HsUntypedSplice Name. Of course, then we can't know what variables
are bound within the splice. So we accept any unbound variables and
rename them again when the bracket is spliced in.  If a variable is brought
into scope by a pattern splice all is fine.  If it is not then an error is
reported.

In any case, when we're done in rnSplicePat, we'll have both the renamed
splice, and either a Pat RdrName and ThModFinalizers (the result of running a
top-level splice) or a splice point name. Thus, rnSplicePat returns both
HsUntypedSplice GhcRn, and HsUntypedSpliceResult (Pat GhcPs) -- which models
the existence of either the result of running the splice (HsUntypedSpliceTop),
or its splice point name if nested (HsUntypedSpliceNested)
-}</span><span>
</span><span id="line-883"></span><span>
</span><span id="line-884"></span><span class="annot"><a href="GHC.Rename.Splice.html#spliceCtxt"><span class="hs-identifier hs-type">spliceCtxt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsUntypedSplice"><span class="hs-identifier hs-type">HsUntypedSplice</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcPs"><span class="hs-identifier hs-type">GhcPs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span>
</span><span id="line-885"></span><span id="spliceCtxt"><span class="annot"><span class="annottext">spliceCtxt :: HsUntypedSplice GhcPs -&gt; SDoc
</span><a href="GHC.Rename.Splice.html#spliceCtxt"><span class="hs-identifier hs-var hs-var">spliceCtxt</span></a></span></span><span> </span><span id="local-6989586621683065751"><span class="annot"><span class="annottext">HsUntypedSplice GhcPs
</span><a href="#local-6989586621683065751"><span class="hs-identifier hs-var">splice</span></a></span></span><span>
</span><span id="line-886"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; ThLevel -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;In the&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683065752"><span class="hs-identifier hs-var">what</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ThLevel
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Maybe Name -&gt; HsUntypedSplice GhcPs -&gt; SDoc
forall (p :: Pass).
OutputableBndrId p =&gt;
Bool -&gt; Maybe Name -&gt; HsUntypedSplice (GhcPass p) -&gt; SDoc
</span><a href="GHC.Hs.Expr.html#pprUntypedSplice"><span class="hs-identifier hs-var">pprUntypedSplice</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">Maybe Name
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice GhcPs
</span><a href="#local-6989586621683065751"><span class="hs-identifier hs-var">splice</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-887"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-888"></span><span>    </span><span id="local-6989586621683065752"><span class="annot"><span class="annottext">what :: SDoc
</span><a href="#local-6989586621683065752"><span class="hs-identifier hs-var hs-var">what</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">HsUntypedSplice GhcPs
</span><a href="#local-6989586621683065751"><span class="hs-identifier hs-var">splice</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-889"></span><span>             </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsUntypedSpliceExpr"><span class="hs-identifier hs-type">HsUntypedSpliceExpr</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;untyped splice:&quot;</span></span><span>
</span><span id="line-890"></span><span>             </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsQuasiQuote"><span class="hs-identifier hs-type">HsQuasiQuote</span></a></span><span>        </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;quasi-quotation:&quot;</span></span><span>
</span><span id="line-891"></span><span>
</span><span id="line-892"></span><span class="annot"><span class="hs-comment">-- | The splice data to be logged</span></span><span>
</span><span id="line-893"></span><span class="hs-keyword">data</span><span> </span><span id="SpliceInfo"><span class="annot"><a href="GHC.Rename.Splice.html#SpliceInfo"><span class="hs-identifier hs-var">SpliceInfo</span></a></span></span><span>
</span><span id="line-894"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="SpliceInfo"><span class="annot"><a href="GHC.Rename.Splice.html#SpliceInfo"><span class="hs-identifier hs-var">SpliceInfo</span></a></span></span><span>
</span><span id="line-895"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="spliceDescription"><span class="annot"><span class="annottext">SpliceInfo -&gt; String
</span><a href="GHC.Rename.Splice.html#spliceDescription"><span class="hs-identifier hs-var hs-var">spliceDescription</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-896"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="spliceSource"><span class="annot"><span class="annottext">SpliceInfo -&gt; Maybe (LHsExpr (GhcPass 'Renamed))
</span><a href="GHC.Rename.Splice.html#spliceSource"><span class="hs-identifier hs-var hs-var">spliceSource</span></a></span></span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#LHsExpr"><span class="hs-identifier hs-type">LHsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Nothing &lt;=&gt; top-level decls</span><span>
</span><span id="line-897"></span><span>                                                  </span><span class="hs-comment">--        added by addTopDecls</span><span>
</span><span id="line-898"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="spliceIsDecl"><span class="annot"><span class="annottext">SpliceInfo -&gt; Bool
</span><a href="GHC.Rename.Splice.html#spliceIsDecl"><span class="hs-identifier hs-var hs-var">spliceIsDecl</span></a></span></span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>    </span><span class="hs-comment">-- True &lt;=&gt; put the generate code in a file</span><span>
</span><span id="line-899"></span><span>                                    </span><span class="hs-comment">--          when -dth-dec-file is on</span><span>
</span><span id="line-900"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="spliceGenerated"><span class="annot"><span class="annottext">SpliceInfo -&gt; SDoc
</span><a href="GHC.Rename.Splice.html#spliceGenerated"><span class="hs-identifier hs-var hs-var">spliceGenerated</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span>
</span><span id="line-901"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-902"></span><span>        </span><span class="hs-comment">-- Note that 'spliceSource' is *renamed* but not *typechecked*</span><span>
</span><span id="line-903"></span><span>        </span><span class="hs-comment">-- Reason (a) less typechecking crap</span><span>
</span><span id="line-904"></span><span>        </span><span class="hs-comment">--        (b) data constructors after type checking have been</span><span>
</span><span id="line-905"></span><span>        </span><span class="hs-comment">--            changed to their *wrappers*, and that makes them</span><span>
</span><span id="line-906"></span><span>        </span><span class="hs-comment">--            print always fully qualified</span><span>
</span><span id="line-907"></span><span>
</span><span id="line-908"></span><span class="hs-comment">-- | outputs splice information for 2 flags which have different output formats:</span><span>
</span><span id="line-909"></span><span class="hs-comment">-- `-ddump-splices` and `-dth-dec-file`</span><span>
</span><span id="line-910"></span><span class="annot"><a href="GHC.Rename.Splice.html#traceSplice"><span class="hs-identifier hs-type">traceSplice</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Rename.Splice.html#SpliceInfo"><span class="hs-identifier hs-type">SpliceInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-911"></span><span id="traceSplice"><span class="annot"><span class="annottext">traceSplice :: SpliceInfo -&gt; RnM ()
</span><a href="GHC.Rename.Splice.html#traceSplice"><span class="hs-identifier hs-var hs-var">traceSplice</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Rename.Splice.html#SpliceInfo"><span class="hs-identifier hs-type">SpliceInfo</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">spliceDescription :: SpliceInfo -&gt; String
</span><a href="GHC.Rename.Splice.html#spliceDescription"><span class="hs-identifier hs-var">spliceDescription</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683065753"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683065753"><span class="hs-identifier hs-var">sd</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">spliceSource :: SpliceInfo -&gt; Maybe (LHsExpr (GhcPass 'Renamed))
</span><a href="GHC.Rename.Splice.html#spliceSource"><span class="hs-identifier hs-var">spliceSource</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683065754"><span class="annot"><span class="annottext">Maybe (LHsExpr (GhcPass 'Renamed))
</span><a href="#local-6989586621683065754"><span class="hs-identifier hs-var">mb_src</span></a></span></span><span>
</span><span id="line-912"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">spliceGenerated :: SpliceInfo -&gt; SDoc
</span><a href="GHC.Rename.Splice.html#spliceGenerated"><span class="hs-identifier hs-var">spliceGenerated</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683065755"><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683065755"><span class="hs-identifier hs-var">gen</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">spliceIsDecl :: SpliceInfo -&gt; Bool
</span><a href="GHC.Rename.Splice.html#spliceIsDecl"><span class="hs-identifier hs-var">spliceIsDecl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683065756"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683065756"><span class="hs-identifier hs-var">is_decl</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-913"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621683065757"><span class="annot"><a href="#local-6989586621683065757"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (LHsExpr (GhcPass 'Renamed))
</span><a href="#local-6989586621683065754"><span class="hs-identifier hs-var">mb_src</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-914"></span><span>                 </span><span class="annot"><span class="annottext">Maybe (LHsExpr (GhcPass 'Renamed))
</span><span class="hs-identifier hs-var">Nothing</span></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcRn SrcSpan
</span><a href="GHC.Tc.Utils.Monad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a></span><span>
</span><span id="line-915"></span><span>                 </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.SrcLoc.html#L"><span class="hs-identifier hs-type">L</span></a></span><span> </span><span id="local-6989586621683065758"><span class="annot"><span class="annottext">SrcSpanAnnA
</span><a href="#local-6989586621683065758"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="annot"><span class="annottext">HsExpr (GhcPass 'Renamed)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SrcSpan -&gt; TcRn SrcSpan
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SrcSpanAnnA -&gt; SrcSpan
forall a. HasLoc a =&gt; a -&gt; SrcSpan
</span><a href="GHC.Parser.Annotation.html#locA"><span class="hs-identifier hs-var">locA</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpanAnnA
</span><a href="#local-6989586621683065758"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-916"></span><span>       </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceOptTcRn"><span class="hs-identifier hs-type">traceOptTcRn</span></a></span><span> </span><span class="annot"><a href="GHC.Driver.Flags.html#Opt_D_dump_splices"><span class="hs-identifier hs-type">Opt_D_dump_splices</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683065761"><span class="hs-identifier hs-type">spliceDebugDoc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065757"><span class="hs-identifier hs-type">loc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-917"></span><span>
</span><span id="line-918"></span><span>       </span><span class="annot"><span class="hs-identifier hs-type">when</span></span><span> </span><span class="annot"><a href="#local-6989586621683065756"><span class="hs-identifier hs-type">is_decl</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- Raw material for -dth-dec-file</span><span>
</span><span id="line-919"></span><span>        </span><span id="local-6989586621683065762"><span class="annot"><a href="#local-6989586621683065762"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#getLogger"><span class="hs-identifier hs-type">getLogger</span></a></span><span>
</span><span id="line-920"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#putDumpFileMaybe"><span class="hs-identifier hs-type">putDumpFileMaybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065762"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><a href="GHC.Driver.Flags.html#Opt_D_th_dec_file"><span class="hs-identifier hs-type">Opt_D_th_dec_file</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#FormatHaskell"><span class="hs-identifier hs-type">FormatHaskell</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683065768"><span class="hs-identifier hs-type">spliceCodeDoc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065757"><span class="hs-identifier hs-type">loc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-921"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-922"></span><span>    </span><span class="hs-comment">-- `-ddump-splices`</span><span>
</span><span id="line-923"></span><span>    </span><span class="annot"><a href="#local-6989586621683065761"><span class="hs-identifier hs-type">spliceDebugDoc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html#SrcSpan"><span class="hs-identifier hs-type">SrcSpan</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span>
</span><span id="line-924"></span><span>    </span><span id="local-6989586621683065761"><span class="annot"><span class="annottext">spliceDebugDoc :: SrcSpan -&gt; SDoc
</span><a href="#local-6989586621683065761"><span class="hs-identifier hs-var hs-var">spliceDebugDoc</span></a></span></span><span> </span><span id="local-6989586621683065769"><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621683065769"><span class="hs-identifier hs-var">loc</span></a></span></span><span>
</span><span id="line-925"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683065770"><span class="annot"><span class="annottext">code :: [SDoc]
</span><a href="#local-6989586621683065770"><span class="hs-identifier hs-var hs-var">code</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (LHsExpr (GhcPass 'Renamed))
</span><a href="#local-6989586621683065754"><span class="hs-identifier hs-var">mb_src</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-926"></span><span>                     </span><span class="annot"><span class="annottext">Maybe (LHsExpr (GhcPass 'Renamed))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[SDoc]
</span><a href="#local-6989586621683065771"><span class="hs-identifier hs-var">ending</span></a></span><span>
</span><span id="line-927"></span><span>                     </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683065772"><span class="annot"><span class="annottext">LHsExpr (GhcPass 'Renamed)
</span><a href="#local-6989586621683065772"><span class="hs-identifier hs-var">e</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ThLevel -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a></span><span> </span><span class="annot"><span class="annottext">ThLevel
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GenLocated SrcSpanAnnA (HsExpr (GhcPass 'Renamed)) -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LHsExpr (GhcPass 'Renamed) -&gt; LHsExpr (GhcPass 'Renamed)
forall (p :: Pass). LHsExpr (GhcPass p) -&gt; LHsExpr (GhcPass p)
</span><a href="GHC.Hs.Expr.html#stripParensLHsExpr"><span class="hs-identifier hs-var">stripParensLHsExpr</span></a></span><span> </span><span class="annot"><span class="annottext">LHsExpr (GhcPass 'Renamed)
</span><a href="#local-6989586621683065772"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; [SDoc] -&gt; [SDoc]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[SDoc]
</span><a href="#local-6989586621683065771"><span class="hs-identifier hs-var">ending</span></a></span><span>
</span><span id="line-928"></span><span>            </span><span id="local-6989586621683065771"><span class="annot"><span class="annottext">ending :: [SDoc]
</span><a href="#local-6989586621683065771"><span class="hs-identifier hs-var hs-var">ending</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;======&gt;&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ThLevel -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a></span><span> </span><span class="annot"><span class="annottext">ThLevel
</span><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683065755"><span class="hs-identifier hs-var">gen</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-929"></span><span>        </span><span class="hs-keyword">in</span><span>  </span><span class="annot"><span class="annottext">SDoc -&gt; ThLevel -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SrcSpan -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621683065769"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#colon"><span class="hs-identifier hs-var">colon</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Splicing&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683065753"><span class="hs-identifier hs-var">sd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-930"></span><span>               </span><span class="annot"><span class="annottext">ThLevel
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="annot"><span class="annottext">[SDoc]
</span><a href="#local-6989586621683065770"><span class="hs-identifier hs-var">code</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-931"></span><span>
</span><span id="line-932"></span><span>    </span><span class="hs-comment">-- `-dth-dec-file`</span><span>
</span><span id="line-933"></span><span>    </span><span class="annot"><a href="#local-6989586621683065768"><span class="hs-identifier hs-type">spliceCodeDoc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html#SrcSpan"><span class="hs-identifier hs-type">SrcSpan</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span>
</span><span id="line-934"></span><span>    </span><span id="local-6989586621683065768"><span class="annot"><span class="annottext">spliceCodeDoc :: SrcSpan -&gt; SDoc
</span><a href="#local-6989586621683065768"><span class="hs-identifier hs-var hs-var">spliceCodeDoc</span></a></span></span><span> </span><span id="local-6989586621683065778"><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621683065778"><span class="hs-identifier hs-var">loc</span></a></span></span><span>
</span><span id="line-935"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;--&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpan -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621683065778"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#colon"><span class="hs-identifier hs-var">colon</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Splicing&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683065753"><span class="hs-identifier hs-var">sd</span></a></span><span>
</span><span id="line-936"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683065755"><span class="hs-identifier hs-var">gen</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-937"></span><span>
</span><span id="line-938"></span><span class="annot"><a href="GHC.Rename.Splice.html#checkThLocalTyName"><span class="hs-identifier hs-type">checkThLocalTyName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#RnM"><span class="hs-identifier hs-type">RnM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-939"></span><span id="checkThLocalTyName"><span class="annot"><span class="annottext">checkThLocalTyName :: Name -&gt; RnM ()
</span><a href="GHC.Rename.Splice.html#checkThLocalTyName"><span class="hs-identifier hs-var hs-var">checkThLocalTyName</span></a></span></span><span> </span><span id="local-6989586621683065779"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065779"><span class="hs-identifier hs-var">name</span></a></span></span><span>
</span><span id="line-940"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Bool
</span><a href="GHC.Builtin.Names.html#isUnboundName"><span class="hs-identifier hs-var">isUnboundName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065779"><span class="hs-identifier hs-var">name</span></a></span><span>   </span><span class="hs-comment">-- Do not report two errors for</span><span>
</span><span id="line-941"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; RnM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>            </span><span class="hs-comment">--   $(not_in_scope args)</span><span>
</span><span id="line-942"></span><span>
</span><span id="line-943"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-944"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; RnM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;checkThLocalTyName&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065779"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-945"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683065780"><span class="annot"><a href="#local-6989586621683065780"><span class="hs-identifier hs-var">mb_local_use</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcRn (Maybe (TopLevelFlag, ThLevel, ThStage))
</span><a href="GHC.Tc.Utils.Monad.html#getStageAndBindLevel"><span class="hs-identifier hs-var">getStageAndBindLevel</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065779"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-946"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683065780"><span class="hs-identifier hs-type">mb_local_use</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-947"></span><span>             </span><span class="annot"><span class="annottext">Maybe (TopLevelFlag, ThLevel, ThStage)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; RnM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">;</span><span>  </span><span class="hs-comment">-- Not a locally-bound thing</span><span>
</span><span id="line-948"></span><span>             </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683065782"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621683065782"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683065783"><span class="annot"><span class="annottext">ThLevel
</span><a href="#local-6989586621683065783"><span class="hs-identifier hs-var">bind_lvl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683065784"><span class="annot"><span class="annottext">ThStage
</span><a href="#local-6989586621683065784"><span class="hs-identifier hs-var">use_stage</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-949"></span><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683065785"><span class="annot"><span class="annottext">use_lvl :: ThLevel
</span><a href="#local-6989586621683065785"><span class="hs-identifier hs-var hs-var hs-var">use_lvl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ThStage -&gt; ThLevel
</span><a href="GHC.Tc.Types.TH.html#thLevel"><span class="hs-identifier hs-var">thLevel</span></a></span><span> </span><span class="annot"><span class="annottext">ThStage
</span><a href="#local-6989586621683065784"><span class="hs-identifier hs-var">use_stage</span></a></span><span>
</span><span id="line-950"></span><span>        </span><span class="hs-comment">-- We don't check the well stageness of name here.</span><span>
</span><span id="line-951"></span><span>        </span><span class="hs-comment">-- this would break test for #20969</span><span>
</span><span id="line-952"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-953"></span><span>        </span><span class="hs-comment">-- Consequently there is no check&amp;restiction for top level splices.</span><span>
</span><span id="line-954"></span><span>        </span><span class="hs-comment">-- But it's annoying anyway.</span><span>
</span><span id="line-955"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-956"></span><span>        </span><span class="hs-comment">-- Therefore checkCrossStageLiftingTy shouldn't assume anything</span><span>
</span><span id="line-957"></span><span>        </span><span class="hs-comment">-- about bind_lvl and use_lvl relation.</span><span>
</span><span id="line-958"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-959"></span><span>        </span><span class="hs-comment">-- ; checkWellStaged (StageCheckSplice name) bind_lvl use_lvl</span><span>
</span><span id="line-960"></span><span>
</span><span id="line-961"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; RnM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;checkThLocalTyName&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065779"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ThLevel -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">ThLevel
</span><a href="#local-6989586621683065783"><span class="hs-identifier hs-var">bind_lvl</span></a></span><span>
</span><span id="line-962"></span><span>                                                 </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ThStage -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">ThStage
</span><a href="#local-6989586621683065784"><span class="hs-identifier hs-var">use_stage</span></a></span><span>
</span><span id="line-963"></span><span>                                                 </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ThLevel -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">ThLevel
</span><a href="#local-6989586621683065785"><span class="hs-identifier hs-var">use_lvl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-964"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; ThLevel -&gt; ThStage -&gt; ThLevel -&gt; Name -&gt; RnM ()
</span><a href="GHC.Rename.Splice.html#checkCrossStageLiftingTy"><span class="hs-identifier hs-var">checkCrossStageLiftingTy</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621683065782"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">ThLevel
</span><a href="#local-6989586621683065783"><span class="hs-identifier hs-var">bind_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">ThStage
</span><a href="#local-6989586621683065784"><span class="hs-identifier hs-var">use_stage</span></a></span><span> </span><span class="annot"><span class="annottext">ThLevel
</span><a href="#local-6989586621683065785"><span class="hs-identifier hs-var">use_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065779"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-965"></span><span>
</span><span id="line-966"></span><span class="annot"><a href="GHC.Rename.Splice.html#checkThLocalName"><span class="hs-identifier hs-type">checkThLocalName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#RnM"><span class="hs-identifier hs-type">RnM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-967"></span><span id="checkThLocalName"><span class="annot"><span class="annottext">checkThLocalName :: Name -&gt; RnM ()
</span><a href="GHC.Rename.Splice.html#checkThLocalName"><span class="hs-identifier hs-var hs-var">checkThLocalName</span></a></span></span><span> </span><span id="local-6989586621683065787"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065787"><span class="hs-identifier hs-var">name</span></a></span></span><span>
</span><span id="line-968"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Bool
</span><a href="GHC.Builtin.Names.html#isUnboundName"><span class="hs-identifier hs-var">isUnboundName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065787"><span class="hs-identifier hs-var">name</span></a></span><span>   </span><span class="hs-comment">-- Do not report two errors for</span><span>
</span><span id="line-969"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; RnM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>            </span><span class="hs-comment">--   $(not_in_scope args)</span><span>
</span><span id="line-970"></span><span>
</span><span id="line-971"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-972"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; RnM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;checkThLocalName&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065787"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-973"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683065788"><span class="annot"><a href="#local-6989586621683065788"><span class="hs-identifier hs-var">mb_local_use</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcRn (Maybe (TopLevelFlag, ThLevel, ThStage))
</span><a href="GHC.Tc.Utils.Monad.html#getStageAndBindLevel"><span class="hs-identifier hs-var">getStageAndBindLevel</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065787"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-974"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683065788"><span class="hs-identifier hs-type">mb_local_use</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-975"></span><span>             </span><span class="annot"><span class="annottext">Maybe (TopLevelFlag, ThLevel, ThStage)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; RnM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">;</span><span>  </span><span class="hs-comment">-- Not a locally-bound thing</span><span>
</span><span id="line-976"></span><span>             </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683065789"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621683065789"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683065790"><span class="annot"><span class="annottext">ThLevel
</span><a href="#local-6989586621683065790"><span class="hs-identifier hs-var">bind_lvl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683065791"><span class="annot"><span class="annottext">ThStage
</span><a href="#local-6989586621683065791"><span class="hs-identifier hs-var">use_stage</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-977"></span><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683065792"><span class="annot"><span class="annottext">use_lvl :: ThLevel
</span><a href="#local-6989586621683065792"><span class="hs-identifier hs-var hs-var hs-var">use_lvl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ThStage -&gt; ThLevel
</span><a href="GHC.Tc.Types.TH.html#thLevel"><span class="hs-identifier hs-var">thLevel</span></a></span><span> </span><span class="annot"><span class="annottext">ThStage
</span><a href="#local-6989586621683065791"><span class="hs-identifier hs-var">use_stage</span></a></span><span>
</span><span id="line-978"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">StageCheckReason -&gt; ThLevel -&gt; ThLevel -&gt; RnM ()
</span><a href="GHC.Tc.Utils.Env.html#checkWellStaged"><span class="hs-identifier hs-var">checkWellStaged</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; StageCheckReason
</span><a href="GHC.Tc.Errors.Types.html#StageCheckSplice"><span class="hs-identifier hs-var">StageCheckSplice</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065787"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ThLevel
</span><a href="#local-6989586621683065790"><span class="hs-identifier hs-var">bind_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">ThLevel
</span><a href="#local-6989586621683065792"><span class="hs-identifier hs-var">use_lvl</span></a></span><span>
</span><span id="line-979"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; RnM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;checkThLocalName&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065787"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ThLevel -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">ThLevel
</span><a href="#local-6989586621683065790"><span class="hs-identifier hs-var">bind_lvl</span></a></span><span>
</span><span id="line-980"></span><span>                                               </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ThStage -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">ThStage
</span><a href="#local-6989586621683065791"><span class="hs-identifier hs-var">use_stage</span></a></span><span>
</span><span id="line-981"></span><span>                                               </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ThLevel -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">ThLevel
</span><a href="#local-6989586621683065792"><span class="hs-identifier hs-var">use_lvl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-982"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; ThLevel -&gt; ThStage -&gt; ThLevel -&gt; Name -&gt; RnM ()
</span><a href="GHC.Rename.Splice.html#checkCrossStageLifting"><span class="hs-identifier hs-var">checkCrossStageLifting</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621683065789"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">ThLevel
</span><a href="#local-6989586621683065790"><span class="hs-identifier hs-var">bind_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">ThStage
</span><a href="#local-6989586621683065791"><span class="hs-identifier hs-var">use_stage</span></a></span><span> </span><span class="annot"><span class="annottext">ThLevel
</span><a href="#local-6989586621683065792"><span class="hs-identifier hs-var">use_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065787"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-983"></span><span>
</span><span id="line-984"></span><span class="hs-comment">--------------------------------------</span><span>
</span><span id="line-985"></span><span class="annot"><a href="GHC.Rename.Splice.html#checkCrossStageLifting"><span class="hs-identifier hs-type">checkCrossStageLifting</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TH.html#ThLevel"><span class="hs-identifier hs-type">ThLevel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TH.html#ThStage"><span class="hs-identifier hs-type">ThStage</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TH.html#ThLevel"><span class="hs-identifier hs-type">ThLevel</span></a></span><span>
</span><span id="line-986"></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-987"></span><span class="hs-comment">-- We are inside brackets, and (use_lvl &gt; bind_lvl)</span><span>
</span><span id="line-988"></span><span class="hs-comment">-- Now we must check whether there's a cross-stage lift to do</span><span>
</span><span id="line-989"></span><span class="hs-comment">-- Examples   \x -&gt; [| x |]</span><span>
</span><span id="line-990"></span><span class="hs-comment">--            [| map |]</span><span>
</span><span id="line-991"></span><span class="hs-comment">--</span><span>
</span><span id="line-992"></span><span class="hs-comment">-- This code is similar to checkCrossStageLifting in GHC.Tc.Gen.Expr, but</span><span>
</span><span id="line-993"></span><span class="hs-comment">-- this is only run on *untyped* brackets.</span><span>
</span><span id="line-994"></span><span>
</span><span id="line-995"></span><span id="checkCrossStageLifting"><span class="annot"><span class="annottext">checkCrossStageLifting :: TopLevelFlag -&gt; ThLevel -&gt; ThStage -&gt; ThLevel -&gt; Name -&gt; RnM ()
</span><a href="GHC.Rename.Splice.html#checkCrossStageLifting"><span class="hs-identifier hs-var hs-var">checkCrossStageLifting</span></a></span></span><span> </span><span id="local-6989586621683065795"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621683065795"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621683065796"><span class="annot"><span class="annottext">ThLevel
</span><a href="#local-6989586621683065796"><span class="hs-identifier hs-var">bind_lvl</span></a></span></span><span> </span><span id="local-6989586621683065797"><span class="annot"><span class="annottext">ThStage
</span><a href="#local-6989586621683065797"><span class="hs-identifier hs-var">use_stage</span></a></span></span><span> </span><span id="local-6989586621683065798"><span class="annot"><span class="annottext">ThLevel
</span><a href="#local-6989586621683065798"><span class="hs-identifier hs-var">use_lvl</span></a></span></span><span> </span><span id="local-6989586621683065799"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065799"><span class="hs-identifier hs-var">name</span></a></span></span><span>
</span><span id="line-996"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TH.html#Brack"><span class="hs-identifier hs-type">Brack</span></a></span><span> </span><span class="annot"><span class="annottext">ThStage
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.TH.html#RnPendingUntyped"><span class="hs-identifier hs-type">RnPendingUntyped</span></a></span><span> </span><span id="local-6989586621683065800"><span class="annot"><span class="annottext">IORef [PendingRnSplice]
</span><a href="#local-6989586621683065800"><span class="hs-identifier hs-var">ps_var</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ThStage
</span><a href="#local-6989586621683065797"><span class="hs-identifier hs-var">use_stage</span></a></span><span>   </span><span class="hs-comment">-- Only for untyped brackets</span><span>
</span><span id="line-997"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ThLevel
</span><a href="#local-6989586621683065798"><span class="hs-identifier hs-var">use_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">ThLevel -&gt; ThLevel -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">ThLevel
</span><a href="#local-6989586621683065796"><span class="hs-identifier hs-var">bind_lvl</span></a></span><span>                               </span><span class="hs-comment">-- Cross-stage condition</span><span>
</span><span id="line-998"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; Name -&gt; IORef [PendingRnSplice] -&gt; RnM ()
</span><a href="GHC.Rename.Splice.html#check_cross_stage_lifting"><span class="hs-identifier hs-var">check_cross_stage_lifting</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621683065795"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065799"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">IORef [PendingRnSplice]
</span><a href="#local-6989586621683065800"><span class="hs-identifier hs-var">ps_var</span></a></span><span>
</span><span id="line-999"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1000"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; RnM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1001"></span><span>
</span><span id="line-1002"></span><span class="annot"><a href="GHC.Rename.Splice.html#check_cross_stage_lifting"><span class="hs-identifier hs-type">check_cross_stage_lifting</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TcRef.html#TcRef"><span class="hs-identifier hs-type">TcRef</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Hs.Expr.html#PendingRnSplice"><span class="hs-identifier hs-type">PendingRnSplice</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1003"></span><span id="check_cross_stage_lifting"><span class="annot"><span class="annottext">check_cross_stage_lifting :: TopLevelFlag -&gt; Name -&gt; IORef [PendingRnSplice] -&gt; RnM ()
</span><a href="GHC.Rename.Splice.html#check_cross_stage_lifting"><span class="hs-identifier hs-var hs-var">check_cross_stage_lifting</span></a></span></span><span> </span><span id="local-6989586621683065803"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621683065803"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621683065804"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065804"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621683065805"><span class="annot"><span class="annottext">IORef [PendingRnSplice]
</span><a href="#local-6989586621683065805"><span class="hs-identifier hs-var">ps_var</span></a></span></span><span>
</span><span id="line-1004"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; Bool
</span><a href="GHC.Types.Basic.html#isTopLevel"><span class="hs-identifier hs-var">isTopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621683065803"><span class="hs-identifier hs-var">top_lvl</span></a></span><span>
</span><span id="line-1005"></span><span>        </span><span class="hs-comment">-- Top-level identifiers in this module,</span><span>
</span><span id="line-1006"></span><span>        </span><span class="hs-comment">-- (which have External Names)</span><span>
</span><span id="line-1007"></span><span>        </span><span class="hs-comment">-- are just like the imported case:</span><span>
</span><span id="line-1008"></span><span>        </span><span class="hs-comment">-- no need for the 'lifting' treatment</span><span>
</span><span id="line-1009"></span><span>        </span><span class="hs-comment">-- E.g.  this is fine:</span><span>
</span><span id="line-1010"></span><span>        </span><span class="hs-comment">--   f x = x</span><span>
</span><span id="line-1011"></span><span>        </span><span class="hs-comment">--   g y = [| f 3 |]</span><span>
</span><span id="line-1012"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; RnM () -&gt; RnM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Bool
</span><a href="GHC.Types.Name.html#isExternalName"><span class="hs-identifier hs-var">isExternalName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065804"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; RnM ()
</span><a href="GHC.Tc.Utils.Monad.html#keepAlive"><span class="hs-identifier hs-var">keepAlive</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065804"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1013"></span><span>    </span><span class="hs-comment">-- See Note [Keeping things alive for Template Haskell]</span><span>
</span><span id="line-1014"></span><span>
</span><span id="line-1015"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1016"></span><span>  </span><span class="hs-glyph">=</span><span>     </span><span class="hs-comment">-- Nested identifiers, such as 'x' in</span><span>
</span><span id="line-1017"></span><span>        </span><span class="hs-comment">-- E.g. \x -&gt; [| h x |]</span><span>
</span><span id="line-1018"></span><span>        </span><span class="hs-comment">-- We must behave as if the reference to x was</span><span>
</span><span id="line-1019"></span><span>        </span><span class="hs-comment">--      h $(lift x)</span><span>
</span><span id="line-1020"></span><span>        </span><span class="hs-comment">-- We use 'x' itself as the SplicePointName, used by</span><span>
</span><span id="line-1021"></span><span>        </span><span class="hs-comment">-- the desugarer to stitch it all back together.</span><span>
</span><span id="line-1022"></span><span>        </span><span class="hs-comment">-- If 'x' occurs many times we may get many identical</span><span>
</span><span id="line-1023"></span><span>        </span><span class="hs-comment">-- bindings of the same SplicePointName, but that doesn't</span><span>
</span><span id="line-1024"></span><span>        </span><span class="hs-comment">-- matter, although it's a mite untidy.</span><span>
</span><span id="line-1025"></span><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; RnM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;checkCrossStageLifting&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065804"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1026"></span><span>
</span><span id="line-1027"></span><span>          </span><span class="hs-comment">-- Construct the (lift x) expression</span><span>
</span><span id="line-1028"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683065806"><span class="annot"><span class="annottext">lift_expr :: LHsExpr (GhcPass 'Renamed)
</span><a href="#local-6989586621683065806"><span class="hs-identifier hs-var hs-var hs-var">lift_expr</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LHsExpr (GhcPass 'Renamed)
-&gt; LHsExpr (GhcPass 'Renamed) -&gt; LHsExpr (GhcPass 'Renamed)
forall (id :: Pass).
IsPass id =&gt;
LHsExpr (GhcPass id)
-&gt; LHsExpr (GhcPass id) -&gt; LHsExpr (GhcPass id)
</span><a href="GHC.Hs.Utils.html#nlHsApp"><span class="hs-identifier hs-var">nlHsApp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdP (GhcPass 'Renamed) -&gt; LHsExpr (GhcPass 'Renamed)
forall (p :: Pass) a.
IsSrcSpanAnn p a =&gt;
IdP (GhcPass p) -&gt; LHsExpr (GhcPass p)
</span><a href="GHC.Hs.Utils.html#nlHsVar"><span class="hs-identifier hs-var">nlHsVar</span></a></span><span> </span><span class="annot"><span class="annottext">IdP (GhcPass 'Renamed)
Name
</span><a href="GHC.Builtin.Names.TH.html#liftName"><span class="hs-identifier hs-var">liftName</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdP (GhcPass 'Renamed) -&gt; LHsExpr (GhcPass 'Renamed)
forall (p :: Pass) a.
IsSrcSpanAnn p a =&gt;
IdP (GhcPass p) -&gt; LHsExpr (GhcPass p)
</span><a href="GHC.Hs.Utils.html#nlHsVar"><span class="hs-identifier hs-var">nlHsVar</span></a></span><span> </span><span class="annot"><span class="annottext">IdP (GhcPass 'Renamed)
Name
</span><a href="#local-6989586621683065804"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1029"></span><span>              </span><span id="local-6989586621683065809"><span class="annot"><span class="annottext">pend_splice :: PendingRnSplice
</span><a href="#local-6989586621683065809"><span class="hs-identifier hs-var hs-var hs-var">pend_splice</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
-&gt; Name -&gt; LHsExpr (GhcPass 'Renamed) -&gt; PendingRnSplice
</span><a href="GHC.Hs.Expr.html#PendingRnSplice"><span class="hs-identifier hs-var">PendingRnSplice</span></a></span><span> </span><span class="annot"><span class="annottext">UntypedSpliceFlavour
</span><a href="GHC.Hs.Expr.html#UntypedExpSplice"><span class="hs-identifier hs-var">UntypedExpSplice</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065804"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">LHsExpr (GhcPass 'Renamed)
</span><a href="#local-6989586621683065806"><span class="hs-identifier hs-var">lift_expr</span></a></span><span>
</span><span id="line-1030"></span><span>
</span><span id="line-1031"></span><span>          </span><span class="hs-comment">-- Warning for implicit lift (#17804)</span><span>
</span><span id="line-1032"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(ErrInfo -&gt; TcRnMessage) -&gt; RnM ()
</span><a href="GHC.Tc.Utils.Monad.html#addDetailedDiagnostic"><span class="hs-identifier hs-var">addDetailedDiagnostic</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; ErrInfo -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnImplicitLift"><span class="hs-identifier hs-var">TcRnImplicitLift</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065804"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1033"></span><span>
</span><span id="line-1034"></span><span>          </span><span class="hs-comment">-- Update the pending splices</span><span>
</span><span id="line-1035"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683065812"><span class="annot"><a href="#local-6989586621683065812"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef [PendingRnSplice]
-&gt; IOEnv (Env TcGblEnv TcLclEnv) [PendingRnSplice]
forall a env. IORef a -&gt; IOEnv env a
</span><a href="GHC.Data.IOEnv.html#readMutVar"><span class="hs-identifier hs-var">readMutVar</span></a></span><span> </span><span class="annot"><span class="annottext">IORef [PendingRnSplice]
</span><a href="#local-6989586621683065805"><span class="hs-identifier hs-var">ps_var</span></a></span><span>
</span><span id="line-1036"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Data.IOEnv.html#writeMutVar"><span class="hs-identifier hs-type">writeMutVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683065805"><span class="hs-identifier hs-type">ps_var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683065809"><span class="hs-identifier hs-type">pend_splice</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="#local-6989586621683065812"><span class="hs-identifier hs-type">ps</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1037"></span><span>
</span><span id="line-1038"></span><span class="annot"><a href="GHC.Rename.Splice.html#checkCrossStageLiftingTy"><span class="hs-identifier hs-type">checkCrossStageLiftingTy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TH.html#ThLevel"><span class="hs-identifier hs-type">ThLevel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TH.html#ThStage"><span class="hs-identifier hs-type">ThStage</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TH.html#ThLevel"><span class="hs-identifier hs-type">ThLevel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1039"></span><span id="checkCrossStageLiftingTy"><span class="annot"><span class="annottext">checkCrossStageLiftingTy :: TopLevelFlag -&gt; ThLevel -&gt; ThStage -&gt; ThLevel -&gt; Name -&gt; RnM ()
</span><a href="GHC.Rename.Splice.html#checkCrossStageLiftingTy"><span class="hs-identifier hs-var hs-var">checkCrossStageLiftingTy</span></a></span></span><span> </span><span id="local-6989586621683065813"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621683065813"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621683065814"><span class="annot"><span class="annottext">ThLevel
</span><a href="#local-6989586621683065814"><span class="hs-identifier hs-var">bind_lvl</span></a></span></span><span> </span><span id="local-6989586621683065815"><span class="annot"><span class="annottext">ThStage
</span><a href="#local-6989586621683065815"><span class="hs-identifier hs-var">_use_stage</span></a></span></span><span> </span><span id="local-6989586621683065816"><span class="annot"><span class="annottext">ThLevel
</span><a href="#local-6989586621683065816"><span class="hs-identifier hs-var">use_lvl</span></a></span></span><span> </span><span id="local-6989586621683065817"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065817"><span class="hs-identifier hs-var">name</span></a></span></span><span>
</span><span id="line-1040"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; Bool
</span><a href="GHC.Types.Basic.html#isTopLevel"><span class="hs-identifier hs-var">isTopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621683065813"><span class="hs-identifier hs-var">top_lvl</span></a></span><span>
</span><span id="line-1041"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; RnM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1042"></span><span>
</span><span id="line-1043"></span><span>  </span><span class="hs-comment">-- There is no liftType (yet), so we could error, or more conservatively, just warn.</span><span>
</span><span id="line-1044"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-1045"></span><span>  </span><span class="hs-comment">-- For now, we check here for both untyped and typed splices, as we don't create splices.</span><span>
</span><span id="line-1046"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ThLevel
</span><a href="#local-6989586621683065816"><span class="hs-identifier hs-var">use_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">ThLevel -&gt; ThLevel -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">ThLevel
</span><a href="#local-6989586621683065814"><span class="hs-identifier hs-var">bind_lvl</span></a></span><span>
</span><span id="line-1047"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; RnM ()
</span><a href="GHC.Tc.Utils.Monad.html#addDiagnostic"><span class="hs-identifier hs-var">addDiagnostic</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; RnM ()) -&gt; TcRnMessage -&gt; RnM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; ThLevel -&gt; ThLevel -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnBadlyStagedType"><span class="hs-identifier hs-var">TcRnBadlyStagedType</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065817"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">ThLevel
</span><a href="#local-6989586621683065814"><span class="hs-identifier hs-var">bind_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">ThLevel
</span><a href="#local-6989586621683065816"><span class="hs-identifier hs-var">use_lvl</span></a></span><span>
</span><span id="line-1048"></span><span>
</span><span id="line-1049"></span><span>  </span><span class="hs-comment">-- See comment in checkThLocalTyName: this can also happen.</span><span>
</span><span id="line-1050"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ThLevel
</span><a href="#local-6989586621683065814"><span class="hs-identifier hs-var">bind_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">ThLevel -&gt; ThLevel -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">ThLevel
</span><a href="#local-6989586621683065816"><span class="hs-identifier hs-var">use_lvl</span></a></span><span>
</span><span id="line-1051"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; RnM ()
</span><a href="GHC.Tc.Utils.Monad.html#addDiagnostic"><span class="hs-identifier hs-var">addDiagnostic</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; RnM ()) -&gt; TcRnMessage -&gt; RnM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; ThLevel -&gt; ThLevel -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnBadlyStagedType"><span class="hs-identifier hs-var">TcRnBadlyStagedType</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683065817"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">ThLevel
</span><a href="#local-6989586621683065814"><span class="hs-identifier hs-var">bind_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">ThLevel
</span><a href="#local-6989586621683065816"><span class="hs-identifier hs-var">use_lvl</span></a></span><span>
</span><span id="line-1052"></span><span>
</span><span id="line-1053"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1054"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; RnM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1055"></span><span>
</span><span id="line-1056"></span><span class="hs-comment">{-
Note [Keeping things alive for Template Haskell]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
  f x = x+1
  g y = [| f 3 |]

Here 'f' is referred to from inside the bracket, which turns into data
and mentions only f's *name*, not 'f' itself. So we need some other
way to keep 'f' alive, lest it get dropped as dead code.  That's what
keepAlive does. It puts it in the keep-alive set, which subsequently
ensures that 'f' stays as a top level binding.

This must be done by the renamer, not the type checker (as of old),
because the type checker doesn't typecheck the body of untyped
brackets (#8540).

A thing can have a bind_lvl of outerLevel, but have an internal name:
   foo = [d| op = 3
             bop = op + 1 |]
Here the bind_lvl of 'op' is (bogusly) outerLevel, even though it is
bound inside a bracket.  That is because we don't even record
binding levels for top-level things; the binding levels are in the
LocalRdrEnv.

So the occurrence of 'op' in the rhs of 'bop' looks a bit like a
cross-stage thing, but it isn't really.  And in fact we never need
to do anything here for top-level bound things, so all is fine, if
a bit hacky.

For these chaps (which have Internal Names) we don't want to put
them in the keep-alive set.

Note [Quoting names]
~~~~~~~~~~~~~~~~~~~~
A quoted name 'n is a bit like a quoted expression [| n |], except that we
have no cross-stage lifting (c.f. GHC.Tc.Gen.Expr.thBrackId).  So, after incrementing
the use-level to account for the brackets, the cases are:

        bind &gt; use                      Error
        bind = use+1                    OK
        bind &lt; use
                Imported things         OK
                Top-level things        OK
                Non-top-level           Error

where 'use' is the binding level of the 'n quote. (So inside the implied
bracket the level would be use+1.)

Examples:

  f 'map        -- OK; also for top-level defns of this module

  \x. f 'x      -- Not ok (bind = 1, use = 1)
                -- (whereas \x. f [| x |] might have been ok, by
                --                               cross-stage lifting

  \y. [| \x. $(f 'y) |] -- Not ok (bind =1, use = 1)

  [| \x. $(f 'x) |]     -- OK (bind = 2, use = 1)
-}</span><span>
</span><span id="line-1117"></span></pre></body></html>