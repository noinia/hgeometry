<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# OPTIONS_GHC -Wno-incomplete-uni-patterns #-}</span><span>
</span><span id="line-3"></span><span>
</span><span id="line-4"></span><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><span id="line-5"></span><span class="hs-comment">--</span><span>
</span><span id="line-6"></span><span class="hs-comment">-- The register allocator</span><span>
</span><span id="line-7"></span><span class="hs-comment">--</span><span>
</span><span id="line-8"></span><span class="hs-comment">-- (c) The University of Glasgow 2004</span><span>
</span><span id="line-9"></span><span class="hs-comment">--</span><span>
</span><span id="line-10"></span><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-comment">{-
The algorithm is roughly:

  1) Compute strongly connected components of the basic block list.

  2) Compute liveness (mapping from pseudo register to
     point(s) of death?).

  3) Walk instructions in each basic block.  We keep track of
        (a) Free real registers (a bitmap?)
        (b) Current assignment of temporaries to machine registers and/or
            spill slots (call this the &quot;assignment&quot;).
        (c) Partial mapping from basic block ids to a virt-to-loc mapping.
            When we first encounter a branch to a basic block,
            we fill in its entry in this table with the current mapping.

     For each instruction:
        (a) For each temporary *read* by the instruction:
            If the temporary does not have a real register allocation:
                - Allocate a real register from the free list.  If
                  the list is empty:
                  - Find a temporary to spill.  Pick one that is
                    not used in this instruction (ToDo: not
                    used for a while...)
                  - generate a spill instruction
                - If the temporary was previously spilled,
                  generate an instruction to read the temp from its spill loc.
            (optimisation: if we can see that a real register is going to
            be used soon, then don't use it for allocation).

        (b) For each real register clobbered by this instruction:
            If a temporary resides in it,
                If the temporary is live after this instruction,
                    Move the temporary to another (non-clobbered &amp; free) reg,
                    or spill it to memory.  Mark the temporary as residing
                    in both memory and a register if it was spilled (it might
                    need to be read by this instruction).

            (ToDo: this is wrong for jump instructions?)

            We do this after step (a), because if we start with
               movq v1, %rsi
            which is an instruction that clobbers %rsi, if v1 currently resides
            in %rsi we want to get
               movq %rsi, %freereg
               movq %rsi, %rsi     -- will disappear
            instead of
               movq %rsi, %freereg
               movq %freereg, %rsi

        (c) Update the current assignment

        (d) If the instruction is a branch:
              if the destination block already has a register assignment,
                Generate a new block with fixup code and redirect the
                jump to the new block.
              else,
                Update the block id-&gt;assignment mapping with the current
                assignment.

        (e) Delete all register assignments for temps which are read
            (only) and die here.  Update the free register list.

        (f) Mark all registers clobbered by this instruction as not free,
            and mark temporaries which have been spilled due to clobbering
            as in memory (step (a) marks then as in both mem &amp; reg).

        (g) For each temporary *written* by this instruction:
            Allocate a real register as for (b), spilling something
            else if necessary.
                - except when updating the assignment, drop any memory
                  locations that the temporary was previously in, since
                  they will be no longer valid after this instruction.

        (h) Delete all register assignments for temps which are
            written and die here (there should rarely be any).  Update
            the free register list.

        (i) Rewrite the instruction with the new mapping.

        (j) For each spilled reg known to be now dead, re-add its stack slot
            to the free list.

-}</span><span>
</span><span id="line-96"></span><span>
</span><span id="line-97"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html"><span class="hs-identifier">GHC.CmmToAsm.Reg.Linear</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-98"></span><span>        </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#regAlloc"><span class="hs-identifier">regAlloc</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-99"></span><span>        </span><span class="hs-keyword">module</span><span>  </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html"><span class="hs-identifier">GHC.CmmToAsm.Reg.Linear.Base</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-100"></span><span>        </span><span class="hs-keyword">module</span><span>  </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Stats.html"><span class="hs-identifier">GHC.CmmToAsm.Reg.Linear.Stats</span></a></span><span>
</span><span id="line-101"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-102"></span><span>
</span><span id="line-103"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html"><span class="hs-identifier">GHC.CmmToAsm.Reg.Linear.State</span></a></span><span>
</span><span id="line-106"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html"><span class="hs-identifier">GHC.CmmToAsm.Reg.Linear.Base</span></a></span><span>
</span><span id="line-107"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.StackMap.html"><span class="hs-identifier">GHC.CmmToAsm.Reg.Linear.StackMap</span></a></span><span>
</span><span id="line-108"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.FreeRegs.html"><span class="hs-identifier">GHC.CmmToAsm.Reg.Linear.FreeRegs</span></a></span><span>
</span><span id="line-109"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Stats.html"><span class="hs-identifier">GHC.CmmToAsm.Reg.Linear.Stats</span></a></span><span>
</span><span id="line-110"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.JoinToTargets.html"><span class="hs-identifier">GHC.CmmToAsm.Reg.Linear.JoinToTargets</span></a></span><span>
</span><span id="line-111"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.PPC.html"><span class="hs-identifier">GHC.CmmToAsm.Reg.Linear.PPC</span></a></span><span>     </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PPC</span></span><span>
</span><span id="line-112"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.X86.html"><span class="hs-identifier">GHC.CmmToAsm.Reg.Linear.X86</span></a></span><span>     </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">X86</span></span><span>
</span><span id="line-113"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.X86_64.html"><span class="hs-identifier">GHC.CmmToAsm.Reg.Linear.X86_64</span></a></span><span>  </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">X86_64</span></span><span>
</span><span id="line-114"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.AArch64.html"><span class="hs-identifier">GHC.CmmToAsm.Reg.Linear.AArch64</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">AArch64</span></span><span>
</span><span id="line-115"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.RV64.html"><span class="hs-identifier">GHC.CmmToAsm.Reg.Linear.RV64</span></a></span><span>    </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">RV64</span></span><span>
</span><span id="line-116"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Target.html"><span class="hs-identifier">GHC.CmmToAsm.Reg.Target</span></a></span><span>
</span><span id="line-117"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html"><span class="hs-identifier">GHC.CmmToAsm.Reg.Liveness</span></a></span><span>
</span><span id="line-118"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Utils.html"><span class="hs-identifier">GHC.CmmToAsm.Reg.Utils</span></a></span><span>
</span><span id="line-119"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Instr.html"><span class="hs-identifier">GHC.CmmToAsm.Instr</span></a></span><span>
</span><span id="line-120"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Config.html"><span class="hs-identifier">GHC.CmmToAsm.Config</span></a></span><span>
</span><span id="line-121"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Format.html"><span class="hs-identifier">GHC.CmmToAsm.Format</span></a></span><span>
</span><span id="line-122"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Types.html"><span class="hs-identifier">GHC.CmmToAsm.Types</span></a></span><span>
</span><span id="line-123"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Platform.Reg.html"><span class="hs-identifier">GHC.Platform.Reg</span></a></span><span>
</span><span id="line-124"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Platform.Reg.Class.html"><span class="hs-identifier">GHC.Platform.Reg.Class</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Platform.Reg.Class.html#RegArch"><span class="hs-identifier">RegArch</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Platform.Reg.Class.html#registerArch"><span class="hs-identifier">registerArch</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-125"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="GHC.Platform.Reg.Class.Separate.html"><span class="hs-identifier">GHC.Platform.Reg.Class.Separate</span></a></span><span>  </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Separate</span></span><span>
</span><span id="line-126"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="GHC.Platform.Reg.Class.Unified.html"><span class="hs-identifier">GHC.Platform.Reg.Class.Unified</span></a></span><span>   </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Unified</span></span><span>
</span><span id="line-127"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="GHC.Platform.Reg.Class.NoVectors.html"><span class="hs-identifier">GHC.Platform.Reg.Class.NoVectors</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NoVectors</span></span><span>
</span><span id="line-128"></span><span>
</span><span id="line-129"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html"><span class="hs-identifier">GHC.Cmm.BlockId</span></a></span><span>
</span><span id="line-130"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html"><span class="hs-identifier">GHC.Cmm.Dataflow.Label</span></a></span><span>
</span><span id="line-131"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Cmm.html"><span class="hs-identifier">GHC.Cmm</span></a></span><span>
</span><span id="line-132"></span><span>
</span><span id="line-133"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Graph.Directed.html"><span class="hs-identifier">GHC.Data.Graph.Directed</span></a></span><span>
</span><span id="line-134"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.html"><span class="hs-identifier">GHC.Types.Unique</span></a></span><span>
</span><span id="line-135"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.FM.html"><span class="hs-identifier">GHC.Types.Unique.FM</span></a></span><span>
</span><span id="line-136"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.DSM.html"><span class="hs-identifier">GHC.Types.Unique.DSM</span></a></span><span>
</span><span id="line-137"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Set.html"><span class="hs-identifier">GHC.Types.Unique.Set</span></a></span><span>
</span><span id="line-138"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-139"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-140"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Platform.html"><span class="hs-identifier">GHC.Platform</span></a></span><span>
</span><span id="line-141"></span><span>
</span><span id="line-142"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Containers.ListUtils.html"><span class="hs-identifier">Data.Containers.ListUtils</span></a></span><span>
</span><span id="line-143"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.Maybe.html"><span class="hs-identifier">Data.Maybe</span></a></span><span>
</span><span id="line-144"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">partition</span></span><span class="hs-special">)</span><span>
</span><span id="line-145"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span>
</span><span id="line-146"></span><span>
</span><span id="line-147"></span><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><span id="line-148"></span><span class="hs-comment">-- Top level of the register allocator</span><span>
</span><span id="line-149"></span><span>
</span><span id="line-150"></span><span class="hs-comment">-- Allocate registers</span><span>
</span><span id="line-151"></span><span id="local-6989586621682851540"><span id="local-6989586621682851543"><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#regAlloc"><span class="hs-identifier hs-type">regAlloc</span></a></span><span>
</span><span id="line-152"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Instr.html#Instruction"><span class="hs-identifier hs-type">Instruction</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851540"><span class="hs-identifier hs-type">instr</span></a></span><span>
</span><span id="line-153"></span><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Config.html#NCGConfig"><span class="hs-identifier hs-type">NCGConfig</span></a></span><span>
</span><span id="line-154"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html#LiveCmmDecl"><span class="hs-identifier hs-type">LiveCmmDecl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851543"><span class="hs-identifier hs-type">statics</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851540"><span class="hs-identifier hs-type">instr</span></a></span><span>
</span><span id="line-155"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.DSM.html#UniqDSM"><span class="hs-identifier hs-type">UniqDSM</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Types.html#NatCmmDecl"><span class="hs-identifier hs-type">NatCmmDecl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851543"><span class="hs-identifier hs-type">statics</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851540"><span class="hs-identifier hs-type">instr</span></a></span><span>
</span><span id="line-156"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>  </span><span class="hs-comment">-- number of extra stack slots required,</span><span>
</span><span id="line-157"></span><span>                                </span><span class="hs-comment">-- beyond maxSpillSlots</span><span>
</span><span id="line-158"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#RegAllocStats"><span class="hs-identifier hs-type">RegAllocStats</span></a></span><span>
</span><span id="line-159"></span><span>                   </span><span class="hs-special">)</span></span></span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span id="regAlloc"><span class="annot"><span class="annottext">regAlloc :: forall instr statics.
Instruction instr =&gt;
NCGConfig
-&gt; LiveCmmDecl statics instr
-&gt; UniqDSM
     (NatCmmDecl statics instr, Maybe Int, Maybe RegAllocStats)
</span><a href="GHC.CmmToAsm.Reg.Linear.html#regAlloc"><span class="hs-identifier hs-var hs-var">regAlloc</span></a></span></span><span> </span><span class="annot"><span class="annottext">NCGConfig
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.html#CmmData"><span class="hs-identifier hs-type">CmmData</span></a></span><span> </span><span id="local-6989586621682851821"><span class="annot"><span class="annottext">Section
</span><a href="#local-6989586621682851821"><span class="hs-identifier hs-var">sec</span></a></span></span><span> </span><span id="local-6989586621682851822"><span class="annot"><span class="annottext">statics
</span><a href="#local-6989586621682851822"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-162"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(NatCmmDecl statics instr, Maybe Int, Maybe RegAllocStats)
-&gt; UniqDSM
     (NatCmmDecl statics instr, Maybe Int, Maybe RegAllocStats)
forall a. a -&gt; UniqDSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-163"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Section -&gt; statics -&gt; NatCmmDecl statics instr
forall d h g. Section -&gt; d -&gt; GenCmmDecl d h g
</span><a href="GHC.Cmm.html#CmmData"><span class="hs-identifier hs-var">CmmData</span></a></span><span> </span><span class="annot"><span class="annottext">Section
</span><a href="#local-6989586621682851821"><span class="hs-identifier hs-var">sec</span></a></span><span> </span><span class="annot"><span class="annottext">statics
</span><a href="#local-6989586621682851822"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-164"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe Int
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-165"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe RegAllocStats
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-166"></span><span>
</span><span id="line-167"></span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#regAlloc"><span class="hs-identifier hs-var">regAlloc</span></a></span><span> </span><span class="annot"><span class="annottext">NCGConfig
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.html#CmmProc"><span class="hs-identifier hs-type">CmmProc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html#LiveInfo"><span class="hs-identifier hs-type">LiveInfo</span></a></span><span> </span><span id="local-6989586621682851825"><span class="annot"><span class="annottext">LabelMap RawCmmStatics
</span><a href="#local-6989586621682851825"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span class="annot"><span class="annottext">[BlockId]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">BlockMap (UniqSet RegWithFormat)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">BlockMap IntSet
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682851826"><span class="annot"><span class="annottext">CLabel
</span><a href="#local-6989586621682851826"><span class="hs-identifier hs-var">lbl</span></a></span></span><span> </span><span id="local-6989586621682851827"><span class="annot"><span class="annottext">[GlobalRegUse]
</span><a href="#local-6989586621682851827"><span class="hs-identifier hs-var">live</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-168"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(NatCmmDecl statics instr, Maybe Int, Maybe RegAllocStats)
-&gt; UniqDSM
     (NatCmmDecl statics instr, Maybe Int, Maybe RegAllocStats)
forall a. a -&gt; UniqDSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">LabelMap RawCmmStatics
-&gt; CLabel
-&gt; [GlobalRegUse]
-&gt; ListGraph instr
-&gt; NatCmmDecl statics instr
forall d h g.
h -&gt; CLabel -&gt; [GlobalRegUse] -&gt; g -&gt; GenCmmDecl d h g
</span><a href="GHC.Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap RawCmmStatics
</span><a href="#local-6989586621682851825"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="annot"><span class="annottext">CLabel
</span><a href="#local-6989586621682851826"><span class="hs-identifier hs-var">lbl</span></a></span><span> </span><span class="annot"><span class="annottext">[GlobalRegUse]
</span><a href="#local-6989586621682851827"><span class="hs-identifier hs-var">live</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[GenBasicBlock instr] -&gt; ListGraph instr
forall i. [GenBasicBlock i] -&gt; ListGraph i
</span><a href="GHC.Cmm.html#ListGraph"><span class="hs-identifier hs-var">ListGraph</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-169"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe Int
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-170"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe RegAllocStats
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-171"></span><span>
</span><span id="line-172"></span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#regAlloc"><span class="hs-identifier hs-var">regAlloc</span></a></span><span> </span><span id="local-6989586621682851829"><span class="annot"><span class="annottext">NCGConfig
</span><a href="#local-6989586621682851829"><span class="hs-identifier hs-var">config</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.html#CmmProc"><span class="hs-identifier hs-type">CmmProc</span></a></span><span> </span><span id="local-6989586621682851830"><span class="annot"><span class="annottext">LiveInfo
</span><a href="#local-6989586621682851830"><span class="hs-identifier hs-var">static</span></a></span></span><span> </span><span id="local-6989586621682851831"><span class="annot"><span class="annottext">CLabel
</span><a href="#local-6989586621682851831"><span class="hs-identifier hs-var">lbl</span></a></span></span><span> </span><span id="local-6989586621682851832"><span class="annot"><span class="annottext">[GlobalRegUse]
</span><a href="#local-6989586621682851832"><span class="hs-identifier hs-var">live</span></a></span></span><span> </span><span id="local-6989586621682851833"><span class="annot"><span class="annottext">[SCC (LiveBasicBlock instr)]
</span><a href="#local-6989586621682851833"><span class="hs-identifier hs-var">sccs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-173"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html#LiveInfo"><span class="hs-identifier hs-type">LiveInfo</span></a></span><span> </span><span id="local-6989586621682851834"><span class="annot"><span class="annottext">LabelMap RawCmmStatics
</span><a href="#local-6989586621682851834"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span id="local-6989586621682851835"><span class="annot"><span class="annottext">entry_ids :: [BlockId]
</span><a href="#local-6989586621682851835"><span class="hs-identifier hs-var">entry_ids</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621682851836"><span class="annot"><span class="annottext">BlockId
</span><a href="#local-6989586621682851836"><span class="hs-identifier hs-var">first_id</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[BlockId]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682851837"><span class="annot"><span class="annottext">BlockMap (UniqSet RegWithFormat)
</span><a href="#local-6989586621682851837"><span class="hs-identifier hs-var">block_live</span></a></span></span><span> </span><span class="annot"><span class="annottext">BlockMap IntSet
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LiveInfo
</span><a href="#local-6989586621682851830"><span class="hs-identifier hs-var">static</span></a></span><span>
</span><span id="line-174"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-175"></span><span>                </span><span class="hs-comment">-- do register allocation on each component.</span><span>
</span><span id="line-176"></span><span>                </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-glyph">!</span><span id="local-6989586621682851838"><span class="annot"><a href="#local-6989586621682851838"><span class="hs-identifier hs-var">final_blocks</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682851839"><span class="annot"><a href="#local-6989586621682851839"><span class="hs-identifier hs-var">stats</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682851840"><span class="annot"><a href="#local-6989586621682851840"><span class="hs-identifier hs-var">stack_use</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-177"></span><span>                        </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">NCGConfig
-&gt; [BlockId]
-&gt; BlockMap (UniqSet RegWithFormat)
-&gt; [SCC (LiveBasicBlock instr)]
-&gt; UniqDSM ([GenBasicBlock instr], RegAllocStats, Int)
forall instr.
Instruction instr =&gt;
NCGConfig
-&gt; [BlockId]
-&gt; BlockMap (UniqSet RegWithFormat)
-&gt; [SCC (LiveBasicBlock instr)]
-&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int)
</span><a href="GHC.CmmToAsm.Reg.Linear.html#linearRegAlloc"><span class="hs-identifier hs-var">linearRegAlloc</span></a></span><span> </span><span class="annot"><span class="annottext">NCGConfig
</span><a href="#local-6989586621682851829"><span class="hs-identifier hs-var">config</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockId]
</span><a href="#local-6989586621682851835"><span class="hs-identifier hs-var">entry_ids</span></a></span><span> </span><span class="annot"><span class="annottext">BlockMap (UniqSet RegWithFormat)
</span><a href="#local-6989586621682851837"><span class="hs-identifier hs-var">block_live</span></a></span><span> </span><span class="annot"><span class="annottext">[SCC (LiveBasicBlock instr)]
</span><a href="#local-6989586621682851833"><span class="hs-identifier hs-var">sccs</span></a></span><span>
</span><span id="line-178"></span><span>
</span><span id="line-179"></span><span>                </span><span class="hs-comment">-- make sure the block that was first in the input list</span><span>
</span><span id="line-180"></span><span>                </span><span class="hs-comment">--      stays at the front of the output</span><span>
</span><span id="line-181"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-glyph">!</span><span id="local-6989586621682851842"><span class="annot"><a href="#local-6989586621682851842"><span class="hs-identifier hs-var">first'</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682851843"><span class="annot"><a href="#local-6989586621682851843"><span class="hs-identifier hs-var">rest'</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-182"></span><span>                                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">partition</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">==</span></span><span> </span><span class="annot"><span class="hs-identifier">first_id</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><a href="GHC.Cmm.html#blockId"><span class="hs-identifier hs-type">blockId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682851838"><span class="hs-identifier hs-type">final_blocks</span></a></span><span>
</span><span id="line-183"></span><span>
</span><span id="line-184"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682851846"><span class="annot"><a href="#local-6989586621682851846"><span class="hs-identifier hs-var hs-var">max_spill_slots</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NCGConfig -&gt; Int
</span><a href="GHC.CmmToAsm.Reg.Linear.FreeRegs.html#maxSpillSlots"><span class="hs-identifier hs-var">maxSpillSlots</span></a></span><span> </span><span class="annot"><span class="annottext">NCGConfig
</span><a href="#local-6989586621682851829"><span class="hs-identifier hs-var">config</span></a></span><span>
</span><span id="line-185"></span><span>                    </span><span id="local-6989586621682851848"><span class="annot"><a href="#local-6989586621682851848"><span class="hs-identifier hs-var hs-var">extra_stack</span></a></span></span><span>
</span><span id="line-186"></span><span>                      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682851840"><span class="hs-identifier hs-var">stack_use</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682851846"><span class="hs-identifier hs-var">max_spill_slots</span></a></span><span>
</span><span id="line-187"></span><span>                      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Maybe Int) -&gt; Int -&gt; Maybe Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682851840"><span class="hs-identifier hs-var">stack_use</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682851846"><span class="hs-identifier hs-var">max_spill_slots</span></a></span><span>
</span><span id="line-188"></span><span>                      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-189"></span><span>                      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Int
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-190"></span><span>
</span><span id="line-191"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Cmm.html#CmmProc"><span class="hs-identifier hs-type">CmmProc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851834"><span class="hs-identifier hs-type">info</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851831"><span class="hs-identifier hs-type">lbl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851832"><span class="hs-identifier hs-type">live</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.html#ListGraph"><span class="hs-identifier hs-type">ListGraph</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682851842"><span class="hs-identifier hs-type">first'</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="#local-6989586621682851843"><span class="hs-identifier hs-type">rest'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-192"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682851848"><span class="hs-identifier hs-type">extra_stack</span></a></span><span>
</span><span id="line-193"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="#local-6989586621682851839"><span class="hs-identifier hs-type">stats</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-194"></span><span>
</span><span id="line-195"></span><span class="hs-comment">-- bogus. to make non-exhaustive match warning go away.</span><span>
</span><span id="line-196"></span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#regAlloc"><span class="hs-identifier hs-var">regAlloc</span></a></span><span> </span><span class="annot"><span class="annottext">NCGConfig
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.html#CmmProc"><span class="hs-identifier hs-type">CmmProc</span></a></span><span> </span><span class="annot"><span class="annottext">LiveInfo
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">CLabel
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[GlobalRegUse]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[SCC (LiveBasicBlock instr)]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-197"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
-&gt; UniqDSM
     (NatCmmDecl statics instr, Maybe Int, Maybe RegAllocStats)
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;RegAllocLinear.regAlloc: no match&quot;</span></span><span>
</span><span id="line-198"></span><span>
</span><span id="line-199"></span><span>
</span><span id="line-200"></span><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><span id="line-201"></span><span class="hs-comment">-- Linear sweep to allocate registers</span><span>
</span><span id="line-202"></span><span>
</span><span id="line-203"></span><span>
</span><span id="line-204"></span><span class="hs-comment">-- | Do register allocation on some basic blocks.</span><span>
</span><span id="line-205"></span><span class="hs-comment">--   But be careful to allocate a block in an SCC only if it has</span><span>
</span><span id="line-206"></span><span class="hs-comment">--   an entry in the block map or it is the first block.</span><span>
</span><span id="line-207"></span><span class="hs-comment">--</span><span>
</span><span id="line-208"></span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#linearRegAlloc"><span class="hs-identifier hs-type">linearRegAlloc</span></a></span><span>
</span><span id="line-209"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621682851574"><span class="annot"><a href="#local-6989586621682851574"><span class="hs-identifier hs-type">instr</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Instr.html#Instruction"><span class="hs-identifier hs-type">Instruction</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851574"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-210"></span><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Config.html#NCGConfig"><span class="hs-identifier hs-type">NCGConfig</span></a></span><span>
</span><span id="line-211"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="hs-comment">-- ^ entry points</span></span><span>
</span><span id="line-212"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html#BlockMap"><span class="hs-identifier hs-type">BlockMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Unique.Set.html#UniqSet"><span class="hs-identifier hs-type">UniqSet</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Format.html#RegWithFormat"><span class="hs-identifier hs-type">RegWithFormat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-213"></span><span>              </span><span class="annot"><span class="hs-comment">-- ^ live regs on entry to each basic block</span></span><span>
</span><span id="line-214"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Graph.html#SCC"><span class="hs-identifier hs-type">SCC</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html#LiveBasicBlock"><span class="hs-identifier hs-type">LiveBasicBlock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851574"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-215"></span><span>              </span><span class="annot"><span class="hs-comment">-- ^ instructions annotated with &quot;deaths&quot;</span></span><span>
</span><span id="line-216"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.DSM.html#UniqDSM"><span class="hs-identifier hs-type">UniqDSM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.CmmToAsm.Types.html#NatBasicBlock"><span class="hs-identifier hs-type">NatBasicBlock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851574"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#RegAllocStats"><span class="hs-identifier hs-type">RegAllocStats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-217"></span><span>
</span><span id="line-218"></span><span id="linearRegAlloc"><span class="annot"><span class="annottext">linearRegAlloc :: forall instr.
Instruction instr =&gt;
NCGConfig
-&gt; [BlockId]
-&gt; BlockMap (UniqSet RegWithFormat)
-&gt; [SCC (LiveBasicBlock instr)]
-&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int)
</span><a href="GHC.CmmToAsm.Reg.Linear.html#linearRegAlloc"><span class="hs-identifier hs-var hs-var">linearRegAlloc</span></a></span></span><span> </span><span id="local-6989586621682851899"><span class="annot"><span class="annottext">NCGConfig
</span><a href="#local-6989586621682851899"><span class="hs-identifier hs-var">config</span></a></span></span><span> </span><span id="local-6989586621682851900"><span class="annot"><span class="annottext">[BlockId]
</span><a href="#local-6989586621682851900"><span class="hs-identifier hs-var">entry_ids</span></a></span></span><span> </span><span id="local-6989586621682851901"><span class="annot"><span class="annottext">BlockMap (UniqSet RegWithFormat)
</span><a href="#local-6989586621682851901"><span class="hs-identifier hs-var">block_live</span></a></span></span><span> </span><span id="local-6989586621682851902"><span class="annot"><span class="annottext">[SCC (LiveBasicBlock instr)]
</span><a href="#local-6989586621682851902"><span class="hs-identifier hs-var">sccs</span></a></span></span><span>
</span><span id="line-219"></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Platform -&gt; Arch
</span><a href="GHC.Platform.html#platformArch"><span class="hs-identifier hs-var">platformArch</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682851904"><span class="hs-identifier hs-var">platform</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-220"></span><span>      </span><span class="annot"><span class="annottext">Arch
</span><span class="hs-identifier hs-var">ArchX86</span></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FreeRegs -&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int)
forall regs.
(FR regs, Outputable regs) =&gt;
regs -&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int)
</span><a href="#local-6989586621682851906"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">(FreeRegs -&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int))
-&gt; FreeRegs -&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Platform -&gt; FreeRegs
forall freeRegs. FR freeRegs =&gt; Platform -&gt; freeRegs
</span><a href="GHC.CmmToAsm.Reg.Linear.FreeRegs.html#frInitFreeRegs"><span class="hs-identifier hs-var">frInitFreeRegs</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682851904"><span class="hs-identifier hs-var">platform</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.X86.html#FreeRegs"><span class="hs-identifier hs-type">X86.FreeRegs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span>      </span><span class="annot"><span class="annottext">Arch
</span><span class="hs-identifier hs-var">ArchX86_64</span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FreeRegs -&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int)
forall regs.
(FR regs, Outputable regs) =&gt;
regs -&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int)
</span><a href="#local-6989586621682851906"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">(FreeRegs -&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int))
-&gt; FreeRegs -&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Platform -&gt; FreeRegs
forall freeRegs. FR freeRegs =&gt; Platform -&gt; freeRegs
</span><a href="GHC.CmmToAsm.Reg.Linear.FreeRegs.html#frInitFreeRegs"><span class="hs-identifier hs-var">frInitFreeRegs</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682851904"><span class="hs-identifier hs-var">platform</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.X86_64.html#FreeRegs"><span class="hs-identifier hs-type">X86_64.FreeRegs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span>      </span><span class="annot"><span class="annottext">Arch
</span><span class="hs-identifier hs-var">ArchS390X</span></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int)
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;linearRegAlloc ArchS390X&quot;</span></span><span>
</span><span id="line-223"></span><span>      </span><span class="annot"><span class="annottext">Arch
</span><span class="hs-identifier hs-var">ArchPPC</span></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FreeRegs -&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int)
forall regs.
(FR regs, Outputable regs) =&gt;
regs -&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int)
</span><a href="#local-6989586621682851906"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">(FreeRegs -&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int))
-&gt; FreeRegs -&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Platform -&gt; FreeRegs
forall freeRegs. FR freeRegs =&gt; Platform -&gt; freeRegs
</span><a href="GHC.CmmToAsm.Reg.Linear.FreeRegs.html#frInitFreeRegs"><span class="hs-identifier hs-var">frInitFreeRegs</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682851904"><span class="hs-identifier hs-var">platform</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.PPC.html#FreeRegs"><span class="hs-identifier hs-type">PPC.FreeRegs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-224"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">ArchARM</span></span><span> </span><span class="annot"><span class="annottext">ArmISA
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[ArmISAExt]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ArmABI
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int)
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;linearRegAlloc ArchARM&quot;</span></span><span>
</span><span id="line-225"></span><span>      </span><span class="annot"><span class="annottext">Arch
</span><span class="hs-identifier hs-var">ArchAArch64</span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FreeRegs -&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int)
forall regs.
(FR regs, Outputable regs) =&gt;
regs -&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int)
</span><a href="#local-6989586621682851906"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">(FreeRegs -&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int))
-&gt; FreeRegs -&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Platform -&gt; FreeRegs
forall freeRegs. FR freeRegs =&gt; Platform -&gt; freeRegs
</span><a href="GHC.CmmToAsm.Reg.Linear.FreeRegs.html#frInitFreeRegs"><span class="hs-identifier hs-var">frInitFreeRegs</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682851904"><span class="hs-identifier hs-var">platform</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.AArch64.html#FreeRegs"><span class="hs-identifier hs-type">AArch64.FreeRegs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-226"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">ArchPPC_64</span></span><span> </span><span class="annot"><span class="annottext">PPC_64ABI
</span><span class="hs-identifier">_</span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FreeRegs -&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int)
forall regs.
(FR regs, Outputable regs) =&gt;
regs -&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int)
</span><a href="#local-6989586621682851906"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">(FreeRegs -&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int))
-&gt; FreeRegs -&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Platform -&gt; FreeRegs
forall freeRegs. FR freeRegs =&gt; Platform -&gt; freeRegs
</span><a href="GHC.CmmToAsm.Reg.Linear.FreeRegs.html#frInitFreeRegs"><span class="hs-identifier hs-var">frInitFreeRegs</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682851904"><span class="hs-identifier hs-var">platform</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.PPC.html#FreeRegs"><span class="hs-identifier hs-type">PPC.FreeRegs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-227"></span><span>      </span><span class="annot"><span class="annottext">Arch
</span><span class="hs-identifier hs-var">ArchAlpha</span></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int)
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;linearRegAlloc ArchAlpha&quot;</span></span><span>
</span><span id="line-228"></span><span>      </span><span class="annot"><span class="annottext">Arch
</span><span class="hs-identifier hs-var">ArchMipseb</span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int)
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;linearRegAlloc ArchMipseb&quot;</span></span><span>
</span><span id="line-229"></span><span>      </span><span class="annot"><span class="annottext">Arch
</span><span class="hs-identifier hs-var">ArchMipsel</span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int)
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;linearRegAlloc ArchMipsel&quot;</span></span><span>
</span><span id="line-230"></span><span>      </span><span class="annot"><span class="annottext">Arch
</span><span class="hs-identifier hs-var">ArchRISCV64</span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FreeRegs -&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int)
forall regs.
(FR regs, Outputable regs) =&gt;
regs -&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int)
</span><a href="#local-6989586621682851906"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Platform -&gt; FreeRegs
forall freeRegs. FR freeRegs =&gt; Platform -&gt; freeRegs
</span><a href="GHC.CmmToAsm.Reg.Linear.FreeRegs.html#frInitFreeRegs"><span class="hs-identifier hs-var">frInitFreeRegs</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682851904"><span class="hs-identifier hs-var">platform</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.RV64.html#FreeRegs"><span class="hs-identifier hs-type">RV64.FreeRegs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-231"></span><span>      </span><span class="annot"><span class="annottext">Arch
</span><span class="hs-identifier hs-var">ArchLoongArch64</span></span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int)
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;linearRegAlloc ArchLoongArch64&quot;</span></span><span>
</span><span id="line-232"></span><span>      </span><span class="annot"><span class="annottext">Arch
</span><span class="hs-identifier hs-var">ArchJavaScript</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int)
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;linearRegAlloc ArchJavaScript&quot;</span></span><span>
</span><span id="line-233"></span><span>      </span><span class="annot"><span class="annottext">Arch
</span><span class="hs-identifier hs-var">ArchWasm32</span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int)
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;linearRegAlloc ArchWasm32&quot;</span></span><span>
</span><span id="line-234"></span><span>      </span><span class="annot"><span class="annottext">Arch
</span><span class="hs-identifier hs-var">ArchUnknown</span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int)
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;linearRegAlloc ArchUnknown&quot;</span></span><span>
</span><span id="line-235"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-236"></span><span>  </span><span id="local-6989586621682851598"><span class="annot"><a href="#local-6989586621682851906"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.FreeRegs.html#FR"><span class="hs-identifier hs-type">FR</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851598"><span class="hs-identifier hs-type">regs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851598"><span class="hs-identifier hs-type">regs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-237"></span><span>     </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621682851598"><span class="hs-identifier hs-type">regs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.DSM.html#UniqDSM"><span class="hs-identifier hs-type">UniqDSM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.CmmToAsm.Types.html#NatBasicBlock"><span class="hs-identifier hs-type">NatBasicBlock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851574"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#RegAllocStats"><span class="hs-identifier hs-type">RegAllocStats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span></span><span>
</span><span id="line-238"></span><span>  </span><span id="local-6989586621682851906"><span class="annot"><span class="annottext">go :: forall regs.
(FR regs, Outputable regs) =&gt;
regs -&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int)
</span><a href="#local-6989586621682851906"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621682851925"><span class="annot"><span class="annottext">regs
</span><a href="#local-6989586621682851925"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NCGConfig
-&gt; regs
-&gt; [BlockId]
-&gt; BlockMap (UniqSet RegWithFormat)
-&gt; [SCC (LiveBasicBlock instr)]
-&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int)
forall freeRegs instr.
OutputableRegConstraint freeRegs instr =&gt;
NCGConfig
-&gt; freeRegs
-&gt; [BlockId]
-&gt; BlockMap (UniqSet RegWithFormat)
-&gt; [SCC (LiveBasicBlock instr)]
-&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int)
</span><a href="GHC.CmmToAsm.Reg.Linear.html#linearRegAlloc%27"><span class="hs-identifier hs-var">linearRegAlloc'</span></a></span><span> </span><span class="annot"><span class="annottext">NCGConfig
</span><a href="#local-6989586621682851899"><span class="hs-identifier hs-var">config</span></a></span><span> </span><span class="annot"><span class="annottext">regs
</span><a href="#local-6989586621682851925"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockId]
</span><a href="#local-6989586621682851900"><span class="hs-identifier hs-var">entry_ids</span></a></span><span> </span><span class="annot"><span class="annottext">BlockMap (UniqSet RegWithFormat)
</span><a href="#local-6989586621682851901"><span class="hs-identifier hs-var">block_live</span></a></span><span> </span><span class="annot"><span class="annottext">[SCC (LiveBasicBlock instr)]
</span><a href="#local-6989586621682851902"><span class="hs-identifier hs-var">sccs</span></a></span><span>
</span><span id="line-239"></span><span>  </span><span id="local-6989586621682851904"><span class="annot"><span class="annottext">platform :: Platform
</span><a href="#local-6989586621682851904"><span class="hs-identifier hs-var hs-var">platform</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NCGConfig -&gt; Platform
</span><a href="GHC.CmmToAsm.Config.html#ncgPlatform"><span class="hs-identifier hs-var">ncgPlatform</span></a></span><span> </span><span class="annot"><span class="annottext">NCGConfig
</span><a href="#local-6989586621682851899"><span class="hs-identifier hs-var">config</span></a></span><span>
</span><span id="line-240"></span><span>
</span><span id="line-241"></span><span class="hs-comment">-- | Constraints on the instruction instances used by the</span><span>
</span><span id="line-242"></span><span class="hs-comment">-- linear allocator.</span><span>
</span><span id="line-243"></span><span class="hs-keyword">type</span><span> </span><span id="OutputableRegConstraint"><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#OutputableRegConstraint"><span class="hs-identifier hs-var">OutputableRegConstraint</span></a></span></span><span> </span><span id="local-6989586621682851928"><span class="annot"><a href="#local-6989586621682851928"><span class="hs-identifier hs-type">freeRegs</span></a></span></span><span> </span><span id="local-6989586621682851929"><span class="annot"><a href="#local-6989586621682851929"><span class="hs-identifier hs-type">instr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-244"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.FreeRegs.html#FR"><span class="hs-identifier hs-type">FR</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851928"><span class="hs-identifier hs-type">freeRegs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851928"><span class="hs-identifier hs-type">freeRegs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Instr.html#Instruction"><span class="hs-identifier hs-type">Instruction</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851929"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-245"></span><span>
</span><span id="line-246"></span><span id="local-6989586621682851612"><span id="local-6989586621682851613"><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#linearRegAlloc%27"><span class="hs-identifier hs-type">linearRegAlloc'</span></a></span><span>
</span><span id="line-247"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#OutputableRegConstraint"><span class="hs-identifier hs-type">OutputableRegConstraint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851612"><span class="hs-identifier hs-type">freeRegs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851613"><span class="hs-identifier hs-type">instr</span></a></span><span>
</span><span id="line-248"></span><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Config.html#NCGConfig"><span class="hs-identifier hs-type">NCGConfig</span></a></span><span>
</span><span id="line-249"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621682851612"><span class="hs-identifier hs-type">freeRegs</span></a></span><span>
</span><span id="line-250"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">]</span><span>                    </span><span class="annot"><span class="hs-comment">-- ^ entry points</span></span><span>
</span><span id="line-251"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html#BlockMap"><span class="hs-identifier hs-type">BlockMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Unique.Set.html#UniqSet"><span class="hs-identifier hs-type">UniqSet</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Format.html#RegWithFormat"><span class="hs-identifier hs-type">RegWithFormat</span></a></span><span class="hs-special">)</span><span>              </span><span class="annot"><span class="hs-comment">-- ^ live regs on entry to each basic block</span></span><span>
</span><span id="line-252"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Graph.html#SCC"><span class="hs-identifier hs-type">SCC</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html#LiveBasicBlock"><span class="hs-identifier hs-type">LiveBasicBlock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851613"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="hs-comment">-- ^ instructions annotated with &quot;deaths&quot;</span></span><span>
</span><span id="line-253"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.DSM.html#UniqDSM"><span class="hs-identifier hs-type">UniqDSM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.CmmToAsm.Types.html#NatBasicBlock"><span class="hs-identifier hs-type">NatBasicBlock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851613"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#RegAllocStats"><span class="hs-identifier hs-type">RegAllocStats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-254"></span><span>
</span><span id="line-255"></span><span id="linearRegAlloc%27"><span class="annot"><span class="annottext">linearRegAlloc' :: forall freeRegs instr.
OutputableRegConstraint freeRegs instr =&gt;
NCGConfig
-&gt; freeRegs
-&gt; [BlockId]
-&gt; BlockMap (UniqSet RegWithFormat)
-&gt; [SCC (LiveBasicBlock instr)]
-&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int)
</span><a href="GHC.CmmToAsm.Reg.Linear.html#linearRegAlloc%27"><span class="hs-identifier hs-var hs-var">linearRegAlloc'</span></a></span></span><span> </span><span id="local-6989586621682851932"><span class="annot"><span class="annottext">NCGConfig
</span><a href="#local-6989586621682851932"><span class="hs-identifier hs-var">config</span></a></span></span><span> </span><span id="local-6989586621682851933"><span class="annot"><span class="annottext">freeRegs
</span><a href="#local-6989586621682851933"><span class="hs-identifier hs-var">initFreeRegs</span></a></span></span><span> </span><span id="local-6989586621682851934"><span class="annot"><span class="annottext">[BlockId]
</span><a href="#local-6989586621682851934"><span class="hs-identifier hs-var">entry_ids</span></a></span></span><span> </span><span id="local-6989586621682851935"><span class="annot"><span class="annottext">BlockMap (UniqSet RegWithFormat)
</span><a href="#local-6989586621682851935"><span class="hs-identifier hs-var">block_live</span></a></span></span><span> </span><span id="local-6989586621682851936"><span class="annot"><span class="annottext">[SCC (LiveBasicBlock instr)]
</span><a href="#local-6989586621682851936"><span class="hs-identifier hs-var">sccs</span></a></span></span><span>
</span><span id="line-256"></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DUniqSupply
 -&gt; DUniqResult ([NatBasicBlock instr], RegAllocStats, Int))
-&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int)
forall a. (DUniqSupply -&gt; DUniqResult a) -&gt; UniqDSM a
</span><a href="GHC.Types.Unique.DSM.html#UDSM"><span class="hs-identifier hs-var">UDSM</span></a></span><span> </span><span class="annot"><span class="annottext">((DUniqSupply
  -&gt; DUniqResult ([NatBasicBlock instr], RegAllocStats, Int))
 -&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int))
-&gt; (DUniqSupply
    -&gt; DUniqResult ([NatBasicBlock instr], RegAllocStats, Int))
-&gt; UniqDSM ([NatBasicBlock instr], RegAllocStats, Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682851938"><span class="annot"><span class="annottext">DUniqSupply
</span><a href="#local-6989586621682851938"><span class="hs-identifier hs-var">us</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-257"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockAssignment freeRegs
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682851939"><span class="annot"><span class="annottext">StackMap
</span><a href="#local-6989586621682851939"><span class="hs-identifier hs-var">stack</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682851940"><span class="annot"><span class="annottext">RegAllocStats
</span><a href="#local-6989586621682851940"><span class="hs-identifier hs-var">stats</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682851941"><span class="annot"><span class="annottext">[NatBasicBlock instr]
</span><a href="#local-6989586621682851941"><span class="hs-identifier hs-var">blocks</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682851942"><span class="annot"><span class="annottext">DUniqSupply
</span><a href="#local-6989586621682851942"><span class="hs-identifier hs-var">us'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-258"></span><span>            </span><span class="annot"><span class="annottext">NCGConfig
-&gt; BlockAssignment freeRegs
-&gt; freeRegs
-&gt; RegMap Loc
-&gt; StackMap
-&gt; DUniqSupply
-&gt; RegM freeRegs [NatBasicBlock instr]
-&gt; (BlockAssignment freeRegs, StackMap, RegAllocStats,
    [NatBasicBlock instr], DUniqSupply)
forall freeRegs a.
NCGConfig
-&gt; BlockAssignment freeRegs
-&gt; freeRegs
-&gt; RegMap Loc
-&gt; StackMap
-&gt; DUniqSupply
-&gt; RegM freeRegs a
-&gt; (BlockAssignment freeRegs, StackMap, RegAllocStats, a,
    DUniqSupply)
</span><a href="GHC.CmmToAsm.Reg.Linear.State.html#runR"><span class="hs-identifier hs-var">runR</span></a></span><span> </span><span class="annot"><span class="annottext">NCGConfig
</span><a href="#local-6989586621682851932"><span class="hs-identifier hs-var">config</span></a></span><span> </span><span class="annot"><span class="annottext">BlockAssignment freeRegs
forall freeRegs. BlockAssignment freeRegs
</span><a href="GHC.CmmToAsm.Reg.Linear.Base.html#emptyBlockAssignment"><span class="hs-identifier hs-var">emptyBlockAssignment</span></a></span><span> </span><span class="annot"><span class="annottext">freeRegs
</span><a href="#local-6989586621682851933"><span class="hs-identifier hs-var">initFreeRegs</span></a></span><span> </span><span class="annot"><span class="annottext">RegMap Loc
forall a. RegMap a
</span><a href="GHC.CmmToAsm.Reg.Liveness.html#emptyRegMap"><span class="hs-identifier hs-var">emptyRegMap</span></a></span><span> </span><span class="annot"><span class="annottext">StackMap
</span><a href="GHC.CmmToAsm.Reg.Linear.StackMap.html#emptyStackMap"><span class="hs-identifier hs-var">emptyStackMap</span></a></span><span> </span><span class="annot"><span class="annottext">DUniqSupply
</span><a href="#local-6989586621682851938"><span class="hs-identifier hs-var">us</span></a></span><span>
</span><span id="line-259"></span><span>                </span><span class="annot"><span class="annottext">(RegM freeRegs [NatBasicBlock instr]
 -&gt; (BlockAssignment freeRegs, StackMap, RegAllocStats,
     [NatBasicBlock instr], DUniqSupply))
-&gt; RegM freeRegs [NatBasicBlock instr]
-&gt; (BlockAssignment freeRegs, StackMap, RegAllocStats,
    [NatBasicBlock instr], DUniqSupply)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[BlockId]
-&gt; BlockMap (UniqSet RegWithFormat)
-&gt; [NatBasicBlock instr]
-&gt; [SCC (LiveBasicBlock instr)]
-&gt; RegM freeRegs [NatBasicBlock instr]
forall freeRegs instr.
OutputableRegConstraint freeRegs instr =&gt;
[BlockId]
-&gt; BlockMap (UniqSet RegWithFormat)
-&gt; [NatBasicBlock instr]
-&gt; [SCC (LiveBasicBlock instr)]
-&gt; RegM freeRegs [NatBasicBlock instr]
</span><a href="GHC.CmmToAsm.Reg.Linear.html#linearRA_SCCs"><span class="hs-identifier hs-var">linearRA_SCCs</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockId]
</span><a href="#local-6989586621682851934"><span class="hs-identifier hs-var">entry_ids</span></a></span><span> </span><span class="annot"><span class="annottext">BlockMap (UniqSet RegWithFormat)
</span><a href="#local-6989586621682851935"><span class="hs-identifier hs-var">block_live</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[SCC (LiveBasicBlock instr)]
</span><a href="#local-6989586621682851936"><span class="hs-identifier hs-var">sccs</span></a></span><span>
</span><span id="line-260"></span><span>     </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">([NatBasicBlock instr], RegAllocStats, Int)
-&gt; DUniqSupply
-&gt; DUniqResult ([NatBasicBlock instr], RegAllocStats, Int)
forall a. a -&gt; DUniqSupply -&gt; (# a, DUniqSupply #)
</span><a href="GHC.Types.Unique.DSM.html#DUniqResult"><span class="hs-identifier hs-var">DUniqResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[NatBasicBlock instr]
</span><a href="#local-6989586621682851941"><span class="hs-identifier hs-var">blocks</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RegAllocStats
</span><a href="#local-6989586621682851940"><span class="hs-identifier hs-var">stats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StackMap -&gt; Int
</span><a href="GHC.CmmToAsm.Reg.Linear.StackMap.html#getStackUse"><span class="hs-identifier hs-var">getStackUse</span></a></span><span> </span><span class="annot"><span class="annottext">StackMap
</span><a href="#local-6989586621682851939"><span class="hs-identifier hs-var">stack</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DUniqSupply
</span><a href="#local-6989586621682851942"><span class="hs-identifier hs-var">us'</span></a></span><span>
</span><span id="line-261"></span><span>
</span><span id="line-262"></span><span>
</span><span id="line-263"></span><span id="local-6989586621682851628"><span id="local-6989586621682851629"><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#linearRA_SCCs"><span class="hs-identifier hs-type">linearRA_SCCs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#OutputableRegConstraint"><span class="hs-identifier hs-type">OutputableRegConstraint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851628"><span class="hs-identifier hs-type">freeRegs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851629"><span class="hs-identifier hs-type">instr</span></a></span><span>
</span><span id="line-264"></span><span>              </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-265"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html#BlockMap"><span class="hs-identifier hs-type">BlockMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Unique.Set.html#UniqSet"><span class="hs-identifier hs-type">UniqSet</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Format.html#RegWithFormat"><span class="hs-identifier hs-type">RegWithFormat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-266"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CmmToAsm.Types.html#NatBasicBlock"><span class="hs-identifier hs-type">NatBasicBlock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851629"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-267"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Graph.html#SCC"><span class="hs-identifier hs-type">SCC</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html#LiveBasicBlock"><span class="hs-identifier hs-type">LiveBasicBlock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851629"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-268"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#RegM"><span class="hs-identifier hs-type">RegM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851628"><span class="hs-identifier hs-type">freeRegs</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CmmToAsm.Types.html#NatBasicBlock"><span class="hs-identifier hs-type">NatBasicBlock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851629"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">]</span></span></span><span>
</span><span id="line-269"></span><span>
</span><span id="line-270"></span><span id="linearRA_SCCs"><span class="annot"><span class="annottext">linearRA_SCCs :: forall freeRegs instr.
OutputableRegConstraint freeRegs instr =&gt;
[BlockId]
-&gt; BlockMap (UniqSet RegWithFormat)
-&gt; [NatBasicBlock instr]
-&gt; [SCC (LiveBasicBlock instr)]
-&gt; RegM freeRegs [NatBasicBlock instr]
</span><a href="GHC.CmmToAsm.Reg.Linear.html#linearRA_SCCs"><span class="hs-identifier hs-var hs-var">linearRA_SCCs</span></a></span></span><span> </span><span class="annot"><span class="annottext">[BlockId]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">BlockMap (UniqSet RegWithFormat)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682851961"><span class="annot"><span class="annottext">[NatBasicBlock instr]
</span><a href="#local-6989586621682851961"><span class="hs-identifier hs-var">blocksAcc</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-271"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[NatBasicBlock instr] -&gt; RegM freeRegs [NatBasicBlock instr]
forall a. a -&gt; RegM freeRegs a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([NatBasicBlock instr] -&gt; RegM freeRegs [NatBasicBlock instr])
-&gt; [NatBasicBlock instr] -&gt; RegM freeRegs [NatBasicBlock instr]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[NatBasicBlock instr] -&gt; [NatBasicBlock instr]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[NatBasicBlock instr]
</span><a href="#local-6989586621682851961"><span class="hs-identifier hs-var">blocksAcc</span></a></span><span>
</span><span id="line-272"></span><span>
</span><span id="line-273"></span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#linearRA_SCCs"><span class="hs-identifier hs-var">linearRA_SCCs</span></a></span><span> </span><span id="local-6989586621682851963"><span class="annot"><span class="annottext">[BlockId]
</span><a href="#local-6989586621682851963"><span class="hs-identifier hs-var">entry_ids</span></a></span></span><span> </span><span id="local-6989586621682851964"><span class="annot"><span class="annottext">BlockMap (UniqSet RegWithFormat)
</span><a href="#local-6989586621682851964"><span class="hs-identifier hs-var">block_live</span></a></span></span><span> </span><span id="local-6989586621682851965"><span class="annot"><span class="annottext">[NatBasicBlock instr]
</span><a href="#local-6989586621682851965"><span class="hs-identifier hs-var">blocksAcc</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Graph.html#AcyclicSCC"><span class="hs-identifier hs-type">AcyclicSCC</span></a></span><span> </span><span id="local-6989586621682851967"><span class="annot"><span class="annottext">LiveBasicBlock instr
</span><a href="#local-6989586621682851967"><span class="hs-identifier hs-var">block</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682851968"><span class="annot"><span class="annottext">[SCC (LiveBasicBlock instr)]
</span><a href="#local-6989586621682851968"><span class="hs-identifier hs-var">sccs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-274"></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>   </span><span id="local-6989586621682851969"><span class="annot"><a href="#local-6989586621682851969"><span class="hs-identifier hs-var">blocks'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BlockMap (UniqSet RegWithFormat)
-&gt; LiveBasicBlock instr -&gt; RegM freeRegs [NatBasicBlock instr]
forall freeRegs instr.
OutputableRegConstraint freeRegs instr =&gt;
BlockMap (UniqSet RegWithFormat)
-&gt; LiveBasicBlock instr -&gt; RegM freeRegs [NatBasicBlock instr]
</span><a href="GHC.CmmToAsm.Reg.Linear.html#processBlock"><span class="hs-identifier hs-var">processBlock</span></a></span><span> </span><span class="annot"><span class="annottext">BlockMap (UniqSet RegWithFormat)
</span><a href="#local-6989586621682851964"><span class="hs-identifier hs-var">block_live</span></a></span><span> </span><span class="annot"><span class="annottext">LiveBasicBlock instr
</span><a href="#local-6989586621682851967"><span class="hs-identifier hs-var">block</span></a></span><span>
</span><span id="line-275"></span><span>        </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#linearRA_SCCs"><span class="hs-identifier hs-type">linearRA_SCCs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851963"><span class="hs-identifier hs-type">entry_ids</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851964"><span class="hs-identifier hs-type">block_live</span></a></span><span>
</span><span id="line-276"></span><span>                </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">reverse</span></span><span> </span><span class="annot"><a href="#local-6989586621682851969"><span class="hs-identifier hs-type">blocks'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621682851965"><span class="hs-identifier hs-type">blocksAcc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-277"></span><span>                </span><span class="annot"><a href="#local-6989586621682851968"><span class="hs-identifier hs-type">sccs</span></a></span><span>
</span><span id="line-278"></span><span>
</span><span id="line-279"></span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#linearRA_SCCs"><span class="hs-identifier hs-var">linearRA_SCCs</span></a></span><span> </span><span id="local-6989586621682851971"><span class="annot"><span class="annottext">[BlockId]
</span><a href="#local-6989586621682851971"><span class="hs-identifier hs-var">entry_ids</span></a></span></span><span> </span><span id="local-6989586621682851972"><span class="annot"><span class="annottext">BlockMap (UniqSet RegWithFormat)
</span><a href="#local-6989586621682851972"><span class="hs-identifier hs-var">block_live</span></a></span></span><span> </span><span id="local-6989586621682851973"><span class="annot"><span class="annottext">[NatBasicBlock instr]
</span><a href="#local-6989586621682851973"><span class="hs-identifier hs-var">blocksAcc</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Graph.html#CyclicSCC"><span class="hs-identifier hs-type">CyclicSCC</span></a></span><span> </span><span id="local-6989586621682851975"><span class="annot"><span class="annottext">[LiveBasicBlock instr]
</span><a href="#local-6989586621682851975"><span class="hs-identifier hs-var">blocks</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682851976"><span class="annot"><span class="annottext">[SCC (LiveBasicBlock instr)]
</span><a href="#local-6989586621682851976"><span class="hs-identifier hs-var">sccs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-280"></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-281"></span><span>        </span><span id="local-6989586621682851977"><span class="annot"><a href="#local-6989586621682851977"><span class="hs-identifier hs-var">blockss'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[BlockId]
-&gt; BlockMap (UniqSet RegWithFormat)
-&gt; [LiveBasicBlock instr]
-&gt; RegM freeRegs [[NatBasicBlock instr]]
forall freeRegs instr.
OutputableRegConstraint freeRegs instr =&gt;
[BlockId]
-&gt; BlockMap (UniqSet RegWithFormat)
-&gt; [GenBasicBlock (LiveInstr instr)]
-&gt; RegM freeRegs [[NatBasicBlock instr]]
</span><a href="GHC.CmmToAsm.Reg.Linear.html#process"><span class="hs-identifier hs-var">process</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockId]
</span><a href="#local-6989586621682851971"><span class="hs-identifier hs-var">entry_ids</span></a></span><span> </span><span class="annot"><span class="annottext">BlockMap (UniqSet RegWithFormat)
</span><a href="#local-6989586621682851972"><span class="hs-identifier hs-var">block_live</span></a></span><span> </span><span class="annot"><span class="annottext">[LiveBasicBlock instr]
</span><a href="#local-6989586621682851975"><span class="hs-identifier hs-var">blocks</span></a></span><span>
</span><span id="line-282"></span><span>        </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#linearRA_SCCs"><span class="hs-identifier hs-type">linearRA_SCCs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851971"><span class="hs-identifier hs-type">entry_ids</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851972"><span class="hs-identifier hs-type">block_live</span></a></span><span>
</span><span id="line-283"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">reverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">concat</span></span><span> </span><span class="annot"><a href="#local-6989586621682851977"><span class="hs-identifier hs-type">blockss'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621682851973"><span class="hs-identifier hs-type">blocksAcc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-284"></span><span>                </span><span class="annot"><a href="#local-6989586621682851976"><span class="hs-identifier hs-type">sccs</span></a></span><span>
</span><span id="line-285"></span><span>
</span><span id="line-286"></span><span class="hs-comment">{- from John Dias's patch 2008/10/16:
   The linear-scan allocator sometimes allocates a block
   before allocating one of its predecessors, which could lead to
   inconsistent allocations. Make it so a block is only allocated
   if a predecessor has set the &quot;incoming&quot; assignments for the block, or
   if it's the procedure's entry block.

   BL 2009/02: Careful. If the assignment for a block doesn't get set for
   some reason then this function will loop. We should probably do some
   more sanity checking to guard against this eventuality.
-}</span><span>
</span><span id="line-297"></span><span>
</span><span id="line-298"></span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#process"><span class="hs-identifier hs-type">process</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621682851638"><span class="annot"><a href="#local-6989586621682851638"><span class="hs-identifier hs-type">freeRegs</span></a></span></span><span> </span><span id="local-6989586621682851639"><span class="annot"><a href="#local-6989586621682851639"><span class="hs-identifier hs-type">instr</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#OutputableRegConstraint"><span class="hs-identifier hs-type">OutputableRegConstraint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851638"><span class="hs-identifier hs-type">freeRegs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851639"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-299"></span><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-300"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html#BlockMap"><span class="hs-identifier hs-type">BlockMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Unique.Set.html#UniqSet"><span class="hs-identifier hs-type">UniqSet</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Format.html#RegWithFormat"><span class="hs-identifier hs-type">RegWithFormat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-301"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Cmm.html#GenBasicBlock"><span class="hs-identifier hs-type">GenBasicBlock</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html#LiveInstr"><span class="hs-identifier hs-type">LiveInstr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851639"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-302"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#RegM"><span class="hs-identifier hs-type">RegM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851638"><span class="hs-identifier hs-type">freeRegs</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="annot"><a href="GHC.CmmToAsm.Types.html#NatBasicBlock"><span class="hs-identifier hs-type">NatBasicBlock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851639"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-303"></span><span id="process"><span class="annot"><span class="annottext">process :: forall freeRegs instr.
OutputableRegConstraint freeRegs instr =&gt;
[BlockId]
-&gt; BlockMap (UniqSet RegWithFormat)
-&gt; [GenBasicBlock (LiveInstr instr)]
-&gt; RegM freeRegs [[NatBasicBlock instr]]
</span><a href="GHC.CmmToAsm.Reg.Linear.html#process"><span class="hs-identifier hs-var hs-var">process</span></a></span></span><span> </span><span id="local-6989586621682851990"><span class="annot"><span class="annottext">[BlockId]
</span><a href="#local-6989586621682851990"><span class="hs-identifier hs-var">entry_ids</span></a></span></span><span> </span><span id="local-6989586621682851991"><span class="annot"><span class="annottext">BlockMap (UniqSet RegWithFormat)
</span><a href="#local-6989586621682851991"><span class="hs-identifier hs-var">block_live</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-304"></span><span>    </span><span class="hs-glyph">\</span><span id="local-6989586621682851992"><span class="annot"><span class="annottext">[GenBasicBlock (LiveInstr instr)]
</span><a href="#local-6989586621682851992"><span class="hs-identifier hs-var">blocks</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[GenBasicBlock (LiveInstr instr)]
-&gt; [GenBasicBlock (LiveInstr instr)]
-&gt; [[NatBasicBlock instr]]
-&gt; Bool
-&gt; RegM freeRegs [[NatBasicBlock instr]]
</span><a href="#local-6989586621682851993"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[GenBasicBlock (LiveInstr instr)]
</span><a href="#local-6989586621682851992"><span class="hs-identifier hs-var">blocks</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[NatBasicBlock instr] -&gt; [[NatBasicBlock instr]]
forall a. a -&gt; [a]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-305"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-306"></span><span>    </span><span class="annot"><a href="#local-6989586621682851993"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Cmm.html#GenBasicBlock"><span class="hs-identifier hs-type">GenBasicBlock</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html#LiveInstr"><span class="hs-identifier hs-type">LiveInstr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851639"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-307"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Cmm.html#GenBasicBlock"><span class="hs-identifier hs-type">GenBasicBlock</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html#LiveInstr"><span class="hs-identifier hs-type">LiveInstr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851639"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-308"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="annot"><a href="GHC.CmmToAsm.Types.html#NatBasicBlock"><span class="hs-identifier hs-type">NatBasicBlock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851639"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-309"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-310"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#RegM"><span class="hs-identifier hs-type">RegM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851638"><span class="hs-identifier hs-type">freeRegs</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="annot"><a href="GHC.CmmToAsm.Types.html#NatBasicBlock"><span class="hs-identifier hs-type">NatBasicBlock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851639"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-311"></span><span>    </span><span id="local-6989586621682851993"><span class="annot"><span class="annottext">go :: [GenBasicBlock (LiveInstr instr)]
-&gt; [GenBasicBlock (LiveInstr instr)]
-&gt; [[NatBasicBlock instr]]
-&gt; Bool
-&gt; RegM freeRegs [[NatBasicBlock instr]]
</span><a href="#local-6989586621682851993"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>         </span><span id="local-6989586621682851994"><span class="annot"><span class="annottext">[[NatBasicBlock instr]]
</span><a href="#local-6989586621682851994"><span class="hs-identifier hs-var">accum</span></a></span></span><span> </span><span id="local-6989586621682851995"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682851995"><span class="hs-identifier hs-var">_madeProgress</span></a></span></span><span>
</span><span id="line-312"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[[NatBasicBlock instr]] -&gt; RegM freeRegs [[NatBasicBlock instr]]
forall a. a -&gt; RegM freeRegs a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([[NatBasicBlock instr]] -&gt; RegM freeRegs [[NatBasicBlock instr]])
-&gt; [[NatBasicBlock instr]] -&gt; RegM freeRegs [[NatBasicBlock instr]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[[NatBasicBlock instr]] -&gt; [[NatBasicBlock instr]]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[[NatBasicBlock instr]]
</span><a href="#local-6989586621682851994"><span class="hs-identifier hs-var">accum</span></a></span><span>
</span><span id="line-313"></span><span>
</span><span id="line-314"></span><span>    </span><span class="annot"><a href="#local-6989586621682851993"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621682851996"><span class="annot"><span class="annottext">[GenBasicBlock (LiveInstr instr)]
</span><a href="#local-6989586621682851996"><span class="hs-identifier hs-var">next_round</span></a></span></span><span> </span><span id="local-6989586621682851997"><span class="annot"><span class="annottext">[[NatBasicBlock instr]]
</span><a href="#local-6989586621682851997"><span class="hs-identifier hs-var">accum</span></a></span></span><span> </span><span id="local-6989586621682851998"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682851998"><span class="hs-identifier hs-var">madeProgress</span></a></span></span><span>
</span><span id="line-315"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682851998"><span class="hs-identifier hs-var">madeProgress</span></a></span><span>
</span><span id="line-316"></span><span>          </span><span class="hs-comment">{- BUGS: There are so many unreachable blocks in the code the warnings are overwhelming.
             pprTrace &quot;RegAlloc.Linear.Main.process: no progress made, bailing out.&quot;
                (  text &quot;Unreachable blocks:&quot;
                $$ vcat (map ppr next_round)) -}</span><span>
</span><span id="line-320"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[[NatBasicBlock instr]] -&gt; RegM freeRegs [[NatBasicBlock instr]]
forall a. a -&gt; RegM freeRegs a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([[NatBasicBlock instr]] -&gt; RegM freeRegs [[NatBasicBlock instr]])
-&gt; [[NatBasicBlock instr]] -&gt; RegM freeRegs [[NatBasicBlock instr]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[[NatBasicBlock instr]] -&gt; [[NatBasicBlock instr]]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[[NatBasicBlock instr]]
</span><a href="#local-6989586621682851997"><span class="hs-identifier hs-var">accum</span></a></span><span>
</span><span id="line-321"></span><span>
</span><span id="line-322"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-323"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[GenBasicBlock (LiveInstr instr)]
-&gt; [GenBasicBlock (LiveInstr instr)]
-&gt; [[NatBasicBlock instr]]
-&gt; Bool
-&gt; RegM freeRegs [[NatBasicBlock instr]]
</span><a href="#local-6989586621682851993"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[GenBasicBlock (LiveInstr instr)]
</span><a href="#local-6989586621682851996"><span class="hs-identifier hs-var">next_round</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[[NatBasicBlock instr]]
</span><a href="#local-6989586621682851997"><span class="hs-identifier hs-var">accum</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-324"></span><span>
</span><span id="line-325"></span><span>    </span><span class="annot"><a href="#local-6989586621682851993"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682852000"><span class="annot"><span class="annottext">b :: GenBasicBlock (LiveInstr instr)
</span><a href="#local-6989586621682852000"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.html#BasicBlock"><span class="hs-identifier hs-type">BasicBlock</span></a></span><span> </span><span id="local-6989586621682852002"><span class="annot"><span class="annottext">BlockId
</span><a href="#local-6989586621682852002"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span class="annot"><span class="annottext">[LiveInstr instr]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682852003"><span class="annot"><span class="annottext">[GenBasicBlock (LiveInstr instr)]
</span><a href="#local-6989586621682852003"><span class="hs-identifier hs-var">blocks</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682852004"><span class="annot"><span class="annottext">[GenBasicBlock (LiveInstr instr)]
</span><a href="#local-6989586621682852004"><span class="hs-identifier hs-var">next_round</span></a></span></span><span> </span><span id="local-6989586621682852005"><span class="annot"><span class="annottext">[[NatBasicBlock instr]]
</span><a href="#local-6989586621682852005"><span class="hs-identifier hs-var">accum</span></a></span></span><span> </span><span id="local-6989586621682852006"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682852006"><span class="hs-identifier hs-var">madeProgress</span></a></span></span><span>
</span><span id="line-326"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-327"></span><span>          </span><span id="local-6989586621682852007"><span class="annot"><a href="#local-6989586621682852007"><span class="hs-identifier hs-var">block_assig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RegM freeRegs (BlockAssignment freeRegs)
forall freeRegs. RegM freeRegs (BlockAssignment freeRegs)
</span><a href="GHC.CmmToAsm.Reg.Linear.State.html#getBlockAssigR"><span class="hs-identifier hs-var">getBlockAssigR</span></a></span><span>
</span><span id="line-328"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="hs-identifier hs-type">isJust</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#lookupBlockAssignment"><span class="hs-identifier hs-type">lookupBlockAssignment</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852002"><span class="hs-identifier hs-type">id</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852007"><span class="hs-identifier hs-type">block_assig</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">||</span></span><span> </span><span class="annot"><a href="#local-6989586621682852002"><span class="hs-identifier hs-type">id</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">`elem`</span></span><span> </span><span class="annot"><a href="#local-6989586621682851990"><span class="hs-identifier hs-type">entry_ids</span></a></span><span>
</span><span id="line-329"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621682852013"><span class="annot"><a href="#local-6989586621682852013"><span class="hs-identifier hs-var">b'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#processBlock"><span class="hs-identifier hs-type">processBlock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851991"><span class="hs-identifier hs-type">block_live</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852000"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-330"></span><span>                    </span><span class="annot"><a href="#local-6989586621682851993"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852003"><span class="hs-identifier hs-type">blocks</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852004"><span class="hs-identifier hs-type">next_round</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682852013"><span class="hs-identifier hs-type">b'</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="#local-6989586621682852005"><span class="hs-identifier hs-type">accum</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">True</span></span><span>
</span><span id="line-331"></span><span>
</span><span id="line-332"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><a href="#local-6989586621682851993"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852003"><span class="hs-identifier hs-type">blocks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682852000"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="#local-6989586621682852004"><span class="hs-identifier hs-type">next_round</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682852005"><span class="hs-identifier hs-type">accum</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852006"><span class="hs-identifier hs-type">madeProgress</span></a></span><span>
</span><span id="line-333"></span><span>
</span><span id="line-334"></span><span>
</span><span id="line-335"></span><span class="hs-comment">-- | Do register allocation on this basic block</span><span>
</span><span id="line-336"></span><span class="hs-comment">--</span><span>
</span><span id="line-337"></span><span id="local-6989586621682851635"><span id="local-6989586621682851636"><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#processBlock"><span class="hs-identifier hs-type">processBlock</span></a></span><span>
</span><span id="line-338"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#OutputableRegConstraint"><span class="hs-identifier hs-type">OutputableRegConstraint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851635"><span class="hs-identifier hs-type">freeRegs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851636"><span class="hs-identifier hs-type">instr</span></a></span><span>
</span><span id="line-339"></span><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html#BlockMap"><span class="hs-identifier hs-type">BlockMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Unique.Set.html#UniqSet"><span class="hs-identifier hs-type">UniqSet</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Format.html#RegWithFormat"><span class="hs-identifier hs-type">RegWithFormat</span></a></span><span class="hs-special">)</span><span>              </span><span class="annot"><span class="hs-comment">-- ^ live regs on entry to each basic block</span></span><span>
</span><span id="line-340"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html#LiveBasicBlock"><span class="hs-identifier hs-type">LiveBasicBlock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851636"><span class="hs-identifier hs-type">instr</span></a></span><span>         </span><span class="annot"><span class="hs-comment">-- ^ block to do register allocation on</span></span><span>
</span><span id="line-341"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#RegM"><span class="hs-identifier hs-type">RegM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851635"><span class="hs-identifier hs-type">freeRegs</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CmmToAsm.Types.html#NatBasicBlock"><span class="hs-identifier hs-type">NatBasicBlock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851636"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">]</span></span></span><span>   </span><span class="annot"><span class="hs-comment">-- ^ block with registers allocated</span></span><span>
</span><span id="line-342"></span><span>
</span><span id="line-343"></span><span id="processBlock"><span class="annot"><span class="annottext">processBlock :: forall freeRegs instr.
OutputableRegConstraint freeRegs instr =&gt;
BlockMap (UniqSet RegWithFormat)
-&gt; LiveBasicBlock instr -&gt; RegM freeRegs [NatBasicBlock instr]
</span><a href="GHC.CmmToAsm.Reg.Linear.html#processBlock"><span class="hs-identifier hs-var hs-var">processBlock</span></a></span></span><span> </span><span id="local-6989586621682852021"><span class="annot"><span class="annottext">BlockMap (UniqSet RegWithFormat)
</span><a href="#local-6989586621682852021"><span class="hs-identifier hs-var">block_live</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.html#BasicBlock"><span class="hs-identifier hs-type">BasicBlock</span></a></span><span> </span><span id="local-6989586621682852022"><span class="annot"><span class="annottext">BlockId
</span><a href="#local-6989586621682852022"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span id="local-6989586621682852023"><span class="annot"><span class="annottext">[LiveInstr instr]
</span><a href="#local-6989586621682852023"><span class="hs-identifier hs-var">instrs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-344"></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>   </span><span class="hs-comment">-- pprTraceM &quot;processBlock&quot; $ text &quot;&quot; $$ ppr (BasicBlock id instrs)</span><span>
</span><span id="line-345"></span><span>        </span><span class="annot"><span class="annottext">BlockId -&gt; BlockMap (UniqSet RegWithFormat) -&gt; RegM freeRegs ()
forall freeRegs.
FR freeRegs =&gt;
BlockId -&gt; BlockMap (UniqSet RegWithFormat) -&gt; RegM freeRegs ()
</span><a href="GHC.CmmToAsm.Reg.Linear.html#initBlock"><span class="hs-identifier hs-var">initBlock</span></a></span><span> </span><span class="annot"><span class="annottext">BlockId
</span><a href="#local-6989586621682852022"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">BlockMap (UniqSet RegWithFormat)
</span><a href="#local-6989586621682852021"><span class="hs-identifier hs-var">block_live</span></a></span><span>
</span><span id="line-346"></span><span>
</span><span id="line-347"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621682852025"><span class="annot"><a href="#local-6989586621682852025"><span class="hs-identifier hs-var">instrs'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682852026"><span class="annot"><a href="#local-6989586621682852026"><span class="hs-identifier hs-var">fixups</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-348"></span><span>                </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BlockMap (UniqSet RegWithFormat)
-&gt; BlockId
-&gt; [LiveInstr instr]
-&gt; RegM freeRegs ([instr], [NatBasicBlock instr])
forall freeRegs instr.
OutputableRegConstraint freeRegs instr =&gt;
BlockMap (UniqSet RegWithFormat)
-&gt; BlockId
-&gt; [LiveInstr instr]
-&gt; RegM freeRegs ([instr], [NatBasicBlock instr])
</span><a href="GHC.CmmToAsm.Reg.Linear.html#linearRA"><span class="hs-identifier hs-var">linearRA</span></a></span><span> </span><span class="annot"><span class="annottext">BlockMap (UniqSet RegWithFormat)
</span><a href="#local-6989586621682852021"><span class="hs-identifier hs-var">block_live</span></a></span><span> </span><span class="annot"><span class="annottext">BlockId
</span><a href="#local-6989586621682852022"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">[LiveInstr instr]
</span><a href="#local-6989586621682852023"><span class="hs-identifier hs-var">instrs</span></a></span><span>
</span><span id="line-349"></span><span>        </span><span class="hs-comment">-- pprTraceM &quot;blockResult&quot; $ ppr (instrs', fixups)</span><span>
</span><span id="line-350"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span>  </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Cmm.html#BasicBlock"><span class="hs-identifier hs-type">BasicBlock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852022"><span class="hs-identifier hs-type">id</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852025"><span class="hs-identifier hs-type">instrs'</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="#local-6989586621682852026"><span class="hs-identifier hs-type">fixups</span></a></span><span>
</span><span id="line-351"></span><span>
</span><span id="line-352"></span><span>
</span><span id="line-353"></span><span class="hs-comment">-- | Load the freeregs and current reg assignment into the RegM state</span><span>
</span><span id="line-354"></span><span class="hs-comment">--      for the basic block with this BlockId.</span><span>
</span><span id="line-355"></span><span id="local-6989586621682851652"><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#initBlock"><span class="hs-identifier hs-type">initBlock</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.FreeRegs.html#FR"><span class="hs-identifier hs-type">FR</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851652"><span class="hs-identifier hs-type">freeRegs</span></a></span><span>
</span><span id="line-356"></span><span>          </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html#BlockMap"><span class="hs-identifier hs-type">BlockMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Unique.Set.html#UniqSet"><span class="hs-identifier hs-type">UniqSet</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Format.html#RegWithFormat"><span class="hs-identifier hs-type">RegWithFormat</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#RegM"><span class="hs-identifier hs-type">RegM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851652"><span class="hs-identifier hs-type">freeRegs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-357"></span><span id="initBlock"><span class="annot"><span class="annottext">initBlock :: forall freeRegs.
FR freeRegs =&gt;
BlockId -&gt; BlockMap (UniqSet RegWithFormat) -&gt; RegM freeRegs ()
</span><a href="GHC.CmmToAsm.Reg.Linear.html#initBlock"><span class="hs-identifier hs-var hs-var">initBlock</span></a></span></span><span> </span><span id="local-6989586621682852037"><span class="annot"><span class="annottext">BlockId
</span><a href="#local-6989586621682852037"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span id="local-6989586621682852038"><span class="annot"><span class="annottext">BlockMap (UniqSet RegWithFormat)
</span><a href="#local-6989586621682852038"><span class="hs-identifier hs-var">block_live</span></a></span></span><span>
</span><span id="line-358"></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>   </span><span id="local-6989586621682852039"><span class="annot"><a href="#local-6989586621682852039"><span class="hs-identifier hs-var">platform</span></a></span></span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RegM freeRegs Platform
forall a. RegM a Platform
</span><a href="GHC.CmmToAsm.Reg.Linear.State.html#getPlatform"><span class="hs-identifier hs-var">getPlatform</span></a></span><span>
</span><span id="line-359"></span><span>        </span><span id="local-6989586621682852041"><span class="annot"><a href="#local-6989586621682852041"><span class="hs-identifier hs-var">block_assig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#getBlockAssigR"><span class="hs-identifier hs-type">getBlockAssigR</span></a></span><span>
</span><span id="line-360"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#lookupBlockAssignment"><span class="hs-identifier hs-type">lookupBlockAssignment</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852037"><span class="hs-identifier hs-type">id</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852041"><span class="hs-identifier hs-type">block_assig</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-361"></span><span>                </span><span class="hs-comment">-- no prior info about this block: we must consider</span><span>
</span><span id="line-362"></span><span>                </span><span class="hs-comment">-- any fixed regs to be allocated, but we can ignore</span><span>
</span><span id="line-363"></span><span>                </span><span class="hs-comment">-- virtual regs (presumably this is part of a loop,</span><span>
</span><span id="line-364"></span><span>                </span><span class="hs-comment">-- and we'll iterate again).  The assignment begins</span><span>
</span><span id="line-365"></span><span>                </span><span class="hs-comment">-- empty.</span><span>
</span><span id="line-366"></span><span>                </span><span class="annot"><span class="annottext">Maybe (freeRegs, RegMap Loc)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-367"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-comment">-- pprTrace &quot;initFreeRegs&quot; (text $ show initFreeRegs) (return ())</span><span>
</span><span id="line-368"></span><span>                        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">BlockId
-&gt; BlockMap (UniqSet RegWithFormat)
-&gt; Maybe (UniqSet RegWithFormat)
forall a. BlockId -&gt; LabelMap a -&gt; Maybe a
</span><a href="GHC.Cmm.Dataflow.Label.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a></span><span> </span><span class="annot"><span class="annottext">BlockId
</span><a href="#local-6989586621682852037"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">BlockMap (UniqSet RegWithFormat)
</span><a href="#local-6989586621682852038"><span class="hs-identifier hs-var">block_live</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-369"></span><span>                          </span><span class="annot"><span class="annottext">Maybe (UniqSet RegWithFormat)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-370"></span><span>                            </span><span class="annot"><span class="annottext">freeRegs -&gt; RegM freeRegs ()
forall freeRegs. freeRegs -&gt; RegM freeRegs ()
</span><a href="GHC.CmmToAsm.Reg.Linear.State.html#setFreeRegsR"><span class="hs-identifier hs-var">setFreeRegsR</span></a></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Platform -&gt; freeRegs
forall freeRegs. FR freeRegs =&gt; Platform -&gt; freeRegs
</span><a href="GHC.CmmToAsm.Reg.Linear.FreeRegs.html#frInitFreeRegs"><span class="hs-identifier hs-var">frInitFreeRegs</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682852039"><span class="hs-identifier hs-var">platform</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-371"></span><span>                          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682852044"><span class="annot"><span class="annottext">UniqSet RegWithFormat
</span><a href="#local-6989586621682852044"><span class="hs-identifier hs-var">live</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-372"></span><span>                            </span><span class="annot"><span class="annottext">freeRegs -&gt; RegM freeRegs ()
forall freeRegs. freeRegs -&gt; RegM freeRegs ()
</span><a href="GHC.CmmToAsm.Reg.Linear.State.html#setFreeRegsR"><span class="hs-identifier hs-var">setFreeRegsR</span></a></span><span> </span><span class="annot"><span class="annottext">(freeRegs -&gt; RegM freeRegs ()) -&gt; freeRegs -&gt; RegM freeRegs ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(freeRegs -&gt; RealReg -&gt; freeRegs)
-&gt; freeRegs -&gt; [RealReg] -&gt; freeRegs
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(RealReg -&gt; freeRegs -&gt; freeRegs)
-&gt; freeRegs -&gt; RealReg -&gt; freeRegs
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">((RealReg -&gt; freeRegs -&gt; freeRegs)
 -&gt; freeRegs -&gt; RealReg -&gt; freeRegs)
-&gt; (RealReg -&gt; freeRegs -&gt; freeRegs)
-&gt; freeRegs
-&gt; RealReg
-&gt; freeRegs
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Platform -&gt; RealReg -&gt; freeRegs -&gt; freeRegs
forall freeRegs.
FR freeRegs =&gt;
Platform -&gt; RealReg -&gt; freeRegs -&gt; freeRegs
</span><a href="GHC.CmmToAsm.Reg.Linear.FreeRegs.html#frAllocateReg"><span class="hs-identifier hs-var">frAllocateReg</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682852039"><span class="hs-identifier hs-var">platform</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Platform -&gt; freeRegs
forall freeRegs. FR freeRegs =&gt; Platform -&gt; freeRegs
</span><a href="GHC.CmmToAsm.Reg.Linear.FreeRegs.html#frInitFreeRegs"><span class="hs-identifier hs-var">frInitFreeRegs</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682852039"><span class="hs-identifier hs-var">platform</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-373"></span><span>                                                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UniqSet RealReg -&gt; [RealReg]
forall elt. UniqSet elt -&gt; [elt]
</span><a href="GHC.Types.Unique.Set.html#nonDetEltsUniqSet"><span class="hs-identifier hs-var">nonDetEltsUniqSet</span></a></span><span> </span><span class="annot"><span class="annottext">(UniqSet RealReg -&gt; [RealReg]) -&gt; UniqSet RealReg -&gt; [RealReg]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UniqSet RegWithFormat -&gt; UniqSet RealReg
</span><a href="GHC.CmmToAsm.Format.html#takeRealRegs"><span class="hs-identifier hs-var">takeRealRegs</span></a></span><span> </span><span class="annot"><span class="annottext">UniqSet RegWithFormat
</span><a href="#local-6989586621682852044"><span class="hs-identifier hs-var">live</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-374"></span><span>                            </span><span class="hs-comment">-- See Note [Unique Determinism and code generation]</span><span>
</span><span id="line-375"></span><span>                        </span><span class="annot"><span class="annottext">RegMap Loc -&gt; RegM freeRegs ()
forall freeRegs. RegMap Loc -&gt; RegM freeRegs ()
</span><a href="GHC.CmmToAsm.Reg.Linear.State.html#setAssigR"><span class="hs-identifier hs-var">setAssigR</span></a></span><span>       </span><span class="annot"><span class="annottext">RegMap Loc
forall a. RegMap a
</span><a href="GHC.CmmToAsm.Reg.Liveness.html#emptyRegMap"><span class="hs-identifier hs-var">emptyRegMap</span></a></span><span>
</span><span id="line-376"></span><span>
</span><span id="line-377"></span><span>                </span><span class="hs-comment">-- load info about register assignments leading into this block.</span><span>
</span><span id="line-378"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682852051"><span class="annot"><span class="annottext">freeRegs
</span><a href="#local-6989586621682852051"><span class="hs-identifier hs-var">freeregs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682852052"><span class="annot"><span class="annottext">RegMap Loc
</span><a href="#local-6989586621682852052"><span class="hs-identifier hs-var">assig</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-379"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="annot"><span class="annottext">freeRegs -&gt; RegM freeRegs ()
forall freeRegs. freeRegs -&gt; RegM freeRegs ()
</span><a href="GHC.CmmToAsm.Reg.Linear.State.html#setFreeRegsR"><span class="hs-identifier hs-var">setFreeRegsR</span></a></span><span>    </span><span class="annot"><span class="annottext">freeRegs
</span><a href="#local-6989586621682852051"><span class="hs-identifier hs-var">freeregs</span></a></span><span>
</span><span id="line-380"></span><span>                        </span><span class="annot"><span class="annottext">RegMap Loc -&gt; RegM freeRegs ()
forall freeRegs. RegMap Loc -&gt; RegM freeRegs ()
</span><a href="GHC.CmmToAsm.Reg.Linear.State.html#setAssigR"><span class="hs-identifier hs-var">setAssigR</span></a></span><span>       </span><span class="annot"><span class="annottext">RegMap Loc
</span><a href="#local-6989586621682852052"><span class="hs-identifier hs-var">assig</span></a></span><span>
</span><span id="line-381"></span><span>
</span><span id="line-382"></span><span>
</span><span id="line-383"></span><span class="annot"><span class="hs-comment">-- | Do allocation for a sequence of instructions.</span></span><span>
</span><span id="line-384"></span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#linearRA"><span class="hs-identifier hs-type">linearRA</span></a></span><span>
</span><span id="line-385"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621682851653"><span class="annot"><a href="#local-6989586621682851653"><span class="hs-identifier hs-type">freeRegs</span></a></span></span><span> </span><span id="local-6989586621682851654"><span class="annot"><a href="#local-6989586621682851654"><span class="hs-identifier hs-type">instr</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#OutputableRegConstraint"><span class="hs-identifier hs-type">OutputableRegConstraint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851653"><span class="hs-identifier hs-type">freeRegs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851654"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-386"></span><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html#BlockMap"><span class="hs-identifier hs-type">BlockMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Unique.Set.html#UniqSet"><span class="hs-identifier hs-type">UniqSet</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Format.html#RegWithFormat"><span class="hs-identifier hs-type">RegWithFormat</span></a></span><span class="hs-special">)</span><span>                      </span><span class="annot"><span class="hs-comment">-- ^ map of what vregs are live on entry to each block.</span></span><span>
</span><span id="line-387"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span>                              </span><span class="annot"><span class="hs-comment">-- ^ id of the current block, for debugging.</span></span><span>
</span><span id="line-388"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html#LiveInstr"><span class="hs-identifier hs-type">LiveInstr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851654"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">]</span><span>                    </span><span class="annot"><span class="hs-comment">-- ^ liveness annotated instructions in this block.</span></span><span>
</span><span id="line-389"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#RegM"><span class="hs-identifier hs-type">RegM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851653"><span class="hs-identifier hs-type">freeRegs</span></a></span><span>
</span><span id="line-390"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621682851654"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">]</span><span>                       </span><span class="hs-comment">--   instructions after register allocation</span><span>
</span><span id="line-391"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CmmToAsm.Types.html#NatBasicBlock"><span class="hs-identifier hs-type">NatBasicBlock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851654"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>        </span><span class="hs-comment">--   fresh blocks of fixup code.</span><span>
</span><span id="line-392"></span><span id="linearRA"><span class="annot"><span class="annottext">linearRA :: forall freeRegs instr.
OutputableRegConstraint freeRegs instr =&gt;
BlockMap (UniqSet RegWithFormat)
-&gt; BlockId
-&gt; [LiveInstr instr]
-&gt; RegM freeRegs ([instr], [NatBasicBlock instr])
</span><a href="GHC.CmmToAsm.Reg.Linear.html#linearRA"><span class="hs-identifier hs-var hs-var">linearRA</span></a></span></span><span> </span><span id="local-6989586621682852057"><span class="annot"><span class="annottext">BlockMap (UniqSet RegWithFormat)
</span><a href="#local-6989586621682852057"><span class="hs-identifier hs-var">block_live</span></a></span></span><span> </span><span id="local-6989586621682852058"><span class="annot"><span class="annottext">BlockId
</span><a href="#local-6989586621682852058"><span class="hs-identifier hs-var">block_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[instr]
-&gt; [NatBasicBlock instr]
-&gt; [LiveInstr instr]
-&gt; RegM freeRegs ([instr], [NatBasicBlock instr])
</span><a href="#local-6989586621682852059"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-393"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-394"></span><span>    </span><span class="annot"><a href="#local-6989586621682852059"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621682851654"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">]</span><span>                              </span><span class="hs-comment">-- accumulator for instructions already processed.</span><span>
</span><span id="line-395"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CmmToAsm.Types.html#NatBasicBlock"><span class="hs-identifier hs-type">NatBasicBlock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851654"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">]</span><span>                </span><span class="hs-comment">-- accumulator for blocks of fixup code.</span><span>
</span><span id="line-396"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html#LiveInstr"><span class="hs-identifier hs-type">LiveInstr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851654"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">]</span><span>                    </span><span class="hs-comment">-- liveness annotated instructions in this block.</span><span>
</span><span id="line-397"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#RegM"><span class="hs-identifier hs-type">RegM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851653"><span class="hs-identifier hs-type">freeRegs</span></a></span><span>
</span><span id="line-398"></span><span>               </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621682851654"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">]</span><span>                       </span><span class="hs-comment">--   instructions after register allocation</span><span>
</span><span id="line-399"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CmmToAsm.Types.html#NatBasicBlock"><span class="hs-identifier hs-type">NatBasicBlock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851654"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">)</span><span>       </span><span class="hs-comment">--   fresh blocks of fixup code.</span><span>
</span><span id="line-400"></span><span>    </span><span id="local-6989586621682852059"><span class="annot"><span class="annottext">go :: [instr]
-&gt; [NatBasicBlock instr]
-&gt; [LiveInstr instr]
-&gt; RegM freeRegs ([instr], [NatBasicBlock instr])
</span><a href="#local-6989586621682852059"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682852060"><span class="annot"><span class="annottext">[instr]
</span><a href="#local-6989586621682852060"><span class="hs-identifier hs-var">accInstr</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682852061"><span class="annot"><span class="annottext">[NatBasicBlock instr]
</span><a href="#local-6989586621682852061"><span class="hs-identifier hs-var">accFixups</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-401"></span><span>        </span><span class="annot"><span class="annottext">([instr], [NatBasicBlock instr])
-&gt; RegM freeRegs ([instr], [NatBasicBlock instr])
forall a. a -&gt; RegM freeRegs a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[instr] -&gt; [instr]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[instr]
</span><a href="#local-6989586621682852060"><span class="hs-identifier hs-var">accInstr</span></a></span><span>               </span><span class="hs-comment">-- instrs need to be returned in the correct order.</span><span>
</span><span id="line-402"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[NatBasicBlock instr]
</span><a href="#local-6989586621682852061"><span class="hs-identifier hs-var">accFixups</span></a></span><span> </span><span class="hs-special">)</span><span>                    </span><span class="hs-comment">-- it doesn't matter what order the fixup blocks are returned in.</span><span>
</span><span id="line-403"></span><span>
</span><span id="line-404"></span><span>    </span><span class="annot"><a href="#local-6989586621682852059"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682852062"><span class="annot"><span class="annottext">[instr]
</span><a href="#local-6989586621682852062"><span class="hs-identifier hs-var">accInstr</span></a></span></span><span> </span><span id="local-6989586621682852063"><span class="annot"><span class="annottext">[NatBasicBlock instr]
</span><a href="#local-6989586621682852063"><span class="hs-identifier hs-var">accFixups</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682852064"><span class="annot"><span class="annottext">LiveInstr instr
</span><a href="#local-6989586621682852064"><span class="hs-identifier hs-var">instr</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682852065"><span class="annot"><span class="annottext">[LiveInstr instr]
</span><a href="#local-6989586621682852065"><span class="hs-identifier hs-var">instrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-405"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621682852066"><span class="annot"><a href="#local-6989586621682852066"><span class="hs-identifier hs-var">accInstr'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682852067"><span class="annot"><a href="#local-6989586621682852067"><span class="hs-identifier hs-var">new_fixups</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BlockMap (UniqSet RegWithFormat)
-&gt; [instr]
-&gt; BlockId
-&gt; LiveInstr instr
-&gt; RegM freeRegs ([instr], [NatBasicBlock instr])
forall freeRegs instr.
OutputableRegConstraint freeRegs instr =&gt;
BlockMap (UniqSet RegWithFormat)
-&gt; [instr]
-&gt; BlockId
-&gt; LiveInstr instr
-&gt; RegM freeRegs ([instr], [NatBasicBlock instr])
</span><a href="GHC.CmmToAsm.Reg.Linear.html#raInsn"><span class="hs-identifier hs-var">raInsn</span></a></span><span> </span><span class="annot"><span class="annottext">BlockMap (UniqSet RegWithFormat)
</span><a href="#local-6989586621682852057"><span class="hs-identifier hs-var">block_live</span></a></span><span> </span><span class="annot"><span class="annottext">[instr]
</span><a href="#local-6989586621682852062"><span class="hs-identifier hs-var">accInstr</span></a></span><span> </span><span class="annot"><span class="annottext">BlockId
</span><a href="#local-6989586621682852058"><span class="hs-identifier hs-var">block_id</span></a></span><span> </span><span class="annot"><span class="annottext">LiveInstr instr
</span><a href="#local-6989586621682852064"><span class="hs-identifier hs-var">instr</span></a></span><span>
</span><span id="line-406"></span><span>        </span><span class="annot"><a href="#local-6989586621682852059"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852066"><span class="hs-identifier hs-type">accInstr'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682852067"><span class="hs-identifier hs-type">new_fixups</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621682852063"><span class="hs-identifier hs-type">accFixups</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682852065"><span class="hs-identifier hs-type">instrs</span></a></span><span>
</span><span id="line-407"></span><span>
</span><span id="line-408"></span><span class="annot"><span class="hs-comment">-- | Do allocation for a single instruction.</span></span><span>
</span><span id="line-409"></span><span id="local-6989586621682851671"><span id="local-6989586621682851672"><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#raInsn"><span class="hs-identifier hs-type">raInsn</span></a></span><span>
</span><span id="line-410"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#OutputableRegConstraint"><span class="hs-identifier hs-type">OutputableRegConstraint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851671"><span class="hs-identifier hs-type">freeRegs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851672"><span class="hs-identifier hs-type">instr</span></a></span><span>
</span><span id="line-411"></span><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html#BlockMap"><span class="hs-identifier hs-type">BlockMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Unique.Set.html#UniqSet"><span class="hs-identifier hs-type">UniqSet</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Format.html#RegWithFormat"><span class="hs-identifier hs-type">RegWithFormat</span></a></span><span class="hs-special">)</span><span>                      </span><span class="annot"><span class="hs-comment">-- ^ map of what vregs are love on entry to each block.</span></span><span>
</span><span id="line-412"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621682851672"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">]</span><span>                              </span><span class="annot"><span class="hs-comment">-- ^ accumulator for instructions already processed.</span></span><span>
</span><span id="line-413"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span>                              </span><span class="annot"><span class="hs-comment">-- ^ the id of the current block, for debugging</span></span><span>
</span><span id="line-414"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html#LiveInstr"><span class="hs-identifier hs-type">LiveInstr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851672"><span class="hs-identifier hs-type">instr</span></a></span><span>                      </span><span class="annot"><span class="hs-comment">-- ^ the instr to have its regs allocated, with liveness info.</span></span><span>
</span><span id="line-415"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#RegM"><span class="hs-identifier hs-type">RegM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851671"><span class="hs-identifier hs-type">freeRegs</span></a></span><span>
</span><span id="line-416"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621682851672"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">]</span><span>                       </span><span class="hs-comment">-- new instructions</span><span>
</span><span id="line-417"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CmmToAsm.Types.html#NatBasicBlock"><span class="hs-identifier hs-type">NatBasicBlock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851672"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span></span></span><span>        </span><span class="hs-comment">-- extra fixup blocks</span><span>
</span><span id="line-418"></span><span>
</span><span id="line-419"></span><span id="raInsn"><span class="annot"><span class="annottext">raInsn :: forall freeRegs instr.
OutputableRegConstraint freeRegs instr =&gt;
BlockMap (UniqSet RegWithFormat)
-&gt; [instr]
-&gt; BlockId
-&gt; LiveInstr instr
-&gt; RegM freeRegs ([instr], [NatBasicBlock instr])
</span><a href="GHC.CmmToAsm.Reg.Linear.html#raInsn"><span class="hs-identifier hs-var hs-var">raInsn</span></a></span></span><span> </span><span class="annot"><span class="annottext">BlockMap (UniqSet RegWithFormat)
</span><span class="hs-identifier">_</span></span><span>     </span><span id="local-6989586621682852104"><span class="annot"><span class="annottext">[instr]
</span><a href="#local-6989586621682852104"><span class="hs-identifier hs-var">new_instrs</span></a></span></span><span> </span><span class="annot"><span class="annottext">BlockId
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html#LiveInstr"><span class="hs-identifier hs-type">LiveInstr</span></a></span><span> </span><span id="local-6989586621682852106"><span class="annot"><span class="annottext">InstrSR instr
</span><a href="#local-6989586621682852106"><span class="hs-identifier hs-var">ii</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe Liveness
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-420"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682852107"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682852107"><span class="hs-identifier hs-var">n</span></a></span></span><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InstrSR instr -&gt; Maybe Int
forall instr. Instruction instr =&gt; instr -&gt; Maybe Int
</span><a href="GHC.CmmToAsm.Instr.html#takeDeltaInstr"><span class="hs-identifier hs-var">takeDeltaInstr</span></a></span><span> </span><span class="annot"><span class="annottext">InstrSR instr
</span><a href="#local-6989586621682852106"><span class="hs-identifier hs-var">ii</span></a></span><span>
</span><span id="line-421"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>    </span><span class="annot"><span class="annottext">Int -&gt; RegM freeRegs ()
forall freeRegs. Int -&gt; RegM freeRegs ()
</span><a href="GHC.CmmToAsm.Reg.Linear.State.html#setDeltaR"><span class="hs-identifier hs-var">setDeltaR</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682852107"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-422"></span><span>                </span><span class="annot"><span class="annottext">([instr], [NatBasicBlock instr])
-&gt; RegM freeRegs ([instr], [NatBasicBlock instr])
forall a. a -&gt; RegM freeRegs a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[instr]
</span><a href="#local-6989586621682852104"><span class="hs-identifier hs-var">new_instrs</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-423"></span><span>
</span><span id="line-424"></span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#raInsn"><span class="hs-identifier hs-var">raInsn</span></a></span><span> </span><span class="annot"><span class="annottext">BlockMap (UniqSet RegWithFormat)
</span><span class="hs-identifier">_</span></span><span>     </span><span id="local-6989586621682852110"><span class="annot"><span class="annottext">[instr]
</span><a href="#local-6989586621682852110"><span class="hs-identifier hs-var">new_instrs</span></a></span></span><span> </span><span class="annot"><span class="annottext">BlockId
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html#LiveInstr"><span class="hs-identifier hs-type">LiveInstr</span></a></span><span> </span><span id="local-6989586621682852111"><span class="annot"><span class="annottext">ii :: InstrSR instr
</span><a href="#local-6989586621682852111"><span class="hs-identifier hs-var">ii</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html#Instr"><span class="hs-identifier hs-type">Instr</span></a></span><span> </span><span id="local-6989586621682852113"><span class="annot"><span class="annottext">instr
</span><a href="#local-6989586621682852113"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Liveness
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-425"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">InstrSR instr -&gt; Bool
forall instr. Instruction instr =&gt; instr -&gt; Bool
</span><a href="GHC.CmmToAsm.Instr.html#isMetaInstr"><span class="hs-identifier hs-var">isMetaInstr</span></a></span><span> </span><span class="annot"><span class="annottext">InstrSR instr
</span><a href="#local-6989586621682852111"><span class="hs-identifier hs-var">ii</span></a></span><span>
</span><span id="line-426"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([instr], [NatBasicBlock instr])
-&gt; RegM freeRegs ([instr], [NatBasicBlock instr])
forall a. a -&gt; RegM freeRegs a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">instr
</span><a href="#local-6989586621682852113"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">instr -&gt; [instr] -&gt; [instr]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[instr]
</span><a href="#local-6989586621682852110"><span class="hs-identifier hs-var">new_instrs</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-427"></span><span>
</span><span id="line-428"></span><span>
</span><span id="line-429"></span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#raInsn"><span class="hs-identifier hs-var">raInsn</span></a></span><span> </span><span id="local-6989586621682852115"><span class="annot"><span class="annottext">BlockMap (UniqSet RegWithFormat)
</span><a href="#local-6989586621682852115"><span class="hs-identifier hs-var">block_live</span></a></span></span><span> </span><span id="local-6989586621682852116"><span class="annot"><span class="annottext">[instr]
</span><a href="#local-6989586621682852116"><span class="hs-identifier hs-var">new_instrs</span></a></span></span><span> </span><span id="local-6989586621682852117"><span class="annot"><span class="annottext">BlockId
</span><a href="#local-6989586621682852117"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html#LiveInstr"><span class="hs-identifier hs-type">LiveInstr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html#Instr"><span class="hs-identifier hs-type">Instr</span></a></span><span> </span><span id="local-6989586621682852118"><span class="annot"><span class="annottext">instr
</span><a href="#local-6989586621682852118"><span class="hs-identifier hs-var">instr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682852119"><span class="annot"><span class="annottext">Liveness
</span><a href="#local-6989586621682852119"><span class="hs-identifier hs-var">live</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-430"></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-431"></span><span>    </span><span id="local-6989586621682852120"><span class="annot"><a href="#local-6989586621682852120"><span class="hs-identifier hs-var">platform</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RegM freeRegs Platform
forall a. RegM a Platform
</span><a href="GHC.CmmToAsm.Reg.Linear.State.html#getPlatform"><span class="hs-identifier hs-var">getPlatform</span></a></span><span>
</span><span id="line-432"></span><span>    </span><span id="local-6989586621682852121"><span id="local-6989586621682852122"><span class="annot"><a href="#local-6989586621682852122"><span class="hs-identifier hs-var">assig</span></a></span></span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#getAssigR"><span class="hs-identifier hs-type">getAssigR</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#RegM"><span class="hs-identifier hs-type">RegM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852121"><span class="hs-identifier hs-type">freeRegs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Unique.FM.html#UniqFM"><span class="hs-identifier hs-type">UniqFM</span></a></span><span> </span><span class="annot"><a href="GHC.Platform.Reg.html#Reg"><span class="hs-identifier hs-type">Reg</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#Loc"><span class="hs-identifier hs-type">Loc</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-433"></span><span>
</span><span id="line-434"></span><span>    </span><span class="hs-comment">-- If we have a reg-&gt;reg move between virtual registers, where the</span><span>
</span><span id="line-435"></span><span>    </span><span class="hs-comment">-- src register is not live after this instruction, and the dst</span><span>
</span><span id="line-436"></span><span>    </span><span class="hs-comment">-- register does not already have an assignment,</span><span>
</span><span id="line-437"></span><span>    </span><span class="hs-comment">-- and the source register is assigned to a register, not to a spill slot,</span><span>
</span><span id="line-438"></span><span>    </span><span class="hs-comment">-- then we can eliminate the instruction.</span><span>
</span><span id="line-439"></span><span>    </span><span class="hs-comment">-- (we can't eliminate it if the source register is on the stack, because</span><span>
</span><span id="line-440"></span><span>    </span><span class="hs-comment">--  we do not want to use one spill slot for different virtual registers)</span><span>
</span><span id="line-441"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Instr.html#takeRegRegMoveInstr"><span class="hs-identifier hs-type">takeRegRegMoveInstr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852120"><span class="hs-identifier hs-type">platform</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852118"><span class="hs-identifier hs-type">instr</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-442"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682852125"><span class="annot"><span class="annottext">Reg
</span><a href="#local-6989586621682852125"><span class="hs-identifier hs-var">src</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682852126"><span class="annot"><span class="annottext">Reg
</span><a href="#local-6989586621682852126"><span class="hs-identifier hs-var">dst</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Format.html#RegWithFormat"><span class="hs-identifier hs-type">RegWithFormat</span></a></span><span> </span><span class="annot"><span class="annottext">Reg
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682852128"><span class="annot"><span class="annottext">Format
</span><a href="#local-6989586621682852128"><span class="hs-identifier hs-var">fmt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UniqSet RegWithFormat -&gt; Unique -&gt; Maybe RegWithFormat
forall a. UniqSet a -&gt; Unique -&gt; Maybe a
</span><a href="GHC.Types.Unique.Set.html#lookupUniqSet_Directly"><span class="hs-identifier hs-var">lookupUniqSet_Directly</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Liveness -&gt; UniqSet RegWithFormat
</span><a href="GHC.CmmToAsm.Reg.Liveness.html#liveDieRead"><span class="hs-identifier hs-var">liveDieRead</span></a></span><span> </span><span class="annot"><span class="annottext">Liveness
</span><a href="#local-6989586621682852119"><span class="hs-identifier hs-var">live</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reg -&gt; Unique
forall a. Uniquable a =&gt; a -&gt; Unique
</span><a href="GHC.Types.Unique.html#getUnique"><span class="hs-identifier hs-var">getUnique</span></a></span><span> </span><span class="annot"><span class="annottext">Reg
</span><a href="#local-6989586621682852125"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-443"></span><span>                          </span><span class="annot"><span class="annottext">Reg -&gt; Bool
</span><a href="GHC.Platform.Reg.html#isVirtualReg"><span class="hs-identifier hs-var">isVirtualReg</span></a></span><span> </span><span class="annot"><span class="annottext">Reg
</span><a href="#local-6989586621682852126"><span class="hs-identifier hs-var">dst</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-444"></span><span>                          </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reg
</span><a href="#local-6989586621682852126"><span class="hs-identifier hs-var">dst</span></a></span><span> </span><span class="annot"><span class="annottext">Reg -&gt; RegMap Loc -&gt; Bool
forall key elt. Uniquable key =&gt; key -&gt; UniqFM key elt -&gt; Bool
</span><a href="GHC.Types.Unique.FM.html#elemUFM"><span class="hs-operator hs-var">`elemUFM`</span></a></span><span> </span><span class="annot"><span class="annottext">RegMap Loc
</span><a href="#local-6989586621682852122"><span class="hs-identifier hs-var">assig</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-445"></span><span>                          </span><span class="annot"><span class="annottext">Reg -&gt; Bool
</span><a href="GHC.Platform.Reg.html#isRealReg"><span class="hs-identifier hs-var">isRealReg</span></a></span><span> </span><span class="annot"><span class="annottext">Reg
</span><a href="#local-6989586621682852125"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Reg -&gt; RegMap Loc -&gt; Bool
</span><a href="GHC.CmmToAsm.Reg.Linear.html#isInReg"><span class="hs-identifier hs-var">isInReg</span></a></span><span> </span><span class="annot"><span class="annottext">Reg
</span><a href="#local-6989586621682852125"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">RegMap Loc
</span><a href="#local-6989586621682852122"><span class="hs-identifier hs-var">assig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-446"></span><span>           </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Reg
</span><a href="#local-6989586621682852125"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-447"></span><span>              </span><span class="annot"><a href="GHC.Platform.Reg.html#RegReal"><span class="hs-identifier hs-type">RegReal</span></a></span><span> </span><span id="local-6989586621682852137"><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852137"><span class="hs-identifier hs-var">rr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RegMap Loc -&gt; RegM freeRegs ()
forall freeRegs. RegMap Loc -&gt; RegM freeRegs ()
</span><a href="GHC.CmmToAsm.Reg.Linear.State.html#setAssigR"><span class="hs-identifier hs-var">setAssigR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RegMap Loc -&gt; Reg -&gt; Loc -&gt; RegMap Loc
forall key elt.
Uniquable key =&gt;
UniqFM key elt -&gt; key -&gt; elt -&gt; UniqFM key elt
</span><a href="GHC.Types.Unique.FM.html#addToUFM"><span class="hs-identifier hs-var">addToUFM</span></a></span><span> </span><span class="annot"><span class="annottext">RegMap Loc
</span><a href="#local-6989586621682852122"><span class="hs-identifier hs-var">assig</span></a></span><span> </span><span class="annot"><span class="annottext">Reg
</span><a href="#local-6989586621682852126"><span class="hs-identifier hs-var">dst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealRegUsage -&gt; Loc
</span><a href="GHC.CmmToAsm.Reg.Linear.Base.html#InReg"><span class="hs-identifier hs-var">InReg</span></a></span><span> </span><span class="annot"><span class="annottext">(RealRegUsage -&gt; Loc) -&gt; RealRegUsage -&gt; Loc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RealReg -&gt; Format -&gt; RealRegUsage
</span><a href="GHC.CmmToAsm.Reg.Linear.Base.html#RealRegUsage"><span class="hs-identifier hs-var">RealRegUsage</span></a></span><span> </span><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852137"><span class="hs-identifier hs-var">rr</span></a></span><span> </span><span class="annot"><span class="annottext">Format
</span><a href="#local-6989586621682852128"><span class="hs-identifier hs-var">fmt</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-448"></span><span>                </span><span class="hs-comment">-- if src is a fixed reg, then we just map dest to this</span><span>
</span><span id="line-449"></span><span>                </span><span class="hs-comment">-- reg in the assignment.  src must be an allocatable reg,</span><span>
</span><span id="line-450"></span><span>                </span><span class="hs-comment">-- otherwise it wouldn't be in r_dying.</span><span>
</span><span id="line-451"></span><span>              </span><span id="local-6989586621682852141"><span class="annot"><span class="annottext">Reg
</span><a href="#local-6989586621682852141"><span class="hs-identifier hs-var">_virt</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">RegMap Loc -&gt; Reg -&gt; Maybe Loc
forall key elt. Uniquable key =&gt; UniqFM key elt -&gt; key -&gt; Maybe elt
</span><a href="GHC.Types.Unique.FM.html#lookupUFM"><span class="hs-identifier hs-var">lookupUFM</span></a></span><span> </span><span class="annot"><span class="annottext">RegMap Loc
</span><a href="#local-6989586621682852122"><span class="hs-identifier hs-var">assig</span></a></span><span> </span><span class="annot"><span class="annottext">Reg
</span><a href="#local-6989586621682852125"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-452"></span><span>                         </span><span class="annot"><span class="annottext">Maybe Loc
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; RegM freeRegs ()
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;raInsn&quot;</span></span><span>
</span><span id="line-453"></span><span>                         </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682852143"><span class="annot"><span class="annottext">Loc
</span><a href="#local-6989586621682852143"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-454"></span><span>                           </span><span class="annot"><span class="annottext">RegMap Loc -&gt; RegM freeRegs ()
forall freeRegs. RegMap Loc -&gt; RegM freeRegs ()
</span><a href="GHC.CmmToAsm.Reg.Linear.State.html#setAssigR"><span class="hs-identifier hs-var">setAssigR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RegMap Loc -&gt; Reg -&gt; Loc -&gt; RegMap Loc
forall key elt.
Uniquable key =&gt;
UniqFM key elt -&gt; key -&gt; elt -&gt; UniqFM key elt
</span><a href="GHC.Types.Unique.FM.html#addToUFM"><span class="hs-identifier hs-var">addToUFM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RegMap Loc -&gt; Reg -&gt; RegMap Loc
forall key elt.
Uniquable key =&gt;
UniqFM key elt -&gt; key -&gt; UniqFM key elt
</span><a href="GHC.Types.Unique.FM.html#delFromUFM"><span class="hs-identifier hs-var">delFromUFM</span></a></span><span> </span><span class="annot"><span class="annottext">RegMap Loc
</span><a href="#local-6989586621682852122"><span class="hs-identifier hs-var">assig</span></a></span><span> </span><span class="annot"><span class="annottext">Reg
</span><a href="#local-6989586621682852125"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Reg
</span><a href="#local-6989586621682852126"><span class="hs-identifier hs-var">dst</span></a></span><span> </span><span class="annot"><span class="annottext">Loc
</span><a href="#local-6989586621682852143"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-455"></span><span>
</span><span id="line-456"></span><span>           </span><span class="hs-comment">-- we have eliminated this instruction</span><span>
</span><span id="line-457"></span><span>          </span><span class="hs-comment">{-
          freeregs &lt;- getFreeRegsR
          assig &lt;- getAssigR
          pprTrace &quot;raInsn&quot; (text &quot;ELIMINATED: &quot; &lt;&gt; docToSDoc (pprInstr instr)
                        $$ ppr r_dying &lt;+&gt; ppr w_dying $$ text (show freeregs) $$ ppr assig) $ do
          -}</span><span>
</span><span id="line-463"></span><span>           </span><span class="annot"><span class="annottext">([instr], [NatBasicBlock instr])
-&gt; RegM freeRegs ([instr], [NatBasicBlock instr])
forall a. a -&gt; RegM freeRegs a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[instr]
</span><a href="#local-6989586621682852116"><span class="hs-identifier hs-var">new_instrs</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-464"></span><span>
</span><span id="line-465"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Reg, Reg)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">BlockMap (UniqSet RegWithFormat)
-&gt; [instr]
-&gt; BlockId
-&gt; instr
-&gt; [Reg]
-&gt; [Reg]
-&gt; RegM freeRegs ([instr], [NatBasicBlock instr])
forall freeRegs instr.
OutputableRegConstraint freeRegs instr =&gt;
BlockMap (UniqSet RegWithFormat)
-&gt; [instr]
-&gt; BlockId
-&gt; instr
-&gt; [Reg]
-&gt; [Reg]
-&gt; RegM freeRegs ([instr], [NatBasicBlock instr])
</span><a href="GHC.CmmToAsm.Reg.Linear.html#genRaInsn"><span class="hs-identifier hs-var">genRaInsn</span></a></span><span> </span><span class="annot"><span class="annottext">BlockMap (UniqSet RegWithFormat)
</span><a href="#local-6989586621682852115"><span class="hs-identifier hs-var">block_live</span></a></span><span> </span><span class="annot"><span class="annottext">[instr]
</span><a href="#local-6989586621682852116"><span class="hs-identifier hs-var">new_instrs</span></a></span><span> </span><span class="annot"><span class="annottext">BlockId
</span><a href="#local-6989586621682852117"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">instr
</span><a href="#local-6989586621682852118"><span class="hs-identifier hs-var">instr</span></a></span><span>
</span><span id="line-466"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(RegWithFormat -&gt; Reg) -&gt; [RegWithFormat] -&gt; [Reg]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">RegWithFormat -&gt; Reg
</span><a href="GHC.CmmToAsm.Format.html#regWithFormat_reg"><span class="hs-identifier hs-var">regWithFormat_reg</span></a></span><span> </span><span class="annot"><span class="annottext">([RegWithFormat] -&gt; [Reg]) -&gt; [RegWithFormat] -&gt; [Reg]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UniqSet RegWithFormat -&gt; [RegWithFormat]
forall elt. UniqSet elt -&gt; [elt]
</span><a href="GHC.Types.Unique.Set.html#nonDetEltsUniqSet"><span class="hs-identifier hs-var">nonDetEltsUniqSet</span></a></span><span> </span><span class="annot"><span class="annottext">(UniqSet RegWithFormat -&gt; [RegWithFormat])
-&gt; UniqSet RegWithFormat -&gt; [RegWithFormat]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Liveness -&gt; UniqSet RegWithFormat
</span><a href="GHC.CmmToAsm.Reg.Liveness.html#liveDieRead"><span class="hs-identifier hs-var">liveDieRead</span></a></span><span> </span><span class="annot"><span class="annottext">Liveness
</span><a href="#local-6989586621682852119"><span class="hs-identifier hs-var">live</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-467"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(RegWithFormat -&gt; Reg) -&gt; [RegWithFormat] -&gt; [Reg]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">RegWithFormat -&gt; Reg
</span><a href="GHC.CmmToAsm.Format.html#regWithFormat_reg"><span class="hs-identifier hs-var">regWithFormat_reg</span></a></span><span> </span><span class="annot"><span class="annottext">([RegWithFormat] -&gt; [Reg]) -&gt; [RegWithFormat] -&gt; [Reg]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UniqSet RegWithFormat -&gt; [RegWithFormat]
forall elt. UniqSet elt -&gt; [elt]
</span><a href="GHC.Types.Unique.Set.html#nonDetEltsUniqSet"><span class="hs-identifier hs-var">nonDetEltsUniqSet</span></a></span><span> </span><span class="annot"><span class="annottext">(UniqSet RegWithFormat -&gt; [RegWithFormat])
-&gt; UniqSet RegWithFormat -&gt; [RegWithFormat]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Liveness -&gt; UniqSet RegWithFormat
</span><a href="GHC.CmmToAsm.Reg.Liveness.html#liveDieWrite"><span class="hs-identifier hs-var">liveDieWrite</span></a></span><span> </span><span class="annot"><span class="annottext">Liveness
</span><a href="#local-6989586621682852119"><span class="hs-identifier hs-var">live</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-468"></span><span>                        </span><span class="hs-comment">-- See Note [Unique Determinism and code generation]</span><span>
</span><span id="line-469"></span><span>
</span><span id="line-470"></span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#raInsn"><span class="hs-identifier hs-var">raInsn</span></a></span><span> </span><span class="annot"><span class="annottext">BlockMap (UniqSet RegWithFormat)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[instr]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">BlockId
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682852148"><span class="annot"><span class="annottext">LiveInstr instr
</span><a href="#local-6989586621682852148"><span class="hs-identifier hs-var">instr</span></a></span></span><span>
</span><span id="line-471"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-472"></span><span>            </span><span id="local-6989586621682852149"><span class="annot"><a href="#local-6989586621682852149"><span class="hs-identifier hs-var">platform</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RegM freeRegs Platform
forall a. RegM a Platform
</span><a href="GHC.CmmToAsm.Reg.Linear.State.html#getPlatform"><span class="hs-identifier hs-var">getPlatform</span></a></span><span>
</span><span id="line-473"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682852150"><span class="annot"><a href="#local-6989586621682852150"><span class="hs-identifier hs-var hs-var">instr'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(instr -&gt; SDoc) -&gt; LiveInstr instr -&gt; LiveInstr SDoc
forall a b. (a -&gt; b) -&gt; LiveInstr a -&gt; LiveInstr b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Platform -&gt; instr -&gt; SDoc
forall instr. Instruction instr =&gt; Platform -&gt; instr -&gt; SDoc
</span><a href="GHC.CmmToAsm.Instr.html#pprInstr"><span class="hs-identifier hs-var">pprInstr</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682852149"><span class="hs-identifier hs-var">platform</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LiveInstr instr
</span><a href="#local-6989586621682852148"><span class="hs-identifier hs-var">instr</span></a></span><span>
</span><span id="line-474"></span><span>            </span><span class="annot"><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-type">pprPanic</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;raInsn&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;no match for:&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-type">&lt;&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852150"><span class="hs-identifier hs-type">instr'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-475"></span><span>
</span><span id="line-476"></span><span class="hs-comment">-- ToDo: what can we do about</span><span>
</span><span id="line-477"></span><span class="hs-comment">--</span><span>
</span><span id="line-478"></span><span class="hs-comment">--     R1 = x</span><span>
</span><span id="line-479"></span><span class="hs-comment">--     jump I64[x] // [R1]</span><span>
</span><span id="line-480"></span><span class="hs-comment">--</span><span>
</span><span id="line-481"></span><span class="hs-comment">-- where x is mapped to the same reg as R1.  We want to coalesce x and</span><span>
</span><span id="line-482"></span><span class="hs-comment">-- R1, but the register allocator doesn't know whether x will be</span><span>
</span><span id="line-483"></span><span class="hs-comment">-- assigned to again later, in which case x and R1 should be in</span><span>
</span><span id="line-484"></span><span class="hs-comment">-- different registers.  Right now we assume the worst, and the</span><span>
</span><span id="line-485"></span><span class="hs-comment">-- assignment to R1 will clobber x, so we'll spill x into another reg,</span><span>
</span><span id="line-486"></span><span class="hs-comment">-- generating another reg-&gt;reg move.</span><span>
</span><span id="line-487"></span><span>
</span><span id="line-488"></span><span>
</span><span id="line-489"></span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#isInReg"><span class="hs-identifier hs-type">isInReg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Platform.Reg.html#Reg"><span class="hs-identifier hs-type">Reg</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html#RegMap"><span class="hs-identifier hs-type">RegMap</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#Loc"><span class="hs-identifier hs-type">Loc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-490"></span><span id="isInReg"><span class="annot"><span class="annottext">isInReg :: Reg -&gt; RegMap Loc -&gt; Bool
</span><a href="GHC.CmmToAsm.Reg.Linear.html#isInReg"><span class="hs-identifier hs-var hs-var">isInReg</span></a></span></span><span> </span><span id="local-6989586621682852156"><span class="annot"><span class="annottext">Reg
</span><a href="#local-6989586621682852156"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span id="local-6989586621682852157"><span class="annot"><span class="annottext">RegMap Loc
</span><a href="#local-6989586621682852157"><span class="hs-identifier hs-var">assig</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#InReg"><span class="hs-identifier hs-type">InReg</span></a></span><span> </span><span class="annot"><span class="annottext">RealRegUsage
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RegMap Loc -&gt; Reg -&gt; Maybe Loc
forall key elt. Uniquable key =&gt; UniqFM key elt -&gt; key -&gt; Maybe elt
</span><a href="GHC.Types.Unique.FM.html#lookupUFM"><span class="hs-identifier hs-var">lookupUFM</span></a></span><span> </span><span class="annot"><span class="annottext">RegMap Loc
</span><a href="#local-6989586621682852157"><span class="hs-identifier hs-var">assig</span></a></span><span> </span><span class="annot"><span class="annottext">Reg
</span><a href="#local-6989586621682852156"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-491"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-492"></span><span>
</span><span id="line-493"></span><span>
</span><span id="line-494"></span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#genRaInsn"><span class="hs-identifier hs-type">genRaInsn</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621682851698"><span class="annot"><a href="#local-6989586621682851698"><span class="hs-identifier hs-type">freeRegs</span></a></span></span><span> </span><span id="local-6989586621682851699"><span class="annot"><a href="#local-6989586621682851699"><span class="hs-identifier hs-type">instr</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-495"></span><span>             </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#OutputableRegConstraint"><span class="hs-identifier hs-type">OutputableRegConstraint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851698"><span class="hs-identifier hs-type">freeRegs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851699"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-496"></span><span>          </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html#BlockMap"><span class="hs-identifier hs-type">BlockMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Unique.Set.html#UniqSet"><span class="hs-identifier hs-type">UniqSet</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Format.html#RegWithFormat"><span class="hs-identifier hs-type">RegWithFormat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-497"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621682851699"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-498"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span>
</span><span id="line-499"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621682851699"><span class="hs-identifier hs-type">instr</span></a></span><span>
</span><span id="line-500"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Platform.Reg.html#Reg"><span class="hs-identifier hs-type">Reg</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-501"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Platform.Reg.html#Reg"><span class="hs-identifier hs-type">Reg</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-502"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#RegM"><span class="hs-identifier hs-type">RegM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851698"><span class="hs-identifier hs-type">freeRegs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621682851699"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CmmToAsm.Types.html#NatBasicBlock"><span class="hs-identifier hs-type">NatBasicBlock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851699"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-503"></span><span>
</span><span id="line-504"></span><span id="genRaInsn"><span class="annot"><span class="annottext">genRaInsn :: forall freeRegs instr.
OutputableRegConstraint freeRegs instr =&gt;
BlockMap (UniqSet RegWithFormat)
-&gt; [instr]
-&gt; BlockId
-&gt; instr
-&gt; [Reg]
-&gt; [Reg]
-&gt; RegM freeRegs ([instr], [NatBasicBlock instr])
</span><a href="GHC.CmmToAsm.Reg.Linear.html#genRaInsn"><span class="hs-identifier hs-var hs-var">genRaInsn</span></a></span></span><span> </span><span id="local-6989586621682852193"><span class="annot"><span class="annottext">BlockMap (UniqSet RegWithFormat)
</span><a href="#local-6989586621682852193"><span class="hs-identifier hs-var">block_live</span></a></span></span><span> </span><span id="local-6989586621682852194"><span class="annot"><span class="annottext">[instr]
</span><a href="#local-6989586621682852194"><span class="hs-identifier hs-var">new_instrs</span></a></span></span><span> </span><span id="local-6989586621682852195"><span class="annot"><span class="annottext">BlockId
</span><a href="#local-6989586621682852195"><span class="hs-identifier hs-var">block_id</span></a></span></span><span> </span><span id="local-6989586621682852196"><span class="annot"><span class="annottext">instr
</span><a href="#local-6989586621682852196"><span class="hs-identifier hs-var">instr</span></a></span></span><span> </span><span id="local-6989586621682852197"><span class="annot"><span class="annottext">[Reg]
</span><a href="#local-6989586621682852197"><span class="hs-identifier hs-var">r_dying</span></a></span></span><span> </span><span id="local-6989586621682852198"><span class="annot"><span class="annottext">[Reg]
</span><a href="#local-6989586621682852198"><span class="hs-identifier hs-var">w_dying</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-505"></span><span class="hs-comment">-- pprTraceM &quot;genRaInsn&quot; $ ppr (block_id, instr)</span><span>
</span><span id="line-506"></span><span>  </span><span id="local-6989586621682852199"><span class="annot"><a href="#local-6989586621682852199"><span class="hs-identifier hs-var">platform</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RegM freeRegs Platform
forall a. RegM a Platform
</span><a href="GHC.CmmToAsm.Reg.Linear.State.html#getPlatform"><span class="hs-identifier hs-var">getPlatform</span></a></span><span>
</span><span id="line-507"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Instr.html#regUsageOfInstr"><span class="hs-identifier hs-type">regUsageOfInstr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852199"><span class="hs-identifier hs-type">platform</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852196"><span class="hs-identifier hs-type">instr</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Instr.html#RU"><span class="hs-identifier hs-type">RU</span></a></span><span> </span><span id="local-6989586621682852202"><span class="annot"><span class="annottext">[RegWithFormat]
</span><a href="#local-6989586621682852202"><span class="hs-identifier hs-var">read</span></a></span></span><span> </span><span id="local-6989586621682852203"><span class="annot"><span class="annottext">[RegWithFormat]
</span><a href="#local-6989586621682852203"><span class="hs-identifier hs-var">written</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-508"></span><span>    </span><span class="hs-keyword">do</span><span>
</span><span id="line-509"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682852204"><span class="annot"><span class="annottext">real_written :: [RealReg]
</span><a href="#local-6989586621682852204"><span class="hs-identifier hs-var hs-var hs-var">real_written</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852205"><span class="hs-identifier hs-var">rr</span></a></span><span>                      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Format.html#RegWithFormat"><span class="hs-identifier hs-type">RegWithFormat</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">regWithFormat_reg :: RegWithFormat -&gt; Reg
</span><a href="GHC.CmmToAsm.Format.html#regWithFormat_reg"><span class="hs-identifier hs-var">regWithFormat_reg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Platform.Reg.html#RegReal"><span class="hs-identifier hs-type">RegReal</span></a></span><span> </span><span id="local-6989586621682852205"><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852205"><span class="hs-identifier hs-var">rr</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[RegWithFormat]
</span><a href="#local-6989586621682852203"><span class="hs-identifier hs-var">written</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-510"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682852206"><span class="annot"><span class="annottext">virt_written :: [VirtualRegWithFormat]
</span><a href="#local-6989586621682852206"><span class="hs-identifier hs-var hs-var hs-var">virt_written</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">VirtualReg -&gt; Format -&gt; VirtualRegWithFormat
</span><a href="GHC.CmmToAsm.Format.html#VirtualRegWithFormat"><span class="hs-identifier hs-var">VirtualRegWithFormat</span></a></span><span> </span><span class="annot"><span class="annottext">VirtualReg
</span><a href="#local-6989586621682852208"><span class="hs-identifier hs-var">vr</span></a></span><span> </span><span class="annot"><span class="annottext">Format
</span><a href="#local-6989586621682852209"><span class="hs-identifier hs-var">fmt</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Format.html#RegWithFormat"><span class="hs-identifier hs-type">RegWithFormat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Platform.Reg.html#RegVirtual"><span class="hs-identifier hs-type">RegVirtual</span></a></span><span> </span><span id="local-6989586621682852208"><span class="annot"><span class="annottext">VirtualReg
</span><a href="#local-6989586621682852208"><span class="hs-identifier hs-var">vr</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682852209"><span class="annot"><span class="annottext">Format
</span><a href="#local-6989586621682852209"><span class="hs-identifier hs-var">fmt</span></a></span></span><span>         </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[RegWithFormat]
</span><a href="#local-6989586621682852203"><span class="hs-identifier hs-var">written</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-511"></span><span>
</span><span id="line-512"></span><span>    </span><span class="hs-comment">-- we don't need to do anything with real registers that are</span><span>
</span><span id="line-513"></span><span>    </span><span class="hs-comment">-- only read by this instr.  (the list is typically ~2 elements,</span><span>
</span><span id="line-514"></span><span>    </span><span class="hs-comment">-- so using nub isn't a problem).</span><span>
</span><span id="line-515"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621682852211"><span class="hs-identifier hs-type">virt_read</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CmmToAsm.Format.html#VirtualRegWithFormat"><span class="hs-identifier hs-type">VirtualRegWithFormat</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-516"></span><span>        </span><span id="local-6989586621682852211"><span class="annot"><span class="annottext">virt_read :: [VirtualRegWithFormat]
</span><a href="#local-6989586621682852211"><span class="hs-identifier hs-var hs-var hs-var">virt_read</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VirtualRegWithFormat -&gt; VirtualReg)
-&gt; [VirtualRegWithFormat] -&gt; [VirtualRegWithFormat]
forall b a. Ord b =&gt; (a -&gt; b) -&gt; [a] -&gt; [a]
</span><a href="../../containers-0.7-5a8f/src/Data.Containers.ListUtils.html#nubOrdOn"><span class="hs-identifier hs-var">nubOrdOn</span></a></span><span> </span><span class="annot"><span class="annottext">VirtualRegWithFormat -&gt; VirtualReg
</span><a href="GHC.CmmToAsm.Format.html#virtualRegWithFormat_reg"><span class="hs-identifier hs-var">virtualRegWithFormat_reg</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">VirtualReg -&gt; Format -&gt; VirtualRegWithFormat
</span><a href="GHC.CmmToAsm.Format.html#VirtualRegWithFormat"><span class="hs-identifier hs-var">VirtualRegWithFormat</span></a></span><span> </span><span class="annot"><span class="annottext">VirtualReg
</span><a href="#local-6989586621682852214"><span class="hs-identifier hs-var">vr</span></a></span><span> </span><span class="annot"><span class="annottext">Format
</span><a href="#local-6989586621682852215"><span class="hs-identifier hs-var">fmt</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Format.html#RegWithFormat"><span class="hs-identifier hs-type">RegWithFormat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Platform.Reg.html#RegVirtual"><span class="hs-identifier hs-type">RegVirtual</span></a></span><span> </span><span id="local-6989586621682852214"><span class="annot"><span class="annottext">VirtualReg
</span><a href="#local-6989586621682852214"><span class="hs-identifier hs-var">vr</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682852215"><span class="annot"><span class="annottext">Format
</span><a href="#local-6989586621682852215"><span class="hs-identifier hs-var">fmt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[RegWithFormat]
</span><a href="#local-6989586621682852202"><span class="hs-identifier hs-var">read</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-517"></span><span>
</span><span id="line-518"></span><span class="hs-comment">--     do</span><span>
</span><span id="line-519"></span><span class="hs-comment">--         let real_read       = nub [ rr      | (RegReal rr) &lt;- read]</span><span>
</span><span id="line-520"></span><span class="hs-comment">--         freeregs &lt;- getFreeRegsR</span><span>
</span><span id="line-521"></span><span class="hs-comment">--         assig    &lt;- getAssigR</span><span>
</span><span id="line-522"></span><span>
</span><span id="line-523"></span><span class="hs-comment">--         pprTraceM &quot;genRaInsn&quot;</span><span>
</span><span id="line-524"></span><span class="hs-comment">--                 (          text &quot;block        = &quot; &lt;+&gt; ppr block_id</span><span>
</span><span id="line-525"></span><span class="hs-comment">--                         $$ text &quot;instruction  = &quot; &lt;+&gt; ppr instr</span><span>
</span><span id="line-526"></span><span class="hs-comment">--                         $$ text &quot;r_dying      = &quot; &lt;+&gt; ppr r_dying</span><span>
</span><span id="line-527"></span><span class="hs-comment">--                         $$ text &quot;w_dying      = &quot; &lt;+&gt; ppr w_dying</span><span>
</span><span id="line-528"></span><span class="hs-comment">--                         $$ text &quot;read         = &quot; &lt;+&gt; ppr real_read    &lt;+&gt; ppr virt_read</span><span>
</span><span id="line-529"></span><span class="hs-comment">--                         $$ text &quot;written      = &quot; &lt;+&gt; ppr real_written &lt;+&gt; ppr virt_written</span><span>
</span><span id="line-530"></span><span class="hs-comment">--                         $$ text &quot;freeregs     = &quot; &lt;+&gt; ppr freeregs</span><span>
</span><span id="line-531"></span><span class="hs-comment">--                         $$ text &quot;assign       = &quot; &lt;+&gt; ppr assig)</span><span>
</span><span id="line-532"></span><span>
</span><span id="line-533"></span><span>    </span><span class="hs-comment">-- (a), (b) allocate real regs for all regs read by this instruction.</span><span>
</span><span id="line-534"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682852216"><span class="annot"><a href="#local-6989586621682852216"><span class="hs-identifier hs-var">r_spills</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682852217"><span class="annot"><a href="#local-6989586621682852217"><span class="hs-identifier hs-var">r_allocd</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-535"></span><span>        </span><span class="annot"><span class="annottext">Bool
-&gt; [VirtualRegWithFormat]
-&gt; [instr]
-&gt; [RealReg]
-&gt; [VirtualRegWithFormat]
-&gt; RegM freeRegs ([instr], [RealReg])
forall freeRegs instr.
(FR freeRegs, Instruction instr) =&gt;
Bool
-&gt; [VirtualRegWithFormat]
-&gt; [instr]
-&gt; [RealReg]
-&gt; [VirtualRegWithFormat]
-&gt; RegM freeRegs ([instr], [RealReg])
</span><a href="GHC.CmmToAsm.Reg.Linear.html#allocateRegsAndSpill"><span class="hs-identifier hs-var">allocateRegsAndSpill</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-comment">{-reading-}</span><span> </span><span class="annot"><span class="annottext">[VirtualRegWithFormat]
</span><a href="#local-6989586621682852211"><span class="hs-identifier hs-var">virt_read</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[VirtualRegWithFormat]
</span><a href="#local-6989586621682852211"><span class="hs-identifier hs-var">virt_read</span></a></span><span>
</span><span id="line-536"></span><span>
</span><span id="line-537"></span><span>    </span><span class="hs-comment">-- (c) save any temporaries which will be clobbered by this instruction</span><span>
</span><span id="line-538"></span><span>    </span><span id="local-6989586621682852219"><span class="annot"><a href="#local-6989586621682852219"><span class="hs-identifier hs-var">clobber_saves</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#saveClobberedTemps"><span class="hs-identifier hs-type">saveClobberedTemps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852204"><span class="hs-identifier hs-type">real_written</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852197"><span class="hs-identifier hs-type">r_dying</span></a></span><span>
</span><span id="line-539"></span><span>
</span><span id="line-540"></span><span>    </span><span class="hs-comment">-- (d) Update block map for new destinations</span><span>
</span><span id="line-541"></span><span>    </span><span class="hs-comment">-- NB. do this before removing dead regs from the assignment, because</span><span>
</span><span id="line-542"></span><span>    </span><span class="hs-comment">-- these dead regs might in fact be live in the jump targets (they're</span><span>
</span><span id="line-543"></span><span>    </span><span class="hs-comment">-- only dead in the code that follows in the current basic block).</span><span>
</span><span id="line-544"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682852221"><span class="annot"><a href="#local-6989586621682852221"><span class="hs-identifier hs-var">fixup_blocks</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682852222"><span class="annot"><a href="#local-6989586621682852222"><span class="hs-identifier hs-var">adjusted_instr</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-545"></span><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.JoinToTargets.html#joinToTargets"><span class="hs-identifier hs-type">joinToTargets</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852193"><span class="hs-identifier hs-type">block_live</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852195"><span class="hs-identifier hs-type">block_id</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852196"><span class="hs-identifier hs-type">instr</span></a></span><span>
</span><span id="line-546"></span><span>
</span><span id="line-547"></span><span class="hs-comment">--     when (not $ null fixup_blocks) $ pprTraceM &quot;genRA:FixBlocks&quot; $ ppr fixup_blocks</span><span>
</span><span id="line-548"></span><span>
</span><span id="line-549"></span><span>    </span><span class="hs-comment">-- Debugging - show places where the reg alloc inserted</span><span>
</span><span id="line-550"></span><span>    </span><span class="hs-comment">-- assignment fixup blocks.</span><span>
</span><span id="line-551"></span><span>    </span><span class="hs-comment">-- when (not $ null fixup_blocks) $</span><span>
</span><span id="line-552"></span><span>    </span><span class="hs-comment">--    pprTrace &quot;fixup_blocks&quot; (ppr fixup_blocks) (return ())</span><span>
</span><span id="line-553"></span><span>
</span><span id="line-554"></span><span>    </span><span class="hs-comment">-- (e) Delete all register assignments for temps which are read</span><span>
</span><span id="line-555"></span><span>    </span><span class="hs-comment">--     (only) and die here.  Update the free register list.</span><span>
</span><span id="line-556"></span><span>    </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#releaseRegs"><span class="hs-identifier hs-type">releaseRegs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852197"><span class="hs-identifier hs-type">r_dying</span></a></span><span>
</span><span id="line-557"></span><span>
</span><span id="line-558"></span><span>    </span><span class="hs-comment">-- (f) Mark regs which are clobbered as unallocatable</span><span>
</span><span id="line-559"></span><span>    </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#clobberRegs"><span class="hs-identifier hs-type">clobberRegs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852204"><span class="hs-identifier hs-type">real_written</span></a></span><span>
</span><span id="line-560"></span><span>
</span><span id="line-561"></span><span>    </span><span class="hs-comment">-- (g) Allocate registers for temporaries *written* (only)</span><span>
</span><span id="line-562"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682852226"><span class="annot"><a href="#local-6989586621682852226"><span class="hs-identifier hs-var">w_spills</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682852227"><span class="annot"><a href="#local-6989586621682852227"><span class="hs-identifier hs-var">w_allocd</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-563"></span><span>        </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#allocateRegsAndSpill"><span class="hs-identifier hs-type">allocateRegsAndSpill</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span class="hs-comment">{-writing-}</span><span> </span><span class="annot"><a href="#local-6989586621682852206"><span class="hs-identifier hs-type">virt_written</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><a href="#local-6989586621682852206"><span class="hs-identifier hs-type">virt_written</span></a></span><span>
</span><span id="line-564"></span><span>
</span><span id="line-565"></span><span>    </span><span class="hs-comment">-- (h) Release registers for temps which are written here and not</span><span>
</span><span id="line-566"></span><span>    </span><span class="hs-comment">-- used again.</span><span>
</span><span id="line-567"></span><span>    </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#releaseRegs"><span class="hs-identifier hs-type">releaseRegs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852198"><span class="hs-identifier hs-type">w_dying</span></a></span><span>
</span><span id="line-568"></span><span>
</span><span id="line-569"></span><span>    </span><span class="hs-keyword">let</span><span>
</span><span id="line-570"></span><span>        </span><span class="hs-comment">-- (i) Patch the instruction</span><span>
</span><span id="line-571"></span><span>        </span><span class="annot"><a href="#local-6989586621682852228"><span class="hs-identifier hs-type">patch_map</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Unique.FM.html#UniqFM"><span class="hs-identifier hs-type">UniqFM</span></a></span><span> </span><span class="annot"><a href="GHC.Platform.Reg.html#Reg"><span class="hs-identifier hs-type">Reg</span></a></span><span> </span><span class="annot"><a href="GHC.Platform.Reg.html#Reg"><span class="hs-identifier hs-type">Reg</span></a></span><span>
</span><span id="line-572"></span><span>        </span><span id="local-6989586621682852228"><span class="annot"><a href="#local-6989586621682852228"><span class="hs-identifier hs-var hs-var">patch_map</span></a></span></span><span>
</span><span id="line-573"></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UniqFM VirtualReg Reg -&gt; UniqFM Reg Reg
forall elt. UniqFM VirtualReg elt -&gt; UniqFM Reg elt
</span><a href="GHC.CmmToAsm.Reg.Utils.html#toRegMap"><span class="hs-identifier hs-var">toRegMap</span></a></span><span> </span><span class="annot"><span class="annottext">(UniqFM VirtualReg Reg -&gt; UniqFM Reg Reg)
-&gt; UniqFM VirtualReg Reg -&gt; UniqFM Reg Reg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-comment">-- Cast key from VirtualReg to Reg</span><span>
</span><span id="line-574"></span><span>                             </span><span class="hs-comment">-- See Note [UniqFM and the register allocator]</span><span>
</span><span id="line-575"></span><span>                  </span><span class="annot"><span class="annottext">[(VirtualReg, Reg)] -&gt; UniqFM VirtualReg Reg
forall key elt. Uniquable key =&gt; [(key, elt)] -&gt; UniqFM key elt
</span><a href="GHC.Types.Unique.FM.html#listToUFM"><span class="hs-identifier hs-var">listToUFM</span></a></span><span>
</span><span id="line-576"></span><span>                        </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VirtualRegWithFormat -&gt; VirtualReg
</span><a href="GHC.CmmToAsm.Format.html#virtualRegWithFormat_reg"><span class="hs-identifier hs-var">virtualRegWithFormat_reg</span></a></span><span> </span><span class="annot"><span class="annottext">VirtualRegWithFormat
</span><a href="#local-6989586621682852231"><span class="hs-identifier hs-var">vr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RealReg -&gt; Reg
</span><a href="GHC.Platform.Reg.html#RegReal"><span class="hs-identifier hs-var">RegReal</span></a></span><span> </span><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852232"><span class="hs-identifier hs-var">rr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-577"></span><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682852231"><span class="annot"><span class="annottext">VirtualRegWithFormat
</span><a href="#local-6989586621682852231"><span class="hs-identifier hs-var">vr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682852232"><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852232"><span class="hs-identifier hs-var">rr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[VirtualRegWithFormat]
-&gt; [RealReg] -&gt; [(VirtualRegWithFormat, RealReg)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VirtualRegWithFormat]
</span><a href="#local-6989586621682852211"><span class="hs-identifier hs-var">virt_read</span></a></span><span>    </span><span class="annot"><span class="annottext">[RealReg]
</span><a href="#local-6989586621682852217"><span class="hs-identifier hs-var">r_allocd</span></a></span><span>
</span><span id="line-578"></span><span>                                   </span><span class="annot"><span class="annottext">[(VirtualRegWithFormat, RealReg)]
-&gt; [(VirtualRegWithFormat, RealReg)]
-&gt; [(VirtualRegWithFormat, RealReg)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VirtualRegWithFormat]
-&gt; [RealReg] -&gt; [(VirtualRegWithFormat, RealReg)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VirtualRegWithFormat]
</span><a href="#local-6989586621682852206"><span class="hs-identifier hs-var">virt_written</span></a></span><span> </span><span class="annot"><span class="annottext">[RealReg]
</span><a href="#local-6989586621682852227"><span class="hs-identifier hs-var">w_allocd</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-579"></span><span>
</span><span id="line-580"></span><span>        </span><span class="annot"><a href="#local-6989586621682852233"><span class="hs-identifier hs-type">patched_instr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621682851699"><span class="hs-identifier hs-type">instr</span></a></span><span>
</span><span id="line-581"></span><span>        </span><span id="local-6989586621682852233"><span class="annot"><a href="#local-6989586621682852233"><span class="hs-identifier hs-var hs-var">patched_instr</span></a></span></span><span>
</span><span id="line-582"></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Platform -&gt; instr -&gt; (Reg -&gt; Reg) -&gt; instr
forall instr.
(Instruction instr, HasDebugCallStack) =&gt;
Platform -&gt; instr -&gt; (Reg -&gt; Reg) -&gt; instr
</span><a href="GHC.CmmToAsm.Instr.html#patchRegsOfInstr"><span class="hs-identifier hs-var">patchRegsOfInstr</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682852199"><span class="hs-identifier hs-var">platform</span></a></span><span> </span><span class="annot"><span class="annottext">instr
</span><a href="#local-6989586621682852222"><span class="hs-identifier hs-var">adjusted_instr</span></a></span><span> </span><span class="annot"><span class="annottext">Reg -&gt; Reg
</span><a href="#local-6989586621682852235"><span class="hs-identifier hs-var">patchLookup</span></a></span><span>
</span><span id="line-583"></span><span>
</span><span id="line-584"></span><span>        </span><span class="annot"><a href="#local-6989586621682852235"><span class="hs-identifier hs-type">patchLookup</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Platform.Reg.html#Reg"><span class="hs-identifier hs-type">Reg</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Platform.Reg.html#Reg"><span class="hs-identifier hs-type">Reg</span></a></span><span>
</span><span id="line-585"></span><span>        </span><span id="local-6989586621682852235"><span class="annot"><a href="#local-6989586621682852235"><span class="hs-identifier hs-var hs-var">patchLookup</span></a></span></span><span> </span><span id="local-6989586621682852236"><span class="annot"><span class="annottext">Reg
</span><a href="#local-6989586621682852236"><span class="hs-identifier hs-var">x</span></a></span></span><span>
</span><span id="line-586"></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">UniqFM Reg Reg -&gt; Reg -&gt; Maybe Reg
forall key elt. Uniquable key =&gt; UniqFM key elt -&gt; key -&gt; Maybe elt
</span><a href="GHC.Types.Unique.FM.html#lookupUFM"><span class="hs-identifier hs-var">lookupUFM</span></a></span><span> </span><span class="annot"><span class="annottext">UniqFM Reg Reg
</span><a href="#local-6989586621682852228"><span class="hs-identifier hs-var">patch_map</span></a></span><span> </span><span class="annot"><span class="annottext">Reg
</span><a href="#local-6989586621682852236"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-587"></span><span>                        </span><span class="annot"><span class="annottext">Maybe Reg
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Reg
</span><a href="#local-6989586621682852236"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-588"></span><span>                        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682852237"><span class="annot"><span class="annottext">Reg
</span><a href="#local-6989586621682852237"><span class="hs-identifier hs-var">y</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Reg
</span><a href="#local-6989586621682852237"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-589"></span><span>
</span><span id="line-590"></span><span>    </span><span class="hs-comment">-- (j) free up stack slots for dead spilled regs</span><span>
</span><span id="line-591"></span><span>    </span><span class="hs-comment">-- TODO (can't be bothered right now)</span><span>
</span><span id="line-592"></span><span>
</span><span id="line-593"></span><span>    </span><span class="hs-comment">-- erase reg-&gt;reg moves where the source and destination are the same.</span><span>
</span><span id="line-594"></span><span>    </span><span class="hs-comment">--  If the src temp didn't die in this instr but happened to be allocated</span><span>
</span><span id="line-595"></span><span>    </span><span class="hs-comment">--  to the same real reg as the destination, then we can erase the move anyway.</span><span>
</span><span id="line-596"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682852238"><span class="annot"><a href="#local-6989586621682852238"><span class="hs-identifier hs-var hs-var">squashed_instr</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Platform -&gt; instr -&gt; Maybe (Reg, Reg)
forall instr.
Instruction instr =&gt;
Platform -&gt; instr -&gt; Maybe (Reg, Reg)
</span><a href="GHC.CmmToAsm.Instr.html#takeRegRegMoveInstr"><span class="hs-identifier hs-var">takeRegRegMoveInstr</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682852199"><span class="hs-identifier hs-var">platform</span></a></span><span> </span><span class="annot"><span class="annottext">instr
</span><a href="#local-6989586621682852233"><span class="hs-identifier hs-var">patched_instr</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-597"></span><span>                                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682852239"><span class="annot"><span class="annottext">Reg
</span><a href="#local-6989586621682852239"><span class="hs-identifier hs-var">src</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682852240"><span class="annot"><span class="annottext">Reg
</span><a href="#local-6989586621682852240"><span class="hs-identifier hs-var">dst</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-598"></span><span>                                 </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Reg
</span><a href="#local-6989586621682852239"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">Reg -&gt; Reg -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Reg
</span><a href="#local-6989586621682852240"><span class="hs-identifier hs-var">dst</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-599"></span><span>                                </span><span class="annot"><span class="annottext">Maybe (Reg, Reg)
</span><span class="hs-identifier">_</span></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">instr
</span><a href="#local-6989586621682852233"><span class="hs-identifier hs-var">patched_instr</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-600"></span><span>
</span><span id="line-601"></span><span>    </span><span class="hs-comment">-- On the use of @reverse@ below.</span><span>
</span><span id="line-602"></span><span>    </span><span class="hs-comment">-- Since we can have spills and reloads produce multiple instructions</span><span>
</span><span id="line-603"></span><span>    </span><span class="hs-comment">-- we need to ensure they are emitted in the correct order.  We used to only</span><span>
</span><span id="line-604"></span><span>    </span><span class="hs-comment">-- emit single instructions in mkSpill/mkReload/mkRegRegMove.</span><span>
</span><span id="line-605"></span><span>    </span><span class="hs-comment">-- As such order of spills and reloads didn't matter.  However,  with</span><span>
</span><span id="line-606"></span><span>    </span><span class="hs-comment">-- multiple instructions potentially issued by those functions we need to be</span><span>
</span><span id="line-607"></span><span>    </span><span class="hs-comment">-- careful to not break execution order. Reversing the spills (clobber will</span><span>
</span><span id="line-608"></span><span>    </span><span class="hs-comment">-- also spill), will ensure they are emitted in the right order.</span><span>
</span><span id="line-609"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-610"></span><span>    </span><span class="hs-comment">-- See also Ticket 19910 for changing the return type from [] to OrdList.</span><span>
</span><span id="line-611"></span><span>
</span><span id="line-612"></span><span>    </span><span class="hs-comment">-- For debugging, uncomment the follow line and the mkComment lines.</span><span>
</span><span id="line-613"></span><span>    </span><span class="hs-comment">-- u &lt;- getUniqueR</span><span>
</span><span id="line-614"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682852241"><span class="annot"><a href="#local-6989586621682852241"><span class="hs-identifier hs-var hs-var">code</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[[instr]] -&gt; [instr]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-comment">--  mkComment (text &quot;&lt;genRaInsn(&quot; &lt;&gt; ppr u &lt;&gt; text &quot;)&gt;&quot;)</span><span>
</span><span id="line-615"></span><span>                        </span><span class="hs-comment">-- ,mkComment (text &quot;&lt;genRaInsn(&quot; &lt;&gt; ppr u &lt;&gt; text &quot;):squashed&gt;&quot;)]</span><span>
</span><span id="line-616"></span><span>                        </span><span class="annot"><span class="annottext">[instr]
</span><a href="#local-6989586621682852238"><span class="hs-identifier hs-var">squashed_instr</span></a></span><span>
</span><span id="line-617"></span><span>                        </span><span class="hs-comment">-- ,mkComment (text &quot;&lt;genRaInsn(&quot; &lt;&gt; ppr u &lt;&gt; text &quot;):w_spills&gt;&quot;)</span><span>
</span><span id="line-618"></span><span>                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[instr] -&gt; [instr]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[instr]
</span><a href="#local-6989586621682852226"><span class="hs-identifier hs-var">w_spills</span></a></span><span>
</span><span id="line-619"></span><span>                        </span><span class="hs-comment">-- ,mkComment (text &quot;&lt;genRaInsn(&quot; &lt;&gt; ppr u &lt;&gt; text &quot;):r_spills&gt;&quot;)</span><span>
</span><span id="line-620"></span><span>                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[instr] -&gt; [instr]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[instr]
</span><a href="#local-6989586621682852216"><span class="hs-identifier hs-var">r_spills</span></a></span><span>
</span><span id="line-621"></span><span>                        </span><span class="hs-comment">-- ,mkComment (text &quot;&lt;genRaInsn(&quot; &lt;&gt; ppr u &lt;&gt; text &quot;):clobber_saves&gt;&quot;)</span><span>
</span><span id="line-622"></span><span>                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[instr] -&gt; [instr]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[instr]
</span><a href="#local-6989586621682852219"><span class="hs-identifier hs-var">clobber_saves</span></a></span><span>
</span><span id="line-623"></span><span>                        </span><span class="hs-comment">-- ,mkComment (text &quot;&lt;genRaInsn(&quot; &lt;&gt; ppr u &lt;&gt; text &quot;):new_instrs&gt;&quot;)</span><span>
</span><span id="line-624"></span><span>                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[instr]
</span><a href="#local-6989586621682852194"><span class="hs-identifier hs-var">new_instrs</span></a></span><span>
</span><span id="line-625"></span><span>                        </span><span class="hs-comment">-- ,mkComment (text &quot;&lt;/genRaInsn(&quot; &lt;&gt; ppr u &lt;&gt; text &quot;)&gt;&quot;)</span><span>
</span><span id="line-626"></span><span>                      </span><span class="hs-special">]</span><span>
</span><span id="line-627"></span><span>
</span><span id="line-628"></span><span class="hs-comment">--    pprTrace &quot;patched-code&quot; ((vcat $ map (docToSDoc . pprInstr) code)) $ do</span><span>
</span><span id="line-629"></span><span class="hs-comment">--    pprTrace &quot;patched-fixup&quot; ((ppr fixup_blocks)) $ do</span><span>
</span><span id="line-630"></span><span>
</span><span id="line-631"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682852241"><span class="hs-identifier hs-type">code</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682852221"><span class="hs-identifier hs-type">fixup_blocks</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-632"></span><span>
</span><span id="line-633"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-634"></span><span>
</span><span id="line-635"></span><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><span id="line-636"></span><span class="hs-comment">-- releaseRegs</span><span>
</span><span id="line-637"></span><span>
</span><span id="line-638"></span><span id="local-6989586621682851722"><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#releaseRegs"><span class="hs-identifier hs-type">releaseRegs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.FreeRegs.html#FR"><span class="hs-identifier hs-type">FR</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851722"><span class="hs-identifier hs-type">freeRegs</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Platform.Reg.html#Reg"><span class="hs-identifier hs-type">Reg</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#RegM"><span class="hs-identifier hs-type">RegM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851722"><span class="hs-identifier hs-type">freeRegs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-639"></span><span id="releaseRegs"><span class="annot"><span class="annottext">releaseRegs :: forall freeRegs. FR freeRegs =&gt; [Reg] -&gt; RegM freeRegs ()
</span><a href="GHC.CmmToAsm.Reg.Linear.html#releaseRegs"><span class="hs-identifier hs-var hs-var">releaseRegs</span></a></span></span><span> </span><span id="local-6989586621682852256"><span class="annot"><span class="annottext">[Reg]
</span><a href="#local-6989586621682852256"><span class="hs-identifier hs-var">regs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-640"></span><span>  </span><span id="local-6989586621682852257"><span class="annot"><a href="#local-6989586621682852257"><span class="hs-identifier hs-var">platform</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RegM freeRegs Platform
forall a. RegM a Platform
</span><a href="GHC.CmmToAsm.Reg.Linear.State.html#getPlatform"><span class="hs-identifier hs-var">getPlatform</span></a></span><span>
</span><span id="line-641"></span><span>  </span><span id="local-6989586621682852258"><span class="annot"><a href="#local-6989586621682852258"><span class="hs-identifier hs-var">assig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#getAssigR"><span class="hs-identifier hs-type">getAssigR</span></a></span><span>
</span><span id="line-642"></span><span>  </span><span id="local-6989586621682852259"><span class="annot"><a href="#local-6989586621682852259"><span class="hs-identifier hs-var">free</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#getFreeRegsR"><span class="hs-identifier hs-type">getFreeRegsR</span></a></span><span>
</span><span id="line-643"></span><span>
</span><span id="line-644"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682852261"><span class="annot"><a href="#local-6989586621682852261"><span class="hs-identifier hs-var hs-var">loop</span></a></span></span><span> </span><span id="local-6989586621682852262"><span class="annot"><span class="annottext">RegMap Loc
</span><a href="#local-6989586621682852262"><span class="hs-identifier hs-var">assig</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682852263"><span class="annot"><span class="annottext">freeRegs
</span><a href="#local-6989586621682852263"><span class="hs-identifier hs-var">free</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">RegMap Loc -&gt; RegM freeRegs ()
forall freeRegs. RegMap Loc -&gt; RegM freeRegs ()
</span><a href="GHC.CmmToAsm.Reg.Linear.State.html#setAssigR"><span class="hs-identifier hs-var">setAssigR</span></a></span><span> </span><span class="annot"><span class="annottext">RegMap Loc
</span><a href="#local-6989586621682852262"><span class="hs-identifier hs-var">assig</span></a></span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">freeRegs -&gt; RegM freeRegs ()
forall freeRegs. freeRegs -&gt; RegM freeRegs ()
</span><a href="GHC.CmmToAsm.Reg.Linear.State.html#setFreeRegsR"><span class="hs-identifier hs-var">setFreeRegsR</span></a></span><span> </span><span class="annot"><span class="annottext">freeRegs
</span><a href="#local-6989586621682852263"><span class="hs-identifier hs-var">free</span></a></span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">() -&gt; RegM freeRegs ()
forall a. a -&gt; RegM freeRegs a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-645"></span><span>      </span><span class="annot"><a href="#local-6989586621682852261"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span id="local-6989586621682852264"><span class="annot"><span class="annottext">RegMap Loc
</span><a href="#local-6989586621682852264"><span class="hs-identifier hs-var">assig</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682852265"><span class="annot"><span class="annottext">freeRegs
</span><a href="#local-6989586621682852265"><span class="hs-identifier hs-var">free</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Platform.Reg.html#RegReal"><span class="hs-identifier hs-type">RegReal</span></a></span><span> </span><span id="local-6989586621682852266"><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852266"><span class="hs-identifier hs-var">rr</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682852267"><span class="annot"><span class="annottext">[Reg]
</span><a href="#local-6989586621682852267"><span class="hs-identifier hs-var">rs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RegMap Loc -&gt; freeRegs -&gt; [Reg] -&gt; RegM freeRegs ()
</span><a href="#local-6989586621682852261"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">RegMap Loc
</span><a href="#local-6989586621682852264"><span class="hs-identifier hs-var">assig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Platform -&gt; RealReg -&gt; freeRegs -&gt; freeRegs
forall freeRegs.
FR freeRegs =&gt;
Platform -&gt; RealReg -&gt; freeRegs -&gt; freeRegs
</span><a href="GHC.CmmToAsm.Reg.Linear.FreeRegs.html#frReleaseReg"><span class="hs-identifier hs-var">frReleaseReg</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682852257"><span class="hs-identifier hs-var">platform</span></a></span><span> </span><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852266"><span class="hs-identifier hs-var">rr</span></a></span><span> </span><span class="annot"><span class="annottext">freeRegs
</span><a href="#local-6989586621682852265"><span class="hs-identifier hs-var">free</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Reg]
</span><a href="#local-6989586621682852267"><span class="hs-identifier hs-var">rs</span></a></span><span>
</span><span id="line-646"></span><span>      </span><span class="annot"><a href="#local-6989586621682852261"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span id="local-6989586621682852269"><span class="annot"><span class="annottext">RegMap Loc
</span><a href="#local-6989586621682852269"><span class="hs-identifier hs-var">assig</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682852270"><span class="annot"><span class="annottext">freeRegs
</span><a href="#local-6989586621682852270"><span class="hs-identifier hs-var">free</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682852271"><span class="annot"><span class="annottext">Reg
</span><a href="#local-6989586621682852271"><span class="hs-identifier hs-var">r</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682852272"><span class="annot"><span class="annottext">[Reg]
</span><a href="#local-6989586621682852272"><span class="hs-identifier hs-var">rs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-647"></span><span>         </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">RegMap Loc -&gt; Reg -&gt; Maybe Loc
forall key elt. Uniquable key =&gt; UniqFM key elt -&gt; key -&gt; Maybe elt
</span><a href="GHC.Types.Unique.FM.html#lookupUFM"><span class="hs-identifier hs-var">lookupUFM</span></a></span><span> </span><span class="annot"><span class="annottext">RegMap Loc
</span><a href="#local-6989586621682852269"><span class="hs-identifier hs-var">assig</span></a></span><span> </span><span class="annot"><span class="annottext">Reg
</span><a href="#local-6989586621682852271"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-648"></span><span>         </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#InBoth"><span class="hs-identifier hs-type">InBoth</span></a></span><span> </span><span id="local-6989586621682852274"><span class="annot"><span class="annottext">RealRegUsage
</span><a href="#local-6989586621682852274"><span class="hs-identifier hs-var">real</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RegMap Loc -&gt; freeRegs -&gt; [Reg] -&gt; RegM freeRegs ()
</span><a href="#local-6989586621682852261"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RegMap Loc -&gt; Reg -&gt; RegMap Loc
forall key elt.
Uniquable key =&gt;
UniqFM key elt -&gt; key -&gt; UniqFM key elt
</span><a href="GHC.Types.Unique.FM.html#delFromUFM"><span class="hs-identifier hs-var">delFromUFM</span></a></span><span> </span><span class="annot"><span class="annottext">RegMap Loc
</span><a href="#local-6989586621682852269"><span class="hs-identifier hs-var">assig</span></a></span><span> </span><span class="annot"><span class="annottext">Reg
</span><a href="#local-6989586621682852271"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-649"></span><span>                                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Platform -&gt; RealReg -&gt; freeRegs -&gt; freeRegs
forall freeRegs.
FR freeRegs =&gt;
Platform -&gt; RealReg -&gt; freeRegs -&gt; freeRegs
</span><a href="GHC.CmmToAsm.Reg.Linear.FreeRegs.html#frReleaseReg"><span class="hs-identifier hs-var">frReleaseReg</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682852257"><span class="hs-identifier hs-var">platform</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealRegUsage -&gt; RealReg
</span><a href="GHC.CmmToAsm.Reg.Linear.Base.html#realReg"><span class="hs-identifier hs-var">realReg</span></a></span><span> </span><span class="annot"><span class="annottext">RealRegUsage
</span><a href="#local-6989586621682852274"><span class="hs-identifier hs-var">real</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">freeRegs
</span><a href="#local-6989586621682852270"><span class="hs-identifier hs-var">free</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Reg]
</span><a href="#local-6989586621682852272"><span class="hs-identifier hs-var">rs</span></a></span><span>
</span><span id="line-650"></span><span>         </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#InReg"><span class="hs-identifier hs-type">InReg</span></a></span><span> </span><span id="local-6989586621682852276"><span class="annot"><span class="annottext">RealRegUsage
</span><a href="#local-6989586621682852276"><span class="hs-identifier hs-var">real</span></a></span></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RegMap Loc -&gt; freeRegs -&gt; [Reg] -&gt; RegM freeRegs ()
</span><a href="#local-6989586621682852261"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RegMap Loc -&gt; Reg -&gt; RegMap Loc
forall key elt.
Uniquable key =&gt;
UniqFM key elt -&gt; key -&gt; UniqFM key elt
</span><a href="GHC.Types.Unique.FM.html#delFromUFM"><span class="hs-identifier hs-var">delFromUFM</span></a></span><span> </span><span class="annot"><span class="annottext">RegMap Loc
</span><a href="#local-6989586621682852269"><span class="hs-identifier hs-var">assig</span></a></span><span> </span><span class="annot"><span class="annottext">Reg
</span><a href="#local-6989586621682852271"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-651"></span><span>                                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Platform -&gt; RealReg -&gt; freeRegs -&gt; freeRegs
forall freeRegs.
FR freeRegs =&gt;
Platform -&gt; RealReg -&gt; freeRegs -&gt; freeRegs
</span><a href="GHC.CmmToAsm.Reg.Linear.FreeRegs.html#frReleaseReg"><span class="hs-identifier hs-var">frReleaseReg</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682852257"><span class="hs-identifier hs-var">platform</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealRegUsage -&gt; RealReg
</span><a href="GHC.CmmToAsm.Reg.Linear.Base.html#realReg"><span class="hs-identifier hs-var">realReg</span></a></span><span> </span><span class="annot"><span class="annottext">RealRegUsage
</span><a href="#local-6989586621682852276"><span class="hs-identifier hs-var">real</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">freeRegs
</span><a href="#local-6989586621682852270"><span class="hs-identifier hs-var">free</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Reg]
</span><a href="#local-6989586621682852272"><span class="hs-identifier hs-var">rs</span></a></span><span>
</span><span id="line-652"></span><span>         </span><span class="annot"><span class="annottext">Maybe Loc
</span><span class="hs-identifier">_</span></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RegMap Loc -&gt; freeRegs -&gt; [Reg] -&gt; RegM freeRegs ()
</span><a href="#local-6989586621682852261"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RegMap Loc -&gt; Reg -&gt; RegMap Loc
forall key elt.
Uniquable key =&gt;
UniqFM key elt -&gt; key -&gt; UniqFM key elt
</span><a href="GHC.Types.Unique.FM.html#delFromUFM"><span class="hs-identifier hs-var">delFromUFM</span></a></span><span> </span><span class="annot"><span class="annottext">RegMap Loc
</span><a href="#local-6989586621682852269"><span class="hs-identifier hs-var">assig</span></a></span><span> </span><span class="annot"><span class="annottext">Reg
</span><a href="#local-6989586621682852271"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">freeRegs
</span><a href="#local-6989586621682852270"><span class="hs-identifier hs-var">free</span></a></span><span> </span><span class="annot"><span class="annottext">[Reg]
</span><a href="#local-6989586621682852272"><span class="hs-identifier hs-var">rs</span></a></span><span>
</span><span id="line-653"></span><span>  </span><span class="annot"><a href="#local-6989586621682852261"><span class="hs-identifier hs-type">loop</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852258"><span class="hs-identifier hs-type">assig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852259"><span class="hs-identifier hs-type">free</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852256"><span class="hs-identifier hs-type">regs</span></a></span><span>
</span><span id="line-654"></span><span>
</span><span id="line-655"></span><span>
</span><span id="line-656"></span><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><span id="line-657"></span><span class="hs-comment">-- Clobber real registers</span><span>
</span><span id="line-658"></span><span>
</span><span id="line-659"></span><span class="hs-comment">-- For each temp in a register that is going to be clobbered:</span><span>
</span><span id="line-660"></span><span class="hs-comment">--      - if the temp dies after this instruction, do nothing</span><span>
</span><span id="line-661"></span><span class="hs-comment">--      - otherwise, put it somewhere safe (another reg if possible,</span><span>
</span><span id="line-662"></span><span class="hs-comment">--              otherwise spill and record InBoth in the assignment).</span><span>
</span><span id="line-663"></span><span class="hs-comment">--      - for allocateRegs on the temps *read*,</span><span>
</span><span id="line-664"></span><span class="hs-comment">--      - clobbered regs are allocatable.</span><span>
</span><span id="line-665"></span><span class="hs-comment">--</span><span>
</span><span id="line-666"></span><span class="hs-comment">--      for allocateRegs on the temps *written*,</span><span>
</span><span id="line-667"></span><span class="hs-comment">--        - clobbered regs are not allocatable.</span><span>
</span><span id="line-668"></span><span class="hs-comment">--</span><span>
</span><span id="line-669"></span><span>
</span><span id="line-670"></span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#saveClobberedTemps"><span class="hs-identifier hs-type">saveClobberedTemps</span></a></span><span>
</span><span id="line-671"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621682851718"><span class="annot"><a href="#local-6989586621682851718"><span class="hs-identifier hs-type">instr</span></a></span></span><span> </span><span id="local-6989586621682851719"><span class="annot"><a href="#local-6989586621682851719"><span class="hs-identifier hs-type">freeRegs</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-672"></span><span>           </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Instr.html#Instruction"><span class="hs-identifier hs-type">Instruction</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851718"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.FreeRegs.html#FR"><span class="hs-identifier hs-type">FR</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851719"><span class="hs-identifier hs-type">freeRegs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-673"></span><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Platform.Reg.html#RealReg"><span class="hs-identifier hs-type">RealReg</span></a></span><span class="hs-special">]</span><span>            </span><span class="hs-comment">-- real registers clobbered by this instruction</span><span>
</span><span id="line-674"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Platform.Reg.html#Reg"><span class="hs-identifier hs-type">Reg</span></a></span><span class="hs-special">]</span><span>                </span><span class="hs-comment">-- registers which are no longer live after this insn</span><span>
</span><span id="line-675"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#RegM"><span class="hs-identifier hs-type">RegM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851719"><span class="hs-identifier hs-type">freeRegs</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621682851718"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">]</span><span>         </span><span class="hs-comment">-- return: instructions to spill any temps that will</span><span>
</span><span id="line-676"></span><span>                                </span><span class="hs-comment">-- be clobbered.</span><span>
</span><span id="line-677"></span><span>
</span><span id="line-678"></span><span id="saveClobberedTemps"><span class="annot"><span class="annottext">saveClobberedTemps :: forall instr freeRegs.
(Instruction instr, FR freeRegs) =&gt;
[RealReg] -&gt; [Reg] -&gt; RegM freeRegs [instr]
</span><a href="GHC.CmmToAsm.Reg.Linear.html#saveClobberedTemps"><span class="hs-identifier hs-var hs-var">saveClobberedTemps</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Reg]
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-679"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[instr] -&gt; RegM freeRegs [instr]
forall a. a -&gt; RegM freeRegs a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-680"></span><span>
</span><span id="line-681"></span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#saveClobberedTemps"><span class="hs-identifier hs-var">saveClobberedTemps</span></a></span><span> </span><span id="local-6989586621682852307"><span class="annot"><span class="annottext">[RealReg]
</span><a href="#local-6989586621682852307"><span class="hs-identifier hs-var">clobbered</span></a></span></span><span> </span><span id="local-6989586621682852308"><span class="annot"><span class="annottext">[Reg]
</span><a href="#local-6989586621682852308"><span class="hs-identifier hs-var">dying</span></a></span></span><span>
</span><span id="line-682"></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-683"></span><span>        </span><span id="local-6989586621682852309"><span class="annot"><a href="#local-6989586621682852309"><span class="hs-identifier hs-var">assig</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RegM freeRegs (RegMap Loc)
forall {freeRegs}. RegM freeRegs (RegMap Loc)
</span><a href="GHC.CmmToAsm.Reg.Linear.State.html#getAssigR"><span class="hs-identifier hs-var">getAssigR</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#RegM"><span class="hs-identifier hs-type">RegM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851719"><span class="hs-identifier hs-type">freeRegs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Unique.FM.html#UniqFM"><span class="hs-identifier hs-type">UniqFM</span></a></span><span> </span><span class="annot"><a href="GHC.Platform.Reg.html#Reg"><span class="hs-identifier hs-type">Reg</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#Loc"><span class="hs-identifier hs-type">Loc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-684"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621682852310"><span class="annot"><a href="#local-6989586621682852310"><span class="hs-identifier hs-var">assig'</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682852311"><span class="annot"><a href="#local-6989586621682852311"><span class="hs-identifier hs-var">instrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Types.Unique.FM.html#nonDetStrictFoldUFM_DirectlyM"><span class="hs-identifier hs-type">nonDetStrictFoldUFM_DirectlyM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852313"><span class="hs-identifier hs-type">maybe_spill</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682852309"><span class="hs-identifier hs-type">assig</span></a></span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682852309"><span class="hs-identifier hs-type">assig</span></a></span><span>
</span><span id="line-685"></span><span>        </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#setAssigR"><span class="hs-identifier hs-type">setAssigR</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852310"><span class="hs-identifier hs-type">assig'</span></a></span><span>
</span><span id="line-686"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-comment">-- mkComment (text &quot;&lt;saveClobberedTemps&gt;&quot;) ++</span><span>
</span><span id="line-687"></span><span>                 </span><span class="annot"><a href="#local-6989586621682852311"><span class="hs-identifier hs-type">instrs</span></a></span><span>
</span><span id="line-688"></span><span class="hs-comment">--              ++ mkComment (text &quot;&lt;/saveClobberedTemps&gt;&quot;)</span><span>
</span><span id="line-689"></span><span>   </span><span class="hs-keyword">where</span><span>
</span><span id="line-690"></span><span>     </span><span class="hs-comment">-- Unique represents the VirtualReg</span><span>
</span><span id="line-691"></span><span>     </span><span class="hs-comment">-- Here we separate the cases which we do want to spill from these we don't.</span><span>
</span><span id="line-692"></span><span>     </span><span class="annot"><a href="#local-6989586621682852313"><span class="hs-identifier hs-type">maybe_spill</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html#RegMap"><span class="hs-identifier hs-type">RegMap</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#Loc"><span class="hs-identifier hs-type">Loc</span></a></span><span class="hs-special">,</span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621682851718"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#Loc"><span class="hs-identifier hs-type">Loc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#RegM"><span class="hs-identifier hs-type">RegM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851719"><span class="hs-identifier hs-type">freeRegs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html#RegMap"><span class="hs-identifier hs-type">RegMap</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#Loc"><span class="hs-identifier hs-type">Loc</span></a></span><span class="hs-special">,</span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621682851718"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-693"></span><span>     </span><span id="local-6989586621682852313"><span class="annot"><span class="annottext">maybe_spill :: Unique
-&gt; (RegMap Loc, [instr])
-&gt; Loc
-&gt; RegM freeRegs (RegMap Loc, [instr])
</span><a href="#local-6989586621682852313"><span class="hs-identifier hs-var hs-var">maybe_spill</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682852314"><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682852314"><span class="hs-identifier hs-var">temp</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span id="local-6989586621682852315"><span class="annot"><span class="annottext">RegMap Loc
</span><a href="#local-6989586621682852315"><span class="hs-identifier hs-var">assig</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682852316"><span class="annot"><span class="annottext">[instr]
</span><a href="#local-6989586621682852316"><span class="hs-identifier hs-var">instrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682852317"><span class="annot"><span class="annottext">Loc
</span><a href="#local-6989586621682852317"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-694"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Loc
</span><a href="#local-6989586621682852317"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-695"></span><span>                </span><span class="hs-comment">-- This is non-deterministic but we do not</span><span>
</span><span id="line-696"></span><span>                </span><span class="hs-comment">-- currently support deterministic code-generation.</span><span>
</span><span id="line-697"></span><span>                </span><span class="hs-comment">-- See Note [Unique Determinism and code generation]</span><span>
</span><span id="line-698"></span><span>                </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#InReg"><span class="hs-identifier hs-type">InReg</span></a></span><span> </span><span id="local-6989586621682852318"><span class="annot"><span class="annottext">RealRegUsage
</span><a href="#local-6989586621682852318"><span class="hs-identifier hs-var">reg</span></a></span></span><span>
</span><span id="line-699"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">(RealReg -&gt; Bool) -&gt; [RealReg] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealReg -&gt; RealReg -&gt; Bool
</span><a href="GHC.Platform.Reg.html#realRegsAlias"><span class="hs-identifier hs-var">realRegsAlias</span></a></span><span> </span><span class="annot"><span class="annottext">(RealReg -&gt; RealReg -&gt; Bool) -&gt; RealReg -&gt; RealReg -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RealRegUsage -&gt; RealReg
</span><a href="GHC.CmmToAsm.Reg.Linear.Base.html#realReg"><span class="hs-identifier hs-var">realReg</span></a></span><span> </span><span class="annot"><span class="annottext">RealRegUsage
</span><a href="#local-6989586621682852318"><span class="hs-identifier hs-var">reg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[RealReg]
</span><a href="#local-6989586621682852307"><span class="hs-identifier hs-var">clobbered</span></a></span><span>
</span><span id="line-700"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682852314"><span class="hs-identifier hs-var">temp</span></a></span><span> </span><span class="annot"><span class="annottext">Unique -&gt; [Unique] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`notElem`</span></span><span> </span><span class="annot"><span class="annottext">(Reg -&gt; Unique) -&gt; [Reg] -&gt; [Unique]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Reg -&gt; Unique
forall a. Uniquable a =&gt; a -&gt; Unique
</span><a href="GHC.Types.Unique.html#getUnique"><span class="hs-identifier hs-var">getUnique</span></a></span><span> </span><span class="annot"><span class="annottext">[Reg]
</span><a href="#local-6989586621682852308"><span class="hs-identifier hs-var">dying</span></a></span><span>
</span><span id="line-701"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Unique
-&gt; (RegMap Loc, [instr])
-&gt; RealRegUsage
-&gt; RegM freeRegs (RegMap Loc, [instr])
</span><a href="#local-6989586621682852322"><span class="hs-identifier hs-var">clobber</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682852314"><span class="hs-identifier hs-var">temp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RegMap Loc
</span><a href="#local-6989586621682852315"><span class="hs-identifier hs-var">assig</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">[instr]
</span><a href="#local-6989586621682852316"><span class="hs-identifier hs-var">instrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">RealRegUsage
</span><a href="#local-6989586621682852318"><span class="hs-identifier hs-var">reg</span></a></span><span>
</span><span id="line-702"></span><span>                </span><span class="annot"><span class="annottext">Loc
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(RegMap Loc, [instr]) -&gt; RegM freeRegs (RegMap Loc, [instr])
forall a. a -&gt; RegM freeRegs a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RegMap Loc
</span><a href="#local-6989586621682852315"><span class="hs-identifier hs-var">assig</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">[instr]
</span><a href="#local-6989586621682852316"><span class="hs-identifier hs-var">instrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-703"></span><span>
</span><span id="line-704"></span><span>
</span><span id="line-705"></span><span>     </span><span class="hs-comment">-- See Note [UniqFM and the register allocator]</span><span>
</span><span id="line-706"></span><span>     </span><span class="annot"><a href="#local-6989586621682852322"><span class="hs-identifier hs-type">clobber</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html#RegMap"><span class="hs-identifier hs-type">RegMap</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#Loc"><span class="hs-identifier hs-type">Loc</span></a></span><span class="hs-special">,</span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621682851718"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#RealRegUsage"><span class="hs-identifier hs-type">RealRegUsage</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#RegM"><span class="hs-identifier hs-type">RegM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851719"><span class="hs-identifier hs-type">freeRegs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html#RegMap"><span class="hs-identifier hs-type">RegMap</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#Loc"><span class="hs-identifier hs-type">Loc</span></a></span><span class="hs-special">,</span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621682851718"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-707"></span><span>     </span><span id="local-6989586621682852322"><span class="annot"><span class="annottext">clobber :: Unique
-&gt; (RegMap Loc, [instr])
-&gt; RealRegUsage
-&gt; RegM freeRegs (RegMap Loc, [instr])
</span><a href="#local-6989586621682852322"><span class="hs-identifier hs-var hs-var">clobber</span></a></span></span><span> </span><span id="local-6989586621682852323"><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682852323"><span class="hs-identifier hs-var">temp</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682852324"><span class="annot"><span class="annottext">RegMap Loc
</span><a href="#local-6989586621682852324"><span class="hs-identifier hs-var">assig</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682852325"><span class="annot"><span class="annottext">[instr]
</span><a href="#local-6989586621682852325"><span class="hs-identifier hs-var">instrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#RealRegUsage"><span class="hs-identifier hs-type">RealRegUsage</span></a></span><span> </span><span id="local-6989586621682852326"><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852326"><span class="hs-identifier hs-var">reg</span></a></span></span><span> </span><span id="local-6989586621682852327"><span class="annot"><span class="annottext">Format
</span><a href="#local-6989586621682852327"><span class="hs-identifier hs-var">fmt</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-708"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621682852328"><span class="annot"><a href="#local-6989586621682852328"><span class="hs-identifier hs-var">config</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RegM freeRegs NCGConfig
forall a. RegM a NCGConfig
</span><a href="GHC.CmmToAsm.Reg.Linear.State.html#getConfig"><span class="hs-identifier hs-var">getConfig</span></a></span><span>
</span><span id="line-709"></span><span>            </span><span id="local-6989586621682852330"><span class="annot"><a href="#local-6989586621682852330"><span class="hs-identifier hs-var">platform</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#getPlatform"><span class="hs-identifier hs-type">getPlatform</span></a></span><span>
</span><span id="line-710"></span><span>
</span><span id="line-711"></span><span>            </span><span id="local-6989586621682852331"><span class="annot"><a href="#local-6989586621682852331"><span class="hs-identifier hs-var">freeRegs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#getFreeRegsR"><span class="hs-identifier hs-type">getFreeRegsR</span></a></span><span>
</span><span id="line-712"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682852332"><span class="annot"><a href="#local-6989586621682852332"><span class="hs-identifier hs-var hs-var">regclass</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Platform -&gt; RealReg -&gt; RegClass
</span><a href="GHC.CmmToAsm.Reg.Target.html#targetClassOfRealReg"><span class="hs-identifier hs-var">targetClassOfRealReg</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682852330"><span class="hs-identifier hs-var">platform</span></a></span><span> </span><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852326"><span class="hs-identifier hs-var">reg</span></a></span><span>
</span><span id="line-713"></span><span>                </span><span id="local-6989586621682852334"><span class="annot"><a href="#local-6989586621682852334"><span class="hs-identifier hs-var hs-var">freeRegs_thisClass</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Platform -&gt; RegClass -&gt; freeRegs -&gt; [RealReg]
forall freeRegs.
FR freeRegs =&gt;
Platform -&gt; RegClass -&gt; freeRegs -&gt; [RealReg]
</span><a href="GHC.CmmToAsm.Reg.Linear.FreeRegs.html#frGetFreeRegs"><span class="hs-identifier hs-var">frGetFreeRegs</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682852330"><span class="hs-identifier hs-var">platform</span></a></span><span> </span><span class="annot"><span class="annottext">RegClass
</span><a href="#local-6989586621682852332"><span class="hs-identifier hs-var">regclass</span></a></span><span> </span><span class="annot"><span class="annottext">freeRegs
</span><a href="#local-6989586621682852331"><span class="hs-identifier hs-var">freeRegs</span></a></span><span>
</span><span id="line-714"></span><span>
</span><span id="line-715"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="hs-identifier hs-type">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">`notElem`</span></span><span> </span><span class="annot"><span class="hs-identifier">clobbered</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682852334"><span class="hs-identifier hs-type">freeRegs_thisClass</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-716"></span><span>
</span><span id="line-717"></span><span>              </span><span class="hs-comment">-- (1) we have a free reg of the right class that isn't</span><span>
</span><span id="line-718"></span><span>              </span><span class="hs-comment">-- clobbered by this instruction; use it to save the</span><span>
</span><span id="line-719"></span><span>              </span><span class="hs-comment">-- clobbered value.</span><span>
</span><span id="line-720"></span><span>              </span><span class="hs-special">(</span><span id="local-6989586621682852336"><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852336"><span class="hs-identifier hs-var">my_reg</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[RealReg]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-721"></span><span>                  </span><span class="annot"><span class="annottext">freeRegs -&gt; RegM freeRegs ()
forall freeRegs. freeRegs -&gt; RegM freeRegs ()
</span><a href="GHC.CmmToAsm.Reg.Linear.State.html#setFreeRegsR"><span class="hs-identifier hs-var">setFreeRegsR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Platform -&gt; RealReg -&gt; freeRegs -&gt; freeRegs
forall freeRegs.
FR freeRegs =&gt;
Platform -&gt; RealReg -&gt; freeRegs -&gt; freeRegs
</span><a href="GHC.CmmToAsm.Reg.Linear.FreeRegs.html#frAllocateReg"><span class="hs-identifier hs-var">frAllocateReg</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682852330"><span class="hs-identifier hs-var">platform</span></a></span><span> </span><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852336"><span class="hs-identifier hs-var">my_reg</span></a></span><span> </span><span class="annot"><span class="annottext">freeRegs
</span><a href="#local-6989586621682852331"><span class="hs-identifier hs-var">freeRegs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-722"></span><span>
</span><span id="line-723"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682852337"><span class="annot"><span class="annottext">new_assign :: RegMap Loc
</span><a href="#local-6989586621682852337"><span class="hs-identifier hs-var hs-var hs-var">new_assign</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RegMap Loc -&gt; Unique -&gt; Loc -&gt; RegMap Loc
forall {k} (key :: k) elt.
UniqFM key elt -&gt; Unique -&gt; elt -&gt; UniqFM key elt
</span><a href="GHC.Types.Unique.FM.html#addToUFM_Directly"><span class="hs-identifier hs-var">addToUFM_Directly</span></a></span><span> </span><span class="annot"><span class="annottext">RegMap Loc
</span><a href="#local-6989586621682852324"><span class="hs-identifier hs-var">assig</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682852323"><span class="hs-identifier hs-var">temp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealRegUsage -&gt; Loc
</span><a href="GHC.CmmToAsm.Reg.Linear.Base.html#InReg"><span class="hs-identifier hs-var">InReg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealReg -&gt; Format -&gt; RealRegUsage
</span><a href="GHC.CmmToAsm.Reg.Linear.Base.html#RealRegUsage"><span class="hs-identifier hs-var">RealRegUsage</span></a></span><span> </span><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852336"><span class="hs-identifier hs-var">my_reg</span></a></span><span> </span><span class="annot"><span class="annottext">Format
</span><a href="#local-6989586621682852327"><span class="hs-identifier hs-var">fmt</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-724"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682852339"><span class="annot"><span class="annottext">instr :: instr
</span><a href="#local-6989586621682852339"><span class="hs-identifier hs-var hs-var">instr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NCGConfig -&gt; Format -&gt; Reg -&gt; Reg -&gt; instr
forall instr.
(Instruction instr, HasDebugCallStack) =&gt;
NCGConfig -&gt; Format -&gt; Reg -&gt; Reg -&gt; instr
</span><a href="GHC.CmmToAsm.Instr.html#mkRegRegMoveInstr"><span class="hs-identifier hs-var">mkRegRegMoveInstr</span></a></span><span> </span><span class="annot"><span class="annottext">NCGConfig
</span><a href="#local-6989586621682852328"><span class="hs-identifier hs-var">config</span></a></span><span> </span><span class="annot"><span class="annottext">Format
</span><a href="#local-6989586621682852327"><span class="hs-identifier hs-var">fmt</span></a></span><span>
</span><span id="line-725"></span><span>                                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealReg -&gt; Reg
</span><a href="GHC.Platform.Reg.html#RegReal"><span class="hs-identifier hs-var">RegReal</span></a></span><span> </span><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852326"><span class="hs-identifier hs-var">reg</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealReg -&gt; Reg
</span><a href="GHC.Platform.Reg.html#RegReal"><span class="hs-identifier hs-var">RegReal</span></a></span><span> </span><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852336"><span class="hs-identifier hs-var">my_reg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-726"></span><span>
</span><span id="line-727"></span><span>                  </span><span class="annot"><span class="annottext">(RegMap Loc, [instr]) -&gt; RegM freeRegs (RegMap Loc, [instr])
forall a. a -&gt; RegM freeRegs a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RegMap Loc
</span><a href="#local-6989586621682852337"><span class="hs-identifier hs-var">new_assign</span></a></span><span class="hs-special">,</span><span class="hs-special">(</span><span class="annot"><span class="annottext">instr
</span><a href="#local-6989586621682852339"><span class="hs-identifier hs-var">instr</span></a></span><span> </span><span class="annot"><span class="annottext">instr -&gt; [instr] -&gt; [instr]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[instr]
</span><a href="#local-6989586621682852325"><span class="hs-identifier hs-var">instrs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-728"></span><span>
</span><span id="line-729"></span><span>              </span><span class="hs-comment">-- (2) no free registers: spill the value</span><span>
</span><span id="line-730"></span><span>              </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-731"></span><span>                  </span><span class="hs-special">(</span><span id="local-6989586621682852341"><span class="annot"><a href="#local-6989586621682852341"><span class="hs-identifier hs-var">spill</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682852342"><span class="annot"><a href="#local-6989586621682852342"><span class="hs-identifier hs-var">slot</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RegWithFormat -&gt; Unique -&gt; RegM freeRegs ([instr], Int)
forall instr freeRegs.
Instruction instr =&gt;
RegWithFormat -&gt; Unique -&gt; RegM freeRegs ([instr], Int)
</span><a href="GHC.CmmToAsm.Reg.Linear.State.html#spillR"><span class="hs-identifier hs-var">spillR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reg -&gt; Format -&gt; RegWithFormat
</span><a href="GHC.CmmToAsm.Format.html#RegWithFormat"><span class="hs-identifier hs-var">RegWithFormat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealReg -&gt; Reg
</span><a href="GHC.Platform.Reg.html#RegReal"><span class="hs-identifier hs-var">RegReal</span></a></span><span> </span><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852326"><span class="hs-identifier hs-var">reg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Format
</span><a href="#local-6989586621682852327"><span class="hs-identifier hs-var">fmt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682852323"><span class="hs-identifier hs-var">temp</span></a></span><span>
</span><span id="line-732"></span><span>
</span><span id="line-733"></span><span>                  </span><span class="hs-comment">-- record why this reg was spilled for profiling</span><span>
</span><span id="line-734"></span><span>                  </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#recordSpill"><span class="hs-identifier hs-type">recordSpill</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#SpillClobber"><span class="hs-identifier hs-type">SpillClobber</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852323"><span class="hs-identifier hs-type">temp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-735"></span><span>
</span><span id="line-736"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682852346"><span class="annot"><a href="#local-6989586621682852346"><span class="hs-identifier hs-var hs-var">new_assign</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RegMap Loc -&gt; Unique -&gt; Loc -&gt; RegMap Loc
forall {k} (key :: k) elt.
UniqFM key elt -&gt; Unique -&gt; elt -&gt; UniqFM key elt
</span><a href="GHC.Types.Unique.FM.html#addToUFM_Directly"><span class="hs-identifier hs-var">addToUFM_Directly</span></a></span><span> </span><span class="annot"><span class="annottext">RegMap Loc
</span><a href="#local-6989586621682852324"><span class="hs-identifier hs-var">assig</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682852323"><span class="hs-identifier hs-var">temp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealRegUsage -&gt; Int -&gt; Loc
</span><a href="GHC.CmmToAsm.Reg.Linear.Base.html#InBoth"><span class="hs-identifier hs-var">InBoth</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealReg -&gt; Format -&gt; RealRegUsage
</span><a href="GHC.CmmToAsm.Reg.Linear.Base.html#RealRegUsage"><span class="hs-identifier hs-var">RealRegUsage</span></a></span><span> </span><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852326"><span class="hs-identifier hs-var">reg</span></a></span><span> </span><span class="annot"><span class="annottext">Format
</span><a href="#local-6989586621682852327"><span class="hs-identifier hs-var">fmt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682852342"><span class="hs-identifier hs-var">slot</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-737"></span><span>
</span><span id="line-738"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682852346"><span class="hs-identifier hs-type">new_assign</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682852341"><span class="hs-identifier hs-type">spill</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621682852325"><span class="hs-identifier hs-type">instrs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-739"></span><span>
</span><span id="line-740"></span><span>
</span><span id="line-741"></span><span>
</span><span id="line-742"></span><span>
</span><span id="line-743"></span><span class="hs-comment">-- | Mark all these real regs as allocated,</span><span>
</span><span id="line-744"></span><span class="hs-comment">--      and kick out their vreg assignments.</span><span>
</span><span id="line-745"></span><span class="hs-comment">--</span><span>
</span><span id="line-746"></span><span id="local-6989586621682851723"><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#clobberRegs"><span class="hs-identifier hs-type">clobberRegs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.FreeRegs.html#FR"><span class="hs-identifier hs-type">FR</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851723"><span class="hs-identifier hs-type">freeRegs</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Platform.Reg.html#RealReg"><span class="hs-identifier hs-type">RealReg</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#RegM"><span class="hs-identifier hs-type">RegM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851723"><span class="hs-identifier hs-type">freeRegs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-747"></span><span id="clobberRegs"><span class="annot"><span class="annottext">clobberRegs :: forall freeRegs. FR freeRegs =&gt; [RealReg] -&gt; RegM freeRegs ()
</span><a href="GHC.CmmToAsm.Reg.Linear.html#clobberRegs"><span class="hs-identifier hs-var hs-var">clobberRegs</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-748"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; RegM freeRegs ()
forall a. a -&gt; RegM freeRegs a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-749"></span><span>
</span><span id="line-750"></span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#clobberRegs"><span class="hs-identifier hs-var">clobberRegs</span></a></span><span> </span><span id="local-6989586621682852362"><span class="annot"><span class="annottext">[RealReg]
</span><a href="#local-6989586621682852362"><span class="hs-identifier hs-var">clobbered</span></a></span></span><span>
</span><span id="line-751"></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>   </span><span id="local-6989586621682852363"><span class="annot"><a href="#local-6989586621682852363"><span class="hs-identifier hs-var">platform</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RegM freeRegs Platform
forall a. RegM a Platform
</span><a href="GHC.CmmToAsm.Reg.Linear.State.html#getPlatform"><span class="hs-identifier hs-var">getPlatform</span></a></span><span>
</span><span id="line-752"></span><span>        </span><span id="local-6989586621682852364"><span class="annot"><a href="#local-6989586621682852364"><span class="hs-identifier hs-var">freeregs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#getFreeRegsR"><span class="hs-identifier hs-type">getFreeRegsR</span></a></span><span>
</span><span id="line-753"></span><span>
</span><span id="line-754"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682852365"><span class="annot"><a href="#local-6989586621682852365"><span class="hs-identifier hs-var hs-var">allRegClasses</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-755"></span><span>               </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Arch -&gt; RegArch
</span><a href="GHC.Platform.Reg.Class.html#registerArch"><span class="hs-identifier hs-var">registerArch</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Platform -&gt; Arch
</span><a href="GHC.Platform.html#platformArch"><span class="hs-identifier hs-var">platformArch</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682852363"><span class="hs-identifier hs-var">platform</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-756"></span><span>                 </span><span class="annot"><span class="annottext">RegArch
</span><a href="GHC.Platform.Reg.Class.html#Unified"><span class="hs-identifier hs-var">Unified</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span>   </span><span class="annot"><span class="annottext">[RegClass]
</span><a href="GHC.Platform.Reg.Class.Unified.html#allRegClasses"><span class="hs-identifier hs-var">Unified.allRegClasses</span></a></span><span>
</span><span id="line-757"></span><span>                 </span><span class="annot"><span class="annottext">RegArch
</span><a href="GHC.Platform.Reg.Class.html#Separate"><span class="hs-identifier hs-var">Separate</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="annot"><span class="annottext">[RegClass]
</span><a href="GHC.Platform.Reg.Class.Separate.html#allRegClasses"><span class="hs-identifier hs-var">Separate.allRegClasses</span></a></span><span>
</span><span id="line-758"></span><span>                 </span><span class="annot"><span class="annottext">RegArch
</span><a href="GHC.Platform.Reg.Class.html#NoVectors"><span class="hs-identifier hs-var">NoVectors</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[RegClass]
</span><a href="GHC.Platform.Reg.Class.NoVectors.html#allRegClasses"><span class="hs-identifier hs-var">NoVectors.allRegClasses</span></a></span><span>
</span><span id="line-759"></span><span>            </span><span id="local-6989586621682852372"><span class="annot"><a href="#local-6989586621682852372"><span class="hs-identifier hs-var hs-var">allFreeRegs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RegClass -&gt; [RealReg]) -&gt; [RegClass] -&gt; [RealReg]
forall m a. Monoid m =&gt; (a -&gt; m) -&gt; [a] -&gt; m
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621682852374"><span class="annot"><span class="annottext">RegClass
</span><a href="#local-6989586621682852374"><span class="hs-identifier hs-var">rc</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Platform -&gt; RegClass -&gt; freeRegs -&gt; [RealReg]
forall freeRegs.
FR freeRegs =&gt;
Platform -&gt; RegClass -&gt; freeRegs -&gt; [RealReg]
</span><a href="GHC.CmmToAsm.Reg.Linear.FreeRegs.html#frGetFreeRegs"><span class="hs-identifier hs-var">frGetFreeRegs</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682852363"><span class="hs-identifier hs-var">platform</span></a></span><span> </span><span class="annot"><span class="annottext">RegClass
</span><a href="#local-6989586621682852374"><span class="hs-identifier hs-var">rc</span></a></span><span> </span><span class="annot"><span class="annottext">freeRegs
</span><a href="#local-6989586621682852364"><span class="hs-identifier hs-var">freeregs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[RegClass]
</span><a href="#local-6989586621682852365"><span class="hs-identifier hs-var">allRegClasses</span></a></span><span>
</span><span id="line-760"></span><span>
</span><span id="line-761"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682852375"><span class="annot"><a href="#local-6989586621682852375"><span class="hs-identifier hs-var hs-var">extra_clobbered</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852376"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621682852376"><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852376"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[RealReg]
</span><a href="#local-6989586621682852362"><span class="hs-identifier hs-var">clobbered</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852376"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">RealReg -&gt; [RealReg] -&gt; Bool
forall a. Eq a =&gt; a -&gt; [a] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[RealReg]
</span><a href="#local-6989586621682852372"><span class="hs-identifier hs-var">allFreeRegs</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-762"></span><span>
</span><span id="line-763"></span><span>        </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#setFreeRegsR"><span class="hs-identifier hs-type">setFreeRegsR</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$!</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">foldl'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">flip</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.FreeRegs.html#frAllocateReg"><span class="hs-identifier hs-type">frAllocateReg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852363"><span class="hs-identifier hs-type">platform</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682852364"><span class="hs-identifier hs-type">freeregs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852375"><span class="hs-identifier hs-type">extra_clobbered</span></a></span><span>
</span><span id="line-764"></span><span>
</span><span id="line-765"></span><span>        </span><span class="hs-comment">-- setFreeRegsR $! foldl' (flip $ frAllocateReg platform) freeregs clobbered</span><span>
</span><span id="line-766"></span><span>
</span><span id="line-767"></span><span>        </span><span id="local-6989586621682852377"><span class="annot"><a href="#local-6989586621682852377"><span class="hs-identifier hs-var">assig</span></a></span></span><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#getAssigR"><span class="hs-identifier hs-type">getAssigR</span></a></span><span>
</span><span id="line-768"></span><span>        </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#setAssigR"><span class="hs-identifier hs-type">setAssigR</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$!</span></span><span> </span><span class="annot"><a href="#local-6989586621682852378"><span class="hs-identifier hs-type">clobber</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852377"><span class="hs-identifier hs-type">assig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Unique.FM.html#nonDetUFMToList"><span class="hs-identifier hs-type">nonDetUFMToList</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852377"><span class="hs-identifier hs-type">assig</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-769"></span><span>          </span><span class="hs-comment">-- This is non-deterministic but we do not</span><span>
</span><span id="line-770"></span><span>          </span><span class="hs-comment">-- currently support deterministic code-generation.</span><span>
</span><span id="line-771"></span><span>          </span><span class="hs-comment">-- See Note [Unique Determinism and code generation]</span><span>
</span><span id="line-772"></span><span>
</span><span id="line-773"></span><span>   </span><span class="hs-keyword">where</span><span>
</span><span id="line-774"></span><span>        </span><span class="hs-comment">-- if the temp was InReg and clobbered, then we will have</span><span>
</span><span id="line-775"></span><span>        </span><span class="hs-comment">-- saved it in saveClobberedTemps above.  So the only case</span><span>
</span><span id="line-776"></span><span>        </span><span class="hs-comment">-- we have to worry about here is InBoth.  Note that this</span><span>
</span><span id="line-777"></span><span>        </span><span class="hs-comment">-- also catches temps which were loaded up during allocation</span><span>
</span><span id="line-778"></span><span>        </span><span class="hs-comment">-- of read registers, not just those saved in saveClobberedTemps.</span><span>
</span><span id="line-779"></span><span>
</span><span id="line-780"></span><span>        </span><span class="annot"><a href="#local-6989586621682852378"><span class="hs-identifier hs-type">clobber</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html#RegMap"><span class="hs-identifier hs-type">RegMap</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#Loc"><span class="hs-identifier hs-type">Loc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#Loc"><span class="hs-identifier hs-type">Loc</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Liveness.html#RegMap"><span class="hs-identifier hs-type">RegMap</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#Loc"><span class="hs-identifier hs-type">Loc</span></a></span><span>
</span><span id="line-781"></span><span>        </span><span id="local-6989586621682852378"><span class="annot"><span class="annottext">clobber :: RegMap Loc -&gt; [(Unique, Loc)] -&gt; RegMap Loc
</span><a href="#local-6989586621682852378"><span class="hs-identifier hs-var hs-var">clobber</span></a></span></span><span> </span><span id="local-6989586621682852380"><span class="annot"><span class="annottext">RegMap Loc
</span><a href="#local-6989586621682852380"><span class="hs-identifier hs-var">assig</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-782"></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RegMap Loc
</span><a href="#local-6989586621682852380"><span class="hs-identifier hs-var">assig</span></a></span><span>
</span><span id="line-783"></span><span>
</span><span id="line-784"></span><span>        </span><span class="annot"><a href="#local-6989586621682852378"><span class="hs-identifier hs-var">clobber</span></a></span><span> </span><span id="local-6989586621682852381"><span class="annot"><span class="annottext">RegMap Loc
</span><a href="#local-6989586621682852381"><span class="hs-identifier hs-var">assig</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621682852382"><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682852382"><span class="hs-identifier hs-var">temp</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#InBoth"><span class="hs-identifier hs-type">InBoth</span></a></span><span> </span><span id="local-6989586621682852383"><span class="annot"><span class="annottext">RealRegUsage
</span><a href="#local-6989586621682852383"><span class="hs-identifier hs-var">reg</span></a></span></span><span> </span><span id="local-6989586621682852384"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682852384"><span class="hs-identifier hs-var">slot</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682852385"><span class="annot"><span class="annottext">[(Unique, Loc)]
</span><a href="#local-6989586621682852385"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-785"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">(RealReg -&gt; Bool) -&gt; [RealReg] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealReg -&gt; RealReg -&gt; Bool
</span><a href="GHC.Platform.Reg.html#realRegsAlias"><span class="hs-identifier hs-var">realRegsAlias</span></a></span><span> </span><span class="annot"><span class="annottext">(RealReg -&gt; RealReg -&gt; Bool) -&gt; RealReg -&gt; RealReg -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RealRegUsage -&gt; RealReg
</span><a href="GHC.CmmToAsm.Reg.Linear.Base.html#realReg"><span class="hs-identifier hs-var">realReg</span></a></span><span> </span><span class="annot"><span class="annottext">RealRegUsage
</span><a href="#local-6989586621682852383"><span class="hs-identifier hs-var">reg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[RealReg]
</span><a href="#local-6989586621682852362"><span class="hs-identifier hs-var">clobbered</span></a></span><span>
</span><span id="line-786"></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RegMap Loc -&gt; [(Unique, Loc)] -&gt; RegMap Loc
</span><a href="#local-6989586621682852378"><span class="hs-identifier hs-var">clobber</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RegMap Loc -&gt; Unique -&gt; Loc -&gt; RegMap Loc
forall {k} (key :: k) elt.
UniqFM key elt -&gt; Unique -&gt; elt -&gt; UniqFM key elt
</span><a href="GHC.Types.Unique.FM.html#addToUFM_Directly"><span class="hs-identifier hs-var">addToUFM_Directly</span></a></span><span> </span><span class="annot"><span class="annottext">RegMap Loc
</span><a href="#local-6989586621682852381"><span class="hs-identifier hs-var">assig</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682852382"><span class="hs-identifier hs-var">temp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Loc
</span><a href="GHC.CmmToAsm.Reg.Linear.Base.html#InMem"><span class="hs-identifier hs-var">InMem</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682852384"><span class="hs-identifier hs-var">slot</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Unique, Loc)]
</span><a href="#local-6989586621682852385"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-787"></span><span>
</span><span id="line-788"></span><span>        </span><span class="annot"><a href="#local-6989586621682852378"><span class="hs-identifier hs-var">clobber</span></a></span><span> </span><span id="local-6989586621682852387"><span class="annot"><span class="annottext">RegMap Loc
</span><a href="#local-6989586621682852387"><span class="hs-identifier hs-var">assig</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Unique, Loc)
</span><span class="hs-identifier">_</span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682852388"><span class="annot"><span class="annottext">[(Unique, Loc)]
</span><a href="#local-6989586621682852388"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-789"></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RegMap Loc -&gt; [(Unique, Loc)] -&gt; RegMap Loc
</span><a href="#local-6989586621682852378"><span class="hs-identifier hs-var">clobber</span></a></span><span> </span><span class="annot"><span class="annottext">RegMap Loc
</span><a href="#local-6989586621682852387"><span class="hs-identifier hs-var">assig</span></a></span><span> </span><span class="annot"><span class="annottext">[(Unique, Loc)]
</span><a href="#local-6989586621682852388"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-790"></span><span>
</span><span id="line-791"></span><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><span id="line-792"></span><span class="hs-comment">-- allocateRegsAndSpill</span><span>
</span><span id="line-793"></span><span>
</span><span id="line-794"></span><span class="hs-comment">-- Why are we performing a spill?</span><span>
</span><span id="line-795"></span><span class="hs-keyword">data</span><span> </span><span id="SpillLoc"><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#SpillLoc"><span class="hs-identifier hs-var">SpillLoc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ReadMem"><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#ReadMem"><span class="hs-identifier hs-var">ReadMem</span></a></span></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.StackMap.html#StackSlot"><span class="hs-identifier hs-type">StackSlot</span></a></span><span>  </span><span class="hs-comment">-- reading from register only in memory</span><span>
</span><span id="line-796"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span id="WriteNew"><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#WriteNew"><span class="hs-identifier hs-var">WriteNew</span></a></span></span><span>           </span><span class="hs-comment">-- writing to a new variable</span><span>
</span><span id="line-797"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span id="WriteMem"><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#WriteMem"><span class="hs-identifier hs-var">WriteMem</span></a></span></span><span>           </span><span class="hs-comment">-- writing to register only in memory</span><span>
</span><span id="line-798"></span><span class="hs-comment">-- Note that ReadNew is not valid, since you don't want to be reading</span><span>
</span><span id="line-799"></span><span class="hs-comment">-- from an uninitialized register.  We also don't need the location of</span><span>
</span><span id="line-800"></span><span class="hs-comment">-- the register in memory, since that will be invalidated by the write.</span><span>
</span><span id="line-801"></span><span class="hs-comment">-- Technically, we could coalesce WriteNew and WriteMem into a single</span><span>
</span><span id="line-802"></span><span class="hs-comment">-- entry as well. -- EZY</span><span>
</span><span id="line-803"></span><span>
</span><span id="line-804"></span><span class="hs-comment">-- This function does several things:</span><span>
</span><span id="line-805"></span><span class="hs-comment">--   For each temporary referred to by this instruction,</span><span>
</span><span id="line-806"></span><span class="hs-comment">--   we allocate a real register (spilling another temporary if necessary).</span><span>
</span><span id="line-807"></span><span class="hs-comment">--   We load the temporary up from memory if necessary.</span><span>
</span><span id="line-808"></span><span class="hs-comment">--   We also update the register assignment in the process, and</span><span>
</span><span id="line-809"></span><span class="hs-comment">--   the list of free registers and free stack slots.</span><span>
</span><span id="line-810"></span><span>
</span><span id="line-811"></span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#allocateRegsAndSpill"><span class="hs-identifier hs-type">allocateRegsAndSpill</span></a></span><span>
</span><span id="line-812"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621682851716"><span class="annot"><a href="#local-6989586621682851716"><span class="hs-identifier hs-type">freeRegs</span></a></span></span><span> </span><span id="local-6989586621682851717"><span class="annot"><a href="#local-6989586621682851717"><span class="hs-identifier hs-type">instr</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.FreeRegs.html#FR"><span class="hs-identifier hs-type">FR</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851716"><span class="hs-identifier hs-type">freeRegs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Instr.html#Instruction"><span class="hs-identifier hs-type">Instruction</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851717"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-813"></span><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>               </span><span class="hs-comment">-- True &lt;=&gt; reading (load up spilled regs)</span><span>
</span><span id="line-814"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CmmToAsm.Format.html#VirtualRegWithFormat"><span class="hs-identifier hs-type">VirtualRegWithFormat</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- don't push these out</span><span>
</span><span id="line-815"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621682851717"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">]</span><span>            </span><span class="hs-comment">-- spill insns</span><span>
</span><span id="line-816"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Platform.Reg.html#RealReg"><span class="hs-identifier hs-type">RealReg</span></a></span><span class="hs-special">]</span><span>          </span><span class="hs-comment">-- real registers allocated (accum.)</span><span>
</span><span id="line-817"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CmmToAsm.Format.html#VirtualRegWithFormat"><span class="hs-identifier hs-type">VirtualRegWithFormat</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- temps to allocate</span><span>
</span><span id="line-818"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#RegM"><span class="hs-identifier hs-type">RegM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851716"><span class="hs-identifier hs-type">freeRegs</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621682851717"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Platform.Reg.html#RealReg"><span class="hs-identifier hs-type">RealReg</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-819"></span><span>
</span><span id="line-820"></span><span id="allocateRegsAndSpill"><span class="annot"><span class="annottext">allocateRegsAndSpill :: forall freeRegs instr.
(FR freeRegs, Instruction instr) =&gt;
Bool
-&gt; [VirtualRegWithFormat]
-&gt; [instr]
-&gt; [RealReg]
-&gt; [VirtualRegWithFormat]
-&gt; RegM freeRegs ([instr], [RealReg])
</span><a href="GHC.CmmToAsm.Reg.Linear.html#allocateRegsAndSpill"><span class="hs-identifier hs-var hs-var">allocateRegsAndSpill</span></a></span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span>       </span><span class="annot"><span class="annottext">[VirtualRegWithFormat]
</span><span class="hs-identifier">_</span></span><span>    </span><span id="local-6989586621682852414"><span class="annot"><span class="annottext">[instr]
</span><a href="#local-6989586621682852414"><span class="hs-identifier hs-var">spills</span></a></span></span><span> </span><span id="local-6989586621682852415"><span class="annot"><span class="annottext">[RealReg]
</span><a href="#local-6989586621682852415"><span class="hs-identifier hs-var">alloc</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-821"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([instr], [RealReg]) -&gt; RegM freeRegs ([instr], [RealReg])
forall a. a -&gt; RegM freeRegs a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[instr]
</span><a href="#local-6989586621682852414"><span class="hs-identifier hs-var">spills</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[RealReg] -&gt; [RealReg]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[RealReg]
</span><a href="#local-6989586621682852415"><span class="hs-identifier hs-var">alloc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-822"></span><span>
</span><span id="line-823"></span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#allocateRegsAndSpill"><span class="hs-identifier hs-var">allocateRegsAndSpill</span></a></span><span> </span><span id="local-6989586621682852416"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682852416"><span class="hs-identifier hs-var">reading</span></a></span></span><span> </span><span id="local-6989586621682852417"><span class="annot"><span class="annottext">[VirtualRegWithFormat]
</span><a href="#local-6989586621682852417"><span class="hs-identifier hs-var">keep</span></a></span></span><span> </span><span id="local-6989586621682852418"><span class="annot"><span class="annottext">[instr]
</span><a href="#local-6989586621682852418"><span class="hs-identifier hs-var">spills</span></a></span></span><span> </span><span id="local-6989586621682852419"><span class="annot"><span class="annottext">[RealReg]
</span><a href="#local-6989586621682852419"><span class="hs-identifier hs-var">alloc</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682852420"><span class="annot"><span class="annottext">r :: VirtualRegWithFormat
</span><a href="#local-6989586621682852420"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Format.html#VirtualRegWithFormat"><span class="hs-identifier hs-type">VirtualRegWithFormat</span></a></span><span> </span><span id="local-6989586621682852421"><span class="annot"><span class="annottext">VirtualReg
</span><a href="#local-6989586621682852421"><span class="hs-identifier hs-var">vr</span></a></span></span><span> </span><span id="local-6989586621682852422"><span class="annot"><span class="annottext">Format
</span><a href="#local-6989586621682852422"><span class="hs-identifier hs-var">_fmt</span></a></span></span><span class="hs-special">)</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682852423"><span class="annot"><span class="annottext">[VirtualRegWithFormat]
</span><a href="#local-6989586621682852423"><span class="hs-identifier hs-var">rs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-824"></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>   </span><span id="local-6989586621682852424"><span class="annot"><a href="#local-6989586621682852424"><span class="hs-identifier hs-var">assig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RegMap Loc -&gt; UniqFM VirtualReg Loc
forall elt. UniqFM Reg elt -&gt; UniqFM VirtualReg elt
</span><a href="GHC.CmmToAsm.Reg.Utils.html#toVRegMap"><span class="hs-identifier hs-var">toVRegMap</span></a></span><span> </span><span class="annot"><span class="annottext">(RegMap Loc -&gt; UniqFM VirtualReg Loc)
-&gt; RegM freeRegs (RegMap Loc)
-&gt; RegM freeRegs (UniqFM VirtualReg Loc)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">RegM freeRegs (RegMap Loc)
forall {freeRegs}. RegM freeRegs (RegMap Loc)
</span><a href="GHC.CmmToAsm.Reg.Linear.State.html#getAssigR"><span class="hs-identifier hs-var">getAssigR</span></a></span><span>
</span><span id="line-825"></span><span>        </span><span class="hs-comment">-- pprTraceM &quot;allocateRegsAndSpill:assig&quot; (ppr (r:rs) $$ ppr assig)</span><span>
</span><span id="line-826"></span><span>        </span><span class="hs-comment">-- See Note [UniqFM and the register allocator]</span><span>
</span><span id="line-827"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682852427"><span class="annot"><a href="#local-6989586621682852427"><span class="hs-identifier hs-var hs-var">doSpill</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; [VirtualRegWithFormat]
-&gt; [instr]
-&gt; [RealReg]
-&gt; VirtualRegWithFormat
-&gt; [VirtualRegWithFormat]
-&gt; UniqFM VirtualReg Loc
-&gt; SpillLoc
-&gt; RegM freeRegs ([instr], [RealReg])
forall freeRegs instr.
(FR freeRegs, Instruction instr) =&gt;
Bool
-&gt; [VirtualRegWithFormat]
-&gt; [instr]
-&gt; [RealReg]
-&gt; VirtualRegWithFormat
-&gt; [VirtualRegWithFormat]
-&gt; UniqFM VirtualReg Loc
-&gt; SpillLoc
-&gt; RegM freeRegs ([instr], [RealReg])
</span><a href="GHC.CmmToAsm.Reg.Linear.html#allocRegsAndSpill_spill"><span class="hs-identifier hs-var">allocRegsAndSpill_spill</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682852416"><span class="hs-identifier hs-var">reading</span></a></span><span> </span><span class="annot"><span class="annottext">[VirtualRegWithFormat]
</span><a href="#local-6989586621682852417"><span class="hs-identifier hs-var">keep</span></a></span><span> </span><span class="annot"><span class="annottext">[instr]
</span><a href="#local-6989586621682852418"><span class="hs-identifier hs-var">spills</span></a></span><span> </span><span class="annot"><span class="annottext">[RealReg]
</span><a href="#local-6989586621682852419"><span class="hs-identifier hs-var">alloc</span></a></span><span> </span><span class="annot"><span class="annottext">VirtualRegWithFormat
</span><a href="#local-6989586621682852420"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">[VirtualRegWithFormat]
</span><a href="#local-6989586621682852423"><span class="hs-identifier hs-var">rs</span></a></span><span> </span><span class="annot"><span class="annottext">UniqFM VirtualReg Loc
</span><a href="#local-6989586621682852424"><span class="hs-identifier hs-var">assig</span></a></span><span>
</span><span id="line-828"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="GHC.Types.Unique.FM.html#lookupUFM"><span class="hs-identifier hs-type">lookupUFM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852424"><span class="hs-identifier hs-type">assig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852421"><span class="hs-identifier hs-type">vr</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-829"></span><span>                </span><span class="hs-comment">-- case (1a): already in a register</span><span>
</span><span id="line-830"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#InReg"><span class="hs-identifier hs-type">InReg</span></a></span><span> </span><span id="local-6989586621682852429"><span class="annot"><span class="annottext">RealRegUsage
</span><a href="#local-6989586621682852429"><span class="hs-identifier hs-var">my_reg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-831"></span><span>                        </span><span class="annot"><span class="annottext">Bool
-&gt; [VirtualRegWithFormat]
-&gt; [instr]
-&gt; [RealReg]
-&gt; [VirtualRegWithFormat]
-&gt; RegM freeRegs ([instr], [RealReg])
forall freeRegs instr.
(FR freeRegs, Instruction instr) =&gt;
Bool
-&gt; [VirtualRegWithFormat]
-&gt; [instr]
-&gt; [RealReg]
-&gt; [VirtualRegWithFormat]
-&gt; RegM freeRegs ([instr], [RealReg])
</span><a href="GHC.CmmToAsm.Reg.Linear.html#allocateRegsAndSpill"><span class="hs-identifier hs-var">allocateRegsAndSpill</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682852416"><span class="hs-identifier hs-var">reading</span></a></span><span> </span><span class="annot"><span class="annottext">[VirtualRegWithFormat]
</span><a href="#local-6989586621682852417"><span class="hs-identifier hs-var">keep</span></a></span><span> </span><span class="annot"><span class="annottext">[instr]
</span><a href="#local-6989586621682852418"><span class="hs-identifier hs-var">spills</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealRegUsage -&gt; RealReg
</span><a href="GHC.CmmToAsm.Reg.Linear.Base.html#realReg"><span class="hs-identifier hs-var">realReg</span></a></span><span> </span><span class="annot"><span class="annottext">RealRegUsage
</span><a href="#local-6989586621682852429"><span class="hs-identifier hs-var">my_reg</span></a></span><span class="annot"><span class="annottext">RealReg -&gt; [RealReg] -&gt; [RealReg]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[RealReg]
</span><a href="#local-6989586621682852419"><span class="hs-identifier hs-var">alloc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VirtualRegWithFormat]
</span><a href="#local-6989586621682852423"><span class="hs-identifier hs-var">rs</span></a></span><span>
</span><span id="line-832"></span><span>
</span><span id="line-833"></span><span>                </span><span class="hs-comment">-- case (1b): already in a register (and memory)</span><span>
</span><span id="line-834"></span><span>                </span><span class="hs-comment">-- NB1. if we're writing this register, update its assignment to be</span><span>
</span><span id="line-835"></span><span>                </span><span class="hs-comment">-- InReg, because the memory value is no longer valid.</span><span>
</span><span id="line-836"></span><span>                </span><span class="hs-comment">-- NB2. This is why we must process written registers here, even if they</span><span>
</span><span id="line-837"></span><span>                </span><span class="hs-comment">-- are also read by the same instruction.</span><span>
</span><span id="line-838"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#InBoth"><span class="hs-identifier hs-type">InBoth</span></a></span><span> </span><span id="local-6989586621682852430"><span class="annot"><span class="annottext">RealRegUsage
</span><a href="#local-6989586621682852430"><span class="hs-identifier hs-var">my_reg</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-839"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; RegM freeRegs () -&gt; RegM freeRegs ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682852416"><span class="hs-identifier hs-var">reading</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RegMap Loc -&gt; RegM freeRegs ()
forall freeRegs. RegMap Loc -&gt; RegM freeRegs ()
</span><a href="GHC.CmmToAsm.Reg.Linear.State.html#setAssigR"><span class="hs-identifier hs-var">setAssigR</span></a></span><span> </span><span class="annot"><span class="annottext">(RegMap Loc -&gt; RegM freeRegs ()) -&gt; RegMap Loc -&gt; RegM freeRegs ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UniqFM VirtualReg Loc -&gt; RegMap Loc
forall elt. UniqFM VirtualReg elt -&gt; UniqFM Reg elt
</span><a href="GHC.CmmToAsm.Reg.Utils.html#toRegMap"><span class="hs-identifier hs-var">toRegMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UniqFM VirtualReg Loc -&gt; VirtualReg -&gt; Loc -&gt; UniqFM VirtualReg Loc
forall key elt.
Uniquable key =&gt;
UniqFM key elt -&gt; key -&gt; elt -&gt; UniqFM key elt
</span><a href="GHC.Types.Unique.FM.html#addToUFM"><span class="hs-identifier hs-var">addToUFM</span></a></span><span> </span><span class="annot"><span class="annottext">UniqFM VirtualReg Loc
</span><a href="#local-6989586621682852424"><span class="hs-identifier hs-var">assig</span></a></span><span> </span><span class="annot"><span class="annottext">VirtualReg
</span><a href="#local-6989586621682852421"><span class="hs-identifier hs-var">vr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealRegUsage -&gt; Loc
</span><a href="GHC.CmmToAsm.Reg.Linear.Base.html#InReg"><span class="hs-identifier hs-var">InReg</span></a></span><span> </span><span class="annot"><span class="annottext">RealRegUsage
</span><a href="#local-6989586621682852430"><span class="hs-identifier hs-var">my_reg</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-840"></span><span>                        </span><span class="annot"><span class="annottext">Bool
-&gt; [VirtualRegWithFormat]
-&gt; [instr]
-&gt; [RealReg]
-&gt; [VirtualRegWithFormat]
-&gt; RegM freeRegs ([instr], [RealReg])
forall freeRegs instr.
(FR freeRegs, Instruction instr) =&gt;
Bool
-&gt; [VirtualRegWithFormat]
-&gt; [instr]
-&gt; [RealReg]
-&gt; [VirtualRegWithFormat]
-&gt; RegM freeRegs ([instr], [RealReg])
</span><a href="GHC.CmmToAsm.Reg.Linear.html#allocateRegsAndSpill"><span class="hs-identifier hs-var">allocateRegsAndSpill</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682852416"><span class="hs-identifier hs-var">reading</span></a></span><span> </span><span class="annot"><span class="annottext">[VirtualRegWithFormat]
</span><a href="#local-6989586621682852417"><span class="hs-identifier hs-var">keep</span></a></span><span> </span><span class="annot"><span class="annottext">[instr]
</span><a href="#local-6989586621682852418"><span class="hs-identifier hs-var">spills</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealRegUsage -&gt; RealReg
</span><a href="GHC.CmmToAsm.Reg.Linear.Base.html#realReg"><span class="hs-identifier hs-var">realReg</span></a></span><span> </span><span class="annot"><span class="annottext">RealRegUsage
</span><a href="#local-6989586621682852430"><span class="hs-identifier hs-var">my_reg</span></a></span><span class="annot"><span class="annottext">RealReg -&gt; [RealReg] -&gt; [RealReg]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[RealReg]
</span><a href="#local-6989586621682852419"><span class="hs-identifier hs-var">alloc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VirtualRegWithFormat]
</span><a href="#local-6989586621682852423"><span class="hs-identifier hs-var">rs</span></a></span><span>
</span><span id="line-841"></span><span>
</span><span id="line-842"></span><span>                </span><span class="hs-comment">-- Not already in a register, so we need to find a free one...</span><span>
</span><span id="line-843"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#InMem"><span class="hs-identifier hs-type">InMem</span></a></span><span> </span><span id="local-6989586621682852432"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682852432"><span class="hs-identifier hs-var">slot</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682852416"><span class="hs-identifier hs-var">reading</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SpillLoc -&gt; RegM freeRegs ([instr], [RealReg])
</span><a href="#local-6989586621682852427"><span class="hs-identifier hs-var">doSpill</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; SpillLoc
</span><a href="GHC.CmmToAsm.Reg.Linear.html#ReadMem"><span class="hs-identifier hs-var">ReadMem</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682852432"><span class="hs-identifier hs-var">slot</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-844"></span><span>                                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SpillLoc -&gt; RegM freeRegs ([instr], [RealReg])
</span><a href="#local-6989586621682852427"><span class="hs-identifier hs-var">doSpill</span></a></span><span> </span><span class="annot"><span class="annottext">SpillLoc
</span><a href="GHC.CmmToAsm.Reg.Linear.html#WriteMem"><span class="hs-identifier hs-var">WriteMem</span></a></span><span>
</span><span id="line-845"></span><span>                </span><span class="annot"><span class="annottext">Maybe Loc
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682852416"><span class="hs-identifier hs-var">reading</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-846"></span><span>                   </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; RegM freeRegs ([instr], [RealReg])
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;allocateRegsAndSpill: Cannot read from uninitialized register&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VirtualReg -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">VirtualReg
</span><a href="#local-6989586621682852421"><span class="hs-identifier hs-var">vr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-847"></span><span>                   </span><span class="hs-comment">-- NOTE: if the input to the NCG contains some</span><span>
</span><span id="line-848"></span><span>                   </span><span class="hs-comment">-- unreachable blocks with junk code, this panic</span><span>
</span><span id="line-849"></span><span>                   </span><span class="hs-comment">-- might be triggered.  Make sure you only feed</span><span>
</span><span id="line-850"></span><span>                   </span><span class="hs-comment">-- sensible code into the NCG.  In GHC.Cmm.Pipeline we</span><span>
</span><span id="line-851"></span><span>                   </span><span class="hs-comment">-- call removeUnreachableBlocks at the end for this</span><span>
</span><span id="line-852"></span><span>                   </span><span class="hs-comment">-- reason.</span><span>
</span><span id="line-853"></span><span>
</span><span id="line-854"></span><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SpillLoc -&gt; RegM freeRegs ([instr], [RealReg])
</span><a href="#local-6989586621682852427"><span class="hs-identifier hs-var">doSpill</span></a></span><span> </span><span class="annot"><span class="annottext">SpillLoc
</span><a href="GHC.CmmToAsm.Reg.Linear.html#WriteNew"><span class="hs-identifier hs-var">WriteNew</span></a></span><span>
</span><span id="line-855"></span><span>
</span><span id="line-856"></span><span class="hs-comment">-- | Given a virtual reg find a preferred real register.</span><span>
</span><span id="line-857"></span><span class="hs-comment">-- The preferred register is simply the first one the variable</span><span>
</span><span id="line-858"></span><span class="hs-comment">-- was assigned to (if any). This way when we allocate for a loop</span><span>
</span><span id="line-859"></span><span class="hs-comment">-- variables are likely to end up in the same registers at the</span><span>
</span><span id="line-860"></span><span class="hs-comment">-- end and start of the loop, avoiding redundant reg-reg moves.</span><span>
</span><span id="line-861"></span><span class="hs-comment">-- Note: I tried returning a list of past assignments, but that</span><span>
</span><span id="line-862"></span><span class="hs-comment">-- turned out to barely matter.</span><span>
</span><span id="line-863"></span><span id="local-6989586621682851772"><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#findPrefRealReg"><span class="hs-identifier hs-type">findPrefRealReg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Platform.Reg.html#VirtualReg"><span class="hs-identifier hs-type">VirtualReg</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#RegM"><span class="hs-identifier hs-type">RegM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851772"><span class="hs-identifier hs-type">freeRegs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Platform.Reg.html#RealReg"><span class="hs-identifier hs-type">RealReg</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-864"></span><span id="findPrefRealReg"><span class="annot"><span class="annottext">findPrefRealReg :: forall freeRegs. VirtualReg -&gt; RegM freeRegs (Maybe RealReg)
</span><a href="GHC.CmmToAsm.Reg.Linear.html#findPrefRealReg"><span class="hs-identifier hs-var hs-var">findPrefRealReg</span></a></span></span><span> </span><span id="local-6989586621682852436"><span class="annot"><span class="annottext">VirtualReg
</span><a href="#local-6989586621682852436"><span class="hs-identifier hs-var">vreg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-865"></span><span>  </span><span id="local-6989586621682852437"><span id="local-6989586621682852438"><span class="annot"><a href="#local-6989586621682852438"><span class="hs-identifier hs-var">bassig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RegM freeRegs (BlockAssignment freeRegs)
forall freeRegs. RegM freeRegs (BlockAssignment freeRegs)
</span><a href="GHC.CmmToAsm.Reg.Linear.State.html#getBlockAssigR"><span class="hs-identifier hs-var">getBlockAssigR</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#RegM"><span class="hs-identifier hs-type">RegM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852437"><span class="hs-identifier hs-type">freeRegs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#BlockAssignment"><span class="hs-identifier hs-type">BlockAssignment</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852437"><span class="hs-identifier hs-type">freeRegs</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-866"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#lookupFirstUsed"><span class="hs-identifier hs-type">lookupFirstUsed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852436"><span class="hs-identifier hs-type">vreg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852438"><span class="hs-identifier hs-type">bassig</span></a></span><span>
</span><span id="line-867"></span><span>
</span><span id="line-868"></span><span class="hs-comment">-- reading is redundant with reason, but we keep it around because it's</span><span>
</span><span id="line-869"></span><span class="hs-comment">-- convenient and it maintains the recursive structure of the allocator. -- EZY</span><span>
</span><span id="line-870"></span><span id="local-6989586621682851769"><span id="local-6989586621682851770"><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#allocRegsAndSpill_spill"><span class="hs-identifier hs-type">allocRegsAndSpill_spill</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.FreeRegs.html#FR"><span class="hs-identifier hs-type">FR</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851769"><span class="hs-identifier hs-type">freeRegs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Instr.html#Instruction"><span class="hs-identifier hs-type">Instruction</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851770"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-871"></span><span>                        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-872"></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CmmToAsm.Format.html#VirtualRegWithFormat"><span class="hs-identifier hs-type">VirtualRegWithFormat</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-873"></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621682851770"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-874"></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Platform.Reg.html#RealReg"><span class="hs-identifier hs-type">RealReg</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-875"></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Format.html#VirtualRegWithFormat"><span class="hs-identifier hs-type">VirtualRegWithFormat</span></a></span><span>
</span><span id="line-876"></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CmmToAsm.Format.html#VirtualRegWithFormat"><span class="hs-identifier hs-type">VirtualRegWithFormat</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-877"></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.FM.html#UniqFM"><span class="hs-identifier hs-type">UniqFM</span></a></span><span> </span><span class="annot"><a href="GHC.Platform.Reg.html#VirtualReg"><span class="hs-identifier hs-type">VirtualReg</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#Loc"><span class="hs-identifier hs-type">Loc</span></a></span><span>
</span><span id="line-878"></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#SpillLoc"><span class="hs-identifier hs-type">SpillLoc</span></a></span><span>
</span><span id="line-879"></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#RegM"><span class="hs-identifier hs-type">RegM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851769"><span class="hs-identifier hs-type">freeRegs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621682851770"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Platform.Reg.html#RealReg"><span class="hs-identifier hs-type">RealReg</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-880"></span><span id="allocRegsAndSpill_spill"><span class="annot"><span class="annottext">allocRegsAndSpill_spill :: forall freeRegs instr.
(FR freeRegs, Instruction instr) =&gt;
Bool
-&gt; [VirtualRegWithFormat]
-&gt; [instr]
-&gt; [RealReg]
-&gt; VirtualRegWithFormat
-&gt; [VirtualRegWithFormat]
-&gt; UniqFM VirtualReg Loc
-&gt; SpillLoc
-&gt; RegM freeRegs ([instr], [RealReg])
</span><a href="GHC.CmmToAsm.Reg.Linear.html#allocRegsAndSpill_spill"><span class="hs-identifier hs-var hs-var">allocRegsAndSpill_spill</span></a></span></span><span> </span><span id="local-6989586621682852511"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682852511"><span class="hs-identifier hs-var">reading</span></a></span></span><span> </span><span id="local-6989586621682852512"><span class="annot"><span class="annottext">[VirtualRegWithFormat]
</span><a href="#local-6989586621682852512"><span class="hs-identifier hs-var">keep</span></a></span></span><span> </span><span id="local-6989586621682852513"><span class="annot"><span class="annottext">[instr]
</span><a href="#local-6989586621682852513"><span class="hs-identifier hs-var">spills</span></a></span></span><span> </span><span id="local-6989586621682852514"><span class="annot"><span class="annottext">[RealReg]
</span><a href="#local-6989586621682852514"><span class="hs-identifier hs-var">alloc</span></a></span></span><span> </span><span id="local-6989586621682852515"><span class="annot"><span class="annottext">r :: VirtualRegWithFormat
</span><a href="#local-6989586621682852515"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Format.html#VirtualRegWithFormat"><span class="hs-identifier hs-type">VirtualRegWithFormat</span></a></span><span> </span><span id="local-6989586621682852516"><span class="annot"><span class="annottext">VirtualReg
</span><a href="#local-6989586621682852516"><span class="hs-identifier hs-var">vr</span></a></span></span><span> </span><span id="local-6989586621682852517"><span class="annot"><span class="annottext">Format
</span><a href="#local-6989586621682852517"><span class="hs-identifier hs-var">fmt</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682852518"><span class="annot"><span class="annottext">[VirtualRegWithFormat]
</span><a href="#local-6989586621682852518"><span class="hs-identifier hs-var">rs</span></a></span></span><span> </span><span id="local-6989586621682852519"><span class="annot"><span class="annottext">UniqFM VirtualReg Loc
</span><a href="#local-6989586621682852519"><span class="hs-identifier hs-var">assig</span></a></span></span><span> </span><span id="local-6989586621682852520"><span class="annot"><span class="annottext">SpillLoc
</span><a href="#local-6989586621682852520"><span class="hs-identifier hs-var">spill_loc</span></a></span></span><span>
</span><span id="line-881"></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>   </span><span id="local-6989586621682852521"><span class="annot"><a href="#local-6989586621682852521"><span class="hs-identifier hs-var">platform</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RegM freeRegs Platform
forall a. RegM a Platform
</span><a href="GHC.CmmToAsm.Reg.Linear.State.html#getPlatform"><span class="hs-identifier hs-var">getPlatform</span></a></span><span>
</span><span id="line-882"></span><span>        </span><span id="local-6989586621682852522"><span class="annot"><a href="#local-6989586621682852522"><span class="hs-identifier hs-var">freeRegs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#getFreeRegsR"><span class="hs-identifier hs-type">getFreeRegsR</span></a></span><span>
</span><span id="line-883"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682852523"><span class="annot"><a href="#local-6989586621682852523"><span class="hs-identifier hs-var hs-var">regclass</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Arch -&gt; VirtualReg -&gt; RegClass
</span><a href="GHC.Platform.Reg.html#classOfVirtualReg"><span class="hs-identifier hs-var">classOfVirtualReg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Platform -&gt; Arch
</span><a href="GHC.Platform.html#platformArch"><span class="hs-identifier hs-var">platformArch</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682852521"><span class="hs-identifier hs-var">platform</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VirtualReg
</span><a href="#local-6989586621682852516"><span class="hs-identifier hs-var">vr</span></a></span><span>
</span><span id="line-884"></span><span>            </span><span id="local-6989586621682852525"><span class="annot"><a href="#local-6989586621682852525"><span class="hs-identifier hs-var hs-var">freeRegs_thisClass</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Platform -&gt; RegClass -&gt; freeRegs -&gt; [RealReg]
forall freeRegs.
FR freeRegs =&gt;
Platform -&gt; RegClass -&gt; freeRegs -&gt; [RealReg]
</span><a href="GHC.CmmToAsm.Reg.Linear.FreeRegs.html#frGetFreeRegs"><span class="hs-identifier hs-var">frGetFreeRegs</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682852521"><span class="hs-identifier hs-var">platform</span></a></span><span> </span><span class="annot"><span class="annottext">RegClass
</span><a href="#local-6989586621682852523"><span class="hs-identifier hs-var">regclass</span></a></span><span> </span><span class="annot"><span class="annottext">freeRegs
</span><a href="#local-6989586621682852522"><span class="hs-identifier hs-var">freeRegs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Platform.Reg.html#RealReg"><span class="hs-identifier hs-type">RealReg</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-885"></span><span>
</span><span id="line-886"></span><span>        </span><span class="hs-comment">-- Can we put the variable into a register it already was?</span><span>
</span><span id="line-887"></span><span>        </span><span id="local-6989586621682852526"><span class="annot"><a href="#local-6989586621682852526"><span class="hs-identifier hs-var">pref_reg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#findPrefRealReg"><span class="hs-identifier hs-type">findPrefRealReg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852516"><span class="hs-identifier hs-type">vr</span></a></span><span>
</span><span id="line-888"></span><span>
</span><span id="line-889"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621682852525"><span class="hs-identifier hs-type">freeRegs_thisClass</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-890"></span><span>         </span><span class="hs-comment">-- case (2): we have a free register</span><span>
</span><span id="line-891"></span><span>         </span><span class="hs-special">(</span><span id="local-6989586621682852527"><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852527"><span class="hs-identifier hs-var">first_free</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[RealReg]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-892"></span><span>           </span><span class="hs-keyword">do</span><span>   </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682852528"><span class="annot"><span class="annottext">final_reg :: RealReg
</span><a href="#local-6989586621682852528"><span class="hs-identifier hs-var hs-var hs-var">final_reg</span></a></span></span><span>
</span><span id="line-893"></span><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682852529"><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852529"><span class="hs-identifier hs-var">reg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe RealReg
</span><a href="#local-6989586621682852526"><span class="hs-identifier hs-var">pref_reg</span></a></span><span>
</span><span id="line-894"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852529"><span class="hs-identifier hs-var">reg</span></a></span><span> </span><span class="annot"><span class="annottext">RealReg -&gt; [RealReg] -&gt; Bool
forall a. Eq a =&gt; a -&gt; [a] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[RealReg]
</span><a href="#local-6989586621682852525"><span class="hs-identifier hs-var">freeRegs_thisClass</span></a></span><span>
</span><span id="line-895"></span><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852529"><span class="hs-identifier hs-var">reg</span></a></span><span>
</span><span id="line-896"></span><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-897"></span><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852527"><span class="hs-identifier hs-var">first_free</span></a></span><span>
</span><span id="line-898"></span><span>
</span><span id="line-899"></span><span>                </span><span id="local-6989586621682852530"><span class="annot"><a href="#local-6989586621682852530"><span class="hs-identifier hs-var">spills'</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VirtualRegWithFormat
-&gt; SpillLoc -&gt; RealReg -&gt; [instr] -&gt; RegM freeRegs [instr]
forall instr freeRegs.
Instruction instr =&gt;
VirtualRegWithFormat
-&gt; SpillLoc -&gt; RealReg -&gt; [instr] -&gt; RegM freeRegs [instr]
</span><a href="GHC.CmmToAsm.Reg.Linear.html#loadTemp"><span class="hs-identifier hs-var">loadTemp</span></a></span><span> </span><span class="annot"><span class="annottext">VirtualRegWithFormat
</span><a href="#local-6989586621682852515"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">SpillLoc
</span><a href="#local-6989586621682852520"><span class="hs-identifier hs-var">spill_loc</span></a></span><span> </span><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852528"><span class="hs-identifier hs-var">final_reg</span></a></span><span> </span><span class="annot"><span class="annottext">[instr]
</span><a href="#local-6989586621682852513"><span class="hs-identifier hs-var">spills</span></a></span><span>
</span><span id="line-900"></span><span>
</span><span id="line-901"></span><span>                </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#setAssigR"><span class="hs-identifier hs-type">setAssigR</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Utils.html#toRegMap"><span class="hs-identifier hs-type">toRegMap</span></a></span><span>
</span><span id="line-902"></span><span>                          </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Unique.FM.html#addToUFM"><span class="hs-identifier hs-type">addToUFM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852519"><span class="hs-identifier hs-type">assig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852516"><span class="hs-identifier hs-type">vr</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$!</span></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#newLocation"><span class="hs-identifier hs-type">newLocation</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852520"><span class="hs-identifier hs-type">spill_loc</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#RealRegUsage"><span class="hs-identifier hs-type">RealRegUsage</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852528"><span class="hs-identifier hs-type">final_reg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852517"><span class="hs-identifier hs-type">fmt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-903"></span><span>                </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#setFreeRegsR"><span class="hs-identifier hs-type">setFreeRegsR</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>  </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.FreeRegs.html#frAllocateReg"><span class="hs-identifier hs-type">frAllocateReg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852521"><span class="hs-identifier hs-type">platform</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852528"><span class="hs-identifier hs-type">final_reg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852522"><span class="hs-identifier hs-type">freeRegs</span></a></span><span>
</span><span id="line-904"></span><span>
</span><span id="line-905"></span><span>                </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#allocateRegsAndSpill"><span class="hs-identifier hs-type">allocateRegsAndSpill</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852511"><span class="hs-identifier hs-type">reading</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852512"><span class="hs-identifier hs-type">keep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852530"><span class="hs-identifier hs-type">spills'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682852528"><span class="hs-identifier hs-type">final_reg</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="#local-6989586621682852514"><span class="hs-identifier hs-type">alloc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682852518"><span class="hs-identifier hs-type">rs</span></a></span><span>
</span><span id="line-906"></span><span>
</span><span id="line-907"></span><span>
</span><span id="line-908"></span><span>          </span><span class="hs-comment">-- case (3): we need to push something out to free up a register</span><span>
</span><span id="line-909"></span><span>         </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-910"></span><span>           </span><span class="hs-keyword">do</span><span>   </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682852533"><span class="annot"><span class="annottext">inRegOrBoth :: Loc -&gt; Bool
</span><a href="#local-6989586621682852533"><span class="hs-identifier hs-var hs-var hs-var">inRegOrBoth</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#InReg"><span class="hs-identifier hs-type">InReg</span></a></span><span> </span><span class="annot"><span class="annottext">RealRegUsage
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-911"></span><span>                    </span><span class="annot"><a href="#local-6989586621682852533"><span class="hs-identifier hs-var">inRegOrBoth</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#InBoth"><span class="hs-identifier hs-type">InBoth</span></a></span><span> </span><span class="annot"><span class="annottext">RealRegUsage
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-912"></span><span>                    </span><span class="annot"><a href="#local-6989586621682852533"><span class="hs-identifier hs-var">inRegOrBoth</span></a></span><span> </span><span class="annot"><span class="annottext">Loc
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-913"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621682852534"><span class="hs-identifier hs-type">candidates'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Unique.FM.html#UniqFM"><span class="hs-identifier hs-type">UniqFM</span></a></span><span> </span><span class="annot"><a href="GHC.Platform.Reg.html#VirtualReg"><span class="hs-identifier hs-type">VirtualReg</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#Loc"><span class="hs-identifier hs-type">Loc</span></a></span><span>
</span><span id="line-914"></span><span>                    </span><span id="local-6989586621682852534"><span class="annot"><span class="annottext">candidates' :: UniqFM VirtualReg Loc
</span><a href="#local-6989586621682852534"><span class="hs-identifier hs-var hs-var hs-var">candidates'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-915"></span><span>                      </span><span class="annot"><span class="annottext">(UniqFM VirtualReg Loc -&gt; [VirtualReg] -&gt; UniqFM VirtualReg Loc)
-&gt; [VirtualReg] -&gt; UniqFM VirtualReg Loc -&gt; UniqFM VirtualReg Loc
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">UniqFM VirtualReg Loc -&gt; [VirtualReg] -&gt; UniqFM VirtualReg Loc
forall key elt.
Uniquable key =&gt;
UniqFM key elt -&gt; [key] -&gt; UniqFM key elt
</span><a href="GHC.Types.Unique.FM.html#delListFromUFM"><span class="hs-identifier hs-var">delListFromUFM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VirtualRegWithFormat -&gt; VirtualReg)
-&gt; [VirtualRegWithFormat] -&gt; [VirtualReg]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">VirtualRegWithFormat -&gt; VirtualReg
</span><a href="GHC.CmmToAsm.Format.html#virtualRegWithFormat_reg"><span class="hs-identifier hs-var">virtualRegWithFormat_reg</span></a></span><span> </span><span class="annot"><span class="annottext">[VirtualRegWithFormat]
</span><a href="#local-6989586621682852512"><span class="hs-identifier hs-var">keep</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(UniqFM VirtualReg Loc -&gt; UniqFM VirtualReg Loc)
-&gt; UniqFM VirtualReg Loc -&gt; UniqFM VirtualReg Loc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-916"></span><span>                      </span><span class="annot"><span class="annottext">(Loc -&gt; Bool) -&gt; UniqFM VirtualReg Loc -&gt; UniqFM VirtualReg Loc
forall {k} elt (key :: k).
(elt -&gt; Bool) -&gt; UniqFM key elt -&gt; UniqFM key elt
</span><a href="GHC.Types.Unique.FM.html#filterUFM"><span class="hs-identifier hs-var">filterUFM</span></a></span><span> </span><span class="annot"><span class="annottext">Loc -&gt; Bool
</span><a href="#local-6989586621682852533"><span class="hs-identifier hs-var">inRegOrBoth</span></a></span><span> </span><span class="annot"><span class="annottext">(UniqFM VirtualReg Loc -&gt; UniqFM VirtualReg Loc)
-&gt; UniqFM VirtualReg Loc -&gt; UniqFM VirtualReg Loc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-917"></span><span>                      </span><span class="annot"><span class="annottext">UniqFM VirtualReg Loc
</span><a href="#local-6989586621682852519"><span class="hs-identifier hs-var">assig</span></a></span><span>
</span><span id="line-918"></span><span>                      </span><span class="hs-comment">-- This is non-deterministic but we do not</span><span>
</span><span id="line-919"></span><span>                      </span><span class="hs-comment">-- currently support deterministic code-generation.</span><span>
</span><span id="line-920"></span><span>                      </span><span class="hs-comment">-- See Note [Unique Determinism and code generation]</span><span>
</span><span id="line-921"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682852537"><span class="annot"><span class="annottext">candidates :: [(Unique, Loc)]
</span><a href="#local-6989586621682852537"><span class="hs-identifier hs-var hs-var hs-var">candidates</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UniqFM VirtualReg Loc -&gt; [(Unique, Loc)]
forall {k} (key :: k) elt. UniqFM key elt -&gt; [(Unique, elt)]
</span><a href="GHC.Types.Unique.FM.html#nonDetUFMToList"><span class="hs-identifier hs-var">nonDetUFMToList</span></a></span><span> </span><span class="annot"><span class="annottext">UniqFM VirtualReg Loc
</span><a href="#local-6989586621682852534"><span class="hs-identifier hs-var">candidates'</span></a></span><span>
</span><span id="line-922"></span><span>
</span><span id="line-923"></span><span>                </span><span class="hs-comment">-- the vregs we could kick out that are already in a slot</span><span>
</span><span id="line-924"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682852538"><span class="annot"><span class="annottext">compat :: RealReg -&gt; Bool
</span><a href="#local-6989586621682852538"><span class="hs-identifier hs-var hs-var hs-var">compat</span></a></span></span><span> </span><span id="local-6989586621682852539"><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852539"><span class="hs-identifier hs-var">reg'</span></a></span></span><span>
</span><span id="line-925"></span><span>                      </span><span class="hs-glyph">=</span><span>  </span><span class="annot"><span class="annottext">Platform -&gt; RealReg -&gt; RegClass
</span><a href="GHC.CmmToAsm.Reg.Target.html#targetClassOfRealReg"><span class="hs-identifier hs-var">targetClassOfRealReg</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682852521"><span class="hs-identifier hs-var">platform</span></a></span><span> </span><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852539"><span class="hs-identifier hs-var">reg'</span></a></span><span>
</span><span id="line-926"></span><span>                      </span><span class="annot"><span class="annottext">RegClass -&gt; RegClass -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">RegClass
</span><a href="#local-6989586621682852523"><span class="hs-identifier hs-var">regclass</span></a></span><span>
</span><span id="line-927"></span><span>                    </span><span class="annot"><a href="#local-6989586621682852540"><span class="hs-identifier hs-type">candidates_inBoth</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#RealRegUsage"><span class="hs-identifier hs-type">RealRegUsage</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.StackMap.html#StackSlot"><span class="hs-identifier hs-type">StackSlot</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-928"></span><span>                    </span><span id="local-6989586621682852540"><span class="annot"><span class="annottext">candidates_inBoth :: [(Unique, RealRegUsage, Int)]
</span><a href="#local-6989586621682852540"><span class="hs-identifier hs-var hs-var hs-var">candidates_inBoth</span></a></span></span><span>
</span><span id="line-929"></span><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682852541"><span class="hs-identifier hs-var">temp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RealRegUsage
</span><a href="#local-6989586621682852542"><span class="hs-identifier hs-var">reg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682852543"><span class="hs-identifier hs-var">mem</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-930"></span><span>                          </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682852541"><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682852541"><span class="hs-identifier hs-var">temp</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#InBoth"><span class="hs-identifier hs-type">InBoth</span></a></span><span> </span><span id="local-6989586621682852542"><span class="annot"><span class="annottext">RealRegUsage
</span><a href="#local-6989586621682852542"><span class="hs-identifier hs-var">reg</span></a></span></span><span> </span><span id="local-6989586621682852543"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682852543"><span class="hs-identifier hs-var">mem</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Unique, Loc)]
</span><a href="#local-6989586621682852537"><span class="hs-identifier hs-var">candidates</span></a></span><span>
</span><span id="line-931"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RealReg -&gt; Bool
</span><a href="#local-6989586621682852538"><span class="hs-identifier hs-var">compat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealRegUsage -&gt; RealReg
</span><a href="GHC.CmmToAsm.Reg.Linear.Base.html#realReg"><span class="hs-identifier hs-var">realReg</span></a></span><span> </span><span class="annot"><span class="annottext">RealRegUsage
</span><a href="#local-6989586621682852542"><span class="hs-identifier hs-var">reg</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-932"></span><span>
</span><span id="line-933"></span><span>                </span><span class="hs-comment">-- the vregs we could kick out that are only in a reg</span><span>
</span><span id="line-934"></span><span>                </span><span class="hs-comment">--      this would require writing the reg to a new slot before using it.</span><span>
</span><span id="line-935"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682852544"><span class="annot"><span class="annottext">candidates_inReg :: [(Unique, RealRegUsage)]
</span><a href="#local-6989586621682852544"><span class="hs-identifier hs-var hs-var hs-var">candidates_inReg</span></a></span></span><span>
</span><span id="line-936"></span><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682852545"><span class="hs-identifier hs-var">temp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RealRegUsage
</span><a href="#local-6989586621682852546"><span class="hs-identifier hs-var">reg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-937"></span><span>                          </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682852545"><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682852545"><span class="hs-identifier hs-var">temp</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#InReg"><span class="hs-identifier hs-type">InReg</span></a></span><span> </span><span id="local-6989586621682852546"><span class="annot"><span class="annottext">RealRegUsage
</span><a href="#local-6989586621682852546"><span class="hs-identifier hs-var">reg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Unique, Loc)]
</span><a href="#local-6989586621682852537"><span class="hs-identifier hs-var">candidates</span></a></span><span>
</span><span id="line-938"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RealReg -&gt; Bool
</span><a href="#local-6989586621682852538"><span class="hs-identifier hs-var">compat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealRegUsage -&gt; RealReg
</span><a href="GHC.CmmToAsm.Reg.Linear.Base.html#realReg"><span class="hs-identifier hs-var">realReg</span></a></span><span> </span><span class="annot"><span class="annottext">RealRegUsage
</span><a href="#local-6989586621682852546"><span class="hs-identifier hs-var">reg</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-939"></span><span>
</span><span id="line-940"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682852547"><span class="annot"><span class="annottext">result :: RegM freeRegs ([instr], [RealReg])
</span><a href="#local-6989586621682852547"><span class="hs-identifier hs-var hs-var">result</span></a></span></span><span>
</span><span id="line-941"></span><span>
</span><span id="line-942"></span><span>                        </span><span class="hs-comment">-- we have a temporary that is in both register and mem,</span><span>
</span><span id="line-943"></span><span>                        </span><span class="hs-comment">-- just free up its register for use.</span><span>
</span><span id="line-944"></span><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682852548"><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682852548"><span class="hs-identifier hs-var">temp</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#RealRegUsage"><span class="hs-identifier hs-type">RealRegUsage</span></a></span><span> </span><span id="local-6989586621682852549"><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852549"><span class="hs-identifier hs-var">my_reg</span></a></span></span><span> </span><span id="local-6989586621682852550"><span class="annot"><span class="annottext">Format
</span><a href="#local-6989586621682852550"><span class="hs-identifier hs-var">_old_fmt</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621682852551"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682852551"><span class="hs-identifier hs-var">slot</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[(Unique, RealRegUsage, Int)]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Unique, RealRegUsage, Int)]
</span><a href="#local-6989586621682852540"><span class="hs-identifier hs-var">candidates_inBoth</span></a></span><span>
</span><span id="line-945"></span><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>    </span><span id="local-6989586621682852552"><span class="annot"><a href="#local-6989586621682852552"><span class="hs-identifier hs-var">spills'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VirtualRegWithFormat
-&gt; SpillLoc -&gt; RealReg -&gt; [instr] -&gt; RegM freeRegs [instr]
forall instr freeRegs.
Instruction instr =&gt;
VirtualRegWithFormat
-&gt; SpillLoc -&gt; RealReg -&gt; [instr] -&gt; RegM freeRegs [instr]
</span><a href="GHC.CmmToAsm.Reg.Linear.html#loadTemp"><span class="hs-identifier hs-var">loadTemp</span></a></span><span> </span><span class="annot"><span class="annottext">VirtualRegWithFormat
</span><a href="#local-6989586621682852515"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">SpillLoc
</span><a href="#local-6989586621682852520"><span class="hs-identifier hs-var">spill_loc</span></a></span><span> </span><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852549"><span class="hs-identifier hs-var">my_reg</span></a></span><span> </span><span class="annot"><span class="annottext">[instr]
</span><a href="#local-6989586621682852513"><span class="hs-identifier hs-var">spills</span></a></span><span>
</span><span id="line-946"></span><span>                                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682852553"><span class="annot"><a href="#local-6989586621682852553"><span class="hs-identifier hs-var hs-var">assig1</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UniqFM VirtualReg Loc -&gt; Unique -&gt; Loc -&gt; UniqFM VirtualReg Loc
forall {k} (key :: k) elt.
UniqFM key elt -&gt; Unique -&gt; elt -&gt; UniqFM key elt
</span><a href="GHC.Types.Unique.FM.html#addToUFM_Directly"><span class="hs-identifier hs-var">addToUFM_Directly</span></a></span><span> </span><span class="annot"><span class="annottext">UniqFM VirtualReg Loc
</span><a href="#local-6989586621682852519"><span class="hs-identifier hs-var">assig</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682852548"><span class="hs-identifier hs-var">temp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Loc
</span><a href="GHC.CmmToAsm.Reg.Linear.Base.html#InMem"><span class="hs-identifier hs-var">InMem</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682852551"><span class="hs-identifier hs-var">slot</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-947"></span><span>                                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682852554"><span class="annot"><a href="#local-6989586621682852554"><span class="hs-identifier hs-var hs-var">assig2</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UniqFM VirtualReg Loc -&gt; VirtualReg -&gt; Loc -&gt; UniqFM VirtualReg Loc
forall key elt.
Uniquable key =&gt;
UniqFM key elt -&gt; key -&gt; elt -&gt; UniqFM key elt
</span><a href="GHC.Types.Unique.FM.html#addToUFM"><span class="hs-identifier hs-var">addToUFM</span></a></span><span> </span><span class="annot"><span class="annottext">UniqFM VirtualReg Loc
</span><a href="#local-6989586621682852553"><span class="hs-identifier hs-var">assig1</span></a></span><span> </span><span class="annot"><span class="annottext">VirtualReg
</span><a href="#local-6989586621682852516"><span class="hs-identifier hs-var">vr</span></a></span><span> </span><span class="annot"><span class="annottext">(Loc -&gt; UniqFM VirtualReg Loc) -&gt; Loc -&gt; UniqFM VirtualReg Loc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">SpillLoc -&gt; RealRegUsage -&gt; Loc
</span><a href="GHC.CmmToAsm.Reg.Linear.html#newLocation"><span class="hs-identifier hs-var">newLocation</span></a></span><span> </span><span class="annot"><span class="annottext">SpillLoc
</span><a href="#local-6989586621682852520"><span class="hs-identifier hs-var">spill_loc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealReg -&gt; Format -&gt; RealRegUsage
</span><a href="GHC.CmmToAsm.Reg.Linear.Base.html#RealRegUsage"><span class="hs-identifier hs-var">RealRegUsage</span></a></span><span> </span><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852549"><span class="hs-identifier hs-var">my_reg</span></a></span><span> </span><span class="annot"><span class="annottext">Format
</span><a href="#local-6989586621682852517"><span class="hs-identifier hs-var">fmt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-948"></span><span>
</span><span id="line-949"></span><span>                                </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#setAssigR"><span class="hs-identifier hs-type">setAssigR</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Utils.html#toRegMap"><span class="hs-identifier hs-type">toRegMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852554"><span class="hs-identifier hs-type">assig2</span></a></span><span>
</span><span id="line-950"></span><span>                                </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#allocateRegsAndSpill"><span class="hs-identifier hs-type">allocateRegsAndSpill</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852511"><span class="hs-identifier hs-type">reading</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852512"><span class="hs-identifier hs-type">keep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852552"><span class="hs-identifier hs-type">spills'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682852549"><span class="hs-identifier hs-type">my_reg</span></a></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><a href="#local-6989586621682852514"><span class="hs-identifier hs-type">alloc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682852518"><span class="hs-identifier hs-type">rs</span></a></span><span>
</span><span id="line-951"></span><span>
</span><span id="line-952"></span><span>                        </span><span class="hs-comment">-- otherwise, we need to spill a temporary that currently</span><span>
</span><span id="line-953"></span><span>                        </span><span class="hs-comment">-- resides in a register.</span><span>
</span><span id="line-954"></span><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682852555"><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682852555"><span class="hs-identifier hs-var">temp_to_push_out</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#RealRegUsage"><span class="hs-identifier hs-type">RealRegUsage</span></a></span><span> </span><span id="local-6989586621682852556"><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852556"><span class="hs-identifier hs-var">my_reg</span></a></span></span><span> </span><span id="local-6989586621682852557"><span class="annot"><span class="annottext">Format
</span><a href="#local-6989586621682852557"><span class="hs-identifier hs-var">fmt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[(Unique, RealRegUsage)]
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-955"></span><span>                                        </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Unique, RealRegUsage)]
</span><a href="#local-6989586621682852544"><span class="hs-identifier hs-var">candidates_inReg</span></a></span><span>
</span><span id="line-956"></span><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-957"></span><span>                                </span><span class="hs-special">(</span><span id="local-6989586621682852558"><span class="annot"><a href="#local-6989586621682852558"><span class="hs-identifier hs-var">spill_store</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682852559"><span class="annot"><a href="#local-6989586621682852559"><span class="hs-identifier hs-var">slot</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RegWithFormat -&gt; Unique -&gt; RegM freeRegs ([instr], Int)
forall instr freeRegs.
Instruction instr =&gt;
RegWithFormat -&gt; Unique -&gt; RegM freeRegs ([instr], Int)
</span><a href="GHC.CmmToAsm.Reg.Linear.State.html#spillR"><span class="hs-identifier hs-var">spillR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reg -&gt; Format -&gt; RegWithFormat
</span><a href="GHC.CmmToAsm.Format.html#RegWithFormat"><span class="hs-identifier hs-var">RegWithFormat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealReg -&gt; Reg
</span><a href="GHC.Platform.Reg.html#RegReal"><span class="hs-identifier hs-var">RegReal</span></a></span><span> </span><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852556"><span class="hs-identifier hs-var">my_reg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Format
</span><a href="#local-6989586621682852557"><span class="hs-identifier hs-var">fmt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682852555"><span class="hs-identifier hs-var">temp_to_push_out</span></a></span><span>
</span><span id="line-958"></span><span>
</span><span id="line-959"></span><span>                                </span><span class="hs-comment">-- record that this temp was spilled</span><span>
</span><span id="line-960"></span><span>                                </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#recordSpill"><span class="hs-identifier hs-type">recordSpill</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#SpillAlloc"><span class="hs-identifier hs-type">SpillAlloc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852555"><span class="hs-identifier hs-type">temp_to_push_out</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-961"></span><span>
</span><span id="line-962"></span><span>                                </span><span class="hs-comment">-- update the register assignment</span><span>
</span><span id="line-963"></span><span>                                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682852561"><span class="annot"><a href="#local-6989586621682852561"><span class="hs-identifier hs-var hs-var">assig1</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UniqFM VirtualReg Loc -&gt; Unique -&gt; Loc -&gt; UniqFM VirtualReg Loc
forall {k} (key :: k) elt.
UniqFM key elt -&gt; Unique -&gt; elt -&gt; UniqFM key elt
</span><a href="GHC.Types.Unique.FM.html#addToUFM_Directly"><span class="hs-identifier hs-var">addToUFM_Directly</span></a></span><span> </span><span class="annot"><span class="annottext">UniqFM VirtualReg Loc
</span><a href="#local-6989586621682852519"><span class="hs-identifier hs-var">assig</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682852555"><span class="hs-identifier hs-var">temp_to_push_out</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Loc
</span><a href="GHC.CmmToAsm.Reg.Linear.Base.html#InMem"><span class="hs-identifier hs-var">InMem</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682852559"><span class="hs-identifier hs-var">slot</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-964"></span><span>                                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682852562"><span class="annot"><a href="#local-6989586621682852562"><span class="hs-identifier hs-var hs-var">assig2</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UniqFM VirtualReg Loc -&gt; VirtualReg -&gt; Loc -&gt; UniqFM VirtualReg Loc
forall key elt.
Uniquable key =&gt;
UniqFM key elt -&gt; key -&gt; elt -&gt; UniqFM key elt
</span><a href="GHC.Types.Unique.FM.html#addToUFM"><span class="hs-identifier hs-var">addToUFM</span></a></span><span> </span><span class="annot"><span class="annottext">UniqFM VirtualReg Loc
</span><a href="#local-6989586621682852561"><span class="hs-identifier hs-var">assig1</span></a></span><span> </span><span class="annot"><span class="annottext">VirtualReg
</span><a href="#local-6989586621682852516"><span class="hs-identifier hs-var">vr</span></a></span><span> </span><span class="annot"><span class="annottext">(Loc -&gt; UniqFM VirtualReg Loc) -&gt; Loc -&gt; UniqFM VirtualReg Loc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">SpillLoc -&gt; RealRegUsage -&gt; Loc
</span><a href="GHC.CmmToAsm.Reg.Linear.html#newLocation"><span class="hs-identifier hs-var">newLocation</span></a></span><span> </span><span class="annot"><span class="annottext">SpillLoc
</span><a href="#local-6989586621682852520"><span class="hs-identifier hs-var">spill_loc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealReg -&gt; Format -&gt; RealRegUsage
</span><a href="GHC.CmmToAsm.Reg.Linear.Base.html#RealRegUsage"><span class="hs-identifier hs-var">RealRegUsage</span></a></span><span> </span><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852556"><span class="hs-identifier hs-var">my_reg</span></a></span><span> </span><span class="annot"><span class="annottext">Format
</span><a href="#local-6989586621682852557"><span class="hs-identifier hs-var">fmt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-965"></span><span>                                </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#setAssigR"><span class="hs-identifier hs-type">setAssigR</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Utils.html#toRegMap"><span class="hs-identifier hs-type">toRegMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852562"><span class="hs-identifier hs-type">assig2</span></a></span><span>
</span><span id="line-966"></span><span>
</span><span id="line-967"></span><span>                                </span><span class="hs-comment">-- if need be, load up a spilled temp into the reg we've just freed up.</span><span>
</span><span id="line-968"></span><span>                                </span><span id="local-6989586621682852563"><span class="annot"><a href="#local-6989586621682852563"><span class="hs-identifier hs-var">spills'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#loadTemp"><span class="hs-identifier hs-type">loadTemp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852515"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852520"><span class="hs-identifier hs-type">spill_loc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852556"><span class="hs-identifier hs-type">my_reg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852513"><span class="hs-identifier hs-type">spills</span></a></span><span>
</span><span id="line-969"></span><span>
</span><span id="line-970"></span><span>                                </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#allocateRegsAndSpill"><span class="hs-identifier hs-type">allocateRegsAndSpill</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852511"><span class="hs-identifier hs-type">reading</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852512"><span class="hs-identifier hs-type">keep</span></a></span><span>
</span><span id="line-971"></span><span>                                        </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682852558"><span class="hs-identifier hs-type">spill_store</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621682852563"><span class="hs-identifier hs-type">spills'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-972"></span><span>                                        </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682852556"><span class="hs-identifier hs-type">my_reg</span></a></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><a href="#local-6989586621682852514"><span class="hs-identifier hs-type">alloc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682852518"><span class="hs-identifier hs-type">rs</span></a></span><span>
</span><span id="line-973"></span><span>
</span><span id="line-974"></span><span>
</span><span id="line-975"></span><span>                        </span><span class="hs-comment">-- there wasn't anything to spill, so we're screwed.</span><span>
</span><span id="line-976"></span><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-977"></span><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; RegM freeRegs ([instr], [RealReg])
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;RegAllocLinear.allocRegsAndSpill: no spill candidates\n&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-978"></span><span>                        </span><span class="annot"><span class="annottext">(SDoc -&gt; RegM freeRegs ([instr], [RealReg]))
-&gt; SDoc -&gt; RegM freeRegs ([instr], [RealReg])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span>
</span><span id="line-979"></span><span>                                </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;allocating vreg:  &quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VirtualReg -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">VirtualReg
</span><a href="#local-6989586621682852516"><span class="hs-identifier hs-var">vr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-980"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;assignment:       &quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">UniqFM VirtualReg Loc -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">UniqFM VirtualReg Loc
</span><a href="#local-6989586621682852519"><span class="hs-identifier hs-var">assig</span></a></span><span>
</span><span id="line-981"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;format:           &quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Format -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Format
</span><a href="#local-6989586621682852517"><span class="hs-identifier hs-var">fmt</span></a></span><span>
</span><span id="line-982"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;freeRegs:         &quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">freeRegs -&gt; String
</span><a href="#local-6989586621682852566"><span class="hs-identifier hs-var">showRegs</span></a></span><span> </span><span class="annot"><span class="annottext">freeRegs
</span><a href="#local-6989586621682852522"><span class="hs-identifier hs-var">freeRegs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-983"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;initFreeRegs:     &quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">freeRegs -&gt; String
</span><a href="#local-6989586621682852566"><span class="hs-identifier hs-var">showRegs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Platform -&gt; freeRegs
forall freeRegs. FR freeRegs =&gt; Platform -&gt; freeRegs
</span><a href="GHC.CmmToAsm.Reg.Linear.FreeRegs.html#frInitFreeRegs"><span class="hs-identifier hs-var">frInitFreeRegs</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682852521"><span class="hs-identifier hs-var">platform</span></a></span><span> </span><span class="annot"><span class="annottext">freeRegs -&gt; freeRegs -&gt; freeRegs
forall a. a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`asTypeOf`</span></span><span> </span><span class="annot"><span class="annottext">freeRegs
</span><a href="#local-6989586621682852522"><span class="hs-identifier hs-var">freeRegs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-984"></span><span>                                </span><span class="hs-special">]</span><span>
</span><span id="line-985"></span><span>                        </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621682852566"><span class="annot"><span class="annottext">showRegs :: freeRegs -&gt; String
</span><a href="#local-6989586621682852566"><span class="hs-identifier hs-var hs-var">showRegs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(RealReg, RegClass)] -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">([(RealReg, RegClass)] -&gt; String)
-&gt; (freeRegs -&gt; [(RealReg, RegClass)]) -&gt; freeRegs -&gt; String
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(RealReg -&gt; (RealReg, RegClass))
-&gt; [RealReg] -&gt; [(RealReg, RegClass)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682852568"><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852568"><span class="hs-identifier hs-var">reg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852568"><span class="hs-identifier hs-var">reg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Platform -&gt; RealReg -&gt; RegClass
</span><a href="GHC.CmmToAsm.Reg.Target.html#targetClassOfRealReg"><span class="hs-identifier hs-var">targetClassOfRealReg</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682852521"><span class="hs-identifier hs-var">platform</span></a></span><span> </span><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852568"><span class="hs-identifier hs-var">reg</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([RealReg] -&gt; [(RealReg, RegClass)])
-&gt; (freeRegs -&gt; [RealReg]) -&gt; freeRegs -&gt; [(RealReg, RegClass)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Platform -&gt; freeRegs -&gt; [RealReg]
forall freeRegs. FR freeRegs =&gt; Platform -&gt; freeRegs -&gt; [RealReg]
</span><a href="GHC.CmmToAsm.Reg.Linear.FreeRegs.html#allFreeRegs"><span class="hs-identifier hs-var">allFreeRegs</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682852521"><span class="hs-identifier hs-var">platform</span></a></span><span>
</span><span id="line-986"></span><span>
</span><span id="line-987"></span><span>                </span><span class="annot"><span class="annottext">RegM freeRegs ([instr], [RealReg])
</span><a href="#local-6989586621682852547"><span class="hs-identifier hs-var">result</span></a></span><span>
</span><span id="line-988"></span><span>
</span><span id="line-989"></span><span>
</span><span id="line-990"></span><span class="annot"><span class="hs-comment">-- | Calculate a new location after a register has been loaded.</span></span><span>
</span><span id="line-991"></span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#newLocation"><span class="hs-identifier hs-type">newLocation</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#SpillLoc"><span class="hs-identifier hs-type">SpillLoc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#RealRegUsage"><span class="hs-identifier hs-type">RealRegUsage</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#Loc"><span class="hs-identifier hs-type">Loc</span></a></span><span>
</span><span id="line-992"></span><span class="hs-comment">-- if the tmp was read from a slot, then now its in a reg as well</span><span>
</span><span id="line-993"></span><span id="newLocation"><span class="annot"><span class="annottext">newLocation :: SpillLoc -&gt; RealRegUsage -&gt; Loc
</span><a href="GHC.CmmToAsm.Reg.Linear.html#newLocation"><span class="hs-identifier hs-var hs-var">newLocation</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#ReadMem"><span class="hs-identifier hs-type">ReadMem</span></a></span><span> </span><span id="local-6989586621682852570"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682852570"><span class="hs-identifier hs-var">slot</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682852571"><span class="annot"><span class="annottext">RealRegUsage
</span><a href="#local-6989586621682852571"><span class="hs-identifier hs-var">my_reg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RealRegUsage -&gt; Int -&gt; Loc
</span><a href="GHC.CmmToAsm.Reg.Linear.Base.html#InBoth"><span class="hs-identifier hs-var">InBoth</span></a></span><span> </span><span class="annot"><span class="annottext">RealRegUsage
</span><a href="#local-6989586621682852571"><span class="hs-identifier hs-var">my_reg</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682852570"><span class="hs-identifier hs-var">slot</span></a></span><span>
</span><span id="line-994"></span><span class="hs-comment">-- writes will always result in only the register being available</span><span>
</span><span id="line-995"></span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#newLocation"><span class="hs-identifier hs-var">newLocation</span></a></span><span> </span><span class="annot"><span class="annottext">SpillLoc
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682852572"><span class="annot"><span class="annottext">RealRegUsage
</span><a href="#local-6989586621682852572"><span class="hs-identifier hs-var">my_reg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RealRegUsage -&gt; Loc
</span><a href="GHC.CmmToAsm.Reg.Linear.Base.html#InReg"><span class="hs-identifier hs-var">InReg</span></a></span><span> </span><span class="annot"><span class="annottext">RealRegUsage
</span><a href="#local-6989586621682852572"><span class="hs-identifier hs-var">my_reg</span></a></span><span>
</span><span id="line-996"></span><span>
</span><span id="line-997"></span><span class="annot"><span class="hs-comment">-- | Load up a spilled temporary if we need to (read from memory).</span></span><span>
</span><span id="line-998"></span><span id="local-6989586621682851785"><span id="local-6989586621682851786"><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#loadTemp"><span class="hs-identifier hs-type">loadTemp</span></a></span><span>
</span><span id="line-999"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Instr.html#Instruction"><span class="hs-identifier hs-type">Instruction</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851785"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1000"></span><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Format.html#VirtualRegWithFormat"><span class="hs-identifier hs-type">VirtualRegWithFormat</span></a></span><span>   </span><span class="hs-comment">-- the temp being loaded</span><span>
</span><span id="line-1001"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#SpillLoc"><span class="hs-identifier hs-type">SpillLoc</span></a></span><span>     </span><span class="hs-comment">-- the current location of this temp</span><span>
</span><span id="line-1002"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Platform.Reg.html#RealReg"><span class="hs-identifier hs-type">RealReg</span></a></span><span>      </span><span class="hs-comment">-- the hreg to load the temp into</span><span>
</span><span id="line-1003"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621682851785"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1004"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#RegM"><span class="hs-identifier hs-type">RegM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682851786"><span class="hs-identifier hs-type">freeRegs</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621682851785"><span class="hs-identifier hs-type">instr</span></a></span><span class="hs-special">]</span></span></span><span>
</span><span id="line-1005"></span><span>
</span><span id="line-1006"></span><span id="loadTemp"><span class="annot"><span class="annottext">loadTemp :: forall instr freeRegs.
Instruction instr =&gt;
VirtualRegWithFormat
-&gt; SpillLoc -&gt; RealReg -&gt; [instr] -&gt; RegM freeRegs [instr]
</span><a href="GHC.CmmToAsm.Reg.Linear.html#loadTemp"><span class="hs-identifier hs-var hs-var">loadTemp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Format.html#VirtualRegWithFormat"><span class="hs-identifier hs-type">VirtualRegWithFormat</span></a></span><span> </span><span id="local-6989586621682852580"><span class="annot"><span class="annottext">VirtualReg
</span><a href="#local-6989586621682852580"><span class="hs-identifier hs-var">vreg</span></a></span></span><span> </span><span id="local-6989586621682852581"><span class="annot"><span class="annottext">Format
</span><a href="#local-6989586621682852581"><span class="hs-identifier hs-var">fmt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#ReadMem"><span class="hs-identifier hs-type">ReadMem</span></a></span><span> </span><span id="local-6989586621682852582"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682852582"><span class="hs-identifier hs-var">slot</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682852583"><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852583"><span class="hs-identifier hs-var">hreg</span></a></span></span><span> </span><span id="local-6989586621682852584"><span class="annot"><span class="annottext">[instr]
</span><a href="#local-6989586621682852584"><span class="hs-identifier hs-var">spills</span></a></span></span><span>
</span><span id="line-1007"></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1008"></span><span>        </span><span id="local-6989586621682852585"><span class="annot"><a href="#local-6989586621682852585"><span class="hs-identifier hs-var">insn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RegWithFormat -&gt; Int -&gt; RegM freeRegs [instr]
forall instr freeRegs.
Instruction instr =&gt;
RegWithFormat -&gt; Int -&gt; RegM freeRegs [instr]
</span><a href="GHC.CmmToAsm.Reg.Linear.State.html#loadR"><span class="hs-identifier hs-var">loadR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reg -&gt; Format -&gt; RegWithFormat
</span><a href="GHC.CmmToAsm.Format.html#RegWithFormat"><span class="hs-identifier hs-var">RegWithFormat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealReg -&gt; Reg
</span><a href="GHC.Platform.Reg.html#RegReal"><span class="hs-identifier hs-var">RegReal</span></a></span><span> </span><span class="annot"><span class="annottext">RealReg
</span><a href="#local-6989586621682852583"><span class="hs-identifier hs-var">hreg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Format
</span><a href="#local-6989586621682852581"><span class="hs-identifier hs-var">fmt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682852582"><span class="hs-identifier hs-var">slot</span></a></span><span>
</span><span id="line-1009"></span><span>        </span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.State.html#recordSpill"><span class="hs-identifier hs-type">recordSpill</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.Base.html#SpillLoad"><span class="hs-identifier hs-type">SpillLoad</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Types.Unique.html#getUnique"><span class="hs-identifier hs-type">getUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682852580"><span class="hs-identifier hs-type">vreg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1010"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span>  </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>  </span><span class="hs-comment">{- mkComment (text &quot;spill load&quot;) : -}</span><span> </span><span class="annot"><a href="#local-6989586621682852585"><span class="hs-identifier hs-type">insn</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621682852584"><span class="hs-identifier hs-type">spills</span></a></span><span>
</span><span id="line-1011"></span><span>
</span><span id="line-1012"></span><span class="annot"><a href="GHC.CmmToAsm.Reg.Linear.html#loadTemp"><span class="hs-identifier hs-var">loadTemp</span></a></span><span> </span><span class="annot"><span class="annottext">VirtualRegWithFormat
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SpillLoc
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">RealReg
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682852588"><span class="annot"><span class="annottext">[instr]
</span><a href="#local-6989586621682852588"><span class="hs-identifier hs-var">spills</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1013"></span><span>   </span><span class="annot"><span class="annottext">[instr] -&gt; RegM freeRegs [instr]
forall a. a -&gt; RegM freeRegs a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">[instr]
</span><a href="#local-6989586621682852588"><span class="hs-identifier hs-var">spills</span></a></span><span>
</span><span id="line-1014"></span></pre></body></html>