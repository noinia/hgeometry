<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE MultiWayIf #-}</span><span>
</span><span id="line-3"></span><span>
</span><span id="line-4"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Equality.html"><span class="hs-identifier">GHC.Tc.Solver.Equality</span></a></span><span class="hs-special">(</span><span>
</span><span id="line-5"></span><span>     </span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#solveEquality"><span class="hs-identifier">solveEquality</span></a></span><span>
</span><span id="line-6"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Irred.html"><span class="hs-identifier">GHC.Tc.Solver.Irred</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Irred.html#solveIrred"><span class="hs-identifier">solveIrred</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Dict.html"><span class="hs-identifier">GHC.Tc.Solver.Dict</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Dict.html#matchLocalInst"><span class="hs-identifier">matchLocalInst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Dict.html#chooseInstance"><span class="hs-identifier">chooseInstance</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html"><span class="hs-identifier">GHC.Tc.Solver.Rewrite</span></a></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html"><span class="hs-identifier">GHC.Tc.Solver.Monad</span></a></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.InertSet.html"><span class="hs-identifier">GHC.Tc.Solver.InertSet</span></a></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Types.html"><span class="hs-identifier">GHC.Tc.Solver.Types</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Types.html#findFunEqsByTyCon"><span class="hs-identifier">findFunEqsByTyCon</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html"><span class="hs-identifier">GHC.Tc.Types.Evidence</span></a></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html"><span class="hs-identifier">GHC.Tc.Types.Constraint</span></a></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Types.CtLoc.html"><span class="hs-identifier">GHC.Tc.Types.CtLoc</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html"><span class="hs-identifier">GHC.Tc.Types.Origin</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html"><span class="hs-identifier">GHC.Tc.Utils.Unify</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html"><span class="hs-identifier">GHC.Tc.Utils.TcType</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Instance.Family.html"><span class="hs-identifier">GHC.Tc.Instance.Family</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Tc.Instance.Family.html#tcTopNormaliseNewTypeTF_maybe"><span class="hs-identifier">tcTopNormaliseNewTypeTF_maybe</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Instance.FunDeps.html"><span class="hs-identifier">GHC.Tc.Instance.FunDeps</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Tc.Instance.FunDeps.html#FunDepEqn"><span class="hs-identifier">FunDepEqn</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html"><span class="hs-identifier">GHC.Tc.Utils.Monad</span></a></span><span>    </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TcM</span></span><span>
</span><span id="line-26"></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Type.html"><span class="hs-identifier">GHC.Core.Type</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html"><span class="hs-identifier">GHC.Core.Predicate</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Class.html"><span class="hs-identifier">GHC.Core.Class</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html"><span class="hs-identifier">GHC.Core.DataCon</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#dataConName"><span class="hs-identifier">dataConName</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html"><span class="hs-identifier">GHC.Core.TyCon</span></a></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html"><span class="hs-identifier">GHC.Core.TyCo.Rep</span></a></span><span>   </span><span class="hs-comment">-- cleverly decomposes types, good for completeness checking</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html"><span class="hs-identifier">GHC.Core.Coercion</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html"><span class="hs-identifier">GHC.Core.Coercion.Axiom</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html"><span class="hs-identifier">GHC.Core.Reduction</span></a></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html"><span class="hs-identifier">GHC.Core.Unify</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#tcUnifyTyWithTFs"><span class="hs-identifier">tcUnifyTyWithTFs</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html"><span class="hs-identifier">GHC.Core.FamInstEnv</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier">FamInstEnvs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier">FamInst</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#apartnessCheck"><span class="hs-identifier">apartnessCheck</span></a></span><span>
</span><span id="line-38"></span><span>                           </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#lookupFamInstEnvByTyCon"><span class="hs-identifier">lookupFamInstEnvByTyCon</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.html"><span class="hs-identifier">GHC.Core</span></a></span><span>
</span><span id="line-40"></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.html"><span class="hs-identifier">GHC.Types.Var</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html"><span class="hs-identifier">GHC.Types.Var.Env</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html"><span class="hs-identifier">GHC.Types.Var.Set</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#anyVarSet"><span class="hs-identifier">anyVarSet</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.Reader.html"><span class="hs-identifier">GHC.Types.Name.Reader</span></a></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html"><span class="hs-identifier">GHC.Types.Basic</span></a></span><span>
</span><span id="line-46"></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.Literals.html"><span class="hs-identifier">GHC.Builtin.Types.Literals</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.Literals.html#tryInteractTopFam"><span class="hs-identifier">tryInteractTopFam</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.Literals.html#tryInteractInertFam"><span class="hs-identifier">tryInteractInertFam</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Monad.html"><span class="hs-identifier">GHC.Utils.Monad</span></a></span><span>
</span><span id="line-53"></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Pair.html"><span class="hs-identifier">GHC.Data.Pair</span></a></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Bag.html"><span class="hs-identifier">GHC.Data.Bag</span></a></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.Maybe.html"><span class="hs-identifier">Data.Maybe</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">isJust</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">isNothing</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">zip4</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.Semigroup.html"><span class="hs-identifier">Data.Semigroup</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.Bifunctor.html"><span class="hs-identifier">Data.Bifunctor</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.Bifunctor.html#bimap"><span class="hs-identifier">bimap</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.Void.html"><span class="hs-identifier">Data.Void</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">Void</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span>
</span><span id="line-64"></span><span class="annot"><span class="hs-comment">{- *********************************************************************
*                                                                      *
*        Equalities
*                                                                      *
************************************************************************

Note [Canonicalising equalities]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In order to canonicalise an equality, we look at the structure of the
two types at hand, looking for similarities. A difficulty is that the
types may look dissimilar before rewriting but similar after rewriting.
However, we don't just want to jump in and rewrite right away, because
this might be wasted effort. So, after looking for similarities and failing,
we rewrite and then try again. Of course, we don't want to loop, so we
track whether or not we've already rewritten.

It is conceivable to do a better job at tracking whether or not a type
is rewritten, but this is left as future work. (Mar '15)

Note [Decomposing FunTy]
~~~~~~~~~~~~~~~~~~~~~~~~
can_eq_nc' may attempt to decompose a FunTy that is un-zonked.  This
means that we may very well have a FunTy containing a type of some
unknown kind. For instance, we may have,

    FunTy (a :: k) Int

Where k is a unification variable. So the calls to splitRuntimeRep_maybe may
fail (returning Nothing).  In that case we'll fall through, zonk, and try again.
Zonking should fill the variable k, meaning that decomposition will succeed the
second time around.

Also note that we require the FunTyFlag to match.  This will stop
us decomposing
   (Int -&gt; Bool)  ~  (Show a =&gt; blah)
It's as if we treat (-&gt;) and (=&gt;) as different type constructors, which
indeed they are!
-}</span></span><span>
</span><span id="line-102"></span><span>
</span><span id="line-103"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#solveEquality"><span class="hs-identifier hs-type">solveEquality</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#EqRel"><span class="hs-identifier hs-type">EqRel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-104"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#SolverStage"><span class="hs-identifier hs-type">SolverStage</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Void</span></span><span>
</span><span id="line-105"></span><span id="solveEquality"><span class="annot"><span class="annottext">solveEquality :: CtEvidence -&gt; EqRel -&gt; TcType -&gt; TcType -&gt; SolverStage Void
</span><a href="GHC.Tc.Solver.Equality.html#solveEquality"><span class="hs-identifier hs-var hs-var">solveEquality</span></a></span></span><span> </span><span id="local-6989586621683043158"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043158"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683043159"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043159"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span id="local-6989586621683043160"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043160"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683043161"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043161"><span class="hs-identifier hs-var">ty2</span></a></span></span><span>
</span><span id="line-106"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span id="local-6989586621683043163"><span class="annot"><a href="#local-6989586621683043163"><span class="hs-identifier hs-var">ty1'</span></a></span></span><span> </span><span id="local-6989586621683043164"><span class="annot"><a href="#local-6989586621683043164"><span class="hs-identifier hs-var">ty2'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; EqRel -&gt; TcType -&gt; TcType -&gt; SolverStage TypeEqn
</span><a href="GHC.Tc.Solver.Equality.html#zonkEqTypes"><span class="hs-identifier hs-var">zonkEqTypes</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043158"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043159"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043160"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043161"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-107"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683043166"><span class="annot"><a href="#local-6989586621683043166"><span class="hs-identifier hs-var">mb_canon</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#canonicaliseEquality"><span class="hs-identifier hs-type">canonicaliseEquality</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043158"><span class="hs-identifier hs-type">ev</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043159"><span class="hs-identifier hs-type">eq_rel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043163"><span class="hs-identifier hs-type">ty1'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043164"><span class="hs-identifier hs-type">ty2'</span></a></span><span>
</span><span id="line-108"></span><span>
</span><span id="line-109"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683043166"><span class="hs-identifier hs-type">mb_canon</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-110"></span><span>
</span><span id="line-111"></span><span>            </span><span class="hs-comment">-- An IrredCt equality may be insoluble; but maybe not!</span><span>
</span><span id="line-112"></span><span>            </span><span class="hs-comment">-- E.g.  m a ~R# m b  is not canonical, but may be</span><span>
</span><span id="line-113"></span><span>            </span><span class="hs-comment">--       solved by a quantified constraint (T15290)</span><span>
</span><span id="line-114"></span><span>            </span><span class="hs-comment">-- See Note [Looking up primitive equalities in quantified constraints]</span><span>
</span><span id="line-115"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621683043168"><span class="annot"><span class="annottext">IrredCt
</span><a href="#local-6989586621683043168"><span class="hs-identifier hs-var">irred_ct</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">IrredCt -&gt; SolverStage ()
</span><a href="GHC.Tc.Solver.Equality.html#tryQCsIrredEqCt"><span class="hs-identifier hs-var">tryQCsIrredEqCt</span></a></span><span> </span><span class="annot"><span class="annottext">IrredCt
</span><a href="#local-6989586621683043168"><span class="hs-identifier hs-var">irred_ct</span></a></span><span>
</span><span id="line-116"></span><span>                                </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">IrredCt -&gt; SolverStage Void
</span><a href="GHC.Tc.Solver.Irred.html#solveIrred"><span class="hs-identifier hs-var">solveIrred</span></a></span><span> </span><span class="annot"><span class="annottext">IrredCt
</span><a href="#local-6989586621683043168"><span class="hs-identifier hs-var">irred_ct</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>
</span><span id="line-117"></span><span>
</span><span id="line-118"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621683043170"><span class="annot"><span class="annottext">EqCt
</span><a href="#local-6989586621683043170"><span class="hs-identifier hs-var">eq_ct</span></a></span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">EqCt -&gt; SolverStage ()
</span><a href="GHC.Tc.Solver.Equality.html#tryInertEqs"><span class="hs-identifier hs-var">tryInertEqs</span></a></span><span> </span><span class="annot"><span class="annottext">EqCt
</span><a href="#local-6989586621683043170"><span class="hs-identifier hs-var">eq_ct</span></a></span><span>
</span><span id="line-119"></span><span>                                </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; EqCt -&gt; SolverStage ()
</span><a href="GHC.Tc.Solver.Equality.html#tryFunDeps"><span class="hs-identifier hs-var">tryFunDeps</span></a></span><span>  </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043159"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">EqCt
</span><a href="#local-6989586621683043170"><span class="hs-identifier hs-var">eq_ct</span></a></span><span>
</span><span id="line-120"></span><span>                                </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">EqCt -&gt; SolverStage ()
</span><a href="GHC.Tc.Solver.Equality.html#tryQCsEqCt"><span class="hs-identifier hs-var">tryQCsEqCt</span></a></span><span>  </span><span class="annot"><span class="annottext">EqCt
</span><a href="#local-6989586621683043170"><span class="hs-identifier hs-var">eq_ct</span></a></span><span>
</span><span id="line-121"></span><span>                                </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">TcS () -&gt; SolverStage ()
forall a. TcS a -&gt; SolverStage a
</span><a href="GHC.Tc.Solver.Monad.html#simpleStage"><span class="hs-identifier hs-var">simpleStage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EqCt -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Equality.html#updInertEqs"><span class="hs-identifier hs-var">updInertEqs</span></a></span><span> </span><span class="annot"><span class="annottext">EqCt
</span><a href="#local-6989586621683043170"><span class="hs-identifier hs-var">eq_ct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-122"></span><span>                                </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; String -&gt; SolverStage Void
forall a. CtEvidence -&gt; String -&gt; SolverStage a
</span><a href="GHC.Tc.Solver.Monad.html#stopWithStage"><span class="hs-identifier hs-var">stopWithStage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EqCt -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#eqCtEvidence"><span class="hs-identifier hs-var">eqCtEvidence</span></a></span><span> </span><span class="annot"><span class="annottext">EqCt
</span><a href="#local-6989586621683043170"><span class="hs-identifier hs-var">eq_ct</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Kept inert EqCt&quot;</span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-123"></span><span>
</span><span id="line-124"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#updInertEqs"><span class="hs-identifier hs-type">updInertEqs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-125"></span><span id="updInertEqs"><span class="annot"><span class="annottext">updInertEqs :: EqCt -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Equality.html#updInertEqs"><span class="hs-identifier hs-var hs-var">updInertEqs</span></a></span></span><span> </span><span id="local-6989586621683043178"><span class="annot"><span class="annottext">EqCt
</span><a href="#local-6989586621683043178"><span class="hs-identifier hs-var">eq_ct</span></a></span></span><span>
</span><span id="line-126"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">KickOutSpec -&gt; CtFlavourRole -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#kickOutRewritable"><span class="hs-identifier hs-var">kickOutRewritable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanEqLHS -&gt; KickOutSpec
</span><a href="GHC.Tc.Solver.InertSet.html#KOAfterAdding"><span class="hs-identifier hs-var">KOAfterAdding</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EqCt -&gt; CanEqLHS
</span><a href="GHC.Tc.Types.Constraint.html#eqCtLHS"><span class="hs-identifier hs-var">eqCtLHS</span></a></span><span> </span><span class="annot"><span class="annottext">EqCt
</span><a href="#local-6989586621683043178"><span class="hs-identifier hs-var">eq_ct</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EqCt -&gt; CtFlavourRole
</span><a href="GHC.Tc.Types.Constraint.html#eqCtFlavourRole"><span class="hs-identifier hs-var">eqCtFlavourRole</span></a></span><span> </span><span class="annot"><span class="annottext">EqCt
</span><a href="#local-6989586621683043178"><span class="hs-identifier hs-var">eq_ct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-127"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683043183"><span class="annot"><a href="#local-6989586621683043183"><span class="hs-identifier hs-var">tc_lvl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS TcLevel
</span><a href="GHC.Tc.Solver.Monad.html#getTcLevel"><span class="hs-identifier hs-var">getTcLevel</span></a></span><span>
</span><span id="line-128"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#updInertCans"><span class="hs-identifier hs-type">updInertCans</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.InertSet.html#addEqToCans"><span class="hs-identifier hs-type">addEqToCans</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043183"><span class="hs-identifier hs-type">tc_lvl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043178"><span class="hs-identifier hs-type">eq_ct</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-129"></span><span>
</span><span id="line-130"></span><span>
</span><span id="line-131"></span><span class="annot"><span class="hs-comment">{- *********************************************************************
*                                                                      *
*           zonkEqTypes
*                                                                      *
********************************************************************* -}</span></span><span>
</span><span id="line-136"></span><span>
</span><span id="line-137"></span><span class="hs-comment">---------------------------------</span><span>
</span><span id="line-138"></span><span class="hs-comment">-- | Compare types for equality, while zonking as necessary. Gives up</span><span>
</span><span id="line-139"></span><span class="hs-comment">-- as soon as it finds that two types are not equal.</span><span>
</span><span id="line-140"></span><span class="hs-comment">-- This is quite handy when some unification has made two</span><span>
</span><span id="line-141"></span><span class="hs-comment">-- types in an inert Wanted to be equal. We can discover the equality without</span><span>
</span><span id="line-142"></span><span class="hs-comment">-- rewriting, which is sometimes very expensive (in the case of type functions).</span><span>
</span><span id="line-143"></span><span class="hs-comment">-- In particular, this function makes a ~20% improvement in test case</span><span>
</span><span id="line-144"></span><span class="hs-comment">-- perf/compiler/T5030.</span><span>
</span><span id="line-145"></span><span class="hs-comment">--</span><span>
</span><span id="line-146"></span><span class="hs-comment">-- Returns either the (partially zonked) types in the case of</span><span>
</span><span id="line-147"></span><span class="hs-comment">-- inequality, or the one type in the case of equality. canEqReflexive is</span><span>
</span><span id="line-148"></span><span class="hs-comment">-- a good next step in the 'Right' case. Returning 'Left' is always safe.</span><span>
</span><span id="line-149"></span><span class="hs-comment">--</span><span>
</span><span id="line-150"></span><span class="hs-comment">-- NB: This does *not* look through type synonyms. In fact, it treats type</span><span>
</span><span id="line-151"></span><span class="hs-comment">-- synonyms as rigid constructors. In the future, it might be convenient</span><span>
</span><span id="line-152"></span><span class="hs-comment">-- to look at only those arguments of type synonyms that actually appear</span><span>
</span><span id="line-153"></span><span class="hs-comment">-- in the synonym RHS. But we're not there yet.</span><span>
</span><span id="line-154"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#zonkEqTypes"><span class="hs-identifier hs-type">zonkEqTypes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#EqRel"><span class="hs-identifier hs-type">EqRel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#SolverStage"><span class="hs-identifier hs-type">SolverStage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-155"></span><span id="zonkEqTypes"><span class="annot"><span class="annottext">zonkEqTypes :: CtEvidence -&gt; EqRel -&gt; TcType -&gt; TcType -&gt; SolverStage TypeEqn
</span><a href="GHC.Tc.Solver.Equality.html#zonkEqTypes"><span class="hs-identifier hs-var hs-var">zonkEqTypes</span></a></span></span><span> </span><span id="local-6989586621683043187"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043187"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683043188"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043188"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span id="local-6989586621683043189"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043189"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683043190"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043190"><span class="hs-identifier hs-var">ty2</span></a></span></span><span>
</span><span id="line-156"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcS (StopOrContinue TypeEqn) -&gt; SolverStage TypeEqn
forall a. TcS (StopOrContinue a) -&gt; SolverStage a
</span><a href="GHC.Tc.Solver.Monad.html#Stage"><span class="hs-identifier hs-var">Stage</span></a></span><span> </span><span class="annot"><span class="annottext">(TcS (StopOrContinue TypeEqn) -&gt; SolverStage TypeEqn)
-&gt; TcS (StopOrContinue TypeEqn) -&gt; SolverStage TypeEqn
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683043192"><span class="annot"><a href="#local-6989586621683043192"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TcS (Either TypeEqn TcType)
</span><a href="#local-6989586621683043193"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043189"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043190"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-157"></span><span>               </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683043192"><span class="hs-identifier hs-type">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-158"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621683043194"><span class="annot"><span class="annottext">TypeEqn
</span><a href="#local-6989586621683043194"><span class="hs-identifier hs-var">pair</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TypeEqn -&gt; TcS (StopOrContinue TypeEqn)
forall a. a -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Monad.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a></span><span> </span><span class="annot"><span class="annottext">TypeEqn
</span><a href="#local-6989586621683043194"><span class="hs-identifier hs-var">pair</span></a></span><span>
</span><span id="line-159"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621683043196"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043196"><span class="hs-identifier hs-var">ty</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; EqRel -&gt; TcType -&gt; TcS (StopOrContinue TypeEqn)
forall a. CtEvidence -&gt; EqRel -&gt; TcType -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Equality.html#canEqReflexive"><span class="hs-identifier hs-var">canEqReflexive</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043187"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043188"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043196"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-160"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-161"></span><span>    </span><span class="annot"><a href="#local-6989586621683043193"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-162"></span><span>    </span><span id="local-6989586621683043193"><span class="annot"><span class="annottext">go :: TcType -&gt; TcType -&gt; TcS (Either TypeEqn TcType)
</span><a href="#local-6989586621683043193"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyVarTy"><span class="hs-identifier hs-type">TyVarTy</span></a></span><span> </span><span id="local-6989586621683043199"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043199"><span class="hs-identifier hs-var">tv1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyVarTy"><span class="hs-identifier hs-type">TyVarTy</span></a></span><span> </span><span id="local-6989586621683043200"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043200"><span class="hs-identifier hs-var">tv2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcTyVar -&gt; TcS (Either TypeEqn TcType)
</span><a href="#local-6989586621683043201"><span class="hs-identifier hs-var">tyvar_tyvar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043199"><span class="hs-identifier hs-var">tv1</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043200"><span class="hs-identifier hs-var">tv2</span></a></span><span>
</span><span id="line-163"></span><span>    </span><span class="annot"><a href="#local-6989586621683043193"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyVarTy"><span class="hs-identifier hs-type">TyVarTy</span></a></span><span> </span><span id="local-6989586621683043202"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043202"><span class="hs-identifier hs-var">tv1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621683043203"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043203"><span class="hs-identifier hs-var">ty2</span></a></span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SwapFlag -&gt; TcTyVar -&gt; TcType -&gt; TcS (Either TypeEqn TcType)
</span><a href="#local-6989586621683043204"><span class="hs-identifier hs-var">tyvar</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#NotSwapped"><span class="hs-identifier hs-var">NotSwapped</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043202"><span class="hs-identifier hs-var">tv1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043203"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-164"></span><span>    </span><span class="annot"><a href="#local-6989586621683043193"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683043206"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043206"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyVarTy"><span class="hs-identifier hs-type">TyVarTy</span></a></span><span> </span><span id="local-6989586621683043207"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043207"><span class="hs-identifier hs-var">tv2</span></a></span></span><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SwapFlag -&gt; TcTyVar -&gt; TcType -&gt; TcS (Either TypeEqn TcType)
</span><a href="#local-6989586621683043204"><span class="hs-identifier hs-var">tyvar</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#IsSwapped"><span class="hs-identifier hs-var">IsSwapped</span></a></span><span>  </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043207"><span class="hs-identifier hs-var">tv2</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043206"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-165"></span><span>
</span><span id="line-166"></span><span>    </span><span class="hs-comment">-- We handle FunTys explicitly here despite the fact that they could also be</span><span>
</span><span id="line-167"></span><span>    </span><span class="hs-comment">-- treated as an application. Why? Well, for one it's cheaper to just look</span><span>
</span><span id="line-168"></span><span>    </span><span class="hs-comment">-- at two types (the argument and result types) than four (the argument,</span><span>
</span><span id="line-169"></span><span>    </span><span class="hs-comment">-- result, and their RuntimeReps). Also, we haven't completely zonked yet,</span><span>
</span><span id="line-170"></span><span>    </span><span class="hs-comment">-- so we may run into an unzonked type variable while trying to compute the</span><span>
</span><span id="line-171"></span><span>    </span><span class="hs-comment">-- RuntimeReps of the argument and result types. This can be observed in</span><span>
</span><span id="line-172"></span><span>    </span><span class="hs-comment">-- testcase tc269.</span><span>
</span><span id="line-173"></span><span>    </span><span class="annot"><a href="#local-6989586621683043193"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#FunTy"><span class="hs-identifier hs-type">FunTy</span></a></span><span> </span><span id="local-6989586621683043210"><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683043210"><span class="hs-identifier hs-var">af1</span></a></span></span><span> </span><span id="local-6989586621683043211"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043211"><span class="hs-identifier hs-var">w1</span></a></span></span><span> </span><span id="local-6989586621683043212"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043212"><span class="hs-identifier hs-var">arg1</span></a></span></span><span> </span><span id="local-6989586621683043213"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043213"><span class="hs-identifier hs-var">res1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#FunTy"><span class="hs-identifier hs-type">FunTy</span></a></span><span> </span><span id="local-6989586621683043214"><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683043214"><span class="hs-identifier hs-var">af2</span></a></span></span><span> </span><span id="local-6989586621683043215"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043215"><span class="hs-identifier hs-var">w2</span></a></span></span><span> </span><span id="local-6989586621683043216"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043216"><span class="hs-identifier hs-var">arg2</span></a></span></span><span> </span><span id="local-6989586621683043217"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043217"><span class="hs-identifier hs-var">res2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683043210"><span class="hs-identifier hs-var">af1</span></a></span><span> </span><span class="annot"><span class="annottext">FunTyFlag -&gt; FunTyFlag -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683043214"><span class="hs-identifier hs-var">af2</span></a></span><span>
</span><span id="line-175"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; TcType -&gt; TcType -&gt; Bool
TcType -&gt; TcType -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#eqType"><span class="hs-identifier hs-var">eqType</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043211"><span class="hs-identifier hs-var">w1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043215"><span class="hs-identifier hs-var">w2</span></a></span><span>
</span><span id="line-176"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683043219"><span class="annot"><a href="#local-6989586621683043219"><span class="hs-identifier hs-var">res_a</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TcS (Either TypeEqn TcType)
</span><a href="#local-6989586621683043193"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043212"><span class="hs-identifier hs-var">arg1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043216"><span class="hs-identifier hs-var">arg2</span></a></span><span>
</span><span id="line-177"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683043220"><span class="annot"><a href="#local-6989586621683043220"><span class="hs-identifier hs-var">res_b</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621683043193"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043213"><span class="hs-identifier hs-type">res1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043217"><span class="hs-identifier hs-type">res2</span></a></span><span>
</span><span id="line-178"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621683043221"><span class="hs-identifier hs-type">combine_rev</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#FunTy"><span class="hs-identifier hs-type">FunTy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043210"><span class="hs-identifier hs-type">af1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043211"><span class="hs-identifier hs-type">w1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683043220"><span class="hs-identifier hs-type">res_b</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043219"><span class="hs-identifier hs-type">res_a</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-179"></span><span>
</span><span id="line-180"></span><span>    </span><span class="annot"><a href="#local-6989586621683043193"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683043222"><span class="annot"><span class="annottext">ty1 :: TcType
</span><a href="#local-6989586621683043222"><span class="hs-identifier hs-var">ty1</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#FunTy"><span class="hs-identifier hs-type">FunTy</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621683043223"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043223"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TcS (Either TypeEqn TcType)
forall {m :: * -&gt; *} {a} {b}.
Monad m =&gt;
a -&gt; a -&gt; m (Either (Pair a) b)
</span><a href="#local-6989586621683043224"><span class="hs-identifier hs-var">bale_out</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043222"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043223"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-181"></span><span>    </span><span class="annot"><a href="#local-6989586621683043193"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683043225"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043225"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683043226"><span class="annot"><span class="annottext">ty2 :: TcType
</span><a href="#local-6989586621683043226"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#FunTy"><span class="hs-identifier hs-type">FunTy</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TcS (Either TypeEqn TcType)
forall {m :: * -&gt; *} {a} {b}.
Monad m =&gt;
a -&gt; a -&gt; m (Either (Pair a) b)
</span><a href="#local-6989586621683043224"><span class="hs-identifier hs-var">bale_out</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043225"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043226"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-182"></span><span>
</span><span id="line-183"></span><span>    </span><span class="annot"><a href="#local-6989586621683043193"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683043227"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043227"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683043228"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043228"><span class="hs-identifier hs-var">ty2</span></a></span></span><span>
</span><span id="line-184"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043229"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043229"><span class="hs-identifier hs-var">tc1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043230"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043230"><span class="hs-identifier hs-var">tys1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; TcType -&gt; Maybe (TyCon, [TcType])
TcType -&gt; Maybe (TyCon, [TcType])
</span><a href="GHC.Core.Type.html#splitTyConAppNoView_maybe"><span class="hs-identifier hs-var">splitTyConAppNoView_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043227"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-185"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043232"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043232"><span class="hs-identifier hs-var">tc2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043233"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043233"><span class="hs-identifier hs-var">tys2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; TcType -&gt; Maybe (TyCon, [TcType])
TcType -&gt; Maybe (TyCon, [TcType])
</span><a href="GHC.Core.Type.html#splitTyConAppNoView_maybe"><span class="hs-identifier hs-var">splitTyConAppNoView_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043228"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-186"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043229"><span class="hs-identifier hs-var">tc1</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; TyCon -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043232"><span class="hs-identifier hs-var">tc2</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043230"><span class="hs-identifier hs-var">tys1</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; [TcType] -&gt; Bool
forall a b. [a] -&gt; [b] -&gt; Bool
</span><a href="GHC.Utils.Misc.html#equalLength"><span class="hs-operator hs-var">`equalLength`</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043233"><span class="hs-identifier hs-var">tys2</span></a></span><span>
</span><span id="line-187"></span><span>          </span><span class="hs-comment">-- Crucial to check for equal-length args, because</span><span>
</span><span id="line-188"></span><span>          </span><span class="hs-comment">-- we cannot assume that the two args to 'go' have</span><span>
</span><span id="line-189"></span><span>          </span><span class="hs-comment">-- the same kind.  E.g go (Proxy *      (Maybe Int))</span><span>
</span><span id="line-190"></span><span>          </span><span class="hs-comment">--                        (Proxy (*-&gt;*) Maybe)</span><span>
</span><span id="line-191"></span><span>          </span><span class="hs-comment">-- We'll call (go (Maybe Int) Maybe)</span><span>
</span><span id="line-192"></span><span>          </span><span class="hs-comment">-- See #13083</span><span>
</span><span id="line-193"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [TcType] -&gt; [TcType] -&gt; TcS (Either TypeEqn TcType)
</span><a href="#local-6989586621683043236"><span class="hs-identifier hs-var">tycon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043229"><span class="hs-identifier hs-var">tc1</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043230"><span class="hs-identifier hs-var">tys1</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043233"><span class="hs-identifier hs-var">tys2</span></a></span><span>
</span><span id="line-194"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TcS (Either TypeEqn TcType)
forall {m :: * -&gt; *} {a} {b}.
Monad m =&gt;
a -&gt; a -&gt; m (Either (Pair a) b)
</span><a href="#local-6989586621683043224"><span class="hs-identifier hs-var">bale_out</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043227"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043228"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-195"></span><span>
</span><span id="line-196"></span><span>    </span><span class="annot"><a href="#local-6989586621683043193"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683043237"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043237"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683043238"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043238"><span class="hs-identifier hs-var">ty2</span></a></span></span><span>
</span><span id="line-197"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043239"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043239"><span class="hs-identifier hs-var">ty1a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043240"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043240"><span class="hs-identifier hs-var">ty1b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe (TcType, TcType)
</span><a href="GHC.Core.Type.html#tcSplitAppTyNoView_maybe"><span class="hs-identifier hs-var">tcSplitAppTyNoView_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043237"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-198"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043242"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043242"><span class="hs-identifier hs-var">ty2a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043243"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043243"><span class="hs-identifier hs-var">ty2b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe (TcType, TcType)
</span><a href="GHC.Core.Type.html#tcSplitAppTyNoView_maybe"><span class="hs-identifier hs-var">tcSplitAppTyNoView_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043238"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-199"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683043244"><span class="annot"><a href="#local-6989586621683043244"><span class="hs-identifier hs-var">res_a</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TcS (Either TypeEqn TcType)
</span><a href="#local-6989586621683043193"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043239"><span class="hs-identifier hs-var">ty1a</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043242"><span class="hs-identifier hs-var">ty2a</span></a></span><span>
</span><span id="line-200"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683043245"><span class="annot"><a href="#local-6989586621683043245"><span class="hs-identifier hs-var">res_b</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621683043193"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043240"><span class="hs-identifier hs-type">ty1b</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043243"><span class="hs-identifier hs-type">ty2b</span></a></span><span>
</span><span id="line-201"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621683043221"><span class="hs-identifier hs-type">combine_rev</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Type.html#mkAppTy"><span class="hs-identifier hs-type">mkAppTy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043245"><span class="hs-identifier hs-type">res_b</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043244"><span class="hs-identifier hs-type">res_a</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-202"></span><span>
</span><span id="line-203"></span><span>    </span><span class="annot"><a href="#local-6989586621683043193"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683043247"><span class="annot"><span class="annottext">ty1 :: TcType
</span><a href="#local-6989586621683043247"><span class="hs-identifier hs-var">ty1</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#LitTy"><span class="hs-identifier hs-type">LitTy</span></a></span><span> </span><span id="local-6989586621683043249"><span class="annot"><span class="annottext">TyLit
</span><a href="#local-6989586621683043249"><span class="hs-identifier hs-var">lit1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#LitTy"><span class="hs-identifier hs-type">LitTy</span></a></span><span> </span><span id="local-6989586621683043250"><span class="annot"><span class="annottext">TyLit
</span><a href="#local-6989586621683043250"><span class="hs-identifier hs-var">lit2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-204"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyLit
</span><a href="#local-6989586621683043249"><span class="hs-identifier hs-var">lit1</span></a></span><span> </span><span class="annot"><span class="annottext">TyLit -&gt; TyLit -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TyLit
</span><a href="#local-6989586621683043250"><span class="hs-identifier hs-var">lit2</span></a></span><span>
</span><span id="line-205"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Either TypeEqn TcType -&gt; TcS (Either TypeEqn TcType)
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; Either TypeEqn TcType
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043247"><span class="hs-identifier hs-var">ty1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-206"></span><span>
</span><span id="line-207"></span><span>    </span><span class="annot"><a href="#local-6989586621683043193"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683043251"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043251"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683043252"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043252"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TcS (Either TypeEqn TcType)
forall {m :: * -&gt; *} {a} {b}.
Monad m =&gt;
a -&gt; a -&gt; m (Either (Pair a) b)
</span><a href="#local-6989586621683043224"><span class="hs-identifier hs-var">bale_out</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043251"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043252"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-208"></span><span>      </span><span class="hs-comment">-- We don't handle more complex forms here</span><span>
</span><span id="line-209"></span><span>
</span><span id="line-210"></span><span>    </span><span id="local-6989586621683043224"><span class="annot"><span class="annottext">bale_out :: a -&gt; a -&gt; m (Either (Pair a) b)
</span><a href="#local-6989586621683043224"><span class="hs-identifier hs-var hs-var">bale_out</span></a></span></span><span> </span><span id="local-6989586621683043261"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683043261"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683043262"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683043262"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Either (Pair a) b -&gt; m (Either (Pair a) b)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Either (Pair a) b -&gt; m (Either (Pair a) b))
-&gt; Either (Pair a) b -&gt; m (Either (Pair a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pair a -&gt; Either (Pair a) b
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; a -&gt; Pair a
forall a. a -&gt; a -&gt; Pair a
</span><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683043261"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683043262"><span class="hs-identifier hs-var">ty2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-211"></span><span>
</span><span id="line-212"></span><span>    </span><span class="annot"><a href="#local-6989586621683043204"><span class="hs-identifier hs-type">tyvar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SwapFlag"><span class="hs-identifier hs-type">SwapFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>
</span><span id="line-213"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-214"></span><span>      </span><span class="hs-comment">-- Try to do as little as possible, as anything we do here is redundant</span><span>
</span><span id="line-215"></span><span>      </span><span class="hs-comment">-- with rewriting. In particular, no need to zonk kinds. That's why</span><span>
</span><span id="line-216"></span><span>      </span><span class="hs-comment">-- we don't use the already-defined zonking functions</span><span>
</span><span id="line-217"></span><span>    </span><span id="local-6989586621683043204"><span class="annot"><span class="annottext">tyvar :: SwapFlag -&gt; TcTyVar -&gt; TcType -&gt; TcS (Either TypeEqn TcType)
</span><a href="#local-6989586621683043204"><span class="hs-identifier hs-var hs-var">tyvar</span></a></span></span><span> </span><span id="local-6989586621683043263"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683043263"><span class="hs-identifier hs-var">swapped</span></a></span></span><span> </span><span id="local-6989586621683043264"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043264"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span id="local-6989586621683043265"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043265"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-218"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcTyVarDetails
</span><a href="GHC.Types.Var.html#tcTyVarDetails"><span class="hs-identifier hs-var">tcTyVarDetails</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043264"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-219"></span><span>          </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#MetaTv"><span class="hs-identifier hs-type">MetaTv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mtv_ref :: TcTyVarDetails -&gt; IORef MetaDetails
</span><a href="GHC.Tc.Utils.TcType.html#mtv_ref"><span class="hs-identifier hs-var">mtv_ref</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683043269"><span class="annot"><span class="annottext">IORef MetaDetails
</span><a href="#local-6989586621683043269"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-220"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683043270"><span class="annot"><a href="#local-6989586621683043270"><span class="hs-identifier hs-var">cts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef MetaDetails -&gt; TcS MetaDetails
forall a. TcRef a -&gt; TcS a
</span><a href="GHC.Tc.Solver.Monad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a></span><span> </span><span class="annot"><span class="annottext">IORef MetaDetails
</span><a href="#local-6989586621683043269"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-221"></span><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683043270"><span class="hs-identifier hs-type">cts</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-222"></span><span>                      </span><span class="annot"><span class="annottext">MetaDetails
</span><a href="GHC.Tc.Utils.TcType.html#Flexi"><span class="hs-identifier hs-var">Flexi</span></a></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcS (Either TypeEqn TcType)
</span><a href="#local-6989586621683043273"><span class="hs-identifier hs-var">give_up</span></a></span><span>
</span><span id="line-223"></span><span>                      </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#Indirect"><span class="hs-identifier hs-type">Indirect</span></a></span><span> </span><span id="local-6989586621683043275"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043275"><span class="hs-identifier hs-var">ty'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType -&gt; TcS ()
forall {a} {a}. (Outputable a, Outputable a) =&gt; a -&gt; a -&gt; TcS ()
</span><a href="#local-6989586621683043276"><span class="hs-identifier hs-var">trace_indirect</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043264"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043275"><span class="hs-identifier hs-var">ty'</span></a></span><span>
</span><span id="line-224"></span><span>                                         </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">SwapFlag
-&gt; (TcType -&gt; TcType -&gt; TcS (Either TypeEqn TcType))
-&gt; TcType
-&gt; TcType
-&gt; TcS (Either TypeEqn TcType)
forall a b. SwapFlag -&gt; (a -&gt; a -&gt; b) -&gt; a -&gt; a -&gt; b
</span><a href="GHC.Types.Basic.html#unSwap"><span class="hs-identifier hs-var">unSwap</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683043263"><span class="hs-identifier hs-var">swapped</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TcS (Either TypeEqn TcType)
</span><a href="#local-6989586621683043193"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043275"><span class="hs-identifier hs-var">ty'</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043265"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-225"></span><span>          </span><span class="annot"><span class="annottext">TcTyVarDetails
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcS (Either TypeEqn TcType)
</span><a href="#local-6989586621683043273"><span class="hs-identifier hs-var">give_up</span></a></span><span>
</span><span id="line-226"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-227"></span><span>        </span><span id="local-6989586621683043273"><span class="annot"><span class="annottext">give_up :: TcS (Either TypeEqn TcType)
</span><a href="#local-6989586621683043273"><span class="hs-identifier hs-var hs-var">give_up</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Either TypeEqn TcType -&gt; TcS (Either TypeEqn TcType)
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Either TypeEqn TcType -&gt; TcS (Either TypeEqn TcType))
-&gt; Either TypeEqn TcType -&gt; TcS (Either TypeEqn TcType)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TypeEqn -&gt; Either TypeEqn TcType
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">(TypeEqn -&gt; Either TypeEqn TcType)
-&gt; TypeEqn -&gt; Either TypeEqn TcType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SwapFlag
-&gt; (TcType -&gt; TcType -&gt; TypeEqn) -&gt; TcType -&gt; TcType -&gt; TypeEqn
forall a b. SwapFlag -&gt; (a -&gt; a -&gt; b) -&gt; a -&gt; a -&gt; b
</span><a href="GHC.Types.Basic.html#unSwap"><span class="hs-identifier hs-var">unSwap</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683043263"><span class="hs-identifier hs-var">swapped</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TypeEqn
forall a. a -&gt; a -&gt; Pair a
</span><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043264"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043265"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-228"></span><span>
</span><span id="line-229"></span><span>    </span><span id="local-6989586621683043201"><span class="annot"><span class="annottext">tyvar_tyvar :: TcTyVar -&gt; TcTyVar -&gt; TcS (Either TypeEqn TcType)
</span><a href="#local-6989586621683043201"><span class="hs-identifier hs-var hs-var">tyvar_tyvar</span></a></span></span><span> </span><span id="local-6989586621683043285"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043285"><span class="hs-identifier hs-var">tv1</span></a></span></span><span> </span><span id="local-6989586621683043286"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043286"><span class="hs-identifier hs-var">tv2</span></a></span></span><span>
</span><span id="line-230"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043285"><span class="hs-identifier hs-var">tv1</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcTyVar -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043286"><span class="hs-identifier hs-var">tv2</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Either TypeEqn TcType -&gt; TcS (Either TypeEqn TcType)
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; Either TypeEqn TcType
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043285"><span class="hs-identifier hs-var">tv1</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-231"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043287"><span class="annot"><a href="#local-6989586621683043287"><span class="hs-identifier hs-var">ty1'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043288"><span class="annot"><a href="#local-6989586621683043288"><span class="hs-identifier hs-var">progress1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcS (TcType, Bool)
</span><a href="#local-6989586621683043289"><span class="hs-identifier hs-var">quick_zonk</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043285"><span class="hs-identifier hs-var">tv1</span></a></span><span>
</span><span id="line-232"></span><span>                        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043290"><span class="annot"><a href="#local-6989586621683043290"><span class="hs-identifier hs-var">ty2'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043291"><span class="annot"><a href="#local-6989586621683043291"><span class="hs-identifier hs-var">progress2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621683043289"><span class="hs-identifier hs-type">quick_zonk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043286"><span class="hs-identifier hs-type">tv2</span></a></span><span>
</span><span id="line-233"></span><span>                        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621683043288"><span class="hs-identifier hs-type">progress1</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">||</span></span><span> </span><span class="annot"><a href="#local-6989586621683043291"><span class="hs-identifier hs-type">progress2</span></a></span><span>
</span><span id="line-234"></span><span>                          </span><span class="hs-keyword">then</span><span> </span><span class="annot"><a href="#local-6989586621683043193"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043287"><span class="hs-identifier hs-type">ty1'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043290"><span class="hs-identifier hs-type">ty2'</span></a></span><span>
</span><span id="line-235"></span><span>                          </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyVarTy"><span class="hs-identifier hs-type">TyVarTy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043285"><span class="hs-identifier hs-type">tv1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyVarTy"><span class="hs-identifier hs-type">TyVarTy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043286"><span class="hs-identifier hs-type">tv2</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-236"></span><span>
</span><span id="line-237"></span><span>    </span><span id="local-6989586621683043276"><span class="annot"><span class="annottext">trace_indirect :: a -&gt; a -&gt; TcS ()
</span><a href="#local-6989586621683043276"><span class="hs-identifier hs-var hs-var">trace_indirect</span></a></span></span><span> </span><span id="local-6989586621683043300"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683043300"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span id="local-6989586621683043301"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683043301"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-238"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Following filled tyvar (zonk_eq_types)&quot;</span></span><span>
</span><span id="line-239"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683043300"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#equals"><span class="hs-identifier hs-var">equals</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683043301"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-240"></span><span>
</span><span id="line-241"></span><span>    </span><span id="local-6989586621683043289"><span class="annot"><span class="annottext">quick_zonk :: TcTyVar -&gt; TcS (TcType, Bool)
</span><a href="#local-6989586621683043289"><span class="hs-identifier hs-var hs-var">quick_zonk</span></a></span></span><span> </span><span id="local-6989586621683043313"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043313"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcTyVarDetails
</span><a href="GHC.Types.Var.html#tcTyVarDetails"><span class="hs-identifier hs-var">tcTyVarDetails</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043313"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-242"></span><span>      </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#MetaTv"><span class="hs-identifier hs-type">MetaTv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mtv_ref :: TcTyVarDetails -&gt; IORef MetaDetails
</span><a href="GHC.Tc.Utils.TcType.html#mtv_ref"><span class="hs-identifier hs-var">mtv_ref</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683043314"><span class="annot"><span class="annottext">IORef MetaDetails
</span><a href="#local-6989586621683043314"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-243"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683043315"><span class="annot"><a href="#local-6989586621683043315"><span class="hs-identifier hs-var">cts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef MetaDetails -&gt; TcS MetaDetails
forall a. TcRef a -&gt; TcS a
</span><a href="GHC.Tc.Solver.Monad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a></span><span> </span><span class="annot"><span class="annottext">IORef MetaDetails
</span><a href="#local-6989586621683043314"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-244"></span><span>              </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683043315"><span class="hs-identifier hs-type">cts</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-245"></span><span>                  </span><span class="annot"><span class="annottext">MetaDetails
</span><a href="GHC.Tc.Utils.TcType.html#Flexi"><span class="hs-identifier hs-var">Flexi</span></a></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(TcType, Bool) -&gt; TcS (TcType, Bool)
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#TyVarTy"><span class="hs-identifier hs-var">TyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043313"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>                  </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#Indirect"><span class="hs-identifier hs-type">Indirect</span></a></span><span> </span><span id="local-6989586621683043316"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043316"><span class="hs-identifier hs-var">ty'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType -&gt; TcS ()
forall {a} {a}. (Outputable a, Outputable a) =&gt; a -&gt; a -&gt; TcS ()
</span><a href="#local-6989586621683043276"><span class="hs-identifier hs-var">trace_indirect</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043313"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043316"><span class="hs-identifier hs-var">ty'</span></a></span><span>
</span><span id="line-247"></span><span>                                     </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(TcType, Bool) -&gt; TcS (TcType, Bool)
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043316"><span class="hs-identifier hs-var">ty'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-248"></span><span>      </span><span class="annot"><span class="annottext">TcTyVarDetails
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(TcType, Bool) -&gt; TcS (TcType, Bool)
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#TyVarTy"><span class="hs-identifier hs-var">TyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043313"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-249"></span><span>
</span><span id="line-250"></span><span>      </span><span class="hs-comment">-- This happens for type families, too. But recall that failure</span><span>
</span><span id="line-251"></span><span>      </span><span class="hs-comment">-- here just means to try harder, so it's OK if the type function</span><span>
</span><span id="line-252"></span><span>      </span><span class="hs-comment">-- isn't injective.</span><span>
</span><span id="line-253"></span><span>    </span><span class="annot"><a href="#local-6989586621683043236"><span class="hs-identifier hs-type">tycon</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-254"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-255"></span><span>    </span><span id="local-6989586621683043236"><span class="annot"><span class="annottext">tycon :: TyCon -&gt; [TcType] -&gt; [TcType] -&gt; TcS (Either TypeEqn TcType)
</span><a href="#local-6989586621683043236"><span class="hs-identifier hs-var hs-var">tycon</span></a></span></span><span> </span><span id="local-6989586621683043317"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043317"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621683043318"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043318"><span class="hs-identifier hs-var">tys1</span></a></span></span><span> </span><span id="local-6989586621683043319"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043319"><span class="hs-identifier hs-var">tys2</span></a></span></span><span>
</span><span id="line-256"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683043320"><span class="annot"><a href="#local-6989586621683043320"><span class="hs-identifier hs-var">results</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TcType -&gt; TcType -&gt; TcS (Either TypeEqn TcType))
-&gt; [TcType] -&gt; [TcType] -&gt; TcS [Either TypeEqn TcType]
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><span class="hs-identifier hs-var">zipWithM</span></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TcS (Either TypeEqn TcType)
</span><a href="#local-6989586621683043193"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043318"><span class="hs-identifier hs-var">tys1</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043319"><span class="hs-identifier hs-var">tys2</span></a></span><span>
</span><span id="line-257"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683043322"><span class="hs-identifier hs-type">combine_results</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043320"><span class="hs-identifier hs-type">results</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-258"></span><span>               </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621683043323"><span class="annot"><span class="annottext">Pair [TcType]
</span><a href="#local-6989586621683043323"><span class="hs-identifier hs-var">tys</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TypeEqn -&gt; Either TypeEqn TcType
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [TcType] -&gt; TcType
</span><a href="GHC.Core.Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043317"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">([TcType] -&gt; TcType) -&gt; Pair [TcType] -&gt; TypeEqn
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pair [TcType]
</span><a href="#local-6989586621683043323"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-259"></span><span>               </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621683043326"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043326"><span class="hs-identifier hs-var">tys</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Either TypeEqn TcType
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [TcType] -&gt; TcType
</span><a href="GHC.Core.Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043317"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043326"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-260"></span><span>
</span><span id="line-261"></span><span>    </span><span class="annot"><a href="#local-6989586621683043322"><span class="hs-identifier hs-type">combine_results</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-262"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-263"></span><span>    </span><span id="local-6989586621683043322"><span class="annot"><span class="annottext">combine_results :: [Either TypeEqn TcType] -&gt; Either (Pair [TcType]) [TcType]
</span><a href="#local-6989586621683043322"><span class="hs-identifier hs-var hs-var">combine_results</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Pair [TcType] -&gt; Pair [TcType])
-&gt; ([TcType] -&gt; [TcType])
-&gt; Either (Pair [TcType]) [TcType]
-&gt; Either (Pair [TcType]) [TcType]
forall a b c d. (a -&gt; b) -&gt; (c -&gt; d) -&gt; Either a c -&gt; Either b d
forall (p :: * -&gt; * -&gt; *) a b c d.
Bifunctor p =&gt;
(a -&gt; b) -&gt; (c -&gt; d) -&gt; p a c -&gt; p b d
</span><a href="../../base-4.21.0.0-ae91/src/Data.Bifunctor.html#bimap"><span class="hs-identifier hs-var">bimap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([TcType] -&gt; [TcType]) -&gt; Pair [TcType] -&gt; Pair [TcType]
forall a b. (a -&gt; b) -&gt; Pair a -&gt; Pair b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; [TcType]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; [TcType]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">(Either (Pair [TcType]) [TcType]
 -&gt; Either (Pair [TcType]) [TcType])
-&gt; ([Either TypeEqn TcType] -&gt; Either (Pair [TcType]) [TcType])
-&gt; [Either TypeEqn TcType]
-&gt; Either (Pair [TcType]) [TcType]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span>
</span><span id="line-264"></span><span>                      </span><span class="annot"><span class="annottext">(Either (Pair [TcType]) [TcType]
 -&gt; Either TypeEqn TcType -&gt; Either (Pair [TcType]) [TcType])
-&gt; Either (Pair [TcType]) [TcType]
-&gt; [Either TypeEqn TcType]
-&gt; Either (Pair [TcType]) [TcType]
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TcType -&gt; [TcType] -&gt; [TcType])
-&gt; Either (Pair [TcType]) [TcType]
-&gt; Either TypeEqn TcType
-&gt; Either (Pair [TcType]) [TcType]
forall a b c.
(a -&gt; b -&gt; c)
-&gt; Either (Pair b) b -&gt; Either (Pair a) a -&gt; Either (Pair c) c
</span><a href="#local-6989586621683043221"><span class="hs-identifier hs-var">combine_rev</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TcType] -&gt; Either (Pair [TcType]) [TcType]
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-265"></span><span>
</span><span id="line-266"></span><span>      </span><span class="hs-comment">-- combine (in reverse) a new result onto an already-combined result</span><span>
</span><span id="line-267"></span><span>    </span><span id="local-6989586621683042490"><span id="local-6989586621683042491"><span id="local-6989586621683042492"><span class="annot"><a href="#local-6989586621683043221"><span class="hs-identifier hs-type">combine_rev</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683042490"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621683042491"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621683042492"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-268"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683042491"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683042491"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-269"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683042490"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683042490"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-270"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683042492"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683042492"><span class="hs-identifier hs-type">c</span></a></span></span></span></span><span>
</span><span id="line-271"></span><span>    </span><span id="local-6989586621683043221"><span class="annot"><span class="annottext">combine_rev :: forall a b c.
(a -&gt; b -&gt; c)
-&gt; Either (Pair b) b -&gt; Either (Pair a) a -&gt; Either (Pair c) c
</span><a href="#local-6989586621683043221"><span class="hs-identifier hs-var hs-var">combine_rev</span></a></span></span><span> </span><span id="local-6989586621683043339"><span class="annot"><span class="annottext">a -&gt; b -&gt; c
</span><a href="#local-6989586621683043339"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621683043340"><span class="annot"><span class="annottext">Pair b
</span><a href="#local-6989586621683043340"><span class="hs-identifier hs-var">list</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621683043341"><span class="annot"><span class="annottext">Pair a
</span><a href="#local-6989586621683043341"><span class="hs-identifier hs-var">elt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pair c -&gt; Either (Pair c) c
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; b -&gt; c
</span><a href="#local-6989586621683043339"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(a -&gt; b -&gt; c) -&gt; Pair a -&gt; Pair (b -&gt; c)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pair a
</span><a href="#local-6989586621683043341"><span class="hs-identifier hs-var">elt</span></a></span><span>     </span><span class="annot"><span class="annottext">Pair (b -&gt; c) -&gt; Pair b -&gt; Pair c
forall a b. Pair (a -&gt; b) -&gt; Pair a -&gt; Pair b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pair b
</span><a href="#local-6989586621683043340"><span class="hs-identifier hs-var">list</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-272"></span><span>    </span><span class="annot"><a href="#local-6989586621683043221"><span class="hs-identifier hs-var">combine_rev</span></a></span><span> </span><span id="local-6989586621683043342"><span class="annot"><span class="annottext">a -&gt; b -&gt; c
</span><a href="#local-6989586621683043342"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621683043343"><span class="annot"><span class="annottext">Pair b
</span><a href="#local-6989586621683043343"><span class="hs-identifier hs-var">list</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621683043344"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683043344"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pair c -&gt; Either (Pair c) c
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; b -&gt; c
</span><a href="#local-6989586621683043342"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(a -&gt; b -&gt; c) -&gt; Pair a -&gt; Pair (b -&gt; c)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Pair a
forall a. a -&gt; Pair a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683043344"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">Pair (b -&gt; c) -&gt; Pair b -&gt; Pair c
forall a b. Pair (a -&gt; b) -&gt; Pair a -&gt; Pair b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pair b
</span><a href="#local-6989586621683043343"><span class="hs-identifier hs-var">list</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-273"></span><span>    </span><span class="annot"><a href="#local-6989586621683043221"><span class="hs-identifier hs-var">combine_rev</span></a></span><span> </span><span id="local-6989586621683043345"><span class="annot"><span class="annottext">a -&gt; b -&gt; c
</span><a href="#local-6989586621683043345"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621683043346"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621683043346"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621683043347"><span class="annot"><span class="annottext">Pair a
</span><a href="#local-6989586621683043347"><span class="hs-identifier hs-var">elt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pair c -&gt; Either (Pair c) c
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; b -&gt; c
</span><a href="#local-6989586621683043345"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(a -&gt; b -&gt; c) -&gt; Pair a -&gt; Pair (b -&gt; c)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pair a
</span><a href="#local-6989586621683043347"><span class="hs-identifier hs-var">elt</span></a></span><span>     </span><span class="annot"><span class="annottext">Pair (b -&gt; c) -&gt; Pair b -&gt; Pair c
forall a b. Pair (a -&gt; b) -&gt; Pair a -&gt; Pair b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; Pair b
forall a. a -&gt; Pair a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621683043346"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-274"></span><span>    </span><span class="annot"><a href="#local-6989586621683043221"><span class="hs-identifier hs-var">combine_rev</span></a></span><span> </span><span id="local-6989586621683043348"><span class="annot"><span class="annottext">a -&gt; b -&gt; c
</span><a href="#local-6989586621683043348"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621683043349"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621683043349"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621683043350"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683043350"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">c -&gt; Either (Pair c) c
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; b -&gt; c
</span><a href="#local-6989586621683043348"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683043350"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621683043349"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-275"></span><span>
</span><span id="line-276"></span><span>
</span><span id="line-277"></span><span class="annot"><span class="hs-comment">{- *********************************************************************
*                                                                      *
*           canonicaliseEquality
*                                                                      *
********************************************************************* -}</span></span><span>
</span><span id="line-282"></span><span>
</span><span id="line-283"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#canonicaliseEquality"><span class="hs-identifier hs-type">canonicaliseEquality</span></a></span><span>
</span><span id="line-284"></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#EqRel"><span class="hs-identifier hs-type">EqRel</span></a></span><span>
</span><span id="line-285"></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>     </span><span class="hs-comment">-- LHS and RHS</span><span>
</span><span id="line-286"></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#SolverStage"><span class="hs-identifier hs-type">SolverStage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#IrredCt"><span class="hs-identifier hs-type">IrredCt</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-287"></span><span class="hs-comment">-- Nota Bene: `ty1` and `ty2` may be more-zonked than `ev`</span><span>
</span><span id="line-288"></span><span class="hs-comment">-- This matters when calling mkSelCo, in canDecomposableTyConAppOK and</span><span>
</span><span id="line-289"></span><span class="hs-comment">--   canDecomposableFunTy, when we need the precondition of mkSelCo to</span><span>
</span><span id="line-290"></span><span class="hs-comment">--   hold.</span><span>
</span><span id="line-291"></span><span>
</span><span id="line-292"></span><span id="canonicaliseEquality"><span class="annot"><span class="annottext">canonicaliseEquality :: CtEvidence
-&gt; EqRel -&gt; TcType -&gt; TcType -&gt; SolverStage (Either IrredCt EqCt)
</span><a href="GHC.Tc.Solver.Equality.html#canonicaliseEquality"><span class="hs-identifier hs-var hs-var">canonicaliseEquality</span></a></span></span><span> </span><span id="local-6989586621683043351"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043351"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683043352"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043352"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span id="local-6989586621683043353"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043353"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683043354"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043354"><span class="hs-identifier hs-var">ty2</span></a></span></span><span>
</span><span id="line-293"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcS (StopOrContinue (Either IrredCt EqCt))
-&gt; SolverStage (Either IrredCt EqCt)
forall a. TcS (StopOrContinue a) -&gt; SolverStage a
</span><a href="GHC.Tc.Solver.Monad.html#Stage"><span class="hs-identifier hs-var">Stage</span></a></span><span> </span><span class="annot"><span class="annottext">(TcS (StopOrContinue (Either IrredCt EqCt))
 -&gt; SolverStage (Either IrredCt EqCt))
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
-&gt; SolverStage (Either IrredCt EqCt)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;canonicaliseEquality&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcS ()) -&gt; SDoc -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-294"></span><span>                 </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043351"><span class="hs-identifier hs-var">ev</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043352"><span class="hs-identifier hs-var">eq_rel</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043353"><span class="hs-identifier hs-var">ty1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043354"><span class="hs-identifier hs-var">ty2</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-295"></span><span>               </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683043356"><span class="annot"><a href="#local-6989586621683043356"><span class="hs-identifier hs-var">rdr_env</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS GlobalRdrEnv
</span><a href="GHC.Tc.Solver.Monad.html#getGlobalRdrEnvTcS"><span class="hs-identifier hs-var">getGlobalRdrEnvTcS</span></a></span><span>
</span><span id="line-296"></span><span>               </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683043358"><span class="annot"><a href="#local-6989586621683043358"><span class="hs-identifier hs-var">fam_insts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#getFamInstEnvs"><span class="hs-identifier hs-type">getFamInstEnvs</span></a></span><span>
</span><span id="line-297"></span><span>               </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#can_eq_nc"><span class="hs-identifier hs-type">can_eq_nc</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span> </span><span class="annot"><a href="#local-6989586621683043356"><span class="hs-identifier hs-type">rdr_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043358"><span class="hs-identifier hs-type">fam_insts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043351"><span class="hs-identifier hs-type">ev</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043352"><span class="hs-identifier hs-type">eq_rel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043353"><span class="hs-identifier hs-type">ty1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043353"><span class="hs-identifier hs-type">ty1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043354"><span class="hs-identifier hs-type">ty2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043354"><span class="hs-identifier hs-type">ty2</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-298"></span><span>
</span><span id="line-299"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#can_eq_nc"><span class="hs-identifier hs-type">can_eq_nc</span></a></span><span>
</span><span id="line-300"></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>           </span><span class="hs-comment">-- True =&gt; both input types are rewritten</span><span>
</span><span id="line-301"></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Name.Reader.html#GlobalRdrEnv"><span class="hs-identifier hs-type">GlobalRdrEnv</span></a></span><span>   </span><span class="hs-comment">-- needed to see which newtypes are in scope</span><span>
</span><span id="line-302"></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a></span><span>    </span><span class="hs-comment">-- needed to unwrap data instances</span><span>
</span><span id="line-303"></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span>
</span><span id="line-304"></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#EqRel"><span class="hs-identifier hs-type">EqRel</span></a></span><span>
</span><span id="line-305"></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>    </span><span class="hs-comment">-- LHS, after and before type-synonym expansion, resp</span><span>
</span><span id="line-306"></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>    </span><span class="hs-comment">-- RHS, after and before type-synonym expansion, resp</span><span>
</span><span id="line-307"></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#IrredCt"><span class="hs-identifier hs-type">IrredCt</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-308"></span><span>
</span><span id="line-309"></span><span class="hs-comment">-- See Note [Unifying type synonyms] in GHC.Core.Unify</span><span>
</span><span id="line-310"></span><span id="can_eq_nc"><span class="annot"><span class="annottext">can_eq_nc :: Bool
-&gt; GlobalRdrEnv
-&gt; (FamInstEnv, FamInstEnv)
-&gt; CtEvidence
-&gt; EqRel
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="GHC.Tc.Solver.Equality.html#can_eq_nc"><span class="hs-identifier hs-var hs-var">can_eq_nc</span></a></span></span><span> </span><span id="local-6989586621683043361"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683043361"><span class="hs-identifier hs-var">_flat</span></a></span></span><span> </span><span id="local-6989586621683043362"><span class="annot"><span class="annottext">GlobalRdrEnv
</span><a href="#local-6989586621683043362"><span class="hs-identifier hs-var">_rdr_env</span></a></span></span><span> </span><span id="local-6989586621683043363"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621683043363"><span class="hs-identifier hs-var">_envs</span></a></span></span><span> </span><span id="local-6989586621683043364"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043364"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683043365"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043365"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span id="local-6989586621683043366"><span class="annot"><span class="annottext">ty1 :: TcType
</span><a href="#local-6989586621683043366"><span class="hs-identifier hs-var">ty1</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyConApp"><span class="hs-identifier hs-type">TyConApp</span></a></span><span> </span><span id="local-6989586621683043368"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043368"><span class="hs-identifier hs-var">tc1</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span id="local-6989586621683043369"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043369"><span class="hs-identifier hs-var">_ps_ty1</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyConApp"><span class="hs-identifier hs-type">TyConApp</span></a></span><span> </span><span id="local-6989586621683043370"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043370"><span class="hs-identifier hs-var">tc2</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span id="local-6989586621683043371"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043371"><span class="hs-identifier hs-var">_ps_ty2</span></a></span></span><span>
</span><span id="line-311"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043368"><span class="hs-identifier hs-var">tc1</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; TyCon -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043370"><span class="hs-identifier hs-var">tc2</span></a></span><span>
</span><span id="line-312"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence
-&gt; EqRel -&gt; TcType -&gt; TcS (StopOrContinue (Either IrredCt EqCt))
forall a. CtEvidence -&gt; EqRel -&gt; TcType -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Equality.html#canEqReflexive"><span class="hs-identifier hs-var">canEqReflexive</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043364"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043365"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043366"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-313"></span><span>
</span><span id="line-314"></span><span class="hs-comment">-- Expand synonyms first; see Note [Type synonyms and canonicalization]</span><span>
</span><span id="line-315"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#can_eq_nc"><span class="hs-identifier hs-var">can_eq_nc</span></a></span><span> </span><span id="local-6989586621683043372"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683043372"><span class="hs-identifier hs-var">rewritten</span></a></span></span><span> </span><span id="local-6989586621683043373"><span class="annot"><span class="annottext">GlobalRdrEnv
</span><a href="#local-6989586621683043373"><span class="hs-identifier hs-var">rdr_env</span></a></span></span><span> </span><span id="local-6989586621683043374"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621683043374"><span class="hs-identifier hs-var">envs</span></a></span></span><span> </span><span id="local-6989586621683043375"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043375"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683043376"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043376"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span id="local-6989586621683043377"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043377"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683043378"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043378"><span class="hs-identifier hs-var">ps_ty1</span></a></span></span><span> </span><span id="local-6989586621683043379"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043379"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span id="local-6989586621683043380"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043380"><span class="hs-identifier hs-var">ps_ty2</span></a></span></span><span>
</span><span id="line-316"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683043381"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043381"><span class="hs-identifier hs-var">ty1'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe TcType
</span><a href="GHC.Core.Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043377"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; GlobalRdrEnv
-&gt; (FamInstEnv, FamInstEnv)
-&gt; CtEvidence
-&gt; EqRel
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="GHC.Tc.Solver.Equality.html#can_eq_nc"><span class="hs-identifier hs-var">can_eq_nc</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683043372"><span class="hs-identifier hs-var">rewritten</span></a></span><span> </span><span class="annot"><span class="annottext">GlobalRdrEnv
</span><a href="#local-6989586621683043373"><span class="hs-identifier hs-var">rdr_env</span></a></span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621683043374"><span class="hs-identifier hs-var">envs</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043375"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043376"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043381"><span class="hs-identifier hs-var">ty1'</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043378"><span class="hs-identifier hs-var">ps_ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043379"><span class="hs-identifier hs-var">ty2</span></a></span><span>  </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043380"><span class="hs-identifier hs-var">ps_ty2</span></a></span><span>
</span><span id="line-317"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683043383"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043383"><span class="hs-identifier hs-var">ty2'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe TcType
</span><a href="GHC.Core.Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043379"><span class="hs-identifier hs-var">ty2</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; GlobalRdrEnv
-&gt; (FamInstEnv, FamInstEnv)
-&gt; CtEvidence
-&gt; EqRel
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="GHC.Tc.Solver.Equality.html#can_eq_nc"><span class="hs-identifier hs-var">can_eq_nc</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683043372"><span class="hs-identifier hs-var">rewritten</span></a></span><span> </span><span class="annot"><span class="annottext">GlobalRdrEnv
</span><a href="#local-6989586621683043373"><span class="hs-identifier hs-var">rdr_env</span></a></span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621683043374"><span class="hs-identifier hs-var">envs</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043375"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043376"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043377"><span class="hs-identifier hs-var">ty1</span></a></span><span>  </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043378"><span class="hs-identifier hs-var">ps_ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043383"><span class="hs-identifier hs-var">ty2'</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043380"><span class="hs-identifier hs-var">ps_ty2</span></a></span><span>
</span><span id="line-318"></span><span>
</span><span id="line-319"></span><span class="hs-comment">-- need to check for reflexivity in the ReprEq case.</span><span>
</span><span id="line-320"></span><span class="hs-comment">-- See Note [Eager reflexivity check]</span><span>
</span><span id="line-321"></span><span class="hs-comment">-- Check only when rewritten because the zonk_eq_types check in canEqNC takes</span><span>
</span><span id="line-322"></span><span class="hs-comment">-- care of the non-rewritten case.</span><span>
</span><span id="line-323"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#can_eq_nc"><span class="hs-identifier hs-var">can_eq_nc</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span id="local-6989586621683043384"><span class="annot"><span class="annottext">GlobalRdrEnv
</span><a href="#local-6989586621683043384"><span class="hs-identifier hs-var">_rdr_env</span></a></span></span><span> </span><span id="local-6989586621683043385"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621683043385"><span class="hs-identifier hs-var">_envs</span></a></span></span><span> </span><span id="local-6989586621683043386"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043386"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#ReprEq"><span class="hs-identifier hs-var">ReprEq</span></a></span><span> </span><span id="local-6989586621683043388"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043388"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span class="annot"><span class="annottext">TcType
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683043389"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043389"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span class="annot"><span class="annottext">TcType
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-324"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043388"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; TcType -&gt; TcType -&gt; Bool
TcType -&gt; TcType -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#tcEqType"><span class="hs-operator hs-var">`tcEqType`</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043389"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-325"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence
-&gt; EqRel -&gt; TcType -&gt; TcS (StopOrContinue (Either IrredCt EqCt))
forall a. CtEvidence -&gt; EqRel -&gt; TcType -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Equality.html#canEqReflexive"><span class="hs-identifier hs-var">canEqReflexive</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043386"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#ReprEq"><span class="hs-identifier hs-var">ReprEq</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043388"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-326"></span><span>
</span><span id="line-327"></span><span class="hs-comment">-- When working with ReprEq, unwrap newtypes.</span><span>
</span><span id="line-328"></span><span class="hs-comment">-- See Note [Unwrap newtypes first]</span><span>
</span><span id="line-329"></span><span class="hs-comment">-- This must be above the TyVarTy case, in order to guarantee (TyEq:N)</span><span>
</span><span id="line-330"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#can_eq_nc"><span class="hs-identifier hs-var">can_eq_nc</span></a></span><span> </span><span id="local-6989586621683043391"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683043391"><span class="hs-identifier hs-var">_rewritten</span></a></span></span><span> </span><span id="local-6989586621683043392"><span class="annot"><span class="annottext">GlobalRdrEnv
</span><a href="#local-6989586621683043392"><span class="hs-identifier hs-var">rdr_env</span></a></span></span><span> </span><span id="local-6989586621683043393"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621683043393"><span class="hs-identifier hs-var">envs</span></a></span></span><span> </span><span id="local-6989586621683043394"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043394"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683043395"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043395"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span id="local-6989586621683043396"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043396"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683043397"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043397"><span class="hs-identifier hs-var">ps_ty1</span></a></span></span><span> </span><span id="local-6989586621683043398"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043398"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span id="local-6989586621683043399"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043399"><span class="hs-identifier hs-var">ps_ty2</span></a></span></span><span>
</span><span id="line-331"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#ReprEq"><span class="hs-identifier hs-var">ReprEq</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043395"><span class="hs-identifier hs-var">eq_rel</span></a></span><span>
</span><span id="line-332"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683043400"><span class="annot"><span class="annottext">((Bag GlobalRdrElt, TcCoercion), TcType)
</span><a href="#local-6989586621683043400"><span class="hs-identifier hs-var">stuff1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
-&gt; GlobalRdrEnv
-&gt; TcType
-&gt; Maybe ((Bag GlobalRdrElt, TcCoercion), TcType)
</span><a href="GHC.Tc.Instance.Family.html#tcTopNormaliseNewTypeTF_maybe"><span class="hs-identifier hs-var">tcTopNormaliseNewTypeTF_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621683043393"><span class="hs-identifier hs-var">envs</span></a></span><span> </span><span class="annot"><span class="annottext">GlobalRdrEnv
</span><a href="#local-6989586621683043392"><span class="hs-identifier hs-var">rdr_env</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043396"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-333"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GlobalRdrEnv
-&gt; (FamInstEnv, FamInstEnv)
-&gt; CtEvidence
-&gt; SwapFlag
-&gt; TcType
-&gt; ((Bag GlobalRdrElt, TcCoercion), TcType)
-&gt; TcType
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="GHC.Tc.Solver.Equality.html#can_eq_newtype_nc"><span class="hs-identifier hs-var">can_eq_newtype_nc</span></a></span><span> </span><span class="annot"><span class="annottext">GlobalRdrEnv
</span><a href="#local-6989586621683043392"><span class="hs-identifier hs-var">rdr_env</span></a></span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621683043393"><span class="hs-identifier hs-var">envs</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043394"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#NotSwapped"><span class="hs-identifier hs-var">NotSwapped</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043396"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">((Bag GlobalRdrElt, TcCoercion), TcType)
</span><a href="#local-6989586621683043400"><span class="hs-identifier hs-var">stuff1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043398"><span class="hs-identifier hs-var">ty2</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043399"><span class="hs-identifier hs-var">ps_ty2</span></a></span><span>
</span><span id="line-334"></span><span>
</span><span id="line-335"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#ReprEq"><span class="hs-identifier hs-var">ReprEq</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043395"><span class="hs-identifier hs-var">eq_rel</span></a></span><span>
</span><span id="line-336"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683043402"><span class="annot"><span class="annottext">((Bag GlobalRdrElt, TcCoercion), TcType)
</span><a href="#local-6989586621683043402"><span class="hs-identifier hs-var">stuff2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
-&gt; GlobalRdrEnv
-&gt; TcType
-&gt; Maybe ((Bag GlobalRdrElt, TcCoercion), TcType)
</span><a href="GHC.Tc.Instance.Family.html#tcTopNormaliseNewTypeTF_maybe"><span class="hs-identifier hs-var">tcTopNormaliseNewTypeTF_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621683043393"><span class="hs-identifier hs-var">envs</span></a></span><span> </span><span class="annot"><span class="annottext">GlobalRdrEnv
</span><a href="#local-6989586621683043392"><span class="hs-identifier hs-var">rdr_env</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043398"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-337"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GlobalRdrEnv
-&gt; (FamInstEnv, FamInstEnv)
-&gt; CtEvidence
-&gt; SwapFlag
-&gt; TcType
-&gt; ((Bag GlobalRdrElt, TcCoercion), TcType)
-&gt; TcType
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="GHC.Tc.Solver.Equality.html#can_eq_newtype_nc"><span class="hs-identifier hs-var">can_eq_newtype_nc</span></a></span><span> </span><span class="annot"><span class="annottext">GlobalRdrEnv
</span><a href="#local-6989586621683043392"><span class="hs-identifier hs-var">rdr_env</span></a></span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621683043393"><span class="hs-identifier hs-var">envs</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043394"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#IsSwapped"><span class="hs-identifier hs-var">IsSwapped</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043398"><span class="hs-identifier hs-var">ty2</span></a></span><span> </span><span class="annot"><span class="annottext">((Bag GlobalRdrElt, TcCoercion), TcType)
</span><a href="#local-6989586621683043402"><span class="hs-identifier hs-var">stuff2</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043396"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043397"><span class="hs-identifier hs-var">ps_ty1</span></a></span><span>
</span><span id="line-338"></span><span>
</span><span id="line-339"></span><span class="hs-comment">-- Then, get rid of casts</span><span>
</span><span id="line-340"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#can_eq_nc"><span class="hs-identifier hs-var">can_eq_nc</span></a></span><span> </span><span id="local-6989586621683043403"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683043403"><span class="hs-identifier hs-var">rewritten</span></a></span></span><span> </span><span id="local-6989586621683043404"><span class="annot"><span class="annottext">GlobalRdrEnv
</span><a href="#local-6989586621683043404"><span class="hs-identifier hs-var">rdr_env</span></a></span></span><span> </span><span id="local-6989586621683043405"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621683043405"><span class="hs-identifier hs-var">envs</span></a></span></span><span> </span><span id="local-6989586621683043406"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043406"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683043407"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043407"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CastTy"><span class="hs-identifier hs-type">CastTy</span></a></span><span> </span><span id="local-6989586621683043409"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043409"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683043410"><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683043410"><span class="hs-identifier hs-var">co1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcType
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683043411"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043411"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span id="local-6989586621683043412"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043412"><span class="hs-identifier hs-var">ps_ty2</span></a></span></span><span>
</span><span id="line-341"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Maybe CanEqLHS -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isNothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; Maybe CanEqLHS
</span><a href="GHC.Tc.Types.Constraint.html#canEqLHS_maybe"><span class="hs-identifier hs-var">canEqLHS_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043411"><span class="hs-identifier hs-var">ty2</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- See (EIK3) in Note [Equalities with incompatible kinds]</span><span>
</span><span id="line-342"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; GlobalRdrEnv
-&gt; (FamInstEnv, FamInstEnv)
-&gt; CtEvidence
-&gt; EqRel
-&gt; SwapFlag
-&gt; TcType
-&gt; TcCoercion
-&gt; TcType
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="GHC.Tc.Solver.Equality.html#canEqCast"><span class="hs-identifier hs-var">canEqCast</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683043403"><span class="hs-identifier hs-var">rewritten</span></a></span><span> </span><span class="annot"><span class="annottext">GlobalRdrEnv
</span><a href="#local-6989586621683043404"><span class="hs-identifier hs-var">rdr_env</span></a></span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621683043405"><span class="hs-identifier hs-var">envs</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043406"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043407"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#NotSwapped"><span class="hs-identifier hs-var">NotSwapped</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043409"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683043410"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043411"><span class="hs-identifier hs-var">ty2</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043412"><span class="hs-identifier hs-var">ps_ty2</span></a></span><span>
</span><span id="line-343"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#can_eq_nc"><span class="hs-identifier hs-var">can_eq_nc</span></a></span><span> </span><span id="local-6989586621683043415"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683043415"><span class="hs-identifier hs-var">rewritten</span></a></span></span><span> </span><span id="local-6989586621683043416"><span class="annot"><span class="annottext">GlobalRdrEnv
</span><a href="#local-6989586621683043416"><span class="hs-identifier hs-var">rdr_env</span></a></span></span><span> </span><span id="local-6989586621683043417"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621683043417"><span class="hs-identifier hs-var">envs</span></a></span></span><span> </span><span id="local-6989586621683043418"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043418"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683043419"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043419"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span id="local-6989586621683043420"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043420"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683043421"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043421"><span class="hs-identifier hs-var">ps_ty1</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CastTy"><span class="hs-identifier hs-type">CastTy</span></a></span><span> </span><span id="local-6989586621683043422"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043422"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span id="local-6989586621683043423"><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683043423"><span class="hs-identifier hs-var">co2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcType
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-344"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Maybe CanEqLHS -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isNothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; Maybe CanEqLHS
</span><a href="GHC.Tc.Types.Constraint.html#canEqLHS_maybe"><span class="hs-identifier hs-var">canEqLHS_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043420"><span class="hs-identifier hs-var">ty1</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- See (EIK3) in Note [Equalities with incompatible kinds]</span><span>
</span><span id="line-345"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; GlobalRdrEnv
-&gt; (FamInstEnv, FamInstEnv)
-&gt; CtEvidence
-&gt; EqRel
-&gt; SwapFlag
-&gt; TcType
-&gt; TcCoercion
-&gt; TcType
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="GHC.Tc.Solver.Equality.html#canEqCast"><span class="hs-identifier hs-var">canEqCast</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683043415"><span class="hs-identifier hs-var">rewritten</span></a></span><span> </span><span class="annot"><span class="annottext">GlobalRdrEnv
</span><a href="#local-6989586621683043416"><span class="hs-identifier hs-var">rdr_env</span></a></span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621683043417"><span class="hs-identifier hs-var">envs</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043418"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043419"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#IsSwapped"><span class="hs-identifier hs-var">IsSwapped</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043422"><span class="hs-identifier hs-var">ty2</span></a></span><span> </span><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683043423"><span class="hs-identifier hs-var">co2</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043420"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043421"><span class="hs-identifier hs-var">ps_ty1</span></a></span><span>
</span><span id="line-346"></span><span>
</span><span id="line-347"></span><span class="hs-comment">----------------------</span><span>
</span><span id="line-348"></span><span class="hs-comment">-- Otherwise try to decompose</span><span>
</span><span id="line-349"></span><span class="hs-comment">----------------------</span><span>
</span><span id="line-350"></span><span>
</span><span id="line-351"></span><span class="hs-comment">-- Literals</span><span>
</span><span id="line-352"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#can_eq_nc"><span class="hs-identifier hs-var">can_eq_nc</span></a></span><span> </span><span id="local-6989586621683043424"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683043424"><span class="hs-identifier hs-var">_rewritten</span></a></span></span><span> </span><span id="local-6989586621683043425"><span class="annot"><span class="annottext">GlobalRdrEnv
</span><a href="#local-6989586621683043425"><span class="hs-identifier hs-var">_rdr_env</span></a></span></span><span> </span><span id="local-6989586621683043426"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621683043426"><span class="hs-identifier hs-var">_envs</span></a></span></span><span> </span><span id="local-6989586621683043427"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043427"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683043428"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043428"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span id="local-6989586621683043429"><span class="annot"><span class="annottext">ty1 :: TcType
</span><a href="#local-6989586621683043429"><span class="hs-identifier hs-var">ty1</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#LitTy"><span class="hs-identifier hs-type">LitTy</span></a></span><span> </span><span id="local-6989586621683043430"><span class="annot"><span class="annottext">TyLit
</span><a href="#local-6989586621683043430"><span class="hs-identifier hs-var">l1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcType
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#LitTy"><span class="hs-identifier hs-type">LitTy</span></a></span><span> </span><span id="local-6989586621683043431"><span class="annot"><span class="annottext">TyLit
</span><a href="#local-6989586621683043431"><span class="hs-identifier hs-var">l2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcType
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-353"></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyLit
</span><a href="#local-6989586621683043430"><span class="hs-identifier hs-var">l1</span></a></span><span> </span><span class="annot"><span class="annottext">TyLit -&gt; TyLit -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TyLit
</span><a href="#local-6989586621683043431"><span class="hs-identifier hs-var">l2</span></a></span><span>
</span><span id="line-354"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CanonicalEvidence -&gt; EvTerm -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#setEvBindIfWanted"><span class="hs-identifier hs-var">setEvBindIfWanted</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043427"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">CanonicalEvidence
</span><a href="GHC.Core.InstEnv.html#EvCanonical"><span class="hs-identifier hs-var">EvCanonical</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcCoercion -&gt; EvTerm
</span><a href="GHC.Tc.Types.Evidence.html#evCoercion"><span class="hs-identifier hs-var">evCoercion</span></a></span><span> </span><span class="annot"><span class="annottext">(TcCoercion -&gt; EvTerm) -&gt; TcCoercion -&gt; EvTerm
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Role -&gt; TcType -&gt; TcCoercion
</span><a href="GHC.Core.Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EqRel -&gt; Role
</span><a href="GHC.Core.Predicate.html#eqRelRole"><span class="hs-identifier hs-var">eqRelRole</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043428"><span class="hs-identifier hs-var">eq_rel</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043429"><span class="hs-identifier hs-var">ty1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-355"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; String -&gt; TcS (StopOrContinue (Either IrredCt EqCt))
forall a. CtEvidence -&gt; String -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Monad.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043427"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Equal LitTy&quot;</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-356"></span><span>
</span><span id="line-357"></span><span class="hs-comment">-- Decompose FunTy: (s -&gt; t) and (c =&gt; t)</span><span>
</span><span id="line-358"></span><span class="hs-comment">-- NB: don't decompose (Int -&gt; blah) ~ (Show a =&gt; blah)</span><span>
</span><span id="line-359"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#can_eq_nc"><span class="hs-identifier hs-var">can_eq_nc</span></a></span><span> </span><span id="local-6989586621683043438"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683043438"><span class="hs-identifier hs-var">_rewritten</span></a></span></span><span> </span><span id="local-6989586621683043439"><span class="annot"><span class="annottext">GlobalRdrEnv
</span><a href="#local-6989586621683043439"><span class="hs-identifier hs-var">_rdr_env</span></a></span></span><span> </span><span id="local-6989586621683043440"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621683043440"><span class="hs-identifier hs-var">_envs</span></a></span></span><span> </span><span id="local-6989586621683043441"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043441"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683043442"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043442"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span>
</span><span id="line-360"></span><span>           </span><span id="local-6989586621683043443"><span class="annot"><span class="annottext">ty1 :: TcType
</span><a href="#local-6989586621683043443"><span class="hs-identifier hs-var">ty1</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#FunTy"><span class="hs-identifier hs-type">FunTy</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ft_mult :: TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#ft_mult"><span class="hs-identifier hs-var">ft_mult</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683043445"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043445"><span class="hs-identifier hs-var">am1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_af :: TcType -&gt; FunTyFlag
</span><a href="GHC.Core.TyCo.Rep.html#ft_af"><span class="hs-identifier hs-var">ft_af</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683043447"><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683043447"><span class="hs-identifier hs-var">af1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_arg :: TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#ft_arg"><span class="hs-identifier hs-var">ft_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683043449"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043449"><span class="hs-identifier hs-var">ty1a</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_res :: TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#ft_res"><span class="hs-identifier hs-var">ft_res</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683043451"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043451"><span class="hs-identifier hs-var">ty1b</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621683043452"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043452"><span class="hs-identifier hs-var">_ps_ty1</span></a></span></span><span>
</span><span id="line-361"></span><span>           </span><span id="local-6989586621683043453"><span class="annot"><span class="annottext">ty2 :: TcType
</span><a href="#local-6989586621683043453"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#FunTy"><span class="hs-identifier hs-type">FunTy</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ft_mult :: TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#ft_mult"><span class="hs-identifier hs-var">ft_mult</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683043454"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043454"><span class="hs-identifier hs-var">am2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_af :: TcType -&gt; FunTyFlag
</span><a href="GHC.Core.TyCo.Rep.html#ft_af"><span class="hs-identifier hs-var">ft_af</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683043455"><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683043455"><span class="hs-identifier hs-var">af2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_arg :: TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#ft_arg"><span class="hs-identifier hs-var">ft_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683043456"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043456"><span class="hs-identifier hs-var">ty2a</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_res :: TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#ft_res"><span class="hs-identifier hs-var">ft_res</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683043457"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043457"><span class="hs-identifier hs-var">ty2b</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621683043458"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043458"><span class="hs-identifier hs-var">_ps_ty2</span></a></span></span><span>
</span><span id="line-362"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683043447"><span class="hs-identifier hs-var">af1</span></a></span><span> </span><span class="annot"><span class="annottext">FunTyFlag -&gt; FunTyFlag -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683043455"><span class="hs-identifier hs-var">af2</span></a></span><span>  </span><span class="hs-comment">-- See Note [Decomposing FunTy]</span><span>
</span><span id="line-363"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence
-&gt; EqRel
-&gt; FunTyFlag
-&gt; (TcType, TcType, TcType, TcType)
-&gt; (TcType, TcType, TcType, TcType)
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
forall a.
CtEvidence
-&gt; EqRel
-&gt; FunTyFlag
-&gt; (TcType, TcType, TcType, TcType)
-&gt; (TcType, TcType, TcType, TcType)
-&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Equality.html#canDecomposableFunTy"><span class="hs-identifier hs-var">canDecomposableFunTy</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043441"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043442"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683043447"><span class="hs-identifier hs-var">af1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043443"><span class="hs-identifier hs-var">ty1</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043445"><span class="hs-identifier hs-var">am1</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043449"><span class="hs-identifier hs-var">ty1a</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043451"><span class="hs-identifier hs-var">ty1b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043453"><span class="hs-identifier hs-var">ty2</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043454"><span class="hs-identifier hs-var">am2</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043456"><span class="hs-identifier hs-var">ty2a</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043457"><span class="hs-identifier hs-var">ty2b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-364"></span><span>
</span><span id="line-365"></span><span class="hs-comment">-- Decompose type constructor applications</span><span>
</span><span id="line-366"></span><span class="hs-comment">-- NB: we have expanded type synonyms already</span><span>
</span><span id="line-367"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#can_eq_nc"><span class="hs-identifier hs-var">can_eq_nc</span></a></span><span> </span><span id="local-6989586621683043460"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683043460"><span class="hs-identifier hs-var">rewritten</span></a></span></span><span> </span><span id="local-6989586621683043461"><span class="annot"><span class="annottext">GlobalRdrEnv
</span><a href="#local-6989586621683043461"><span class="hs-identifier hs-var">_rdr_env</span></a></span></span><span> </span><span id="local-6989586621683043462"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621683043462"><span class="hs-identifier hs-var">_envs</span></a></span></span><span> </span><span id="local-6989586621683043463"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043463"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683043464"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043464"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span id="local-6989586621683043465"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043465"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span class="annot"><span class="annottext">TcType
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683043466"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043466"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span class="annot"><span class="annottext">TcType
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-368"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043467"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043467"><span class="hs-identifier hs-var">tc1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043468"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043468"><span class="hs-identifier hs-var">tys1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; TcType -&gt; Maybe (TyCon, [TcType])
TcType -&gt; Maybe (TyCon, [TcType])
</span><a href="GHC.Core.Type.html#tcSplitTyConApp_maybe"><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043465"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-369"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043470"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043470"><span class="hs-identifier hs-var">tc2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043471"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043471"><span class="hs-identifier hs-var">tys2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; TcType -&gt; Maybe (TyCon, [TcType])
TcType -&gt; Maybe (TyCon, [TcType])
</span><a href="GHC.Core.Type.html#tcSplitTyConApp_maybe"><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043466"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-370"></span><span>   </span><span class="hs-comment">-- tcSplitTyConApp_maybe: we want to catch e.g. Maybe Int ~ (Int -&gt; Int)</span><span>
</span><span id="line-371"></span><span>   </span><span class="hs-comment">-- here for better error messages rather than decomposing into AppTys;</span><span>
</span><span id="line-372"></span><span>   </span><span class="hs-comment">-- hence not using a direct match on TyConApp</span><span>
</span><span id="line-373"></span><span>
</span><span id="line-374"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isTypeFamilyTyCon"><span class="hs-identifier hs-var">isTypeFamilyTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043467"><span class="hs-identifier hs-var">tc1</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isTypeFamilyTyCon"><span class="hs-identifier hs-var">isTypeFamilyTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043470"><span class="hs-identifier hs-var">tc2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-375"></span><span>    </span><span class="hs-comment">-- A type family at the top of LHS or RHS: we want to fall through</span><span>
</span><span id="line-376"></span><span>    </span><span class="hs-comment">-- to the canonical-LHS cases (look for canEqLHS_maybe)</span><span>
</span><span id="line-377"></span><span>
</span><span id="line-378"></span><span>  </span><span class="hs-comment">-- See (TC1) in Note [Canonicalising TyCon/TyCon equalities]</span><span>
</span><span id="line-379"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683043474"><span class="annot"><span class="annottext">role :: Role
</span><a href="#local-6989586621683043474"><span class="hs-keyword hs-var hs-var">role</span></a></span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; Role
</span><a href="GHC.Core.Predicate.html#eqRelRole"><span class="hs-identifier hs-var">eqRelRole</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043464"><span class="hs-identifier hs-var">eq_rel</span></a></span><span>
</span><span id="line-380"></span><span>        </span><span id="local-6989586621683043475"><span class="annot"><span class="annottext">both_generative :: Bool
</span><a href="#local-6989586621683043475"><span class="hs-identifier hs-var hs-var">both_generative</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Role -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isGenerativeTyCon"><span class="hs-identifier hs-var">isGenerativeTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043467"><span class="hs-identifier hs-var">tc1</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683043474"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Role -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isGenerativeTyCon"><span class="hs-identifier hs-var">isGenerativeTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043470"><span class="hs-identifier hs-var">tc2</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683043474"><span class="hs-keyword hs-var">role</span></a></span><span>
</span><span id="line-381"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683043460"><span class="hs-identifier hs-var">rewritten</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683043475"><span class="hs-identifier hs-var">both_generative</span></a></span><span>
</span><span id="line-382"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence
-&gt; EqRel
-&gt; Bool
-&gt; (TcType, TyCon, [TcType])
-&gt; (TcType, TyCon, [TcType])
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="GHC.Tc.Solver.Equality.html#canTyConApp"><span class="hs-identifier hs-var">canTyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043463"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043464"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683043475"><span class="hs-identifier hs-var">both_generative</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043465"><span class="hs-identifier hs-var">ty1</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043467"><span class="hs-identifier hs-var">tc1</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043468"><span class="hs-identifier hs-var">tys1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043466"><span class="hs-identifier hs-var">ty2</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043470"><span class="hs-identifier hs-var">tc2</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043471"><span class="hs-identifier hs-var">tys2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-383"></span><span>
</span><span id="line-384"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#can_eq_nc"><span class="hs-identifier hs-var">can_eq_nc</span></a></span><span> </span><span id="local-6989586621683043478"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683043478"><span class="hs-identifier hs-var">_rewritten</span></a></span></span><span> </span><span id="local-6989586621683043479"><span class="annot"><span class="annottext">GlobalRdrEnv
</span><a href="#local-6989586621683043479"><span class="hs-identifier hs-var">_rdr_env</span></a></span></span><span> </span><span id="local-6989586621683043480"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621683043480"><span class="hs-identifier hs-var">_envs</span></a></span></span><span> </span><span id="local-6989586621683043481"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043481"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683043482"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043482"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span>
</span><span id="line-385"></span><span>           </span><span id="local-6989586621683043483"><span class="annot"><span class="annottext">s1 :: TcType
</span><a href="#local-6989586621683043483"><span class="hs-identifier hs-var">s1</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ForAllTy"><span class="hs-identifier hs-type">ForAllTy</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="annot"><span class="annottext">TcType
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-386"></span><span>           </span><span id="local-6989586621683043485"><span class="annot"><span class="annottext">s2 :: TcType
</span><a href="#local-6989586621683043485"><span class="hs-identifier hs-var">s2</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ForAllTy"><span class="hs-identifier hs-type">ForAllTy</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="annot"><span class="annottext">TcType
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-387"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence
-&gt; EqRel
-&gt; TcType
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="GHC.Tc.Solver.Equality.html#can_eq_nc_forall"><span class="hs-identifier hs-var">can_eq_nc_forall</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043481"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043482"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043483"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043485"><span class="hs-identifier hs-var">s2</span></a></span><span>
</span><span id="line-388"></span><span>
</span><span id="line-389"></span><span class="hs-comment">-- See Note [Canonicalising type applications] about why we require rewritten types</span><span>
</span><span id="line-390"></span><span class="hs-comment">-- Use tcSplitAppTy, not matching on AppTy, to catch oversaturated type families</span><span>
</span><span id="line-391"></span><span class="hs-comment">-- NB: Only decompose AppTy for nominal equality.</span><span>
</span><span id="line-392"></span><span class="hs-comment">--     See Note [Decomposing AppTy equalities]</span><span>
</span><span id="line-393"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#can_eq_nc"><span class="hs-identifier hs-var">can_eq_nc</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span id="local-6989586621683043487"><span class="annot"><span class="annottext">GlobalRdrEnv
</span><a href="#local-6989586621683043487"><span class="hs-identifier hs-var">_rdr_env</span></a></span></span><span> </span><span id="local-6989586621683043488"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621683043488"><span class="hs-identifier hs-var">_envs</span></a></span></span><span> </span><span id="local-6989586621683043489"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043489"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#NomEq"><span class="hs-identifier hs-var">NomEq</span></a></span><span> </span><span id="local-6989586621683043491"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043491"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span class="annot"><span class="annottext">TcType
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683043492"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043492"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span class="annot"><span class="annottext">TcType
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-394"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043493"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043493"><span class="hs-identifier hs-var">t1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043494"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043494"><span class="hs-identifier hs-var">s1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe (TcType, TcType)
</span><a href="GHC.Tc.Utils.TcType.html#tcSplitAppTy_maybe"><span class="hs-identifier hs-var">tcSplitAppTy_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043491"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-395"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043496"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043496"><span class="hs-identifier hs-var">t2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043497"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043497"><span class="hs-identifier hs-var">s2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe (TcType, TcType)
</span><a href="GHC.Tc.Utils.TcType.html#tcSplitAppTy_maybe"><span class="hs-identifier hs-var">tcSplitAppTy_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043492"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-396"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="GHC.Tc.Solver.Equality.html#can_eq_app"><span class="hs-identifier hs-var">can_eq_app</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043489"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043493"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043494"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043496"><span class="hs-identifier hs-var">t2</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043497"><span class="hs-identifier hs-var">s2</span></a></span><span>
</span><span id="line-397"></span><span>
</span><span id="line-398"></span><span class="hs-comment">-------------------</span><span>
</span><span id="line-399"></span><span class="hs-comment">-- Can't decompose.</span><span>
</span><span id="line-400"></span><span class="hs-comment">-------------------</span><span>
</span><span id="line-401"></span><span>
</span><span id="line-402"></span><span class="hs-comment">-- No similarity in type structure detected. Rewrite and try again.</span><span>
</span><span id="line-403"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#can_eq_nc"><span class="hs-identifier hs-var">can_eq_nc</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span id="local-6989586621683043499"><span class="annot"><span class="annottext">GlobalRdrEnv
</span><a href="#local-6989586621683043499"><span class="hs-identifier hs-var">rdr_env</span></a></span></span><span> </span><span id="local-6989586621683043500"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621683043500"><span class="hs-identifier hs-var">envs</span></a></span></span><span> </span><span id="local-6989586621683043501"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043501"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683043502"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043502"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span class="annot"><span class="annottext">TcType
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683043503"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043503"><span class="hs-identifier hs-var">ps_ty1</span></a></span></span><span> </span><span class="annot"><span class="annottext">TcType
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683043504"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043504"><span class="hs-identifier hs-var">ps_ty2</span></a></span></span><span>
</span><span id="line-404"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- Rewrite the two types and try again</span><span>
</span><span id="line-405"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043505"><span class="annot"><a href="#local-6989586621683043505"><span class="hs-identifier hs-var">redn1</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683043507"><span class="annot"><a href="#local-6989586621683043507"><span class="hs-identifier hs-var">xi1</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043508"><span class="annot"><a href="#local-6989586621683043508"><span class="hs-identifier hs-var">rewriters1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; TcType -&gt; TcS (Reduction, RewriterSet)
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite"><span class="hs-identifier hs-var">rewrite</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043501"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043503"><span class="hs-identifier hs-var">ps_ty1</span></a></span><span>
</span><span id="line-406"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043510"><span class="annot"><a href="#local-6989586621683043510"><span class="hs-identifier hs-var">redn2</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683043511"><span class="annot"><a href="#local-6989586621683043511"><span class="hs-identifier hs-var">xi2</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043512"><span class="annot"><a href="#local-6989586621683043512"><span class="hs-identifier hs-var">rewriters2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewrite"><span class="hs-identifier hs-type">rewrite</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043501"><span class="hs-identifier hs-type">ev</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043504"><span class="hs-identifier hs-type">ps_ty2</span></a></span><span>
</span><span id="line-407"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683043513"><span class="annot"><a href="#local-6989586621683043513"><span class="hs-identifier hs-var">new_ev</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#rewriteEqEvidence"><span class="hs-identifier hs-type">rewriteEqEvidence</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683043508"><span class="hs-identifier hs-type">rewriters1</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">S.&lt;&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621683043512"><span class="hs-identifier hs-type">rewriters2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683043501"><span class="hs-identifier hs-type">ev</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#NotSwapped"><span class="hs-identifier hs-type">NotSwapped</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043505"><span class="hs-identifier hs-type">redn1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043510"><span class="hs-identifier hs-type">redn2</span></a></span><span>
</span><span id="line-408"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-type">traceTcS</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;can_eq_nc: go round again&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043513"><span class="hs-identifier hs-type">new_ev</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-type">$$</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043507"><span class="hs-identifier hs-type">xi1</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-type">$$</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043511"><span class="hs-identifier hs-type">xi2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-409"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#can_eq_nc"><span class="hs-identifier hs-type">can_eq_nc</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">True</span></span><span> </span><span class="annot"><a href="#local-6989586621683043499"><span class="hs-identifier hs-type">rdr_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043500"><span class="hs-identifier hs-type">envs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043513"><span class="hs-identifier hs-type">new_ev</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043502"><span class="hs-identifier hs-type">eq_rel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043507"><span class="hs-identifier hs-type">xi1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043507"><span class="hs-identifier hs-type">xi1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043511"><span class="hs-identifier hs-type">xi2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043511"><span class="hs-identifier hs-type">xi2</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-410"></span><span>
</span><span id="line-411"></span><span class="hs-comment">----------------------------</span><span>
</span><span id="line-412"></span><span class="hs-comment">-- Look for a canonical LHS.</span><span>
</span><span id="line-413"></span><span class="hs-comment">-- Only rewritten types end up below here.</span><span>
</span><span id="line-414"></span><span class="hs-comment">----------------------------</span><span>
</span><span id="line-415"></span><span>
</span><span id="line-416"></span><span class="hs-comment">-- NB: pattern match on rewritten=True: we want only rewritten types sent to canEqLHS</span><span>
</span><span id="line-417"></span><span class="hs-comment">-- This means we've rewritten any variables and reduced any type family redexes</span><span>
</span><span id="line-418"></span><span class="hs-comment">-- See also Note [No top-level newtypes on RHS of representational equalities]</span><span>
</span><span id="line-419"></span><span>
</span><span id="line-420"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#can_eq_nc"><span class="hs-identifier hs-var">can_eq_nc</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span id="local-6989586621683043516"><span class="annot"><span class="annottext">GlobalRdrEnv
</span><a href="#local-6989586621683043516"><span class="hs-identifier hs-var">_rdr_env</span></a></span></span><span> </span><span id="local-6989586621683043517"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621683043517"><span class="hs-identifier hs-var">_envs</span></a></span></span><span> </span><span id="local-6989586621683043518"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043518"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683043519"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043519"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span id="local-6989586621683043520"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043520"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683043521"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043521"><span class="hs-identifier hs-var">ps_ty1</span></a></span></span><span> </span><span id="local-6989586621683043522"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043522"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span id="local-6989586621683043523"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043523"><span class="hs-identifier hs-var">ps_ty2</span></a></span></span><span>
</span><span id="line-421"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683043524"><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683043524"><span class="hs-identifier hs-var">can_eq_lhs1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe CanEqLHS
</span><a href="GHC.Tc.Types.Constraint.html#canEqLHS_maybe"><span class="hs-identifier hs-var">canEqLHS_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043520"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-422"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;can_eq1&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043520"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043522"><span class="hs-identifier hs-var">ty2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-423"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CtEvidence
-&gt; EqRel
-&gt; SwapFlag
-&gt; CanEqLHS
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="GHC.Tc.Solver.Equality.html#canEqCanLHS"><span class="hs-identifier hs-var">canEqCanLHS</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043518"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043519"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#NotSwapped"><span class="hs-identifier hs-var">NotSwapped</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683043524"><span class="hs-identifier hs-var">can_eq_lhs1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043521"><span class="hs-identifier hs-var">ps_ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043522"><span class="hs-identifier hs-var">ty2</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043523"><span class="hs-identifier hs-var">ps_ty2</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-424"></span><span>
</span><span id="line-425"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683043526"><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683043526"><span class="hs-identifier hs-var">can_eq_lhs2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe CanEqLHS
</span><a href="GHC.Tc.Types.Constraint.html#canEqLHS_maybe"><span class="hs-identifier hs-var">canEqLHS_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043522"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-426"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;can_eq2&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043520"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043522"><span class="hs-identifier hs-var">ty2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-427"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CtEvidence
-&gt; EqRel
-&gt; SwapFlag
-&gt; CanEqLHS
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="GHC.Tc.Solver.Equality.html#canEqCanLHS"><span class="hs-identifier hs-var">canEqCanLHS</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043518"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043519"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#IsSwapped"><span class="hs-identifier hs-var">IsSwapped</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683043526"><span class="hs-identifier hs-var">can_eq_lhs2</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043523"><span class="hs-identifier hs-var">ps_ty2</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043520"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043521"><span class="hs-identifier hs-var">ps_ty1</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-428"></span><span>
</span><span id="line-429"></span><span>     </span><span class="hs-comment">-- If the type is TyConApp tc1 args1, then args1 really can't be less</span><span>
</span><span id="line-430"></span><span>     </span><span class="hs-comment">-- than tyConArity tc1. It could be *more* than tyConArity, but then we</span><span>
</span><span id="line-431"></span><span>     </span><span class="hs-comment">-- should have handled the case as an AppTy. That case only fires if</span><span>
</span><span id="line-432"></span><span>     </span><span class="hs-comment">-- _both_ sides of the equality are AppTy-like... but if one side is</span><span>
</span><span id="line-433"></span><span>     </span><span class="hs-comment">-- AppTy-like and the other isn't (and it also isn't a variable or</span><span>
</span><span id="line-434"></span><span>     </span><span class="hs-comment">-- saturated type family application, both of which are handled by</span><span>
</span><span id="line-435"></span><span>     </span><span class="hs-comment">-- can_eq_nc), we're in a failure mode and can just fall through.</span><span>
</span><span id="line-436"></span><span>
</span><span id="line-437"></span><span class="hs-comment">----------------------------</span><span>
</span><span id="line-438"></span><span class="hs-comment">-- Fall-through. Give up.</span><span>
</span><span id="line-439"></span><span class="hs-comment">----------------------------</span><span>
</span><span id="line-440"></span><span>
</span><span id="line-441"></span><span class="hs-comment">-- We've rewritten and the types don't match. Give up.</span><span>
</span><span id="line-442"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#can_eq_nc"><span class="hs-identifier hs-var">can_eq_nc</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span id="local-6989586621683043527"><span class="annot"><span class="annottext">GlobalRdrEnv
</span><a href="#local-6989586621683043527"><span class="hs-identifier hs-var">_rdr_env</span></a></span></span><span> </span><span id="local-6989586621683043528"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621683043528"><span class="hs-identifier hs-var">_envs</span></a></span></span><span> </span><span id="local-6989586621683043529"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043529"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683043530"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043530"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span class="annot"><span class="annottext">TcType
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683043531"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043531"><span class="hs-identifier hs-var">ps_ty1</span></a></span></span><span> </span><span class="annot"><span class="annottext">TcType
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683043532"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043532"><span class="hs-identifier hs-var">ps_ty2</span></a></span></span><span>
</span><span id="line-443"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;can_eq_nc catch-all case&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043531"><span class="hs-identifier hs-var">ps_ty1</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043532"><span class="hs-identifier hs-var">ps_ty2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-444"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043530"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-comment">-- See Note [Unsolved equalities]</span><span>
</span><span id="line-445"></span><span>            </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#ReprEq"><span class="hs-identifier hs-var">ReprEq</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CtIrredReason
-&gt; CtEvidence -&gt; TcS (StopOrContinue (Either IrredCt EqCt))
forall a.
CtIrredReason
-&gt; CtEvidence -&gt; TcS (StopOrContinue (Either IrredCt a))
</span><a href="GHC.Tc.Solver.Equality.html#finishCanWithIrred"><span class="hs-identifier hs-var">finishCanWithIrred</span></a></span><span> </span><span class="annot"><span class="annottext">CtIrredReason
</span><a href="GHC.Tc.Types.Constraint.html#ReprEqReason"><span class="hs-identifier hs-var">ReprEqReason</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043529"><span class="hs-identifier hs-var">ev</span></a></span><span>
</span><span id="line-446"></span><span>            </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#NomEq"><span class="hs-identifier hs-var">NomEq</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CtIrredReason
-&gt; CtEvidence -&gt; TcS (StopOrContinue (Either IrredCt EqCt))
forall a.
CtIrredReason
-&gt; CtEvidence -&gt; TcS (StopOrContinue (Either IrredCt a))
</span><a href="GHC.Tc.Solver.Equality.html#finishCanWithIrred"><span class="hs-identifier hs-var">finishCanWithIrred</span></a></span><span> </span><span class="annot"><span class="annottext">CtIrredReason
</span><a href="GHC.Tc.Types.Constraint.html#ShapeMismatchReason"><span class="hs-identifier hs-var">ShapeMismatchReason</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043529"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-447"></span><span>          </span><span class="hs-comment">-- No need to call canEqSoftFailure/canEqHardFailure because they</span><span>
</span><span id="line-448"></span><span>          </span><span class="hs-comment">-- rewrite, and the types involved here are already rewritten</span><span>
</span><span id="line-449"></span><span>
</span><span id="line-450"></span><span>
</span><span id="line-451"></span><span class="hs-comment">{- Note [Unsolved equalities]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we have an unsolved equality like
  (a b ~R# Int)
that is not necessarily insoluble!  Maybe 'a' will turn out to be a newtype.
So we want to make it a potentially-soluble Irred not an insoluble one.
Missing this point is what caused #15431
-}</span><span>
</span><span id="line-459"></span><span>
</span><span id="line-460"></span><span class="hs-comment">---------------------------------</span><span>
</span><span id="line-461"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#can_eq_nc_forall"><span class="hs-identifier hs-type">can_eq_nc_forall</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#EqRel"><span class="hs-identifier hs-type">EqRel</span></a></span><span>
</span><span id="line-462"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>    </span><span class="hs-comment">-- LHS and RHS</span><span>
</span><span id="line-463"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#IrredCt"><span class="hs-identifier hs-type">IrredCt</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-464"></span><span class="hs-comment">-- See Note [Solving forall equalities]</span><span>
</span><span id="line-465"></span><span>
</span><span id="line-466"></span><span id="can_eq_nc_forall"><span class="annot"><span class="annottext">can_eq_nc_forall :: CtEvidence
-&gt; EqRel
-&gt; TcType
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="GHC.Tc.Solver.Equality.html#can_eq_nc_forall"><span class="hs-identifier hs-var hs-var">can_eq_nc_forall</span></a></span></span><span> </span><span id="local-6989586621683043536"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043536"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683043537"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043537"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span id="local-6989586621683043538"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043538"><span class="hs-identifier hs-var">s1</span></a></span></span><span> </span><span id="local-6989586621683043539"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043539"><span class="hs-identifier hs-var">s2</span></a></span></span><span>
</span><span id="line-467"></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtWanted"><span class="hs-identifier hs-type">CtWanted</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ctev_dest :: CtEvidence -&gt; TcEvDest
</span><a href="GHC.Tc.Types.Constraint.html#ctev_dest"><span class="hs-identifier hs-var">ctev_dest</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683043542"><span class="annot"><span class="annottext">TcEvDest
</span><a href="#local-6989586621683043542"><span class="hs-identifier hs-var">orig_dest</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043536"><span class="hs-identifier hs-var">ev</span></a></span><span>
</span><span id="line-468"></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043543"><span class="annot"><span class="annottext">[ForAllTyBinder]
</span><a href="#local-6989586621683043543"><span class="hs-identifier hs-var">bndrs1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043544"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043544"><span class="hs-identifier hs-var">phi1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043545"><span class="annot"><span class="annottext">[ForAllTyBinder]
</span><a href="#local-6989586621683043545"><span class="hs-identifier hs-var">bndrs2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043546"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043546"><span class="hs-identifier hs-var">phi2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType
-&gt; TcType -&gt; ([ForAllTyBinder], TcType, [ForAllTyBinder], TcType)
</span><a href="#local-6989586621683043547"><span class="hs-identifier hs-var">split_foralls</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043538"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043539"><span class="hs-identifier hs-var">s2</span></a></span><span>
</span><span id="line-469"></span><span>            </span><span id="local-6989586621683043548"><span class="annot"><span class="annottext">flags1 :: [ForAllTyFlag]
</span><a href="#local-6989586621683043548"><span class="hs-identifier hs-var hs-var">flags1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ForAllTyBinder] -&gt; [ForAllTyFlag]
forall tv argf. [VarBndr tv argf] -&gt; [argf]
</span><a href="GHC.Types.Var.html#binderFlags"><span class="hs-identifier hs-var">binderFlags</span></a></span><span> </span><span class="annot"><span class="annottext">[ForAllTyBinder]
</span><a href="#local-6989586621683043543"><span class="hs-identifier hs-var">bndrs1</span></a></span><span>
</span><span id="line-470"></span><span>            </span><span id="local-6989586621683043550"><span class="annot"><span class="annottext">flags2 :: [ForAllTyFlag]
</span><a href="#local-6989586621683043550"><span class="hs-identifier hs-var hs-var">flags2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ForAllTyBinder] -&gt; [ForAllTyFlag]
forall tv argf. [VarBndr tv argf] -&gt; [argf]
</span><a href="GHC.Types.Var.html#binderFlags"><span class="hs-identifier hs-var">binderFlags</span></a></span><span> </span><span class="annot"><span class="annottext">[ForAllTyBinder]
</span><a href="#local-6989586621683043545"><span class="hs-identifier hs-var">bndrs2</span></a></span><span>
</span><span id="line-471"></span><span>
</span><span id="line-472"></span><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043537"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; EqRel -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#NomEq"><span class="hs-identifier hs-var">NomEq</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ForAllTyFlag -&gt; ForAllTyFlag -&gt; Bool)
-&gt; [ForAllTyFlag] -&gt; [ForAllTyFlag] -&gt; Bool
forall a b. (a -&gt; b -&gt; Bool) -&gt; [a] -&gt; [b] -&gt; Bool
</span><a href="GHC.Utils.Misc.html#all2"><span class="hs-identifier hs-var">all2</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag -&gt; ForAllTyFlag -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#eqForAllVis"><span class="hs-identifier hs-var">eqForAllVis</span></a></span><span> </span><span class="annot"><span class="annottext">[ForAllTyFlag]
</span><a href="#local-6989586621683043548"><span class="hs-identifier hs-var">flags1</span></a></span><span> </span><span class="annot"><span class="annottext">[ForAllTyFlag]
</span><a href="#local-6989586621683043550"><span class="hs-identifier hs-var">flags2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Note [ForAllTy and type equality]</span><span>
</span><span id="line-473"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Forall failure: visibility-mismatch&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcS ()) -&gt; SDoc -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-474"></span><span>                     </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043538"><span class="hs-identifier hs-var">s1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043539"><span class="hs-identifier hs-var">s2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[ForAllTyBinder] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[ForAllTyBinder]
</span><a href="#local-6989586621683043543"><span class="hs-identifier hs-var">bndrs1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[ForAllTyBinder] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[ForAllTyBinder]
</span><a href="#local-6989586621683043545"><span class="hs-identifier hs-var">bndrs2</span></a></span><span>
</span><span id="line-475"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[ForAllTyFlag] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[ForAllTyFlag]
</span><a href="#local-6989586621683043548"><span class="hs-identifier hs-var">flags1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[ForAllTyFlag] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[ForAllTyFlag]
</span><a href="#local-6989586621683043550"><span class="hs-identifier hs-var">flags2</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-476"></span><span>                </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CtEvidence
-&gt; TcType -&gt; TcType -&gt; TcS (StopOrContinue (Either IrredCt EqCt))
forall a.
CtEvidence
-&gt; TcType -&gt; TcType -&gt; TcS (StopOrContinue (Either IrredCt a))
</span><a href="GHC.Tc.Solver.Equality.html#canEqHardFailure"><span class="hs-identifier hs-var">canEqHardFailure</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043536"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043538"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043539"><span class="hs-identifier hs-var">s2</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-477"></span><span>
</span><span id="line-478"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-479"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Creating implication for polytype equality&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043536"><span class="hs-identifier hs-var">ev</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-480"></span><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683043554"><span class="annot"><span class="annottext">free_tvs :: TyCoVarSet
</span><a href="#local-6989586621683043554"><span class="hs-identifier hs-var hs-var hs-var">free_tvs</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; TyCoVarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tyCoVarsOfTypes</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043538"><span class="hs-identifier hs-var">s1</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043539"><span class="hs-identifier hs-var">s2</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-481"></span><span>            </span><span id="local-6989586621683043556"><span class="annot"><span class="annottext">empty_subst1 :: Subst
</span><a href="#local-6989586621683043556"><span class="hs-identifier hs-var hs-var hs-var">empty_subst1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#mkEmptySubst"><span class="hs-identifier hs-var">mkEmptySubst</span></a></span><span> </span><span class="annot"><span class="annottext">(InScopeSet -&gt; Subst) -&gt; InScopeSet -&gt; Subst
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TyCoVarSet -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#mkInScopeSet"><span class="hs-identifier hs-var">mkInScopeSet</span></a></span><span> </span><span class="annot"><span class="annottext">TyCoVarSet
</span><a href="#local-6989586621683043554"><span class="hs-identifier hs-var">free_tvs</span></a></span><span>
</span><span id="line-482"></span><span>      </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683043559"><span class="annot"><a href="#local-6989586621683043559"><span class="hs-identifier hs-var">skol_info</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SkolemInfoAnon -&gt; TcS SkolemInfo
forall (m :: * -&gt; *). MonadIO m =&gt; SkolemInfoAnon -&gt; m SkolemInfo
</span><a href="GHC.Tc.Types.Origin.html#mkSkolemInfo"><span class="hs-identifier hs-var">mkSkolemInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; SkolemInfoAnon
</span><a href="GHC.Tc.Types.Origin.html#UnifyForAllSkol"><span class="hs-identifier hs-var">UnifyForAllSkol</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043544"><span class="hs-identifier hs-var">phi1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-483"></span><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043562"><span class="annot"><a href="#local-6989586621683043562"><span class="hs-identifier hs-var">subst1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043563"><span class="annot"><a href="#local-6989586621683043563"><span class="hs-identifier hs-var">skol_tvs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#tcInstSkolTyVarsX"><span class="hs-identifier hs-type">tcInstSkolTyVarsX</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043559"><span class="hs-identifier hs-type">skol_info</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043556"><span class="hs-identifier hs-type">empty_subst1</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-484"></span><span>                              </span><span class="annot"><a href="GHC.Types.Var.html#binderVars"><span class="hs-identifier hs-type">binderVars</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043543"><span class="hs-identifier hs-type">bndrs1</span></a></span><span>
</span><span id="line-485"></span><span>
</span><span id="line-486"></span><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683043566"><span class="annot"><a href="#local-6989586621683043566"><span class="hs-identifier hs-var hs-var">phi1'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; TcType -&gt; TcType
Subst -&gt; TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Subst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683043562"><span class="hs-identifier hs-var">subst1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043544"><span class="hs-identifier hs-var">phi1</span></a></span><span>
</span><span id="line-487"></span><span>
</span><span id="line-488"></span><span>            </span><span class="hs-comment">-- Unify the kinds, extend the substitution</span><span>
</span><span id="line-489"></span><span>            </span><span class="annot"><a href="#local-6989586621683043568"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#UnifyEnv"><span class="hs-identifier hs-type">UnifyEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>
</span><span id="line-490"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TyVarBinder"><span class="hs-identifier hs-type">TyVarBinder</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TyVarBinder"><span class="hs-identifier hs-type">TyVarBinder</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM.TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#TcCoercion"><span class="hs-identifier hs-type">TcCoercion</span></a></span><span>
</span><span id="line-491"></span><span>            </span><span id="local-6989586621683043568"><span class="annot"><a href="#local-6989586621683043568"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621683043570"><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683043570"><span class="hs-identifier hs-var">uenv</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043571"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043571"><span class="hs-identifier hs-var">skol_tv</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621683043572"><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683043572"><span class="hs-identifier hs-var">skol_tvs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621683043573"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683043573"><span class="hs-identifier hs-var">subst2</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043574"><span class="annot"><span class="annottext">ForAllTyBinder
</span><a href="#local-6989586621683043574"><span class="hs-identifier hs-var">bndr1</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621683043575"><span class="annot"><span class="annottext">[ForAllTyBinder]
</span><a href="#local-6989586621683043575"><span class="hs-identifier hs-var">bndrs1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043576"><span class="annot"><span class="annottext">ForAllTyBinder
</span><a href="#local-6989586621683043576"><span class="hs-identifier hs-var">bndr2</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621683043577"><span class="annot"><span class="annottext">[ForAllTyBinder]
</span><a href="#local-6989586621683043577"><span class="hs-identifier hs-var">bndrs2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-492"></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683043578"><span class="annot"><span class="annottext">tv2 :: TcTyVar
</span><a href="#local-6989586621683043578"><span class="hs-identifier hs-var hs-var hs-var">tv2</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ForAllTyBinder -&gt; TcTyVar
forall tv argf. VarBndr tv argf -&gt; tv
</span><a href="GHC.Types.Var.html#binderVar"><span class="hs-identifier hs-var">binderVar</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyBinder
</span><a href="#local-6989586621683043576"><span class="hs-identifier hs-var">bndr2</span></a></span><span>
</span><span id="line-493"></span><span>                         </span><span id="local-6989586621683043580"><span class="annot"><span class="annottext">vis1 :: ForAllTyFlag
</span><a href="#local-6989586621683043580"><span class="hs-identifier hs-var hs-var hs-var">vis1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ForAllTyBinder -&gt; ForAllTyFlag
forall tv argf. VarBndr tv argf -&gt; argf
</span><a href="GHC.Types.Var.html#binderFlag"><span class="hs-identifier hs-var">binderFlag</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyBinder
</span><a href="#local-6989586621683043574"><span class="hs-identifier hs-var">bndr1</span></a></span><span>
</span><span id="line-494"></span><span>                         </span><span id="local-6989586621683043582"><span class="annot"><span class="annottext">vis2 :: ForAllTyFlag
</span><a href="#local-6989586621683043582"><span class="hs-identifier hs-var hs-var hs-var">vis2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ForAllTyBinder -&gt; ForAllTyFlag
forall tv argf. VarBndr tv argf -&gt; argf
</span><a href="GHC.Types.Var.html#binderFlag"><span class="hs-identifier hs-var">binderFlag</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyBinder
</span><a href="#local-6989586621683043576"><span class="hs-identifier hs-var">bndr2</span></a></span><span>
</span><span id="line-495"></span><span>
</span><span id="line-496"></span><span>                   </span><span class="hs-comment">-- Unify the kinds, at Nominal role</span><span>
</span><span id="line-497"></span><span>                   </span><span class="hs-comment">-- See (SF1) in Note [Solving forall equalities]</span><span>
</span><span id="line-498"></span><span>                   </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683043583"><span class="annot"><a href="#local-6989586621683043583"><span class="hs-identifier hs-var">kind_co</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UnifyEnv -&gt; TcType -&gt; TcType -&gt; TcM TcCoercion
</span><a href="GHC.Tc.Utils.Unify.html#uType"><span class="hs-identifier hs-var">uType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683043570"><span class="hs-identifier hs-var">uenv</span></a></span><span> </span><span class="annot"><span class="annottext">UnifyEnv -&gt; Role -&gt; UnifyEnv
</span><a href="GHC.Tc.Utils.Unify.html#setUEnvRole"><span class="hs-operator hs-var">`setUEnvRole`</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-499"></span><span>                                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType
</span><a href="GHC.Types.Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043571"><span class="hs-identifier hs-var">skol_tv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-500"></span><span>                                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; TcType -&gt; TcType
Subst -&gt; TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Subst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683043573"><span class="hs-identifier hs-var">subst2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType
</span><a href="GHC.Types.Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043578"><span class="hs-identifier hs-var">tv2</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-501"></span><span>
</span><span id="line-502"></span><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683043588"><span class="annot"><a href="#local-6989586621683043588"><span class="hs-identifier hs-var hs-var">subst2'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; TcTyVar -&gt; TcType -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#extendTvSubstAndInScope"><span class="hs-identifier hs-var">extendTvSubstAndInScope</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683043573"><span class="hs-identifier hs-var">subst2</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043578"><span class="hs-identifier hs-var">tv2</span></a></span><span>
</span><span id="line-503"></span><span>                                       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; TcCoercion -&gt; TcType
</span><a href="GHC.Core.Type.html#mkCastTy"><span class="hs-identifier hs-var">mkCastTy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043571"><span class="hs-identifier hs-var">skol_tv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683043583"><span class="hs-identifier hs-var">kind_co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-504"></span><span>                         </span><span class="hs-comment">-- skol_tv is already in the in-scope set, but the</span><span>
</span><span id="line-505"></span><span>                         </span><span class="hs-comment">-- free vars of kind_co are not; hence &quot;...AndInScope&quot;</span><span>
</span><span id="line-506"></span><span>                   </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683043591"><span class="annot"><a href="#local-6989586621683043591"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621683043568"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043570"><span class="hs-identifier hs-type">uenv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043572"><span class="hs-identifier hs-type">skol_tvs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043588"><span class="hs-identifier hs-type">subst2'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043575"><span class="hs-identifier hs-type">bndrs1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043577"><span class="hs-identifier hs-type">bndrs2</span></a></span><span>
</span><span id="line-507"></span><span>
</span><span id="line-508"></span><span>                   </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.html#mkNakedForAllCo"><span class="hs-identifier hs-type">mkNakedForAllCo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043571"><span class="hs-identifier hs-type">skol_tv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043580"><span class="hs-identifier hs-type">vis1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043582"><span class="hs-identifier hs-type">vis2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043583"><span class="hs-identifier hs-type">kind_co</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043591"><span class="hs-identifier hs-type">co</span></a></span><span class="hs-special">)</span><span class="hs-special">}</span><span>
</span><span id="line-509"></span><span>                     </span><span class="hs-comment">-- mkNaked.. because these types are not zonked, and the</span><span>
</span><span id="line-510"></span><span>                     </span><span class="hs-comment">-- assertions in mkForAllCo may fail without that zonking</span><span>
</span><span id="line-511"></span><span>
</span><span id="line-512"></span><span>            </span><span class="hs-comment">-- Done: unify phi1 ~ phi2</span><span>
</span><span id="line-513"></span><span>            </span><span class="annot"><a href="#local-6989586621683043568"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683043593"><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683043593"><span class="hs-identifier hs-var">uenv</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621683043594"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683043594"><span class="hs-identifier hs-var">subst2</span></a></span></span><span> </span><span id="local-6989586621683043595"><span class="annot"><span class="annottext">[ForAllTyBinder]
</span><a href="#local-6989586621683043595"><span class="hs-identifier hs-var">bndrs1</span></a></span></span><span> </span><span id="local-6989586621683043596"><span class="annot"><span class="annottext">[ForAllTyBinder]
</span><a href="#local-6989586621683043596"><span class="hs-identifier hs-var">bndrs2</span></a></span></span><span>
</span><span id="line-514"></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcM TcCoercion -&gt; TcM TcCoercion
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ForAllTyBinder] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[ForAllTyBinder]
</span><a href="#local-6989586621683043595"><span class="hs-identifier hs-var">bndrs1</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">[ForAllTyBinder] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[ForAllTyBinder]
</span><a href="#local-6989586621683043596"><span class="hs-identifier hs-var">bndrs2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcM TcCoercion -&gt; TcM TcCoercion)
-&gt; TcM TcCoercion -&gt; TcM TcCoercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-515"></span><span>                </span><span class="annot"><span class="annottext">UnifyEnv -&gt; TcType -&gt; TcType -&gt; TcM TcCoercion
</span><a href="GHC.Tc.Utils.Unify.html#uType"><span class="hs-identifier hs-var">uType</span></a></span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683043593"><span class="hs-identifier hs-var">uenv</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043566"><span class="hs-identifier hs-var">phi1'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Subst.html#substTyUnchecked"><span class="hs-identifier hs-var">substTyUnchecked</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683043594"><span class="hs-identifier hs-var">subst2</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043546"><span class="hs-identifier hs-var">phi2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-516"></span><span>
</span><span id="line-517"></span><span>            </span><span class="annot"><a href="#local-6989586621683043568"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Subst
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[ForAllTyBinder]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[ForAllTyBinder]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; TcM TcCoercion
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;can_eq_nc_forall&quot;</span></span><span>  </span><span class="hs-comment">-- case (s:ss) []</span><span>
</span><span id="line-518"></span><span>
</span><span id="line-519"></span><span>            </span><span id="local-6989586621683043601"><span class="annot"><a href="#local-6989586621683043601"><span class="hs-identifier hs-var hs-var">init_subst2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#mkEmptySubst"><span class="hs-identifier hs-var">mkEmptySubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; InScopeSet
</span><a href="GHC.Core.TyCo.Subst.html#getSubstInScope"><span class="hs-identifier hs-var">getSubstInScope</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683043562"><span class="hs-identifier hs-var">subst1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-520"></span><span>
</span><span id="line-521"></span><span>      </span><span class="hs-comment">-- Generate the constraints that live in the body of the implication</span><span>
</span><span id="line-522"></span><span>      </span><span class="hs-comment">-- See (SF5) in Note [Solving forall equalities]</span><span>
</span><span id="line-523"></span><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043603"><span class="annot"><a href="#local-6989586621683043603"><span class="hs-identifier hs-var">lvl</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043604"><span class="annot"><a href="#local-6989586621683043604"><span class="hs-identifier hs-var">all_co</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043605"><span class="annot"><a href="#local-6989586621683043605"><span class="hs-identifier hs-var">wanteds</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#pushLevelNoWorkList"><span class="hs-identifier hs-type">pushLevelNoWorkList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043559"><span class="hs-identifier hs-type">skol_info</span></a></span><span class="hs-special">)</span><span>   </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-524"></span><span>                                    </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#unifyForAllBody"><span class="hs-identifier hs-type">unifyForAllBody</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043536"><span class="hs-identifier hs-type">ev</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Predicate.html#eqRelRole"><span class="hs-identifier hs-type">eqRelRole</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043537"><span class="hs-identifier hs-type">eq_rel</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621683043608"><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683043608"><span class="hs-identifier hs-var">uenv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-525"></span><span>                                    </span><span class="annot"><span class="annottext">UnifyEnv
-&gt; [TcTyVar]
-&gt; Subst
-&gt; [ForAllTyBinder]
-&gt; [ForAllTyBinder]
-&gt; TcM TcCoercion
</span><a href="#local-6989586621683043568"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683043608"><span class="hs-identifier hs-var">uenv</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683043563"><span class="hs-identifier hs-var">skol_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683043601"><span class="hs-identifier hs-var">init_subst2</span></a></span><span> </span><span class="annot"><span class="annottext">[ForAllTyBinder]
</span><a href="#local-6989586621683043543"><span class="hs-identifier hs-var">bndrs1</span></a></span><span> </span><span class="annot"><span class="annottext">[ForAllTyBinder]
</span><a href="#local-6989586621683043545"><span class="hs-identifier hs-var">bndrs2</span></a></span><span>
</span><span id="line-526"></span><span>
</span><span id="line-527"></span><span>      </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#emitTvImplicationTcS"><span class="hs-identifier hs-type">emitTvImplicationTcS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043603"><span class="hs-identifier hs-type">lvl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#getSkolemInfo"><span class="hs-identifier hs-type">getSkolemInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043559"><span class="hs-identifier hs-type">skol_info</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683043563"><span class="hs-identifier hs-type">skol_tvs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043605"><span class="hs-identifier hs-type">wanteds</span></a></span><span>
</span><span id="line-528"></span><span>
</span><span id="line-529"></span><span>      </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#setWantedEq"><span class="hs-identifier hs-type">setWantedEq</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043542"><span class="hs-identifier hs-type">orig_dest</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043604"><span class="hs-identifier hs-type">all_co</span></a></span><span>
</span><span id="line-530"></span><span>      </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#stopWith"><span class="hs-identifier hs-type">stopWith</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043536"><span class="hs-identifier hs-type">ev</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Deferred polytype equality&quot;</span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-531"></span><span>
</span><span id="line-532"></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-533"></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Omitting decomposition of given polytype equality&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcS ()) -&gt; SDoc -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-534"></span><span>        </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; SDoc
</span><a href="GHC.Tc.Solver.Monad.html#pprEq"><span class="hs-identifier hs-var">pprEq</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043538"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043539"><span class="hs-identifier hs-var">s2</span></a></span><span>    </span><span class="hs-comment">-- See Note [Do not decompose Given polytype equalities]</span><span>
</span><span id="line-535"></span><span>      </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; String -&gt; TcS (StopOrContinue (Either IrredCt EqCt))
forall a. CtEvidence -&gt; String -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Monad.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043536"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Discard given polytype equality&quot;</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-536"></span><span>
</span><span id="line-537"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-538"></span><span>    </span><span class="annot"><a href="#local-6989586621683043547"><span class="hs-identifier hs-type">split_foralls</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>
</span><span id="line-539"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#ForAllTyBinder"><span class="hs-identifier hs-type">ForAllTyBinder</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>
</span><span id="line-540"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#ForAllTyBinder"><span class="hs-identifier hs-type">ForAllTyBinder</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-541"></span><span>    </span><span class="hs-comment">-- Split matching foralls; stop when the foralls don't match</span><span>
</span><span id="line-542"></span><span>    </span><span class="hs-comment">-- See #22537.  See (SF3) in Note [Solving forall equalities]</span><span>
</span><span id="line-543"></span><span>    </span><span class="hs-comment">-- Postcondition: the two lists of binders returned have the same length</span><span>
</span><span id="line-544"></span><span>    </span><span id="local-6989586621683043547"><span class="annot"><span class="annottext">split_foralls :: TcType
-&gt; TcType -&gt; ([ForAllTyBinder], TcType, [ForAllTyBinder], TcType)
</span><a href="#local-6989586621683043547"><span class="hs-identifier hs-var hs-var">split_foralls</span></a></span></span><span> </span><span id="local-6989586621683043613"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043613"><span class="hs-identifier hs-var">s1</span></a></span></span><span> </span><span id="local-6989586621683043614"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043614"><span class="hs-identifier hs-var">s2</span></a></span></span><span>
</span><span id="line-545"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043615"><span class="annot"><span class="annottext">ForAllTyBinder
</span><a href="#local-6989586621683043615"><span class="hs-identifier hs-var">bndr1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043616"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043616"><span class="hs-identifier hs-var">s1'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe (ForAllTyBinder, TcType)
</span><a href="GHC.Core.Type.html#splitForAllForAllTyBinder_maybe"><span class="hs-identifier hs-var">splitForAllForAllTyBinder_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043613"><span class="hs-identifier hs-var">s1</span></a></span><span>
</span><span id="line-546"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043618"><span class="annot"><span class="annottext">ForAllTyBinder
</span><a href="#local-6989586621683043618"><span class="hs-identifier hs-var">bndr2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043619"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043619"><span class="hs-identifier hs-var">s2'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe (ForAllTyBinder, TcType)
</span><a href="GHC.Core.Type.html#splitForAllForAllTyBinder_maybe"><span class="hs-identifier hs-var">splitForAllForAllTyBinder_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043614"><span class="hs-identifier hs-var">s2</span></a></span><span>
</span><span id="line-547"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span id="local-6989586621683043620"><span class="annot"><span class="annottext">[ForAllTyBinder]
</span><a href="#local-6989586621683043620"><span class="hs-identifier hs-var">bndrs1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043621"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043621"><span class="hs-identifier hs-var">phi1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043622"><span class="annot"><span class="annottext">[ForAllTyBinder]
</span><a href="#local-6989586621683043622"><span class="hs-identifier hs-var">bndrs2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043623"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043623"><span class="hs-identifier hs-var">phi2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType
-&gt; TcType -&gt; ([ForAllTyBinder], TcType, [ForAllTyBinder], TcType)
</span><a href="#local-6989586621683043547"><span class="hs-identifier hs-var">split_foralls</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043616"><span class="hs-identifier hs-var">s1'</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043619"><span class="hs-identifier hs-var">s2'</span></a></span><span>
</span><span id="line-548"></span><span>        </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ForAllTyBinder
</span><a href="#local-6989586621683043615"><span class="hs-identifier hs-var">bndr1</span></a></span><span class="annot"><span class="annottext">ForAllTyBinder -&gt; [ForAllTyBinder] -&gt; [ForAllTyBinder]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[ForAllTyBinder]
</span><a href="#local-6989586621683043620"><span class="hs-identifier hs-var">bndrs1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043621"><span class="hs-identifier hs-var">phi1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ForAllTyBinder
</span><a href="#local-6989586621683043618"><span class="hs-identifier hs-var">bndr2</span></a></span><span class="annot"><span class="annottext">ForAllTyBinder -&gt; [ForAllTyBinder] -&gt; [ForAllTyBinder]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[ForAllTyBinder]
</span><a href="#local-6989586621683043622"><span class="hs-identifier hs-var">bndrs2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043623"><span class="hs-identifier hs-var">phi2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-549"></span><span>    </span><span class="annot"><a href="#local-6989586621683043547"><span class="hs-identifier hs-var">split_foralls</span></a></span><span> </span><span id="local-6989586621683043624"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043624"><span class="hs-identifier hs-var">s1</span></a></span></span><span> </span><span id="local-6989586621683043625"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043625"><span class="hs-identifier hs-var">s2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043624"><span class="hs-identifier hs-var">s1</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043625"><span class="hs-identifier hs-var">s2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-550"></span><span>
</span><span id="line-551"></span><span class="hs-comment">{- Note [Solving forall equalities]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
To solve an equality between foralls
   [W] (forall a. t1) ~ (forall b. t2)
the basic plan is simple: just create the implication constraint
   [W] forall a. { t1 ~ (t2[a/b]) }

The evidence we produce is a ForAllCo; see the typing rule for
ForAllCo in Note [ForAllCo] in GHC.Tc.TyCo.Rep.

There are lots of wrinkles of course:

(SF1) We must check the kinds match (at Nominal role).  So from
      [W] (forall (a:ka). t1) ~ (forall (b:kb). t2)
   we actually generate the implication
      [W] forall (a:ka). { ka ~N kb,  t1 ~ t2[a/b] }
   These kind equalities are generated by the `go` loop in `can_eq_nc_forall`.
   Why Nominal role? See the typing rule for ForAllCo.

(SF2) At Nominal role we must check that the visiblities match.
  For example
     [W] (forall a. a -&gt; a) ~N  (forall b -&gt; b -&gt; b)
  should fail.  At /Representational/ role we allow this; see the
  typing rule for ForAllCo, mentioned above.

(SF3) Consider this (#22537)
     newtype P a = MkP (forall c. (a,c))
     [W] (forall a. P a) ~R (forall a b. (a,b))
  The number of foralls does not line up.  But if we just unwrap the outer
  forall a, we'll get
     [W] P a ~R forall b. (a,b)
  Now unwrap the newtype
     [W] (forall c. (a,c)) ~R (forall b. (a,b))
  and all is good.

  Conclusion: Don't fail if the number of foralls does not line up.  Instead,
  handle as many binders as are visibly apparent on both sides, and then keep
  going with unification. See `split_foralls` in `can_eq_nc_forall`.  In the
  above example, at Representational role, the unifier will proceed to unwrap
  the newtype on the RHS and we'll end up back in can_eq_nc_forall.

(SF4) Remember also that we might have forall z (a:z). blah
  so in that `go` loop, we must proceed one binder at a time (#13879)

(SF5) Rather than manually gather the constraints needed in the body of the
   implication, we use `uType`.  That way we can solve some of them on the fly,
   especially Refl ones.  We use the `unifyForAllBody` wrapper for `uType`,
   because we want to /gather/ the equality constraint (to put in the implication)
   rather than /emit/ them into the monad, as `wrapUnifierTcS` does.
-}</span><span>
</span><span id="line-601"></span><span>
</span><span id="line-602"></span><span class="hs-comment">{- Note [Unwrap newtypes first]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
See also Note [Decomposing newtype equalities]

Consider
  newtype N m a = MkN (m a)
N will get a conservative, Nominal role for its second parameter 'a',
because it appears as an argument to the unknown 'm'. Now consider
  [W] N Maybe a  ~R#  N Maybe b

If we /decompose/, we'll get
  [W] a ~N# b

But if instead we /unwrap/ we'll get
  [W] Maybe a ~R# Maybe b
which in turn gives us
  [W] a ~R# b
which is easier to satisfy.

Conclusion: we must unwrap newtypes before decomposing them. This happens
in `can_eq_newtype_nc`

We did flirt with making the /rewriter/ expand newtypes, rather than
doing it in `can_eq_newtype_nc`.   But with recursive newtypes we want
to be super-careful about expanding!

   newtype A = MkA [A]   -- Recursive!

   f :: A -&gt; [A]
   f = coerce

We have [W] A ~R# [A].  If we rewrite [A], it'll expand to
   [[[[[...]]]]]
and blow the reduction stack.  See Note [Newtypes can blow the stack]
in GHC.Tc.Solver.Rewrite.  But if we expand only the /top level/ of
both sides, we get
   [W] [A] ~R# [A]
which we can, just, solve by reflexivity.

So we simply unwrap, on-demand, at top level, in `can_eq_newtype_nc`.

This is all very delicate. There is a real risk of a loop in the type checker
with recursive newtypes -- but I think we're doomed to do *something*
delicate, as we're really trying to solve for equirecursive type
equality. Bottom line for users: recursive newtypes do not play well with type
inference for representational equality.  See also Section 5.3.1 and 5.3.4 of
&quot;Safe Zero-cost Coercions for Haskell&quot; (JFP 2016).

See also Note [Decomposing newtype equalities].

--- Historical side note ---

We flirted with doing /both/ unwrap-at-top-level /and/ rewrite-deeply;
see #22519.  But that didn't work: see discussion in #22924. Specifically
we got a loop with a minor variation:
   f2 :: a -&gt; [A]
   f2 = coerce

Note [Eager reflexivity check]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have

  newtype X = MkX (Int -&gt; X)

and

  [W] X ~R X

Naively, we would start unwrapping X and end up in a loop. Instead,
we do this eager reflexivity check. This is necessary only for representational
equality because the rewriter technology deals with the similar case
(recursive type families) for nominal equality.

Note that this check does not catch all cases, but it will catch the cases
we're most worried about, types like X above that are actually inhabited.

Here's another place where this reflexivity check is key:
Consider trying to prove (f a) ~R (f a). The AppTys in there can't
be decomposed, because representational equality isn't congruent with respect
to AppTy. So, when canonicalising the equality above, we get stuck and
would normally produce a CIrredCan. However, we really do want to
be able to solve (f a) ~R (f a). So, in the representational case only,
we do a reflexivity check.

(This would be sound in the nominal case, but unnecessary, and I [Richard
E.] am worried that it would slow down the common case.)

 Note [Newtypes can blow the stack]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have

  newtype X = MkX (Int -&gt; X)
  newtype Y = MkY (Int -&gt; Y)

and now wish to prove

  [W] X ~R Y

This Wanted will loop, expanding out the newtypes ever deeper looking
for a solid match or a solid discrepancy. Indeed, there is something
appropriate to this looping, because X and Y *do* have the same representation,
in the limit -- they're both (Fix ((-&gt;) Int)). However, no finitely-sized
coercion will ever witness it. This loop won't actually cause GHC to hang,
though, because we check our depth in `can_eq_newtype_nc`.
-}</span><span>
</span><span id="line-707"></span><span>
</span><span id="line-708"></span><span class="hs-comment">------------------------</span><span>
</span><span id="line-709"></span><span class="annot"><span class="hs-comment">-- | We're able to unwrap a newtype. Update the bits accordingly.</span></span><span>
</span><span id="line-710"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#can_eq_newtype_nc"><span class="hs-identifier hs-type">can_eq_newtype_nc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Name.Reader.html#GlobalRdrEnv"><span class="hs-identifier hs-type">GlobalRdrEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a></span><span>
</span><span id="line-711"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span>           </span><span class="annot"><span class="hs-comment">-- ^ :: ty1 ~ ty2</span></span><span>
</span><span id="line-712"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SwapFlag"><span class="hs-identifier hs-type">SwapFlag</span></a></span><span>
</span><span id="line-713"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>                                    </span><span class="annot"><span class="hs-comment">-- ^ ty1</span></span><span>
</span><span id="line-714"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Name.Reader.html#GlobalRdrElt"><span class="hs-identifier hs-type">GlobalRdrElt</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#TcCoercion"><span class="hs-identifier hs-type">TcCoercion</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">)</span><span>  </span><span class="annot"><span class="hs-comment">-- ^ :: ty1 ~ ty1'</span></span><span>
</span><span id="line-715"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>               </span><span class="annot"><span class="hs-comment">-- ^ ty2</span></span><span>
</span><span id="line-716"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>               </span><span class="annot"><span class="hs-comment">-- ^ ty2, with type synonyms</span></span><span>
</span><span id="line-717"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#IrredCt"><span class="hs-identifier hs-type">IrredCt</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-718"></span><span id="can_eq_newtype_nc"><span class="annot"><span class="annottext">can_eq_newtype_nc :: GlobalRdrEnv
-&gt; (FamInstEnv, FamInstEnv)
-&gt; CtEvidence
-&gt; SwapFlag
-&gt; TcType
-&gt; ((Bag GlobalRdrElt, TcCoercion), TcType)
-&gt; TcType
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="GHC.Tc.Solver.Equality.html#can_eq_newtype_nc"><span class="hs-identifier hs-var hs-var">can_eq_newtype_nc</span></a></span></span><span> </span><span id="local-6989586621683043626"><span class="annot"><span class="annottext">GlobalRdrEnv
</span><a href="#local-6989586621683043626"><span class="hs-identifier hs-var">rdr_env</span></a></span></span><span> </span><span id="local-6989586621683043627"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621683043627"><span class="hs-identifier hs-var">envs</span></a></span></span><span> </span><span id="local-6989586621683043628"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043628"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683043629"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683043629"><span class="hs-identifier hs-var">swapped</span></a></span></span><span> </span><span id="local-6989586621683043630"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043630"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621683043631"><span class="annot"><span class="annottext">Bag GlobalRdrElt
</span><a href="#local-6989586621683043631"><span class="hs-identifier hs-var">gres</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043632"><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683043632"><span class="hs-identifier hs-var">co1</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043633"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043633"><span class="hs-identifier hs-var">ty1'</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621683043634"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043634"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span id="local-6989586621683043635"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043635"><span class="hs-identifier hs-var">ps_ty2</span></a></span></span><span>
</span><span id="line-719"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;can_eq_newtype_nc&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcS ()) -&gt; SDoc -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-720"></span><span>         </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043628"><span class="hs-identifier hs-var">ev</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SwapFlag -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683043629"><span class="hs-identifier hs-var">swapped</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcCoercion -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683043632"><span class="hs-identifier hs-var">co1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bag GlobalRdrElt -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Bag GlobalRdrElt
</span><a href="#local-6989586621683043631"><span class="hs-identifier hs-var">gres</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043633"><span class="hs-identifier hs-var">ty1'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043634"><span class="hs-identifier hs-var">ty2</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-721"></span><span>
</span><span id="line-722"></span><span>         </span><span class="hs-comment">-- Check for blowing our stack, and increase the depth</span><span>
</span><span id="line-723"></span><span>         </span><span class="hs-comment">-- See Note [Newtypes can blow the stack]</span><span>
</span><span id="line-724"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683043636"><span class="annot"><span class="annottext">loc :: CtLoc
</span><a href="#local-6989586621683043636"><span class="hs-identifier hs-var hs-var hs-var">loc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043628"><span class="hs-identifier hs-var">ev</span></a></span><span>
</span><span id="line-725"></span><span>             </span><span id="local-6989586621683043638"><span class="annot"><span class="annottext">ev' :: CtEvidence
</span><a href="#local-6989586621683043638"><span class="hs-identifier hs-var hs-var hs-var">ev'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043628"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#setCtEvLoc"><span class="hs-operator hs-var">`setCtEvLoc`</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; CtLoc
</span><a href="GHC.Tc.Types.CtLoc.html#bumpCtLocDepth"><span class="hs-identifier hs-var">bumpCtLocDepth</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683043636"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-726"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; TcType -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#checkReductionDepth"><span class="hs-identifier hs-var">checkReductionDepth</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683043636"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043630"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-727"></span><span>
</span><span id="line-728"></span><span>         </span><span class="hs-comment">-- Next, we record uses of newtype constructors, since coercing</span><span>
</span><span id="line-729"></span><span>         </span><span class="hs-comment">-- through newtypes is tantamount to using their constructors.</span><span>
</span><span id="line-730"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bag GlobalRdrElt -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#recordUsedGREs"><span class="hs-identifier hs-var">recordUsedGREs</span></a></span><span> </span><span class="annot"><span class="annottext">Bag GlobalRdrElt
</span><a href="#local-6989586621683043631"><span class="hs-identifier hs-var">gres</span></a></span><span>
</span><span id="line-731"></span><span>
</span><span id="line-732"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683043643"><span class="annot"><span class="annottext">redn1 :: Reduction
</span><a href="#local-6989586621683043643"><span class="hs-identifier hs-var hs-var hs-var">redn1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcCoercion -&gt; TcType -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkReduction"><span class="hs-identifier hs-var">mkReduction</span></a></span><span> </span><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683043632"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043633"><span class="hs-identifier hs-var">ty1'</span></a></span><span>
</span><span id="line-733"></span><span>
</span><span id="line-734"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683043645"><span class="annot"><a href="#local-6989586621683043645"><span class="hs-identifier hs-var">new_ev</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RewriterSet
-&gt; CtEvidence
-&gt; SwapFlag
-&gt; Reduction
-&gt; Reduction
-&gt; TcS CtEvidence
</span><a href="GHC.Tc.Solver.Equality.html#rewriteEqEvidence"><span class="hs-identifier hs-var">rewriteEqEvidence</span></a></span><span> </span><span class="annot"><span class="annottext">RewriterSet
</span><a href="GHC.Tc.Types.Constraint.html#emptyRewriterSet"><span class="hs-identifier hs-var">emptyRewriterSet</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043638"><span class="hs-identifier hs-var">ev'</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683043629"><span class="hs-identifier hs-var">swapped</span></a></span><span>
</span><span id="line-735"></span><span>                     </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621683043643"><span class="hs-identifier hs-var">redn1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; TcType -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkReflRedn"><span class="hs-identifier hs-var">mkReflRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Representational"><span class="hs-identifier hs-var">Representational</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043635"><span class="hs-identifier hs-var">ps_ty2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-736"></span><span>
</span><span id="line-737"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#can_eq_nc"><span class="hs-identifier hs-type">can_eq_nc</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span> </span><span class="annot"><a href="#local-6989586621683043626"><span class="hs-identifier hs-type">rdr_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043627"><span class="hs-identifier hs-type">envs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043645"><span class="hs-identifier hs-type">new_ev</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#ReprEq"><span class="hs-identifier hs-type">ReprEq</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043633"><span class="hs-identifier hs-type">ty1'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043633"><span class="hs-identifier hs-type">ty1'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043634"><span class="hs-identifier hs-type">ty2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043635"><span class="hs-identifier hs-type">ps_ty2</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-738"></span><span>
</span><span id="line-739"></span><span class="hs-comment">---------</span><span>
</span><span id="line-740"></span><span class="hs-comment">-- ^ Decompose a type application.</span><span>
</span><span id="line-741"></span><span class="hs-comment">-- All input types must be rewritten. See Note [Canonicalising type applications]</span><span>
</span><span id="line-742"></span><span class="hs-comment">-- Nominal equality only!</span><span>
</span><span id="line-743"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#can_eq_app"><span class="hs-identifier hs-type">can_eq_app</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span>       </span><span class="hs-comment">-- :: s1 t1 ~N s2 t2</span><span>
</span><span id="line-744"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Xi"><span class="hs-identifier hs-type">Xi</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Xi"><span class="hs-identifier hs-type">Xi</span></a></span><span>         </span><span class="hs-comment">-- s1 t1</span><span>
</span><span id="line-745"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Xi"><span class="hs-identifier hs-type">Xi</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Xi"><span class="hs-identifier hs-type">Xi</span></a></span><span>         </span><span class="hs-comment">-- s2 t2</span><span>
</span><span id="line-746"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#IrredCt"><span class="hs-identifier hs-type">IrredCt</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-747"></span><span>
</span><span id="line-748"></span><span class="hs-comment">-- AppTys only decompose for nominal equality, so this case just leads</span><span>
</span><span id="line-749"></span><span class="hs-comment">-- to an irreducible constraint; see typecheck/should_compile/T10494</span><span>
</span><span id="line-750"></span><span class="hs-comment">-- See Note [Decomposing AppTy equalities]</span><span>
</span><span id="line-751"></span><span id="can_eq_app"><span class="annot"><span class="annottext">can_eq_app :: CtEvidence
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="GHC.Tc.Solver.Equality.html#can_eq_app"><span class="hs-identifier hs-var hs-var">can_eq_app</span></a></span></span><span> </span><span id="local-6989586621683043650"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043650"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683043651"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043651"><span class="hs-identifier hs-var">s1</span></a></span></span><span> </span><span id="local-6989586621683043652"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043652"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621683043653"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043653"><span class="hs-identifier hs-var">s2</span></a></span></span><span> </span><span id="local-6989586621683043654"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043654"><span class="hs-identifier hs-var">t2</span></a></span></span><span>
</span><span id="line-752"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtWanted"><span class="hs-identifier hs-type">CtWanted</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ctev_dest :: CtEvidence -&gt; TcEvDest
</span><a href="GHC.Tc.Types.Constraint.html#ctev_dest"><span class="hs-identifier hs-var">ctev_dest</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683043655"><span class="annot"><span class="annottext">TcEvDest
</span><a href="#local-6989586621683043655"><span class="hs-identifier hs-var">dest</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043650"><span class="hs-identifier hs-var">ev</span></a></span><span>
</span><span id="line-753"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;can_eq_app&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;s1:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043651"><span class="hs-identifier hs-var">s1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;t1:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043652"><span class="hs-identifier hs-var">t1</span></a></span><span>
</span><span id="line-754"></span><span>                                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;s2:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043653"><span class="hs-identifier hs-var">s2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;t2:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043654"><span class="hs-identifier hs-var">t2</span></a></span><span>
</span><span id="line-755"></span><span>                                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;vis:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isNextArgVisible"><span class="hs-identifier hs-var">isNextArgVisible</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043651"><span class="hs-identifier hs-var">s1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-756"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043658"><span class="annot"><a href="#local-6989586621683043658"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">,</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtEvidence
-&gt; Role
-&gt; (UnifyEnv -&gt; TcM TcCoercion)
-&gt; TcS (TcCoercion, Cts, [TcTyVar])
forall a.
CtEvidence
-&gt; Role -&gt; (UnifyEnv -&gt; TcM a) -&gt; TcS (a, Cts, [TcTyVar])
</span><a href="GHC.Tc.Solver.Monad.html#wrapUnifierTcS"><span class="hs-identifier hs-var">wrapUnifierTcS</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043650"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="annot"><span class="annottext">((UnifyEnv -&gt; TcM TcCoercion) -&gt; TcS (TcCoercion, Cts, [TcTyVar]))
-&gt; (UnifyEnv -&gt; TcM TcCoercion) -&gt; TcS (TcCoercion, Cts, [TcTyVar])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621683043660"><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683043660"><span class="hs-identifier hs-var">uenv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-757"></span><span>            </span><span class="hs-comment">-- Unify arguments t1/t2 before function s1/s2, because</span><span>
</span><span id="line-758"></span><span>            </span><span class="hs-comment">-- the former have smaller kinds, and hence simpler error messages</span><span>
</span><span id="line-759"></span><span>            </span><span class="hs-comment">-- c.f. GHC.Tc.Utils.Unify.uType (go_app)</span><span>
</span><span id="line-760"></span><span>            </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683043661"><span class="annot"><span class="annottext">arg_env :: UnifyEnv
</span><a href="#local-6989586621683043661"><span class="hs-identifier hs-var hs-var hs-var">arg_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnifyEnv -&gt; (CtLoc -&gt; CtLoc) -&gt; UnifyEnv
</span><a href="GHC.Tc.Utils.Unify.html#updUEnvLoc"><span class="hs-identifier hs-var">updUEnvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683043660"><span class="hs-identifier hs-var">uenv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; CtLoc -&gt; CtLoc
</span><a href="GHC.Tc.Types.CtLoc.html#adjustCtLoc"><span class="hs-identifier hs-var">adjustCtLoc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isNextArgVisible"><span class="hs-identifier hs-var">isNextArgVisible</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043651"><span class="hs-identifier hs-var">s1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-761"></span><span>               </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683043664"><span class="annot"><a href="#local-6989586621683043664"><span class="hs-identifier hs-var">co_t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UnifyEnv -&gt; TcType -&gt; TcType -&gt; TcM TcCoercion
</span><a href="GHC.Tc.Utils.Unify.html#uType"><span class="hs-identifier hs-var">uType</span></a></span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683043661"><span class="hs-identifier hs-var">arg_env</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043652"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043654"><span class="hs-identifier hs-var">t2</span></a></span><span>
</span><span id="line-762"></span><span>               </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683043665"><span class="annot"><a href="#local-6989586621683043665"><span class="hs-identifier hs-var">co_s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#uType"><span class="hs-identifier hs-type">uType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043660"><span class="hs-identifier hs-type">uenv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043651"><span class="hs-identifier hs-type">s1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043653"><span class="hs-identifier hs-type">s2</span></a></span><span>
</span><span id="line-763"></span><span>               </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.html#mkAppCo"><span class="hs-identifier hs-type">mkAppCo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043665"><span class="hs-identifier hs-type">co_s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043664"><span class="hs-identifier hs-type">co_t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-764"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#setWantedEq"><span class="hs-identifier hs-type">setWantedEq</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043655"><span class="hs-identifier hs-type">dest</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043658"><span class="hs-identifier hs-type">co</span></a></span><span>
</span><span id="line-765"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#stopWith"><span class="hs-identifier hs-type">stopWith</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043650"><span class="hs-identifier hs-type">ev</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Decomposed [W] AppTy&quot;</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-766"></span><span>
</span><span id="line-767"></span><span>    </span><span class="hs-comment">-- If there is a ForAll/(-&gt;) mismatch, the use of the Left coercion</span><span>
</span><span id="line-768"></span><span>    </span><span class="hs-comment">-- below is ill-typed, potentially leading to a panic in splitTyConApp</span><span>
</span><span id="line-769"></span><span>    </span><span class="hs-comment">-- Test case: typecheck/should_run/Typeable1</span><span>
</span><span id="line-770"></span><span>    </span><span class="hs-comment">-- We could also include this mismatch check above (for W and D), but it's slow</span><span>
</span><span id="line-771"></span><span>    </span><span class="hs-comment">-- and we'll get a better error message not doing it</span><span>
</span><span id="line-772"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043667"><span class="hs-identifier hs-var">s1k</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; Bool
</span><a href="#local-6989586621683043668"><span class="hs-operator hs-var">`mismatches`</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043669"><span class="hs-identifier hs-var">s2k</span></a></span><span>
</span><span id="line-773"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence
-&gt; TcType -&gt; TcType -&gt; TcS (StopOrContinue (Either IrredCt EqCt))
forall a.
CtEvidence
-&gt; TcType -&gt; TcType -&gt; TcS (StopOrContinue (Either IrredCt a))
</span><a href="GHC.Tc.Solver.Equality.html#canEqHardFailure"><span class="hs-identifier hs-var">canEqHardFailure</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043650"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043651"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TcType
</span><a href="GHC.Core.Type.html#mkAppTy"><span class="hs-operator hs-var">`mkAppTy`</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043652"><span class="hs-identifier hs-var">t1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043653"><span class="hs-identifier hs-var">s2</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TcType
</span><a href="GHC.Core.Type.html#mkAppTy"><span class="hs-operator hs-var">`mkAppTy`</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043654"><span class="hs-identifier hs-var">t2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-774"></span><span>
</span><span id="line-775"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtGiven"><span class="hs-identifier hs-type">CtGiven</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ctev_evar :: CtEvidence -&gt; TcTyVar
</span><a href="GHC.Tc.Types.Constraint.html#ctev_evar"><span class="hs-identifier hs-var">ctev_evar</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683043672"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043672"><span class="hs-identifier hs-var">evar</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043650"><span class="hs-identifier hs-var">ev</span></a></span><span>
</span><span id="line-776"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683043673"><span class="annot"><span class="annottext">co :: TcCoercion
</span><a href="#local-6989586621683043673"><span class="hs-identifier hs-var hs-var hs-var">co</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcCoercion
</span><a href="GHC.Core.Coercion.html#mkCoVarCo"><span class="hs-identifier hs-var">mkCoVarCo</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043672"><span class="hs-identifier hs-var">evar</span></a></span><span>
</span><span id="line-777"></span><span>             </span><span id="local-6989586621683043675"><span class="annot"><span class="annottext">co_s :: TcCoercion
</span><a href="#local-6989586621683043675"><span class="hs-identifier hs-var hs-var hs-var">co_s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LeftOrRight -&gt; TcCoercion -&gt; TcCoercion
</span><a href="GHC.Core.Coercion.html#mkLRCo"><span class="hs-identifier hs-var">mkLRCo</span></a></span><span> </span><span class="annot"><span class="annottext">LeftOrRight
</span><a href="GHC.Types.Basic.html#CLeft"><span class="hs-identifier hs-var">CLeft</span></a></span><span>  </span><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683043673"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-778"></span><span>             </span><span id="local-6989586621683043678"><span class="annot"><span class="annottext">co_t :: TcCoercion
</span><a href="#local-6989586621683043678"><span class="hs-identifier hs-var hs-var hs-var">co_t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LeftOrRight -&gt; TcCoercion -&gt; TcCoercion
</span><a href="GHC.Core.Coercion.html#mkLRCo"><span class="hs-identifier hs-var">mkLRCo</span></a></span><span> </span><span class="annot"><span class="annottext">LeftOrRight
</span><a href="GHC.Types.Basic.html#CRight"><span class="hs-identifier hs-var">CRight</span></a></span><span> </span><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683043673"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-779"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683043680"><span class="annot"><a href="#local-6989586621683043680"><span class="hs-identifier hs-var">evar_s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; (TcType, EvTerm) -&gt; TcS CtEvidence
</span><a href="GHC.Tc.Solver.Monad.html#newGivenEvVar"><span class="hs-identifier hs-var">newGivenEvVar</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683043682"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; TcType -&gt; TcType -&gt; TcType
</span><a href="GHC.Tc.Types.Constraint.html#mkTcEqPredLikeEv"><span class="hs-identifier hs-var">mkTcEqPredLikeEv</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043650"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043651"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043653"><span class="hs-identifier hs-var">s2</span></a></span><span>
</span><span id="line-780"></span><span>                                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcCoercion -&gt; EvTerm
</span><a href="GHC.Tc.Types.Evidence.html#evCoercion"><span class="hs-identifier hs-var">evCoercion</span></a></span><span> </span><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683043675"><span class="hs-identifier hs-var">co_s</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-781"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683043684"><span class="annot"><a href="#local-6989586621683043684"><span class="hs-identifier hs-var">evar_t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#newGivenEvVar"><span class="hs-identifier hs-type">newGivenEvVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043682"><span class="hs-identifier hs-type">loc</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#mkTcEqPredLikeEv"><span class="hs-identifier hs-type">mkTcEqPredLikeEv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043650"><span class="hs-identifier hs-type">ev</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043652"><span class="hs-identifier hs-type">t1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043654"><span class="hs-identifier hs-type">t2</span></a></span><span>
</span><span id="line-782"></span><span>                                     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#evCoercion"><span class="hs-identifier hs-type">evCoercion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043678"><span class="hs-identifier hs-type">co_t</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-783"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#emitWorkNC"><span class="hs-identifier hs-type">emitWorkNC</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621683043684"><span class="hs-identifier hs-type">evar_t</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-784"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#startAgainWith"><span class="hs-identifier hs-type">startAgainWith</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#mkNonCanonical"><span class="hs-identifier hs-type">mkNonCanonical</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043680"><span class="hs-identifier hs-type">evar_s</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-785"></span><span>
</span><span id="line-786"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-787"></span><span>    </span><span id="local-6989586621683043682"><span class="annot"><span class="annottext">loc :: CtLoc
</span><a href="#local-6989586621683043682"><span class="hs-identifier hs-var hs-var">loc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043650"><span class="hs-identifier hs-var">ev</span></a></span><span>
</span><span id="line-788"></span><span>
</span><span id="line-789"></span><span>    </span><span id="local-6989586621683043667"><span class="annot"><span class="annottext">s1k :: TcType
</span><a href="#local-6989586621683043667"><span class="hs-identifier hs-var hs-var">s1k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; TcType -&gt; TcType
TcType -&gt; TcType
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043651"><span class="hs-identifier hs-var">s1</span></a></span><span>
</span><span id="line-790"></span><span>    </span><span id="local-6989586621683043669"><span class="annot"><span class="annottext">s2k :: TcType
</span><a href="#local-6989586621683043669"><span class="hs-identifier hs-var hs-var">s2k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; TcType -&gt; TcType
TcType -&gt; TcType
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043653"><span class="hs-identifier hs-var">s2</span></a></span><span>
</span><span id="line-791"></span><span>
</span><span id="line-792"></span><span>    </span><span id="local-6989586621683043689"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043689"><span class="hs-identifier hs-var">k1</span></a></span></span><span> </span><span id="local-6989586621683043668"><span class="annot"><span class="annottext">mismatches :: TcType -&gt; TcType -&gt; Bool
</span><a href="#local-6989586621683043668"><span class="hs-operator hs-var hs-var">`mismatches`</span></a></span></span><span> </span><span id="local-6989586621683043690"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043690"><span class="hs-identifier hs-var">k2</span></a></span></span><span>
</span><span id="line-793"></span><span>      </span><span class="hs-glyph">=</span><span>  </span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="GHC.Core.Type.html#isForAllTy"><span class="hs-identifier hs-var">isForAllTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043689"><span class="hs-identifier hs-var">k1</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="GHC.Core.Type.html#isForAllTy"><span class="hs-identifier hs-var">isForAllTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043690"><span class="hs-identifier hs-var">k2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-794"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="GHC.Core.Type.html#isForAllTy"><span class="hs-identifier hs-var">isForAllTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043689"><span class="hs-identifier hs-var">k1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="GHC.Core.Type.html#isForAllTy"><span class="hs-identifier hs-var">isForAllTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043690"><span class="hs-identifier hs-var">k2</span></a></span><span>
</span><span id="line-795"></span><span>
</span><span id="line-796"></span><span class="hs-comment">-----------------------</span><span>
</span><span id="line-797"></span><span class="hs-comment">-- | Break apart an equality over a casted type</span><span>
</span><span id="line-798"></span><span class="hs-comment">-- looking like   (ty1 |&gt; co1) ~ ty2   (modulo a swap-flag)</span><span>
</span><span id="line-799"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#canEqCast"><span class="hs-identifier hs-type">canEqCast</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>         </span><span class="hs-comment">-- are both types rewritten?</span><span>
</span><span id="line-800"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Name.Reader.html#GlobalRdrEnv"><span class="hs-identifier hs-type">GlobalRdrEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a></span><span>
</span><span id="line-801"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span>
</span><span id="line-802"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#EqRel"><span class="hs-identifier hs-type">EqRel</span></a></span><span>
</span><span id="line-803"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SwapFlag"><span class="hs-identifier hs-type">SwapFlag</span></a></span><span>
</span><span id="line-804"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>   </span><span class="hs-comment">-- LHS (res. RHS), ty1 |&gt; co1</span><span>
</span><span id="line-805"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>     </span><span class="hs-comment">-- RHS (res. LHS), ty2 both normal and pretty</span><span>
</span><span id="line-806"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#IrredCt"><span class="hs-identifier hs-type">IrredCt</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-807"></span><span id="canEqCast"><span class="annot"><span class="annottext">canEqCast :: Bool
-&gt; GlobalRdrEnv
-&gt; (FamInstEnv, FamInstEnv)
-&gt; CtEvidence
-&gt; EqRel
-&gt; SwapFlag
-&gt; TcType
-&gt; TcCoercion
-&gt; TcType
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="GHC.Tc.Solver.Equality.html#canEqCast"><span class="hs-identifier hs-var hs-var">canEqCast</span></a></span></span><span> </span><span id="local-6989586621683043693"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683043693"><span class="hs-identifier hs-var">rewritten</span></a></span></span><span> </span><span id="local-6989586621683043694"><span class="annot"><span class="annottext">GlobalRdrEnv
</span><a href="#local-6989586621683043694"><span class="hs-identifier hs-var">rdr_env</span></a></span></span><span> </span><span id="local-6989586621683043695"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621683043695"><span class="hs-identifier hs-var">envs</span></a></span></span><span> </span><span id="local-6989586621683043696"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043696"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683043697"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043697"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span id="local-6989586621683043698"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683043698"><span class="hs-identifier hs-var">swapped</span></a></span></span><span> </span><span id="local-6989586621683043699"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043699"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683043700"><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683043700"><span class="hs-identifier hs-var">co1</span></a></span></span><span> </span><span id="local-6989586621683043701"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043701"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span id="local-6989586621683043702"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043702"><span class="hs-identifier hs-var">ps_ty2</span></a></span></span><span>
</span><span id="line-808"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Decomposing cast&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043696"><span class="hs-identifier hs-var">ev</span></a></span><span>
</span><span id="line-809"></span><span>                                           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043699"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;|&gt;&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcCoercion -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683043700"><span class="hs-identifier hs-var">co1</span></a></span><span>
</span><span id="line-810"></span><span>                                           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043702"><span class="hs-identifier hs-var">ps_ty2</span></a></span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-811"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683043703"><span class="annot"><a href="#local-6989586621683043703"><span class="hs-identifier hs-var">new_ev</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RewriterSet
-&gt; CtEvidence
-&gt; SwapFlag
-&gt; Reduction
-&gt; Reduction
-&gt; TcS CtEvidence
</span><a href="GHC.Tc.Solver.Equality.html#rewriteEqEvidence"><span class="hs-identifier hs-var">rewriteEqEvidence</span></a></span><span> </span><span class="annot"><span class="annottext">RewriterSet
</span><a href="GHC.Tc.Types.Constraint.html#emptyRewriterSet"><span class="hs-identifier hs-var">emptyRewriterSet</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043696"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683043698"><span class="hs-identifier hs-var">swapped</span></a></span><span>
</span><span id="line-812"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; TcType -&gt; TcCoercion -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkGReflLeftRedn"><span class="hs-identifier hs-var">mkGReflLeftRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683043705"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043699"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683043700"><span class="hs-identifier hs-var">co1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-813"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; TcType -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkReflRedn"><span class="hs-identifier hs-var">mkReflRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683043705"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043702"><span class="hs-identifier hs-var">ps_ty2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-814"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#can_eq_nc"><span class="hs-identifier hs-type">can_eq_nc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043693"><span class="hs-identifier hs-type">rewritten</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043694"><span class="hs-identifier hs-type">rdr_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043695"><span class="hs-identifier hs-type">envs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043703"><span class="hs-identifier hs-type">new_ev</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043697"><span class="hs-identifier hs-type">eq_rel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043699"><span class="hs-identifier hs-type">ty1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043699"><span class="hs-identifier hs-type">ty1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043701"><span class="hs-identifier hs-type">ty2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043702"><span class="hs-identifier hs-type">ps_ty2</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-815"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-816"></span><span>    </span><span id="local-6989586621683043705"><span class="annot"><span class="annottext">role :: Role
</span><a href="#local-6989586621683043705"><span class="hs-keyword hs-var hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; Role
</span><a href="GHC.Core.Predicate.html#eqRelRole"><span class="hs-identifier hs-var">eqRelRole</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043697"><span class="hs-identifier hs-var">eq_rel</span></a></span><span>
</span><span id="line-817"></span><span>
</span><span id="line-818"></span><span class="hs-comment">------------------------</span><span>
</span><span id="line-819"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#canTyConApp"><span class="hs-identifier hs-type">canTyConApp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#EqRel"><span class="hs-identifier hs-type">EqRel</span></a></span><span>
</span><span id="line-820"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>  </span><span class="hs-comment">-- True &lt;=&gt; both TyCons are generative</span><span>
</span><span id="line-821"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span class="hs-special">,</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-822"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span class="hs-special">,</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-823"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#IrredCt"><span class="hs-identifier hs-type">IrredCt</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-824"></span><span class="hs-comment">-- See Note [Decomposing TyConApp equalities]</span><span>
</span><span id="line-825"></span><span class="hs-comment">-- Neither tc1 nor tc2 is a saturated funTyCon, nor a type family</span><span>
</span><span id="line-826"></span><span class="hs-comment">-- But they can be data families.</span><span>
</span><span id="line-827"></span><span id="canTyConApp"><span class="annot"><span class="annottext">canTyConApp :: CtEvidence
-&gt; EqRel
-&gt; Bool
-&gt; (TcType, TyCon, [TcType])
-&gt; (TcType, TyCon, [TcType])
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="GHC.Tc.Solver.Equality.html#canTyConApp"><span class="hs-identifier hs-var hs-var">canTyConApp</span></a></span></span><span> </span><span id="local-6989586621683043706"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043706"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683043707"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043707"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span id="local-6989586621683043708"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683043708"><span class="hs-identifier hs-var">both_generative</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043709"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043709"><span class="hs-identifier hs-var">ty1</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621683043710"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043710"><span class="hs-identifier hs-var">tc1</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621683043711"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043711"><span class="hs-identifier hs-var">tys1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043712"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043712"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621683043713"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043713"><span class="hs-identifier hs-var">tc2</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621683043714"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043714"><span class="hs-identifier hs-var">tys2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-828"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043710"><span class="hs-identifier hs-var">tc1</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; TyCon -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043713"><span class="hs-identifier hs-var">tc2</span></a></span><span>
</span><span id="line-829"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043711"><span class="hs-identifier hs-var">tys1</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; [TcType] -&gt; Bool
forall a b. [a] -&gt; [b] -&gt; Bool
</span><a href="GHC.Utils.Misc.html#equalLength"><span class="hs-operator hs-var">`equalLength`</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043714"><span class="hs-identifier hs-var">tys2</span></a></span><span>
</span><span id="line-830"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683043715"><span class="annot"><a href="#local-6989586621683043715"><span class="hs-identifier hs-var">inerts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS InertSet
</span><a href="GHC.Tc.Solver.Monad.html#getInertSet"><span class="hs-identifier hs-var">getInertSet</span></a></span><span>
</span><span id="line-831"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621683043717"><span class="hs-identifier hs-type">can_decompose</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043715"><span class="hs-identifier hs-type">inerts</span></a></span><span>
</span><span id="line-832"></span><span>         </span><span class="hs-keyword">then</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#canDecomposableTyConAppOK"><span class="hs-identifier hs-type">canDecomposableTyConAppOK</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043706"><span class="hs-identifier hs-type">ev</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043707"><span class="hs-identifier hs-type">eq_rel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043710"><span class="hs-identifier hs-type">tc1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683043709"><span class="hs-identifier hs-type">ty1</span></a></span><span class="hs-special">,</span><span class="annot"><a href="#local-6989586621683043711"><span class="hs-identifier hs-type">tys1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683043712"><span class="hs-identifier hs-type">ty2</span></a></span><span class="hs-special">,</span><span class="annot"><a href="#local-6989586621683043714"><span class="hs-identifier hs-type">tys2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-833"></span><span>         </span><span class="hs-keyword">else</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#canEqSoftFailure"><span class="hs-identifier hs-type">canEqSoftFailure</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043706"><span class="hs-identifier hs-type">ev</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043707"><span class="hs-identifier hs-type">eq_rel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043709"><span class="hs-identifier hs-type">ty1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043712"><span class="hs-identifier hs-type">ty2</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-834"></span><span>
</span><span id="line-835"></span><span>  </span><span class="hs-comment">-- See Note [Skolem abstract data] in GHC.Core.Tycon</span><span>
</span><span id="line-836"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#tyConSkolem"><span class="hs-identifier hs-var">tyConSkolem</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043710"><span class="hs-identifier hs-var">tc1</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#tyConSkolem"><span class="hs-identifier hs-var">tyConSkolem</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043713"><span class="hs-identifier hs-var">tc2</span></a></span><span>
</span><span id="line-837"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;canTyConApp: skolem abstract&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043710"><span class="hs-identifier hs-var">tc1</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043713"><span class="hs-identifier hs-var">tc2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-838"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CtIrredReason
-&gt; CtEvidence -&gt; TcS (StopOrContinue (Either IrredCt EqCt))
forall a.
CtIrredReason
-&gt; CtEvidence -&gt; TcS (StopOrContinue (Either IrredCt a))
</span><a href="GHC.Tc.Solver.Equality.html#finishCanWithIrred"><span class="hs-identifier hs-var">finishCanWithIrred</span></a></span><span> </span><span class="annot"><span class="annottext">CtIrredReason
</span><a href="GHC.Tc.Types.Constraint.html#AbstractTyConReason"><span class="hs-identifier hs-var">AbstractTyConReason</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043706"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-839"></span><span>
</span><span id="line-840"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>  </span><span class="hs-comment">-- Different TyCons</span><span>
</span><span id="line-841"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683043708"><span class="hs-identifier hs-var">both_generative</span></a></span><span> </span><span class="hs-comment">-- See (TC2) and (TC3) in</span><span>
</span><span id="line-842"></span><span>                       </span><span class="hs-comment">-- Note [Canonicalising TyCon/TyCon equalities]</span><span>
</span><span id="line-843"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">CtEvidence
-&gt; TcType -&gt; TcType -&gt; TcS (StopOrContinue (Either IrredCt EqCt))
forall a.
CtEvidence
-&gt; TcType -&gt; TcType -&gt; TcS (StopOrContinue (Either IrredCt a))
</span><a href="GHC.Tc.Solver.Equality.html#canEqHardFailure"><span class="hs-identifier hs-var">canEqHardFailure</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043706"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043709"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043712"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-844"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">CtEvidence
-&gt; EqRel
-&gt; TcType
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
forall a.
CtEvidence
-&gt; EqRel
-&gt; TcType
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt a))
</span><a href="GHC.Tc.Solver.Equality.html#canEqSoftFailure"><span class="hs-identifier hs-var">canEqSoftFailure</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043706"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043707"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043709"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043712"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-845"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-846"></span><span>     </span><span class="hs-comment">-- See Note [Decomposing TyConApp equalities]</span><span>
</span><span id="line-847"></span><span>     </span><span class="hs-comment">-- and Note [Decomposing newtype equalities]</span><span>
</span><span id="line-848"></span><span>    </span><span id="local-6989586621683043717"><span class="annot"><span class="annottext">can_decompose :: InertSet -&gt; Bool
</span><a href="#local-6989586621683043717"><span class="hs-identifier hs-var hs-var">can_decompose</span></a></span></span><span> </span><span id="local-6989586621683043722"><span class="annot"><span class="annottext">InertSet
</span><a href="#local-6989586621683043722"><span class="hs-identifier hs-var">inerts</span></a></span></span><span>
</span><span id="line-849"></span><span>      </span><span class="hs-glyph">=</span><span>  </span><span class="annot"><span class="annottext">TyCon -&gt; Role -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isInjectiveTyCon"><span class="hs-identifier hs-var">isInjectiveTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043710"><span class="hs-identifier hs-var">tc1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EqRel -&gt; Role
</span><a href="GHC.Core.Predicate.html#eqRelRole"><span class="hs-identifier hs-var">eqRelRole</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043707"><span class="hs-identifier hs-var">eq_rel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-850"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043707"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; EqRel -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#ReprEq"><span class="hs-identifier hs-var">ReprEq</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-851"></span><span>          </span><span class="hs-comment">-- assert: isInjectiveTyCon is always True for Nominal except</span><span>
</span><span id="line-852"></span><span>          </span><span class="hs-comment">--   for type synonyms/families, neither of which happen here</span><span>
</span><span id="line-853"></span><span>          </span><span class="hs-comment">-- Moreover isInjectiveTyCon is True for Representational</span><span>
</span><span id="line-854"></span><span>          </span><span class="hs-comment">--   for algebraic data types.  So we are down to newtypes</span><span>
</span><span id="line-855"></span><span>          </span><span class="hs-comment">--   and data families.</span><span>
</span><span id="line-856"></span><span>          </span><span class="annot"><span class="annottext">CtEvidence -&gt; CtFlavour
</span><a href="GHC.Tc.Types.Constraint.html#ctEvFlavour"><span class="hs-identifier hs-var">ctEvFlavour</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043706"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">CtFlavour -&gt; CtFlavour -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">CtFlavour
</span><a href="GHC.Tc.Types.Constraint.html#Wanted"><span class="hs-identifier hs-var">Wanted</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; InertSet -&gt; Bool
</span><a href="GHC.Tc.Solver.InertSet.html#noGivenNewtypeReprEqs"><span class="hs-identifier hs-var">noGivenNewtypeReprEqs</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043710"><span class="hs-identifier hs-var">tc1</span></a></span><span> </span><span class="annot"><span class="annottext">InertSet
</span><a href="#local-6989586621683043722"><span class="hs-identifier hs-var">inerts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-857"></span><span>             </span><span class="hs-comment">-- See Note [Decomposing newtype equalities] (EX2)</span><span>
</span><span id="line-858"></span><span>
</span><span id="line-859"></span><span class="hs-comment">{- Note [Canonicalising TyCon/TyCon equalities]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider

  type family TF a where TF Char = Bool
  data family DF a
  newtype instance DF Bool = MkDF Int

Suppose we are canonicalising [W] Int ~R# DF (TF a).  Then

(TC1) We might have an inert Given (a ~# Char), so if we rewrote the wanted
      (i.e. went around again in `can_eq_nc` with `rewritten`=True, we'd get
         [W] Int ~R# DF Bool
      and then the `tcTopNormaliseNewTypeTF_maybe` call would fire and
      we'd unwrap the newtype.  So we must do that &quot;go round again&quot; bit.
      Hence the complicated guard (rewritten || both_generative) in `can_eq_nc`.

(TC2) If we can't rewrite `a` yet, we'll finish with an unsolved
         [W] Int ~R# DF (TF a)
      in the inert set. But we must use canEqSoftFailure, not canEqHardFailure,
      because it might be solved &quot;later&quot; when we learn more about `a`.
      Hence the use of `both_generative` in `canTyConApp`.

(TC3) Here's another example:
         [G] Age ~R# Int
      where Age's constructor is not in scope. We don't want to report
      an &quot;inaccessible code&quot; error in the context of this Given!  So again
      we want `canEqSoftFailure`.

      For example, see typecheck/should_compile/T10493, repeated here:
        import Data.Ord (Down)  -- no constructor
        foo :: Coercible (Down Int) Int =&gt; Down Int -&gt; Int
        foo = coerce

      That should compile, but only because we use canEqSoftFailure and
      not canEqHardFailure.

Note [Fast path when decomposing TyConApps]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we see (T s1 t1 ~ T s2 t2), then we can just decompose to
  (s1 ~ s2, t1 ~ t2)
and push those back into the work list.  But if
  s1 = K k1    s2 = K k2
then we will just decompose s1~s2, and it might be better to
do so on the spot.  An important special case is where s1=s2,
and we get just Refl.

So canDecomposableTyConAppOK uses wrapUnifierTcS etc to short-cut
that work.  See also Note [Work-list ordering].

Note [Decomposing TyConApp equalities]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have
        [G/W] T ty1 ~r T ty2
Can we decompose it, and replace it by
        [G/W] ty1 ~r' ty2
and if so what role is r'?  (In this Note, all the &quot;~&quot; are primitive
equalities &quot;~#&quot;, but I have dropped the noisy &quot;#&quot; symbols.)  Lots of
background in the paper &quot;Safe zero-cost coercions for Haskell&quot;.

This Note covers the topic for
  * Datatypes
  * Newtypes
  * Data families
For the rest:
  * Type synonyms: are always expanded
  * Type families: see Note [Decomposing type family applications]
  * AppTy:         see Note [Decomposing AppTy equalities].

---- Roles of the decomposed constraints ----
For a start, the role r' will always be defined like this:
  * If r=N then r' = N
  * If r=R then r' = role of T's first argument

For example:
   data TR a = MkTR a       -- Role of T's first arg is Representational
   data TN a = MkTN (F a)   -- Role of T's first arg is Nominal

The function tyConRolesX :: Role -&gt; TyCon -&gt; [Role] gets the argument
role r' for a TyCon T at role r.  E.g.
   tyConRolesX Nominal          TR = [Nominal]
   tyConRolesX Representational TR = [Representational]

---- Soundness and completeness ----
For Givens, for /soundness/ of decomposition we need, forall ty1,ty2:
    T ty1 ~r T ty2   ===&gt;    ty1 ~r' ty2
Here &quot;===&gt;&quot; means &quot;implies&quot;.  That is, given evidence for (co1 : T ty1 ~r T co2)
we can produce evidence for (co2 : ty1 ~r' ty2).  But in the solver we
/replace/ co1 with co2 in the inert set, and we don't want to lose any proofs
thereby. So for /completeness/ of decomposition we also need the reverse:
    ty1 ~r' ty2   ===&gt;    T ty1 ~r T ty2

For Wanteds, for /soundness/ of decomposition we need:
    ty1 ~r' ty2   ===&gt;    T ty1 ~r T ty2
because if we do decompose we'll get evidence (co2 : ty1 ~r' ty2) and
from that we want to derive evidence (T co2 : T ty1 ~r T ty2).
For /completeness/ of decomposition we need the reverse implication too,
else we may decompose to a new proof obligation that is stronger than
the one we started with.  See Note [Decomposing newtype equalities].

---- Injectivity ----
When do these bi-implications hold? In one direction it is easy.
We /always/ have
    ty1 ~r'  ty2   ===&gt;    T ty1 ~r T ty2
This is the CO_TYCONAPP rule of the paper (Fig 5); see also the
TyConAppCo case of GHC.Core.Lint.lintCoercion.

In the other direction, we have
    T ty1 ~r T ty2   ==&gt;   ty1 ~r' ty2  if T is /injective at role r/
This is the very /definition/ of injectivity: injectivity means result
is the same =&gt; arguments are the same, modulo the role shift.
See comments on GHC.Core.TyCon.isInjectiveTyCon.  This is also
the CO_NTH rule in Fig 5 of the paper, except in the paper only
newtypes are non-injective at representation role, so the rule says &quot;H
is not a newtype&quot;.

Injectivity is a bit subtle:
                 Nominal   Representational
   Datatype        YES        YES
   Newtype         YES        NO{1}
   Data family     YES        NO{2}

{1} Consider newtype N a = MkN (F a)   -- Arg has Nominal role
    Is it true that (N t1) ~R (N t2)   ==&gt;   t1 ~N t2  ?
    No, absolutely not.  E.g.
       type instance F Int = Int; type instance F Bool = Char
       Then (N Int) ~R (N Bool), by unwrapping, but we don't want Int~Char!

    See Note [Decomposing newtype equalities]

{2} We must treat data families precisely like newtypes, because of the
    possibility of newtype instances. See also
    Note [Decomposing newtype equalities]. See #10534 and
    test case typecheck/should_fail/T10534.

---- Takeaway summary -----
For sound and complete decomposition, we simply need injectivity;
that is for isInjectiveTyCon to be true:

* At Nominal role, isInjectiveTyCon is True for all the TyCons we are
  considering in this Note: datatypes, newtypes, and data families.

* For Givens, injectivity is necessary for soundness; completeness has no
  side conditions.

* For Wanteds, soundness has no side conditions; but injectivity is needed
  for completeness. See Note [Decomposing newtype equalities]

This is implemented in `can_decompose` in `canTyConApp`; it looks at
injectivity, just as specified above.

Note [Work-list ordering]
~~~~~~~~~~~~~~~~~~~~~~~~~
Consider decomposing a TyCon equality

    (0) [W] T k_fresh (t1::k_fresh) ~ T k1 (t2::k1)

This gives rise to 2 equalities in the solver worklist

    (1) [W] k_fresh ~ k1
    (2) [W] t1::k_fresh ~ t2::k1

We would like to solve (1) before looking at (2), so that we don't end
up in the complexities of canEqLHSHetero.  To do this:

* `canDecomposableTyConAppOK` calls `uType` on the arguments
  /left-to-right/.  See the call to zipWith4M in that function.

* `uType` keeps the bag of emitted constraints in the same
  left-to-right order.  See the use of `snocBag` in `uType_defer`.

* `wrapUnifierTcS` adds the bag of deferred constraints from
  `do_unifications` to the work-list using `extendWorkListEqs`.

* `extendWorkListEqs` and `selectWorkItem` together arrange that the
  list of constraints given to `extendWorkListEqs` is processed in
  left-to-right order.

This is not a very big deal.  It reduces the number of solver steps
in the test RaeJobTalk from 1830 to 1815, a 1% reduction.  But still,
it doesn't cost anything either.

Note [Decomposing type family applications]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Supose we have
   [G/W]  (F ty1) ~r  (F ty2)
This is handled by the TyFamLHS/TyFamLHS case of canEqCanLHS2.

We never decompose to
   [G/W]  ty1 ~r' ty2

Instead

* For Givens we do nothing. Injective type families have no corresponding
  evidence of their injectivity, so we cannot decompose an
  injective-type-family Given.

* For Wanteds, for the Nominal role only, we emit new Wanteds rather like
  functional dependencies, for each injective argument position.

  E.g type family F a b   -- injective in first arg, but not second
      [W] (F s1 t1) ~N (F s2 t2)
  Emit new Wanteds
      [W] s1 ~N s2
  But retain the existing, unsolved constraint.

Note [Decomposing newtype equalities]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
This Note also applies to data families, which we treat like
newtype in case of 'newtype instance'.

As Note [Decomposing TyConApp equalities] describes, if N is injective
at role r, we can do this decomposition?
   [G/W] (N ty1) ~r (N ty2)    to     [G/W]  ty1 ~r' ty2

For a Given with r=R, the answer is a solid NO: newtypes are not injective at
representational role, and we must not decompose, or we lose soundness.
Example is wrinkle {1} in Note [Decomposing TyConApp equalities].

For a Wanted with r=R, since newtypes are not injective at representational
role, decomposition is sound, but we may lose completeness.  Nevertheless,
if the newtype is abstract (so can't be unwrapped) we can only solve
the equality by (a) using a Given or (b) decomposition.  If (a) is impossible
(e.g. no Givens) then (b) is safe albeit potentially incomplete.

There are two ways in which decomposing (N ty1) ~r (N ty2) could be incomplete:

* Incompleteness example (EX1): unwrap first
      newtype Nt a = MkNt (Id a)
      type family Id a where Id a = a

      [W] Nt Int ~R Nt Age

  Because of its use of a type family, Nt's parameter will get inferred to
  have a nominal role. Thus, decomposing the wanted will yield [W] Int ~N Age,
  which is unsatisfiable. Unwrapping, though, leads to a solution.

  CONCLUSION: always unwrap newtypes before attempting to decompose
  them.  This is done in can_eq_nc.  Of course, we can't unwrap if the data
  constructor isn't in scope.  See Note [Unwrap newtypes first].

* Incompleteness example (EX2): see #24887
      data family D a
      data instance D Int  = MkD1 (D Char)
      data instance D Bool = MkD2 (D Char)
  Now suppose we have
      [W] g1: D Int ~R# D a
      [W] g2: a ~# Bool
  If we solve g2 first, giving a:=Bool, then we can solve g1 easily:
      D Int ~R# D Char ~R# D Bool
  by newtype unwrapping.

  BUT: if we instead attempt to solve g1 first, we can unwrap the LHS (only)
  leaving     [W] D Char ~#R D Bool
  If we decompose now, we'll get (Char ~R# Bool), which is insoluble.

  CONCLUSION: prioritise nominal equalites in the work list.
  See Note [Prioritise equalities] in GHC.Tc.Solver.InertSet.

* Incompleteness example (EX3): available Givens
      newtype Nt a = Mk Bool         -- NB: a is not used in the RHS,
      type role Nt representational  -- but the user gives it an R role anyway

      [G] Nt t1 ~R Nt t2
      [W] Nt alpha ~R Nt beta

  We *don't* want to decompose to [W] alpha ~R beta, because it's possible
  that alpha and beta aren't representationally equal.  And if we figure
  out (elsewhere) that alpha:=t1 and beta:=t2, we can solve the Wanted
  from the Given.  This is somewhat similar to the question of overlapping
  Givens for class constraints: see Note [Instance and Given overlap] in
  GHC.Tc.Solver.Dict.

  CONCLUSION: don't decompose [W] N s ~R N t, if there are any Given
  equalities that could later solve it.

  But what precisely does it mean to say &quot;any Given equalities that could
  later solve it&quot;?

  In #22924 we had
     [G] f a ~R# a     [W] Const (f a) a ~R# Const a a
  where Const is an abstract newtype.  If we decomposed the newtype, we
  could solve.  Not-decomposing on the grounds that (f a ~R# a) might turn
  into (Const (f a) a ~R# Const a a) seems a bit silly.

  In #22331 we had
     [G] N a ~R# N b   [W] N b ~R# N a
  (where N is abstract so we can't unwrap). Here we really /don't/ want to
  decompose, because the /only/ way to solve the Wanted is from that Given
  (with a Sym).

  In #22519 we had
     [G] a &lt;= b     [W] IO Age ~R# IO Int

  (where IO is abstract so we can't unwrap, and newtype Age = Int; and (&lt;=)
  is a type-level comparison on Nats).  Here we /must/ decompose, despite the
  existence of an Irred Given, or we will simply be stuck.  (Side note: We
  flirted with deep-rewriting of newtypes (see discussion on #22519 and
  !9623) but that turned out not to solve #22924, and also makes type
  inference loop more often on recursive newtypes.)

  The currently-implemented compromise is this:

    we decompose [W] N s ~R# N t unless there is a [G] N s' ~ N t'

  that is, a Given Irred equality with both sides headed with N.
  See the call to noGivenNewtypeReprEqs in canTyConApp.

  This is not perfect.  In principle a Given like [G] (a b) ~ (c d), or
  even just [G] c, could later turn into N s ~ N t.  But since the free
  vars of a Given are skolems, or at least untouchable unification
  variables, this is extremely unlikely to happen.

  Another worry: there could, just, be a CDictCan with some
  un-expanded equality superclasses; but only in some very obscure
  recursive-superclass situations.

   Yet another approach (!) is desribed in
   Note [Decomposing newtypes a bit more aggressively].

Remember: decomposing Wanteds is always /sound/. This Note is
only about /completeness/.

Note [Decomposing newtypes a bit more aggressively]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
IMPORTANT: the ideas in this Note are *not* implemented. Instead, the
current approach is detailed in Note [Decomposing newtype equalities]
and Note [Unwrap newtypes first].
For more details about the ideas in this Note see
  * GHC propoosal: https://github.com/ghc-proposals/ghc-proposals/pull/549
  * issue #22441
  * discussion on !9282.

Consider [G] c, [W] (IO Int) ~R (IO Age)
where IO is abstract, and
   newtype Age = MkAge Int   -- Not abstract
With the above rules, if there any Given Irreds,
the Wanted is insoluble because we can't decompose it.  But in fact,
if we look at the defn of IO, roughly,
    newtype IO a = State# -&gt; (State#, a)
we can see that decomposing [W] (IO Int) ~R (IO Age) to
    [W] Int ~R Age
definitely does not lose completeness. Why not? Because the role of
IO's argment is representational.  Hence:

  DecomposeNewtypeIdea:
     decompose [W] (N s1 .. sn) ~R (N t1 .. tn)
     if the roles of all N's arguments are representational

If N's arguments really /are/ representational this will not lose
completeness.  Here &quot;really are representational&quot; means &quot;if you expand
all newtypes in N's RHS, we'd infer a representational role for each
of N's type variables in that expansion&quot;.  See Note [Role inference]
in GHC.Tc.TyCl.Utils.

But the user might /override/ a phantom role with an explicit role
annotation, and then we could (obscurely) get incompleteness.
Consider

   module A( silly, T ) where
     newtype T a = MkT Int
     type role T representational  -- Override phantom role

     silly :: Coercion (T Int) (T Bool)
     silly = Coercion  -- Typechecks by unwrapping the newtype

     data Coercion a b where  -- Actually defined in Data.Type.Coercion
       Coercion :: Coercible a b =&gt; Coercion a b

   module B where
     import A
     f :: T Int -&gt; T Bool
     f = case silly of Coercion -&gt; coerce

Here the `coerce` gives [W] (T Int) ~R (T Bool) which, if we decompose,
we'll get stuck with (Int ~R Bool).  Instead we want to use the
[G] (T Int) ~R (T Bool), which will be in the Irreds.

Summary: we could adopt (DecomposeNewtypeIdea), at the cost of a very
obscure incompleteness (above).  But no one is reporting a problem from
the lack of decompostion, so we'll just leave it for now.  This long
Note is just to record the thinking for our future selves.

Note [Decomposing AppTy equalities]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For AppTy all the same questions arise as in
Note [Decomposing TyConApp equalities]. We have

    s1 ~r s2,  t1 ~N t2   ==&gt;   s1 t1 ~r s2 t2       (rule CO_APP)
    s1 t1 ~N s2 t2        ==&gt;   s1 ~N s2,  t1 ~N t2  (CO_LEFT, CO_RIGHT)

In the first of these, why do we need Nominal equality in (t1 ~N t2)?
See {2} below.

For sound and complete solving, we need both directions to decompose. So:
* At nominal role, all is well: we have both directions.
* At representational role, decomposition of Givens is unsound (see {1} below),
  and decomposition of Wanteds is incomplete.

Here is an example of the incompleteness for Wanteds:

    [G] g1 :: a ~R b
    [W] w1 :: Maybe b ~R alpha a
    [W] w2 :: alpha ~N Maybe

Suppose we see w1 before w2. If we decompose, using AppCo to prove w1, we get

    w1 := AppCo w3 w4
    [W] w3 :: Maybe ~R alpha
    [W] w4 :: b ~N a

Note that w4 is *nominal*. A nominal role here is necessary because AppCo
requires a nominal role on its second argument. (See {2} for an example of
why.) Now we are stuck, because w4 is insoluble. On the other hand, if we
see w2 first, setting alpha := Maybe, all is well, as we can decompose
Maybe b ~R Maybe a into b ~R a.

Another example:
    newtype Phant x = MkPhant Int
    [W] w1 :: Phant Int ~R alpha Bool
    [W] w2 :: alpha ~ Phant

If we see w1 first, decomposing would be disastrous, as we would then try
to solve Int ~ Bool. Instead, spotting w2 allows us to simplify w1 to become
    [W] w1' :: Phant Int ~R Phant Bool

which can then (assuming MkPhant is in scope) be simplified to Int ~R Int,
and all will be well. See also Note [Unwrap newtypes first].

Bottom line:
* Always decompose AppTy at nominal role: can_eq_app
* Never decompose AppTy at representational role (neither Given nor Wanted):
  the lack of an equation in can_eq_nc

Extra points
{1}  Decomposing a Given AppTy over a representational role is simply
     unsound. For example, if we have co1 :: Phant Int ~R a Bool (for
     the newtype Phant, above), then we surely don't want any relationship
     between Int and Bool, lest we also have co2 :: Phant ~ a around.

{2} The role on the AppCo coercion is a conservative choice, because we don't
    know the role signature of the function. For example, let's assume we could
    have a representational role on the second argument of AppCo. Then, consider

    data G a where    -- G will have a nominal role, as G is a GADT
      MkG :: G Int
    newtype Age = MkAge Int

    co1 :: G ~R a        -- by assumption
    co2 :: Age ~R Int    -- by newtype axiom
    co3 = AppCo co1 co2 :: G Age ~R a Int    -- by our broken AppCo

    and now co3 can be used to cast MkG to have type G Age, in violation of
    the way GADTs are supposed to work (which is to use nominal equality).
-}</span><span>
</span><span id="line-1314"></span><span>
</span><span id="line-1315"></span><span id="local-6989586621683042584"><span class="annot"><a href="GHC.Tc.Solver.Equality.html#canDecomposableTyConAppOK"><span class="hs-identifier hs-type">canDecomposableTyConAppOK</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#EqRel"><span class="hs-identifier hs-type">EqRel</span></a></span><span>
</span><span id="line-1316"></span><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span>
</span><span id="line-1317"></span><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">,</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">,</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1318"></span><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683042584"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-1319"></span><span class="hs-comment">-- Precondition: tys1 and tys2 are the same finite length, hence &quot;OK&quot;</span><span>
</span><span id="line-1320"></span><span id="canDecomposableTyConAppOK"><span class="annot"><span class="annottext">canDecomposableTyConAppOK :: forall a.
CtEvidence
-&gt; EqRel
-&gt; TyCon
-&gt; (TcType, [TcType])
-&gt; (TcType, [TcType])
-&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Equality.html#canDecomposableTyConAppOK"><span class="hs-identifier hs-var hs-var">canDecomposableTyConAppOK</span></a></span></span><span> </span><span id="local-6989586621683043753"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043753"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683043754"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043754"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span id="local-6989586621683043755"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043755"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043756"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043756"><span class="hs-identifier hs-var">ty1</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621683043757"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043757"><span class="hs-identifier hs-var">tys1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043758"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043758"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621683043759"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043759"><span class="hs-identifier hs-var">tys2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1321"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcS (StopOrContinue a) -&gt; TcS (StopOrContinue a)
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043757"><span class="hs-identifier hs-var">tys1</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; [TcType] -&gt; Bool
forall a b. [a] -&gt; [b] -&gt; Bool
</span><a href="GHC.Utils.Misc.html#equalLength"><span class="hs-operator hs-var">`equalLength`</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043759"><span class="hs-identifier hs-var">tys2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcS (StopOrContinue a) -&gt; TcS (StopOrContinue a))
-&gt; TcS (StopOrContinue a) -&gt; TcS (StopOrContinue a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1322"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;canDecomposableTyConAppOK&quot;</span></span><span>
</span><span id="line-1323"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043753"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043754"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043755"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043757"><span class="hs-identifier hs-var">tys1</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043759"><span class="hs-identifier hs-var">tys2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1324"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043753"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1325"></span><span>           </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtWanted"><span class="hs-identifier hs-type">CtWanted</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ctev_dest :: CtEvidence -&gt; TcEvDest
</span><a href="GHC.Tc.Types.Constraint.html#ctev_dest"><span class="hs-identifier hs-var">ctev_dest</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683043760"><span class="annot"><span class="annottext">TcEvDest
</span><a href="#local-6989586621683043760"><span class="hs-identifier hs-var">dest</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1326"></span><span>             </span><span class="hs-comment">-- new_locs and tc_roles are both infinite, so we are</span><span>
</span><span id="line-1327"></span><span>             </span><span class="hs-comment">-- guaranteed that cos has the same length as tys1 and tys2</span><span>
</span><span id="line-1328"></span><span>             </span><span class="hs-comment">-- See Note [Fast path when decomposing TyConApps]</span><span>
</span><span id="line-1329"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043761"><span class="annot"><a href="#local-6989586621683043761"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtEvidence
-&gt; Role
-&gt; (UnifyEnv -&gt; TcM TcCoercion)
-&gt; TcS (TcCoercion, Cts, [TcTyVar])
forall a.
CtEvidence
-&gt; Role -&gt; (UnifyEnv -&gt; TcM a) -&gt; TcS (a, Cts, [TcTyVar])
</span><a href="GHC.Tc.Solver.Monad.html#wrapUnifierTcS"><span class="hs-identifier hs-var">wrapUnifierTcS</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043753"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683043762"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">((UnifyEnv -&gt; TcM TcCoercion) -&gt; TcS (TcCoercion, Cts, [TcTyVar]))
-&gt; (UnifyEnv -&gt; TcM TcCoercion) -&gt; TcS (TcCoercion, Cts, [TcTyVar])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621683043763"><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683043763"><span class="hs-identifier hs-var">uenv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1330"></span><span>                        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683043764"><span class="annot"><a href="#local-6989586621683043764"><span class="hs-identifier hs-var">cos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(CtLoc -&gt; Role -&gt; TcType -&gt; TcType -&gt; TcM TcCoercion)
-&gt; [CtLoc]
-&gt; [Role]
-&gt; [TcType]
-&gt; [TcType]
-&gt; IOEnv (Env TcGblEnv TcLclEnv) [TcCoercion]
forall (m :: * -&gt; *) a b c d e.
Monad m =&gt;
(a -&gt; b -&gt; c -&gt; d -&gt; m e) -&gt; [a] -&gt; [b] -&gt; [c] -&gt; [d] -&gt; m [e]
</span><a href="GHC.Utils.Monad.html#zipWith4M"><span class="hs-identifier hs-var">zipWith4M</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UnifyEnv -&gt; CtLoc -&gt; Role -&gt; TcType -&gt; TcType -&gt; TcM TcCoercion
</span><a href="#local-6989586621683043766"><span class="hs-identifier hs-var">u_arg</span></a></span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683043763"><span class="hs-identifier hs-var">uenv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CtLoc]
</span><a href="#local-6989586621683043767"><span class="hs-identifier hs-var">new_locs</span></a></span><span> </span><span class="annot"><span class="annottext">[Role]
</span><a href="#local-6989586621683043768"><span class="hs-identifier hs-var">tc_roles</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043757"><span class="hs-identifier hs-var">tys1</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043759"><span class="hs-identifier hs-var">tys2</span></a></span><span>
</span><span id="line-1331"></span><span>                                    </span><span class="hs-comment">-- zipWith4M: see Note [Work-list ordering]</span><span>
</span><span id="line-1332"></span><span>                                    </span><span class="hs-comment">-- in GHC.Tc.Solved.Equality</span><span>
</span><span id="line-1333"></span><span>                           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-type">mkTyConAppCo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043762"><span class="hs-keyword hs-type">role</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043755"><span class="hs-identifier hs-type">tc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043764"><span class="hs-identifier hs-type">cos</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1334"></span><span>                   </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#setWantedEq"><span class="hs-identifier hs-type">setWantedEq</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043760"><span class="hs-identifier hs-type">dest</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043761"><span class="hs-identifier hs-type">co</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1335"></span><span>
</span><span id="line-1336"></span><span>           </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtGiven"><span class="hs-identifier hs-type">CtGiven</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ctev_evar :: CtEvidence -&gt; TcTyVar
</span><a href="GHC.Tc.Types.Constraint.html#ctev_evar"><span class="hs-identifier hs-var">ctev_evar</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683043770"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043770"><span class="hs-identifier hs-var">evar</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1337"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683043771"><span class="annot"><span class="annottext">pred_ty :: TcType
</span><a href="#local-6989586621683043771"><span class="hs-identifier hs-var hs-var">pred_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role -&gt; TcType -&gt; TcType -&gt; TcType
</span><a href="GHC.Core.Coercion.html#mkPrimEqPredRole"><span class="hs-identifier hs-var">mkPrimEqPredRole</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EqRel -&gt; Role
</span><a href="GHC.Core.Predicate.html#eqRelRole"><span class="hs-identifier hs-var">eqRelRole</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043754"><span class="hs-identifier hs-var">eq_rel</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043756"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043758"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-1338"></span><span>                   </span><span id="local-6989586621683043773"><span class="annot"><span class="annottext">ev_co :: TcCoercion
</span><a href="#local-6989586621683043773"><span class="hs-identifier hs-var hs-var">ev_co</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcCoercion
</span><a href="GHC.Core.Coercion.html#mkCoVarCo"><span class="hs-identifier hs-var">mkCoVarCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType -&gt; TcTyVar
</span><a href="GHC.Types.Var.html#setVarType"><span class="hs-identifier hs-var">setVarType</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043770"><span class="hs-identifier hs-var">evar</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043771"><span class="hs-identifier hs-var">pred_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1339"></span><span>                   </span><span class="hs-comment">-- setVarType: satisfy Note [mkSelCo precondition] in Coercion.hs</span><span>
</span><span id="line-1340"></span><span>                   </span><span class="hs-comment">-- Remember: ty1/ty2 may be more fully zonked than evar</span><span>
</span><span id="line-1341"></span><span>                   </span><span class="hs-comment">--           See the call to canonicaliseEquality in solveEquality.</span><span>
</span><span id="line-1342"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; [(Role, TcCoercion)] -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#emitNewGivens"><span class="hs-identifier hs-var">emitNewGivens</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683043776"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-1343"></span><span>                       </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683043777"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoSel -&gt; TcCoercion -&gt; TcCoercion
CoSel -&gt; TcCoercion -&gt; TcCoercion
</span><a href="GHC.Core.Coercion.html#mkSelCo"><span class="hs-identifier hs-var">mkSelCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Role -&gt; CoSel
</span><a href="GHC.Core.TyCo.Rep.html#SelTyCon"><span class="hs-identifier hs-var">SelTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683043780"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683043777"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683043773"><span class="hs-identifier hs-var">ev_co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1344"></span><span>                       </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043777"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683043777"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043781"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043781"><span class="hs-identifier hs-var">ty1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043782"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043782"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043780"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683043780"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Role]
-&gt; [TcType] -&gt; [TcType] -&gt; [Int] -&gt; [(Role, TcType, TcType, Int)]
forall a b c d. [a] -&gt; [b] -&gt; [c] -&gt; [d] -&gt; [(a, b, c, d)]
</span><span class="hs-identifier hs-var">zip4</span></span><span> </span><span class="annot"><span class="annottext">[Role]
</span><a href="#local-6989586621683043768"><span class="hs-identifier hs-var">tc_roles</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043757"><span class="hs-identifier hs-var">tys1</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043759"><span class="hs-identifier hs-var">tys2</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-glyph">..</span><span class="hs-special">]</span><span>
</span><span id="line-1345"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683043777"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Role -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Phantom"><span class="hs-identifier hs-var">Phantom</span></a></span><span>
</span><span id="line-1346"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="GHC.Core.Type.html#isCoercionTy"><span class="hs-identifier hs-var">isCoercionTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043781"><span class="hs-identifier hs-var">ty1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="GHC.Core.Type.html#isCoercionTy"><span class="hs-identifier hs-var">isCoercionTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043782"><span class="hs-identifier hs-var">ty2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1347"></span><span>
</span><span id="line-1348"></span><span>    </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; String -&gt; TcS (StopOrContinue a)
forall a. CtEvidence -&gt; String -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Monad.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043753"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Decomposed TyConApp&quot;</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1349"></span><span>
</span><span id="line-1350"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1351"></span><span>    </span><span id="local-6989586621683043776"><span class="annot"><span class="annottext">loc :: CtLoc
</span><a href="#local-6989586621683043776"><span class="hs-identifier hs-var hs-var">loc</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043753"><span class="hs-identifier hs-var">ev</span></a></span><span>
</span><span id="line-1352"></span><span>    </span><span id="local-6989586621683043762"><span class="annot"><span class="annottext">role :: Role
</span><a href="#local-6989586621683043762"><span class="hs-keyword hs-var hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; Role
</span><a href="GHC.Core.Predicate.html#eqRelRole"><span class="hs-identifier hs-var">eqRelRole</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043754"><span class="hs-identifier hs-var">eq_rel</span></a></span><span>
</span><span id="line-1353"></span><span>
</span><span id="line-1354"></span><span>    </span><span id="local-6989586621683043766"><span class="annot"><span class="annottext">u_arg :: UnifyEnv -&gt; CtLoc -&gt; Role -&gt; TcType -&gt; TcType -&gt; TcM TcCoercion
</span><a href="#local-6989586621683043766"><span class="hs-identifier hs-var hs-var">u_arg</span></a></span></span><span> </span><span id="local-6989586621683043786"><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683043786"><span class="hs-identifier hs-var">uenv</span></a></span></span><span> </span><span id="local-6989586621683043787"><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683043787"><span class="hs-identifier hs-var">arg_loc</span></a></span></span><span> </span><span id="local-6989586621683043788"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683043788"><span class="hs-identifier hs-var">arg_role</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnifyEnv -&gt; TcType -&gt; TcType -&gt; TcM TcCoercion
</span><a href="GHC.Tc.Utils.Unify.html#uType"><span class="hs-identifier hs-var">uType</span></a></span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683043789"><span class="hs-identifier hs-var">arg_env</span></a></span><span>
</span><span id="line-1355"></span><span>       </span><span class="hs-keyword">where</span><span>
</span><span id="line-1356"></span><span>         </span><span id="local-6989586621683043789"><span class="annot"><span class="annottext">arg_env :: UnifyEnv
</span><a href="#local-6989586621683043789"><span class="hs-identifier hs-var hs-var">arg_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683043786"><span class="hs-identifier hs-var">uenv</span></a></span><span> </span><span class="annot"><span class="annottext">UnifyEnv -&gt; Role -&gt; UnifyEnv
</span><a href="GHC.Tc.Utils.Unify.html#setUEnvRole"><span class="hs-operator hs-var">`setUEnvRole`</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683043788"><span class="hs-identifier hs-var">arg_role</span></a></span><span>
</span><span id="line-1357"></span><span>                        </span><span class="annot"><span class="annottext">UnifyEnv -&gt; (CtLoc -&gt; CtLoc) -&gt; UnifyEnv
</span><a href="GHC.Tc.Utils.Unify.html#updUEnvLoc"><span class="hs-operator hs-var">`updUEnvLoc`</span></a></span><span>  </span><span class="annot"><span class="annottext">CtLoc -&gt; CtLoc -&gt; CtLoc
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683043787"><span class="hs-identifier hs-var">arg_loc</span></a></span><span>
</span><span id="line-1358"></span><span>
</span><span id="line-1359"></span><span>    </span><span class="hs-comment">-- Infinite, to allow for over-saturated TyConApps</span><span>
</span><span id="line-1360"></span><span>    </span><span id="local-6989586621683043768"><span class="annot"><span class="annottext">tc_roles :: [Role]
</span><a href="#local-6989586621683043768"><span class="hs-identifier hs-var hs-var">tc_roles</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role -&gt; TyCon -&gt; [Role]
</span><a href="GHC.Core.Coercion.html#tyConRoleListX"><span class="hs-identifier hs-var">tyConRoleListX</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683043762"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043755"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-1361"></span><span>
</span><span id="line-1362"></span><span>      </span><span class="hs-comment">-- Add nuances to the location during decomposition:</span><span>
</span><span id="line-1363"></span><span>      </span><span class="hs-comment">--  * if the argument is a kind argument, remember this, so that error</span><span>
</span><span id="line-1364"></span><span>      </span><span class="hs-comment">--    messages say &quot;kind&quot;, not &quot;type&quot;. This is determined based on whether</span><span>
</span><span id="line-1365"></span><span>      </span><span class="hs-comment">--    the corresponding tyConBinder is named (that is, dependent)</span><span>
</span><span id="line-1366"></span><span>      </span><span class="hs-comment">--  * if the argument is invisible, note this as well, again by</span><span>
</span><span id="line-1367"></span><span>      </span><span class="hs-comment">--    looking at the corresponding binder</span><span>
</span><span id="line-1368"></span><span>      </span><span class="hs-comment">-- For oversaturated tycons, we need the (repeat loc) tail, which doesn't</span><span>
</span><span id="line-1369"></span><span>      </span><span class="hs-comment">-- do either of these changes. (Forgetting to do so led to #16188)</span><span>
</span><span id="line-1370"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-1371"></span><span>      </span><span class="hs-comment">-- NB: infinite in length</span><span>
</span><span id="line-1372"></span><span>    </span><span id="local-6989586621683043767"><span class="annot"><span class="annottext">new_locs :: [CtLoc]
</span><a href="#local-6989586621683043767"><span class="hs-identifier hs-var hs-var">new_locs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">TyConBinder -&gt; CtLoc -&gt; CtLoc
</span><a href="GHC.Tc.Types.CtLoc.html#adjustCtLocTyConBinder"><span class="hs-identifier hs-var">adjustCtLocTyConBinder</span></a></span><span> </span><span class="annot"><span class="annottext">TyConBinder
</span><a href="#local-6989586621683043793"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683043776"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-1373"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621683043793"><span class="annot"><span class="annottext">TyConBinder
</span><a href="#local-6989586621683043793"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [TyConBinder]
</span><a href="GHC.Core.TyCon.html#tyConBinders"><span class="hs-identifier hs-var">tyConBinders</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043755"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1374"></span><span>               </span><span class="annot"><span class="annottext">[CtLoc] -&gt; [CtLoc] -&gt; [CtLoc]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; [CtLoc]
forall a. a -&gt; [a]
</span><span class="hs-identifier hs-var">repeat</span></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683043776"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-1375"></span><span>
</span><span id="line-1376"></span><span id="local-6989586621683042550"><span class="annot"><a href="GHC.Tc.Solver.Equality.html#canDecomposableFunTy"><span class="hs-identifier hs-type">canDecomposableFunTy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#EqRel"><span class="hs-identifier hs-type">EqRel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#FunTyFlag"><span class="hs-identifier hs-type">FunTyFlag</span></a></span><span>
</span><span id="line-1377"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- (fun_ty,multiplicity,arg,res)</span><span>
</span><span id="line-1378"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- (fun_ty,multiplicity,arg,res)</span><span>
</span><span id="line-1379"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683042550"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-1380"></span><span id="canDecomposableFunTy"><span class="annot"><span class="annottext">canDecomposableFunTy :: forall a.
CtEvidence
-&gt; EqRel
-&gt; FunTyFlag
-&gt; (TcType, TcType, TcType, TcType)
-&gt; (TcType, TcType, TcType, TcType)
-&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Equality.html#canDecomposableFunTy"><span class="hs-identifier hs-var hs-var">canDecomposableFunTy</span></a></span></span><span> </span><span id="local-6989586621683043813"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043813"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683043814"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043814"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span id="local-6989586621683043815"><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683043815"><span class="hs-identifier hs-var">af</span></a></span></span><span> </span><span id="local-6989586621683043816"><span class="annot"><span class="annottext">f1 :: (TcType, TcType, TcType, TcType)
</span><a href="#local-6989586621683043816"><span class="hs-identifier hs-var">f1</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621683043817"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043817"><span class="hs-identifier hs-var">ty1</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621683043818"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043818"><span class="hs-identifier hs-var">m1</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621683043819"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043819"><span class="hs-identifier hs-var">a1</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621683043820"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043820"><span class="hs-identifier hs-var">r1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621683043821"><span class="annot"><span class="annottext">f2 :: (TcType, TcType, TcType, TcType)
</span><a href="#local-6989586621683043821"><span class="hs-identifier hs-var">f2</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621683043822"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043822"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621683043823"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043823"><span class="hs-identifier hs-var">m2</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621683043824"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043824"><span class="hs-identifier hs-var">a2</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621683043825"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043825"><span class="hs-identifier hs-var">r2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1381"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;canDecomposableFunTy&quot;</span></span><span>
</span><span id="line-1382"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043813"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043814"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">(TcType, TcType, TcType, TcType) -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">(TcType, TcType, TcType, TcType)
</span><a href="#local-6989586621683043816"><span class="hs-identifier hs-var">f1</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">(TcType, TcType, TcType, TcType) -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">(TcType, TcType, TcType, TcType)
</span><a href="#local-6989586621683043821"><span class="hs-identifier hs-var">f2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1383"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043813"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1384"></span><span>           </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtWanted"><span class="hs-identifier hs-type">CtWanted</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ctev_dest :: CtEvidence -&gt; TcEvDest
</span><a href="GHC.Tc.Types.Constraint.html#ctev_dest"><span class="hs-identifier hs-var">ctev_dest</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683043826"><span class="annot"><span class="annottext">TcEvDest
</span><a href="#local-6989586621683043826"><span class="hs-identifier hs-var">dest</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1385"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043827"><span class="annot"><a href="#local-6989586621683043827"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtEvidence
-&gt; Role
-&gt; (UnifyEnv -&gt; TcM TcCoercion)
-&gt; TcS (TcCoercion, Cts, [TcTyVar])
forall a.
CtEvidence
-&gt; Role -&gt; (UnifyEnv -&gt; TcM a) -&gt; TcS (a, Cts, [TcTyVar])
</span><a href="GHC.Tc.Solver.Monad.html#wrapUnifierTcS"><span class="hs-identifier hs-var">wrapUnifierTcS</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043813"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="annot"><span class="annottext">((UnifyEnv -&gt; TcM TcCoercion) -&gt; TcS (TcCoercion, Cts, [TcTyVar]))
-&gt; (UnifyEnv -&gt; TcM TcCoercion) -&gt; TcS (TcCoercion, Cts, [TcTyVar])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621683043828"><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683043828"><span class="hs-identifier hs-var">uenv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1386"></span><span>                        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683043829"><span class="annot"><span class="annottext">mult_env :: UnifyEnv
</span><a href="#local-6989586621683043829"><span class="hs-identifier hs-var hs-var hs-var">mult_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683043828"><span class="hs-identifier hs-var">uenv</span></a></span><span> </span><span class="annot"><span class="annottext">UnifyEnv -&gt; (CtLoc -&gt; CtLoc) -&gt; UnifyEnv
</span><a href="GHC.Tc.Utils.Unify.html#updUEnvLoc"><span class="hs-operator hs-var">`updUEnvLoc`</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; CtLoc
</span><a href="GHC.Tc.Types.CtLoc.html#toInvisibleLoc"><span class="hs-identifier hs-var">toInvisibleLoc</span></a></span><span>
</span><span id="line-1387"></span><span>                                                 </span><span class="annot"><span class="annottext">UnifyEnv -&gt; Role -&gt; UnifyEnv
</span><a href="GHC.Tc.Utils.Unify.html#setUEnvRole"><span class="hs-operator hs-var">`setUEnvRole`</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; FunSel -&gt; Role
</span><a href="GHC.Core.Coercion.html#funRole"><span class="hs-identifier hs-var">funRole</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683043832"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">FunSel
</span><a href="GHC.Core.TyCo.Rep.html#SelMult"><span class="hs-identifier hs-var">SelMult</span></a></span><span>
</span><span id="line-1388"></span><span>                           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683043834"><span class="annot"><a href="#local-6989586621683043834"><span class="hs-identifier hs-var">mult</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UnifyEnv -&gt; TcType -&gt; TcType -&gt; TcM TcCoercion
</span><a href="GHC.Tc.Utils.Unify.html#uType"><span class="hs-identifier hs-var">uType</span></a></span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683043829"><span class="hs-identifier hs-var">mult_env</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043818"><span class="hs-identifier hs-var">m1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043823"><span class="hs-identifier hs-var">m2</span></a></span><span>
</span><span id="line-1389"></span><span>                           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683043835"><span class="annot"><a href="#local-6989586621683043835"><span class="hs-identifier hs-var">arg</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#uType"><span class="hs-identifier hs-type">uType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683043828"><span class="hs-identifier hs-type">uenv</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#setUEnvRole"><span class="hs-operator hs-type">`setUEnvRole`</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#funRole"><span class="hs-identifier hs-type">funRole</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043832"><span class="hs-keyword hs-type">role</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#SelArg"><span class="hs-identifier hs-type">SelArg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683043819"><span class="hs-identifier hs-type">a1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043824"><span class="hs-identifier hs-type">a2</span></a></span><span>
</span><span id="line-1390"></span><span>                           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683043837"><span class="annot"><a href="#local-6989586621683043837"><span class="hs-identifier hs-var">res</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#uType"><span class="hs-identifier hs-type">uType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683043828"><span class="hs-identifier hs-type">uenv</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#setUEnvRole"><span class="hs-operator hs-type">`setUEnvRole`</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#funRole"><span class="hs-identifier hs-type">funRole</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043832"><span class="hs-keyword hs-type">role</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#SelRes"><span class="hs-identifier hs-type">SelRes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683043820"><span class="hs-identifier hs-type">r1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043825"><span class="hs-identifier hs-type">r2</span></a></span><span>
</span><span id="line-1391"></span><span>                           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.html#mkNakedFunCo"><span class="hs-identifier hs-type">mkNakedFunCo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043832"><span class="hs-keyword hs-type">role</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043815"><span class="hs-identifier hs-type">af</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043834"><span class="hs-identifier hs-type">mult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043835"><span class="hs-identifier hs-type">arg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043837"><span class="hs-identifier hs-type">res</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1392"></span><span>                   </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#setWantedEq"><span class="hs-identifier hs-type">setWantedEq</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043826"><span class="hs-identifier hs-type">dest</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043827"><span class="hs-identifier hs-type">co</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1393"></span><span>
</span><span id="line-1394"></span><span>           </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtGiven"><span class="hs-identifier hs-type">CtGiven</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ctev_evar :: CtEvidence -&gt; TcTyVar
</span><a href="GHC.Tc.Types.Constraint.html#ctev_evar"><span class="hs-identifier hs-var">ctev_evar</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683043840"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043840"><span class="hs-identifier hs-var">evar</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1395"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683043841"><span class="annot"><span class="annottext">pred_ty :: TcType
</span><a href="#local-6989586621683043841"><span class="hs-identifier hs-var hs-var">pred_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role -&gt; TcType -&gt; TcType -&gt; TcType
</span><a href="GHC.Core.Coercion.html#mkPrimEqPredRole"><span class="hs-identifier hs-var">mkPrimEqPredRole</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EqRel -&gt; Role
</span><a href="GHC.Core.Predicate.html#eqRelRole"><span class="hs-identifier hs-var">eqRelRole</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043814"><span class="hs-identifier hs-var">eq_rel</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043817"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043822"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-1396"></span><span>                   </span><span id="local-6989586621683043842"><span class="annot"><span class="annottext">ev_co :: TcCoercion
</span><a href="#local-6989586621683043842"><span class="hs-identifier hs-var hs-var">ev_co</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcCoercion
</span><a href="GHC.Core.Coercion.html#mkCoVarCo"><span class="hs-identifier hs-var">mkCoVarCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType -&gt; TcTyVar
</span><a href="GHC.Types.Var.html#setVarType"><span class="hs-identifier hs-var">setVarType</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043840"><span class="hs-identifier hs-var">evar</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043841"><span class="hs-identifier hs-var">pred_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1397"></span><span>                   </span><span class="hs-comment">-- setVarType: satisfy Note [mkSelCo precondition] in Coercion.hs</span><span>
</span><span id="line-1398"></span><span>                   </span><span class="hs-comment">-- Remember: ty1/ty2 may be more fully zonked than evar</span><span>
</span><span id="line-1399"></span><span>                   </span><span class="hs-comment">--           See the call to canonicaliseEquality in solveEquality.</span><span>
</span><span id="line-1400"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; [(Role, TcCoercion)] -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#emitNewGivens"><span class="hs-identifier hs-var">emitNewGivens</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683043843"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-1401"></span><span>                       </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; FunSel -&gt; Role
</span><a href="GHC.Core.Coercion.html#funRole"><span class="hs-identifier hs-var">funRole</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683043832"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">FunSel
</span><a href="#local-6989586621683043844"><span class="hs-identifier hs-var">fs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoSel -&gt; TcCoercion -&gt; TcCoercion
CoSel -&gt; TcCoercion -&gt; TcCoercion
</span><a href="GHC.Core.Coercion.html#mkSelCo"><span class="hs-identifier hs-var">mkSelCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FunSel -&gt; CoSel
</span><a href="GHC.Core.TyCo.Rep.html#SelFun"><span class="hs-identifier hs-var">SelFun</span></a></span><span> </span><span class="annot"><span class="annottext">FunSel
</span><a href="#local-6989586621683043844"><span class="hs-identifier hs-var">fs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683043842"><span class="hs-identifier hs-var">ev_co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1402"></span><span>                       </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621683043844"><span class="annot"><span class="annottext">FunSel
</span><a href="#local-6989586621683043844"><span class="hs-identifier hs-var">fs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">FunSel
</span><a href="GHC.Core.TyCo.Rep.html#SelMult"><span class="hs-identifier hs-var">SelMult</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FunSel
</span><a href="GHC.Core.TyCo.Rep.html#SelArg"><span class="hs-identifier hs-var">SelArg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FunSel
</span><a href="GHC.Core.TyCo.Rep.html#SelRes"><span class="hs-identifier hs-var">SelRes</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1403"></span><span>
</span><span id="line-1404"></span><span>    </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; String -&gt; TcS (StopOrContinue a)
forall a. CtEvidence -&gt; String -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Monad.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043813"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Decomposed TyConApp&quot;</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1405"></span><span>
</span><span id="line-1406"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1407"></span><span>    </span><span id="local-6989586621683043843"><span class="annot"><span class="annottext">loc :: CtLoc
</span><a href="#local-6989586621683043843"><span class="hs-identifier hs-var hs-var">loc</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043813"><span class="hs-identifier hs-var">ev</span></a></span><span>
</span><span id="line-1408"></span><span>    </span><span id="local-6989586621683043832"><span class="annot"><span class="annottext">role :: Role
</span><a href="#local-6989586621683043832"><span class="hs-keyword hs-var hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; Role
</span><a href="GHC.Core.Predicate.html#eqRelRole"><span class="hs-identifier hs-var">eqRelRole</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043814"><span class="hs-identifier hs-var">eq_rel</span></a></span><span>
</span><span id="line-1409"></span><span>
</span><span id="line-1410"></span><span class="hs-comment">-- | Call canEqSoftFailure when canonicalizing an equality fails, but if the</span><span>
</span><span id="line-1411"></span><span class="hs-comment">-- equality is representational, there is some hope for the future.</span><span>
</span><span id="line-1412"></span><span id="local-6989586621683042585"><span class="annot"><a href="GHC.Tc.Solver.Equality.html#canEqSoftFailure"><span class="hs-identifier hs-type">canEqSoftFailure</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#EqRel"><span class="hs-identifier hs-type">EqRel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>
</span><span id="line-1413"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#IrredCt"><span class="hs-identifier hs-type">IrredCt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683042585"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-1414"></span><span id="canEqSoftFailure"><span class="annot"><span class="annottext">canEqSoftFailure :: forall a.
CtEvidence
-&gt; EqRel
-&gt; TcType
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt a))
</span><a href="GHC.Tc.Solver.Equality.html#canEqSoftFailure"><span class="hs-identifier hs-var hs-var">canEqSoftFailure</span></a></span></span><span> </span><span id="local-6989586621683043856"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043856"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#NomEq"><span class="hs-identifier hs-var">NomEq</span></a></span><span> </span><span id="local-6989586621683043857"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043857"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683043858"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043858"><span class="hs-identifier hs-var">ty2</span></a></span></span><span>
</span><span id="line-1415"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence
-&gt; TcType -&gt; TcType -&gt; TcS (StopOrContinue (Either IrredCt a))
forall a.
CtEvidence
-&gt; TcType -&gt; TcType -&gt; TcS (StopOrContinue (Either IrredCt a))
</span><a href="GHC.Tc.Solver.Equality.html#canEqHardFailure"><span class="hs-identifier hs-var">canEqHardFailure</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043856"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043857"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043858"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-1416"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#canEqSoftFailure"><span class="hs-identifier hs-var">canEqSoftFailure</span></a></span><span> </span><span id="local-6989586621683043859"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043859"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#ReprEq"><span class="hs-identifier hs-var">ReprEq</span></a></span><span> </span><span id="local-6989586621683043860"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043860"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683043861"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043861"><span class="hs-identifier hs-var">ty2</span></a></span></span><span>
</span><span id="line-1417"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043862"><span class="annot"><a href="#local-6989586621683043862"><span class="hs-identifier hs-var">redn1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043863"><span class="annot"><a href="#local-6989586621683043863"><span class="hs-identifier hs-var">rewriters1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; TcType -&gt; TcS (Reduction, RewriterSet)
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite"><span class="hs-identifier hs-var">rewrite</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043859"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043860"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-1418"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043864"><span class="annot"><a href="#local-6989586621683043864"><span class="hs-identifier hs-var">redn2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043865"><span class="annot"><a href="#local-6989586621683043865"><span class="hs-identifier hs-var">rewriters2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewrite"><span class="hs-identifier hs-type">rewrite</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043859"><span class="hs-identifier hs-type">ev</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043861"><span class="hs-identifier hs-type">ty2</span></a></span><span>
</span><span id="line-1419"></span><span>            </span><span class="hs-comment">-- We must rewrite the types before putting them in the</span><span>
</span><span id="line-1420"></span><span>            </span><span class="hs-comment">-- inert set, so that we are sure to kick them out when</span><span>
</span><span id="line-1421"></span><span>            </span><span class="hs-comment">-- new equalities become available</span><span>
</span><span id="line-1422"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-type">traceTcS</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;canEqSoftFailure with ReprEq&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-1423"></span><span>         </span><span class="annot"><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-type">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043859"><span class="hs-identifier hs-type">ev</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043862"><span class="hs-identifier hs-type">redn1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043864"><span class="hs-identifier hs-type">redn2</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1424"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683043866"><span class="annot"><a href="#local-6989586621683043866"><span class="hs-identifier hs-var">new_ev</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#rewriteEqEvidence"><span class="hs-identifier hs-type">rewriteEqEvidence</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683043863"><span class="hs-identifier hs-type">rewriters1</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">S.&lt;&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621683043865"><span class="hs-identifier hs-type">rewriters2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683043859"><span class="hs-identifier hs-type">ev</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#NotSwapped"><span class="hs-identifier hs-type">NotSwapped</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043862"><span class="hs-identifier hs-type">redn1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043864"><span class="hs-identifier hs-type">redn2</span></a></span><span>
</span><span id="line-1425"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#finishCanWithIrred"><span class="hs-identifier hs-type">finishCanWithIrred</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ReprEqReason"><span class="hs-identifier hs-type">ReprEqReason</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043866"><span class="hs-identifier hs-type">new_ev</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1426"></span><span>
</span><span id="line-1427"></span><span class="annot"><span class="hs-comment">-- | Call when canonicalizing an equality fails with utterly no hope.</span></span><span>
</span><span id="line-1428"></span><span id="local-6989586621683042560"><span class="annot"><a href="GHC.Tc.Solver.Equality.html#canEqHardFailure"><span class="hs-identifier hs-type">canEqHardFailure</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>
</span><span id="line-1429"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#IrredCt"><span class="hs-identifier hs-type">IrredCt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683042560"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-1430"></span><span class="hs-comment">-- See Note [Make sure that insolubles are fully rewritten]</span><span>
</span><span id="line-1431"></span><span id="canEqHardFailure"><span class="annot"><span class="annottext">canEqHardFailure :: forall a.
CtEvidence
-&gt; TcType -&gt; TcType -&gt; TcS (StopOrContinue (Either IrredCt a))
</span><a href="GHC.Tc.Solver.Equality.html#canEqHardFailure"><span class="hs-identifier hs-var hs-var">canEqHardFailure</span></a></span></span><span> </span><span id="local-6989586621683043875"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043875"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683043876"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043876"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683043877"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043877"><span class="hs-identifier hs-var">ty2</span></a></span></span><span>
</span><span id="line-1432"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;canEqHardFailure&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043876"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043877"><span class="hs-identifier hs-var">ty2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1433"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043878"><span class="annot"><a href="#local-6989586621683043878"><span class="hs-identifier hs-var">redn1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043879"><span class="annot"><a href="#local-6989586621683043879"><span class="hs-identifier hs-var">rewriters1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; TcType -&gt; TcS (Reduction, RewriterSet)
</span><a href="GHC.Tc.Solver.Rewrite.html#rewriteForErrors"><span class="hs-identifier hs-var">rewriteForErrors</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043875"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043876"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-1434"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043881"><span class="annot"><a href="#local-6989586621683043881"><span class="hs-identifier hs-var">redn2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043882"><span class="annot"><a href="#local-6989586621683043882"><span class="hs-identifier hs-var">rewriters2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewriteForErrors"><span class="hs-identifier hs-type">rewriteForErrors</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043875"><span class="hs-identifier hs-type">ev</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043877"><span class="hs-identifier hs-type">ty2</span></a></span><span>
</span><span id="line-1435"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683043883"><span class="annot"><a href="#local-6989586621683043883"><span class="hs-identifier hs-var">new_ev</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#rewriteEqEvidence"><span class="hs-identifier hs-type">rewriteEqEvidence</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683043879"><span class="hs-identifier hs-type">rewriters1</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">S.&lt;&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621683043882"><span class="hs-identifier hs-type">rewriters2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683043875"><span class="hs-identifier hs-type">ev</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#NotSwapped"><span class="hs-identifier hs-type">NotSwapped</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043878"><span class="hs-identifier hs-type">redn1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043881"><span class="hs-identifier hs-type">redn2</span></a></span><span>
</span><span id="line-1436"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#finishCanWithIrred"><span class="hs-identifier hs-type">finishCanWithIrred</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ShapeMismatchReason"><span class="hs-identifier hs-type">ShapeMismatchReason</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043883"><span class="hs-identifier hs-type">new_ev</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1437"></span><span>
</span><span id="line-1438"></span><span class="hs-comment">{-
Note [Canonicalising type applications]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Given (s1 t1) ~ ty2, how should we proceed?
The simple thing is to see if ty2 is of form (s2 t2), and
decompose.

However, over-eager decomposition gives bad error messages
for things like
   a b ~ Maybe c
   e f ~ p -&gt; q
Suppose (in the first example) we already know a~Array.  Then if we
decompose the application eagerly, yielding
   a ~ Maybe
   b ~ c
we get an error        &quot;Can't match Array ~ Maybe&quot;,
but we'd prefer to get &quot;Can't match Array b ~ Maybe c&quot;.

So instead can_eq_wanted_app rewrites the LHS and RHS, in the hope of
replacing (a b) by (Array b), before using try_decompose_app to
decompose it.

Note [Make sure that insolubles are fully rewritten]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When an equality fails, we still want to rewrite the equality
all the way down, so that it accurately reflects
 (a) the mutable reference substitution in force at start of solving
 (b) any ty-binds in force at this point in solving
See Note [Rewrite insolubles] in GHC.Tc.Solver.InertSet.
And if we don't do this there is a bad danger that
GHC.Tc.Solver.applyTyVarDefaulting will find a variable
that has in fact been substituted.

Note [Do not decompose Given polytype equalities]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider [G] (forall a. t1 ~ forall a. t2).  Can we decompose this?
No -- what would the evidence look like?  So instead we simply discard
this given evidence.

Note [No top-level newtypes on RHS of representational equalities]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we're in this situation:

 work item:  [W] c1 : a ~R b
     inert:  [G] c2 : b ~R Id a

where
  newtype Id a = Id a

We want to make sure canEqCanLHS sees [W] a ~R a, after b is rewritten
and the Id newtype is unwrapped. This is assured by requiring only rewritten
types in canEqCanLHS *and* having the newtype-unwrapping check above
the tyvar check in can_eq_nc.

Note that this only applies to saturated applications of newtype TyCons, as
we can't rewrite an unsaturated application. See for example T22310, where
we ended up with:

  newtype Compose f g a = ...

  [W] t[tau] ~# Compose Foo Bar

Note [Put touchable variables on the left]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Ticket #10009, a very nasty example:

    f :: (UnF (F b) ~ b) =&gt; F b -&gt; ()

    g :: forall a. (UnF (F a) ~ a) =&gt; a -&gt; ()
    g _ = f (undefined :: F a)

For g we get [G]  g1 : UnF (F a) ~ a
             [W] w1 : UnF (F beta) ~ beta
             [W] w2 : F a ~ F beta

g1 is canonical (CEqCan). It is oriented as above because a is not touchable.
See canEqTyVarFunEq.

w1 is similarly canonical, though the occurs-check in canEqTyVarFunEq is key
here.

w2 is canonical. But which way should it be oriented? As written, we'll be
stuck. When w2 is added to the inert set, nothing gets kicked out: g1 is
a Given (and Wanteds don't rewrite Givens), and w2 doesn't mention the LHS
of w2. We'll thus lose.

But if w2 is swapped around, to

    [W] w3 : F beta ~ F a

then we'll kick w1 out of the inert set (it mentions the LHS of w3). We then
rewrite w1 to

    [W] w4 : UnF (F a) ~ beta

and then, using g1, to

    [W] w5 : a ~ beta

at which point we can unify and go on to glory. (This rewriting actually
happens all at once, in the call to rewrite during canonicalisation.)

But what about the new LHS makes it better? It mentions a variable (beta)
that can appear in a Wanted -- a touchable metavariable never appears
in a Given. On the other hand, the original LHS mentioned only variables
that appear in Givens. We thus choose to put variables that can appear
in Wanteds on the left.

Ticket #12526 is another good example of this in action.

-}</span><span>
</span><span id="line-1549"></span><span>
</span><span id="line-1550"></span><span class="hs-comment">---------------------</span><span>
</span><span id="line-1551"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#canEqCanLHS"><span class="hs-identifier hs-type">canEqCanLHS</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span>            </span><span class="hs-comment">-- ev :: lhs ~ rhs</span><span>
</span><span id="line-1552"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#EqRel"><span class="hs-identifier hs-type">EqRel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SwapFlag"><span class="hs-identifier hs-type">SwapFlag</span></a></span><span>
</span><span id="line-1553"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CanEqLHS"><span class="hs-identifier hs-type">CanEqLHS</span></a></span><span>              </span><span class="hs-comment">-- lhs (or, if swapped, rhs)</span><span>
</span><span id="line-1554"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>                </span><span class="hs-comment">-- lhs: pretty lhs, already rewritten</span><span>
</span><span id="line-1555"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>      </span><span class="hs-comment">-- rhs: already rewritten</span><span>
</span><span id="line-1556"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#IrredCt"><span class="hs-identifier hs-type">IrredCt</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1557"></span><span id="canEqCanLHS"><span class="annot"><span class="annottext">canEqCanLHS :: CtEvidence
-&gt; EqRel
-&gt; SwapFlag
-&gt; CanEqLHS
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="GHC.Tc.Solver.Equality.html#canEqCanLHS"><span class="hs-identifier hs-var hs-var">canEqCanLHS</span></a></span></span><span> </span><span id="local-6989586621683043884"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043884"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683043885"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043885"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span id="local-6989586621683043886"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683043886"><span class="hs-identifier hs-var">swapped</span></a></span></span><span> </span><span id="local-6989586621683043887"><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683043887"><span class="hs-identifier hs-var">lhs1</span></a></span></span><span> </span><span id="local-6989586621683043888"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043888"><span class="hs-identifier hs-var">ps_xi1</span></a></span></span><span> </span><span id="local-6989586621683043889"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043889"><span class="hs-identifier hs-var">xi2</span></a></span></span><span> </span><span id="local-6989586621683043890"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043890"><span class="hs-identifier hs-var">ps_xi2</span></a></span></span><span>
</span><span id="line-1558"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043891"><span class="hs-identifier hs-var">k1</span></a></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; TcType -&gt; TcType -&gt; Bool
TcType -&gt; TcType -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#tcEqType"><span class="hs-operator hs-var">`tcEqType`</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043892"><span class="hs-identifier hs-var">k2</span></a></span><span>
</span><span id="line-1559"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence
-&gt; EqRel
-&gt; SwapFlag
-&gt; CanEqLHS
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="GHC.Tc.Solver.Equality.html#canEqCanLHSHomo"><span class="hs-identifier hs-var">canEqCanLHSHomo</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043884"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043885"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683043886"><span class="hs-identifier hs-var">swapped</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683043887"><span class="hs-identifier hs-var">lhs1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043888"><span class="hs-identifier hs-var">ps_xi1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043889"><span class="hs-identifier hs-var">xi2</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043890"><span class="hs-identifier hs-var">ps_xi2</span></a></span><span>
</span><span id="line-1560"></span><span>
</span><span id="line-1561"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1562"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence
-&gt; EqRel
-&gt; SwapFlag
-&gt; CanEqLHS
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="GHC.Tc.Solver.Equality.html#canEqCanLHSHetero"><span class="hs-identifier hs-var">canEqCanLHSHetero</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043884"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043885"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683043886"><span class="hs-identifier hs-var">swapped</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683043887"><span class="hs-identifier hs-var">lhs1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043888"><span class="hs-identifier hs-var">ps_xi1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043891"><span class="hs-identifier hs-var">k1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043889"><span class="hs-identifier hs-var">xi2</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043890"><span class="hs-identifier hs-var">ps_xi2</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043892"><span class="hs-identifier hs-var">k2</span></a></span><span>
</span><span id="line-1563"></span><span>
</span><span id="line-1564"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1565"></span><span>    </span><span id="local-6989586621683043891"><span class="annot"><span class="annottext">k1 :: TcType
</span><a href="#local-6989586621683043891"><span class="hs-identifier hs-var hs-var">k1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CanEqLHS -&gt; TcType
</span><a href="GHC.Tc.Types.Constraint.html#canEqLHSKind"><span class="hs-identifier hs-var">canEqLHSKind</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683043887"><span class="hs-identifier hs-var">lhs1</span></a></span><span>
</span><span id="line-1566"></span><span>    </span><span id="local-6989586621683043892"><span class="annot"><span class="annottext">k2 :: TcType
</span><a href="#local-6989586621683043892"><span class="hs-identifier hs-var hs-var">k2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; TcType -&gt; TcType
TcType -&gt; TcType
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043889"><span class="hs-identifier hs-var">xi2</span></a></span><span>
</span><span id="line-1567"></span><span>
</span><span id="line-1568"></span><span>
</span><span id="line-1569"></span><span class="hs-comment">{-
Note [Kind Equality Orientation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
While in theory [W] x ~ y and [W] y ~ x ought to give us the same behaviour, in
practice it does not.  See Note [Fundeps with instances, and equality
orientation] where this is discussed at length.  As a rule of thumb: we keep
the newest unification variables on the left of the equality.  See also
Note [Improvement orientation].

In particular, `canEqCanLHSHetero` produces the following constraint equalities

[X] (xi1 :: ki1) ~ (xi2 :: ki2)
  --&gt;  [X] kco :: ki1 ~ ki2
       [X] co : xi1 :: ki1 ~ (xi2 |&gt; sym kco) :: ki1

Note that the types in the LHS of the new constraints are the ones that were on the LHS of
the original constraint.

--- Historical note ---
We prevously used to flip the kco to avoid using a sym in the cast

[X] (xi1 :: ki1) ~ (xi2 :: ki2)
  --&gt;  [X] kco :: ki2 ~ ki1
       [X] co : xi1 :: ki1 ~ (xi2 |&gt; kco) :: ki1

But this sent solver in an infinite loop (see #19415).
-- End of historical note --
-}</span><span>
</span><span id="line-1597"></span><span>
</span><span id="line-1598"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#canEqCanLHSHetero"><span class="hs-identifier hs-type">canEqCanLHSHetero</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span>         </span><span class="hs-comment">-- :: (xi1 :: ki1) ~ (xi2 :: ki2)</span><span>
</span><span id="line-1599"></span><span>                                        </span><span class="hs-comment">--    (or reversed if SwapFlag=IsSwapped)</span><span>
</span><span id="line-1600"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#EqRel"><span class="hs-identifier hs-type">EqRel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SwapFlag"><span class="hs-identifier hs-type">SwapFlag</span></a></span><span>
</span><span id="line-1601"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CanEqLHS"><span class="hs-identifier hs-type">CanEqLHS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-comment">-- xi1</span><span>
</span><span id="line-1602"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcKind"><span class="hs-identifier hs-type">TcKind</span></a></span><span>             </span><span class="hs-comment">-- ki1</span><span>
</span><span id="line-1603"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>   </span><span class="hs-comment">-- xi2</span><span>
</span><span id="line-1604"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcKind"><span class="hs-identifier hs-type">TcKind</span></a></span><span>             </span><span class="hs-comment">-- ki2</span><span>
</span><span id="line-1605"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#IrredCt"><span class="hs-identifier hs-type">IrredCt</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1606"></span><span id="canEqCanLHSHetero"><span class="annot"><span class="annottext">canEqCanLHSHetero :: CtEvidence
-&gt; EqRel
-&gt; SwapFlag
-&gt; CanEqLHS
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="GHC.Tc.Solver.Equality.html#canEqCanLHSHetero"><span class="hs-identifier hs-var hs-var">canEqCanLHSHetero</span></a></span></span><span> </span><span id="local-6989586621683043897"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043897"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683043898"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043898"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span id="local-6989586621683043899"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683043899"><span class="hs-identifier hs-var">swapped</span></a></span></span><span> </span><span id="local-6989586621683043900"><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683043900"><span class="hs-identifier hs-var">lhs1</span></a></span></span><span> </span><span id="local-6989586621683043901"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043901"><span class="hs-identifier hs-var">ps_xi1</span></a></span></span><span> </span><span id="local-6989586621683043902"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043902"><span class="hs-identifier hs-var">ki1</span></a></span></span><span> </span><span id="local-6989586621683043903"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043903"><span class="hs-identifier hs-var">xi2</span></a></span></span><span> </span><span id="local-6989586621683043904"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043904"><span class="hs-identifier hs-var">ps_xi2</span></a></span></span><span> </span><span id="local-6989586621683043905"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043905"><span class="hs-identifier hs-var">ki2</span></a></span></span><span>
</span><span id="line-1607"></span><span class="hs-comment">-- See Note [Equalities with incompatible kinds]</span><span>
</span><span id="line-1608"></span><span class="hs-comment">-- See Note [Kind Equality Orientation]</span><span>
</span><span id="line-1609"></span><span>
</span><span id="line-1610"></span><span class="hs-comment">-- NB: preserve left-to-right orientation!! See wrinkle (W2) in</span><span>
</span><span id="line-1611"></span><span class="hs-comment">-- Note [Fundeps with instances, and equality orientation] in GHC.Tc.Solver.Dict</span><span>
</span><span id="line-1612"></span><span class="hs-comment">--    NotSwapped:</span><span>
</span><span id="line-1613"></span><span class="hs-comment">--        ev      :: (lhs1:ki1) ~r# (xi2:ki2)</span><span>
</span><span id="line-1614"></span><span class="hs-comment">--        kind_co :: k11 ~# ki2               -- Same orientation as ev</span><span>
</span><span id="line-1615"></span><span class="hs-comment">--        type_ev :: lhs1 ~r# (xi2 |&gt; sym kind_co)</span><span>
</span><span id="line-1616"></span><span class="hs-comment">--    Swapped</span><span>
</span><span id="line-1617"></span><span class="hs-comment">--        ev      :: (xi2:ki2) ~r# (lhs1:ki1)</span><span>
</span><span id="line-1618"></span><span class="hs-comment">--        kind_co :: ki2 ~# ki1               -- Same orientation as ev</span><span>
</span><span id="line-1619"></span><span class="hs-comment">--        type_ev :: (xi2 |&gt; kind_co) ~r# lhs1</span><span>
</span><span id="line-1620"></span><span>
</span><span id="line-1621"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043906"><span class="annot"><a href="#local-6989586621683043906"><span class="hs-identifier hs-var">kind_co</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043907"><span class="annot"><a href="#local-6989586621683043907"><span class="hs-identifier hs-var">rewriters</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043908"><span class="annot"><a href="#local-6989586621683043908"><span class="hs-identifier hs-var">unifs_happened</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS (TcCoercion, RewriterSet, Bool)
</span><a href="#local-6989586621683043909"><span class="hs-identifier hs-var">mk_kind_eq</span></a></span><span>   </span><span class="hs-comment">-- :: ki1 ~N ki2</span><span>
</span><span id="line-1622"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621683043908"><span class="hs-identifier hs-type">unifs_happened</span></a></span><span>
</span><span id="line-1623"></span><span>              </span><span class="hs-comment">-- Unifications happened, so start again to do the zonking</span><span>
</span><span id="line-1624"></span><span>              </span><span class="hs-comment">-- Otherwise we might put something in the inert set that isn't inert</span><span>
</span><span id="line-1625"></span><span>         </span><span class="hs-keyword">then</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#startAgainWith"><span class="hs-identifier hs-type">startAgainWith</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#mkNonCanonical"><span class="hs-identifier hs-type">mkNonCanonical</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043897"><span class="hs-identifier hs-type">ev</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1626"></span><span>         </span><span class="hs-keyword">else</span><span>
</span><span id="line-1627"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683043910"><span class="annot"><a href="#local-6989586621683043910"><span class="hs-identifier hs-var hs-var">lhs_redn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role -&gt; TcType -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkReflRedn"><span class="hs-identifier hs-var">mkReflRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683043911"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043901"><span class="hs-identifier hs-var">ps_xi1</span></a></span><span>
</span><span id="line-1628"></span><span>             </span><span id="local-6989586621683043912"><span class="annot"><a href="#local-6989586621683043912"><span class="hs-identifier hs-var hs-var">rhs_redn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role -&gt; TcType -&gt; TcCoercion -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkGReflRightRedn"><span class="hs-identifier hs-var">mkGReflRightRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683043911"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043903"><span class="hs-identifier hs-var">xi2</span></a></span><span> </span><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683043914"><span class="hs-identifier hs-var">mb_sym_kind_co</span></a></span><span>
</span><span id="line-1629"></span><span>             </span><span id="local-6989586621683043914"><span class="annot"><a href="#local-6989586621683043914"><span class="hs-identifier hs-var hs-var">mb_sym_kind_co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683043899"><span class="hs-identifier hs-var">swapped</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1630"></span><span>                                </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#NotSwapped"><span class="hs-identifier hs-var">NotSwapped</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcCoercion -&gt; TcCoercion
</span><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a></span><span> </span><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683043906"><span class="hs-identifier hs-var">kind_co</span></a></span><span>
</span><span id="line-1631"></span><span>                                </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#IsSwapped"><span class="hs-identifier hs-var">IsSwapped</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683043906"><span class="hs-identifier hs-var">kind_co</span></a></span><span>
</span><span id="line-1632"></span><span>
</span><span id="line-1633"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-type">traceTcS</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Hetero equality gives rise to kind equality&quot;</span></span><span>
</span><span id="line-1634"></span><span>           </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043899"><span class="hs-identifier hs-type">swapped</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-type">$$</span></a></span><span>
</span><span id="line-1635"></span><span>            </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043906"><span class="hs-identifier hs-type">kind_co</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#dcolon"><span class="hs-identifier hs-type">dcolon</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#sep"><span class="hs-identifier hs-type">sep</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043902"><span class="hs-identifier hs-type">ki1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;~#&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043905"><span class="hs-identifier hs-type">ki2</span></a></span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1636"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683043918"><span class="annot"><a href="#local-6989586621683043918"><span class="hs-identifier hs-var">type_ev</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#rewriteEqEvidence"><span class="hs-identifier hs-type">rewriteEqEvidence</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043907"><span class="hs-identifier hs-type">rewriters</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043897"><span class="hs-identifier hs-type">ev</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043899"><span class="hs-identifier hs-type">swapped</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043910"><span class="hs-identifier hs-type">lhs_redn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043912"><span class="hs-identifier hs-type">rhs_redn</span></a></span><span>
</span><span id="line-1637"></span><span>
</span><span id="line-1638"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683043919"><span class="annot"><a href="#local-6989586621683043919"><span class="hs-identifier hs-var hs-var">new_xi2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcCoercion -&gt; TcType
</span><a href="GHC.Core.Type.html#mkCastTy"><span class="hs-identifier hs-var">mkCastTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043904"><span class="hs-identifier hs-var">ps_xi2</span></a></span><span> </span><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683043914"><span class="hs-identifier hs-var">mb_sym_kind_co</span></a></span><span>
</span><span id="line-1639"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#canEqCanLHSHomo"><span class="hs-identifier hs-type">canEqCanLHSHomo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043918"><span class="hs-identifier hs-type">type_ev</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043898"><span class="hs-identifier hs-type">eq_rel</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#NotSwapped"><span class="hs-identifier hs-type">NotSwapped</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043900"><span class="hs-identifier hs-type">lhs1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043901"><span class="hs-identifier hs-type">ps_xi1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043919"><span class="hs-identifier hs-type">new_xi2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043919"><span class="hs-identifier hs-type">new_xi2</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><span id="line-1640"></span><span>
</span><span id="line-1641"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1642"></span><span>    </span><span class="annot"><a href="#local-6989586621683043909"><span class="hs-identifier hs-type">mk_kind_eq</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#RewriterSet"><span class="hs-identifier hs-type">RewriterSet</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span>
</span><span id="line-1643"></span><span>    </span><span class="hs-comment">-- Returned kind_co has kind (k1 ~ k2) if NotSwapped, (k2 ~ k1) if Swapped</span><span>
</span><span id="line-1644"></span><span>    </span><span class="hs-comment">-- Returned Bool = True if unifications happened, so we should retry</span><span>
</span><span id="line-1645"></span><span>    </span><span id="local-6989586621683043909"><span class="annot"><span class="annottext">mk_kind_eq :: TcS (TcCoercion, RewriterSet, Bool)
</span><a href="#local-6989586621683043909"><span class="hs-identifier hs-var hs-var">mk_kind_eq</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043897"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1646"></span><span>      </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtGiven"><span class="hs-identifier hs-type">CtGiven</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ctev_evar :: CtEvidence -&gt; TcTyVar
</span><a href="GHC.Tc.Types.Constraint.html#ctev_evar"><span class="hs-identifier hs-var">ctev_evar</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683043921"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043921"><span class="hs-identifier hs-var">evar</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1647"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683043922"><span class="annot"><span class="annottext">kind_co :: TcCoercion
</span><a href="#local-6989586621683043922"><span class="hs-identifier hs-var hs-var hs-var">kind_co</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcCoercion -&gt; TcCoercion
</span><a href="GHC.Core.Coercion.html#mkKindCo"><span class="hs-identifier hs-var">mkKindCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; TcCoercion
</span><a href="GHC.Core.Coercion.html#mkCoVarCo"><span class="hs-identifier hs-var">mkCoVarCo</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043921"><span class="hs-identifier hs-var">evar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1648"></span><span>                    </span><span id="local-6989586621683043924"><span class="annot"><span class="annottext">pred_ty :: TcType
</span><a href="#local-6989586621683043924"><span class="hs-identifier hs-var hs-var hs-var">pred_ty</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SwapFlag
-&gt; (TcType -&gt; TcType -&gt; TcType) -&gt; TcType -&gt; TcType -&gt; TcType
forall a b. SwapFlag -&gt; (a -&gt; a -&gt; b) -&gt; a -&gt; a -&gt; b
</span><a href="GHC.Types.Basic.html#unSwap"><span class="hs-identifier hs-var">unSwap</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683043899"><span class="hs-identifier hs-var">swapped</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TcType -&gt; TcType
</span><a href="GHC.Core.Coercion.html#mkNomPrimEqPred"><span class="hs-identifier hs-var">mkNomPrimEqPred</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="GHC.Builtin.Types.html#liftedTypeKind"><span class="hs-identifier hs-var">liftedTypeKind</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043902"><span class="hs-identifier hs-var">ki1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043905"><span class="hs-identifier hs-var">ki2</span></a></span><span>
</span><span id="line-1649"></span><span>                    </span><span id="local-6989586621683043927"><span class="annot"><span class="annottext">kind_loc :: CtLoc
</span><a href="#local-6989586621683043927"><span class="hs-identifier hs-var hs-var hs-var">kind_loc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; CtLoc -&gt; CtLoc
</span><a href="GHC.Tc.Types.CtLoc.html#mkKindEqLoc"><span class="hs-identifier hs-var">mkKindEqLoc</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043929"><span class="hs-identifier hs-var">xi1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043903"><span class="hs-identifier hs-var">xi2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctev_loc"><span class="hs-identifier hs-var">ctev_loc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043897"><span class="hs-identifier hs-var">ev</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1650"></span><span>              </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683043931"><span class="annot"><a href="#local-6989586621683043931"><span class="hs-identifier hs-var">kind_ev</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; (TcType, EvTerm) -&gt; TcS CtEvidence
</span><a href="GHC.Tc.Solver.Monad.html#newGivenEvVar"><span class="hs-identifier hs-var">newGivenEvVar</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683043927"><span class="hs-identifier hs-var">kind_loc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043924"><span class="hs-identifier hs-var">pred_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcCoercion -&gt; EvTerm
</span><a href="GHC.Tc.Types.Evidence.html#evCoercion"><span class="hs-identifier hs-var">evCoercion</span></a></span><span> </span><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683043922"><span class="hs-identifier hs-var">kind_co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1651"></span><span>              </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#emitWorkNC"><span class="hs-identifier hs-type">emitWorkNC</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621683043931"><span class="hs-identifier hs-type">kind_ev</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1652"></span><span>              </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ctEvCoercion"><span class="hs-identifier hs-type">ctEvCoercion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043931"><span class="hs-identifier hs-type">kind_ev</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#emptyRewriterSet"><span class="hs-identifier hs-type">emptyRewriterSet</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1653"></span><span>
</span><span id="line-1654"></span><span>      </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtWanted"><span class="hs-identifier hs-type">CtWanted</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>
</span><span id="line-1655"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043933"><span class="annot"><a href="#local-6989586621683043933"><span class="hs-identifier hs-var">kind_co</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043934"><span class="annot"><a href="#local-6989586621683043934"><span class="hs-identifier hs-var">cts</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043935"><span class="annot"><a href="#local-6989586621683043935"><span class="hs-identifier hs-var">unifs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtEvidence
-&gt; Role
-&gt; (UnifyEnv -&gt; TcM TcCoercion)
-&gt; TcS (TcCoercion, Cts, [TcTyVar])
forall a.
CtEvidence
-&gt; Role -&gt; (UnifyEnv -&gt; TcM a) -&gt; TcS (a, Cts, [TcTyVar])
</span><a href="GHC.Tc.Solver.Monad.html#wrapUnifierTcS"><span class="hs-identifier hs-var">wrapUnifierTcS</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043897"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="annot"><span class="annottext">((UnifyEnv -&gt; TcM TcCoercion) -&gt; TcS (TcCoercion, Cts, [TcTyVar]))
-&gt; (UnifyEnv -&gt; TcM TcCoercion) -&gt; TcS (TcCoercion, Cts, [TcTyVar])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621683043936"><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683043936"><span class="hs-identifier hs-var">uenv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1656"></span><span>                                         </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683043937"><span class="annot"><span class="annottext">uenv' :: UnifyEnv
</span><a href="#local-6989586621683043937"><span class="hs-identifier hs-var hs-var">uenv'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnifyEnv -&gt; (CtLoc -&gt; CtLoc) -&gt; UnifyEnv
</span><a href="GHC.Tc.Utils.Unify.html#updUEnvLoc"><span class="hs-identifier hs-var">updUEnvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683043936"><span class="hs-identifier hs-var">uenv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; CtLoc -&gt; CtLoc
</span><a href="GHC.Tc.Types.CtLoc.html#mkKindEqLoc"><span class="hs-identifier hs-var">mkKindEqLoc</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043929"><span class="hs-identifier hs-var">xi1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043903"><span class="hs-identifier hs-var">xi2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1657"></span><span>                                         </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">SwapFlag
-&gt; (TcType -&gt; TcType -&gt; TcM TcCoercion)
-&gt; TcType
-&gt; TcType
-&gt; TcM TcCoercion
forall a b. SwapFlag -&gt; (a -&gt; a -&gt; b) -&gt; a -&gt; a -&gt; b
</span><a href="GHC.Types.Basic.html#unSwap"><span class="hs-identifier hs-var">unSwap</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683043899"><span class="hs-identifier hs-var">swapped</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UnifyEnv -&gt; TcType -&gt; TcType -&gt; TcM TcCoercion
</span><a href="GHC.Tc.Utils.Unify.html#uType"><span class="hs-identifier hs-var">uType</span></a></span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683043937"><span class="hs-identifier hs-var">uenv'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043902"><span class="hs-identifier hs-var">ki1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043905"><span class="hs-identifier hs-var">ki2</span></a></span><span>
</span><span id="line-1658"></span><span>              </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683043933"><span class="hs-identifier hs-type">kind_co</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#rewriterSetFromCts"><span class="hs-identifier hs-type">rewriterSetFromCts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043934"><span class="hs-identifier hs-type">cts</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">null</span></span><span> </span><span class="annot"><a href="#local-6989586621683043935"><span class="hs-identifier hs-type">unifs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1659"></span><span>
</span><span id="line-1660"></span><span>    </span><span id="local-6989586621683043929"><span class="annot"><span class="annottext">xi1 :: TcType
</span><a href="#local-6989586621683043929"><span class="hs-identifier hs-var hs-var">xi1</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CanEqLHS -&gt; TcType
</span><a href="GHC.Tc.Types.Constraint.html#canEqLHSType"><span class="hs-identifier hs-var">canEqLHSType</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683043900"><span class="hs-identifier hs-var">lhs1</span></a></span><span>
</span><span id="line-1661"></span><span>    </span><span id="local-6989586621683043911"><span class="annot"><span class="annottext">role :: Role
</span><a href="#local-6989586621683043911"><span class="hs-keyword hs-var hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; Role
</span><a href="GHC.Core.Predicate.html#eqRelRole"><span class="hs-identifier hs-var">eqRelRole</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043898"><span class="hs-identifier hs-var">eq_rel</span></a></span><span>
</span><span id="line-1662"></span><span>
</span><span id="line-1663"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#canEqCanLHSHomo"><span class="hs-identifier hs-type">canEqCanLHSHomo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span>          </span><span class="hs-comment">-- lhs ~ rhs</span><span>
</span><span id="line-1664"></span><span>                                       </span><span class="hs-comment">-- or, if swapped: rhs ~ lhs</span><span>
</span><span id="line-1665"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#EqRel"><span class="hs-identifier hs-type">EqRel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SwapFlag"><span class="hs-identifier hs-type">SwapFlag</span></a></span><span>
</span><span id="line-1666"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CanEqLHS"><span class="hs-identifier hs-type">CanEqLHS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>  </span><span class="hs-comment">-- lhs, pretty lhs</span><span>
</span><span id="line-1667"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>  </span><span class="hs-comment">-- rhs, pretty rhs</span><span>
</span><span id="line-1668"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#IrredCt"><span class="hs-identifier hs-type">IrredCt</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1669"></span><span class="hs-comment">-- Guaranteed that typeKind lhs == typeKind rhs</span><span>
</span><span id="line-1670"></span><span id="canEqCanLHSHomo"><span class="annot"><span class="annottext">canEqCanLHSHomo :: CtEvidence
-&gt; EqRel
-&gt; SwapFlag
-&gt; CanEqLHS
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="GHC.Tc.Solver.Equality.html#canEqCanLHSHomo"><span class="hs-identifier hs-var hs-var">canEqCanLHSHomo</span></a></span></span><span> </span><span id="local-6989586621683043940"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043940"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683043941"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043941"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span id="local-6989586621683043942"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683043942"><span class="hs-identifier hs-var">swapped</span></a></span></span><span> </span><span id="local-6989586621683043943"><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683043943"><span class="hs-identifier hs-var">lhs1</span></a></span></span><span> </span><span id="local-6989586621683043944"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043944"><span class="hs-identifier hs-var">ps_xi1</span></a></span></span><span> </span><span id="local-6989586621683043945"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043945"><span class="hs-identifier hs-var">xi2</span></a></span></span><span> </span><span id="local-6989586621683043946"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043946"><span class="hs-identifier hs-var">ps_xi2</span></a></span></span><span>
</span><span id="line-1671"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683043947"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043947"><span class="hs-identifier hs-var">xi2'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683043948"><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621683043948"><span class="hs-identifier hs-var">mco</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; (TcType, MCoercion)
</span><a href="#local-6989586621683043949"><span class="hs-identifier hs-var">split_cast_ty</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043945"><span class="hs-identifier hs-var">xi2</span></a></span><span>
</span><span id="line-1672"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683043950"><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683043950"><span class="hs-identifier hs-var">lhs2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe CanEqLHS
</span><a href="GHC.Tc.Types.Constraint.html#canEqLHS_maybe"><span class="hs-identifier hs-var">canEqLHS_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043947"><span class="hs-identifier hs-var">xi2'</span></a></span><span>
</span><span id="line-1673"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence
-&gt; EqRel
-&gt; SwapFlag
-&gt; CanEqLHS
-&gt; TcType
-&gt; CanEqLHS
-&gt; TcType
-&gt; MCoercion
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="GHC.Tc.Solver.Equality.html#canEqCanLHS2"><span class="hs-identifier hs-var">canEqCanLHS2</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043940"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043941"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683043942"><span class="hs-identifier hs-var">swapped</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683043943"><span class="hs-identifier hs-var">lhs1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043944"><span class="hs-identifier hs-var">ps_xi1</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683043950"><span class="hs-identifier hs-var">lhs2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043946"><span class="hs-identifier hs-var">ps_xi2</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; MCoercion -&gt; TcType
</span><a href="GHC.Core.Coercion.html#mkCastTyMCo"><span class="hs-operator hs-var">`mkCastTyMCo`</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercion -&gt; MCoercion
</span><a href="GHC.Core.Coercion.html#mkSymMCo"><span class="hs-identifier hs-var">mkSymMCo</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621683043948"><span class="hs-identifier hs-var">mco</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621683043948"><span class="hs-identifier hs-var">mco</span></a></span><span>
</span><span id="line-1674"></span><span>
</span><span id="line-1675"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1676"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence
-&gt; EqRel
-&gt; SwapFlag
-&gt; CanEqLHS
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="GHC.Tc.Solver.Equality.html#canEqCanLHSFinish"><span class="hs-identifier hs-var">canEqCanLHSFinish</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043940"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043941"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683043942"><span class="hs-identifier hs-var">swapped</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683043943"><span class="hs-identifier hs-var">lhs1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043946"><span class="hs-identifier hs-var">ps_xi2</span></a></span><span>
</span><span id="line-1677"></span><span>
</span><span id="line-1678"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1679"></span><span>    </span><span id="local-6989586621683043949"><span class="annot"><span class="annottext">split_cast_ty :: TcType -&gt; (TcType, MCoercion)
</span><a href="#local-6989586621683043949"><span class="hs-identifier hs-var hs-var">split_cast_ty</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CastTy"><span class="hs-identifier hs-type">CastTy</span></a></span><span> </span><span id="local-6989586621683043955"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043955"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621683043956"><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683043956"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043955"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcCoercion -&gt; MCoercion
</span><a href="GHC.Core.TyCo.Rep.html#MCo"><span class="hs-identifier hs-var">MCo</span></a></span><span> </span><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683043956"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1680"></span><span>    </span><span class="annot"><a href="#local-6989586621683043949"><span class="hs-identifier hs-var">split_cast_ty</span></a></span><span> </span><span id="local-6989586621683043958"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043958"><span class="hs-identifier hs-var">other</span></a></span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043958"><span class="hs-identifier hs-var">other</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MCoercion
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1681"></span><span>
</span><span id="line-1682"></span><span class="hs-comment">-- This function deals with the case that both LHS and RHS are potential</span><span>
</span><span id="line-1683"></span><span class="hs-comment">-- CanEqLHSs.</span><span>
</span><span id="line-1684"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#canEqCanLHS2"><span class="hs-identifier hs-type">canEqCanLHS2</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span>              </span><span class="hs-comment">-- lhs ~ (rhs |&gt; mco)</span><span>
</span><span id="line-1685"></span><span>                                        </span><span class="hs-comment">-- or, if swapped: (rhs |&gt; mco) ~ lhs</span><span>
</span><span id="line-1686"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#EqRel"><span class="hs-identifier hs-type">EqRel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SwapFlag"><span class="hs-identifier hs-type">SwapFlag</span></a></span><span>
</span><span id="line-1687"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CanEqLHS"><span class="hs-identifier hs-type">CanEqLHS</span></a></span><span>                </span><span class="hs-comment">-- lhs (or, if swapped, rhs)</span><span>
</span><span id="line-1688"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>                  </span><span class="hs-comment">-- pretty lhs</span><span>
</span><span id="line-1689"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CanEqLHS"><span class="hs-identifier hs-type">CanEqLHS</span></a></span><span>                </span><span class="hs-comment">-- rhs</span><span>
</span><span id="line-1690"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>                  </span><span class="hs-comment">-- pretty rhs</span><span>
</span><span id="line-1691"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCoercion"><span class="hs-identifier hs-type">MCoercion</span></a></span><span>               </span><span class="hs-comment">-- :: kind(rhs) ~N kind(lhs)</span><span>
</span><span id="line-1692"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#IrredCt"><span class="hs-identifier hs-type">IrredCt</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1693"></span><span id="canEqCanLHS2"><span class="annot"><span class="annottext">canEqCanLHS2 :: CtEvidence
-&gt; EqRel
-&gt; SwapFlag
-&gt; CanEqLHS
-&gt; TcType
-&gt; CanEqLHS
-&gt; TcType
-&gt; MCoercion
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="GHC.Tc.Solver.Equality.html#canEqCanLHS2"><span class="hs-identifier hs-var hs-var">canEqCanLHS2</span></a></span></span><span> </span><span id="local-6989586621683043960"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043960"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683043961"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043961"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span id="local-6989586621683043962"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683043962"><span class="hs-identifier hs-var">swapped</span></a></span></span><span> </span><span id="local-6989586621683043963"><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683043963"><span class="hs-identifier hs-var">lhs1</span></a></span></span><span> </span><span id="local-6989586621683043964"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043964"><span class="hs-identifier hs-var">ps_xi1</span></a></span></span><span> </span><span id="local-6989586621683043965"><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683043965"><span class="hs-identifier hs-var">lhs2</span></a></span></span><span> </span><span id="local-6989586621683043966"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043966"><span class="hs-identifier hs-var">ps_xi2</span></a></span></span><span> </span><span id="local-6989586621683043967"><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621683043967"><span class="hs-identifier hs-var">mco</span></a></span></span><span>
</span><span id="line-1694"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683043963"><span class="hs-identifier hs-var">lhs1</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS -&gt; CanEqLHS -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#eqCanEqLHS"><span class="hs-operator hs-var">`eqCanEqLHS`</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683043965"><span class="hs-identifier hs-var">lhs2</span></a></span><span>
</span><span id="line-1695"></span><span>    </span><span class="hs-comment">-- It must be the case that mco is reflexive</span><span>
</span><span id="line-1696"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence
-&gt; EqRel -&gt; TcType -&gt; TcS (StopOrContinue (Either IrredCt EqCt))
forall a. CtEvidence -&gt; EqRel -&gt; TcType -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Equality.html#canEqReflexive"><span class="hs-identifier hs-var">canEqReflexive</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043960"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043961"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043969"><span class="hs-identifier hs-var">lhs1_ty</span></a></span><span>
</span><span id="line-1697"></span><span>
</span><span id="line-1698"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#TyVarLHS"><span class="hs-identifier hs-type">TyVarLHS</span></a></span><span> </span><span id="local-6989586621683043971"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043971"><span class="hs-identifier hs-var">tv1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683043963"><span class="hs-identifier hs-var">lhs1</span></a></span><span>
</span><span id="line-1699"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#TyVarLHS"><span class="hs-identifier hs-type">TyVarLHS</span></a></span><span> </span><span id="local-6989586621683043972"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043972"><span class="hs-identifier hs-var">tv2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683043965"><span class="hs-identifier hs-var">lhs2</span></a></span><span>
</span><span id="line-1700"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- See Note [TyVar/TyVar orientation] in GHC.Tc.Utils.Unify</span><span>
</span><span id="line-1701"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;canEqLHS2 swapOver&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043971"><span class="hs-identifier hs-var">tv1</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043972"><span class="hs-identifier hs-var">tv2</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683043962"><span class="hs-identifier hs-var">swapped</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1702"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcTyVar -&gt; TcTyVar -&gt; Bool
</span><a href="GHC.Tc.Utils.Unify.html#swapOverTyVars"><span class="hs-identifier hs-var">swapOverTyVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isGiven"><span class="hs-identifier hs-var">isGiven</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043960"><span class="hs-identifier hs-var">ev</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043971"><span class="hs-identifier hs-var">tv1</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683043972"><span class="hs-identifier hs-var">tv2</span></a></span><span>
</span><span id="line-1703"></span><span>         </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="#local-6989586621683043975"><span class="hs-identifier hs-var">finish_with_swapping</span></a></span><span>
</span><span id="line-1704"></span><span>         </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="#local-6989586621683043976"><span class="hs-identifier hs-var">finish_without_swapping</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1705"></span><span>
</span><span id="line-1706"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#TyVarLHS"><span class="hs-identifier hs-type">TyVarLHS</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683043963"><span class="hs-identifier hs-var">lhs1</span></a></span><span>
</span><span id="line-1707"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#TyFamLHS"><span class="hs-identifier hs-type">TyFamLHS</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683043965"><span class="hs-identifier hs-var">lhs2</span></a></span><span>
</span><span id="line-1708"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683043978"><span class="hs-identifier hs-var">put_tyvar_on_lhs</span></a></span><span>
</span><span id="line-1709"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="#local-6989586621683043976"><span class="hs-identifier hs-var">finish_without_swapping</span></a></span><span>
</span><span id="line-1710"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="#local-6989586621683043975"><span class="hs-identifier hs-var">finish_with_swapping</span></a></span><span>
</span><span id="line-1711"></span><span>
</span><span id="line-1712"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#TyFamLHS"><span class="hs-identifier hs-type">TyFamLHS</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683043963"><span class="hs-identifier hs-var">lhs1</span></a></span><span>
</span><span id="line-1713"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#TyVarLHS"><span class="hs-identifier hs-type">TyVarLHS</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683043965"><span class="hs-identifier hs-var">lhs2</span></a></span><span>
</span><span id="line-1714"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683043978"><span class="hs-identifier hs-var">put_tyvar_on_lhs</span></a></span><span>
</span><span id="line-1715"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="#local-6989586621683043975"><span class="hs-identifier hs-var">finish_with_swapping</span></a></span><span>
</span><span id="line-1716"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="#local-6989586621683043976"><span class="hs-identifier hs-var">finish_without_swapping</span></a></span><span>
</span><span id="line-1717"></span><span>
</span><span id="line-1718"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#TyFamLHS"><span class="hs-identifier hs-type">TyFamLHS</span></a></span><span> </span><span id="local-6989586621683043979"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043979"><span class="hs-identifier hs-var">_fun_tc1</span></a></span></span><span> </span><span id="local-6989586621683043980"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043980"><span class="hs-identifier hs-var">fun_args1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683043963"><span class="hs-identifier hs-var">lhs1</span></a></span><span>
</span><span id="line-1719"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#TyFamLHS"><span class="hs-identifier hs-type">TyFamLHS</span></a></span><span> </span><span id="local-6989586621683043981"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683043981"><span class="hs-identifier hs-var">_fun_tc2</span></a></span></span><span> </span><span id="local-6989586621683043982"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043982"><span class="hs-identifier hs-var">fun_args2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683043965"><span class="hs-identifier hs-var">lhs2</span></a></span><span>
</span><span id="line-1720"></span><span>  </span><span class="hs-comment">-- See Note [Decomposing type family applications]</span><span>
</span><span id="line-1721"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;canEqCanLHS2 two type families&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanEqLHS -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683043963"><span class="hs-identifier hs-var">lhs1</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683043965"><span class="hs-identifier hs-var">lhs2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1722"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683043983"><span class="annot"><a href="#local-6989586621683043983"><span class="hs-identifier hs-var">tclvl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS TcLevel
</span><a href="GHC.Tc.Solver.Monad.html#getTcLevel"><span class="hs-identifier hs-var">getTcLevel</span></a></span><span>
</span><span id="line-1723"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683043984"><span class="annot"><a href="#local-6989586621683043984"><span class="hs-identifier hs-var hs-var">tvs1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; TyCoVarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tyCoVarsOfTypes</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043980"><span class="hs-identifier hs-var">fun_args1</span></a></span><span>
</span><span id="line-1724"></span><span>             </span><span id="local-6989586621683043985"><span class="annot"><a href="#local-6989586621683043985"><span class="hs-identifier hs-var hs-var">tvs2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; TyCoVarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tyCoVarsOfTypes</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043982"><span class="hs-identifier hs-var">fun_args2</span></a></span><span>
</span><span id="line-1725"></span><span>
</span><span id="line-1726"></span><span>             </span><span class="hs-comment">-- See Note [Orienting TyFamLHS/TyFamLHS]</span><span>
</span><span id="line-1727"></span><span>             </span><span id="local-6989586621683043986"><span class="annot"><a href="#local-6989586621683043986"><span class="hs-identifier hs-var hs-var">swap_for_size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; Int
</span><a href="GHC.Core.TyCo.Rep.html#typesSize"><span class="hs-identifier hs-var">typesSize</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043982"><span class="hs-identifier hs-var">fun_args2</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; Int
</span><a href="GHC.Core.TyCo.Rep.html#typesSize"><span class="hs-identifier hs-var">typesSize</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683043980"><span class="hs-identifier hs-var">fun_args1</span></a></span><span>
</span><span id="line-1728"></span><span>
</span><span id="line-1729"></span><span>             </span><span class="hs-comment">-- See Note [Orienting TyFamLHS/TyFamLHS]</span><span>
</span><span id="line-1730"></span><span>             </span><span id="local-6989586621683043989"><span class="annot"><a href="#local-6989586621683043989"><span class="hs-identifier hs-var hs-var">meta_tv_lhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TcTyVar -&gt; Bool) -&gt; TyCoVarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#anyVarSet"><span class="hs-identifier hs-var">anyVarSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcLevel -&gt; TcTyVar -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isTouchableMetaTyVar"><span class="hs-identifier hs-var">isTouchableMetaTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683043983"><span class="hs-identifier hs-var">tclvl</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TyCoVarSet
</span><a href="#local-6989586621683043984"><span class="hs-identifier hs-var">tvs1</span></a></span><span>
</span><span id="line-1731"></span><span>             </span><span id="local-6989586621683043991"><span class="annot"><a href="#local-6989586621683043991"><span class="hs-identifier hs-var hs-var">meta_tv_rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TcTyVar -&gt; Bool) -&gt; TyCoVarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#anyVarSet"><span class="hs-identifier hs-var">anyVarSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcLevel -&gt; TcTyVar -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isTouchableMetaTyVar"><span class="hs-identifier hs-var">isTouchableMetaTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683043983"><span class="hs-identifier hs-var">tclvl</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TyCoVarSet
</span><a href="#local-6989586621683043985"><span class="hs-identifier hs-var">tvs2</span></a></span><span>
</span><span id="line-1732"></span><span>             </span><span id="local-6989586621683043992"><span class="annot"><a href="#local-6989586621683043992"><span class="hs-identifier hs-var hs-var">swap_for_rewriting</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683043991"><span class="hs-identifier hs-var">meta_tv_rhs</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683043989"><span class="hs-identifier hs-var">meta_tv_lhs</span></a></span><span>
</span><span id="line-1733"></span><span>                                  </span><span class="hs-comment">-- See Note [Put touchable variables on the left]</span><span>
</span><span id="line-1734"></span><span>                                  </span><span class="hs-comment">-- This second check is just to avoid unfruitful swapping</span><span>
</span><span id="line-1735"></span><span>
</span><span id="line-1736"></span><span>         </span><span class="hs-comment">-- It's important that we don't flip-flop (#T24134)</span><span>
</span><span id="line-1737"></span><span>         </span><span class="hs-comment">-- So swap_for_rewriting &quot;wins&quot;, and we only try swap_for_size</span><span>
</span><span id="line-1738"></span><span>         </span><span class="hs-comment">-- if swap_for_rewriting doesn't care either way</span><span>
</span><span id="line-1739"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621683043992"><span class="hs-identifier hs-type">swap_for_rewriting</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">||</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683043989"><span class="hs-identifier hs-type">meta_tv_lhs</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">==</span></span><span> </span><span class="annot"><a href="#local-6989586621683043991"><span class="hs-identifier hs-type">meta_tv_rhs</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&amp;&amp;</span></span><span> </span><span class="annot"><a href="#local-6989586621683043986"><span class="hs-identifier hs-type">swap_for_size</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1740"></span><span>         </span><span class="hs-keyword">then</span><span> </span><span class="annot"><a href="#local-6989586621683043975"><span class="hs-identifier hs-type">finish_with_swapping</span></a></span><span>
</span><span id="line-1741"></span><span>         </span><span class="hs-keyword">else</span><span> </span><span class="annot"><a href="#local-6989586621683043976"><span class="hs-identifier hs-type">finish_without_swapping</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1742"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1743"></span><span>    </span><span id="local-6989586621683043993"><span class="annot"><span class="annottext">sym_mco :: MCoercion
</span><a href="#local-6989586621683043993"><span class="hs-identifier hs-var hs-var">sym_mco</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MCoercion -&gt; MCoercion
</span><a href="GHC.Core.Coercion.html#mkSymMCo"><span class="hs-identifier hs-var">mkSymMCo</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621683043967"><span class="hs-identifier hs-var">mco</span></a></span><span>
</span><span id="line-1744"></span><span>    </span><span id="local-6989586621683043994"><span class="annot"><span class="annottext">role :: Role
</span><a href="#local-6989586621683043994"><span class="hs-keyword hs-var hs-var">role</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; Role
</span><a href="GHC.Core.Predicate.html#eqRelRole"><span class="hs-identifier hs-var">eqRelRole</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043961"><span class="hs-identifier hs-var">eq_rel</span></a></span><span>
</span><span id="line-1745"></span><span>    </span><span id="local-6989586621683043969"><span class="annot"><span class="annottext">lhs1_ty :: TcType
</span><a href="#local-6989586621683043969"><span class="hs-identifier hs-var hs-var">lhs1_ty</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CanEqLHS -&gt; TcType
</span><a href="GHC.Tc.Types.Constraint.html#canEqLHSType"><span class="hs-identifier hs-var">canEqLHSType</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683043963"><span class="hs-identifier hs-var">lhs1</span></a></span><span>
</span><span id="line-1746"></span><span>    </span><span id="local-6989586621683043995"><span class="annot"><span class="annottext">lhs2_ty :: TcType
</span><a href="#local-6989586621683043995"><span class="hs-identifier hs-var hs-var">lhs2_ty</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CanEqLHS -&gt; TcType
</span><a href="GHC.Tc.Types.Constraint.html#canEqLHSType"><span class="hs-identifier hs-var">canEqLHSType</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683043965"><span class="hs-identifier hs-var">lhs2</span></a></span><span>
</span><span id="line-1747"></span><span>
</span><span id="line-1748"></span><span>    </span><span id="local-6989586621683043976"><span class="annot"><span class="annottext">finish_without_swapping :: TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="#local-6989586621683043976"><span class="hs-identifier hs-var hs-var">finish_without_swapping</span></a></span></span><span>
</span><span id="line-1749"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence
-&gt; EqRel
-&gt; SwapFlag
-&gt; CanEqLHS
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="GHC.Tc.Solver.Equality.html#canEqCanLHSFinish"><span class="hs-identifier hs-var">canEqCanLHSFinish</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043960"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043961"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683043962"><span class="hs-identifier hs-var">swapped</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683043963"><span class="hs-identifier hs-var">lhs1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043966"><span class="hs-identifier hs-var">ps_xi2</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; MCoercion -&gt; TcType
</span><a href="GHC.Core.Coercion.html#mkCastTyMCo"><span class="hs-operator hs-var">`mkCastTyMCo`</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621683043967"><span class="hs-identifier hs-var">mco</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1750"></span><span>
</span><span id="line-1751"></span><span>    </span><span class="hs-comment">-- Swapping. We have   ev : lhs1 ~ lhs2 |&gt; co</span><span>
</span><span id="line-1752"></span><span>    </span><span class="hs-comment">-- We swap to      new_ev : lhs2 ~ lhs1 |&gt; sym co</span><span>
</span><span id="line-1753"></span><span>    </span><span class="hs-comment">--                     ev = grefl1 ; sym new_ev ; grefl2</span><span>
</span><span id="line-1754"></span><span>    </span><span class="hs-comment">--      where grefl1 : lhs1 ~ lhs1 |&gt; sym co</span><span>
</span><span id="line-1755"></span><span>    </span><span class="hs-comment">--            grefl2 : lhs2 ~ lhs2 |&gt; co</span><span>
</span><span id="line-1756"></span><span>    </span><span id="local-6989586621683043975"><span class="annot"><span class="annottext">finish_with_swapping :: TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="#local-6989586621683043975"><span class="hs-identifier hs-var hs-var">finish_with_swapping</span></a></span></span><span>
</span><span id="line-1757"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683043996"><span class="annot"><span class="annottext">lhs1_redn :: Reduction
</span><a href="#local-6989586621683043996"><span class="hs-identifier hs-var hs-var hs-var">lhs1_redn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role -&gt; TcType -&gt; MCoercion -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkGReflRightMRedn"><span class="hs-identifier hs-var">mkGReflRightMRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683043994"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043969"><span class="hs-identifier hs-var">lhs1_ty</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621683043993"><span class="hs-identifier hs-var">sym_mco</span></a></span><span>
</span><span id="line-1758"></span><span>                 </span><span id="local-6989586621683043998"><span class="annot"><span class="annottext">lhs2_redn :: Reduction
</span><a href="#local-6989586621683043998"><span class="hs-identifier hs-var hs-var hs-var">lhs2_redn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role -&gt; TcType -&gt; MCoercion -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkGReflLeftMRedn"><span class="hs-identifier hs-var">mkGReflLeftMRedn</span></a></span><span>  </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683043994"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683043995"><span class="hs-identifier hs-var">lhs2_ty</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621683043967"><span class="hs-identifier hs-var">mco</span></a></span><span>
</span><span id="line-1759"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683044000"><span class="annot"><a href="#local-6989586621683044000"><span class="hs-identifier hs-var">new_ev</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span class="annot"><span class="annottext">RewriterSet
-&gt; CtEvidence
-&gt; SwapFlag
-&gt; Reduction
-&gt; Reduction
-&gt; TcS CtEvidence
</span><a href="GHC.Tc.Solver.Equality.html#rewriteEqEvidence"><span class="hs-identifier hs-var">rewriteEqEvidence</span></a></span><span> </span><span class="annot"><span class="annottext">RewriterSet
</span><a href="GHC.Tc.Types.Constraint.html#emptyRewriterSet"><span class="hs-identifier hs-var">emptyRewriterSet</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043960"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683043962"><span class="hs-identifier hs-var">swapped</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621683043996"><span class="hs-identifier hs-var">lhs1_redn</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621683043998"><span class="hs-identifier hs-var">lhs2_redn</span></a></span><span>
</span><span id="line-1760"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#canEqCanLHSFinish"><span class="hs-identifier hs-type">canEqCanLHSFinish</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044000"><span class="hs-identifier hs-type">new_ev</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043961"><span class="hs-identifier hs-type">eq_rel</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#IsSwapped"><span class="hs-identifier hs-type">IsSwapped</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043965"><span class="hs-identifier hs-type">lhs2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683043964"><span class="hs-identifier hs-type">ps_xi1</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#mkCastTyMCo"><span class="hs-operator hs-type">`mkCastTyMCo`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683043993"><span class="hs-identifier hs-type">sym_mco</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1761"></span><span>
</span><span id="line-1762"></span><span>    </span><span id="local-6989586621683043978"><span class="annot"><span class="annottext">put_tyvar_on_lhs :: Bool
</span><a href="#local-6989586621683043978"><span class="hs-identifier hs-var hs-var">put_tyvar_on_lhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isWanted"><span class="hs-identifier hs-var">isWanted</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683043960"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683043961"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; EqRel -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#NomEq"><span class="hs-identifier hs-var">NomEq</span></a></span><span>
</span><span id="line-1763"></span><span>    </span><span class="hs-comment">-- See Note [Orienting TyVarLHS/TyFamLHS]</span><span>
</span><span id="line-1764"></span><span>    </span><span class="hs-comment">-- Same conditions as for canEqCanLHSFinish_try_unification</span><span>
</span><span id="line-1765"></span><span>    </span><span class="hs-comment">-- which we are setting ourselves up for here</span><span>
</span><span id="line-1766"></span><span>
</span><span id="line-1767"></span><span class="hs-comment">{- Note [Orienting TyVarLHS/TyFamLHS]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
What if one side is a TyVarLHS and the other is a TyFamLHS, (a ~ F tys)?
Which to put on the left?  Answer:

* If there is no chance of unifying, put the type family on the left,
  (F tys ~ a), because it's generally better to rewrite away function
  calls.  See `put_tyvar_on_lhs` in canEqCanLHS2; and
  Note [Orienting TyVarLHS/TyFamLHS]

* But if there /is/ a chance of unifying, put the tyvar on the left,
  (a ~ F tys), as this may be our only shot to unify. Again see
  `put_tyvar_on_lhs`.

* But if we /fail/ to unify then flip back to (F tys ~ a) because it's
  generally better to rewrite away function calls. See the call to
  `swapAndFinish` in `canEqCanLHSFinish_try_unification`

  It's important to flip back. Consider
    [W] F alpha ~ alpha
    [W] F alpha ~ beta
    [W] G alpha beta ~ Int   ( where we have type instance G a a = a )
  If we end up with a stuck alpha ~ F alpha, we won't be able to solve this.
  Test case: indexed-types/should_compile/CEqCanOccursCheck

Note [Orienting TyFamLHS/TyFamLHS]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we have a TyFamLHS on both sides, we choose how to orient it.

* swap_for_size.  If we have
      S a ~ F (G (H (Maybe a)))
  then we swap so that we tend to rewrite the bigger type (F (G (H (Maybe a))))
  into the smaller one (S a).  This same test tends to avoid occurs-check
  errors.  E.g.
      S g ~ F (G (S g))
  Here (S g) occurs on the RHS, so this is not canonical.  But if we swap it
  around, it /is/ canonical
      F (G (S g)) ~ S g

* swap_for_rewriting: put touchable meta-tyvars on the left:
  see Note [Put touchable variables on the left]
-}</span><span>
</span><span id="line-1809"></span><span>
</span><span id="line-1810"></span><span class="hs-comment">-- The RHS here is either not CanEqLHS, or it's one that we</span><span>
</span><span id="line-1811"></span><span class="hs-comment">-- want to rewrite the LHS to (as per e.g. swapOverTyVars)</span><span>
</span><span id="line-1812"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#canEqCanLHSFinish"><span class="hs-identifier hs-type">canEqCanLHSFinish</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#canEqCanLHSFinish_try_unification"><span class="hs-identifier hs-type">canEqCanLHSFinish_try_unification</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1813"></span><span>                   </span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#canEqCanLHSFinish_no_unification"><span class="hs-identifier hs-type">canEqCanLHSFinish_no_unification</span></a></span><span>
</span><span id="line-1814"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span>           </span><span class="hs-comment">-- (lhs ~ rhs) or if swapped (rhs ~ lhs)</span><span>
</span><span id="line-1815"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#EqRel"><span class="hs-identifier hs-type">EqRel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SwapFlag"><span class="hs-identifier hs-type">SwapFlag</span></a></span><span>
</span><span id="line-1816"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CanEqLHS"><span class="hs-identifier hs-type">CanEqLHS</span></a></span><span>             </span><span class="hs-comment">-- lhs</span><span>
</span><span id="line-1817"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>               </span><span class="hs-comment">-- rhs</span><span>
</span><span id="line-1818"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#IrredCt"><span class="hs-identifier hs-type">IrredCt</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1819"></span><span>    </span><span class="hs-comment">-- RHS is fully rewritten, but with type synonyms</span><span>
</span><span id="line-1820"></span><span>    </span><span class="hs-comment">--   preserved as much as possible</span><span>
</span><span id="line-1821"></span><span>    </span><span class="hs-comment">-- Guaranteed preconditions that</span><span>
</span><span id="line-1822"></span><span>    </span><span class="hs-comment">--    (TyEq:K)  handled in canEqCanLHSHomo</span><span>
</span><span id="line-1823"></span><span>    </span><span class="hs-comment">--    (TyEq:N)  checked in can_eq_nc</span><span>
</span><span id="line-1824"></span><span>    </span><span class="hs-comment">--    (TyEq:TV) handled in canEqCanLHS2</span><span>
</span><span id="line-1825"></span><span>
</span><span id="line-1826"></span><span class="hs-comment">---------------------------</span><span>
</span><span id="line-1827"></span><span id="canEqCanLHSFinish"><span class="annot"><span class="annottext">canEqCanLHSFinish :: CtEvidence
-&gt; EqRel
-&gt; SwapFlag
-&gt; CanEqLHS
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="GHC.Tc.Solver.Equality.html#canEqCanLHSFinish"><span class="hs-identifier hs-var hs-var">canEqCanLHSFinish</span></a></span></span><span> </span><span id="local-6989586621683044004"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044004"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683044005"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044005"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span id="local-6989586621683044006"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683044006"><span class="hs-identifier hs-var">swapped</span></a></span></span><span> </span><span id="local-6989586621683044007"><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683044007"><span class="hs-identifier hs-var">lhs</span></a></span></span><span> </span><span id="local-6989586621683044008"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044008"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-1828"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;canEqCanLHSFinish&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcS ()) -&gt; SDoc -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1829"></span><span>         </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ev:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044004"><span class="hs-identifier hs-var">ev</span></a></span><span>
</span><span id="line-1830"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;swapped:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683044006"><span class="hs-identifier hs-var">swapped</span></a></span><span>
</span><span id="line-1831"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;lhs:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683044007"><span class="hs-identifier hs-var">lhs</span></a></span><span>
</span><span id="line-1832"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rhs:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044008"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1833"></span><span>
</span><span id="line-1834"></span><span>         </span><span class="hs-comment">-- Assertion: (TyEq:K) is already satisfied</span><span>
</span><span id="line-1835"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcS ()
forall (m :: * -&gt; *). (HasCallStack, Applicative m) =&gt; Bool -&gt; m ()
</span><a href="GHC.Utils.Panic.Plain.html#massert"><span class="hs-identifier hs-var">massert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanEqLHS -&gt; TcType
</span><a href="GHC.Tc.Types.Constraint.html#canEqLHSKind"><span class="hs-identifier hs-var">canEqLHSKind</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683044007"><span class="hs-identifier hs-var">lhs</span></a></span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; TcType -&gt; TcType -&gt; Bool
TcType -&gt; TcType -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#eqType"><span class="hs-operator hs-var">`eqType`</span></a></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; TcType -&gt; TcType
TcType -&gt; TcType
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044008"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1836"></span><span>
</span><span id="line-1837"></span><span>         </span><span class="hs-comment">-- Assertion: (TyEq:N) is already satisfied (if applicable)</span><span>
</span><span id="line-1838"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">TcS Bool -&gt; SDoc -&gt; TcS ()
forall (m :: * -&gt; *).
(HasCallStack, Monad m) =&gt;
m Bool -&gt; SDoc -&gt; m ()
</span><a href="GHC.Utils.Panic.html#assertPprM"><span class="hs-identifier hs-var">assertPprM</span></a></span><span> </span><span class="annot"><span class="annottext">TcS Bool
</span><a href="#local-6989586621683044011"><span class="hs-identifier hs-var">ty_eq_N_OK</span></a></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcS ()) -&gt; SDoc -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1839"></span><span>           </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;CanEqCanLHSFinish: (TyEq:N) not satisfied&quot;</span></span><span>
</span><span id="line-1840"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rhs:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044008"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1841"></span><span>
</span><span id="line-1842"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CtEvidence
-&gt; EqRel
-&gt; SwapFlag
-&gt; CanEqLHS
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="GHC.Tc.Solver.Equality.html#canEqCanLHSFinish_try_unification"><span class="hs-identifier hs-var">canEqCanLHSFinish_try_unification</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044004"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044005"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683044006"><span class="hs-identifier hs-var">swapped</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683044007"><span class="hs-identifier hs-var">lhs</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044008"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1843"></span><span>
</span><span id="line-1844"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1845"></span><span>    </span><span class="hs-comment">-- This is about (TyEq:N): check that we don't have a saturated application</span><span>
</span><span id="line-1846"></span><span>    </span><span class="hs-comment">-- of a newtype TyCon at the top level of the RHS, if the constructor</span><span>
</span><span id="line-1847"></span><span>    </span><span class="hs-comment">-- of the newtype is in scope.</span><span>
</span><span id="line-1848"></span><span>    </span><span class="annot"><a href="#local-6989586621683044011"><span class="hs-identifier hs-type">ty_eq_N_OK</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1849"></span><span>    </span><span id="local-6989586621683044011"><span class="annot"><span class="annottext">ty_eq_N_OK :: TcS Bool
</span><a href="#local-6989586621683044011"><span class="hs-identifier hs-var hs-var">ty_eq_N_OK</span></a></span></span><span>
</span><span id="line-1850"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#ReprEq"><span class="hs-identifier hs-var">ReprEq</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044005"><span class="hs-identifier hs-var">eq_rel</span></a></span><span>
</span><span id="line-1851"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683044012"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044012"><span class="hs-identifier hs-var">tc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683044013"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044013"><span class="hs-identifier hs-var">tc_args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; TcType -&gt; Maybe (TyCon, [TcType])
TcType -&gt; Maybe (TyCon, [TcType])
</span><a href="GHC.Core.Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044008"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1852"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683044015"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621683044015"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Maybe DataCon
</span><a href="GHC.Core.TyCon.html#newTyConDataCon_maybe"><span class="hs-identifier hs-var">newTyConDataCon_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044012"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-1853"></span><span>      </span><span class="hs-comment">-- #22310: only a problem if the newtype TyCon is saturated.</span><span>
</span><span id="line-1854"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044013"><span class="hs-identifier hs-var">tc_args</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; Int -&gt; Bool
forall a. [a] -&gt; Int -&gt; Bool
</span><a href="GHC.Utils.Misc.html#lengthAtLeast"><span class="hs-operator hs-var">`lengthAtLeast`</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Int
</span><a href="GHC.Core.TyCon.html#tyConArity"><span class="hs-identifier hs-var">tyConArity</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044012"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-1855"></span><span>      </span><span class="hs-comment">-- #21010: only a problem if the newtype constructor is in scope.</span><span>
</span><span id="line-1856"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683044019"><span class="annot"><a href="#local-6989586621683044019"><span class="hs-identifier hs-var">rdr_env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS GlobalRdrEnv
</span><a href="GHC.Tc.Solver.Monad.html#getGlobalRdrEnvTcS"><span class="hs-identifier hs-var">getGlobalRdrEnvTcS</span></a></span><span>
</span><span id="line-1857"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683044020"><span class="annot"><a href="#local-6989586621683044020"><span class="hs-identifier hs-var hs-var">con_in_scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe GlobalRdrElt -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">(Maybe GlobalRdrElt -&gt; Bool) -&gt; Maybe GlobalRdrElt -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">GlobalRdrEnv -&gt; Name -&gt; Maybe GlobalRdrElt
forall info.
Outputable info =&gt;
GlobalRdrEnvX info -&gt; Name -&gt; Maybe (GlobalRdrEltX info)
</span><a href="GHC.Types.Name.Reader.html#lookupGRE_Name"><span class="hs-identifier hs-var">lookupGRE_Name</span></a></span><span> </span><span class="annot"><span class="annottext">GlobalRdrEnv
</span><a href="#local-6989586621683044019"><span class="hs-identifier hs-var">rdr_env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; Name
</span><a href="GHC.Core.DataCon.html#dataConName"><span class="hs-identifier hs-var">dataConName</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621683044015"><span class="hs-identifier hs-var">con</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1858"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="annot"><a href="#local-6989586621683044020"><span class="hs-identifier hs-type">con_in_scope</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1859"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1860"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcS Bool
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1861"></span><span>
</span><span id="line-1862"></span><span class="hs-comment">-----------------------</span><span>
</span><span id="line-1863"></span><span id="canEqCanLHSFinish_try_unification"><span class="annot"><span class="annottext">canEqCanLHSFinish_try_unification :: CtEvidence
-&gt; EqRel
-&gt; SwapFlag
-&gt; CanEqLHS
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="GHC.Tc.Solver.Equality.html#canEqCanLHSFinish_try_unification"><span class="hs-identifier hs-var hs-var">canEqCanLHSFinish_try_unification</span></a></span></span><span> </span><span id="local-6989586621683044022"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044022"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683044023"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044023"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span id="local-6989586621683044024"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683044024"><span class="hs-identifier hs-var">swapped</span></a></span></span><span> </span><span id="local-6989586621683044025"><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683044025"><span class="hs-identifier hs-var">lhs</span></a></span></span><span> </span><span id="local-6989586621683044026"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044026"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-1864"></span><span>  </span><span class="hs-comment">-- Try unification; for Wanted, Nominal equalities with a meta-tyvar on the LHS</span><span>
</span><span id="line-1865"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isWanted"><span class="hs-identifier hs-var">isWanted</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044022"><span class="hs-identifier hs-var">ev</span></a></span><span>      </span><span class="hs-comment">-- See Note [Do not unify Givens]</span><span>
</span><span id="line-1866"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#NomEq"><span class="hs-identifier hs-var">NomEq</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044023"><span class="hs-identifier hs-var">eq_rel</span></a></span><span>  </span><span class="hs-comment">-- See Note [Do not unify representational equalities]</span><span>
</span><span id="line-1867"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#TyVarLHS"><span class="hs-identifier hs-type">TyVarLHS</span></a></span><span> </span><span id="local-6989586621683044027"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683044027"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683044025"><span class="hs-identifier hs-var">lhs</span></a></span><span>
</span><span id="line-1868"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683044028"><span class="annot"><a href="#local-6989586621683044028"><span class="hs-identifier hs-var">given_eq_lvl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS TcLevel
</span><a href="GHC.Tc.Solver.Monad.html#getInnermostGivenEqLevel"><span class="hs-identifier hs-var">getInnermostGivenEqLevel</span></a></span><span>
</span><span id="line-1869"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#touchabilityAndShapeTest"><span class="hs-identifier hs-type">touchabilityAndShapeTest</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044028"><span class="hs-identifier hs-type">given_eq_lvl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044027"><span class="hs-identifier hs-type">tv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044026"><span class="hs-identifier hs-type">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1870"></span><span>         </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683044031"><span class="annot"><a href="#local-6989586621683044031"><span class="hs-identifier hs-var">can_rhs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#canTyFamEqLHS_maybe"><span class="hs-identifier hs-type">canTyFamEqLHS_maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044026"><span class="hs-identifier hs-type">rhs</span></a></span><span>
</span><span id="line-1871"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#swapAndFinish"><span class="hs-identifier hs-type">swapAndFinish</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044022"><span class="hs-identifier hs-type">ev</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044023"><span class="hs-identifier hs-type">eq_rel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044024"><span class="hs-identifier hs-type">swapped</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-type">mkTyVarTy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044027"><span class="hs-identifier hs-type">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683044031"><span class="hs-identifier hs-type">can_rhs</span></a></span><span>
</span><span id="line-1872"></span><span>                    </span><span class="hs-comment">-- See Note [Orienting TyVarLHS/TyFamLHS]</span><span>
</span><span id="line-1873"></span><span>
</span><span id="line-1874"></span><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">otherwise</span></span><span>
</span><span id="line-1875"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#canEqCanLHSFinish_no_unification"><span class="hs-identifier hs-type">canEqCanLHSFinish_no_unification</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044022"><span class="hs-identifier hs-type">ev</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044023"><span class="hs-identifier hs-type">eq_rel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044024"><span class="hs-identifier hs-type">swapped</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044025"><span class="hs-identifier hs-type">lhs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044026"><span class="hs-identifier hs-type">rhs</span></a></span><span>
</span><span id="line-1876"></span><span>         </span><span class="hs-keyword">else</span><span>
</span><span id="line-1877"></span><span>
</span><span id="line-1878"></span><span>    </span><span class="hs-comment">-- We have a touchable unification variable on the left</span><span>
</span><span id="line-1879"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683044034"><span class="annot"><a href="#local-6989586621683044034"><span class="hs-identifier hs-var">check_result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#checkTouchableTyVarEq"><span class="hs-identifier hs-type">checkTouchableTyVarEq</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044022"><span class="hs-identifier hs-type">ev</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044027"><span class="hs-identifier hs-type">tv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044026"><span class="hs-identifier hs-type">rhs</span></a></span><span>
</span><span id="line-1880"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683044034"><span class="hs-identifier hs-type">check_result</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1881"></span><span>            </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuFail"><span class="hs-identifier hs-type">PuFail</span></a></span><span> </span><span id="local-6989586621683044037"><span class="annot"><span class="annottext">CheckTyEqResult
</span><a href="#local-6989586621683044037"><span class="hs-identifier hs-var">reason</span></a></span></span><span>
</span><span id="line-1882"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683044038"><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683044038"><span class="hs-identifier hs-var">can_rhs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe CanEqLHS
</span><a href="GHC.Tc.Types.Constraint.html#canTyFamEqLHS_maybe"><span class="hs-identifier hs-var">canTyFamEqLHS_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044026"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1883"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CtEvidence
-&gt; EqRel
-&gt; SwapFlag
-&gt; TcType
-&gt; CanEqLHS
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
forall unused.
CtEvidence
-&gt; EqRel
-&gt; SwapFlag
-&gt; TcType
-&gt; CanEqLHS
-&gt; TcS (StopOrContinue (Either unused EqCt))
</span><a href="GHC.Tc.Solver.Equality.html#swapAndFinish"><span class="hs-identifier hs-var">swapAndFinish</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044022"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044023"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683044024"><span class="hs-identifier hs-var">swapped</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683044027"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683044038"><span class="hs-identifier hs-var">can_rhs</span></a></span><span>
</span><span id="line-1884"></span><span>                </span><span class="hs-comment">-- Swap back: see Note [Orienting TyVarLHS/TyFamLHS]</span><span>
</span><span id="line-1885"></span><span>
</span><span id="line-1886"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult
</span><a href="#local-6989586621683044037"><span class="hs-identifier hs-var">reason</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult -&gt; CheckTyEqResult -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#cterHasOnlyProblems"><span class="hs-operator hs-var">`cterHasOnlyProblems`</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult
</span><a href="#local-6989586621683044040"><span class="hs-identifier hs-var">do_not_prevent_rewriting</span></a></span><span>
</span><span id="line-1887"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CtEvidence
-&gt; EqRel
-&gt; SwapFlag
-&gt; CanEqLHS
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="GHC.Tc.Solver.Equality.html#canEqCanLHSFinish_no_unification"><span class="hs-identifier hs-var">canEqCanLHSFinish_no_unification</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044022"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044023"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683044024"><span class="hs-identifier hs-var">swapped</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683044025"><span class="hs-identifier hs-var">lhs</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044026"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1888"></span><span>
</span><span id="line-1889"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1890"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult
-&gt; CtEvidence
-&gt; EqRel
-&gt; SwapFlag
-&gt; CanEqLHS
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
forall unused.
CheckTyEqResult
-&gt; CtEvidence
-&gt; EqRel
-&gt; SwapFlag
-&gt; CanEqLHS
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt unused))
</span><a href="GHC.Tc.Solver.Equality.html#tryIrredInstead"><span class="hs-identifier hs-var">tryIrredInstead</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult
</span><a href="#local-6989586621683044037"><span class="hs-identifier hs-var">reason</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044022"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044023"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683044024"><span class="hs-identifier hs-var">swapped</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683044025"><span class="hs-identifier hs-var">lhs</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044026"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="hs-special">;</span><span>
</span><span id="line-1891"></span><span>
</span><span id="line-1892"></span><span>            </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuOK"><span class="hs-identifier hs-type">PuOK</span></a></span><span> </span><span class="annot"><span class="annottext">Bag ()
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683044043"><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621683044043"><span class="hs-identifier hs-var">rhs_redn</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1893"></span><span>
</span><span id="line-1894"></span><span>    </span><span class="hs-comment">-- Success: we can solve by unification</span><span>
</span><span id="line-1895"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- In the common case where rhs_redn is Refl, we don't need to rewrite</span><span>
</span><span id="line-1896"></span><span>         </span><span class="hs-comment">-- the evidence, even if swapped=IsSwapped.   Suppose the original was</span><span>
</span><span id="line-1897"></span><span>         </span><span class="hs-comment">--     [W] co : Int ~ alpha</span><span>
</span><span id="line-1898"></span><span>         </span><span class="hs-comment">-- We unify alpha := Int, and set co := &lt;Int&gt;.  No need to</span><span>
</span><span id="line-1899"></span><span>         </span><span class="hs-comment">-- swap to   co = sym co'</span><span>
</span><span id="line-1900"></span><span>         </span><span class="hs-comment">--           co' = &lt;Int&gt;</span><span>
</span><span id="line-1901"></span><span>         </span><span id="local-6989586621683044044"><span class="annot"><a href="#local-6989586621683044044"><span class="hs-identifier hs-var">new_ev</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">TcCoercion -&gt; Bool
</span><a href="GHC.Core.Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reduction -&gt; TcCoercion
</span><a href="GHC.Core.Reduction.html#reductionCoercion"><span class="hs-identifier hs-var">reductionCoercion</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621683044043"><span class="hs-identifier hs-var">rhs_redn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1902"></span><span>                   </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; TcS CtEvidence
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044022"><span class="hs-identifier hs-var">ev</span></a></span><span>
</span><span id="line-1903"></span><span>                   </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">RewriterSet
-&gt; CtEvidence
-&gt; SwapFlag
-&gt; Reduction
-&gt; Reduction
-&gt; TcS CtEvidence
</span><a href="GHC.Tc.Solver.Equality.html#rewriteEqEvidence"><span class="hs-identifier hs-var">rewriteEqEvidence</span></a></span><span> </span><span class="annot"><span class="annottext">RewriterSet
</span><a href="GHC.Tc.Types.Constraint.html#emptyRewriterSet"><span class="hs-identifier hs-var">emptyRewriterSet</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044022"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683044024"><span class="hs-identifier hs-var">swapped</span></a></span><span>
</span><span id="line-1904"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; TcType -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkReflRedn"><span class="hs-identifier hs-var">mkReflRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683044027"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621683044043"><span class="hs-identifier hs-var">rhs_redn</span></a></span><span>
</span><span id="line-1905"></span><span>
</span><span id="line-1906"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683044047"><span class="annot"><a href="#local-6989586621683044047"><span class="hs-identifier hs-var hs-var">tv_ty</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683044027"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-1907"></span><span>             </span><span id="local-6989586621683044048"><span class="annot"><a href="#local-6989586621683044048"><span class="hs-identifier hs-var hs-var">final_rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; TcType
</span><a href="GHC.Core.Reduction.html#reductionReducedType"><span class="hs-identifier hs-var">reductionReducedType</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621683044043"><span class="hs-identifier hs-var">rhs_redn</span></a></span><span>
</span><span id="line-1908"></span><span>
</span><span id="line-1909"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-type">traceTcS</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Sneaky unification:&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-1910"></span><span>         </span><span class="annot"><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-type">vcat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Unifies:&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044027"><span class="hs-identifier hs-type">tv</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;:=&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044048"><span class="hs-identifier hs-type">final_rhs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1911"></span><span>               </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Coercion:&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#pprEq"><span class="hs-identifier hs-type">pprEq</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044047"><span class="hs-identifier hs-type">tv_ty</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044048"><span class="hs-identifier hs-type">final_rhs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1912"></span><span>               </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Left Kind is:&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-type">typeKind</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044047"><span class="hs-identifier hs-type">tv_ty</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1913"></span><span>               </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Right Kind is:&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-type">typeKind</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044048"><span class="hs-identifier hs-type">final_rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1914"></span><span>
</span><span id="line-1915"></span><span>       </span><span class="hs-comment">-- Update the unification variable itself</span><span>
</span><span id="line-1916"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#unifyTyVar"><span class="hs-identifier hs-type">unifyTyVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044027"><span class="hs-identifier hs-type">tv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044048"><span class="hs-identifier hs-type">final_rhs</span></a></span><span>
</span><span id="line-1917"></span><span>
</span><span id="line-1918"></span><span>       </span><span class="hs-comment">-- Provide Refl evidence for the constraint</span><span>
</span><span id="line-1919"></span><span>       </span><span class="hs-comment">-- Ignore 'swapped' because it's Refl!</span><span>
</span><span id="line-1920"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#setEvBindIfWanted"><span class="hs-identifier hs-type">setEvBindIfWanted</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044044"><span class="hs-identifier hs-type">new_ev</span></a></span><span> </span><span class="annot"><a href="GHC.Core.InstEnv.html#EvCanonical"><span class="hs-identifier hs-type">EvCanonical</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-1921"></span><span>         </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#evCoercion"><span class="hs-identifier hs-type">evCoercion</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-type">mkNomReflCo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044048"><span class="hs-identifier hs-type">final_rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1922"></span><span>
</span><span id="line-1923"></span><span>       </span><span class="hs-comment">-- Kick out any constraints that can now be rewritten</span><span>
</span><span id="line-1924"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#kickOutAfterUnification"><span class="hs-identifier hs-type">kickOutAfterUnification</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621683044027"><span class="hs-identifier hs-type">tv</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1925"></span><span>
</span><span id="line-1926"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#Stop"><span class="hs-identifier hs-type">Stop</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044044"><span class="hs-identifier hs-type">new_ev</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Solved by unification&quot;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><span id="line-1927"></span><span>
</span><span id="line-1928"></span><span>  </span><span class="hs-comment">-- Otherwise unification is off the table</span><span>
</span><span id="line-1929"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1930"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence
-&gt; EqRel
-&gt; SwapFlag
-&gt; CanEqLHS
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="GHC.Tc.Solver.Equality.html#canEqCanLHSFinish_no_unification"><span class="hs-identifier hs-var">canEqCanLHSFinish_no_unification</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044022"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044023"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683044024"><span class="hs-identifier hs-var">swapped</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683044025"><span class="hs-identifier hs-var">lhs</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044026"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1931"></span><span>
</span><span id="line-1932"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1933"></span><span>    </span><span class="hs-comment">-- Some problems prevent /unification/ but not /rewriting/</span><span>
</span><span id="line-1934"></span><span>    </span><span class="hs-comment">-- Skolem-escape: if we have [W] alpha[2] ~ Maybe b[3]</span><span>
</span><span id="line-1935"></span><span>    </span><span class="hs-comment">--    we can't unify (skolem-escape); but it /is/ canonical,</span><span>
</span><span id="line-1936"></span><span>    </span><span class="hs-comment">--    and hence we /can/ use it for rewriting</span><span>
</span><span id="line-1937"></span><span>    </span><span class="hs-comment">-- Concrete-ness:  alpha[conc] ~ b[sk]</span><span>
</span><span id="line-1938"></span><span>    </span><span class="hs-comment">--    We can use it to rewrite; we still have to solve the original</span><span>
</span><span id="line-1939"></span><span>    </span><span class="annot"><a href="#local-6989586621683044040"><span class="hs-identifier hs-type">do_not_prevent_rewriting</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CheckTyEqResult"><span class="hs-identifier hs-type">CheckTyEqResult</span></a></span><span>
</span><span id="line-1940"></span><span>    </span><span id="local-6989586621683044040"><span class="annot"><span class="annottext">do_not_prevent_rewriting :: CheckTyEqResult
</span><a href="#local-6989586621683044040"><span class="hs-identifier hs-var hs-var">do_not_prevent_rewriting</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CheckTyEqProblem -&gt; CheckTyEqResult
</span><a href="GHC.Tc.Types.Constraint.html#cteProblem"><span class="hs-identifier hs-var">cteProblem</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqProblem
</span><a href="GHC.Tc.Types.Constraint.html#cteSkolemEscape"><span class="hs-identifier hs-var">cteSkolemEscape</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult -&gt; CheckTyEqResult -&gt; CheckTyEqResult
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">S.&lt;&gt;</span></span><span>
</span><span id="line-1941"></span><span>                               </span><span class="annot"><span class="annottext">CheckTyEqProblem -&gt; CheckTyEqResult
</span><a href="GHC.Tc.Types.Constraint.html#cteProblem"><span class="hs-identifier hs-var">cteProblem</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqProblem
</span><a href="GHC.Tc.Types.Constraint.html#cteConcrete"><span class="hs-identifier hs-var">cteConcrete</span></a></span><span>
</span><span id="line-1942"></span><span>
</span><span id="line-1943"></span><span class="hs-comment">---------------------------</span><span>
</span><span id="line-1944"></span><span class="hs-comment">-- Unification is off the table</span><span>
</span><span id="line-1945"></span><span id="canEqCanLHSFinish_no_unification"><span class="annot"><span class="annottext">canEqCanLHSFinish_no_unification :: CtEvidence
-&gt; EqRel
-&gt; SwapFlag
-&gt; CanEqLHS
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
</span><a href="GHC.Tc.Solver.Equality.html#canEqCanLHSFinish_no_unification"><span class="hs-identifier hs-var hs-var">canEqCanLHSFinish_no_unification</span></a></span></span><span> </span><span id="local-6989586621683044057"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044057"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683044058"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044058"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span id="local-6989586621683044059"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683044059"><span class="hs-identifier hs-var">swapped</span></a></span></span><span> </span><span id="local-6989586621683044060"><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683044060"><span class="hs-identifier hs-var">lhs</span></a></span></span><span> </span><span id="local-6989586621683044061"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044061"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-1946"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Do checkTypeEq to guarantee (TyEq:OC), (TyEq:F)</span><span>
</span><span id="line-1947"></span><span>         </span><span class="hs-comment">-- Must do the occurs check even on tyvar/tyvar equalities,</span><span>
</span><span id="line-1948"></span><span>         </span><span class="hs-comment">-- in case have  x ~ (y :: ..x...); this is #12593.</span><span>
</span><span id="line-1949"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683044062"><span class="annot"><a href="#local-6989586621683044062"><span class="hs-identifier hs-var">check_result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtEvidence
-&gt; EqRel -&gt; CanEqLHS -&gt; TcType -&gt; TcS (PuResult () Reduction)
</span><a href="GHC.Tc.Solver.Monad.html#checkTypeEq"><span class="hs-identifier hs-var">checkTypeEq</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044057"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044058"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683044060"><span class="hs-identifier hs-var">lhs</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044061"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1950"></span><span>
</span><span id="line-1951"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683044064"><span class="annot"><a href="#local-6989586621683044064"><span class="hs-identifier hs-var hs-var">lhs_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CanEqLHS -&gt; TcType
</span><a href="GHC.Tc.Types.Constraint.html#canEqLHSType"><span class="hs-identifier hs-var">canEqLHSType</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683044060"><span class="hs-identifier hs-var">lhs</span></a></span><span>
</span><span id="line-1952"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683044062"><span class="hs-identifier hs-type">check_result</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1953"></span><span>            </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuFail"><span class="hs-identifier hs-type">PuFail</span></a></span><span> </span><span id="local-6989586621683044065"><span class="annot"><span class="annottext">CheckTyEqResult
</span><a href="#local-6989586621683044065"><span class="hs-identifier hs-var">reason</span></a></span></span><span>
</span><span id="line-1954"></span><span>
</span><span id="line-1955"></span><span>              </span><span class="hs-comment">-- If we had F a ~ G (F a), which gives an occurs check,</span><span>
</span><span id="line-1956"></span><span>              </span><span class="hs-comment">-- then swap it to G (F a) ~ F a, which does not</span><span>
</span><span id="line-1957"></span><span>              </span><span class="hs-comment">-- However `swap_for_size` above will orient it with (G (F a)) on</span><span>
</span><span id="line-1958"></span><span>              </span><span class="hs-comment">-- the left anwyway.  `swap_for_rewriting` &quot;wins&quot;, but that doesn't</span><span>
</span><span id="line-1959"></span><span>              </span><span class="hs-comment">-- matter: in the occurs check case swap_for_rewriting will be moot.</span><span>
</span><span id="line-1960"></span><span>              </span><span class="hs-comment">-- TL;DR: the next four lines of code are redundant</span><span>
</span><span id="line-1961"></span><span>              </span><span class="hs-comment">-- I'm leaving them here in case they become relevant again</span><span>
</span><span id="line-1962"></span><span class="hs-comment">--              | TyFamLHS {} &lt;- lhs</span><span>
</span><span id="line-1963"></span><span class="hs-comment">--              , Just can_rhs &lt;- canTyFamEqLHS_maybe rhs</span><span>
</span><span id="line-1964"></span><span class="hs-comment">--              , reason `cterHasOnlyProblem` cteSolubleOccurs</span><span>
</span><span id="line-1965"></span><span class="hs-comment">--              -&gt; swapAndFinish ev eq_rel swapped lhs_ty can_rhs</span><span>
</span><span id="line-1966"></span><span class="hs-comment">--              | otherwise</span><span>
</span><span id="line-1967"></span><span>
</span><span id="line-1968"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult
-&gt; CtEvidence
-&gt; EqRel
-&gt; SwapFlag
-&gt; CanEqLHS
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt EqCt))
forall unused.
CheckTyEqResult
-&gt; CtEvidence
-&gt; EqRel
-&gt; SwapFlag
-&gt; CanEqLHS
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt unused))
</span><a href="GHC.Tc.Solver.Equality.html#tryIrredInstead"><span class="hs-identifier hs-var">tryIrredInstead</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult
</span><a href="#local-6989586621683044065"><span class="hs-identifier hs-var">reason</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044057"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044058"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683044059"><span class="hs-identifier hs-var">swapped</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683044060"><span class="hs-identifier hs-var">lhs</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044061"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1969"></span><span>
</span><span id="line-1970"></span><span>            </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuOK"><span class="hs-identifier hs-type">PuOK</span></a></span><span> </span><span class="annot"><span class="annottext">Bag ()
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683044066"><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621683044066"><span class="hs-identifier hs-var">rhs_redn</span></a></span></span><span>
</span><span id="line-1971"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683044067"><span class="annot"><a href="#local-6989586621683044067"><span class="hs-identifier hs-var">new_ev</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RewriterSet
-&gt; CtEvidence
-&gt; SwapFlag
-&gt; Reduction
-&gt; Reduction
-&gt; TcS CtEvidence
</span><a href="GHC.Tc.Solver.Equality.html#rewriteEqEvidence"><span class="hs-identifier hs-var">rewriteEqEvidence</span></a></span><span> </span><span class="annot"><span class="annottext">RewriterSet
</span><a href="GHC.Tc.Types.Constraint.html#emptyRewriterSet"><span class="hs-identifier hs-var">emptyRewriterSet</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044057"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683044059"><span class="hs-identifier hs-var">swapped</span></a></span><span>
</span><span id="line-1972"></span><span>                                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; TcType -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkReflRedn"><span class="hs-identifier hs-var">mkReflRedn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EqRel -&gt; Role
</span><a href="GHC.Core.Predicate.html#eqRelRole"><span class="hs-identifier hs-var">eqRelRole</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044058"><span class="hs-identifier hs-var">eq_rel</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044064"><span class="hs-identifier hs-var">lhs_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1973"></span><span>                                   </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621683044066"><span class="hs-identifier hs-var">rhs_redn</span></a></span><span>
</span><span id="line-1974"></span><span>
</span><span id="line-1975"></span><span>                    </span><span class="hs-comment">-- Important: even if the coercion is Refl,</span><span>
</span><span id="line-1976"></span><span>                    </span><span class="hs-comment">--   * new_ev has reductionReducedType on the RHS</span><span>
</span><span id="line-1977"></span><span>                    </span><span class="hs-comment">--   * eq_rhs is set to reductionReducedType</span><span>
</span><span id="line-1978"></span><span>                    </span><span class="hs-comment">-- See Note [Forgetful synonyms in checkTyConApp] in GHC.Tc.Utils.Unify</span><span>
</span><span id="line-1979"></span><span>                    </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#continueWith"><span class="hs-identifier hs-type">continueWith</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-1980"></span><span>                      </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#eq_ev"><span class="hs-identifier hs-var">eq_ev</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683044067"><span class="hs-identifier hs-type">new_ev</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#eq_eq_rel"><span class="hs-identifier hs-var">eq_eq_rel</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683044058"><span class="hs-identifier hs-type">eq_rel</span></a></span><span>
</span><span id="line-1981"></span><span>                           </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#eq_lhs"><span class="hs-identifier hs-var">eq_lhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683044060"><span class="hs-identifier hs-type">lhs</span></a></span><span>
</span><span id="line-1982"></span><span>                           </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#eq_rhs"><span class="hs-identifier hs-var">eq_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#reductionReducedType"><span class="hs-identifier hs-var">reductionReducedType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044066"><span class="hs-identifier hs-type">rhs_redn</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1983"></span><span>
</span><span id="line-1984"></span><span class="hs-comment">----------------------</span><span>
</span><span id="line-1985"></span><span id="local-6989586621683042622"><span class="annot"><a href="GHC.Tc.Solver.Equality.html#swapAndFinish"><span class="hs-identifier hs-type">swapAndFinish</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#EqRel"><span class="hs-identifier hs-type">EqRel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SwapFlag"><span class="hs-identifier hs-type">SwapFlag</span></a></span><span>
</span><span id="line-1986"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CanEqLHS"><span class="hs-identifier hs-type">CanEqLHS</span></a></span><span>      </span><span class="hs-comment">-- ty ~ F tys</span><span>
</span><span id="line-1987"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="#local-6989586621683042622"><span class="hs-identifier hs-type">unused</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-1988"></span><span class="hs-comment">-- We have an equality alpha ~ F tys, that we can't unify e.g because 'tys'</span><span>
</span><span id="line-1989"></span><span class="hs-comment">-- mentions alpha, it would not be a canonical constraint as-is.</span><span>
</span><span id="line-1990"></span><span class="hs-comment">-- We want to flip it to (F tys ~ a), whereupon it is canonical</span><span>
</span><span id="line-1991"></span><span id="swapAndFinish"><span class="annot"><span class="annottext">swapAndFinish :: forall unused.
CtEvidence
-&gt; EqRel
-&gt; SwapFlag
-&gt; TcType
-&gt; CanEqLHS
-&gt; TcS (StopOrContinue (Either unused EqCt))
</span><a href="GHC.Tc.Solver.Equality.html#swapAndFinish"><span class="hs-identifier hs-var hs-var">swapAndFinish</span></a></span></span><span> </span><span id="local-6989586621683044074"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044074"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683044075"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044075"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span id="local-6989586621683044076"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683044076"><span class="hs-identifier hs-var">swapped</span></a></span></span><span> </span><span id="local-6989586621683044077"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044077"><span class="hs-identifier hs-var">lhs_ty</span></a></span></span><span> </span><span id="local-6989586621683044078"><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683044078"><span class="hs-identifier hs-var">can_rhs</span></a></span></span><span>
</span><span id="line-1992"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683044079"><span class="annot"><span class="annottext">role :: Role
</span><a href="#local-6989586621683044079"><span class="hs-keyword hs-var hs-var hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; Role
</span><a href="GHC.Core.Predicate.html#eqRelRole"><span class="hs-identifier hs-var">eqRelRole</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044075"><span class="hs-identifier hs-var">eq_rel</span></a></span><span>
</span><span id="line-1993"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683044080"><span class="annot"><a href="#local-6989586621683044080"><span class="hs-identifier hs-var">new_ev</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RewriterSet
-&gt; CtEvidence
-&gt; SwapFlag
-&gt; Reduction
-&gt; Reduction
-&gt; TcS CtEvidence
</span><a href="GHC.Tc.Solver.Equality.html#rewriteEqEvidence"><span class="hs-identifier hs-var">rewriteEqEvidence</span></a></span><span> </span><span class="annot"><span class="annottext">RewriterSet
</span><a href="GHC.Tc.Types.Constraint.html#emptyRewriterSet"><span class="hs-identifier hs-var">emptyRewriterSet</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044074"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SwapFlag -&gt; SwapFlag
</span><a href="GHC.Types.Basic.html#flipSwap"><span class="hs-identifier hs-var">flipSwap</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683044076"><span class="hs-identifier hs-var">swapped</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1994"></span><span>                       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; TcType -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkReflRedn"><span class="hs-identifier hs-var">mkReflRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683044079"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanEqLHS -&gt; TcType
</span><a href="GHC.Tc.Types.Constraint.html#canEqLHSType"><span class="hs-identifier hs-var">canEqLHSType</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683044078"><span class="hs-identifier hs-var">can_rhs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1995"></span><span>                       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; TcType -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkReflRedn"><span class="hs-identifier hs-var">mkReflRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683044079"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044077"><span class="hs-identifier hs-var">lhs_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1996"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#continueWith"><span class="hs-identifier hs-type">continueWith</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-1997"></span><span>         </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#eq_ev"><span class="hs-identifier hs-var">eq_ev</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683044080"><span class="hs-identifier hs-type">new_ev</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#eq_eq_rel"><span class="hs-identifier hs-var">eq_eq_rel</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683044075"><span class="hs-identifier hs-type">eq_rel</span></a></span><span>
</span><span id="line-1998"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#eq_lhs"><span class="hs-identifier hs-var">eq_lhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683044078"><span class="hs-identifier hs-type">can_rhs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#eq_rhs"><span class="hs-identifier hs-var">eq_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683044077"><span class="hs-identifier hs-type">lhs_ty</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1999"></span><span>
</span><span id="line-2000"></span><span class="hs-comment">----------------------</span><span>
</span><span id="line-2001"></span><span id="local-6989586621683042624"><span class="annot"><a href="GHC.Tc.Solver.Equality.html#tryIrredInstead"><span class="hs-identifier hs-type">tryIrredInstead</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CheckTyEqResult"><span class="hs-identifier hs-type">CheckTyEqResult</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span>
</span><span id="line-2002"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#EqRel"><span class="hs-identifier hs-type">EqRel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SwapFlag"><span class="hs-identifier hs-type">SwapFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CanEqLHS"><span class="hs-identifier hs-type">CanEqLHS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>
</span><span id="line-2003"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#IrredCt"><span class="hs-identifier hs-type">IrredCt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683042624"><span class="hs-identifier hs-type">unused</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-2004"></span><span class="hs-comment">-- We have a non-canonical equality</span><span>
</span><span id="line-2005"></span><span class="hs-comment">-- We still swap it if 'swapped' says so, so that it is oriented</span><span>
</span><span id="line-2006"></span><span class="hs-comment">-- in the direction that the error-reporting machinery</span><span>
</span><span id="line-2007"></span><span class="hs-comment">-- expects it; e.g.  (m ~ t m) rather than (t m ~ m)</span><span>
</span><span id="line-2008"></span><span class="hs-comment">-- This is not very important, and only affects error reporting.</span><span>
</span><span id="line-2009"></span><span id="tryIrredInstead"><span class="annot"><span class="annottext">tryIrredInstead :: forall unused.
CheckTyEqResult
-&gt; CtEvidence
-&gt; EqRel
-&gt; SwapFlag
-&gt; CanEqLHS
-&gt; TcType
-&gt; TcS (StopOrContinue (Either IrredCt unused))
</span><a href="GHC.Tc.Solver.Equality.html#tryIrredInstead"><span class="hs-identifier hs-var hs-var">tryIrredInstead</span></a></span></span><span> </span><span id="local-6989586621683044090"><span class="annot"><span class="annottext">CheckTyEqResult
</span><a href="#local-6989586621683044090"><span class="hs-identifier hs-var">reason</span></a></span></span><span> </span><span id="local-6989586621683044091"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044091"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683044092"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044092"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span id="local-6989586621683044093"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683044093"><span class="hs-identifier hs-var">swapped</span></a></span></span><span> </span><span id="local-6989586621683044094"><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683044094"><span class="hs-identifier hs-var">lhs</span></a></span></span><span> </span><span id="local-6989586621683044095"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044095"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-2010"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;cantMakeCanonical&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CheckTyEqResult -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult
</span><a href="#local-6989586621683044090"><span class="hs-identifier hs-var">reason</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683044094"><span class="hs-identifier hs-var">lhs</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044095"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2011"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683044096"><span class="annot"><span class="annottext">role :: Role
</span><a href="#local-6989586621683044096"><span class="hs-keyword hs-var hs-var hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; Role
</span><a href="GHC.Core.Predicate.html#eqRelRole"><span class="hs-identifier hs-var">eqRelRole</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044092"><span class="hs-identifier hs-var">eq_rel</span></a></span><span>
</span><span id="line-2012"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683044097"><span class="annot"><a href="#local-6989586621683044097"><span class="hs-identifier hs-var">new_ev</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RewriterSet
-&gt; CtEvidence
-&gt; SwapFlag
-&gt; Reduction
-&gt; Reduction
-&gt; TcS CtEvidence
</span><a href="GHC.Tc.Solver.Equality.html#rewriteEqEvidence"><span class="hs-identifier hs-var">rewriteEqEvidence</span></a></span><span> </span><span class="annot"><span class="annottext">RewriterSet
</span><a href="GHC.Tc.Types.Constraint.html#emptyRewriterSet"><span class="hs-identifier hs-var">emptyRewriterSet</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044091"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683044093"><span class="hs-identifier hs-var">swapped</span></a></span><span>
</span><span id="line-2013"></span><span>                       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; TcType -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkReflRedn"><span class="hs-identifier hs-var">mkReflRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683044096"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanEqLHS -&gt; TcType
</span><a href="GHC.Tc.Types.Constraint.html#canEqLHSType"><span class="hs-identifier hs-var">canEqLHSType</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683044094"><span class="hs-identifier hs-var">lhs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2014"></span><span>                       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; TcType -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkReflRedn"><span class="hs-identifier hs-var">mkReflRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683044096"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044095"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2015"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#finishCanWithIrred"><span class="hs-identifier hs-type">finishCanWithIrred</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#NonCanonicalReason"><span class="hs-identifier hs-type">NonCanonicalReason</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044090"><span class="hs-identifier hs-type">reason</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683044097"><span class="hs-identifier hs-type">new_ev</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2016"></span><span>
</span><span id="line-2017"></span><span id="local-6989586621683042554"><span class="annot"><a href="GHC.Tc.Solver.Equality.html#finishCanWithIrred"><span class="hs-identifier hs-type">finishCanWithIrred</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtIrredReason"><span class="hs-identifier hs-type">CtIrredReason</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span>
</span><span id="line-2018"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#IrredCt"><span class="hs-identifier hs-type">IrredCt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683042554"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-2019"></span><span id="finishCanWithIrred"><span class="annot"><span class="annottext">finishCanWithIrred :: forall a.
CtIrredReason
-&gt; CtEvidence -&gt; TcS (StopOrContinue (Either IrredCt a))
</span><a href="GHC.Tc.Solver.Equality.html#finishCanWithIrred"><span class="hs-identifier hs-var hs-var">finishCanWithIrred</span></a></span></span><span> </span><span id="local-6989586621683044101"><span class="annot"><span class="annottext">CtIrredReason
</span><a href="#local-6989586621683044101"><span class="hs-identifier hs-var">reason</span></a></span></span><span> </span><span id="local-6989586621683044102"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044102"><span class="hs-identifier hs-var">ev</span></a></span></span><span>
</span><span id="line-2020"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Abort fast if we have any insoluble Wanted constraints,</span><span>
</span><span id="line-2021"></span><span>         </span><span class="hs-comment">-- and the TcS abort-if-insoluble flag is on.</span><span>
</span><span id="line-2022"></span><span>         </span><span class="annot"><span class="annottext">Bool -&gt; TcS () -&gt; TcS ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtIrredReason -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isInsolubleReason"><span class="hs-identifier hs-var">isInsolubleReason</span></a></span><span> </span><span class="annot"><span class="annottext">CtIrredReason
</span><a href="#local-6989586621683044101"><span class="hs-identifier hs-var">reason</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#tryEarlyAbortTcS"><span class="hs-identifier hs-var">tryEarlyAbortTcS</span></a></span><span>
</span><span id="line-2023"></span><span>
</span><span id="line-2024"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Either IrredCt a -&gt; TcS (StopOrContinue (Either IrredCt a))
forall a. a -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Monad.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a></span><span> </span><span class="annot"><span class="annottext">(Either IrredCt a -&gt; TcS (StopOrContinue (Either IrredCt a)))
-&gt; Either IrredCt a -&gt; TcS (StopOrContinue (Either IrredCt a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IrredCt -&gt; Either IrredCt a
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">(IrredCt -&gt; Either IrredCt a) -&gt; IrredCt -&gt; Either IrredCt a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#IrredCt"><span class="hs-identifier hs-type">IrredCt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ir_ev :: CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#ir_ev"><span class="hs-identifier hs-var">ir_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044102"><span class="hs-identifier hs-var">ev</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ir_reason :: CtIrredReason
</span><a href="GHC.Tc.Types.Constraint.html#ir_reason"><span class="hs-identifier hs-var">ir_reason</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtIrredReason
</span><a href="#local-6989586621683044101"><span class="hs-identifier hs-var">reason</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2025"></span><span>
</span><span id="line-2026"></span><span class="hs-comment">-----------------------</span><span>
</span><span id="line-2027"></span><span class="annot"><span class="hs-comment">-- | Solve a reflexive equality constraint</span></span><span>
</span><span id="line-2028"></span><span id="local-6989586621683042486"><span class="annot"><a href="GHC.Tc.Solver.Equality.html#canEqReflexive"><span class="hs-identifier hs-type">canEqReflexive</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span>    </span><span class="hs-comment">-- ty ~ ty</span><span>
</span><span id="line-2029"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#EqRel"><span class="hs-identifier hs-type">EqRel</span></a></span><span>
</span><span id="line-2030"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>        </span><span class="hs-comment">-- ty</span><span>
</span><span id="line-2031"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683042486"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>   </span><span class="hs-comment">-- always Stop</span><span>
</span><span id="line-2032"></span><span id="canEqReflexive"><span class="annot"><span class="annottext">canEqReflexive :: forall a. CtEvidence -&gt; EqRel -&gt; TcType -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Equality.html#canEqReflexive"><span class="hs-identifier hs-var hs-var">canEqReflexive</span></a></span></span><span> </span><span id="local-6989586621683044110"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044110"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683044111"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044111"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span id="local-6989586621683044112"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044112"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-2033"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CanonicalEvidence -&gt; EvTerm -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#setEvBindIfWanted"><span class="hs-identifier hs-var">setEvBindIfWanted</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044110"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">CanonicalEvidence
</span><a href="GHC.Core.InstEnv.html#EvCanonical"><span class="hs-identifier hs-var">EvCanonical</span></a></span><span> </span><span class="annot"><span class="annottext">(EvTerm -&gt; TcS ()) -&gt; EvTerm -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2034"></span><span>         </span><span class="annot"><span class="annottext">TcCoercion -&gt; EvTerm
</span><a href="GHC.Tc.Types.Evidence.html#evCoercion"><span class="hs-identifier hs-var">evCoercion</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; TcType -&gt; TcCoercion
</span><a href="GHC.Core.Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EqRel -&gt; Role
</span><a href="GHC.Core.Predicate.html#eqRelRole"><span class="hs-identifier hs-var">eqRelRole</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044111"><span class="hs-identifier hs-var">eq_rel</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044112"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2035"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; String -&gt; TcS (StopOrContinue a)
forall a. CtEvidence -&gt; String -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Monad.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044110"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Solved by reflexivity&quot;</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2036"></span><span>
</span><span id="line-2037"></span><span class="hs-comment">{- Note [Equalities with incompatible kinds]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
What do we do when we have an equality

  (tv :: k1) ~ (rhs :: k2)

where k1 and k2 differ? Easy: we create a coercion that relates k1 and
k2 and use this to cast. To wit, from

  [X] (tv :: k1) ~ (rhs :: k2)

(where [X] is [G] or [W]), we go to

  [X] co :: k1 ~ k2
  [X] (tv :: k1) ~ ((rhs |&gt; sym co) :: k1)

Wrinkles:

(EIK1) When X is W, the new type-level wanted is effectively rewritten by the
     kind-level one. We thus include the kind-level wanted in the RewriterSet
     for the type-level one. See Note [Wanteds rewrite Wanteds] in GHC.Tc.Types.Constraint.
     This is done in canEqCanLHSHetero.

(EIK2) Suppose we have [W] (a::Type) ~ (b::Type-&gt;Type). The above rewrite will produce
        [W] w  : a ~ (b |&gt; kw)
        [W] kw : Type ~ (Type-&gt;Type)

     But we do /not/ want to regard `w` as canonical, and use it for rewriting
     other constraints: `kw` is insoluble, and replacing something of kind
     `Type` with something of kind `Type-&gt;Type` (even wrapped in an insouluble
     cast) does not help, and doing so turns out to lead to much worse error
     messages.  (In particular, if 'a' is a unification variable, we might
     unify, losing the tracking info that it depends on solving `kw`.)

     Conclusion: if a RHS contains a coercion hole arising from fixing a hetero-kinded
     equality, treat the equality (`w` in this case) as non-canonical, so that
       * It will not be used for unification
       * It will not be used for rewriting
     Instead, it lands in the inert_irreds in the inert set, awaiting solution of
     that `kw`.

     (EIK2a) We must later indeed unify if/when the kind-level wanted, `kw` gets
     solved. This is done in kickOutAfterFillingCoercionHole, which kicks out
     all equalities whose RHS mentions the filled-in coercion hole.  Note that
     it looks for type family equalities, too, because of the use of unifyTest
     in canEqTyVarFunEq.

     (EIK2b) What if the RHS mentions /other/ coercion holes?  How can that happen?  The
     main way is like this. Assume F :: forall k. k -&gt; Type
        [W] kw : k  ~ Type
        [W] w  : a ~ F k t
     We can rewrite `w` with `kw` like this:
        [W] w' : a ~ F Type (t |&gt; kw)
     The cast on the second argument of `F` is necessary to keep the appliation well-kinded.
     There is nothing special here; no reason not treat w' as canonical, and use it for
     rewriting. Indeed tests JuanLopez only typechecks if we do.  So we'd like to treat
     this kind of equality as canonical.

     Hence the ch_hetero_kind field in CoercionHole: it is True of constraints
     created by `canEqCanLHSHetero` to fix up hetero-kinded equalities; and False otherwise:

     * An equality constraint is non-canonical if it mentions a hetero-kind
       CoercionHole on the RHS.  See the `hasCoercionHoleCo` test in GHC.Tc.Utils.checkCo.

     * Hetero-kind CoercionHoles are created when the parent's CtOrigin is
       KindEqOrigin: see GHC.Tc.Utils.TcMType.newCoercionHole and friends.  We
       set this origin, via `mkKindLoc`, in `mk_kind_eq` in `canEqCanLHSHetero`.

(EIK3) Suppose we have [W] (a :: k1) ~ (rhs :: k2). We duly follow the
     algorithm detailed here, producing [W] co :: k1 ~ k2, and adding
     [W] (a :: k1) ~ ((rhs |&gt; sym co) :: k1) to the irreducibles. Some time
     later, we solve co, and fill in co's coercion hole. This kicks out
     the irreducible as described in (2).

     But now, during canonicalization, we see the cast and remove it, in
     canEqCast. By the time we get into canEqCanLHS, the equality is
     heterogeneous again, and the process repeats.

     To avoid this, we don't strip casts off a type if the other type in the
     equality is a CanEqLHS (the scenario above can happen with a type
     family, too. testcase: typecheck/should_compile/T13822).

     And this is an improvement regardless: because tyvars can, generally,
     unify with casted types, there's no reason to go through the work of
     stripping off the cast when the cast appears opposite a tyvar. This is
     implemented in the cast case of can_eq_nc.

Historical note:

We used to do this via emitting a Derived kind equality and then parking
the heterogeneous equality as irreducible. But this new approach is much
more direct. And it doesn't produce duplicate Deriveds (as the old one did).

Note [Type synonyms and canonicalization]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We treat type synonym applications as xi types, that is, they do not
count as type function applications.  However, we do need to be a bit
careful with type synonyms: like type functions they may not be
generative or injective.  However, unlike type functions, they are
parametric, so there is no problem in expanding them whenever we see
them, since we do not need to know anything about their arguments in
order to expand them; this is what justifies not having to treat them
as specially as type function applications.  The thing that causes
some subtleties is that we prefer to leave type synonym applications
*unexpanded* whenever possible, in order to generate better error
messages.

If we encounter an equality constraint with type synonym applications
on both sides, or a type synonym application on one side and some sort
of type application on the other, we simply must expand out the type
synonyms in order to continue decomposing the equality constraint into
primitive equality constraints.  For example, suppose we have

  type F a = [Int]

and we encounter the equality

  F a ~ [b]

In order to continue we must expand F a into [Int], giving us the
equality

  [Int] ~ [b]

which we can then decompose into the more primitive equality
constraint

  Int ~ b.

However, if we encounter an equality constraint with a type synonym
application on one side and a variable on the other side, we should
NOT (necessarily) expand the type synonym, since for the purpose of
good error messages we want to leave type synonyms unexpanded as much
as possible.  Hence the ps_xi1, ps_xi2 argument passed to canEqCanLHS.

Note [Type equality cycles]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this situation (from indexed-types/should_compile/GivenLoop):

  instance C (Maybe b)
  *[G] a ~ Maybe (F a)
  [W] C a

or (typecheck/should_compile/T19682b):

  instance C (a -&gt; b)
  *[W] alpha ~ (Arg alpha -&gt; Res alpha)
  [W] C alpha

or (typecheck/should_compile/T21515):

  type family Code a
  *[G] Code a ~ '[ '[ Head (Head (Code a)) ] ]
  [W] Code a ~ '[ '[ alpha ] ]

In order to solve the final Wanted, we must use the starred constraint
for rewriting. But note that all starred constraints have occurs-check failures,
and so we can't straightforwardly add these to the inert set and
use them for rewriting. (NB: A rigid type constructor is at the
top of all RHSs, preventing reorienting in canEqTyVarFunEq in the tyvar
cases.)

The key idea is to replace the outermost type family applications in the RHS of
the starred constraints with a fresh variable, which we'll call a cycle-breaker
variable, or cbv. Then, relate the cbv back with the original type family
application via new equality constraints. Our situations thus become:

  instance C (Maybe b)
  [G] a ~ Maybe cbv
  [G] F a ~ cbv
  [W] C a

or

  instance C (a -&gt; b)
  [W] alpha ~ (cbv1 -&gt; cbv2)
  [W] Arg alpha ~ cbv1
  [W] Res alpha ~ cbv2
  [W] C alpha

or

  [G] Code a ~ '[ '[ cbv ] ]
  [G] Head (Head (Code a)) ~ cbv
  [W] Code a ~ '[ '[ alpha ] ]

This transformation (creating the new types and emitting new equality
constraints) is done by the `FamAppBreaker` field of `TEFA_Break`, which
in turn lives in the `tef_fam_app` field of `TyEqFlags`.  And that in
turn controls the behaviour of the workhorse: GHC.Tc.Utils.Unify.checkTyEqRhs.

The details depend on whether we're working with a Given or a Wanted.

Given
-----
We emit a new Given, [G] F a ~ cbv, equating the type family application
to our new cbv. This is actually done by `break_given` in
`GHC.Tc.Solver.Monad.checkTypeEq`.

Note its orientation: The type family ends up on the left; see
Note [Orienting TyFamLHS/TyFamLHS]d. No special treatment for
CycleBreakerTvs is necessary. This scenario is now easily soluble, by using
the first Given to rewrite the Wanted, which can now be solved.

(The first Given actually also rewrites the second one, giving
[G] F (Maybe cbv) ~ cbv, but this causes no trouble.)

Of course, we don't want our fresh variables leaking into e.g. error
messages.  So we fill in the metavariables with their original type family
applications after we're done running the solver (in nestImplicTcS and
runTcSWithEvBinds).  This is done by `restoreTyVarCycles`, which uses the
`inert_cycle_breakers` field in InertSet, which contains the pairings
invented in `break_given`.

That is, we transform
  [G] g : lhs ~ ...(F lhs)...
to
  [G] (Refl lhs) : F lhs ~ cbv      -- CEqCan
  [G] g          : lhs ~ ...cbv...  -- CEqCan

Note that
* `cbv` is a fresh cycle breaker variable.
* `cbv` is a is a meta-tyvar, but it is completely untouchable.
* We track the cycle-breaker variables in inert_cycle_breakers in InertSet
* We eventually fill in the cycle-breakers, with `cbv := F lhs`.
  No one else fills in CycleBreakerTvs!
* The evidence for the new `F lhs ~ cbv` constraint is Refl, because we know
  this fill-in is ultimately going to happen.
* In `inert_cycle_breakers`, we remember the (cbv, F lhs) pair; that is, we
  remember the /original/ type.  The [G] F lhs ~ cbv constraint may be rewritten
  by other givens (eg if we have another [G] lhs ~ (b,c)), but at the end we
  still fill in with cbv := F lhs
* This fill-in is done when solving is complete, by restoreTyVarCycles
  in nestImplicTcS and runTcSWithEvBinds.

Wanted
------
First, we do not cycle-break unless the LHS is a unifiable type variable
See Note [Don't cycle-break Wanteds when not unifying] in GHC.Tc.Solver.Monad.

OK, so suppose the LHS is a unifiable type variable.  The fresh cycle-breaker
variables here must actually be normal, touchable metavariables. That is, they
are TauTvs. Nothing at all unusual. Repeating the example from above, we have

  *[W] alpha ~ (Arg alpha -&gt; Res alpha)

and we turn this into

  *[W] alpha ~ (cbv1 -&gt; cbv2)
  [W] Arg alpha ~ cbv1
  [W] Res alpha ~ cbv2

where cbv1 and cbv2 are fresh TauTvs.  This is actually done by `break_wanted`
in `GHC.Tc.Solver.Monad.checkTouchableTyVarEq`.

Why TauTvs? See [Why TauTvs] below.

Critically, we emit the two new constraints (the last two above)
directly instead of calling wrapUnifierTcS. (Otherwise, we'd end up
unifying cbv1 and cbv2 immediately, achieving nothing.)  Next, we
unify alpha := cbv1 -&gt; cbv2, having eliminated the occurs check. This
unification happens immediately following a successful call to
checkTouchableTyVarEq, in canEqCanLHSFinish_try_unification.

Now, we're here (including further context from our original example,
from the top of the Note):

  instance C (a -&gt; b)
  [W] Arg (cbv1 -&gt; cbv2) ~ cbv1
  [W] Res (cbv1 -&gt; cbv2) ~ cbv2
  [W] C (cbv1 -&gt; cbv2)

The first two W constraints reduce to reflexivity and are discarded,
and the last is easily soluble.

[Why TauTvs]:
Let's look at another example (typecheck/should_compile/T19682) where we need
to unify the cbvs:

  class    (AllEqF xs ys, SameShapeAs xs ys) =&gt; AllEq xs ys
  instance (AllEqF xs ys, SameShapeAs xs ys) =&gt; AllEq xs ys

  type family SameShapeAs xs ys :: Constraint where
    SameShapeAs '[] ys      = (ys ~ '[])
    SameShapeAs (x : xs) ys = (ys ~ (Head ys : Tail ys))

  type family AllEqF xs ys :: Constraint where
    AllEqF '[]      '[]      = ()
    AllEqF (x : xs) (y : ys) = (x ~ y, AllEq xs ys)

  [W] alpha ~ (Head alpha : Tail alpha)
  [W] AllEqF '[Bool] alpha

Without the logic detailed in this Note, we're stuck here, as AllEqF cannot
reduce and alpha cannot unify. Let's instead apply our cycle-breaker approach,
just as described above. We thus invent cbv1 and cbv2 and unify
alpha := cbv1 -&gt; cbv2, yielding (after zonking)

  [W] Head (cbv1 : cbv2) ~ cbv1
  [W] Tail (cbv1 : cbv2) ~ cbv2
  [W] AllEqF '[Bool] (cbv1 : cbv2)

The first two W constraints simplify to reflexivity and are discarded.
But the last reduces:

  [W] Bool ~ cbv1
  [W] AllEq '[] cbv2

The first of these is solved by unification: cbv1 := Bool. The second
is solved by the instance for AllEq to become

  [W] AllEqF '[] cbv2
  [W] SameShapeAs '[] cbv2

While the first of these is stuck, the second makes progress, to lead to

  [W] AllEqF '[] cbv2
  [W] cbv2 ~ '[]

This second constraint is solved by unification: cbv2 := '[]. We now
have

  [W] AllEqF '[] '[]

which reduces to

  [W] ()

which is trivially satisfiable. Hooray!

Note that we need to unify the cbvs here; if we did not, there would be
no way to solve those constraints. That's why the cycle-breakers are
ordinary TauTvs.

How all this is implemented
---------------------------
We implement all this via the `TEFA_Break` constructor of `TyEqFamApp`,
itself stored in the `tef_fam_app` field of `TyEqFlags`, which controls
the behaviour of `GHC.Tc.Utils.Unify.checkTyEqRhs`.  The `TEFA_Break`
stuff happens when `checkTyEqRhs` encounters a family application.

We try the cycle-breaking trick:
* For Wanteds, when there is a touchable unification variable on the left
* For Givens, regardless of the LHS

EXCEPT that, in both cases, as `GHC.Tc.Solver.Monad.mkTEFA_Break` shows, we
don't use this trick:

* When the constraint we are looking at was itself created by cycle-breaking;
  see Detail (7) below.

* For representational equalities, as there is no concrete use case where it is
  helpful (unlike for nominal equalities).

  Furthermore, because function applications can be CanEqLHSs, but newtype
  applications cannot, the disparities between the cases are enough that it
  would be effortful to expand the idea to representational equalities. A quick
  attempt, with
      data family N a b
      f :: (Coercible a (N a b), Coercible (N a b) b) =&gt; a -&gt; b
      f = coerce
  failed with &quot;Could not match 'b' with 'b'.&quot; Further work is held off
  until when we have a concrete incentive to explore this dark corner.

More details:

 (1) We don't look under foralls, at all, in `checkTyEqRhs`.  There might be
     a cyclic occurrence underneath, in a case like
          [G] lhs ~ forall b. ... lhs ....
     but it doesn't matter because we will classify the constraint as Irred,
     so it will not be used for rewriting.

     Earlier versions required an extra, post-breaking, check.  Skipping this
     check causes typecheck/should_fail/GivenForallLoop and polykinds/T18451 to
     loop.  But now it is all simpler, with no need for a second check.

 (2) Historical Note: our goal here is to avoid loops in rewriting. We can thus
     skip looking in coercions, as we don't rewrite in coercions in the
     algorithm in GHC.Solver.Rewrite.  This doesn't seem relevant any more.
     We cycle break to make the constraint canonical.

 (3) As we cycle-break as described in this Note, we can build ill-kinded
     types. For example, if we have Proxy (F a) b, where (b :: F a), then
     replacing this with Proxy cbv b is ill-kinded. However, we will later
     set cbv := F a, and so the zonked type will be well-kinded again.
     The temporary ill-kinded type hurts no one, and avoiding this would
     be quite painfully difficult.

     Specifically, this detail does not contravene the Purely Kinded Type Invariant
     (Note [The Purely Kinded Type Invariant (PKTI)] in GHC.Tc.Gen.HsType).
     The PKTI says that we can call typeKind on any type, without failure.
     It would be violated if we, say, replaced a kind (a -&gt; b) with a kind c,
     because an arrow kind might be consulted in piResultTys. Here, we are
     replacing one opaque type like (F a b c) with another, cbv (opaque in
     that we never assume anything about its structure, like that it has a
     result type or a RuntimeRep argument).

 (4) The evidence for the produced Givens is all just reflexive, because we
     will eventually set the cycle-breaker variable to be the type family, and
     then, after the zonk, all will be well. See also the notes at the end of
     the Given section of this Note.

 (5) The implementation in `checkTyEqRhs` is efficient because it only replaces
     a type family application with a type variable, if that particular
     appplication is implicated in the occurs check.  For example:
         [W] alpha ~ Maybe (F alpha, G beta)
     We'll end up calling GHC.Tc.Utils.Unify.checkFamApp
       * On `F alpha`, which fail and calls the cycle-breaker in TEFA_Break
       * On `G beta`, which succeeds no problem.

     However, we make no attempt to detect cases like a ~ (F a, F a) and use the
     same tyvar to replace F a. The constraint solver will common them up later!
     (Cf. Note [Flattening type-family applications when matching instances] in
     GHC.Core.Unify, which goes to this extra effort.) However, this is really
     a very small corner case.  The investment to craft a clever, performant
     solution seems unworthwhile.

 (6) We often get the predicate associated with a constraint from its evidence
     with ctPred. We thus must not only make sure the generated CEqCan's fields
     have the updated RHS type (that is, the one produced by replacing type
     family applications with fresh variables), but we must also update the
     evidence itself. This is done by the call to rewriteEqEvidence in
     canEqCanLHSFinish.

 (7) We don't wish to apply this magic on the equalities created
     by this very same process. Consider this, from
     typecheck/should_compile/ContextStack2:

       type instance TF (a, b) = (TF a, TF b)
       t :: (a ~ TF (a, Int)) =&gt; ...

       [G] a ~ TF (a, Int)

     The RHS reduces, so we get

       [G] a ~ (TF a, TF Int)

     We then break cycles, to get

       [G] g1 :: a ~ (cbv1, cbv2)
       [G] g2 :: TF a ~ cbv1
       [G] g3 :: TF Int ~ cbv2

     g1 gets added to the inert set, as written. But then g2 becomes
     the work item. g1 rewrites g2 to become

       [G] TF (cbv1, cbv2) ~ cbv1

     which then uses the type instance to become

       [G] (TF cbv1, TF cbv2) ~ cbv1

     which looks remarkably like the Given we started with. If left unchecked,
     this will end up breaking cycles again, looping ad infinitum (and
     resulting in a context-stack reduction error, not an outright loop). The
     solution is easy: don't break cycles on an equality generated by breaking
     cycles. Instead, we mark this final Given as a CIrredCan with a
     NonCanonicalReason with the soluble occurs-check bit set (only).

     We track these equalities by giving them a special CtOrigin,
     CycleBreakerOrigin. This works for both Givens and Wanteds, as we need the
     logic in the W case for e.g. typecheck/should_fail/T17139.  Because this
     logic needs to work for Wanteds, too, we cannot simply look for a
     CycleBreakerTv on the left: Wanteds don't use them.


**********************************************************************
*                                                                    *
                   Rewriting evidence
*                                                                    *
**********************************************************************
-}</span><span>
</span><span id="line-2509"></span><span>
</span><span id="line-2510"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#rewriteEqEvidence"><span class="hs-identifier hs-type">rewriteEqEvidence</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#RewriterSet"><span class="hs-identifier hs-type">RewriterSet</span></a></span><span>        </span><span class="hs-comment">-- New rewriters</span><span>
</span><span id="line-2511"></span><span>                                        </span><span class="hs-comment">-- See GHC.Tc.Types.Constraint</span><span>
</span><span id="line-2512"></span><span>                                        </span><span class="hs-comment">-- Note [Wanteds rewrite Wanteds]</span><span>
</span><span id="line-2513"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span>         </span><span class="hs-comment">-- Old evidence :: olhs ~ orhs (not swapped)</span><span>
</span><span id="line-2514"></span><span>                                        </span><span class="hs-comment">--              or orhs ~ olhs (swapped)</span><span>
</span><span id="line-2515"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SwapFlag"><span class="hs-identifier hs-type">SwapFlag</span></a></span><span>
</span><span id="line-2516"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span>          </span><span class="hs-comment">-- lhs_co :: olhs ~ nlhs</span><span>
</span><span id="line-2517"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span>          </span><span class="hs-comment">-- rhs_co :: orhs ~ nrhs</span><span>
</span><span id="line-2518"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span>     </span><span class="hs-comment">-- Of type nlhs ~ nrhs</span><span>
</span><span id="line-2519"></span><span class="hs-comment">-- With reductions (Reduction lhs_co nlhs) (Reduction rhs_co nrhs),</span><span>
</span><span id="line-2520"></span><span class="hs-comment">-- rewriteEqEvidence yields, for a given equality (Given g olhs orhs):</span><span>
</span><span id="line-2521"></span><span class="hs-comment">-- If not swapped</span><span>
</span><span id="line-2522"></span><span class="hs-comment">--      g1 : nlhs ~ nrhs = sym lhs_co ; g ; rhs_co</span><span>
</span><span id="line-2523"></span><span class="hs-comment">-- If swapped</span><span>
</span><span id="line-2524"></span><span class="hs-comment">--      g1 : nlhs ~ nrhs = sym lhs_co ; Sym g ; rhs_co</span><span>
</span><span id="line-2525"></span><span class="hs-comment">--</span><span>
</span><span id="line-2526"></span><span class="hs-comment">-- For a wanted equality (Wanted w), we do the dual thing:</span><span>
</span><span id="line-2527"></span><span class="hs-comment">-- New  w1 : nlhs ~ nrhs</span><span>
</span><span id="line-2528"></span><span class="hs-comment">-- If not swapped</span><span>
</span><span id="line-2529"></span><span class="hs-comment">--      w : olhs ~ orhs = lhs_co ; w1 ; sym rhs_co</span><span>
</span><span id="line-2530"></span><span class="hs-comment">-- If swapped</span><span>
</span><span id="line-2531"></span><span class="hs-comment">--      w : orhs ~ olhs = rhs_co ; sym w1 ; sym lhs_co</span><span>
</span><span id="line-2532"></span><span class="hs-comment">--</span><span>
</span><span id="line-2533"></span><span class="hs-comment">-- It's all a form of rewriteEvidence, specialised for equalities</span><span>
</span><span id="line-2534"></span><span id="rewriteEqEvidence"><span class="annot"><span class="annottext">rewriteEqEvidence :: RewriterSet
-&gt; CtEvidence
-&gt; SwapFlag
-&gt; Reduction
-&gt; Reduction
-&gt; TcS CtEvidence
</span><a href="GHC.Tc.Solver.Equality.html#rewriteEqEvidence"><span class="hs-identifier hs-var hs-var">rewriteEqEvidence</span></a></span></span><span> </span><span id="local-6989586621683044113"><span class="annot"><span class="annottext">RewriterSet
</span><a href="#local-6989586621683044113"><span class="hs-identifier hs-var">new_rewriters</span></a></span></span><span> </span><span id="local-6989586621683044114"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044114"><span class="hs-identifier hs-var">old_ev</span></a></span></span><span> </span><span id="local-6989586621683044115"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683044115"><span class="hs-identifier hs-var">swapped</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span> </span><span id="local-6989586621683044116"><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683044116"><span class="hs-identifier hs-var">lhs_co</span></a></span></span><span> </span><span id="local-6989586621683044117"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044117"><span class="hs-identifier hs-var">nlhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span> </span><span id="local-6989586621683044118"><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683044118"><span class="hs-identifier hs-var">rhs_co</span></a></span></span><span> </span><span id="local-6989586621683044119"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044119"><span class="hs-identifier hs-var">nrhs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2535"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#NotSwapped"><span class="hs-identifier hs-var">NotSwapped</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683044115"><span class="hs-identifier hs-var">swapped</span></a></span><span>
</span><span id="line-2536"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcCoercion -&gt; Bool
</span><a href="GHC.Core.Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683044116"><span class="hs-identifier hs-var">lhs_co</span></a></span><span>      </span><span class="hs-comment">-- See Note [Rewriting with Refl]</span><span>
</span><span id="line-2537"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcCoercion -&gt; Bool
</span><a href="GHC.Core.Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683044118"><span class="hs-identifier hs-var">rhs_co</span></a></span><span>
</span><span id="line-2538"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; TcS CtEvidence
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CtEvidence -&gt; TcType -&gt; CtEvidence
CtEvidence -&gt; TcType -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#setCtEvPredType"><span class="hs-identifier hs-var">setCtEvPredType</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044114"><span class="hs-identifier hs-var">old_ev</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044121"><span class="hs-identifier hs-var">new_pred</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2539"></span><span>
</span><span id="line-2540"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtGiven"><span class="hs-identifier hs-type">CtGiven</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ctev_evar :: CtEvidence -&gt; TcTyVar
</span><a href="GHC.Tc.Types.Constraint.html#ctev_evar"><span class="hs-identifier hs-var">ctev_evar</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044122"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683044122"><span class="hs-identifier hs-var">old_evar</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044114"><span class="hs-identifier hs-var">old_ev</span></a></span><span>
</span><span id="line-2541"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683044123"><span class="annot"><span class="annottext">new_tm :: EvTerm
</span><a href="#local-6989586621683044123"><span class="hs-identifier hs-var hs-var">new_tm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcCoercion -&gt; EvTerm
</span><a href="GHC.Tc.Types.Evidence.html#evCoercion"><span class="hs-identifier hs-var">evCoercion</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">TcCoercion -&gt; TcCoercion
</span><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a></span><span> </span><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683044116"><span class="hs-identifier hs-var">lhs_co</span></a></span><span>
</span><span id="line-2542"></span><span>                                  </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; TcCoercion -&gt; TcCoercion -&gt; TcCoercion
TcCoercion -&gt; TcCoercion -&gt; TcCoercion
</span><a href="GHC.Core.Coercion.html#mkTransCo"><span class="hs-operator hs-var">`mkTransCo`</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag -&gt; TcCoercion -&gt; TcCoercion
</span><a href="GHC.Tc.Types.Evidence.html#maybeSymCo"><span class="hs-identifier hs-var">maybeSymCo</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683044115"><span class="hs-identifier hs-var">swapped</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; TcCoercion
</span><a href="GHC.Core.Coercion.html#mkCoVarCo"><span class="hs-identifier hs-var">mkCoVarCo</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683044122"><span class="hs-identifier hs-var">old_evar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2543"></span><span>                                  </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; TcCoercion -&gt; TcCoercion -&gt; TcCoercion
TcCoercion -&gt; TcCoercion -&gt; TcCoercion
</span><a href="GHC.Core.Coercion.html#mkTransCo"><span class="hs-operator hs-var">`mkTransCo`</span></a></span><span> </span><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683044118"><span class="hs-identifier hs-var">rhs_co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2544"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; (TcType, EvTerm) -&gt; TcS CtEvidence
</span><a href="GHC.Tc.Solver.Monad.html#newGivenEvVar"><span class="hs-identifier hs-var">newGivenEvVar</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683044126"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044121"><span class="hs-identifier hs-var">new_pred</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EvTerm
</span><a href="#local-6989586621683044123"><span class="hs-identifier hs-var">new_tm</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2545"></span><span>
</span><span id="line-2546"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtWanted"><span class="hs-identifier hs-type">CtWanted</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ctev_dest :: CtEvidence -&gt; TcEvDest
</span><a href="GHC.Tc.Types.Constraint.html#ctev_dest"><span class="hs-identifier hs-var">ctev_dest</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044127"><span class="annot"><span class="annottext">TcEvDest
</span><a href="#local-6989586621683044127"><span class="hs-identifier hs-var">dest</span></a></span></span><span>
</span><span id="line-2547"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ctev_rewriters :: CtEvidence -&gt; RewriterSet
</span><a href="GHC.Tc.Types.Constraint.html#ctev_rewriters"><span class="hs-identifier hs-var">ctev_rewriters</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044129"><span class="annot"><span class="annottext">RewriterSet
</span><a href="#local-6989586621683044129"><span class="hs-identifier hs-var">rewriters</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044114"><span class="hs-identifier hs-var">old_ev</span></a></span><span>
</span><span id="line-2548"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683044130"><span class="annot"><span class="annottext">rewriters' :: RewriterSet
</span><a href="#local-6989586621683044130"><span class="hs-identifier hs-var hs-var">rewriters'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RewriterSet
</span><a href="#local-6989586621683044129"><span class="hs-identifier hs-var">rewriters</span></a></span><span> </span><span class="annot"><span class="annottext">RewriterSet -&gt; RewriterSet -&gt; RewriterSet
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">S.&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">RewriterSet
</span><a href="#local-6989586621683044113"><span class="hs-identifier hs-var">new_rewriters</span></a></span><span>
</span><span id="line-2549"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683044131"><span class="annot"><a href="#local-6989586621683044131"><span class="hs-identifier hs-var">new_ev</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683044132"><span class="annot"><a href="#local-6989586621683044132"><span class="hs-identifier hs-var">hole_co</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtLoc
-&gt; RewriterSet
-&gt; Role
-&gt; TcType
-&gt; TcType
-&gt; TcS (CtEvidence, TcCoercion)
</span><a href="GHC.Tc.Solver.Monad.html#newWantedEq"><span class="hs-identifier hs-var">newWantedEq</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683044126"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">RewriterSet
</span><a href="#local-6989586621683044130"><span class="hs-identifier hs-var">rewriters'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CtEvidence -&gt; Role
CtEvidence -&gt; Role
</span><a href="GHC.Tc.Types.Constraint.html#ctEvRewriteRole"><span class="hs-identifier hs-var">ctEvRewriteRole</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044114"><span class="hs-identifier hs-var">old_ev</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044117"><span class="hs-identifier hs-var">nlhs</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044119"><span class="hs-identifier hs-var">nrhs</span></a></span><span>
</span><span id="line-2550"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683044135"><span class="annot"><a href="#local-6989586621683044135"><span class="hs-identifier hs-var hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SwapFlag -&gt; TcCoercion -&gt; TcCoercion
</span><a href="GHC.Tc.Types.Evidence.html#maybeSymCo"><span class="hs-identifier hs-var">maybeSymCo</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683044115"><span class="hs-identifier hs-var">swapped</span></a></span><span> </span><span class="annot"><span class="annottext">(TcCoercion -&gt; TcCoercion) -&gt; TcCoercion -&gt; TcCoercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2551"></span><span>                  </span><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683044116"><span class="hs-identifier hs-var">lhs_co</span></a></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; TcCoercion -&gt; TcCoercion -&gt; TcCoercion
TcCoercion -&gt; TcCoercion -&gt; TcCoercion
</span><a href="GHC.Core.Coercion.html#mkTransCo"><span class="hs-operator hs-var">`mkTransCo`</span></a></span><span> </span><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683044132"><span class="hs-identifier hs-var">hole_co</span></a></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; TcCoercion -&gt; TcCoercion -&gt; TcCoercion
TcCoercion -&gt; TcCoercion -&gt; TcCoercion
</span><a href="GHC.Core.Coercion.html#mkTransCo"><span class="hs-operator hs-var">`mkTransCo`</span></a></span><span> </span><span class="annot"><span class="annottext">TcCoercion -&gt; TcCoercion
</span><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a></span><span> </span><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683044118"><span class="hs-identifier hs-var">rhs_co</span></a></span><span>
</span><span id="line-2552"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#setWantedEq"><span class="hs-identifier hs-type">setWantedEq</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044127"><span class="hs-identifier hs-type">dest</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044135"><span class="hs-identifier hs-type">co</span></a></span><span>
</span><span id="line-2553"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-type">traceTcS</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;rewriteEqEvidence&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-type">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044114"><span class="hs-identifier hs-type">old_ev</span></a></span><span>
</span><span id="line-2554"></span><span>                                            </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044117"><span class="hs-identifier hs-type">nlhs</span></a></span><span>
</span><span id="line-2555"></span><span>                                            </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044119"><span class="hs-identifier hs-type">nrhs</span></a></span><span>
</span><span id="line-2556"></span><span>                                            </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044135"><span class="hs-identifier hs-type">co</span></a></span><span>
</span><span id="line-2557"></span><span>                                            </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044113"><span class="hs-identifier hs-type">new_rewriters</span></a></span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2558"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683044131"><span class="hs-identifier hs-type">new_ev</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2559"></span><span>
</span><span id="line-2560"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2561"></span><span>    </span><span id="local-6989586621683044121"><span class="annot"><span class="annottext">new_pred :: TcType
</span><a href="#local-6989586621683044121"><span class="hs-identifier hs-var hs-var">new_pred</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; TcType -&gt; TcType -&gt; TcType
</span><a href="GHC.Tc.Types.Constraint.html#mkTcEqPredLikeEv"><span class="hs-identifier hs-var">mkTcEqPredLikeEv</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044114"><span class="hs-identifier hs-var">old_ev</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044117"><span class="hs-identifier hs-var">nlhs</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044119"><span class="hs-identifier hs-var">nrhs</span></a></span><span>
</span><span id="line-2562"></span><span>    </span><span id="local-6989586621683044126"><span class="annot"><span class="annottext">loc :: CtLoc
</span><a href="#local-6989586621683044126"><span class="hs-identifier hs-var hs-var">loc</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044114"><span class="hs-identifier hs-var">old_ev</span></a></span><span>
</span><span id="line-2563"></span><span>
</span><span id="line-2564"></span><span class="hs-comment">{-
**********************************************************************
*                                                                    *
                   tryInertEqs
*                                                                    *
**********************************************************************

Note [Combining equalities]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have
   Inert:     g1 :: a ~ t
   Work item: g2 :: a ~ t

Then we can simply solve g2 from g1, thus g2 := g1.  Easy!
But it's not so simple:

* If t is a type variable, the equalties might be oriented differently:
      e.g. (g1 :: a~b) and (g2 :: b~a)
  So we look both ways round.  Hence the SwapFlag result to
  inertsCanDischarge.

* We can only do g2 := g1 if g1 can discharge g2; that depends on
  (a) the role and (b) the flavour.  E.g. a representational equality
  cannot discharge a nominal one; a Wanted cannot discharge a Given.
  The predicate is eqCanRewriteFR.

* Visibility. Suppose  S :: forall k. k -&gt; Type, and consider unifying
      S @Type (a::Type)  ~   S @(Type-&gt;Type) (b::Type-&gt;Type)
  From the first argument we get (Type ~ Type-&gt;Type); from the second
  argument we get (a ~ b) which in turn gives (Type ~ Type-&gt;Type).
  See typecheck/should_fail/T16204c.

  That first argument is invisible in the source program (aside from
  visible type application), so we'd much prefer to get the error from
  the second. We track visibility in the uo_visible field of a TypeEqOrigin.
  We use this to prioritise visible errors (see GHC.Tc.Errors.tryReporters,
  the partition on isVisibleOrigin).

  So when combining two otherwise-identical equalites, we want to
  keep the visible one, and discharge the invisible one.  Hence the
  call to strictly_more_visible.
-}</span><span>
</span><span id="line-2606"></span><span>
</span><span id="line-2607"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#tryInertEqs"><span class="hs-identifier hs-type">tryInertEqs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#SolverStage"><span class="hs-identifier hs-type">SolverStage</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2608"></span><span id="tryInertEqs"><span class="annot"><span class="annottext">tryInertEqs :: EqCt -&gt; SolverStage ()
</span><a href="GHC.Tc.Solver.Equality.html#tryInertEqs"><span class="hs-identifier hs-var hs-var">tryInertEqs</span></a></span></span><span> </span><span id="local-6989586621683044136"><span class="annot"><span class="annottext">work_item :: EqCt
</span><a href="#local-6989586621683044136"><span class="hs-identifier hs-var">work_item</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">eq_ev :: EqCt -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#eq_ev"><span class="hs-identifier hs-var">eq_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044137"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044137"><span class="hs-identifier hs-var">ev</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">eq_eq_rel :: EqCt -&gt; EqRel
</span><a href="GHC.Tc.Types.Constraint.html#eq_eq_rel"><span class="hs-identifier hs-var">eq_eq_rel</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044138"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044138"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2609"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcS (StopOrContinue ()) -&gt; SolverStage ()
forall a. TcS (StopOrContinue a) -&gt; SolverStage a
</span><a href="GHC.Tc.Solver.Monad.html#Stage"><span class="hs-identifier hs-var">Stage</span></a></span><span> </span><span class="annot"><span class="annottext">(TcS (StopOrContinue ()) -&gt; SolverStage ())
-&gt; TcS (StopOrContinue ()) -&gt; SolverStage ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2610"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683044139"><span class="annot"><a href="#local-6989586621683044139"><span class="hs-identifier hs-var">inerts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS InertCans
</span><a href="GHC.Tc.Solver.Monad.html#getInertCans"><span class="hs-identifier hs-var">getInertCans</span></a></span><span>
</span><span id="line-2611"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683044141"><span class="annot"><a href="#local-6989586621683044141"><span class="hs-identifier hs-var">ev_i</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683044142"><span class="annot"><a href="#local-6989586621683044142"><span class="hs-identifier hs-var">swapped</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#inertsCanDischarge"><span class="hs-identifier hs-type">inertsCanDischarge</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044139"><span class="hs-identifier hs-type">inerts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044136"><span class="hs-identifier hs-type">work_item</span></a></span><span>
</span><span id="line-2612"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#setEvBindIfWanted"><span class="hs-identifier hs-type">setEvBindIfWanted</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044137"><span class="hs-identifier hs-type">ev</span></a></span><span> </span><span class="annot"><a href="GHC.Core.InstEnv.html#EvCanonical"><span class="hs-identifier hs-type">EvCanonical</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-2613"></span><span>                    </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#evCoercion"><span class="hs-identifier hs-type">evCoercion</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#maybeSymCo"><span class="hs-identifier hs-type">maybeSymCo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044142"><span class="hs-identifier hs-type">swapped</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-2614"></span><span>                                </span><span class="annot"><a href="GHC.Core.Coercion.html#downgradeRole"><span class="hs-identifier hs-type">downgradeRole</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Predicate.html#eqRelRole"><span class="hs-identifier hs-type">eqRelRole</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044138"><span class="hs-identifier hs-type">eq_rel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2615"></span><span>                                              </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ctEvRewriteRole"><span class="hs-identifier hs-type">ctEvRewriteRole</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044141"><span class="hs-identifier hs-type">ev_i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2616"></span><span>                                              </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ctEvCoercion"><span class="hs-identifier hs-type">ctEvCoercion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044141"><span class="hs-identifier hs-type">ev_i</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2617"></span><span>                  </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#stopWith"><span class="hs-identifier hs-type">stopWith</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044137"><span class="hs-identifier hs-type">ev</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Solved from inert&quot;</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2618"></span><span>
</span><span id="line-2619"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">otherwise</span></span><span>
</span><span id="line-2620"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#continueWith"><span class="hs-identifier hs-type">continueWith</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2621"></span><span>
</span><span id="line-2622"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#inertsCanDischarge"><span class="hs-identifier hs-type">inertsCanDischarge</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.InertSet.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span>
</span><span id="line-2623"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span>  </span><span class="hs-comment">-- The evidence for the inert</span><span>
</span><span id="line-2624"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SwapFlag"><span class="hs-identifier hs-type">SwapFlag</span></a></span><span> </span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Whether we need mkSymCo</span><span>
</span><span id="line-2625"></span><span id="inertsCanDischarge"><span class="annot"><span class="annottext">inertsCanDischarge :: InertCans -&gt; EqCt -&gt; Maybe (CtEvidence, SwapFlag)
</span><a href="GHC.Tc.Solver.Equality.html#inertsCanDischarge"><span class="hs-identifier hs-var hs-var">inertsCanDischarge</span></a></span></span><span> </span><span id="local-6989586621683044145"><span class="annot"><span class="annottext">InertCans
</span><a href="#local-6989586621683044145"><span class="hs-identifier hs-var">inerts</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">eq_lhs :: EqCt -&gt; CanEqLHS
</span><a href="GHC.Tc.Types.Constraint.html#eq_lhs"><span class="hs-identifier hs-var">eq_lhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044146"><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683044146"><span class="hs-identifier hs-var">lhs_w</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">eq_rhs :: EqCt -&gt; TcType
</span><a href="GHC.Tc.Types.Constraint.html#eq_rhs"><span class="hs-identifier hs-var">eq_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044147"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044147"><span class="hs-identifier hs-var">rhs_w</span></a></span></span><span>
</span><span id="line-2626"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">eq_ev :: EqCt -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#eq_ev"><span class="hs-identifier hs-var">eq_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044148"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044148"><span class="hs-identifier hs-var">ev_w</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">eq_eq_rel :: EqCt -&gt; EqRel
</span><a href="GHC.Tc.Types.Constraint.html#eq_eq_rel"><span class="hs-identifier hs-var">eq_eq_rel</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044149"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044149"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2627"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683044150"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044150"><span class="hs-identifier hs-var">ev_i</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[CtEvidence]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044151"><span class="hs-identifier hs-var">ev_i</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">eq_ev :: EqCt -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#eq_ev"><span class="hs-identifier hs-var">eq_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044151"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044151"><span class="hs-identifier hs-var">ev_i</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">eq_rhs :: EqCt -&gt; TcType
</span><a href="GHC.Tc.Types.Constraint.html#eq_rhs"><span class="hs-identifier hs-var">eq_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044152"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044152"><span class="hs-identifier hs-var">rhs_i</span></a></span></span><span>
</span><span id="line-2628"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">eq_eq_rel :: EqCt -&gt; EqRel
</span><a href="GHC.Tc.Types.Constraint.html#eq_eq_rel"><span class="hs-identifier hs-var">eq_eq_rel</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044153"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044153"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2629"></span><span>                                  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InertCans -&gt; CanEqLHS -&gt; [EqCt]
</span><a href="GHC.Tc.Solver.InertSet.html#findEq"><span class="hs-identifier hs-var">findEq</span></a></span><span> </span><span class="annot"><span class="annottext">InertCans
</span><a href="#local-6989586621683044145"><span class="hs-identifier hs-var">inerts</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683044146"><span class="hs-identifier hs-var">lhs_w</span></a></span><span>
</span><span id="line-2630"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044152"><span class="hs-identifier hs-var">rhs_i</span></a></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; TcType -&gt; TcType -&gt; Bool
TcType -&gt; TcType -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#tcEqType"><span class="hs-operator hs-var">`tcEqType`</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044147"><span class="hs-identifier hs-var">rhs_w</span></a></span><span>
</span><span id="line-2631"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; EqRel -&gt; Bool
</span><a href="#local-6989586621683044155"><span class="hs-identifier hs-var">inert_beats_wanted</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044151"><span class="hs-identifier hs-var">ev_i</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044153"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-2632"></span><span>  </span><span class="hs-glyph">=</span><span>  </span><span class="hs-comment">-- Inert:     a ~ ty</span><span>
</span><span id="line-2633"></span><span>     </span><span class="hs-comment">-- Work item: a ~ ty</span><span>
</span><span id="line-2634"></span><span>    </span><span class="annot"><span class="annottext">(CtEvidence, SwapFlag) -&gt; Maybe (CtEvidence, SwapFlag)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044150"><span class="hs-identifier hs-var">ev_i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#NotSwapped"><span class="hs-identifier hs-var">NotSwapped</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2635"></span><span>
</span><span id="line-2636"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683044156"><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683044156"><span class="hs-identifier hs-var">rhs_lhs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe CanEqLHS
</span><a href="GHC.Tc.Types.Constraint.html#canEqLHS_maybe"><span class="hs-identifier hs-var">canEqLHS_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044147"><span class="hs-identifier hs-var">rhs_w</span></a></span><span>
</span><span id="line-2637"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683044157"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044157"><span class="hs-identifier hs-var">ev_i</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[CtEvidence]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044158"><span class="hs-identifier hs-var">ev_i</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">eq_ev :: EqCt -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#eq_ev"><span class="hs-identifier hs-var">eq_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044158"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044158"><span class="hs-identifier hs-var">ev_i</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">eq_rhs :: EqCt -&gt; TcType
</span><a href="GHC.Tc.Types.Constraint.html#eq_rhs"><span class="hs-identifier hs-var">eq_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044159"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044159"><span class="hs-identifier hs-var">rhs_i</span></a></span></span><span>
</span><span id="line-2638"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">eq_eq_rel :: EqCt -&gt; EqRel
</span><a href="GHC.Tc.Types.Constraint.html#eq_eq_rel"><span class="hs-identifier hs-var">eq_eq_rel</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044160"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044160"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2639"></span><span>                             </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InertCans -&gt; CanEqLHS -&gt; [EqCt]
</span><a href="GHC.Tc.Solver.InertSet.html#findEq"><span class="hs-identifier hs-var">findEq</span></a></span><span> </span><span class="annot"><span class="annottext">InertCans
</span><a href="#local-6989586621683044145"><span class="hs-identifier hs-var">inerts</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683044156"><span class="hs-identifier hs-var">rhs_lhs</span></a></span><span>
</span><span id="line-2640"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044159"><span class="hs-identifier hs-var">rhs_i</span></a></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; TcType -&gt; TcType -&gt; Bool
TcType -&gt; TcType -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#tcEqType"><span class="hs-operator hs-var">`tcEqType`</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS -&gt; TcType
</span><a href="GHC.Tc.Types.Constraint.html#canEqLHSType"><span class="hs-identifier hs-var">canEqLHSType</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683044146"><span class="hs-identifier hs-var">lhs_w</span></a></span><span>
</span><span id="line-2641"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; EqRel -&gt; Bool
</span><a href="#local-6989586621683044155"><span class="hs-identifier hs-var">inert_beats_wanted</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044158"><span class="hs-identifier hs-var">ev_i</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044160"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-2642"></span><span>  </span><span class="hs-glyph">=</span><span>  </span><span class="hs-comment">-- Inert:     a ~ b</span><span>
</span><span id="line-2643"></span><span>     </span><span class="hs-comment">-- Work item: b ~ a</span><span>
</span><span id="line-2644"></span><span>     </span><span class="annot"><span class="annottext">(CtEvidence, SwapFlag) -&gt; Maybe (CtEvidence, SwapFlag)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044157"><span class="hs-identifier hs-var">ev_i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#IsSwapped"><span class="hs-identifier hs-var">IsSwapped</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2645"></span><span>
</span><span id="line-2646"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2647"></span><span>    </span><span id="local-6989586621683044161"><span class="annot"><span class="annottext">loc_w :: CtLoc
</span><a href="#local-6989586621683044161"><span class="hs-identifier hs-var hs-var">loc_w</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044148"><span class="hs-identifier hs-var">ev_w</span></a></span><span>
</span><span id="line-2648"></span><span>    </span><span id="local-6989586621683044162"><span class="annot"><span class="annottext">flav_w :: CtFlavour
</span><a href="#local-6989586621683044162"><span class="hs-identifier hs-var hs-var">flav_w</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CtFlavour
</span><a href="GHC.Tc.Types.Constraint.html#ctEvFlavour"><span class="hs-identifier hs-var">ctEvFlavour</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044148"><span class="hs-identifier hs-var">ev_w</span></a></span><span>
</span><span id="line-2649"></span><span>    </span><span id="local-6989586621683044163"><span class="annot"><span class="annottext">fr_w :: CtFlavourRole
</span><a href="#local-6989586621683044163"><span class="hs-identifier hs-var hs-var">fr_w</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtFlavour
</span><a href="#local-6989586621683044162"><span class="hs-identifier hs-var">flav_w</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044149"><span class="hs-identifier hs-var">eq_rel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2650"></span><span>
</span><span id="line-2651"></span><span>    </span><span id="local-6989586621683044155"><span class="annot"><span class="annottext">inert_beats_wanted :: CtEvidence -&gt; EqRel -&gt; Bool
</span><a href="#local-6989586621683044155"><span class="hs-identifier hs-var hs-var">inert_beats_wanted</span></a></span></span><span> </span><span id="local-6989586621683044164"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044164"><span class="hs-identifier hs-var">ev_i</span></a></span></span><span> </span><span id="local-6989586621683044165"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044165"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span>
</span><span id="line-2652"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- eqCanRewriteFR:        see second bullet of Note [Combining equalities]</span><span>
</span><span id="line-2653"></span><span>        </span><span class="hs-comment">-- strictly_more_visible: see last bullet of Note [Combining equalities]</span><span>
</span><span id="line-2654"></span><span>        </span><span class="annot"><span class="annottext">CtFlavourRole
</span><a href="#local-6989586621683044166"><span class="hs-identifier hs-var">fr_i</span></a></span><span> </span><span class="annot"><span class="annottext">CtFlavourRole -&gt; CtFlavourRole -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#eqCanRewriteFR"><span class="hs-operator hs-var">`eqCanRewriteFR`</span></a></span><span> </span><span class="annot"><span class="annottext">CtFlavourRole
</span><a href="#local-6989586621683044163"><span class="hs-identifier hs-var">fr_w</span></a></span><span>
</span><span id="line-2655"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683044161"><span class="hs-identifier hs-var">loc_w</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; CtLoc -&gt; Bool
</span><a href="#local-6989586621683044168"><span class="hs-operator hs-var">`strictly_more_visible`</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044164"><span class="hs-identifier hs-var">ev_i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2656"></span><span>                 </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtFlavourRole
</span><a href="#local-6989586621683044163"><span class="hs-identifier hs-var">fr_w</span></a></span><span> </span><span class="annot"><span class="annottext">CtFlavourRole -&gt; CtFlavourRole -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#eqCanRewriteFR"><span class="hs-operator hs-var">`eqCanRewriteFR`</span></a></span><span> </span><span class="annot"><span class="annottext">CtFlavourRole
</span><a href="#local-6989586621683044166"><span class="hs-identifier hs-var">fr_i</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2657"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-2658"></span><span>        </span><span id="local-6989586621683044166"><span class="annot"><span class="annottext">fr_i :: CtFlavourRole
</span><a href="#local-6989586621683044166"><span class="hs-identifier hs-var hs-var">fr_i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; CtFlavour
</span><a href="GHC.Tc.Types.Constraint.html#ctEvFlavour"><span class="hs-identifier hs-var">ctEvFlavour</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044164"><span class="hs-identifier hs-var">ev_i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044165"><span class="hs-identifier hs-var">eq_rel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2659"></span><span>
</span><span id="line-2660"></span><span>    </span><span class="hs-comment">-- See Note [Combining equalities], final bullet</span><span>
</span><span id="line-2661"></span><span>    </span><span id="local-6989586621683044168"><span class="annot"><span class="annottext">strictly_more_visible :: CtLoc -&gt; CtLoc -&gt; Bool
</span><a href="#local-6989586621683044168"><span class="hs-identifier hs-var hs-var">strictly_more_visible</span></a></span></span><span> </span><span id="local-6989586621683044169"><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683044169"><span class="hs-identifier hs-var">loc1</span></a></span></span><span> </span><span id="local-6989586621683044170"><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683044170"><span class="hs-identifier hs-var">loc2</span></a></span></span><span>
</span><span id="line-2662"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtOrigin -&gt; Bool
</span><a href="GHC.Tc.Types.Origin.html#isVisibleOrigin"><span class="hs-identifier hs-var">isVisibleOrigin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtLoc -&gt; CtOrigin
</span><a href="GHC.Tc.Types.CtLoc.html#ctLocOrigin"><span class="hs-identifier hs-var">ctLocOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683044170"><span class="hs-identifier hs-var">loc2</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span>
</span><span id="line-2663"></span><span>         </span><span class="annot"><span class="annottext">CtOrigin -&gt; Bool
</span><a href="GHC.Tc.Types.Origin.html#isVisibleOrigin"><span class="hs-identifier hs-var">isVisibleOrigin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtLoc -&gt; CtOrigin
</span><a href="GHC.Tc.Types.CtLoc.html#ctLocOrigin"><span class="hs-identifier hs-var">ctLocOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683044169"><span class="hs-identifier hs-var">loc1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2664"></span><span>
</span><span id="line-2665"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#inertsCanDischarge"><span class="hs-identifier hs-var">inertsCanDischarge</span></a></span><span> </span><span class="annot"><span class="annottext">InertCans
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">EqCt
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (CtEvidence, SwapFlag)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-2666"></span><span>
</span><span id="line-2667"></span><span>
</span><span id="line-2668"></span><span>
</span><span id="line-2669"></span><span class="hs-comment">{- Note [Do not unify Givens]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this GADT match
   data T a where
      T1 :: T Int
      ...

   f x = case x of
           T1 -&gt; True
           ...

So we get f :: T alpha[1] -&gt; beta[1]
          x :: T alpha[1]
and from the T1 branch we get the implication
   forall[2] (alpha[1] ~ Int) =&gt; beta[1] ~ Bool

Now, clearly we don't want to unify alpha:=Int!  Yet at the moment we
process [G] alpha[1] ~ Int, we don't have any given-equalities in the
inert set, and hence there are no given equalities to make alpha untouchable.

NB: if it were alpha[2] ~ Int, this argument wouldn't hold.  But that
never happens: invariant (GivenInv) in Note [TcLevel invariants]
in GHC.Tc.Utils.TcType.

Simple solution: never unify in Givens!

Note [Do not unify representational equalities]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider   [W] alpha ~R# b
where alpha is touchable. Should we unify alpha := b?

Certainly not!  Unifying forces alpha and be to be the same; but they
only need to be representationally equal types.

For example, we might have another constraint [W] alpha ~# N b
where
  newtype N b = MkN b
and we want to get alpha := N b.

See also #15144, which was caused by unifying a representational
equality.

Note [Solve by unification]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we solve
   alpha[n] ~ ty
by unification, there are two cases to consider

* TouchableSameLevel: if the ambient level is 'n', then
  we can simply update alpha := ty, and do nothing else

* TouchableOuterLevel free_metas n: if the ambient level is greater than
  'n' (the level of alpha), in addition to setting alpha := ty we must
  do two other things:

  1. Promote all the free meta-vars of 'ty' to level n.  After all,
     alpha[n] is at level n, and so if we set, say,
          alpha[n] := Maybe beta[m],
     we must ensure that when unifying beta we do skolem-escape checks
     etc relevant to level n.  Simple way to do that: promote beta to
     level n.

  2. Set the Unification Level Flag to record that a level-n unification has
     taken place. See Note [The Unification Level Flag] in GHC.Tc.Solver.Monad

NB: TouchableSameLevel is just an optimisation for TouchableOuterLevel. Promotion
would be a no-op, and setting the unification flag unnecessarily would just
make the solver iterate more often.  (We don't need to iterate when unifying
at the ambient level because of the kick-out mechanism.)
-}</span><span>
</span><span id="line-2739"></span><span>
</span><span id="line-2740"></span><span>
</span><span id="line-2741"></span><span class="annot"><span class="hs-comment">{-********************************************************************
*                                                                    *
          Final wrap-up for equalities
*                                                                    *
********************************************************************-}</span></span><span>
</span><span id="line-2746"></span><span>
</span><span id="line-2747"></span><span class="hs-comment">{- Note [Looking up primitive equalities in quantified constraints]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For equalities (a ~# b) look up (a ~ b), and then do a superclass
selection. This avoids having to support quantified constraints whose
kind is not Constraint, such as (forall a. F a ~# b)

See
 * Note [Evidence for quantified constraints] in GHC.Core.Predicate
 * Note [Equality superclasses in quantified constraints]
   in GHC.Tc.Solver.Dict
-}</span><span>
</span><span id="line-2758"></span><span>
</span><span id="line-2759"></span><span class="hs-comment">--------------------</span><span>
</span><span id="line-2760"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#tryQCsIrredEqCt"><span class="hs-identifier hs-type">tryQCsIrredEqCt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#IrredCt"><span class="hs-identifier hs-type">IrredCt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#SolverStage"><span class="hs-identifier hs-type">SolverStage</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2761"></span><span id="tryQCsIrredEqCt"><span class="annot"><span class="annottext">tryQCsIrredEqCt :: IrredCt -&gt; SolverStage ()
</span><a href="GHC.Tc.Solver.Equality.html#tryQCsIrredEqCt"><span class="hs-identifier hs-var hs-var">tryQCsIrredEqCt</span></a></span></span><span> </span><span id="local-6989586621683044173"><span class="annot"><span class="annottext">irred :: IrredCt
</span><a href="#local-6989586621683044173"><span class="hs-identifier hs-var">irred</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#IrredCt"><span class="hs-identifier hs-type">IrredCt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ir_ev :: IrredCt -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#ir_ev"><span class="hs-identifier hs-var">ir_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044174"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044174"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2762"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#EqPred"><span class="hs-identifier hs-type">EqPred</span></a></span><span> </span><span id="local-6989586621683044176"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044176"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span id="local-6989586621683044177"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044177"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621683044178"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044178"><span class="hs-identifier hs-var">t2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Pred
</span><a href="GHC.Core.Predicate.html#classifyPredType"><span class="hs-identifier hs-var">classifyPredType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; TcType
</span><a href="GHC.Tc.Types.Constraint.html#ctEvPred"><span class="hs-identifier hs-var">ctEvPred</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044174"><span class="hs-identifier hs-var">ev</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2763"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; EqRel -&gt; TcType -&gt; TcType -&gt; SolverStage ()
</span><a href="GHC.Tc.Solver.Equality.html#lookup_eq_in_qcis"><span class="hs-identifier hs-var">lookup_eq_in_qcis</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IrredCt -&gt; Ct
</span><a href="GHC.Tc.Types.Constraint.html#CIrredCan"><span class="hs-identifier hs-var">CIrredCan</span></a></span><span> </span><span class="annot"><span class="annottext">IrredCt
</span><a href="#local-6989586621683044173"><span class="hs-identifier hs-var">irred</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044176"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044177"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044178"><span class="hs-identifier hs-var">t2</span></a></span><span>
</span><span id="line-2764"></span><span>
</span><span id="line-2765"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>  </span><span class="hs-comment">-- All the calls come from in this module, where we deal only with</span><span>
</span><span id="line-2766"></span><span>               </span><span class="hs-comment">-- equalities, so ctEvPred ev) must be an equality. Indeed, we could</span><span>
</span><span id="line-2767"></span><span>               </span><span class="hs-comment">-- pass eq_rel, t1, t2 as arguments, to avoid this can't-happen case,</span><span>
</span><span id="line-2768"></span><span>               </span><span class="hs-comment">-- but it's not a hot path, and this is simple and robust</span><span>
</span><span id="line-2769"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; SolverStage ()
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;solveIrredEquality&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044174"><span class="hs-identifier hs-var">ev</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2770"></span><span>
</span><span id="line-2771"></span><span class="hs-comment">--------------------</span><span>
</span><span id="line-2772"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#tryQCsEqCt"><span class="hs-identifier hs-type">tryQCsEqCt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#SolverStage"><span class="hs-identifier hs-type">SolverStage</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2773"></span><span id="tryQCsEqCt"><span class="annot"><span class="annottext">tryQCsEqCt :: EqCt -&gt; SolverStage ()
</span><a href="GHC.Tc.Solver.Equality.html#tryQCsEqCt"><span class="hs-identifier hs-var hs-var">tryQCsEqCt</span></a></span></span><span> </span><span id="local-6989586621683044184"><span class="annot"><span class="annottext">work_item :: EqCt
</span><a href="#local-6989586621683044184"><span class="hs-identifier hs-var">work_item</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">eq_lhs :: EqCt -&gt; CanEqLHS
</span><a href="GHC.Tc.Types.Constraint.html#eq_lhs"><span class="hs-identifier hs-var">eq_lhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044185"><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683044185"><span class="hs-identifier hs-var">lhs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">eq_rhs :: EqCt -&gt; TcType
</span><a href="GHC.Tc.Types.Constraint.html#eq_rhs"><span class="hs-identifier hs-var">eq_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044186"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044186"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">eq_eq_rel :: EqCt -&gt; EqRel
</span><a href="GHC.Tc.Types.Constraint.html#eq_eq_rel"><span class="hs-identifier hs-var">eq_eq_rel</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044187"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044187"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2774"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; EqRel -&gt; TcType -&gt; TcType -&gt; SolverStage ()
</span><a href="GHC.Tc.Solver.Equality.html#lookup_eq_in_qcis"><span class="hs-identifier hs-var">lookup_eq_in_qcis</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EqCt -&gt; Ct
</span><a href="GHC.Tc.Types.Constraint.html#CEqCan"><span class="hs-identifier hs-var">CEqCan</span></a></span><span> </span><span class="annot"><span class="annottext">EqCt
</span><a href="#local-6989586621683044184"><span class="hs-identifier hs-var">work_item</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044187"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanEqLHS -&gt; TcType
</span><a href="GHC.Tc.Types.Constraint.html#canEqLHSType"><span class="hs-identifier hs-var">canEqLHSType</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683044185"><span class="hs-identifier hs-var">lhs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044186"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-2775"></span><span>
</span><span id="line-2776"></span><span class="hs-comment">--------------------</span><span>
</span><span id="line-2777"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#lookup_eq_in_qcis"><span class="hs-identifier hs-type">lookup_eq_in_qcis</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#EqRel"><span class="hs-identifier hs-type">EqRel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#SolverStage"><span class="hs-identifier hs-type">SolverStage</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2778"></span><span class="hs-comment">-- The &quot;final QCI check&quot; checks to see if we have</span><span>
</span><span id="line-2779"></span><span class="hs-comment">--    [W] t1 ~# t2</span><span>
</span><span id="line-2780"></span><span class="hs-comment">-- and a Given quantified contraint like (forall a b. blah =&gt; a ~ b)</span><span>
</span><span id="line-2781"></span><span class="hs-comment">-- Why?  See Note [Looking up primitive equalities in quantified constraints]</span><span>
</span><span id="line-2782"></span><span class="hs-comment">-- See also GHC.Tc.Solver.Dict</span><span>
</span><span id="line-2783"></span><span class="hs-comment">-- Note [Equality superclasses in quantified constraints]</span><span>
</span><span id="line-2784"></span><span id="lookup_eq_in_qcis"><span class="annot"><span class="annottext">lookup_eq_in_qcis :: Ct -&gt; EqRel -&gt; TcType -&gt; TcType -&gt; SolverStage ()
</span><a href="GHC.Tc.Solver.Equality.html#lookup_eq_in_qcis"><span class="hs-identifier hs-var hs-var">lookup_eq_in_qcis</span></a></span></span><span> </span><span id="local-6989586621683044189"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683044189"><span class="hs-identifier hs-var">work_ct</span></a></span></span><span> </span><span id="local-6989586621683044190"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044190"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span id="local-6989586621683044191"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044191"><span class="hs-identifier hs-var">lhs</span></a></span></span><span> </span><span id="local-6989586621683044192"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044192"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-2785"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcS (StopOrContinue ()) -&gt; SolverStage ()
forall a. TcS (StopOrContinue a) -&gt; SolverStage a
</span><a href="GHC.Tc.Solver.Monad.html#Stage"><span class="hs-identifier hs-var">Stage</span></a></span><span> </span><span class="annot"><span class="annottext">(TcS (StopOrContinue ()) -&gt; SolverStage ())
-&gt; TcS (StopOrContinue ()) -&gt; SolverStage ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2786"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683044193"><span class="annot"><a href="#local-6989586621683044193"><span class="hs-identifier hs-var">ev_binds_var</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS EvBindsVar
</span><a href="GHC.Tc.Solver.Monad.html#getTcEvBindsVar"><span class="hs-identifier hs-var">getTcEvBindsVar</span></a></span><span>
</span><span id="line-2787"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683044195"><span class="annot"><a href="#local-6989586621683044195"><span class="hs-identifier hs-var">ics</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#getInertCans"><span class="hs-identifier hs-type">getInertCans</span></a></span><span>
</span><span id="line-2788"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#isWanted"><span class="hs-identifier hs-type">isWanted</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044196"><span class="hs-identifier hs-type">ev</span></a></span><span>                       </span><span class="hs-comment">-- Never look up Givens in quantified constraints</span><span>
</span><span id="line-2789"></span><span>         </span><span class="annot"><span class="hs-operator hs-type">&amp;&amp;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">null</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.InertSet.html#inert_insts"><span class="hs-identifier hs-var">inert_insts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044195"><span class="hs-identifier hs-type">ics</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>      </span><span class="hs-comment">-- Shortcut common case</span><span>
</span><span id="line-2790"></span><span>         </span><span class="annot"><span class="hs-operator hs-type">&amp;&amp;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#isCoEvBindsVar"><span class="hs-identifier hs-type">isCoEvBindsVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044193"><span class="hs-identifier hs-type">ev_binds_var</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- See Note [Instances in no-evidence implications]</span><span>
</span><span id="line-2791"></span><span>         </span><span class="hs-keyword">then</span><span> </span><span class="annot"><a href="#local-6989586621683044199"><span class="hs-identifier hs-type">try_for_qci</span></a></span><span>
</span><span id="line-2792"></span><span>         </span><span class="hs-keyword">else</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#continueWith"><span class="hs-identifier hs-type">continueWith</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2793"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2794"></span><span>    </span><span id="local-6989586621683044196"><span class="annot"><span class="annottext">ev :: CtEvidence
</span><a href="#local-6989586621683044196"><span class="hs-identifier hs-var hs-var">ev</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#ctEvidence"><span class="hs-identifier hs-var">ctEvidence</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683044189"><span class="hs-identifier hs-var">work_ct</span></a></span><span>
</span><span id="line-2795"></span><span>    </span><span id="local-6989586621683044201"><span class="annot"><span class="annottext">loc :: CtLoc
</span><a href="#local-6989586621683044201"><span class="hs-identifier hs-var hs-var">loc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044196"><span class="hs-identifier hs-var">ev</span></a></span><span>
</span><span id="line-2796"></span><span>    </span><span id="local-6989586621683044202"><span class="annot"><span class="annottext">role :: Role
</span><a href="#local-6989586621683044202"><span class="hs-keyword hs-var hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; Role
</span><a href="GHC.Core.Predicate.html#eqRelRole"><span class="hs-identifier hs-var">eqRelRole</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044190"><span class="hs-identifier hs-var">eq_rel</span></a></span><span>
</span><span id="line-2797"></span><span>
</span><span id="line-2798"></span><span>    </span><span id="local-6989586621683044199"><span class="annot"><span class="annottext">try_for_qci :: TcS (StopOrContinue ())
</span><a href="#local-6989586621683044199"><span class="hs-identifier hs-var hs-var">try_for_qci</span></a></span></span><span>  </span><span class="hs-comment">-- First try looking for (lhs ~ rhs)</span><span>
</span><span id="line-2799"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683044203"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683044203"><span class="hs-identifier hs-var">cls</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683044204"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044204"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; TcType -&gt; TcType -&gt; Maybe (Class, [TcType])
</span><a href="GHC.Tc.Utils.TcType.html#boxEqPred"><span class="hs-identifier hs-var">boxEqPred</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044190"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044191"><span class="hs-identifier hs-var">lhs</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044192"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-2800"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683044206"><span class="annot"><a href="#local-6989586621683044206"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; CtLoc -&gt; TcS ClsInstResult
</span><a href="GHC.Tc.Solver.Dict.html#matchLocalInst"><span class="hs-identifier hs-var">matchLocalInst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Class -&gt; [TcType] -&gt; TcType
</span><a href="GHC.Core.Predicate.html#mkClassPred"><span class="hs-identifier hs-var">mkClassPred</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683044203"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044204"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683044201"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-2801"></span><span>            </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-type">traceTcS</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;lookup_irred_in_qcis:1&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Predicate.html#mkClassPred"><span class="hs-identifier hs-type">mkClassPred</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044203"><span class="hs-identifier hs-type">cls</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044204"><span class="hs-identifier hs-type">tys</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2802"></span><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683044206"><span class="hs-identifier hs-type">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2803"></span><span>                </span><span class="annot"><a href="GHC.Tc.Instance.Class.html#OneInst"><span class="hs-identifier hs-type">OneInst</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cir_mk_ev :: ClsInstResult -&gt; [EvExpr] -&gt; EvTerm
</span><a href="GHC.Tc.Instance.Class.html#cir_mk_ev"><span class="hs-identifier hs-var">cir_mk_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044210"><span class="annot"><span class="annottext">[EvExpr] -&gt; EvTerm
</span><a href="#local-6989586621683044210"><span class="hs-identifier hs-var">mk_ev</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2804"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; ClsInstResult -&gt; TcS (StopOrContinue ())
forall a. CtEvidence -&gt; ClsInstResult -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Dict.html#chooseInstance"><span class="hs-identifier hs-var">chooseInstance</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044196"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClsInstResult
</span><a href="#local-6989586621683044206"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Instance.Class.html#cir_mk_ev"><span class="hs-identifier hs-var">cir_mk_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683044211"><span class="hs-identifier hs-type">mk_eq_ev</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044203"><span class="hs-identifier hs-type">cls</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044204"><span class="hs-identifier hs-type">tys</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044210"><span class="hs-identifier hs-type">mk_ev</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2805"></span><span>                </span><span class="annot"><span class="annottext">ClsInstResult
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcS (StopOrContinue ())
</span><a href="#local-6989586621683044212"><span class="hs-identifier hs-var">try_swapping</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2806"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2807"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcS (StopOrContinue ())
forall a. a -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Monad.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2808"></span><span>
</span><span id="line-2809"></span><span>    </span><span id="local-6989586621683044212"><span class="annot"><span class="annottext">try_swapping :: TcS (StopOrContinue ())
</span><a href="#local-6989586621683044212"><span class="hs-identifier hs-var hs-var">try_swapping</span></a></span></span><span>  </span><span class="hs-comment">-- Now try looking for (rhs ~ lhs)  (see #23333)</span><span>
</span><span id="line-2810"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683044213"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683044213"><span class="hs-identifier hs-var">cls</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683044214"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044214"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; TcType -&gt; TcType -&gt; Maybe (Class, [TcType])
</span><a href="GHC.Tc.Utils.TcType.html#boxEqPred"><span class="hs-identifier hs-var">boxEqPred</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044190"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044192"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044191"><span class="hs-identifier hs-var">lhs</span></a></span><span>
</span><span id="line-2811"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683044215"><span class="annot"><a href="#local-6989586621683044215"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; CtLoc -&gt; TcS ClsInstResult
</span><a href="GHC.Tc.Solver.Dict.html#matchLocalInst"><span class="hs-identifier hs-var">matchLocalInst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Class -&gt; [TcType] -&gt; TcType
</span><a href="GHC.Core.Predicate.html#mkClassPred"><span class="hs-identifier hs-var">mkClassPred</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683044213"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044214"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683044201"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-2812"></span><span>            </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-type">traceTcS</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;lookup_irred_in_qcis:2&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Predicate.html#mkClassPred"><span class="hs-identifier hs-type">mkClassPred</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044213"><span class="hs-identifier hs-type">cls</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044214"><span class="hs-identifier hs-type">tys</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2813"></span><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683044215"><span class="hs-identifier hs-type">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2814"></span><span>                </span><span class="annot"><a href="GHC.Tc.Instance.Class.html#OneInst"><span class="hs-identifier hs-type">OneInst</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cir_mk_ev :: ClsInstResult -&gt; [EvExpr] -&gt; EvTerm
</span><a href="GHC.Tc.Instance.Class.html#cir_mk_ev"><span class="hs-identifier hs-var">cir_mk_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044216"><span class="annot"><span class="annottext">[EvExpr] -&gt; EvTerm
</span><a href="#local-6989586621683044216"><span class="hs-identifier hs-var">mk_ev</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2815"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683044217"><span class="annot"><a href="#local-6989586621683044217"><span class="hs-identifier hs-var">ev'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RewriterSet
-&gt; CtEvidence
-&gt; SwapFlag
-&gt; Reduction
-&gt; Reduction
-&gt; TcS CtEvidence
</span><a href="GHC.Tc.Solver.Equality.html#rewriteEqEvidence"><span class="hs-identifier hs-var">rewriteEqEvidence</span></a></span><span> </span><span class="annot"><span class="annottext">RewriterSet
</span><a href="GHC.Tc.Types.Constraint.html#emptyRewriterSet"><span class="hs-identifier hs-var">emptyRewriterSet</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044196"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#IsSwapped"><span class="hs-identifier hs-var">IsSwapped</span></a></span><span>
</span><span id="line-2816"></span><span>                                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; TcType -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkReflRedn"><span class="hs-identifier hs-var">mkReflRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683044202"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044192"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; TcType -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkReflRedn"><span class="hs-identifier hs-var">mkReflRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683044202"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044191"><span class="hs-identifier hs-var">lhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2817"></span><span>                        </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Dict.html#chooseInstance"><span class="hs-identifier hs-type">chooseInstance</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044217"><span class="hs-identifier hs-type">ev'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683044215"><span class="hs-identifier hs-type">res</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Instance.Class.html#cir_mk_ev"><span class="hs-identifier hs-var">cir_mk_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683044211"><span class="hs-identifier hs-type">mk_eq_ev</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044213"><span class="hs-identifier hs-type">cls</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044214"><span class="hs-identifier hs-type">tys</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044216"><span class="hs-identifier hs-type">mk_ev</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2818"></span><span>                </span><span class="annot"><span class="annottext">ClsInstResult
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;lookup_irred_in_qcis:3&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683044189"><span class="hs-identifier hs-var">work_ct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2819"></span><span>                        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcS (StopOrContinue ())
forall a. a -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Monad.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><span id="line-2820"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2821"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcS (StopOrContinue ())
forall a. a -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Monad.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2822"></span><span>
</span><span id="line-2823"></span><span>    </span><span id="local-6989586621683044211"><span class="annot"><span class="annottext">mk_eq_ev :: Class -&gt; [TcType] -&gt; ([EvExpr] -&gt; EvTerm) -&gt; [EvExpr] -&gt; EvTerm
</span><a href="#local-6989586621683044211"><span class="hs-identifier hs-var hs-var">mk_eq_ev</span></a></span></span><span> </span><span id="local-6989586621683044218"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683044218"><span class="hs-identifier hs-var">cls</span></a></span></span><span> </span><span id="local-6989586621683044219"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044219"><span class="hs-identifier hs-var">tys</span></a></span></span><span> </span><span id="local-6989586621683044220"><span class="annot"><span class="annottext">[EvExpr] -&gt; EvTerm
</span><a href="#local-6989586621683044220"><span class="hs-identifier hs-var">mk_ev</span></a></span></span><span> </span><span id="local-6989586621683044221"><span class="annot"><span class="annottext">[EvExpr]
</span><a href="#local-6989586621683044221"><span class="hs-identifier hs-var">evs</span></a></span></span><span>
</span><span id="line-2824"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621683044222"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683044222"><span class="hs-identifier hs-var">sc_id</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621683044223"><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683044223"><span class="hs-identifier hs-var">rest</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Class -&gt; [TcTyVar]
</span><a href="GHC.Core.Class.html#classSCSelIds"><span class="hs-identifier hs-var">classSCSelIds</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683044218"><span class="hs-identifier hs-var">cls</span></a></span><span>  </span><span class="hs-comment">-- Just one superclass for this</span><span>
</span><span id="line-2825"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; EvTerm -&gt; EvTerm
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TcTyVar] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683044223"><span class="hs-identifier hs-var">rest</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(EvTerm -&gt; EvTerm) -&gt; EvTerm -&gt; EvTerm
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[EvExpr] -&gt; EvTerm
</span><a href="#local-6989586621683044220"><span class="hs-identifier hs-var">mk_ev</span></a></span><span> </span><span class="annot"><span class="annottext">[EvExpr]
</span><a href="#local-6989586621683044221"><span class="hs-identifier hs-var">evs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2826"></span><span>          </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#EvExpr"><span class="hs-identifier hs-type">EvExpr</span></a></span><span> </span><span id="local-6989586621683044226"><span class="annot"><span class="annottext">EvExpr
</span><a href="#local-6989586621683044226"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">EvExpr -&gt; EvTerm
</span><a href="GHC.Tc.Types.Evidence.html#EvExpr"><span class="hs-identifier hs-var">EvExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; EvExpr
forall b. TcTyVar -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683044222"><span class="hs-identifier hs-var">sc_id</span></a></span><span> </span><span class="annot"><span class="annottext">EvExpr -&gt; [TcType] -&gt; EvExpr
forall b. Expr b -&gt; [TcType] -&gt; Expr b
</span><a href="GHC.Core.html#mkTyApps"><span class="hs-operator hs-var">`mkTyApps`</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044219"><span class="hs-identifier hs-var">tys</span></a></span><span> </span><span class="annot"><span class="annottext">EvExpr -&gt; EvExpr -&gt; EvExpr
forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-operator hs-var">`App`</span></a></span><span> </span><span class="annot"><span class="annottext">EvExpr
</span><a href="#local-6989586621683044226"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2827"></span><span>          </span><span id="local-6989586621683044230"><span class="annot"><span class="annottext">EvTerm
</span><a href="#local-6989586621683044230"><span class="hs-identifier hs-var">ev</span></a></span></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; EvTerm
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;mk_eq_ev&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EvTerm -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">EvTerm
</span><a href="#local-6989586621683044230"><span class="hs-identifier hs-var">ev</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2828"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; EvTerm
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;finishEqCt&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683044189"><span class="hs-identifier hs-var">work_ct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2829"></span><span>
</span><span id="line-2830"></span><span class="hs-comment">{- Note [Instances in no-evidence implications]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In #15290 we had
  [G] forall p q. Coercible p q =&gt; Coercible (m p) (m q))   -- Quantified
  [W] forall &lt;no-ev&gt; a. m (Int, IntStateT m a)
                          ~R#
                        m (Int, StateT Int m a)

The Given is an ordinary quantified constraint; the Wanted is an implication
equality that arises from
  [W] (forall a. t1) ~R# (forall a. t2)

But because the (t1 ~R# t2) is solved &quot;inside a type&quot; (under that forall a)
we can't generate any term evidence.  So we can't actually use that
lovely quantified constraint.  Alas!

This test arranges to ignore the instance-based solution under these
(rare) circumstances.   It's sad, but I  really don't see what else we can do.
-}</span><span>
</span><span id="line-2849"></span><span>
</span><span id="line-2850"></span><span>
</span><span id="line-2851"></span><span class="hs-comment">{-
**********************************************************************
*                                                                    *
    Functional dependencies for type families
*                                                                    *
**********************************************************************

Note [Reverse order of fundep equations]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this scenario (from dependent/should_fail/T13135_simple):

  type Sig :: Type -&gt; Type
  data Sig a = SigFun a (Sig a)

  type SmartFun :: forall (t :: Type). Sig t -&gt; Type
  type family SmartFun sig = r | r -&gt; sig where
    SmartFun @Type (SigFun @Type a sig) = a -&gt; SmartFun @Type sig

  [W] SmartFun @kappa sigma ~ (Int -&gt; Bool)

The injectivity of SmartFun allows us to produce two new equalities:

  [W] w1 :: Type ~ kappa
  [W] w2 :: SigFun @Type Int beta ~ sigma

for some fresh (beta :: SigType). The second Wanted here is actually
heterogeneous: the LHS has type Sig Type while the RHS has type Sig kappa.
Of course, if we solve the first wanted first, the second becomes homogeneous.

When looking for injectivity-inspired equalities, we work left-to-right,
producing the two equalities in the order written above. However, these
equalities are then passed into wrapUnifierTcS, which will fail, adding these
to the work list. However, crucially, the work list operates like a *stack*.
So, because we add w1 and then w2, we process w2 first. This is silly: solving
w1 would unlock w2. So we make sure to add equalities to the work
list in left-to-right order, which requires a few key calls to 'reverse'.

This treatment is also used for class-based functional dependencies, although
we do not have a program yet known to exhibit a loop there. It just seems
like the right thing to do.

When this was originally conceived, it was necessary to avoid a loop in T13135.
That loop is now avoided by continuing with the kind equality (not the type
equality) in canEqCanLHSHetero (see Note [Equalities with incompatible kinds]).
However, the idea of working left-to-right still seems worthwhile, and so the calls
to 'reverse' remain.

Note [Improvement orientation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
See also Note [Fundeps with instances, and equality orientation], which describes
the Exact Same Problem, with the same solution, but for functional dependencies.

A very delicate point is the orientation of equalities
arising from injectivity improvement (#12522).  Suppose we have
  type family F x = t | t -&gt; x
  type instance F (a, Int) = (Int, G a)
where G is injective; and wanted constraints

  [W] TF (alpha, beta) ~ fuv
  [W] fuv ~ (Int, &lt;some type&gt;)

The injectivity will give rise to constraints

  [W] gamma1 ~ alpha
  [W] Int ~ beta

The fresh unification variable gamma1 comes from the fact that we
can only do &quot;partial improvement&quot; here; see Section 5.2 of
&quot;Injective type families for Haskell&quot; (HS'15).

Now, it's very important to orient the equations this way round,
so that the fresh unification variable will be eliminated in
favour of alpha.  If we instead had
   [W] alpha ~ gamma1
then we would unify alpha := gamma1; and kick out the wanted
constraint.  But when we grough it back in, it'd look like
   [W] TF (gamma1, beta) ~ fuv
and exactly the same thing would happen again!  Infinite loop.

This all seems fragile, and it might seem more robust to avoid
introducing gamma1 in the first place, in the case where the
actual argument (alpha, beta) partly matches the improvement
template.  But that's a bit tricky, esp when we remember that the
kinds much match too; so it's easier to let the normal machinery
handle it.  Instead we are careful to orient the new
equality with the template on the left.  Delicate, but it works.

-}</span><span>
</span><span id="line-2939"></span><span>
</span><span id="line-2940"></span><span class="hs-comment">--------------------</span><span>
</span><span id="line-2941"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#tryFunDeps"><span class="hs-identifier hs-type">tryFunDeps</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#EqRel"><span class="hs-identifier hs-type">EqRel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#SolverStage"><span class="hs-identifier hs-type">SolverStage</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2942"></span><span id="tryFunDeps"><span class="annot"><span class="annottext">tryFunDeps :: EqRel -&gt; EqCt -&gt; SolverStage ()
</span><a href="GHC.Tc.Solver.Equality.html#tryFunDeps"><span class="hs-identifier hs-var hs-var">tryFunDeps</span></a></span></span><span> </span><span id="local-6989586621683044231"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044231"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span id="local-6989586621683044232"><span class="annot"><span class="annottext">work_item :: EqCt
</span><a href="#local-6989586621683044232"><span class="hs-identifier hs-var">work_item</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">eq_lhs :: EqCt -&gt; CanEqLHS
</span><a href="GHC.Tc.Types.Constraint.html#eq_lhs"><span class="hs-identifier hs-var">eq_lhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044233"><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683044233"><span class="hs-identifier hs-var">lhs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">eq_ev :: EqCt -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#eq_ev"><span class="hs-identifier hs-var">eq_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044234"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044234"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2943"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#NomEq"><span class="hs-identifier hs-var">NomEq</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683044231"><span class="hs-identifier hs-var">eq_rel</span></a></span><span>
</span><span id="line-2944"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#TyFamLHS"><span class="hs-identifier hs-type">TyFamLHS</span></a></span><span> </span><span id="local-6989586621683044235"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044235"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621683044236"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044236"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683044233"><span class="hs-identifier hs-var">lhs</span></a></span><span>
</span><span id="line-2945"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcS (StopOrContinue ()) -&gt; SolverStage ()
forall a. TcS (StopOrContinue a) -&gt; SolverStage a
</span><a href="GHC.Tc.Solver.Monad.html#Stage"><span class="hs-identifier hs-var">Stage</span></a></span><span> </span><span class="annot"><span class="annottext">(TcS (StopOrContinue ()) -&gt; SolverStage ())
-&gt; TcS (StopOrContinue ()) -&gt; SolverStage ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2946"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683044237"><span class="annot"><a href="#local-6989586621683044237"><span class="hs-identifier hs-var">inerts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS InertCans
</span><a href="GHC.Tc.Solver.Monad.html#getInertCans"><span class="hs-identifier hs-var">getInertCans</span></a></span><span>
</span><span id="line-2947"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683044238"><span class="annot"><a href="#local-6989586621683044238"><span class="hs-identifier hs-var">imp1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#improveLocalFunEqs"><span class="hs-identifier hs-type">improveLocalFunEqs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044237"><span class="hs-identifier hs-type">inerts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044235"><span class="hs-identifier hs-type">tc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044236"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044232"><span class="hs-identifier hs-type">work_item</span></a></span><span>
</span><span id="line-2948"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683044240"><span class="annot"><a href="#local-6989586621683044240"><span class="hs-identifier hs-var">imp2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#improveTopFunEqs"><span class="hs-identifier hs-type">improveTopFunEqs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044235"><span class="hs-identifier hs-type">tc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044236"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044232"><span class="hs-identifier hs-type">work_item</span></a></span><span>
</span><span id="line-2949"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683044238"><span class="hs-identifier hs-type">imp1</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">||</span></span><span> </span><span class="annot"><a href="#local-6989586621683044240"><span class="hs-identifier hs-type">imp2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2950"></span><span>         </span><span class="hs-keyword">then</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#startAgainWith"><span class="hs-identifier hs-type">startAgainWith</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#mkNonCanonical"><span class="hs-identifier hs-type">mkNonCanonical</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044234"><span class="hs-identifier hs-type">ev</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2951"></span><span>         </span><span class="hs-keyword">else</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#continueWith"><span class="hs-identifier hs-type">continueWith</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2952"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2953"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; SolverStage ()
forall a. a -&gt; SolverStage a
</span><a href="GHC.Tc.Solver.Monad.html#nopStage"><span class="hs-identifier hs-var">nopStage</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2954"></span><span>
</span><span id="line-2955"></span><span class="hs-comment">--------------------</span><span>
</span><span id="line-2956"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#improveTopFunEqs"><span class="hs-identifier hs-type">improveTopFunEqs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-2957"></span><span class="hs-comment">-- TyCon is definitely a type family</span><span>
</span><span id="line-2958"></span><span class="hs-comment">-- See Note [FunDep and implicit parameter reactions]</span><span>
</span><span id="line-2959"></span><span id="improveTopFunEqs"><span class="annot"><span class="annottext">improveTopFunEqs :: TyCon -&gt; [TcType] -&gt; EqCt -&gt; TcS Bool
</span><a href="GHC.Tc.Solver.Equality.html#improveTopFunEqs"><span class="hs-identifier hs-var hs-var">improveTopFunEqs</span></a></span></span><span> </span><span id="local-6989586621683044243"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044243"><span class="hs-identifier hs-var">fam_tc</span></a></span></span><span> </span><span id="local-6989586621683044244"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044244"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">eq_ev :: EqCt -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#eq_ev"><span class="hs-identifier hs-var">eq_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044245"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044245"><span class="hs-identifier hs-var">ev</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">eq_rhs :: EqCt -&gt; TcType
</span><a href="GHC.Tc.Types.Constraint.html#eq_rhs"><span class="hs-identifier hs-var">eq_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044246"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044246"><span class="hs-identifier hs-var">rhs_ty</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2960"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isGiven"><span class="hs-identifier hs-var">isGiven</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044245"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [TcType] -&gt; CtEvidence -&gt; TcType -&gt; TcS Bool
</span><a href="GHC.Tc.Solver.Equality.html#improveGivenTopFunEqs"><span class="hs-identifier hs-var">improveGivenTopFunEqs</span></a></span><span>  </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044243"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044244"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044245"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044246"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span>
</span><span id="line-2961"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [TcType] -&gt; CtEvidence -&gt; TcType -&gt; TcS Bool
</span><a href="GHC.Tc.Solver.Equality.html#improveWantedTopFunEqs"><span class="hs-identifier hs-var">improveWantedTopFunEqs</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044243"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044244"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044245"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044246"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span>
</span><span id="line-2962"></span><span>
</span><span id="line-2963"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#improveGivenTopFunEqs"><span class="hs-identifier hs-type">improveGivenTopFunEqs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Xi"><span class="hs-identifier hs-type">Xi</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-2964"></span><span class="hs-comment">-- TyCon is definitely a type family</span><span>
</span><span id="line-2965"></span><span class="hs-comment">-- Work-item is a Given</span><span>
</span><span id="line-2966"></span><span id="improveGivenTopFunEqs"><span class="annot"><span class="annottext">improveGivenTopFunEqs :: TyCon -&gt; [TcType] -&gt; CtEvidence -&gt; TcType -&gt; TcS Bool
</span><a href="GHC.Tc.Solver.Equality.html#improveGivenTopFunEqs"><span class="hs-identifier hs-var hs-var">improveGivenTopFunEqs</span></a></span></span><span> </span><span id="local-6989586621683044249"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044249"><span class="hs-identifier hs-var">fam_tc</span></a></span></span><span> </span><span id="local-6989586621683044250"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044250"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621683044251"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044251"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683044252"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044252"><span class="hs-identifier hs-var">rhs_ty</span></a></span></span><span>
</span><span id="line-2967"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683044253"><span class="annot"><span class="annottext">BuiltInSynFamily
</span><a href="#local-6989586621683044253"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Maybe BuiltInSynFamily
</span><a href="GHC.Core.TyCon.html#isBuiltInSynFamTyCon_maybe"><span class="hs-identifier hs-var">isBuiltInSynFamTyCon_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044249"><span class="hs-identifier hs-var">fam_tc</span></a></span><span>
</span><span id="line-2968"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;improveGivenTopFunEqs&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044249"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044250"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044251"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044252"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2969"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; [(Role, TcCoercion)] -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#emitNewGivens"><span class="hs-identifier hs-var">emitNewGivens</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044251"><span class="hs-identifier hs-var">ev</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(Role, TcCoercion)] -&gt; TcS ()) -&gt; [(Role, TcCoercion)] -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2970"></span><span>           </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683044255"><span class="hs-identifier hs-var">new_co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2971"></span><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683044256"><span class="annot"><span class="annottext">CoAxiomRule
</span><a href="#local-6989586621683044256"><span class="hs-identifier hs-var">ax</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TypeEqn
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BuiltInSynFamily
-&gt; TyCon -&gt; [TcType] -&gt; TcType -&gt; [(CoAxiomRule, TypeEqn)]
</span><a href="GHC.Builtin.Types.Literals.html#tryInteractTopFam"><span class="hs-identifier hs-var">tryInteractTopFam</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltInSynFamily
</span><a href="#local-6989586621683044253"><span class="hs-identifier hs-var">ops</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044249"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044250"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044252"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span>
</span><span id="line-2972"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683044255"><span class="annot"><span class="annottext">new_co :: TcCoercion
</span><a href="#local-6989586621683044255"><span class="hs-identifier hs-var hs-var">new_co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoAxiomRule -&gt; [TcCoercion] -&gt; TcCoercion
</span><a href="GHC.Core.Coercion.html#mkAxiomCo"><span class="hs-identifier hs-var">mkAxiomCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiomRule
</span><a href="#local-6989586621683044256"><span class="hs-identifier hs-var">ax</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683044258"><span class="hs-identifier hs-var">given_co</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-2973"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcS Bool
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-special">}</span><span>  </span><span class="hs-comment">-- False: no unifications</span><span>
</span><span id="line-2974"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2975"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcS Bool
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-2976"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2977"></span><span>    </span><span id="local-6989586621683044258"><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683044258"><span class="hs-identifier hs-var">given_co</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CtEvidence -&gt; TcCoercion
CtEvidence -&gt; TcCoercion
</span><a href="GHC.Tc.Types.Constraint.html#ctEvCoercion"><span class="hs-identifier hs-var">ctEvCoercion</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044251"><span class="hs-identifier hs-var">ev</span></a></span><span>
</span><span id="line-2978"></span><span>
</span><span id="line-2979"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#improveWantedTopFunEqs"><span class="hs-identifier hs-type">improveWantedTopFunEqs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Xi"><span class="hs-identifier hs-type">Xi</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-2980"></span><span class="hs-comment">-- TyCon is definitely a type family</span><span>
</span><span id="line-2981"></span><span class="hs-comment">-- Work-item is a Wanted</span><span>
</span><span id="line-2982"></span><span id="improveWantedTopFunEqs"><span class="annot"><span class="annottext">improveWantedTopFunEqs :: TyCon -&gt; [TcType] -&gt; CtEvidence -&gt; TcType -&gt; TcS Bool
</span><a href="GHC.Tc.Solver.Equality.html#improveWantedTopFunEqs"><span class="hs-identifier hs-var hs-var">improveWantedTopFunEqs</span></a></span></span><span> </span><span id="local-6989586621683044259"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044259"><span class="hs-identifier hs-var">fam_tc</span></a></span></span><span> </span><span id="local-6989586621683044260"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044260"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621683044261"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044261"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621683044262"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044262"><span class="hs-identifier hs-var">rhs_ty</span></a></span></span><span>
</span><span id="line-2983"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683044263"><span class="annot"><a href="#local-6989586621683044263"><span class="hs-identifier hs-var">eqns</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [TcType] -&gt; TcType -&gt; TcS [TypeEqn]
</span><a href="GHC.Tc.Solver.Equality.html#improve_wanted_top_fun_eqs"><span class="hs-identifier hs-var">improve_wanted_top_fun_eqs</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044259"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044260"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044262"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span>
</span><span id="line-2984"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-type">traceTcS</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;improveTopFunEqs&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-type">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044259"><span class="hs-identifier hs-type">fam_tc</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044260"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044262"><span class="hs-identifier hs-type">rhs_ty</span></a></span><span>
</span><span id="line-2985"></span><span>                                           </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044263"><span class="hs-identifier hs-type">eqns</span></a></span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2986"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#unifyFunDeps"><span class="hs-identifier hs-type">unifyFunDeps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044261"><span class="hs-identifier hs-type">ev</span></a></span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-type">Nominal</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621683044266"><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683044266"><span class="hs-identifier hs-var">uenv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2987"></span><span>         </span><span class="annot"><span class="annottext">UnifyEnv -&gt; [TypeEqn] -&gt; TcM ()
</span><a href="GHC.Tc.Solver.Monad.html#uPairsTcM"><span class="hs-identifier hs-var">uPairsTcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UnifyEnv -&gt; UnifyEnv
</span><a href="#local-6989586621683044268"><span class="hs-identifier hs-var">bump_depth</span></a></span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683044266"><span class="hs-identifier hs-var">uenv</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TypeEqn] -&gt; [TypeEqn]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[TypeEqn]
</span><a href="#local-6989586621683044263"><span class="hs-identifier hs-var">eqns</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2988"></span><span>         </span><span class="hs-comment">-- Missing that `reverse` causes T13135 and T13135_simple to loop.</span><span>
</span><span id="line-2989"></span><span>         </span><span class="hs-comment">-- See Note [Reverse order of fundep equations]</span><span>
</span><span id="line-2990"></span><span>
</span><span id="line-2991"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2992"></span><span>    </span><span id="local-6989586621683044268"><span class="annot"><span class="annottext">bump_depth :: UnifyEnv -&gt; UnifyEnv
</span><a href="#local-6989586621683044268"><span class="hs-identifier hs-var hs-var">bump_depth</span></a></span></span><span> </span><span id="local-6989586621683044269"><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683044269"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683044269"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#u_loc"><span class="hs-identifier hs-var">u_loc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.CtLoc.html#bumpCtLocDepth"><span class="hs-identifier hs-type">bumpCtLocDepth</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#u_loc"><span class="hs-identifier hs-var">u_loc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044269"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2993"></span><span>        </span><span class="hs-comment">-- ToDo: this location is wrong; it should be FunDepOrigin2</span><span>
</span><span id="line-2994"></span><span>        </span><span class="hs-comment">-- See #14778</span><span>
</span><span id="line-2995"></span><span>
</span><span id="line-2996"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#improve_wanted_top_fun_eqs"><span class="hs-identifier hs-type">improve_wanted_top_fun_eqs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Xi"><span class="hs-identifier hs-type">Xi</span></a></span><span>
</span><span id="line-2997"></span><span>                           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#TypeEqn"><span class="hs-identifier hs-type">TypeEqn</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2998"></span><span class="hs-comment">-- TyCon is definitely a type family</span><span>
</span><span id="line-2999"></span><span id="improve_wanted_top_fun_eqs"><span class="annot"><span class="annottext">improve_wanted_top_fun_eqs :: TyCon -&gt; [TcType] -&gt; TcType -&gt; TcS [TypeEqn]
</span><a href="GHC.Tc.Solver.Equality.html#improve_wanted_top_fun_eqs"><span class="hs-identifier hs-var hs-var">improve_wanted_top_fun_eqs</span></a></span></span><span> </span><span id="local-6989586621683044271"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044271"><span class="hs-identifier hs-var">fam_tc</span></a></span></span><span> </span><span id="local-6989586621683044272"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044272"><span class="hs-identifier hs-var">lhs_tys</span></a></span></span><span> </span><span id="local-6989586621683044273"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044273"><span class="hs-identifier hs-var">rhs_ty</span></a></span></span><span>
</span><span id="line-3000"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683044274"><span class="annot"><span class="annottext">BuiltInSynFamily
</span><a href="#local-6989586621683044274"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Maybe BuiltInSynFamily
</span><a href="GHC.Core.TyCon.html#isBuiltInSynFamTyCon_maybe"><span class="hs-identifier hs-var">isBuiltInSynFamTyCon_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044271"><span class="hs-identifier hs-var">fam_tc</span></a></span><span>
</span><span id="line-3001"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TypeEqn] -&gt; TcS [TypeEqn]
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((CoAxiomRule, TypeEqn) -&gt; TypeEqn)
-&gt; [(CoAxiomRule, TypeEqn)] -&gt; [TypeEqn]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(CoAxiomRule, TypeEqn) -&gt; TypeEqn
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">([(CoAxiomRule, TypeEqn)] -&gt; [TypeEqn])
-&gt; [(CoAxiomRule, TypeEqn)] -&gt; [TypeEqn]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BuiltInSynFamily
-&gt; TyCon -&gt; [TcType] -&gt; TcType -&gt; [(CoAxiomRule, TypeEqn)]
</span><a href="GHC.Builtin.Types.Literals.html#tryInteractTopFam"><span class="hs-identifier hs-var">tryInteractTopFam</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltInSynFamily
</span><a href="#local-6989586621683044274"><span class="hs-identifier hs-var">ops</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044271"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044272"><span class="hs-identifier hs-var">lhs_tys</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044273"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3002"></span><span>
</span><span id="line-3003"></span><span>  </span><span class="hs-comment">-- See Note [Type inference for type families with injectivity]</span><span>
</span><span id="line-3004"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#Injective"><span class="hs-identifier hs-type">Injective</span></a></span><span> </span><span id="local-6989586621683044277"><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621683044277"><span class="hs-identifier hs-var">inj_args</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Injectivity
</span><a href="GHC.Core.TyCon.html#tyConInjectivityInfo"><span class="hs-identifier hs-var">tyConInjectivityInfo</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044271"><span class="hs-identifier hs-var">fam_tc</span></a></span><span>
</span><span id="line-3005"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683044279"><span class="annot"><a href="#local-6989586621683044279"><span class="hs-identifier hs-var">fam_envs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS (FamInstEnv, FamInstEnv)
</span><a href="GHC.Tc.Solver.Monad.html#getFamInstEnvs"><span class="hs-identifier hs-var">getFamInstEnvs</span></a></span><span>
</span><span id="line-3006"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683044280"><span class="annot"><a href="#local-6989586621683044280"><span class="hs-identifier hs-var">top_eqns</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#improve_injective_wanted_top"><span class="hs-identifier hs-type">improve_injective_wanted_top</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044279"><span class="hs-identifier hs-type">fam_envs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044277"><span class="hs-identifier hs-type">inj_args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044271"><span class="hs-identifier hs-type">fam_tc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044272"><span class="hs-identifier hs-type">lhs_tys</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044273"><span class="hs-identifier hs-type">rhs_ty</span></a></span><span>
</span><span id="line-3007"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683044282"><span class="annot"><a href="#local-6989586621683044282"><span class="hs-identifier hs-var hs-var">local_eqns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Bool] -&gt; TyCon -&gt; [TcType] -&gt; TcType -&gt; [TypeEqn]
</span><a href="GHC.Tc.Solver.Equality.html#improve_injective_wanted_famfam"><span class="hs-identifier hs-var">improve_injective_wanted_famfam</span></a></span><span>  </span><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621683044277"><span class="hs-identifier hs-var">inj_args</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044271"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044272"><span class="hs-identifier hs-var">lhs_tys</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044273"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span>
</span><span id="line-3008"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683044282"><span class="hs-identifier hs-type">local_eqns</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621683044280"><span class="hs-identifier hs-type">top_eqns</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3009"></span><span>
</span><span id="line-3010"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>  </span><span class="hs-comment">-- No injectivity</span><span>
</span><span id="line-3011"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TypeEqn] -&gt; TcS [TypeEqn]
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-3012"></span><span>
</span><span id="line-3013"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#improve_injective_wanted_top"><span class="hs-identifier hs-type">improve_injective_wanted_top</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Xi"><span class="hs-identifier hs-type">Xi</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#TypeEqn"><span class="hs-identifier hs-type">TypeEqn</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-3014"></span><span class="hs-comment">-- Interact with top-level instance declarations</span><span>
</span><span id="line-3015"></span><span id="improve_injective_wanted_top"><span class="annot"><span class="annottext">improve_injective_wanted_top :: (FamInstEnv, FamInstEnv)
-&gt; [Bool] -&gt; TyCon -&gt; [TcType] -&gt; TcType -&gt; TcS [TypeEqn]
</span><a href="GHC.Tc.Solver.Equality.html#improve_injective_wanted_top"><span class="hs-identifier hs-var hs-var">improve_injective_wanted_top</span></a></span></span><span> </span><span id="local-6989586621683044284"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621683044284"><span class="hs-identifier hs-var">fam_envs</span></a></span></span><span> </span><span id="local-6989586621683044285"><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621683044285"><span class="hs-identifier hs-var">inj_args</span></a></span></span><span> </span><span id="local-6989586621683044286"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044286"><span class="hs-identifier hs-var">fam_tc</span></a></span></span><span> </span><span id="local-6989586621683044287"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044287"><span class="hs-identifier hs-var">lhs_tys</span></a></span></span><span> </span><span id="local-6989586621683044288"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044288"><span class="hs-identifier hs-var">rhs_ty</span></a></span></span><span>
</span><span id="line-3016"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoAxBranch -&gt; TcS [TypeEqn]) -&gt; [CoAxBranch] -&gt; TcS [TypeEqn]
forall (m :: * -&gt; *) (f :: * -&gt; *) a b.
(Monad m, Traversable f) =&gt;
(a -&gt; m [b]) -&gt; f a -&gt; m [b]
</span><a href="GHC.Utils.Monad.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxBranch -&gt; TcS [TypeEqn]
</span><a href="#local-6989586621683044290"><span class="hs-identifier hs-var">do_one</span></a></span><span> </span><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="#local-6989586621683044291"><span class="hs-identifier hs-var">branches</span></a></span><span>
</span><span id="line-3017"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3018"></span><span>    </span><span class="annot"><a href="#local-6989586621683044291"><span class="hs-identifier hs-type">branches</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-3019"></span><span>    </span><span id="local-6989586621683044291"><span class="annot"><span class="annottext">branches :: [CoAxBranch]
</span><a href="#local-6989586621683044291"><span class="hs-identifier hs-var hs-var">branches</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isOpenTypeFamilyTyCon"><span class="hs-identifier hs-var">isOpenTypeFamilyTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044286"><span class="hs-identifier hs-var">fam_tc</span></a></span><span>
</span><span id="line-3020"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683044293"><span class="annot"><span class="annottext">fam_insts :: [FamInst]
</span><a href="#local-6989586621683044293"><span class="hs-identifier hs-var hs-var">fam_insts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv) -&gt; TyCon -&gt; [FamInst]
</span><a href="GHC.Core.FamInstEnv.html#lookupFamInstEnvByTyCon"><span class="hs-identifier hs-var">lookupFamInstEnvByTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621683044284"><span class="hs-identifier hs-var">fam_envs</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044286"><span class="hs-identifier hs-var">fam_tc</span></a></span><span>
</span><span id="line-3021"></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FamInst -&gt; [CoAxBranch]) -&gt; [FamInst] -&gt; [CoAxBranch]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Branches Unbranched -&gt; [CoAxBranch]
forall (br :: BranchFlag). Branches br -&gt; [CoAxBranch]
</span><a href="GHC.Core.Coercion.Axiom.html#fromBranches"><span class="hs-identifier hs-var">fromBranches</span></a></span><span> </span><span class="annot"><span class="annottext">(Branches Unbranched -&gt; [CoAxBranch])
-&gt; (FamInst -&gt; Branches Unbranched) -&gt; FamInst -&gt; [CoAxBranch]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">CoAxiom Unbranched -&gt; Branches Unbranched
forall (br :: BranchFlag). CoAxiom br -&gt; Branches br
</span><a href="GHC.Core.Coercion.Axiom.html#coAxiomBranches"><span class="hs-identifier hs-var">coAxiomBranches</span></a></span><span> </span><span class="annot"><span class="annottext">(CoAxiom Unbranched -&gt; Branches Unbranched)
-&gt; (FamInst -&gt; CoAxiom Unbranched)
-&gt; FamInst
-&gt; Branches Unbranched
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">FamInst -&gt; CoAxiom Unbranched
</span><a href="GHC.Core.FamInstEnv.html#fi_axiom"><span class="hs-identifier hs-var">fi_axiom</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[FamInst]
</span><a href="#local-6989586621683044293"><span class="hs-identifier hs-var">fam_insts</span></a></span><span>
</span><span id="line-3022"></span><span>
</span><span id="line-3023"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683044298"><span class="annot"><span class="annottext">CoAxiom Branched
</span><a href="#local-6989586621683044298"><span class="hs-identifier hs-var">ax</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Maybe (CoAxiom Branched)
</span><a href="GHC.Core.TyCon.html#isClosedSynFamilyTyConWithAxiom_maybe"><span class="hs-identifier hs-var">isClosedSynFamilyTyConWithAxiom_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044286"><span class="hs-identifier hs-var">fam_tc</span></a></span><span>
</span><span id="line-3024"></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Branches Branched -&gt; [CoAxBranch]
forall (br :: BranchFlag). Branches br -&gt; [CoAxBranch]
</span><a href="GHC.Core.Coercion.Axiom.html#fromBranches"><span class="hs-identifier hs-var">fromBranches</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoAxiom Branched -&gt; Branches Branched
forall (br :: BranchFlag). CoAxiom br -&gt; Branches br
</span><a href="GHC.Core.Coercion.Axiom.html#coAxiomBranches"><span class="hs-identifier hs-var">coAxiomBranches</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiom Branched
</span><a href="#local-6989586621683044298"><span class="hs-identifier hs-var">ax</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3025"></span><span>
</span><span id="line-3026"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3027"></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-3028"></span><span>
</span><span id="line-3029"></span><span>    </span><span class="annot"><a href="#local-6989586621683044290"><span class="hs-identifier hs-type">do_one</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#TypeEqn"><span class="hs-identifier hs-type">TypeEqn</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-3030"></span><span>    </span><span id="local-6989586621683044290"><span class="annot"><span class="annottext">do_one :: CoAxBranch -&gt; TcS [TypeEqn]
</span><a href="#local-6989586621683044290"><span class="hs-identifier hs-var hs-var">do_one</span></a></span></span><span> </span><span id="local-6989586621683044300"><span class="annot"><span class="annottext">branch :: CoAxBranch
</span><a href="#local-6989586621683044300"><span class="hs-identifier hs-var">branch</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cab_tvs :: CoAxBranch -&gt; [TcTyVar]
</span><a href="GHC.Core.Coercion.Axiom.html#cab_tvs"><span class="hs-identifier hs-var">cab_tvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044303"><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683044303"><span class="hs-identifier hs-var">branch_tvs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cab_lhs :: CoAxBranch -&gt; [TcType]
</span><a href="GHC.Core.Coercion.Axiom.html#cab_lhs"><span class="hs-identifier hs-var">cab_lhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044305"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044305"><span class="hs-identifier hs-var">branch_lhs_tys</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cab_rhs :: CoAxBranch -&gt; TcType
</span><a href="GHC.Core.Coercion.Axiom.html#cab_rhs"><span class="hs-identifier hs-var">cab_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044307"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044307"><span class="hs-identifier hs-var">branch_rhs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3031"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683044308"><span class="annot"><span class="annottext">in_scope1 :: InScopeSet
</span><a href="#local-6989586621683044308"><span class="hs-identifier hs-var hs-var">in_scope1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621683044309"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; [TcTyVar] -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#extendInScopeSetList"><span class="hs-operator hs-var">`extendInScopeSetList`</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683044303"><span class="hs-identifier hs-var">branch_tvs</span></a></span><span>
</span><span id="line-3032"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683044311"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683044311"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; InScopeSet -&gt; TcType -&gt; TcType -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tcUnifyTyWithTFs"><span class="hs-identifier hs-var">tcUnifyTyWithTFs</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621683044308"><span class="hs-identifier hs-var">in_scope1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044307"><span class="hs-identifier hs-var">branch_rhs</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044288"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span>
</span><span id="line-3033"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683044312"><span class="annot"><span class="annottext">inSubst :: TcTyVar -&gt; Bool
</span><a href="#local-6989586621683044312"><span class="hs-identifier hs-var hs-var hs-var">inSubst</span></a></span></span><span> </span><span id="local-6989586621683044313"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683044313"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683044313"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; VarEnv TcType -&gt; Bool
forall a. TcTyVar -&gt; VarEnv a -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#elemVarEnv"><span class="hs-operator hs-var">`elemVarEnv`</span></a></span><span> </span><span class="annot"><span class="annottext">Subst -&gt; VarEnv TcType
</span><a href="GHC.Core.TyCo.Subst.html#getTvSubstEnv"><span class="hs-identifier hs-var">getTvSubstEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683044311"><span class="hs-identifier hs-var">subst</span></a></span><span>
</span><span id="line-3034"></span><span>                 </span><span id="local-6989586621683044316"><span class="annot"><span class="annottext">unsubstTvs :: [TcTyVar]
</span><a href="#local-6989586621683044316"><span class="hs-identifier hs-var hs-var hs-var">unsubstTvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TcTyVar -&gt; Bool) -&gt; [TcTyVar] -&gt; [TcTyVar]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="GHC.Utils.Misc.html#filterOut"><span class="hs-identifier hs-var">filterOut</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; Bool
</span><a href="#local-6989586621683044312"><span class="hs-identifier hs-var">inSubst</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683044303"><span class="hs-identifier hs-var">branch_tvs</span></a></span><span>
</span><span id="line-3035"></span><span>                 </span><span class="hs-comment">-- The order of unsubstTvs is important; it must be</span><span>
</span><span id="line-3036"></span><span>                 </span><span class="hs-comment">-- in telescope order e.g. (k:*) (a:k)</span><span>
</span><span id="line-3037"></span><span>
</span><span id="line-3038"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683044318"><span class="annot"><a href="#local-6989586621683044318"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; [TcTyVar] -&gt; TcS Subst
</span><a href="GHC.Tc.Solver.Monad.html#instFlexiX"><span class="hs-identifier hs-var">instFlexiX</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683044311"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683044316"><span class="hs-identifier hs-var">unsubstTvs</span></a></span><span>
</span><span id="line-3039"></span><span>                </span><span class="hs-comment">-- If the current substitution bind [k -&gt; *], and</span><span>
</span><span id="line-3040"></span><span>                </span><span class="hs-comment">-- one of the un-substituted tyvars is (a::k), we'd better</span><span>
</span><span id="line-3041"></span><span>                </span><span class="hs-comment">-- be sure to apply the current substitution to a's kind.</span><span>
</span><span id="line-3042"></span><span>                </span><span class="hs-comment">-- Hence instFlexiX.   #13135 was an example.</span><span>
</span><span id="line-3043"></span><span>
</span><span id="line-3044"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#apartnessCheck"><span class="hs-identifier hs-type">apartnessCheck</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#substTys"><span class="hs-identifier hs-type">substTys</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044318"><span class="hs-identifier hs-type">subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044305"><span class="hs-identifier hs-type">branch_lhs_tys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683044300"><span class="hs-identifier hs-type">branch</span></a></span><span>
</span><span id="line-3045"></span><span>             </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#mkInjectivityEqns"><span class="hs-identifier hs-type">mkInjectivityEqns</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044285"><span class="hs-identifier hs-type">inj_args</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#substTy"><span class="hs-identifier hs-type">substTy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044318"><span class="hs-identifier hs-type">subst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683044305"><span class="hs-identifier hs-type">branch_lhs_tys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683044287"><span class="hs-identifier hs-type">lhs_tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3046"></span><span>                  </span><span class="hs-comment">-- NB: The fresh unification variables (from unsubstTvs) are on the left</span><span>
</span><span id="line-3047"></span><span>                  </span><span class="hs-comment">--     See Note [Improvement orientation]</span><span>
</span><span id="line-3048"></span><span>             </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3049"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3050"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TypeEqn] -&gt; TcS [TypeEqn]
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-3051"></span><span>
</span><span id="line-3052"></span><span>    </span><span id="local-6989586621683044309"><span class="annot"><span class="annottext">in_scope :: InScopeSet
</span><a href="#local-6989586621683044309"><span class="hs-identifier hs-var hs-var">in_scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCoVarSet -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#mkInScopeSet"><span class="hs-identifier hs-var">mkInScopeSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; TyCoVarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044288"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3053"></span><span>
</span><span id="line-3054"></span><span>
</span><span id="line-3055"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#improve_injective_wanted_famfam"><span class="hs-identifier hs-type">improve_injective_wanted_famfam</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Xi"><span class="hs-identifier hs-type">Xi</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#TypeEqn"><span class="hs-identifier hs-type">TypeEqn</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-3056"></span><span class="hs-comment">-- Interact with itself, specifically  F s1 s2 ~ F t1 t2</span><span>
</span><span id="line-3057"></span><span id="improve_injective_wanted_famfam"><span class="annot"><span class="annottext">improve_injective_wanted_famfam :: [Bool] -&gt; TyCon -&gt; [TcType] -&gt; TcType -&gt; [TypeEqn]
</span><a href="GHC.Tc.Solver.Equality.html#improve_injective_wanted_famfam"><span class="hs-identifier hs-var hs-var">improve_injective_wanted_famfam</span></a></span></span><span> </span><span id="local-6989586621683044323"><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621683044323"><span class="hs-identifier hs-var">inj_args</span></a></span></span><span> </span><span id="local-6989586621683044324"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044324"><span class="hs-identifier hs-var">fam_tc</span></a></span></span><span> </span><span id="local-6989586621683044325"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044325"><span class="hs-identifier hs-var">lhs_tys</span></a></span></span><span> </span><span id="local-6989586621683044326"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044326"><span class="hs-identifier hs-var">rhs_ty</span></a></span></span><span>
</span><span id="line-3058"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683044327"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044327"><span class="hs-identifier hs-var">tc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683044328"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044328"><span class="hs-identifier hs-var">rhs_tys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; TcType -&gt; Maybe (TyCon, [TcType])
TcType -&gt; Maybe (TyCon, [TcType])
</span><a href="GHC.Core.Type.html#tcSplitTyConApp_maybe"><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044326"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span>
</span><span id="line-3059"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044327"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; TyCon -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044324"><span class="hs-identifier hs-var">fam_tc</span></a></span><span>
</span><span id="line-3060"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Bool] -&gt; [TcType] -&gt; [TcType] -&gt; [TypeEqn]
</span><a href="GHC.Tc.Solver.Equality.html#mkInjectivityEqns"><span class="hs-identifier hs-var">mkInjectivityEqns</span></a></span><span> </span><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621683044323"><span class="hs-identifier hs-var">inj_args</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044325"><span class="hs-identifier hs-var">lhs_tys</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044328"><span class="hs-identifier hs-var">rhs_tys</span></a></span><span>
</span><span id="line-3061"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3062"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-3063"></span><span>
</span><span id="line-3064"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#mkInjectivityEqns"><span class="hs-identifier hs-type">mkInjectivityEqns</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#TypeEqn"><span class="hs-identifier hs-type">TypeEqn</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-3065"></span><span class="hs-comment">-- When F s1 s2 s3 ~ F t1 t2 t3, and F has injectivity info [True,False,True]</span><span>
</span><span id="line-3066"></span><span class="hs-comment">-- return the equations [Pair s1 t1, Pair s3 t3]</span><span>
</span><span id="line-3067"></span><span id="mkInjectivityEqns"><span class="annot"><span class="annottext">mkInjectivityEqns :: [Bool] -&gt; [TcType] -&gt; [TcType] -&gt; [TypeEqn]
</span><a href="GHC.Tc.Solver.Equality.html#mkInjectivityEqns"><span class="hs-identifier hs-var hs-var">mkInjectivityEqns</span></a></span></span><span> </span><span id="local-6989586621683044329"><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621683044329"><span class="hs-identifier hs-var">inj_args</span></a></span></span><span> </span><span id="local-6989586621683044330"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044330"><span class="hs-identifier hs-var">lhs_args</span></a></span></span><span> </span><span id="local-6989586621683044331"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044331"><span class="hs-identifier hs-var">rhs_args</span></a></span></span><span>
</span><span id="line-3068"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TypeEqn
forall a. a -&gt; a -&gt; Pair a
</span><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044332"><span class="hs-identifier hs-var">lhs_arg</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044333"><span class="hs-identifier hs-var">rhs_arg</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683044332"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044332"><span class="hs-identifier hs-var">lhs_arg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683044333"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044333"><span class="hs-identifier hs-var">rhs_arg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Bool] -&gt; [TcType] -&gt; [TcType] -&gt; [(Bool, TcType, TcType)]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><span class="hs-identifier hs-var">zip3</span></span><span> </span><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621683044329"><span class="hs-identifier hs-var">inj_args</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044330"><span class="hs-identifier hs-var">lhs_args</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044331"><span class="hs-identifier hs-var">rhs_args</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-3069"></span><span>
</span><span id="line-3070"></span><span class="hs-comment">---------------------------------------------</span><span>
</span><span id="line-3071"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#improveLocalFunEqs"><span class="hs-identifier hs-type">improveLocalFunEqs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.InertSet.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a></span><span>
</span><span id="line-3072"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span>   </span><span class="hs-comment">-- F args ~ rhs</span><span>
</span><span id="line-3073"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-3074"></span><span class="hs-comment">-- Emit equalities from interaction between two equalities</span><span>
</span><span id="line-3075"></span><span id="improveLocalFunEqs"><span class="annot"><span class="annottext">improveLocalFunEqs :: InertCans -&gt; TyCon -&gt; [TcType] -&gt; EqCt -&gt; TcS Bool
</span><a href="GHC.Tc.Solver.Equality.html#improveLocalFunEqs"><span class="hs-identifier hs-var hs-var">improveLocalFunEqs</span></a></span></span><span> </span><span id="local-6989586621683044335"><span class="annot"><span class="annottext">InertCans
</span><a href="#local-6989586621683044335"><span class="hs-identifier hs-var">inerts</span></a></span></span><span> </span><span id="local-6989586621683044336"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044336"><span class="hs-identifier hs-var">fam_tc</span></a></span></span><span> </span><span id="local-6989586621683044337"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044337"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">eq_ev :: EqCt -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#eq_ev"><span class="hs-identifier hs-var">eq_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044338"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044338"><span class="hs-identifier hs-var">work_ev</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">eq_rhs :: EqCt -&gt; TcType
</span><a href="GHC.Tc.Types.Constraint.html#eq_rhs"><span class="hs-identifier hs-var">eq_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044339"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044339"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3076"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isGiven"><span class="hs-identifier hs-var">isGiven</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044338"><span class="hs-identifier hs-var">work_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[EqCt] -&gt; TyCon -&gt; [TcType] -&gt; CtEvidence -&gt; TcType -&gt; TcS Bool
</span><a href="GHC.Tc.Solver.Equality.html#improveGivenLocalFunEqs"><span class="hs-identifier hs-var">improveGivenLocalFunEqs</span></a></span><span>  </span><span class="annot"><span class="annottext">[EqCt]
</span><a href="#local-6989586621683044341"><span class="hs-identifier hs-var">funeqs_for_tc</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044336"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044337"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044338"><span class="hs-identifier hs-var">work_ev</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044339"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-3077"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[EqCt] -&gt; TyCon -&gt; [TcType] -&gt; CtEvidence -&gt; TcType -&gt; TcS Bool
</span><a href="GHC.Tc.Solver.Equality.html#improveWantedLocalFunEqs"><span class="hs-identifier hs-var">improveWantedLocalFunEqs</span></a></span><span> </span><span class="annot"><span class="annottext">[EqCt]
</span><a href="#local-6989586621683044341"><span class="hs-identifier hs-var">funeqs_for_tc</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044336"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044337"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044338"><span class="hs-identifier hs-var">work_ev</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044339"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-3078"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3079"></span><span>    </span><span id="local-6989586621683044343"><span class="annot"><span class="annottext">funeqs :: InertFunEqs
</span><a href="#local-6989586621683044343"><span class="hs-identifier hs-var hs-var">funeqs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InertCans -&gt; InertFunEqs
</span><a href="GHC.Tc.Solver.InertSet.html#inert_funeqs"><span class="hs-identifier hs-var">inert_funeqs</span></a></span><span> </span><span class="annot"><span class="annottext">InertCans
</span><a href="#local-6989586621683044335"><span class="hs-identifier hs-var">inerts</span></a></span><span>
</span><span id="line-3080"></span><span>    </span><span class="annot"><a href="#local-6989586621683044341"><span class="hs-identifier hs-type">funeqs_for_tc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- Mixture of Given and Wanted</span><span>
</span><span id="line-3081"></span><span>    </span><span id="local-6989586621683044341"><span class="annot"><span class="annottext">funeqs_for_tc :: [EqCt]
</span><a href="#local-6989586621683044341"><span class="hs-identifier hs-var hs-var">funeqs_for_tc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EqCt
</span><a href="#local-6989586621683044345"><span class="hs-identifier hs-var">funeq_ct</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621683044346"><span class="annot"><span class="annottext">[EqCt]
</span><a href="#local-6989586621683044346"><span class="hs-identifier hs-var">equal_ct_list</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InertFunEqs -&gt; TyCon -&gt; [[EqCt]]
forall a. FunEqMap a -&gt; TyCon -&gt; [a]
</span><a href="GHC.Tc.Solver.Types.html#findFunEqsByTyCon"><span class="hs-identifier hs-var">findFunEqsByTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">InertFunEqs
</span><a href="#local-6989586621683044343"><span class="hs-identifier hs-var">funeqs</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044336"><span class="hs-identifier hs-var">fam_tc</span></a></span><span>
</span><span id="line-3082"></span><span>                               </span><span class="hs-special">,</span><span> </span><span id="local-6989586621683044345"><span class="annot"><span class="annottext">EqCt
</span><a href="#local-6989586621683044345"><span class="hs-identifier hs-var">funeq_ct</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[EqCt]
</span><a href="#local-6989586621683044346"><span class="hs-identifier hs-var">equal_ct_list</span></a></span><span>
</span><span id="line-3083"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#NomEq"><span class="hs-identifier hs-var">NomEq</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; EqRel -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">EqCt -&gt; EqRel
</span><a href="GHC.Tc.Types.Constraint.html#eq_eq_rel"><span class="hs-identifier hs-var">eq_eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">EqCt
</span><a href="#local-6989586621683044345"><span class="hs-identifier hs-var">funeq_ct</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-3084"></span><span>                                  </span><span class="hs-comment">-- Representational equalities don't interact</span><span>
</span><span id="line-3085"></span><span>                                  </span><span class="hs-comment">-- with type family dependencies</span><span>
</span><span id="line-3086"></span><span>
</span><span id="line-3087"></span><span>
</span><span id="line-3088"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#improveGivenLocalFunEqs"><span class="hs-identifier hs-type">improveGivenLocalFunEqs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- Inert items, mixture of Given and Wanted</span><span>
</span><span id="line-3089"></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Xi"><span class="hs-identifier hs-type">Xi</span></a></span><span>  </span><span class="hs-comment">-- Work item (Given)</span><span>
</span><span id="line-3090"></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>  </span><span class="hs-comment">-- Always False (no unifications)</span><span>
</span><span id="line-3091"></span><span class="hs-comment">-- Emit equalities from interaction between two Given type-family equalities</span><span>
</span><span id="line-3092"></span><span class="hs-comment">--    e.g.    (x+y1~z, x+y2~z) =&gt; (y1 ~ y2)</span><span>
</span><span id="line-3093"></span><span id="improveGivenLocalFunEqs"><span class="annot"><span class="annottext">improveGivenLocalFunEqs :: [EqCt] -&gt; TyCon -&gt; [TcType] -&gt; CtEvidence -&gt; TcType -&gt; TcS Bool
</span><a href="GHC.Tc.Solver.Equality.html#improveGivenLocalFunEqs"><span class="hs-identifier hs-var hs-var">improveGivenLocalFunEqs</span></a></span></span><span> </span><span id="local-6989586621683044347"><span class="annot"><span class="annottext">[EqCt]
</span><a href="#local-6989586621683044347"><span class="hs-identifier hs-var">funeqs_for_tc</span></a></span></span><span> </span><span id="local-6989586621683044348"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044348"><span class="hs-identifier hs-var">fam_tc</span></a></span></span><span> </span><span id="local-6989586621683044349"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044349"><span class="hs-identifier hs-var">work_args</span></a></span></span><span> </span><span id="local-6989586621683044350"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044350"><span class="hs-identifier hs-var">work_ev</span></a></span></span><span> </span><span id="local-6989586621683044351"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044351"><span class="hs-identifier hs-var">work_rhs</span></a></span></span><span>
</span><span id="line-3094"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683044352"><span class="annot"><span class="annottext">BuiltInSynFamily
</span><a href="#local-6989586621683044352"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Maybe BuiltInSynFamily
</span><a href="GHC.Core.TyCon.html#isBuiltInSynFamTyCon_maybe"><span class="hs-identifier hs-var">isBuiltInSynFamTyCon_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044348"><span class="hs-identifier hs-var">fam_tc</span></a></span><span>
</span><span id="line-3095"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">(EqCt -&gt; TcS ()) -&gt; [EqCt] -&gt; TcS ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BuiltInSynFamily -&gt; EqCt -&gt; TcS ()
</span><a href="#local-6989586621683044354"><span class="hs-identifier hs-var">do_one</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltInSynFamily
</span><a href="#local-6989586621683044352"><span class="hs-identifier hs-var">ops</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[EqCt]
</span><a href="#local-6989586621683044347"><span class="hs-identifier hs-var">funeqs_for_tc</span></a></span><span>
</span><span id="line-3096"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcS Bool
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-special">}</span><span>     </span><span class="hs-comment">-- False: no unifications</span><span>
</span><span id="line-3097"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3098"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcS Bool
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-3099"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3100"></span><span>    </span><span id="local-6989586621683044355"><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683044355"><span class="hs-identifier hs-var">given_co</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CtEvidence -&gt; TcCoercion
CtEvidence -&gt; TcCoercion
</span><a href="GHC.Tc.Types.Constraint.html#ctEvCoercion"><span class="hs-identifier hs-var">ctEvCoercion</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044350"><span class="hs-identifier hs-var">work_ev</span></a></span><span>
</span><span id="line-3101"></span><span>
</span><span id="line-3102"></span><span>    </span><span class="annot"><a href="#local-6989586621683044354"><span class="hs-identifier hs-type">do_one</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#BuiltInSynFamily"><span class="hs-identifier hs-type">BuiltInSynFamily</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-3103"></span><span>    </span><span class="hs-comment">-- Used only work-item is Given</span><span>
</span><span id="line-3104"></span><span>    </span><span id="local-6989586621683044354"><span class="annot"><span class="annottext">do_one :: BuiltInSynFamily -&gt; EqCt -&gt; TcS ()
</span><a href="#local-6989586621683044354"><span class="hs-identifier hs-var hs-var">do_one</span></a></span></span><span> </span><span id="local-6989586621683044356"><span class="annot"><span class="annottext">BuiltInSynFamily
</span><a href="#local-6989586621683044356"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">eq_ev :: EqCt -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#eq_ev"><span class="hs-identifier hs-var">eq_ev</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044357"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044357"><span class="hs-identifier hs-var">inert_ev</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">eq_lhs :: EqCt -&gt; CanEqLHS
</span><a href="GHC.Tc.Types.Constraint.html#eq_lhs"><span class="hs-identifier hs-var">eq_lhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044358"><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683044358"><span class="hs-identifier hs-var">inert_lhs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">eq_rhs :: EqCt -&gt; TcType
</span><a href="GHC.Tc.Types.Constraint.html#eq_rhs"><span class="hs-identifier hs-var">eq_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044359"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044359"><span class="hs-identifier hs-var">inert_rhs</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3105"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isGiven"><span class="hs-identifier hs-var">isGiven</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044357"><span class="hs-identifier hs-var">inert_ev</span></a></span><span>                    </span><span class="hs-comment">-- Given/Given interaction</span><span>
</span><span id="line-3106"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#TyFamLHS"><span class="hs-identifier hs-type">TyFamLHS</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683044360"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044360"><span class="hs-identifier hs-var">inert_args</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683044358"><span class="hs-identifier hs-var">inert_lhs</span></a></span><span>  </span><span class="hs-comment">-- Inert item is F inert_args ~ inert_rhs</span><span>
</span><span id="line-3107"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044351"><span class="hs-identifier hs-var">work_rhs</span></a></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; TcType -&gt; TcType -&gt; Bool
TcType -&gt; TcType -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#tcEqType"><span class="hs-operator hs-var">`tcEqType`</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044359"><span class="hs-identifier hs-var">inert_rhs</span></a></span><span>       </span><span class="hs-comment">-- Both RHSs are the same</span><span>
</span><span id="line-3108"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- So we have work_ev  : F work_args  ~ rhs</span><span>
</span><span id="line-3109"></span><span>        </span><span class="hs-comment">--            inert_ev : F inert_args ~ rhs</span><span>
</span><span id="line-3110"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621683044361"><span class="hs-identifier hs-type">pairs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxiomRule"><span class="hs-identifier hs-type">CoAxiomRule</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#TypeEqn"><span class="hs-identifier hs-type">TypeEqn</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-3111"></span><span>            </span><span id="local-6989586621683044361"><span class="annot"><span class="annottext">pairs :: [(CoAxiomRule, TypeEqn)]
</span><a href="#local-6989586621683044361"><span class="hs-identifier hs-var hs-var">pairs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BuiltInSynFamily
-&gt; TyCon -&gt; [TcType] -&gt; [TcType] -&gt; [(CoAxiomRule, TypeEqn)]
</span><a href="GHC.Builtin.Types.Literals.html#tryInteractInertFam"><span class="hs-identifier hs-var">tryInteractInertFam</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltInSynFamily
</span><a href="#local-6989586621683044356"><span class="hs-identifier hs-var">ops</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044348"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044349"><span class="hs-identifier hs-var">work_args</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044360"><span class="hs-identifier hs-var">inert_args</span></a></span><span>
</span><span id="line-3112"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(CoAxiomRule, TypeEqn)] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[(CoAxiomRule, TypeEqn)]
</span><a href="#local-6989586621683044361"><span class="hs-identifier hs-var">pairs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3113"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;improveGivenLocalFunEqs&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044348"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044349"><span class="hs-identifier hs-var">work_args</span></a></span><span>
</span><span id="line-3114"></span><span>                                                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;work_ev&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span>  </span><span class="annot"><span class="annottext">CtEvidence -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044350"><span class="hs-identifier hs-var">work_ev</span></a></span><span>
</span><span id="line-3115"></span><span>                                                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;inert_ev&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044357"><span class="hs-identifier hs-var">inert_ev</span></a></span><span>
</span><span id="line-3116"></span><span>                                                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044351"><span class="hs-identifier hs-var">work_rhs</span></a></span><span>
</span><span id="line-3117"></span><span>                                                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(CoAxiomRule, TypeEqn)] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[(CoAxiomRule, TypeEqn)]
</span><a href="#local-6989586621683044361"><span class="hs-identifier hs-var">pairs</span></a></span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-3118"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; [(Role, TcCoercion)] -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#emitNewGivens"><span class="hs-identifier hs-var">emitNewGivens</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044357"><span class="hs-identifier hs-var">inert_ev</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((CoAxiomRule, TypeEqn) -&gt; (Role, TcCoercion))
-&gt; [(CoAxiomRule, TypeEqn)] -&gt; [(Role, TcCoercion)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(CoAxiomRule, TypeEqn) -&gt; (Role, TcCoercion)
</span><a href="#local-6989586621683044362"><span class="hs-identifier hs-var">mk_ax_co</span></a></span><span> </span><span class="annot"><span class="annottext">[(CoAxiomRule, TypeEqn)]
</span><a href="#local-6989586621683044361"><span class="hs-identifier hs-var">pairs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3119"></span><span>             </span><span class="hs-comment">-- This CtLoc for the new Givens doesn't reflect the</span><span>
</span><span id="line-3120"></span><span>             </span><span class="hs-comment">-- fact that it's a combination of Givens, but I don't</span><span>
</span><span id="line-3121"></span><span>             </span><span class="hs-comment">-- this that matters.</span><span>
</span><span id="line-3122"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-3123"></span><span>        </span><span id="local-6989586621683044363"><span class="annot"><span class="annottext">inert_co :: TcCoercion
</span><a href="#local-6989586621683044363"><span class="hs-identifier hs-var hs-var">inert_co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CtEvidence -&gt; TcCoercion
CtEvidence -&gt; TcCoercion
</span><a href="GHC.Tc.Types.Constraint.html#ctEvCoercion"><span class="hs-identifier hs-var">ctEvCoercion</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044357"><span class="hs-identifier hs-var">inert_ev</span></a></span><span>
</span><span id="line-3124"></span><span>        </span><span id="local-6989586621683044362"><span class="annot"><span class="annottext">mk_ax_co :: (CoAxiomRule, TypeEqn) -&gt; (Role, TcCoercion)
</span><a href="#local-6989586621683044362"><span class="hs-identifier hs-var hs-var">mk_ax_co</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683044364"><span class="annot"><span class="annottext">CoAxiomRule
</span><a href="#local-6989586621683044364"><span class="hs-identifier hs-var">ax</span></a></span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">TypeEqn
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoAxiomRule -&gt; [TcCoercion] -&gt; TcCoercion
</span><a href="GHC.Core.Coercion.html#mkAxiomCo"><span class="hs-identifier hs-var">mkAxiomCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiomRule
</span><a href="#local-6989586621683044364"><span class="hs-identifier hs-var">ax</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683044365"><span class="hs-identifier hs-var">combined_co</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-3125"></span><span>          </span><span class="hs-keyword">where</span><span>
</span><span id="line-3126"></span><span>            </span><span id="local-6989586621683044365"><span class="annot"><span class="annottext">combined_co :: TcCoercion
</span><a href="#local-6989586621683044365"><span class="hs-identifier hs-var hs-var">combined_co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683044355"><span class="hs-identifier hs-var">given_co</span></a></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; TcCoercion -&gt; TcCoercion -&gt; TcCoercion
TcCoercion -&gt; TcCoercion -&gt; TcCoercion
</span><a href="GHC.Core.Coercion.html#mkTransCo"><span class="hs-operator hs-var">`mkTransCo`</span></a></span><span> </span><span class="annot"><span class="annottext">TcCoercion -&gt; TcCoercion
</span><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a></span><span> </span><span class="annot"><span class="annottext">TcCoercion
</span><a href="#local-6989586621683044363"><span class="hs-identifier hs-var">inert_co</span></a></span><span>
</span><span id="line-3127"></span><span>            </span><span class="hs-comment">-- given_co :: F work_args  ~ rhs</span><span>
</span><span id="line-3128"></span><span>            </span><span class="hs-comment">-- inert_co :: F inert_args ~ rhs</span><span>
</span><span id="line-3129"></span><span>            </span><span class="hs-comment">-- the_co :: F work_args ~ F inert_args</span><span>
</span><span id="line-3130"></span><span>
</span><span id="line-3131"></span><span>    </span><span class="annot"><a href="#local-6989586621683044354"><span class="hs-identifier hs-var">do_one</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltInSynFamily
</span><span class="hs-identifier">_</span></span><span>  </span><span class="annot"><span class="annottext">EqCt
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcS ()
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-3132"></span><span>
</span><span id="line-3133"></span><span class="annot"><a href="GHC.Tc.Solver.Equality.html#improveWantedLocalFunEqs"><span class="hs-identifier hs-type">improveWantedLocalFunEqs</span></a></span><span>
</span><span id="line-3134"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span class="hs-special">]</span><span>     </span><span class="hs-comment">-- Inert items (Given and Wanted)</span><span>
</span><span id="line-3135"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Xi"><span class="hs-identifier hs-type">Xi</span></a></span><span>  </span><span class="hs-comment">-- Work item (Wanted)</span><span>
</span><span id="line-3136"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>   </span><span class="hs-comment">-- True &lt;=&gt; some unifications</span><span>
</span><span id="line-3137"></span><span class="hs-comment">-- Emit improvement equalities for a Wanted constraint, by comparing</span><span>
</span><span id="line-3138"></span><span class="hs-comment">-- the current work item with inert CFunEqs (boh Given and Wanted)</span><span>
</span><span id="line-3139"></span><span class="hs-comment">-- E.g.   x + y ~ z,   x + y' ~ z   =&gt;   [W] y ~ y'</span><span>
</span><span id="line-3140"></span><span class="hs-comment">--</span><span>
</span><span id="line-3141"></span><span class="hs-comment">-- See Note [FunDep and implicit parameter reactions]</span><span>
</span><span id="line-3142"></span><span id="improveWantedLocalFunEqs"><span class="annot"><span class="annottext">improveWantedLocalFunEqs :: [EqCt] -&gt; TyCon -&gt; [TcType] -&gt; CtEvidence -&gt; TcType -&gt; TcS Bool
</span><a href="GHC.Tc.Solver.Equality.html#improveWantedLocalFunEqs"><span class="hs-identifier hs-var hs-var">improveWantedLocalFunEqs</span></a></span></span><span> </span><span id="local-6989586621683044366"><span class="annot"><span class="annottext">[EqCt]
</span><a href="#local-6989586621683044366"><span class="hs-identifier hs-var">funeqs_for_tc</span></a></span></span><span> </span><span id="local-6989586621683044367"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044367"><span class="hs-identifier hs-var">fam_tc</span></a></span></span><span> </span><span id="local-6989586621683044368"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044368"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621683044369"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044369"><span class="hs-identifier hs-var">work_ev</span></a></span></span><span> </span><span id="local-6989586621683044370"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044370"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-3143"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[FunDepEqn (CtLoc, RewriterSet)] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[FunDepEqn (CtLoc, RewriterSet)]
</span><a href="#local-6989586621683044371"><span class="hs-identifier hs-var">improvement_eqns</span></a></span><span>
</span><span id="line-3144"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcS Bool
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-3145"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3146"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;interactFunEq improvements: &quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcS ()) -&gt; SDoc -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-3147"></span><span>                   </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Eqns:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[FunDepEqn (CtLoc, RewriterSet)] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[FunDepEqn (CtLoc, RewriterSet)]
</span><a href="#local-6989586621683044371"><span class="hs-identifier hs-var">improvement_eqns</span></a></span><span>
</span><span id="line-3148"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Candidates:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[EqCt] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[EqCt]
</span><a href="#local-6989586621683044366"><span class="hs-identifier hs-var">funeqs_for_tc</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-3149"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; [FunDepEqn (CtLoc, RewriterSet)] -&gt; TcS Bool
</span><a href="GHC.Tc.Solver.Monad.html#emitFunDepWanteds"><span class="hs-identifier hs-var">emitFunDepWanteds</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044369"><span class="hs-identifier hs-var">work_ev</span></a></span><span> </span><span class="annot"><span class="annottext">[FunDepEqn (CtLoc, RewriterSet)]
</span><a href="#local-6989586621683044371"><span class="hs-identifier hs-var">improvement_eqns</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3150"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3151"></span><span>    </span><span id="local-6989586621683044373"><span class="annot"><span class="annottext">work_loc :: CtLoc
</span><a href="#local-6989586621683044373"><span class="hs-identifier hs-var hs-var">work_loc</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044369"><span class="hs-identifier hs-var">work_ev</span></a></span><span>
</span><span id="line-3152"></span><span>    </span><span id="local-6989586621683044374"><span class="annot"><span class="annottext">work_pred :: TcType
</span><a href="#local-6989586621683044374"><span class="hs-identifier hs-var hs-var">work_pred</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; TcType
</span><a href="GHC.Tc.Types.Constraint.html#ctEvPred"><span class="hs-identifier hs-var">ctEvPred</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044369"><span class="hs-identifier hs-var">work_ev</span></a></span><span>
</span><span id="line-3153"></span><span>    </span><span id="local-6989586621683044375"><span class="annot"><span class="annottext">fam_inj_info :: Injectivity
</span><a href="#local-6989586621683044375"><span class="hs-identifier hs-var hs-var">fam_inj_info</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Injectivity
</span><a href="GHC.Core.TyCon.html#tyConInjectivityInfo"><span class="hs-identifier hs-var">tyConInjectivityInfo</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044367"><span class="hs-identifier hs-var">fam_tc</span></a></span><span>
</span><span id="line-3154"></span><span>
</span><span id="line-3155"></span><span>    </span><span class="hs-comment">--------------------</span><span>
</span><span id="line-3156"></span><span>    </span><span class="annot"><a href="#local-6989586621683044371"><span class="hs-identifier hs-type">improvement_eqns</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Instance.FunDeps.html#FunDepEqn"><span class="hs-identifier hs-type">FunDepEqn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.CtLoc.html#CtLoc"><span class="hs-identifier hs-type">CtLoc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#RewriterSet"><span class="hs-identifier hs-type">RewriterSet</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-3157"></span><span>    </span><span id="local-6989586621683044371"><span class="annot"><span class="annottext">improvement_eqns :: [FunDepEqn (CtLoc, RewriterSet)]
</span><a href="#local-6989586621683044371"><span class="hs-identifier hs-var hs-var">improvement_eqns</span></a></span></span><span>
</span><span id="line-3158"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683044376"><span class="annot"><span class="annottext">BuiltInSynFamily
</span><a href="#local-6989586621683044376"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Maybe BuiltInSynFamily
</span><a href="GHC.Core.TyCon.html#isBuiltInSynFamTyCon_maybe"><span class="hs-identifier hs-var">isBuiltInSynFamTyCon_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044367"><span class="hs-identifier hs-var">fam_tc</span></a></span><span>
</span><span id="line-3159"></span><span>      </span><span class="hs-glyph">=</span><span>    </span><span class="hs-comment">-- Try built-in families, notably for arithmethic</span><span>
</span><span id="line-3160"></span><span>        </span><span class="annot"><span class="annottext">(EqCt -&gt; [FunDepEqn (CtLoc, RewriterSet)])
-&gt; [EqCt] -&gt; [FunDepEqn (CtLoc, RewriterSet)]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BuiltInSynFamily
-&gt; TcType -&gt; EqCt -&gt; [FunDepEqn (CtLoc, RewriterSet)]
</span><a href="#local-6989586621683044377"><span class="hs-identifier hs-var">do_one_built_in</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltInSynFamily
</span><a href="#local-6989586621683044376"><span class="hs-identifier hs-var">ops</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044370"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[EqCt]
</span><a href="#local-6989586621683044366"><span class="hs-identifier hs-var">funeqs_for_tc</span></a></span><span>
</span><span id="line-3161"></span><span>
</span><span id="line-3162"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#Injective"><span class="hs-identifier hs-type">Injective</span></a></span><span> </span><span id="local-6989586621683044378"><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621683044378"><span class="hs-identifier hs-var">injective_args</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Injectivity
</span><a href="#local-6989586621683044375"><span class="hs-identifier hs-var">fam_inj_info</span></a></span><span>
</span><span id="line-3163"></span><span>      </span><span class="hs-glyph">=</span><span>    </span><span class="hs-comment">-- Try improvement from type families with injectivity annotations</span><span>
</span><span id="line-3164"></span><span>        </span><span class="annot"><span class="annottext">(EqCt -&gt; [FunDepEqn (CtLoc, RewriterSet)])
-&gt; [EqCt] -&gt; [FunDepEqn (CtLoc, RewriterSet)]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Bool] -&gt; TcType -&gt; EqCt -&gt; [FunDepEqn (CtLoc, RewriterSet)]
</span><a href="#local-6989586621683044379"><span class="hs-identifier hs-var">do_one_injective</span></a></span><span> </span><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621683044378"><span class="hs-identifier hs-var">injective_args</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044370"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[EqCt]
</span><a href="#local-6989586621683044366"><span class="hs-identifier hs-var">funeqs_for_tc</span></a></span><span>
</span><span id="line-3165"></span><span>
</span><span id="line-3166"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3167"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-3168"></span><span>
</span><span id="line-3169"></span><span>    </span><span class="hs-comment">--------------------</span><span>
</span><span id="line-3170"></span><span>    </span><span id="local-6989586621683044377"><span class="annot"><span class="annottext">do_one_built_in :: BuiltInSynFamily
-&gt; TcType -&gt; EqCt -&gt; [FunDepEqn (CtLoc, RewriterSet)]
</span><a href="#local-6989586621683044377"><span class="hs-identifier hs-var hs-var">do_one_built_in</span></a></span></span><span> </span><span id="local-6989586621683044380"><span class="annot"><span class="annottext">BuiltInSynFamily
</span><a href="#local-6989586621683044380"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span id="local-6989586621683044381"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044381"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">eq_lhs :: EqCt -&gt; CanEqLHS
</span><a href="GHC.Tc.Types.Constraint.html#eq_lhs"><span class="hs-identifier hs-var">eq_lhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#TyFamLHS"><span class="hs-identifier hs-type">TyFamLHS</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683044382"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044382"><span class="hs-identifier hs-var">iargs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">eq_rhs :: EqCt -&gt; TcType
</span><a href="GHC.Tc.Types.Constraint.html#eq_rhs"><span class="hs-identifier hs-var">eq_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044383"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044383"><span class="hs-identifier hs-var">irhs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">eq_ev :: EqCt -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#eq_ev"><span class="hs-identifier hs-var">eq_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044384"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044384"><span class="hs-identifier hs-var">inert_ev</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3171"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044383"><span class="hs-identifier hs-var">irhs</span></a></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; TcType -&gt; TcType -&gt; Bool
TcType -&gt; TcType -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#tcEqType"><span class="hs-operator hs-var">`tcEqType`</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044381"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-3172"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; [TypeEqn] -&gt; [FunDepEqn (CtLoc, RewriterSet)]
</span><a href="#local-6989586621683044385"><span class="hs-identifier hs-var">mk_fd_eqns</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044384"><span class="hs-identifier hs-var">inert_ev</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((CoAxiomRule, TypeEqn) -&gt; TypeEqn)
-&gt; [(CoAxiomRule, TypeEqn)] -&gt; [TypeEqn]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(CoAxiomRule, TypeEqn) -&gt; TypeEqn
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">([(CoAxiomRule, TypeEqn)] -&gt; [TypeEqn])
-&gt; [(CoAxiomRule, TypeEqn)] -&gt; [TypeEqn]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BuiltInSynFamily
-&gt; TyCon -&gt; [TcType] -&gt; [TcType] -&gt; [(CoAxiomRule, TypeEqn)]
</span><a href="GHC.Builtin.Types.Literals.html#tryInteractInertFam"><span class="hs-identifier hs-var">tryInteractInertFam</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltInSynFamily
</span><a href="#local-6989586621683044380"><span class="hs-identifier hs-var">ops</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044367"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044368"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044382"><span class="hs-identifier hs-var">iargs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3173"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3174"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-3175"></span><span>    </span><span class="annot"><a href="#local-6989586621683044377"><span class="hs-identifier hs-var">do_one_built_in</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltInSynFamily
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TcType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">EqCt
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; [FunDepEqn (CtLoc, RewriterSet)]
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;interactFunEq 1&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044367"><span class="hs-identifier hs-var">fam_tc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- TyVarLHS</span><span>
</span><span id="line-3176"></span><span>
</span><span id="line-3177"></span><span>    </span><span class="hs-comment">--------------------</span><span>
</span><span id="line-3178"></span><span>    </span><span class="hs-comment">-- See Note [Type inference for type families with injectivity]</span><span>
</span><span id="line-3179"></span><span>    </span><span id="local-6989586621683044379"><span class="annot"><span class="annottext">do_one_injective :: [Bool] -&gt; TcType -&gt; EqCt -&gt; [FunDepEqn (CtLoc, RewriterSet)]
</span><a href="#local-6989586621683044379"><span class="hs-identifier hs-var hs-var">do_one_injective</span></a></span></span><span> </span><span id="local-6989586621683044386"><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621683044386"><span class="hs-identifier hs-var">inj_args</span></a></span></span><span> </span><span id="local-6989586621683044387"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044387"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#EqCt"><span class="hs-identifier hs-type">EqCt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">eq_lhs :: EqCt -&gt; CanEqLHS
</span><a href="GHC.Tc.Types.Constraint.html#eq_lhs"><span class="hs-identifier hs-var">eq_lhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#TyFamLHS"><span class="hs-identifier hs-type">TyFamLHS</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683044388"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044388"><span class="hs-identifier hs-var">inert_args</span></a></span></span><span>
</span><span id="line-3180"></span><span>                                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">eq_rhs :: EqCt -&gt; TcType
</span><a href="GHC.Tc.Types.Constraint.html#eq_rhs"><span class="hs-identifier hs-var">eq_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044389"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044389"><span class="hs-identifier hs-var">irhs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">eq_ev :: EqCt -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#eq_ev"><span class="hs-identifier hs-var">eq_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683044390"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044390"><span class="hs-identifier hs-var">inert_ev</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3181"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044387"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; TcType -&gt; TcType -&gt; Bool
TcType -&gt; TcType -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#tcEqType"><span class="hs-operator hs-var">`tcEqType`</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044389"><span class="hs-identifier hs-var">irhs</span></a></span><span>
</span><span id="line-3182"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; [TypeEqn] -&gt; [FunDepEqn (CtLoc, RewriterSet)]
</span><a href="#local-6989586621683044385"><span class="hs-identifier hs-var">mk_fd_eqns</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044390"><span class="hs-identifier hs-var">inert_ev</span></a></span><span> </span><span class="annot"><span class="annottext">([TypeEqn] -&gt; [FunDepEqn (CtLoc, RewriterSet)])
-&gt; [TypeEqn] -&gt; [FunDepEqn (CtLoc, RewriterSet)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Bool] -&gt; [TcType] -&gt; [TcType] -&gt; [TypeEqn]
</span><a href="GHC.Tc.Solver.Equality.html#mkInjectivityEqns"><span class="hs-identifier hs-var">mkInjectivityEqns</span></a></span><span> </span><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621683044386"><span class="hs-identifier hs-var">inj_args</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044368"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683044388"><span class="hs-identifier hs-var">inert_args</span></a></span><span>
</span><span id="line-3183"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3184"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-3185"></span><span>
</span><span id="line-3186"></span><span>    </span><span class="annot"><a href="#local-6989586621683044379"><span class="hs-identifier hs-var">do_one_injective</span></a></span><span> </span><span class="annot"><span class="annottext">[Bool]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TcType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">EqCt
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; [FunDepEqn (CtLoc, RewriterSet)]
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;interactFunEq 2&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683044367"><span class="hs-identifier hs-var">fam_tc</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- TyVarLHS</span><span>
</span><span id="line-3187"></span><span>
</span><span id="line-3188"></span><span>    </span><span class="hs-comment">--------------------</span><span>
</span><span id="line-3189"></span><span>    </span><span class="annot"><a href="#local-6989586621683044385"><span class="hs-identifier hs-type">mk_fd_eqns</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#TypeEqn"><span class="hs-identifier hs-type">TypeEqn</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Instance.FunDeps.html#FunDepEqn"><span class="hs-identifier hs-type">FunDepEqn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.CtLoc.html#CtLoc"><span class="hs-identifier hs-type">CtLoc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#RewriterSet"><span class="hs-identifier hs-type">RewriterSet</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-3190"></span><span>    </span><span id="local-6989586621683044385"><span class="annot"><span class="annottext">mk_fd_eqns :: CtEvidence -&gt; [TypeEqn] -&gt; [FunDepEqn (CtLoc, RewriterSet)]
</span><a href="#local-6989586621683044385"><span class="hs-identifier hs-var hs-var">mk_fd_eqns</span></a></span></span><span> </span><span id="local-6989586621683044391"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044391"><span class="hs-identifier hs-var">inert_ev</span></a></span></span><span> </span><span id="local-6989586621683044392"><span class="annot"><span class="annottext">[TypeEqn]
</span><a href="#local-6989586621683044392"><span class="hs-identifier hs-var">eqns</span></a></span></span><span>
</span><span id="line-3191"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[TypeEqn] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[TypeEqn]
</span><a href="#local-6989586621683044392"><span class="hs-identifier hs-var">eqns</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-3192"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Tc.Instance.FunDeps.html#FDEqn"><span class="hs-identifier hs-type">FDEqn</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fd_qtvs :: [TcTyVar]
</span><a href="GHC.Tc.Instance.FunDeps.html#fd_qtvs"><span class="hs-identifier hs-var">fd_qtvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fd_eqs :: [TypeEqn]
</span><a href="GHC.Tc.Instance.FunDeps.html#fd_eqs"><span class="hs-identifier hs-var">fd_eqs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TypeEqn]
</span><a href="#local-6989586621683044392"><span class="hs-identifier hs-var">eqns</span></a></span><span>
</span><span id="line-3193"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fd_loc :: (CtLoc, RewriterSet)
</span><a href="GHC.Tc.Instance.FunDeps.html#fd_loc"><span class="hs-identifier hs-var">fd_loc</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683044397"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RewriterSet
</span><a href="#local-6989586621683044398"><span class="hs-identifier hs-var">inert_rewriters</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-3194"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-3195"></span><span>        </span><span id="local-6989586621683044399"><span class="annot"><span class="annottext">initial_loc :: CtLoc
</span><a href="#local-6989586621683044399"><span class="hs-identifier hs-var hs-var">initial_loc</span></a></span></span><span>  </span><span class="hs-comment">-- start with the location of the Wanted involved</span><span>
</span><span id="line-3196"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isGiven"><span class="hs-identifier hs-var">isGiven</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044369"><span class="hs-identifier hs-var">work_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683044400"><span class="hs-identifier hs-var">inert_loc</span></a></span><span>
</span><span id="line-3197"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683044373"><span class="hs-identifier hs-var">work_loc</span></a></span><span>
</span><span id="line-3198"></span><span>        </span><span id="local-6989586621683044401"><span class="annot"><span class="annottext">eqn_orig :: CtOrigin
</span><a href="#local-6989586621683044401"><span class="hs-identifier hs-var hs-var">eqn_orig</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType
-&gt; CtOrigin
-&gt; RealSrcSpan
-&gt; TcType
-&gt; CtOrigin
-&gt; RealSrcSpan
-&gt; CtOrigin
</span><a href="GHC.Tc.Types.Origin.html#InjTFOrigin1"><span class="hs-identifier hs-var">InjTFOrigin1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044374"><span class="hs-identifier hs-var">work_pred</span></a></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtLoc -&gt; CtOrigin
</span><a href="GHC.Tc.Types.CtLoc.html#ctLocOrigin"><span class="hs-identifier hs-var">ctLocOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683044373"><span class="hs-identifier hs-var">work_loc</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtLoc -&gt; RealSrcSpan
</span><a href="GHC.Tc.Types.CtLoc.html#ctLocSpan"><span class="hs-identifier hs-var">ctLocSpan</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683044373"><span class="hs-identifier hs-var">work_loc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3199"></span><span>                                       </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683044404"><span class="hs-identifier hs-var">inert_pred</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtLoc -&gt; CtOrigin
</span><a href="GHC.Tc.Types.CtLoc.html#ctLocOrigin"><span class="hs-identifier hs-var">ctLocOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683044400"><span class="hs-identifier hs-var">inert_loc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtLoc -&gt; RealSrcSpan
</span><a href="GHC.Tc.Types.CtLoc.html#ctLocSpan"><span class="hs-identifier hs-var">ctLocSpan</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683044400"><span class="hs-identifier hs-var">inert_loc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3200"></span><span>        </span><span id="local-6989586621683044405"><span class="annot"><span class="annottext">eqn_loc :: CtLoc
</span><a href="#local-6989586621683044405"><span class="hs-identifier hs-var hs-var">eqn_loc</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; CtOrigin -&gt; CtLoc
</span><a href="GHC.Tc.Types.CtLoc.html#setCtLocOrigin"><span class="hs-identifier hs-var">setCtLocOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683044399"><span class="hs-identifier hs-var">initial_loc</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683044401"><span class="hs-identifier hs-var">eqn_orig</span></a></span><span>
</span><span id="line-3201"></span><span>        </span><span id="local-6989586621683044404"><span class="annot"><span class="annottext">inert_pred :: TcType
</span><a href="#local-6989586621683044404"><span class="hs-identifier hs-var hs-var">inert_pred</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; TcType
</span><a href="GHC.Tc.Types.Constraint.html#ctEvPred"><span class="hs-identifier hs-var">ctEvPred</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044391"><span class="hs-identifier hs-var">inert_ev</span></a></span><span>
</span><span id="line-3202"></span><span>        </span><span id="local-6989586621683044400"><span class="annot"><span class="annottext">inert_loc :: CtLoc
</span><a href="#local-6989586621683044400"><span class="hs-identifier hs-var hs-var">inert_loc</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044391"><span class="hs-identifier hs-var">inert_ev</span></a></span><span>
</span><span id="line-3203"></span><span>        </span><span id="local-6989586621683044398"><span class="annot"><span class="annottext">inert_rewriters :: RewriterSet
</span><a href="#local-6989586621683044398"><span class="hs-identifier hs-var hs-var">inert_rewriters</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; RewriterSet
</span><a href="GHC.Tc.Types.Constraint.html#ctEvRewriters"><span class="hs-identifier hs-var">ctEvRewriters</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683044391"><span class="hs-identifier hs-var">inert_ev</span></a></span><span>
</span><span id="line-3204"></span><span>        </span><span id="local-6989586621683044397"><span class="annot"><span class="annottext">loc :: CtLoc
</span><a href="#local-6989586621683044397"><span class="hs-identifier hs-var hs-var">loc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683044405"><span class="hs-identifier hs-var">eqn_loc</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.CtLoc.html#ctl_depth"><span class="hs-identifier hs-var">ctl_depth</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.CtLoc.html#ctl_depth"><span class="hs-identifier hs-var">ctl_depth</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044400"><span class="hs-identifier hs-type">inert_loc</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.CtLoc.html#maxSubGoalDepth"><span class="hs-operator hs-type">`maxSubGoalDepth`</span></a></span><span>
</span><span id="line-3205"></span><span>                                    </span><span class="annot"><a href="GHC.Tc.Types.CtLoc.html#ctl_depth"><span class="hs-identifier hs-var">ctl_depth</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683044373"><span class="hs-identifier hs-type">work_loc</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3206"></span><span>
</span><span id="line-3207"></span><span class="hs-comment">{- Note [Type inference for type families with injectivity]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have a type family with an injectivity annotation:
    type family F a b = r | r -&gt; b

Then if we have an equality like F s1 t1 ~ F s2 t2,
we can use the injectivity to get a new Wanted constraint on
the injective argument
  [W] t1 ~ t2

That in turn can help GHC solve constraints that would otherwise require
guessing.  For example, consider the ambiguity check for
   f :: F Int b -&gt; Int
We get the constraint
   [W] F Int b ~ F Int beta
where beta is a unification variable.  Injectivity lets us pick beta ~ b.

Injectivity information is also used at the call sites. For example:
   g = f True
gives rise to
   [W] F Int b ~ Bool
from which we can derive b.  This requires looking at the defining equations of
a type family, ie. finding equation with a matching RHS (Bool in this example)
and inferring values of type variables (b in this example) from the LHS patterns
of the matching equation.  For closed type families we have to perform
additional apartness check for the selected equation to check that the selected
is guaranteed to fire for given LHS arguments.

These new constraints are Wanted constraints, but we will not use the evidence.
We could go further and offer evidence from decomposing injective type-function
applications, but that would require new evidence forms, and an extension to
FC, so we don't do that right now (Dec 14).

We generate these Wanteds in three places, depending on how we notice the
injectivity.

1. When we have a [W] F tys1 ~ F tys2. This is handled in canEqCanLHS2, and
described in Note [Decomposing type family applications] in GHC.Tc.Solver.Equality

2. When we have [W] F tys1 ~ T and [W] F tys2 ~ T. Note that neither of these
constraints rewrites the other, as they have different LHSs. This is done
in improveLocalFunEqs, called during the interactWithInertsStage.

3. When we have [W] F tys ~ T and an equation for F that looks like F tys' = T.
This is done in improve_top_fun_eqs, called from the top-level reactions stage.

See also Note [Injective type families] in GHC.Core.TyCon

Note [Cache-caused loops]
~~~~~~~~~~~~~~~~~~~~~~~~~
It is very dangerous to cache a rewritten wanted family equation as 'solved' in our
solved cache (which is the default behaviour or xCtEvidence), because the interaction
may not be contributing towards a solution. Here is an example:

Initial inert set:
  [W] g1 : F a ~ beta1
Work item:
  [W] g2 : F a ~ beta2
The work item will react with the inert yielding the _same_ inert set plus:
    (i)   Will set g2 := g1 `cast` g3
    (ii)  Will add to our solved cache that [S] g2 : F a ~ beta2
    (iii) Will emit [W] g3 : beta1 ~ beta2
Now, the g3 work item will be spontaneously solved to [G] g3 : beta1 ~ beta2
and then it will react the item in the inert ([W] g1 : F a ~ beta1). So it
will set
      g1 := g ; sym g3
and what is g? Well it would ideally be a new goal of type (F a ~ beta2) but
remember that we have this in our solved cache, and it is ... g2! In short we
created the evidence loop:

        g2 := g1 ; g3
        g3 := refl
        g1 := g2 ; sym g3

To avoid this situation we do not cache as solved any workitems (or inert)
which did not really made a 'step' towards proving some goal. Solved's are
just an optimization so we don't lose anything in terms of completeness of
solving.
-}</span><span>
</span><span id="line-3286"></span></pre></body></html>