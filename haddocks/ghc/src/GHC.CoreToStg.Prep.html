<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ViewPatterns #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# OPTIONS_GHC -Wno-incomplete-uni-patterns #-}</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-comment">{-
(c) The University of Glasgow, 1994-2006


Core pass to saturate constructors and PrimOps
-}</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html"><span class="hs-identifier">GHC.CoreToStg.Prep</span></a></span><span>
</span><span id="line-13"></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepConfig"><span class="hs-identifier">CorePrepConfig</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepPgmConfig"><span class="hs-identifier">CorePrepPgmConfig</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#corePrepPgm"><span class="hs-identifier">corePrepPgm</span></a></span><span>
</span><span id="line-16"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#corePrepExpr"><span class="hs-identifier">corePrepExpr</span></a></span><span>
</span><span id="line-17"></span><span>   </span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">where</span><span>
</span><span id="line-19"></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-21"></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Platform.html"><span class="hs-identifier">GHC.Platform</span></a></span><span>
</span><span id="line-23"></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Flags.html"><span class="hs-identifier">GHC.Driver.Flags</span></a></span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.html"><span class="hs-identifier">GHC.Unit</span></a></span><span>
</span><span id="line-27"></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html"><span class="hs-identifier">GHC.Builtin.Names</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.PrimOps.html"><span class="hs-identifier">GHC.Builtin.PrimOps</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.PrimOps.Ids.html"><span class="hs-identifier">GHC.Builtin.PrimOps.Ids</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.html"><span class="hs-identifier">GHC.Builtin.Types</span></a></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.Prim.html"><span class="hs-identifier">GHC.Builtin.Types.Prim</span></a></span><span>
</span><span id="line-33"></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html"><span class="hs-identifier">GHC.Core.Utils</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html"><span class="hs-identifier">GHC.Core.Opt.Arity</span></a></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Lint.html"><span class="hs-identifier">GHC.Core.Lint</span></a></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Lint.html#EndPassConfig"><span class="hs-identifier">EndPassConfig</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Lint.html#endPassIO"><span class="hs-identifier">endPassIO</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.html"><span class="hs-identifier">GHC.Core</span></a></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html"><span class="hs-identifier">GHC.Core.Subst</span></a></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Make.html"><span class="hs-identifier">GHC.Core.Make</span></a></span><span> </span><span class="hs-keyword">hiding</span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Make.html#FloatBind"><span class="hs-identifier">FloatBind</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- We use our own FloatBind here</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Type.html"><span class="hs-identifier">GHC.Core.Type</span></a></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html"><span class="hs-identifier">GHC.Core.Coercion</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html"><span class="hs-identifier">GHC.Core.TyCon</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html"><span class="hs-identifier">GHC.Core.DataCon</span></a></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html"><span class="hs-identifier">GHC.Core.Opt.OccurAnal</span></a></span><span>
</span><span id="line-45"></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Maybe.html"><span class="hs-identifier">GHC.Data.Maybe</span></a></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.OrdList.html"><span class="hs-identifier">GHC.Data.OrdList</span></a></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html"><span class="hs-identifier">GHC.Data.FastString</span></a></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Graph.UnVar.html"><span class="hs-identifier">GHC.Data.Graph.UnVar</span></a></span><span>
</span><span id="line-50"></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Error.html"><span class="hs-identifier">GHC.Utils.Error</span></a></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Monad.html"><span class="hs-identifier">GHC.Utils.Monad</span></a></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Utils.Monad.html#mapAccumLM"><span class="hs-identifier">mapAccumLM</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html"><span class="hs-identifier">GHC.Utils.Logger</span></a></span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html"><span class="hs-identifier">GHC.Types.Demand</span></a></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.html"><span class="hs-identifier">GHC.Types.Var</span></a></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.html"><span class="hs-identifier">GHC.Types.Id</span></a></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.Info.html"><span class="hs-identifier">GHC.Types.Id.Info</span></a></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.Make.html"><span class="hs-identifier">GHC.Types.Id.Make</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Id.Make.html#realWorldPrimId"><span class="hs-identifier">realWorldPrimId</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html"><span class="hs-identifier">GHC.Types.Basic</span></a></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.html"><span class="hs-identifier">GHC.Types.Name</span></a></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#NamedThing"><span class="hs-identifier">NamedThing</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#nameSrcSpan"><span class="hs-identifier">nameSrcSpan</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#isInternalName"><span class="hs-identifier">isInternalName</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html"><span class="hs-identifier">GHC.Types.SrcLoc</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html#SrcSpan"><span class="hs-identifier">SrcSpan</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html#realSrcLocSpan"><span class="hs-identifier">realSrcLocSpan</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html#mkRealSrcLoc"><span class="hs-identifier">mkRealSrcLoc</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Literal.html"><span class="hs-identifier">GHC.Types.Literal</span></a></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Tickish.html"><span class="hs-identifier">GHC.Types.Tickish</span></a></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html"><span class="hs-identifier">GHC.Types.Unique.Supply</span></a></span><span>
</span><span id="line-69"></span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../bytestring-0.12.2.0-7dd0/src/Data.ByteString.html"><span class="hs-identifier">Data.ByteString</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../bytestring-0.12.2.0-7dd0/src/Data.ByteString.Builder.html"><span class="hs-identifier">Data.ByteString.Builder</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BB</span></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../bytestring-0.12.2.0-7dd0/src/Data.ByteString.Builder.Prim.html"><span class="hs-identifier">Data.ByteString.Builder.Prim</span></a></span><span>
</span><span id="line-73"></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span class="hs-comment">{-
Note [CorePrep Overview]
~~~~~~~~~~~~~~~~~~~~~~~~

The goal of this pass is to prepare for code generation.

1.  Saturate constructor and primop applications.

2.  Convert to A-normal form; that is, function arguments
    are always variables.

    * Use case for strict arguments:
        f E ==&gt; case E of x -&gt; f x
        (where f is strict)

    * Use let for non-trivial lazy arguments
        f E ==&gt; let x = E in f x
        (were f is lazy and x is non-trivial)

3.  Similarly, convert any unboxed lets into cases.
    [I'm experimenting with leaving 'ok-for-speculation'
     rhss in let-form right up to this point.]

4.  Ensure that *value* lambdas only occur as the RHS of a binding
    (The code generator can't deal with anything else.)
    Type lambdas are ok, however, because the code gen discards them.

5.  ANF-isation results in additional bindings that can obscure values.
    We float these out; see Note [Floating in CorePrep].

6.  Clone all local Ids.  See Note [Cloning in CorePrep]

7.  Give each dynamic CCall occurrence a fresh unique; this is
    rather like the cloning step above.

8.  Inject bindings for the &quot;implicit&quot; Ids:
        * Constructor wrappers
        * Constructor workers
    We want curried definitions for all of these in case they
    aren't inlined by some caller.

 9. Convert bignum literals into their core representation.

10. Uphold tick consistency while doing this: We move ticks out of
    (non-type) applications where we can, and make sure that we
    annotate according to scoping rules when floating.

11. Collect cost centres (including cost centres in unfoldings) if we're in
    profiling mode. We have to do this here because we won't have unfoldings
    after this pass (see `trimUnfolding` and Note [Drop unfoldings and rules].

12. Eliminate some magic Ids, specifically
     runRW# (\s. e)  ==&gt;  e[readWorldId/s]
             lazy e  ==&gt;  e (see Note [lazyId magic] in GHC.Types.Id.Make)
         noinline e  ==&gt;  e
           nospec e  ==&gt;  e
     ToDo:  keepAlive# ...
    This is done in cpeApp

This is all done modulo type applications and abstractions, so that
when type erasure is done for conversion to STG, we don't end up with
any trivial or useless bindings.

Note [CorePrep invariants]
~~~~~~~~~~~~~~~~~~~~~~~~~~
Here is the syntax of the Core produced by CorePrep:

    Trivial expressions
       arg ::= lit     |  var
            |  arg ty  |  /\a. arg
            |  co      |  arg |&gt; co

    Applications
       app ::= lit  |  var  |  app arg  |  app ty  |  app co  |  app |&gt; co

    Expressions
       body ::= app
             |  let(rec) x = rhs in body     -- Boxed only
             |  case body of pat -&gt; body
             |  /\a. body | /\c. body
             |  body |&gt; co

    Right hand sides (only place where value lambdas can occur)
       rhs ::= /\a.rhs  |  \x.rhs  |  body

We define a synonym for each of these non-terminals.  Functions
with the corresponding name produce a result in that syntax.

Note [Cloning in CorePrep]
~~~~~~~~~~~~~~~~~~~~~~~~~~
In CorePrep we
* Always clone non-CoVar Ids, so each has a unique Unique
* Sometimes clone CoVars and TyVars

We always clone non-CoVarIds, for three reasons

1. Things associated with labels in the final code must be truly unique in
   order to avoid labels being shadowed in the final output.

2. Even binders without info tables like function arguments or alternative
   bound binders must be unique at least in their type/unique combination.
   We only emit a single declaration for each binder when compiling to C
   so if binders are not unique we would either get duplicate declarations
   or misstyped variables. The later happend in #22402.

3. We heavily use unique-keyed maps in the backend which can go wrong when
   ids with the same unique are meant to represent the same variable.

Generally speaking we don't clone TyVars or CoVars. The code gen doesn't need
that (they are erased), and doing so would be tiresome because then we'd need
to substitute in types and coercions.  But sometimes need to: see
Note [Cloning CoVars and TyVars]

Note [Cloning CoVars and TyVars]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Normally we don't need to clone TyVars and CoVars, but there is one occasion
when we do (see #24463).  When we have
    case unsafeEqualityProof ... of UnsafeRefl g -&gt; ...
we try to float it, using UnsafeEqualityCase.
Why?  See (U3) in Note [Implementing unsafeCoerce]

Alas, floating it widens the scope of `g`, and that led to catastrophe in
#24463, when two identically-named g's shadowed.

Solution: clone `g`; see `cpCloneCoVarBndr`.

BUT once we clone `g` we must apply the cloning substitution to all types
and coercions.  But that in turn means that, given a binder like
   /\ (a :: kind |&gt; g). blah
we must substitute in a's kind, and hence need to substitute for `a`
itself in `blah`.

So our plan is:
  * Maintain a full Subst in `cpe_subst`

  * Clone a CoVar when we we meet an `isUnsafeEqualityCase`;
    otherwise TyVar/CoVar binders are never cloned.

  * So generally the TCvSubst is empty

  * Apply the substitution to type and coercion arguments in Core; but
    happily `substTy` has a no-op short-cut for an empty TCvSubst, so this
    is usually very cheap.

  * In `cpCloneBndr`, for a tyvar/covar binder, check for an empty substitution;
    in that case just do nothing
-}</span><span>
</span><span id="line-223"></span><span>
</span><span id="line-224"></span><span class="hs-keyword">type</span><span> </span><span id="CpeArg"><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeArg"><span class="hs-identifier hs-var">CpeArg</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>    </span><span class="hs-comment">-- Non-terminal 'arg'</span><span>
</span><span id="line-225"></span><span class="hs-keyword">type</span><span> </span><span id="CpeApp"><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeApp"><span class="hs-identifier hs-var">CpeApp</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>    </span><span class="hs-comment">-- Non-terminal 'app'</span><span>
</span><span id="line-226"></span><span class="hs-keyword">type</span><span> </span><span id="CpeBody"><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeBody"><span class="hs-identifier hs-var">CpeBody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>    </span><span class="hs-comment">-- Non-terminal 'body'</span><span>
</span><span id="line-227"></span><span class="hs-keyword">type</span><span> </span><span id="CpeRhs"><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeRhs"><span class="hs-identifier hs-var">CpeRhs</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>    </span><span class="hs-comment">-- Non-terminal 'rhs'</span><span>
</span><span id="line-228"></span><span>
</span><span id="line-229"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Top level stuff
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-236"></span><span>
</span><span id="line-237"></span><span class="hs-keyword">data</span><span> </span><span id="CorePrepPgmConfig"><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepPgmConfig"><span class="hs-identifier hs-var">CorePrepPgmConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="CorePrepPgmConfig"><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepPgmConfig"><span class="hs-identifier hs-var">CorePrepPgmConfig</span></a></span></span><span>
</span><span id="line-238"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="cpPgm_endPassConfig"><span class="annot"><span class="annottext">CorePrepPgmConfig -&gt; EndPassConfig
</span><a href="GHC.CoreToStg.Prep.html#cpPgm_endPassConfig"><span class="hs-identifier hs-var hs-var">cpPgm_endPassConfig</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.Lint.html#EndPassConfig"><span class="hs-identifier hs-type">EndPassConfig</span></a></span><span>
</span><span id="line-239"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="cpPgm_generateDebugInfo"><span class="annot"><span class="annottext">CorePrepPgmConfig -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#cpPgm_generateDebugInfo"><span class="hs-identifier hs-var hs-var">cpPgm_generateDebugInfo</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-240"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-241"></span><span>
</span><span id="line-242"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#corePrepPgm"><span class="hs-identifier hs-type">corePrepPgm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span>
</span><span id="line-243"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepConfig"><span class="hs-identifier hs-type">CorePrepConfig</span></a></span><span>
</span><span id="line-244"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepPgmConfig"><span class="hs-identifier hs-type">CorePrepPgmConfig</span></a></span><span>
</span><span id="line-245"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Unit.Types.html#Module"><span class="hs-identifier hs-type">Module</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Unit.Module.Location.html#ModLocation"><span class="hs-identifier hs-type">ModLocation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-246"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a></span><span>
</span><span id="line-247"></span><span id="corePrepPgm"><span class="annot"><span class="annottext">corePrepPgm :: Logger
-&gt; CorePrepConfig
-&gt; CorePrepPgmConfig
-&gt; Module
-&gt; ModLocation
-&gt; CoreProgram
-&gt; [TyCon]
-&gt; IO CoreProgram
</span><a href="GHC.CoreToStg.Prep.html#corePrepPgm"><span class="hs-identifier hs-var hs-var">corePrepPgm</span></a></span></span><span> </span><span id="local-6989586621682975164"><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621682975164"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621682975165"><span class="annot"><span class="annottext">CorePrepConfig
</span><a href="#local-6989586621682975165"><span class="hs-identifier hs-var">cp_cfg</span></a></span></span><span> </span><span id="local-6989586621682975166"><span class="annot"><span class="annottext">CorePrepPgmConfig
</span><a href="#local-6989586621682975166"><span class="hs-identifier hs-var">pgm_cfg</span></a></span></span><span>
</span><span id="line-248"></span><span>            </span><span id="local-6989586621682975167"><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682975167"><span class="hs-identifier hs-var">this_mod</span></a></span></span><span> </span><span id="local-6989586621682975168"><span class="annot"><span class="annottext">ModLocation
</span><a href="#local-6989586621682975168"><span class="hs-identifier hs-var">mod_loc</span></a></span></span><span> </span><span id="local-6989586621682975169"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621682975169"><span class="hs-identifier hs-var">binds</span></a></span></span><span> </span><span id="local-6989586621682975170"><span class="annot"><span class="annottext">[TyCon]
</span><a href="#local-6989586621682975170"><span class="hs-identifier hs-var">data_tycons</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-249"></span><span>    </span><span class="annot"><span class="annottext">Logger
-&gt; SDoc -&gt; (CoreProgram -&gt; ()) -&gt; IO CoreProgram -&gt; IO CoreProgram
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
Logger -&gt; SDoc -&gt; (a -&gt; ()) -&gt; m a -&gt; m a
</span><a href="GHC.Utils.Error.html#withTiming"><span class="hs-identifier hs-var">withTiming</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621682975164"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-250"></span><span>               </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;CorePrep&quot;</span></span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#brackets"><span class="hs-identifier hs-var">brackets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Module -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682975167"><span class="hs-identifier hs-var">this_mod</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-251"></span><span>               </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682975176"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621682975176"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621682975176"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram -&gt; () -&gt; ()
forall a b. [a] -&gt; b -&gt; b
</span><a href="GHC.Utils.Misc.html#seqList"><span class="hs-operator hs-var">`seqList`</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO CoreProgram -&gt; IO CoreProgram)
-&gt; IO CoreProgram -&gt; IO CoreProgram
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-252"></span><span>    </span><span id="local-6989586621682975178"><span class="annot"><a href="#local-6989586621682975178"><span class="hs-identifier hs-var">us</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Char -&gt; IO UniqSupply
</span><a href="GHC.Types.Unique.Supply.html#mkSplitUniqSupply"><span class="hs-identifier hs-var">mkSplitUniqSupply</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'s'</span></span><span>
</span><span id="line-253"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682975180"><span class="annot"><a href="#local-6989586621682975180"><span class="hs-identifier hs-var hs-var">initialCorePrepEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepConfig -&gt; CorePrepEnv
</span><a href="GHC.CoreToStg.Prep.html#mkInitialCorePrepEnv"><span class="hs-identifier hs-var">mkInitialCorePrepEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepConfig
</span><a href="#local-6989586621682975165"><span class="hs-identifier hs-var">cp_cfg</span></a></span><span>
</span><span id="line-254"></span><span>
</span><span id="line-255"></span><span>    </span><span class="hs-keyword">let</span><span>
</span><span id="line-256"></span><span>        </span><span id="local-6989586621682975182"><span class="annot"><a href="#local-6989586621682975182"><span class="hs-identifier hs-var hs-var">implicit_binds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; ModLocation -&gt; [TyCon] -&gt; CoreProgram
</span><a href="GHC.CoreToStg.Prep.html#mkDataConWorkers"><span class="hs-identifier hs-var">mkDataConWorkers</span></a></span><span>
</span><span id="line-257"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepPgmConfig -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#cpPgm_generateDebugInfo"><span class="hs-identifier hs-var">cpPgm_generateDebugInfo</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepPgmConfig
</span><a href="#local-6989586621682975166"><span class="hs-identifier hs-var">pgm_cfg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-258"></span><span>          </span><span class="annot"><span class="annottext">ModLocation
</span><a href="#local-6989586621682975168"><span class="hs-identifier hs-var">mod_loc</span></a></span><span> </span><span class="annot"><span class="annottext">[TyCon]
</span><a href="#local-6989586621682975170"><span class="hs-identifier hs-var">data_tycons</span></a></span><span>
</span><span id="line-259"></span><span>            </span><span class="hs-comment">-- NB: we must feed mkImplicitBinds through corePrep too</span><span>
</span><span id="line-260"></span><span>            </span><span class="hs-comment">-- so that they are suitably cloned and eta-expanded</span><span>
</span><span id="line-261"></span><span>
</span><span id="line-262"></span><span>        </span><span id="local-6989586621682975184"><span class="annot"><a href="#local-6989586621682975184"><span class="hs-identifier hs-var hs-var">binds_out</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UniqSupply -&gt; UniqSM CoreProgram -&gt; CoreProgram
forall a. UniqSupply -&gt; UniqSM a -&gt; a
</span><a href="GHC.Types.Unique.Supply.html#initUs_"><span class="hs-identifier hs-var">initUs_</span></a></span><span> </span><span class="annot"><span class="annottext">UniqSupply
</span><a href="#local-6989586621682975178"><span class="hs-identifier hs-var">us</span></a></span><span> </span><span class="annot"><span class="annottext">(UniqSM CoreProgram -&gt; CoreProgram)
-&gt; UniqSM CoreProgram -&gt; CoreProgram
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-263"></span><span>                      </span><span id="local-6989586621682975186"><span class="annot"><a href="#local-6989586621682975186"><span class="hs-identifier hs-var">floats1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CoreProgram -&gt; UniqSM Floats
</span><a href="GHC.CoreToStg.Prep.html#corePrepTopBinds"><span class="hs-identifier hs-var">corePrepTopBinds</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975180"><span class="hs-identifier hs-var">initialCorePrepEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621682975169"><span class="hs-identifier hs-var">binds</span></a></span><span>
</span><span id="line-264"></span><span>                      </span><span id="local-6989586621682975188"><span class="annot"><a href="#local-6989586621682975188"><span class="hs-identifier hs-var">floats2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#corePrepTopBinds"><span class="hs-identifier hs-type">corePrepTopBinds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975180"><span class="hs-identifier hs-type">initialCorePrepEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975182"><span class="hs-identifier hs-type">implicit_binds</span></a></span><span>
</span><span id="line-265"></span><span>                      </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#deFloatTop"><span class="hs-identifier hs-type">deFloatTop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682975186"><span class="hs-identifier hs-type">floats1</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#zipFloats"><span class="hs-operator hs-type">`zipFloats`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975188"><span class="hs-identifier hs-type">floats2</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-266"></span><span>
</span><span id="line-267"></span><span>    </span><span class="annot"><a href="GHC.Core.Lint.html#endPassIO"><span class="hs-identifier hs-type">endPassIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975164"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpPgm_endPassConfig"><span class="hs-identifier hs-var">cpPgm_endPassConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975166"><span class="hs-identifier hs-type">pgm_cfg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-268"></span><span>              </span><span class="annot"><a href="#local-6989586621682975184"><span class="hs-identifier hs-type">binds_out</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-269"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621682975184"><span class="hs-identifier hs-type">binds_out</span></a></span><span>
</span><span id="line-270"></span><span>
</span><span id="line-271"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#corePrepExpr"><span class="hs-identifier hs-type">corePrepExpr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepConfig"><span class="hs-identifier hs-type">CorePrepConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-272"></span><span id="corePrepExpr"><span class="annot"><span class="annottext">corePrepExpr :: Logger -&gt; CorePrepConfig -&gt; CpeRhs -&gt; IO CpeRhs
</span><a href="GHC.CoreToStg.Prep.html#corePrepExpr"><span class="hs-identifier hs-var hs-var">corePrepExpr</span></a></span></span><span> </span><span id="local-6989586621682975191"><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621682975191"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621682975192"><span class="annot"><span class="annottext">CorePrepConfig
</span><a href="#local-6989586621682975192"><span class="hs-identifier hs-var">config</span></a></span></span><span> </span><span id="local-6989586621682975193"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975193"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-273"></span><span>    </span><span class="annot"><span class="annottext">Logger -&gt; SDoc -&gt; (CpeRhs -&gt; ()) -&gt; IO CpeRhs -&gt; IO CpeRhs
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
Logger -&gt; SDoc -&gt; (a -&gt; ()) -&gt; m a -&gt; m a
</span><a href="GHC.Utils.Error.html#withTiming"><span class="hs-identifier hs-var">withTiming</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621682975191"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;CorePrep [expr]&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682975194"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975194"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975194"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; () -&gt; ()
forall a b. a -&gt; b -&gt; b
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO CpeRhs -&gt; IO CpeRhs) -&gt; IO CpeRhs -&gt; IO CpeRhs
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-274"></span><span>      </span><span id="local-6989586621682975195"><span class="annot"><a href="#local-6989586621682975195"><span class="hs-identifier hs-var">us</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Char -&gt; IO UniqSupply
</span><a href="GHC.Types.Unique.Supply.html#mkSplitUniqSupply"><span class="hs-identifier hs-var">mkSplitUniqSupply</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'s'</span></span><span>
</span><span id="line-275"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682975196"><span class="annot"><a href="#local-6989586621682975196"><span class="hs-identifier hs-var hs-var">initialCorePrepEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepConfig -&gt; CorePrepEnv
</span><a href="GHC.CoreToStg.Prep.html#mkInitialCorePrepEnv"><span class="hs-identifier hs-var">mkInitialCorePrepEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepConfig
</span><a href="#local-6989586621682975192"><span class="hs-identifier hs-var">config</span></a></span><span>
</span><span id="line-276"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682975197"><span class="annot"><a href="#local-6989586621682975197"><span class="hs-identifier hs-var hs-var">new_expr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UniqSupply -&gt; UniqSM CpeRhs -&gt; CpeRhs
forall a. UniqSupply -&gt; UniqSM a -&gt; a
</span><a href="GHC.Types.Unique.Supply.html#initUs_"><span class="hs-identifier hs-var">initUs_</span></a></span><span> </span><span class="annot"><span class="annottext">UniqSupply
</span><a href="#local-6989586621682975195"><span class="hs-identifier hs-var">us</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeRhs -&gt; UniqSM CpeRhs
</span><a href="GHC.CoreToStg.Prep.html#cpeBodyNF"><span class="hs-identifier hs-var">cpeBodyNF</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975196"><span class="hs-identifier hs-var">initialCorePrepEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975193"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-277"></span><span>      </span><span class="annot"><a href="GHC.Utils.Logger.html#putDumpFileMaybe"><span class="hs-identifier hs-type">putDumpFileMaybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975191"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><a href="GHC.Driver.Flags.html#Opt_D_dump_prep"><span class="hs-identifier hs-type">Opt_D_dump_prep</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;CorePrep&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#FormatCore"><span class="hs-identifier hs-type">FormatCore</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975197"><span class="hs-identifier hs-type">new_expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-278"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621682975197"><span class="hs-identifier hs-type">new_expr</span></a></span><span>
</span><span id="line-279"></span><span>
</span><span id="line-280"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#corePrepTopBinds"><span class="hs-identifier hs-type">corePrepTopBinds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span>
</span><span id="line-281"></span><span class="hs-comment">-- Note [Floating out of top level bindings]</span><span>
</span><span id="line-282"></span><span id="corePrepTopBinds"><span class="annot"><span class="annottext">corePrepTopBinds :: CorePrepEnv -&gt; CoreProgram -&gt; UniqSM Floats
</span><a href="GHC.CoreToStg.Prep.html#corePrepTopBinds"><span class="hs-identifier hs-var hs-var">corePrepTopBinds</span></a></span></span><span> </span><span id="local-6989586621682975202"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975202"><span class="hs-identifier hs-var">initialCorePrepEnv</span></a></span></span><span> </span><span id="local-6989586621682975203"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621682975203"><span class="hs-identifier hs-var">binds</span></a></span></span><span>
</span><span id="line-283"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CoreProgram -&gt; UniqSM Floats
</span><a href="#local-6989586621682975204"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975202"><span class="hs-identifier hs-var">initialCorePrepEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621682975203"><span class="hs-identifier hs-var">binds</span></a></span><span>
</span><span id="line-284"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-285"></span><span>    </span><span id="local-6989586621682975204"><span class="annot"><span class="annottext">go :: CorePrepEnv -&gt; CoreProgram -&gt; UniqSM Floats
</span><a href="#local-6989586621682975204"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><span class="hs-identifier">_</span></span><span>   </span><span class="hs-special">[</span><span class="hs-special">]</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Floats -&gt; UniqSM Floats
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span>
</span><span id="line-286"></span><span>    </span><span class="annot"><a href="#local-6989586621682975204"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682975214"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975214"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975215"><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682975215"><span class="hs-identifier hs-var">bind</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682975216"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621682975216"><span class="hs-identifier hs-var">binds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975217"><span class="annot"><a href="#local-6989586621682975217"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975218"><span class="annot"><a href="#local-6989586621682975218"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975219"><span class="annot"><a href="#local-6989586621682975219"><span class="hs-identifier hs-var">maybe_new_bind</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-287"></span><span>                                 </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
-&gt; CorePrepEnv
-&gt; CoreBind
-&gt; UniqSM (CorePrepEnv, Floats, Maybe CoreBind)
</span><a href="GHC.CoreToStg.Prep.html#cpeBind"><span class="hs-identifier hs-var">cpeBind</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="GHC.Types.Basic.html#TopLevel"><span class="hs-identifier hs-var">TopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975214"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682975215"><span class="hs-identifier hs-var">bind</span></a></span><span>
</span><span id="line-288"></span><span>                               </span><span class="annot"><a href="GHC.Utils.Panic.Plain.html#massert"><span class="hs-identifier hs-type">massert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">isNothing</span></span><span> </span><span class="annot"><a href="#local-6989586621682975219"><span class="hs-identifier hs-type">maybe_new_bind</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-289"></span><span>                                 </span><span class="hs-comment">-- Only join points get returned this way by</span><span>
</span><span id="line-290"></span><span>                                 </span><span class="hs-comment">-- cpeBind, and no join point may float to top</span><span>
</span><span id="line-291"></span><span>                               </span><span id="local-6989586621682975224"><span class="annot"><a href="#local-6989586621682975224"><span class="hs-identifier hs-var">floatss</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621682975204"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975217"><span class="hs-identifier hs-type">env'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975216"><span class="hs-identifier hs-type">binds</span></a></span><span>
</span><span id="line-292"></span><span>                               </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682975218"><span class="hs-identifier hs-type">floats</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#zipFloats"><span class="hs-operator hs-type">`zipFloats`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975224"><span class="hs-identifier hs-type">floatss</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-293"></span><span>
</span><span id="line-294"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#mkDataConWorkers"><span class="hs-identifier hs-type">mkDataConWorkers</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Unit.Module.Location.html#ModLocation"><span class="hs-identifier hs-type">ModLocation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-295"></span><span class="hs-comment">-- See Note [Data constructor workers]</span><span>
</span><span id="line-296"></span><span class="hs-comment">-- c.f. Note [Injecting implicit bindings] in GHC.Iface.Tidy</span><span>
</span><span id="line-297"></span><span id="mkDataConWorkers"><span class="annot"><span class="annottext">mkDataConWorkers :: Bool -&gt; ModLocation -&gt; [TyCon] -&gt; CoreProgram
</span><a href="GHC.CoreToStg.Prep.html#mkDataConWorkers"><span class="hs-identifier hs-var hs-var">mkDataConWorkers</span></a></span></span><span> </span><span id="local-6989586621682975225"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682975225"><span class="hs-identifier hs-var">generate_debug_info</span></a></span></span><span> </span><span id="local-6989586621682975226"><span class="annot"><span class="annottext">ModLocation
</span><a href="#local-6989586621682975226"><span class="hs-identifier hs-var">mod_loc</span></a></span></span><span> </span><span id="local-6989586621682975227"><span class="annot"><span class="annottext">[TyCon]
</span><a href="#local-6989586621682975227"><span class="hs-identifier hs-var">data_tycons</span></a></span></span><span>
</span><span id="line-298"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">InVar -&gt; CpeRhs -&gt; CoreBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975229"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; CpeRhs -&gt; CpeRhs
</span><a href="#local-6989586621682975230"><span class="hs-identifier hs-var">tick_it</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; Name
forall a. NamedThing a =&gt; a -&gt; Name
</span><a href="GHC.Types.Name.html#getName"><span class="hs-identifier hs-var">getName</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682975232"><span class="hs-identifier hs-var">data_con</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InVar -&gt; CpeRhs
forall b. InVar -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975229"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-299"></span><span>                                </span><span class="hs-comment">-- The ice is thin here, but it works</span><span>
</span><span id="line-300"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621682975234"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682975234"><span class="hs-identifier hs-var">tycon</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TyCon]
</span><a href="#local-6989586621682975227"><span class="hs-identifier hs-var">data_tycons</span></a></span><span class="hs-special">,</span><span>     </span><span class="hs-comment">-- CorePrep will eta-expand it</span><span>
</span><span id="line-301"></span><span>      </span><span id="local-6989586621682975232"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682975232"><span class="hs-identifier hs-var">data_con</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [DataCon]
</span><a href="GHC.Core.TyCon.html#tyConDataCons"><span class="hs-identifier hs-var">tyConDataCons</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682975234"><span class="hs-identifier hs-var">tycon</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-302"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682975229"><span class="annot"><span class="annottext">id :: InVar
</span><a href="#local-6989586621682975229"><span class="hs-identifier hs-var hs-var">id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; InVar
</span><a href="GHC.Core.DataCon.html#dataConWorkId"><span class="hs-identifier hs-var">dataConWorkId</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682975232"><span class="hs-identifier hs-var">data_con</span></a></span><span>
</span><span id="line-303"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-304"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-305"></span><span>   </span><span class="hs-comment">-- If we want to generate debug info, we put a source note on the</span><span>
</span><span id="line-306"></span><span>   </span><span class="hs-comment">-- worker. This is useful, especially for heap profiling.</span><span>
</span><span id="line-307"></span><span>   </span><span id="local-6989586621682975230"><span class="annot"><span class="annottext">tick_it :: Name -&gt; CpeRhs -&gt; CpeRhs
</span><a href="#local-6989586621682975230"><span class="hs-identifier hs-var hs-var">tick_it</span></a></span></span><span> </span><span id="local-6989586621682975237"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682975237"><span class="hs-identifier hs-var">name</span></a></span></span><span>
</span><span id="line-308"></span><span>     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682975225"><span class="hs-identifier hs-var">generate_debug_info</span></a></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; CpeRhs
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span>
</span><span id="line-309"></span><span>     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html#RealSrcSpan"><span class="hs-identifier hs-type">RealSrcSpan</span></a></span><span> </span><span id="local-6989586621682975241"><span class="annot"><span class="annottext">RealSrcSpan
</span><a href="#local-6989586621682975241"><span class="hs-identifier hs-var">span</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe BufSpan
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; SrcSpan
</span><a href="GHC.Types.Name.html#nameSrcSpan"><span class="hs-identifier hs-var">nameSrcSpan</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682975237"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RealSrcSpan -&gt; CpeRhs -&gt; CpeRhs
</span><a href="#local-6989586621682975242"><span class="hs-identifier hs-var">tick</span></a></span><span> </span><span class="annot"><span class="annottext">RealSrcSpan
</span><a href="#local-6989586621682975241"><span class="hs-identifier hs-var">span</span></a></span><span>
</span><span id="line-310"></span><span>     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682975243"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621682975243"><span class="hs-identifier hs-var">file</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ModLocation -&gt; Maybe String
</span><a href="GHC.Unit.Module.Location.html#ml_hs_file"><span class="hs-identifier hs-var">ml_hs_file</span></a></span><span> </span><span class="annot"><span class="annottext">ModLocation
</span><a href="#local-6989586621682975226"><span class="hs-identifier hs-var">mod_loc</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RealSrcSpan -&gt; CpeRhs -&gt; CpeRhs
</span><a href="#local-6989586621682975242"><span class="hs-identifier hs-var">tick</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; RealSrcSpan
</span><a href="#local-6989586621682975245"><span class="hs-identifier hs-var">span1</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621682975243"><span class="hs-identifier hs-var">file</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-311"></span><span>     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RealSrcSpan -&gt; CpeRhs -&gt; CpeRhs
</span><a href="#local-6989586621682975242"><span class="hs-identifier hs-var">tick</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; RealSrcSpan
</span><a href="#local-6989586621682975245"><span class="hs-identifier hs-var">span1</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;???&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-312"></span><span>     </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621682975242"><span class="annot"><span class="annottext">tick :: RealSrcSpan -&gt; CpeRhs -&gt; CpeRhs
</span><a href="#local-6989586621682975242"><span class="hs-identifier hs-var hs-var">tick</span></a></span></span><span> </span><span id="local-6989586621682975246"><span class="annot"><span class="annottext">RealSrcSpan
</span><a href="#local-6989586621682975246"><span class="hs-identifier hs-var">span</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; CpeRhs -&gt; CpeRhs
forall b. CoreTickish -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-var">Tick</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreTickish -&gt; CpeRhs -&gt; CpeRhs)
-&gt; CoreTickish -&gt; CpeRhs -&gt; CpeRhs
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RealSrcSpan -&gt; LexicalFastString -&gt; CoreTickish
forall (pass :: TickishPass).
RealSrcSpan -&gt; LexicalFastString -&gt; GenTickish pass
</span><a href="GHC.Types.Tickish.html#SourceNote"><span class="hs-identifier hs-var">SourceNote</span></a></span><span> </span><span class="annot"><span class="annottext">RealSrcSpan
</span><a href="#local-6989586621682975246"><span class="hs-identifier hs-var">span</span></a></span><span> </span><span class="annot"><span class="annottext">(LexicalFastString -&gt; CoreTickish)
-&gt; LexicalFastString -&gt; CoreTickish
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-313"></span><span>             </span><span class="annot"><span class="annottext">FastString -&gt; LexicalFastString
</span><a href="GHC.Data.FastString.html#LexicalFastString"><span class="hs-identifier hs-var">LexicalFastString</span></a></span><span> </span><span class="annot"><span class="annottext">(FastString -&gt; LexicalFastString)
-&gt; FastString -&gt; LexicalFastString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; FastString
</span><a href="GHC.Data.FastString.html#mkFastString"><span class="hs-identifier hs-var">mkFastString</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; FastString) -&gt; String -&gt; FastString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SDocContext -&gt; SDoc -&gt; String
</span><a href="GHC.Utils.Outputable.html#renderWithContext"><span class="hs-identifier hs-var">renderWithContext</span></a></span><span> </span><span class="annot"><span class="annottext">SDocContext
</span><a href="GHC.Utils.Outputable.html#defaultSDocContext"><span class="hs-identifier hs-var">defaultSDocContext</span></a></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; String) -&gt; SDoc -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682975237"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-314"></span><span>           </span><span id="local-6989586621682975245"><span class="annot"><span class="annottext">span1 :: String -&gt; RealSrcSpan
</span><a href="#local-6989586621682975245"><span class="hs-identifier hs-var hs-var">span1</span></a></span></span><span> </span><span id="local-6989586621682975253"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621682975253"><span class="hs-identifier hs-var">file</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RealSrcLoc -&gt; RealSrcSpan
</span><a href="GHC.Types.SrcLoc.html#realSrcLocSpan"><span class="hs-identifier hs-var">realSrcLocSpan</span></a></span><span> </span><span class="annot"><span class="annottext">(RealSrcLoc -&gt; RealSrcSpan) -&gt; RealSrcLoc -&gt; RealSrcSpan
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FastString -&gt; Int -&gt; Int -&gt; RealSrcLoc
</span><a href="GHC.Types.SrcLoc.html#mkRealSrcLoc"><span class="hs-identifier hs-var">mkRealSrcLoc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; FastString
</span><a href="GHC.Data.FastString.html#mkFastString"><span class="hs-identifier hs-var">mkFastString</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621682975253"><span class="hs-identifier hs-var">file</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-315"></span><span>
</span><span id="line-316"></span><span class="hs-comment">{- Note [Floating in CorePrep]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
ANFisation risks producing a lot of nested lets that obscures values:
  let v = (:) (f 14) [] in e
  ==&gt; { ANF in CorePrep }
  let v = let sat = f 14 in (:) sat [] in e
Here, `v` is not a value anymore, and we'd allocate a thunk closure for `v` that
allocates a thunk for `sat` and then allocates the cons cell.
Hence we carry around a bunch of floated bindings with us so that we again
expose the values:
  let v = let sat = f 14 in (:) sat [] in e
  ==&gt; { Float sat }
  let sat = f 14 in
  let v = (:) sat [] in e
(We will not do this transformation if `v` does not become a value afterwards;
see Note [wantFloatLocal].)
If `v` is bound at the top-level, we might even float `sat` to top-level;
see Note [Floating out of top level bindings].
For nested let bindings, we have to keep in mind Note [Core letrec invariant]
and may exploit strict contexts; see Note [wantFloatLocal].

There are 3 main categories of floats, encoded in the `FloatingBind` type:

  * `Float`: A floated binding, as `sat` above.
    These come in different flavours as described by their `FloatInfo` and
    `BindInfo`, which captures how far the binding can be floated and whether or
    not we want to case-bind. See Note [BindInfo and FloatInfo].
  * `UnsafeEqualityCase`: Used for floating around unsafeEqualityProof bindings;
    see (U3) of Note [Implementing unsafeCoerce].
    It's exactly a `Float` that is `CaseBound` and `LazyContextFloatable`
    (see `mkNonRecFloat`), but one that has a non-DEFAULT Case alternative to
    bind the unsafe coercion field of the Refl constructor.
  * `FloatTick`: A floated `Tick`. See Note [Floating Ticks in CorePrep].

It is quite essential that CorePrep *does not* rearrange the order in which
evaluations happen, in contrast to, e.g., FloatOut, because CorePrep lowers
the seq# primop into a Case (see Note [seq# magic]). Fortunately, CorePrep does
not attempt to reorder the telescope of Floats or float out out of non-floated
binding sites (such as Case alts) in the first place; for that it would have to
do some kind of data dependency analysis.

Note [Floating out of top level bindings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
NB: we do need to float out of top-level bindings
Consider        x = length [True,False]
We want to get
                s1 = False : []
                s2 = True  : s1
                x  = length s2

We return a *list* of bindings, because we may start with
        x* = f (g y)
where x is demanded, in which case we want to finish with
        a = g y
        x* = f a
And then x will actually end up case-bound

Note [Join points and floating]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Join points can float out of other join points but not out of value bindings:

  let z =
    let  w = ... in -- can float
    join k = ... in -- can't float
    ... jump k ...
  join j x1 ... xn =
    let  y = ... in -- can float (but don't want to)
    join h = ... in -- can float (but not much point)
    ... jump h ...
  in ...

Here, the jump to h remains valid if h is floated outward, but the jump to k
does not.

We don't float *out* of join points. It would only be safe to float out of
nullary join points (or ones where the arguments are all either type arguments
or dead binders). Nullary join points aren't ever recursive, so they're always
effectively one-shot functions, which we don't float out of. We *could* float
join points from nullary join points, but there's no clear benefit at this
stage.

Note [Data constructor workers]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Create any necessary &quot;implicit&quot; bindings for data con workers.  We
create the rather strange (non-recursive!) binding

        $wC = \x y -&gt; $wC x y

i.e. a curried constructor that allocates.  This means that we can
treat the worker for a constructor like any other function in the rest
of the compiler.  The point here is that CoreToStg will generate a
StgConApp for the RHS, rather than a call to the worker (which would
give a loop).  As Lennart says: the ice is thin here, but it works.

Hmm.  Should we create bindings for dictionary constructors?  They are
always fully applied, and the bindings are just there to support
partial applications. But it's easier to let them through.


Note [Dead code in CorePrep]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Imagine that we got an input program like this (see #4962):

  f :: Show b =&gt; Int -&gt; (Int, b -&gt; Maybe Int -&gt; Int)
  f x = (g True (Just x) + g () (Just x), g)
    where
      g :: Show a =&gt; a -&gt; Maybe Int -&gt; Int
      g _ Nothing = x
      g y (Just z) = if z &gt; 100 then g y (Just (z + length (show y))) else g y unknown

After specialisation and SpecConstr, we would get something like this:

  f :: Show b =&gt; Int -&gt; (Int, b -&gt; Maybe Int -&gt; Int)
  f x = (g$Bool_True_Just x + g$Unit_Unit_Just x, g)
    where
      {-# RULES g $dBool = g$Bool
                g $dUnit = g$Unit #-}
      g = ...
      {-# RULES forall x. g$Bool True (Just x) = g$Bool_True_Just x #-}
      g$Bool = ...
      {-# RULES forall x. g$Unit () (Just x) = g$Unit_Unit_Just x #-}
      g$Unit = ...
      g$Bool_True_Just = ...
      g$Unit_Unit_Just = ...

Note that the g$Bool and g$Unit functions are actually dead code: they
are only kept alive by the occurrence analyser because they are
referred to by the rules of g, which is being kept alive by the fact
that it is used (unspecialised) in the returned pair.

However, at the CorePrep stage there is no way that the rules for g
will ever fire, and it really seems like a shame to produce an output
program that goes to the trouble of allocating a closure for the
unreachable g$Bool and g$Unit functions.

The way we fix this is to:
 * In cloneBndr, drop all unfoldings/rules

 * In deFloatTop, run a simple dead code analyser on each top-level
   RHS to drop the dead local bindings.

The reason we don't just OccAnal the whole output of CorePrep is that
the tidier ensures that all top-level binders are GlobalIds, so they
don't show up in the free variables any longer. So if you run the
occurrence analyser on the output of CoreTidy (or later) you e.g. turn
this program:

  Rec {
  f = ... f ...
  }

Into this one:

  f = ... f ...

(Since f is not considered to be free in its own RHS.)


Note [keepAlive# magic]
~~~~~~~~~~~~~~~~~~~~~~~
When interacting with foreign code, it is often necessary for the user to
extend the lifetime of a heap object beyond the lifetime that would be apparent
from the on-heap references alone. For instance, a program like:

  foreign import safe &quot;hello&quot; hello :: ByteArray# -&gt; IO ()

  callForeign :: IO ()
  callForeign = IO $ \s0 -&gt;
    case newByteArray# n# s0 of (# s1, barr #) -&gt;
      unIO hello barr s1

As-written this program is susceptible to memory-unsafety since there are
no references to `barr` visible to the garbage collector. Consequently, if a
garbage collection happens during the execution of the C function `hello`, it
may be that the array is freed while in use by the foreign function.

To address this, we introduced a new primop, keepAlive#, which &quot;scopes over&quot;
the computation needing the kept-alive value:

  keepAlive# :: forall (ra :: RuntimeRep) (rb :: RuntimeRep) (a :: TYPE a) (b :: TYPE b).
                a -&gt; State# RealWorld -&gt; (State# RealWorld -&gt; b) -&gt; b

When entered, an application (keepAlive# x s k) will apply `k` to the state
token, evaluating it to WHNF. However, during the course of this evaluation
will *guarantee* that `x` is considered to be alive.

There are a few things to note here:

 - we are RuntimeRep-polymorphic in the value to be kept-alive. This is
   necessary since we will often (but not always) be keeping alive something
   unlifted (like a ByteArray#)

 - we are RuntimeRep-polymorphic in the result value since the result may take
   many forms (e.g. a boxed value, a raw state token, or a (# State s, result #).

We implement this operation by desugaring to touch# during CorePrep (see
GHC.CoreToStg.Prep.cpeApp). Specifically,

  keepAlive# x s0 k

is transformed to:

  case k s0 of r -&gt;
  case touch# x realWorld# of s1 -&gt;
    r

Operationally, `keepAlive# x s k` is equivalent to pushing a stack frame with a
pointer to `x` and entering `k s0`. This compilation strategy is safe
because we do no optimization on STG that would drop or re-order the
continuation containing the `touch#`. However, if we were to become more
aggressive in our STG pipeline then we would need to revisit this.

Beyond this CorePrep transformation, there is very little special about
keepAlive#. However, we did explore (and eventually gave up on)
an optimisation which would allow unboxing of constructed product results,
which we describe below.


Lost optimisation: CPR unboxing
--------------------------------
One unfortunate property of this approach is that the simplifier is unable to
unbox the result of a keepAlive# expression. For instance, consider the program:

  case keepAlive# arr s0 (
         \s1 -&gt; case peekInt arr s1 of
                  (# s2, r #) -&gt; I# r
  ) of
    I# x -&gt; ...

This is a surprisingly common pattern, previously used, e.g., in
GHC.IO.Buffer.readWord8Buf. While exploring ideas, we briefly played around
with optimising this away by pushing strict contexts (like the
`case [] of I# x -&gt; ...` above) into keepAlive#'s continuation. While this can
recover unboxing, it can also unfortunately in general change the asymptotic
memory (namely stack) behavior of the program. For instance, consider

  writeN =
    ...
      case keepAlive# x s0 (\s1 -&gt; something s1) of
        (# s2, x #) -&gt;
          writeN ...

As it is tail-recursive, this program will run in constant space. However, if
we push outer case into the continuation we get:

  writeN =

      case keepAlive# x s0 (\s1 -&gt;
        case something s1 of
          (# s2, x #) -&gt;
            writeN ...
      ) of
        ...

Which ends up building a stack which is linear in the recursion depth. For this
reason, we ended up giving up on this optimisation.


Historical note: touch# and its inadequacy
------------------------------------------
Prior to the introduction of `keepAlive#` we instead addressed the need for
lifetime extension with the `touch#` primop:

    touch# :: a -&gt; State# s -&gt; State# s

This operation would ensure that the `a` value passed as the first argument was
considered &quot;alive&quot; at the time the primop application is entered.

For instance, the user might modify `callForeign` as:

  callForeign :: IO ()
  callForeign s0 = IO $ \s0 -&gt;
    case newByteArray# n# s0 of (# s1, barr #) -&gt;
    case unIO hello barr s1 of (# s2, () #) -&gt;
    case touch# barr s2 of s3 -&gt;
      (# s3, () #)

However, in #14346 we discovered that this primop is insufficient in the
presence of simplification. For instance, consider a program like:

  callForeign :: IO ()
  callForeign s0 = IO $ \s0 -&gt;
    case newByteArray# n# s0 of (# s1, barr #) -&gt;
    case unIO (forever $ hello barr) s1 of (# s2, () #) -&gt;
    case touch# barr s2 of s3 -&gt;
      (# s3, () #)

In this case the Simplifier may realize that (forever $ hello barr)
will never return and consequently that the `touch#` that follows is dead code.
As such, it will be dropped, resulting in memory unsoundness.
This unsoundness lead to the introduction of keepAlive#.



Other related tickets:

 - #15544
 - #17760
 - #14375
 - #15260
 - #18061

************************************************************************
*                                                                      *
                The main code
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-624"></span><span>
</span><span id="line-625"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeBind"><span class="hs-identifier hs-type">cpeBind</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span>
</span><span id="line-626"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-627"></span><span>                   </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span class="hs-special">,</span><span>         </span><span class="hs-comment">-- Floating value bindings</span><span>
</span><span id="line-628"></span><span>                   </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Just bind' &lt;=&gt; returned new bind; no float</span><span>
</span><span id="line-629"></span><span>                                   </span><span class="hs-comment">-- Nothing &lt;=&gt; added bind' to floats instead</span><span>
</span><span id="line-630"></span><span id="cpeBind"><span class="annot"><span class="annottext">cpeBind :: TopLevelFlag
-&gt; CorePrepEnv
-&gt; CoreBind
-&gt; UniqSM (CorePrepEnv, Floats, Maybe CoreBind)
</span><a href="GHC.CoreToStg.Prep.html#cpeBind"><span class="hs-identifier hs-var hs-var">cpeBind</span></a></span></span><span> </span><span id="local-6989586621682975254"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682975254"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621682975255"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975255"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span id="local-6989586621682975256"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975256"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682975257"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975257"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-631"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InVar -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975256"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-632"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975259"><span class="annot"><a href="#local-6989586621682975259"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975260"><span class="annot"><a href="#local-6989586621682975260"><span class="hs-identifier hs-var">bndr1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; InVar -&gt; UniqSM (CorePrepEnv, InVar)
</span><a href="GHC.CoreToStg.Prep.html#cpCloneBndr"><span class="hs-identifier hs-var">cpCloneBndr</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975255"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975256"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-633"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682975262"><span class="annot"><a href="#local-6989586621682975262"><span class="hs-identifier hs-var hs-var">dmd</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InVar -&gt; Demand
</span><a href="GHC.Types.Id.html#idDemandInfo"><span class="hs-identifier hs-var">idDemandInfo</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975256"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-634"></span><span>             </span><span id="local-6989586621682975264"><span class="annot"><a href="#local-6989586621682975264"><span class="hs-identifier hs-var hs-var">is_unlifted</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Bool
Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isUnliftedType"><span class="hs-identifier hs-var">isUnliftedType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InVar -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975256"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-635"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975267"><span class="annot"><a href="#local-6989586621682975267"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975268"><span class="annot"><a href="#local-6989586621682975268"><span class="hs-identifier hs-var">rhs1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpePair"><span class="hs-identifier hs-type">cpePair</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975254"><span class="hs-identifier hs-type">top_lvl</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#NonRecursive"><span class="hs-identifier hs-type">NonRecursive</span></a></span><span>
</span><span id="line-636"></span><span>                                   </span><span class="annot"><a href="#local-6989586621682975262"><span class="hs-identifier hs-type">dmd</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975264"><span class="hs-identifier hs-type">is_unlifted</span></a></span><span>
</span><span id="line-637"></span><span>                                   </span><span class="annot"><a href="#local-6989586621682975255"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975260"><span class="hs-identifier hs-type">bndr1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975257"><span class="hs-identifier hs-type">rhs</span></a></span><span>
</span><span id="line-638"></span><span>       </span><span class="hs-comment">-- See Note [Inlining in CorePrep]</span><span>
</span><span id="line-639"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682975271"><span class="annot"><a href="#local-6989586621682975271"><span class="hs-identifier hs-var hs-var">triv_rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975268"><span class="hs-identifier hs-var">rhs1</span></a></span><span>
</span><span id="line-640"></span><span>             </span><span id="local-6989586621682975273"><span class="annot"><a href="#local-6989586621682975273"><span class="hs-identifier hs-var hs-var">env2</span></a></span></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682975271"><span class="hs-identifier hs-var">triv_rhs</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; InVar -&gt; CpeRhs -&gt; CorePrepEnv
</span><a href="GHC.CoreToStg.Prep.html#extendCorePrepEnvExpr"><span class="hs-identifier hs-var">extendCorePrepEnvExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975259"><span class="hs-identifier hs-var">env1</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975256"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975268"><span class="hs-identifier hs-var">rhs1</span></a></span><span>
</span><span id="line-641"></span><span>                     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975259"><span class="hs-identifier hs-var">env1</span></a></span><span>
</span><span id="line-642"></span><span>             </span><span id="local-6989586621682975275"><span class="annot"><a href="#local-6989586621682975275"><span class="hs-identifier hs-var hs-var">floats1</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682975271"><span class="hs-identifier hs-var">triv_rhs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Bool
</span><a href="GHC.Types.Name.html#isInternalName"><span class="hs-identifier hs-var">isInternalName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InVar -&gt; Name
</span><a href="GHC.Types.Id.html#idName"><span class="hs-identifier hs-var">idName</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975256"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-643"></span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975267"><span class="hs-identifier hs-var">floats</span></a></span><span>
</span><span id="line-644"></span><span>                     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-645"></span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Floats -&gt; FloatingBind -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#snocFloat"><span class="hs-identifier hs-var">snocFloat</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975267"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621682975278"><span class="hs-identifier hs-var">new_float</span></a></span><span>
</span><span id="line-646"></span><span>
</span><span id="line-647"></span><span>             </span><span id="local-6989586621682975278"><span class="annot"><a href="#local-6989586621682975278"><span class="hs-identifier hs-var hs-var">new_float</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Bool -&gt; InVar -&gt; CpeRhs -&gt; FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#mkNonRecFloat"><span class="hs-identifier hs-var">mkNonRecFloat</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975255"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682975264"><span class="hs-identifier hs-var">is_unlifted</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975260"><span class="hs-identifier hs-var">bndr1</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975268"><span class="hs-identifier hs-var">rhs1</span></a></span><span>
</span><span id="line-648"></span><span>
</span><span id="line-649"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682975273"><span class="hs-identifier hs-type">env2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682975275"><span class="hs-identifier hs-type">floats1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-650"></span><span>
</span><span id="line-651"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-comment">-- A join point; see Note [Join points and floating]</span><span>
</span><span id="line-652"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; UniqSM (CorePrepEnv, Floats, Maybe CoreBind)
-&gt; UniqSM (CorePrepEnv, Floats, Maybe CoreBind)
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelFlag -&gt; Bool
</span><a href="GHC.Types.Basic.html#isTopLevel"><span class="hs-identifier hs-var">isTopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682975254"><span class="hs-identifier hs-var">top_lvl</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(UniqSM (CorePrepEnv, Floats, Maybe CoreBind)
 -&gt; UniqSM (CorePrepEnv, Floats, Maybe CoreBind))
-&gt; UniqSM (CorePrepEnv, Floats, Maybe CoreBind)
-&gt; UniqSM (CorePrepEnv, Floats, Maybe CoreBind)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-comment">-- can't have top-level join point</span><span>
</span><span id="line-653"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975282"><span class="annot"><a href="#local-6989586621682975282"><span class="hs-identifier hs-var">bndr1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; InVar -&gt; UniqSM (CorePrepEnv, InVar)
</span><a href="GHC.CoreToStg.Prep.html#cpCloneBndr"><span class="hs-identifier hs-var">cpCloneBndr</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975255"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975256"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-654"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975283"><span class="annot"><a href="#local-6989586621682975283"><span class="hs-identifier hs-var">bndr2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975284"><span class="annot"><a href="#local-6989586621682975284"><span class="hs-identifier hs-var">rhs1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeJoinPair"><span class="hs-identifier hs-type">cpeJoinPair</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975255"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975282"><span class="hs-identifier hs-type">bndr1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975257"><span class="hs-identifier hs-type">rhs</span></a></span><span>
</span><span id="line-655"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#extendCorePrepEnv"><span class="hs-identifier hs-type">extendCorePrepEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975255"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975256"><span class="hs-identifier hs-type">bndr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975283"><span class="hs-identifier hs-type">bndr2</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-656"></span><span>                 </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-type">emptyFloats</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-657"></span><span>                 </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975283"><span class="hs-identifier hs-type">bndr2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975284"><span class="hs-identifier hs-type">rhs1</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-658"></span><span>
</span><span id="line-659"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeBind"><span class="hs-identifier hs-var">cpeBind</span></a></span><span> </span><span id="local-6989586621682975287"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682975287"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621682975288"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975288"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span id="local-6989586621682975290"><span class="annot"><span class="annottext">[(InVar, CpeRhs)]
</span><a href="#local-6989586621682975290"><span class="hs-identifier hs-var">pairs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-660"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InVar -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[InVar] -&gt; InVar
forall a. HasCallStack =&gt; [a] -&gt; a
</span><a href="GHC.Prelude.Basic.html#head"><span class="hs-identifier hs-var">head</span></a></span><span> </span><span class="annot"><span class="annottext">[InVar]
</span><a href="#local-6989586621682975292"><span class="hs-identifier hs-var">bndrs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-661"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975293"><span class="annot"><a href="#local-6989586621682975293"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975294"><span class="annot"><a href="#local-6989586621682975294"><span class="hs-identifier hs-var">bndrs1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; [InVar] -&gt; UniqSM (CorePrepEnv, [InVar])
</span><a href="GHC.CoreToStg.Prep.html#cpCloneBndrs"><span class="hs-identifier hs-var">cpCloneBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975288"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[InVar]
</span><a href="#local-6989586621682975292"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-662"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682975296"><span class="annot"><a href="#local-6989586621682975296"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; [InVar] -&gt; CorePrepEnv
</span><a href="GHC.CoreToStg.Prep.html#enterRecGroupRHSs"><span class="hs-identifier hs-var">enterRecGroupRHSs</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975293"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[InVar]
</span><a href="#local-6989586621682975294"><span class="hs-identifier hs-var">bndrs1</span></a></span><span>
</span><span id="line-663"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682975298"><span class="annot"><a href="#local-6989586621682975298"><span class="hs-identifier hs-var">stuff</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">zipWithM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpePair"><span class="hs-identifier hs-type">cpePair</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975287"><span class="hs-identifier hs-type">top_lvl</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Recursive"><span class="hs-identifier hs-type">Recursive</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#topDmd"><span class="hs-identifier hs-type">topDmd</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span> </span><span class="annot"><a href="#local-6989586621682975296"><span class="hs-identifier hs-type">env'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-664"></span><span>                           </span><span class="annot"><a href="#local-6989586621682975294"><span class="hs-identifier hs-type">bndrs1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975302"><span class="hs-identifier hs-type">rhss</span></a></span><span>
</span><span id="line-665"></span><span>
</span><span id="line-666"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#zipManyFloats"><span class="hs-identifier hs-type">zipManyFloats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621682975304"><span class="annot"><a href="#local-6989586621682975304"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975305"><span class="annot"><a href="#local-6989586621682975305"><span class="hs-identifier hs-var">rhss1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">unzip</span></span><span> </span><span class="annot"><a href="#local-6989586621682975298"><span class="hs-identifier hs-type">stuff</span></a></span><span>
</span><span id="line-667"></span><span>             </span><span class="hs-comment">-- Glom all floats into the Rec, *except* FloatStrings; see</span><span>
</span><span id="line-668"></span><span>             </span><span class="hs-comment">-- see Note [ANF-ising literal string arguments], Wrinkle (FS1)</span><span>
</span><span id="line-669"></span><span>             </span><span id="local-6989586621682975307"><span class="annot"><a href="#local-6989586621682975307"><span class="hs-identifier hs-var hs-var">is_lit</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Float"><span class="hs-identifier hs-type">Float</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682975309"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975309"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">BindInfo
</span><a href="GHC.CoreToStg.Prep.html#CaseBound"><span class="hs-identifier hs-var">CaseBound</span></a></span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#TopLvlFloatable"><span class="hs-identifier hs-var">TopLvlFloatable</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsTickedString"><span class="hs-identifier hs-var">exprIsTickedString</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975309"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-670"></span><span>             </span><span class="annot"><a href="#local-6989586621682975307"><span class="hs-identifier hs-var">is_lit</span></a></span><span> </span><span class="annot"><span class="annottext">FloatingBind
</span><span class="hs-identifier">_</span></span><span>                                                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-671"></span><span>             </span><span class="hs-special">(</span><span id="local-6989586621682975313"><span class="annot"><a href="#local-6989586621682975313"><span class="hs-identifier hs-var">string_floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975314"><span class="annot"><a href="#local-6989586621682975314"><span class="hs-identifier hs-var">top</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Data.OrdList.html#partitionOL"><span class="hs-identifier hs-type">partitionOL</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975307"><span class="hs-identifier hs-type">is_lit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#fs_binds"><span class="hs-identifier hs-var">fs_binds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975304"><span class="hs-identifier hs-type">floats</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-672"></span><span>                 </span><span class="hs-comment">-- Strings will *always* be in `top_floats` (we made sure of</span><span>
</span><span id="line-673"></span><span>                 </span><span class="hs-comment">-- that in `snocOL`), so that's the only field we need to</span><span>
</span><span id="line-674"></span><span>                 </span><span class="hs-comment">-- partition.</span><span>
</span><span id="line-675"></span><span>             </span><span id="local-6989586621682975317"><span class="annot"><a href="#local-6989586621682975317"><span class="hs-identifier hs-var hs-var">floats'</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975304"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#fs_binds"><span class="hs-identifier hs-var">fs_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682975314"><span class="hs-identifier hs-type">top</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-676"></span><span>             </span><span id="local-6989586621682975318"><span class="annot"><a href="#local-6989586621682975318"><span class="hs-identifier hs-var hs-var">all_pairs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FloatingBind -&gt; [(InVar, CpeRhs)] -&gt; [(InVar, CpeRhs)])
-&gt; [(InVar, CpeRhs)] -&gt; OrdList FloatingBind -&gt; [(InVar, CpeRhs)]
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; OrdList a -&gt; b
</span><a href="GHC.Data.OrdList.html#foldrOL"><span class="hs-identifier hs-var">foldrOL</span></a></span><span> </span><span class="annot"><span class="annottext">FloatingBind -&gt; [(InVar, CpeRhs)] -&gt; [(InVar, CpeRhs)]
</span><a href="#local-6989586621682975320"><span class="hs-identifier hs-var">add_float</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[InVar]
</span><a href="#local-6989586621682975294"><span class="hs-identifier hs-var">bndrs1</span></a></span><span> </span><span class="annot"><span class="annottext">[InVar] -&gt; [CpeRhs] -&gt; [(InVar, CpeRhs)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-operator hs-var">`zip`</span></span><span> </span><span class="annot"><span class="annottext">[CpeRhs]
</span><a href="#local-6989586621682975305"><span class="hs-identifier hs-var">rhss1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats -&gt; OrdList FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#getFloats"><span class="hs-identifier hs-var">getFloats</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975317"><span class="hs-identifier hs-var">floats'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-677"></span><span>       </span><span class="hs-comment">-- use env below, so that we reset cpe_rec_ids</span><span>
</span><span id="line-678"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#extendCorePrepEnvList"><span class="hs-identifier hs-type">extendCorePrepEnvList</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975293"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682975292"><span class="hs-identifier hs-type">bndrs</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">`zip`</span></span><span> </span><span class="annot"><a href="#local-6989586621682975294"><span class="hs-identifier hs-type">bndrs1</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-679"></span><span>                 </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#snocFloat"><span class="hs-identifier hs-type">snocFloat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-type">emptyFloats</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#fs_binds"><span class="hs-identifier hs-var">fs_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682975313"><span class="hs-identifier hs-type">string_floats</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-680"></span><span>                           </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Float"><span class="hs-identifier hs-type">Float</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975318"><span class="hs-identifier hs-type">all_pairs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#LetBound"><span class="hs-identifier hs-type">LetBound</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#TopLvlFloatable"><span class="hs-identifier hs-type">TopLvlFloatable</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-681"></span><span>                 </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-682"></span><span>
</span><span id="line-683"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-comment">-- See Note [Join points and floating]</span><span>
</span><span id="line-684"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975324"><span class="annot"><a href="#local-6989586621682975324"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975325"><span class="annot"><a href="#local-6989586621682975325"><span class="hs-identifier hs-var">bndrs1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; [InVar] -&gt; UniqSM (CorePrepEnv, [InVar])
</span><a href="GHC.CoreToStg.Prep.html#cpCloneBndrs"><span class="hs-identifier hs-var">cpCloneBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975288"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[InVar]
</span><a href="#local-6989586621682975292"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-685"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682975326"><span class="annot"><a href="#local-6989586621682975326"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; [InVar] -&gt; CorePrepEnv
</span><a href="GHC.CoreToStg.Prep.html#enterRecGroupRHSs"><span class="hs-identifier hs-var">enterRecGroupRHSs</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975324"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[InVar]
</span><a href="#local-6989586621682975325"><span class="hs-identifier hs-var">bndrs1</span></a></span><span>
</span><span id="line-686"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682975327"><span class="annot"><a href="#local-6989586621682975327"><span class="hs-identifier hs-var">pairs1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">zipWithM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeJoinPair"><span class="hs-identifier hs-type">cpeJoinPair</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975326"><span class="hs-identifier hs-type">env'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682975325"><span class="hs-identifier hs-type">bndrs1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975302"><span class="hs-identifier hs-type">rhss</span></a></span><span>
</span><span id="line-687"></span><span>
</span><span id="line-688"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682975328"><span class="annot"><a href="#local-6989586621682975328"><span class="hs-identifier hs-var hs-var">bndrs2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((InVar, CpeRhs) -&gt; InVar) -&gt; [(InVar, CpeRhs)] -&gt; [InVar]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(InVar, CpeRhs) -&gt; InVar
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(InVar, CpeRhs)]
</span><a href="#local-6989586621682975327"><span class="hs-identifier hs-var">pairs1</span></a></span><span>
</span><span id="line-689"></span><span>       </span><span class="hs-comment">-- use env below, so that we reset cpe_rec_ids</span><span>
</span><span id="line-690"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#extendCorePrepEnvList"><span class="hs-identifier hs-type">extendCorePrepEnvList</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975324"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682975292"><span class="hs-identifier hs-type">bndrs</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">`zip`</span></span><span> </span><span class="annot"><a href="#local-6989586621682975328"><span class="hs-identifier hs-type">bndrs2</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-691"></span><span>                 </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-type">emptyFloats</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-692"></span><span>                 </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975327"><span class="hs-identifier hs-type">pairs1</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-693"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-694"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682975292"><span class="annot"><span class="annottext">[InVar]
</span><a href="#local-6989586621682975292"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975302"><span class="annot"><span class="annottext">[CpeRhs]
</span><a href="#local-6989586621682975302"><span class="hs-identifier hs-var">rhss</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(InVar, CpeRhs)] -&gt; ([InVar], [CpeRhs])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">[(InVar, CpeRhs)]
</span><a href="#local-6989586621682975290"><span class="hs-identifier hs-var">pairs</span></a></span><span>
</span><span id="line-695"></span><span>
</span><span id="line-696"></span><span>    </span><span class="hs-comment">-- Flatten all the floats, and the current</span><span>
</span><span id="line-697"></span><span>    </span><span class="hs-comment">-- group into a single giant Rec</span><span>
</span><span id="line-698"></span><span>    </span><span id="local-6989586621682975320"><span class="annot"><span class="annottext">add_float :: FloatingBind -&gt; [(InVar, CpeRhs)] -&gt; [(InVar, CpeRhs)]
</span><a href="#local-6989586621682975320"><span class="hs-identifier hs-var hs-var">add_float</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Float"><span class="hs-identifier hs-type">Float</span></a></span><span> </span><span id="local-6989586621682975338"><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682975338"><span class="hs-identifier hs-var">bind</span></a></span></span><span> </span><span id="local-6989586621682975339"><span class="annot"><span class="annottext">BindInfo
</span><a href="#local-6989586621682975339"><span class="hs-identifier hs-var">bound</span></a></span></span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682975340"><span class="annot"><span class="annottext">[(InVar, CpeRhs)]
</span><a href="#local-6989586621682975340"><span class="hs-identifier hs-var">prs2</span></a></span></span><span>
</span><span id="line-699"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">BindInfo
</span><a href="#local-6989586621682975339"><span class="hs-identifier hs-var">bound</span></a></span><span> </span><span class="annot"><span class="annottext">BindInfo -&gt; BindInfo -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">BindInfo
</span><a href="GHC.CoreToStg.Prep.html#CaseBound"><span class="hs-identifier hs-var">CaseBound</span></a></span><span>
</span><span id="line-700"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">(InVar -&gt; Bool) -&gt; [InVar] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; (InVar -&gt; Bool) -&gt; InVar -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Bool
Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isUnliftedType"><span class="hs-identifier hs-var">isUnliftedType</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Bool) -&gt; (InVar -&gt; Type) -&gt; InVar -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">InVar -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBind -&gt; [InVar]
forall b. Bind b -&gt; [b]
</span><a href="GHC.Core.html#bindersOf"><span class="hs-identifier hs-var">bindersOf</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682975338"><span class="hs-identifier hs-var">bind</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-701"></span><span>           </span><span class="hs-comment">-- The latter check is hit in -O0 (i.e., flavours quick, devel2)</span><span>
</span><span id="line-702"></span><span>           </span><span class="hs-comment">-- for dictionary args which haven't been floated out yet, #24102.</span><span>
</span><span id="line-703"></span><span>           </span><span class="hs-comment">-- They are preferably CaseBound, but since they are lifted we may</span><span>
</span><span id="line-704"></span><span>           </span><span class="hs-comment">-- just as well put them in the Rec, in contrast to lifted bindings.</span><span>
</span><span id="line-705"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682975338"><span class="hs-identifier hs-var">bind</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-706"></span><span>          </span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span id="local-6989586621682975346"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975346"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621682975347"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975347"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975346"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975347"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InVar, CpeRhs) -&gt; [(InVar, CpeRhs)] -&gt; [(InVar, CpeRhs)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[(InVar, CpeRhs)]
</span><a href="#local-6989586621682975340"><span class="hs-identifier hs-var">prs2</span></a></span><span>
</span><span id="line-707"></span><span>          </span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span id="local-6989586621682975348"><span class="annot"><span class="annottext">[(InVar, CpeRhs)]
</span><a href="#local-6989586621682975348"><span class="hs-identifier hs-var">prs1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[(InVar, CpeRhs)]
</span><a href="#local-6989586621682975348"><span class="hs-identifier hs-var">prs1</span></a></span><span> </span><span class="annot"><span class="annottext">[(InVar, CpeRhs)] -&gt; [(InVar, CpeRhs)] -&gt; [(InVar, CpeRhs)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[(InVar, CpeRhs)]
</span><a href="#local-6989586621682975340"><span class="hs-identifier hs-var">prs2</span></a></span><span>
</span><span id="line-708"></span><span>    </span><span class="annot"><a href="#local-6989586621682975320"><span class="hs-identifier hs-var">add_float</span></a></span><span> </span><span id="local-6989586621682975349"><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621682975349"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="annot"><span class="annottext">[(InVar, CpeRhs)]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; [(InVar, CpeRhs)]
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;cpeBind&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FloatingBind -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621682975349"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-709"></span><span>
</span><span id="line-710"></span><span>
</span><span id="line-711"></span><span class="hs-comment">---------------</span><span>
</span><span id="line-712"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpePair"><span class="hs-identifier hs-type">cpePair</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#RecFlag"><span class="hs-identifier hs-type">RecFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-713"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-714"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-715"></span><span class="hs-comment">-- Used for all bindings</span><span>
</span><span id="line-716"></span><span class="hs-comment">-- The binder is already cloned, hence an OutId</span><span>
</span><span id="line-717"></span><span id="cpePair"><span class="annot"><span class="annottext">cpePair :: TopLevelFlag
-&gt; RecFlag
-&gt; Demand
-&gt; Bool
-&gt; CorePrepEnv
-&gt; InVar
-&gt; CpeRhs
-&gt; UniqSM (Floats, CpeRhs)
</span><a href="GHC.CoreToStg.Prep.html#cpePair"><span class="hs-identifier hs-var hs-var">cpePair</span></a></span></span><span> </span><span id="local-6989586621682975352"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682975352"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621682975353"><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621682975353"><span class="hs-identifier hs-var">is_rec</span></a></span></span><span> </span><span id="local-6989586621682975354"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682975354"><span class="hs-identifier hs-var">dmd</span></a></span></span><span> </span><span id="local-6989586621682975355"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682975355"><span class="hs-identifier hs-var">is_unlifted</span></a></span></span><span> </span><span id="local-6989586621682975356"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975356"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682975357"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975357"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682975358"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975358"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-718"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; UniqSM (Floats, CpeRhs) -&gt; UniqSM (Floats, CpeRhs)
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InVar -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975357"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(UniqSM (Floats, CpeRhs) -&gt; UniqSM (Floats, CpeRhs))
-&gt; UniqSM (Floats, CpeRhs) -&gt; UniqSM (Floats, CpeRhs)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-comment">-- those should use cpeJoinPair</span><span>
</span><span id="line-719"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975359"><span class="annot"><a href="#local-6989586621682975359"><span class="hs-identifier hs-var">floats1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975360"><span class="annot"><a href="#local-6989586621682975360"><span class="hs-identifier hs-var">rhs1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeRhs -&gt; UniqSM (Floats, CpeRhs)
</span><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975356"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975358"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-720"></span><span>
</span><span id="line-721"></span><span>       </span><span class="hs-comment">-- See if we are allowed to float this stuff out of the RHS</span><span>
</span><span id="line-722"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682975362"><span class="annot"><a href="#local-6989586621682975362"><span class="hs-identifier hs-var hs-var">dec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Floats -&gt; CpeRhs -&gt; FloatDecision
</span><a href="#local-6989586621682975363"><span class="hs-identifier hs-var">want_float_from_rhs</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975359"><span class="hs-identifier hs-var">floats1</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975360"><span class="hs-identifier hs-var">rhs1</span></a></span><span>
</span><span id="line-723"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975364"><span class="annot"><a href="#local-6989586621682975364"><span class="hs-identifier hs-var">floats2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975365"><span class="annot"><a href="#local-6989586621682975365"><span class="hs-identifier hs-var">rhs2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#executeFloatDecision"><span class="hs-identifier hs-type">executeFloatDecision</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975362"><span class="hs-identifier hs-type">dec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975359"><span class="hs-identifier hs-type">floats1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975360"><span class="hs-identifier hs-type">rhs1</span></a></span><span>
</span><span id="line-724"></span><span>
</span><span id="line-725"></span><span>       </span><span class="hs-comment">-- Make the arity match up</span><span>
</span><span id="line-726"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975367"><span class="annot"><a href="#local-6989586621682975367"><span class="hs-identifier hs-var">floats3</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975368"><span class="annot"><a href="#local-6989586621682975368"><span class="hs-identifier hs-var">rhs3</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-727"></span><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#manifestArity"><span class="hs-identifier hs-type">manifestArity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975360"><span class="hs-identifier hs-type">rhs1</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;=</span></span><span> </span><span class="annot"><a href="#local-6989586621682975371"><span class="hs-identifier hs-type">arity</span></a></span><span>
</span><span id="line-728"></span><span>               </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682975364"><span class="hs-identifier hs-type">floats2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeEtaExpand"><span class="hs-identifier hs-type">cpeEtaExpand</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975371"><span class="hs-identifier hs-type">arity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975365"><span class="hs-identifier hs-type">rhs2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-729"></span><span>               </span><span class="hs-keyword">else</span><span> </span><span class="annot"><a href="GHC.Utils.Trace.html#warnPprTrace"><span class="hs-identifier hs-type">warnPprTrace</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">True</span></span><span> </span><span class="annot"><span class="hs-string">&quot;CorePrep: silly extra arguments:&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975357"><span class="hs-identifier hs-type">bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-730"></span><span>                               </span><span class="hs-comment">-- Note [Silly extra arguments]</span><span>
</span><span id="line-731"></span><span>                    </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682975374"><span class="annot"><a href="#local-6989586621682975374"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#newVar"><span class="hs-identifier hs-type">newVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-type">idType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975357"><span class="hs-identifier hs-type">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-732"></span><span>                        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682975376"><span class="annot"><a href="#local-6989586621682975376"><span class="hs-identifier hs-var hs-var">float</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Bool -&gt; InVar -&gt; CpeRhs -&gt; FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#mkNonRecFloat"><span class="hs-identifier hs-var">mkNonRecFloat</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975356"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975374"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975365"><span class="hs-identifier hs-var">rhs2</span></a></span><span>
</span><span id="line-733"></span><span>                        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#snocFloat"><span class="hs-identifier hs-type">snocFloat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975364"><span class="hs-identifier hs-type">floats2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975376"><span class="hs-identifier hs-type">float</span></a></span><span>
</span><span id="line-734"></span><span>                                 </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeEtaExpand"><span class="hs-identifier hs-type">cpeEtaExpand</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975371"><span class="hs-identifier hs-type">arity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975374"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-735"></span><span>
</span><span id="line-736"></span><span>        </span><span class="hs-comment">-- Wrap floating ticks</span><span>
</span><span id="line-737"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975377"><span class="annot"><a href="#local-6989586621682975377"><span class="hs-identifier hs-var">floats4</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975378"><span class="annot"><a href="#local-6989586621682975378"><span class="hs-identifier hs-var">rhs4</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#wrapTicks"><span class="hs-identifier hs-type">wrapTicks</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975367"><span class="hs-identifier hs-type">floats3</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975368"><span class="hs-identifier hs-type">rhs3</span></a></span><span>
</span><span id="line-738"></span><span>
</span><span id="line-739"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682975377"><span class="hs-identifier hs-type">floats4</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682975378"><span class="hs-identifier hs-type">rhs4</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-740"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-741"></span><span>    </span><span id="local-6989586621682975371"><span class="annot"><span class="annottext">arity :: Int
</span><a href="#local-6989586621682975371"><span class="hs-identifier hs-var hs-var">arity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InVar -&gt; Int
</span><a href="GHC.Types.Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975357"><span class="hs-identifier hs-var">bndr</span></a></span><span>        </span><span class="hs-comment">-- We must match this arity</span><span>
</span><span id="line-742"></span><span>
</span><span id="line-743"></span><span>    </span><span id="local-6989586621682975363"><span class="annot"><span class="annottext">want_float_from_rhs :: Floats -&gt; CpeRhs -&gt; FloatDecision
</span><a href="#local-6989586621682975363"><span class="hs-identifier hs-var hs-var">want_float_from_rhs</span></a></span></span><span> </span><span id="local-6989586621682975381"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975381"><span class="hs-identifier hs-var">floats</span></a></span></span><span> </span><span id="local-6989586621682975382"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975382"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-744"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; Bool
</span><a href="GHC.Types.Basic.html#isTopLevel"><span class="hs-identifier hs-var">isTopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682975352"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Floats -&gt; FloatDecision
</span><a href="GHC.CoreToStg.Prep.html#wantFloatTop"><span class="hs-identifier hs-var">wantFloatTop</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975381"><span class="hs-identifier hs-var">floats</span></a></span><span>
</span><span id="line-745"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RecFlag -&gt; Demand -&gt; Bool -&gt; Floats -&gt; CpeRhs -&gt; FloatDecision
</span><a href="GHC.CoreToStg.Prep.html#wantFloatLocal"><span class="hs-identifier hs-var">wantFloatLocal</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621682975353"><span class="hs-identifier hs-var">is_rec</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682975354"><span class="hs-identifier hs-var">dmd</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682975355"><span class="hs-identifier hs-var">is_unlifted</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975381"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975382"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-746"></span><span>
</span><span id="line-747"></span><span class="hs-comment">{- Note [Silly extra arguments]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we had this
        f{arity=1} = \x\y. e
We *must* match the arity on the Id, so we have to generate
        f' = \x\y. e
        f  = \x. f' x

It's a bizarre case: why is the arity on the Id wrong?  Reason
(in the days of __inline_me__):
        f{arity=0} = __inline_me__ (let v = expensive in \xy. e)
When InlineMe notes go away this won't happen any more.  But
it seems good for CorePrep to be robust.
-}</span><span>
</span><span id="line-761"></span><span>
</span><span id="line-762"></span><span class="hs-comment">---------------</span><span>
</span><span id="line-763"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeJoinPair"><span class="hs-identifier hs-type">cpeJoinPair</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#JoinId"><span class="hs-identifier hs-type">JoinId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-764"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#JoinId"><span class="hs-identifier hs-type">JoinId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-765"></span><span class="hs-comment">-- Used for all join bindings</span><span>
</span><span id="line-766"></span><span class="hs-comment">-- No eta-expansion: see Note [Do not eta-expand join points] in GHC.Core.Opt.Simplify.Utils</span><span>
</span><span id="line-767"></span><span id="cpeJoinPair"><span class="annot"><span class="annottext">cpeJoinPair :: CorePrepEnv -&gt; InVar -&gt; CpeRhs -&gt; UniqSM (InVar, CpeRhs)
</span><a href="GHC.CoreToStg.Prep.html#cpeJoinPair"><span class="hs-identifier hs-var hs-var">cpeJoinPair</span></a></span></span><span> </span><span id="local-6989586621682975386"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975386"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682975387"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975387"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682975388"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975388"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-768"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; UniqSM (InVar, CpeRhs) -&gt; UniqSM (InVar, CpeRhs)
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InVar -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975387"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(UniqSM (InVar, CpeRhs) -&gt; UniqSM (InVar, CpeRhs))
-&gt; UniqSM (InVar, CpeRhs) -&gt; UniqSM (InVar, CpeRhs)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-769"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#JoinPoint"><span class="hs-identifier hs-type">JoinPoint</span></a></span><span> </span><span id="local-6989586621682975390"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682975390"><span class="hs-identifier hs-var hs-var">join_arity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InVar -&gt; JoinPointHood
</span><a href="GHC.Types.Id.html#idJoinPointHood"><span class="hs-identifier hs-var">idJoinPointHood</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975387"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-770"></span><span>             </span><span class="hs-special">(</span><span id="local-6989586621682975392"><span class="annot"><span class="annottext">[InVar]
</span><a href="#local-6989586621682975392"><span class="hs-identifier hs-var hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975393"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975393"><span class="hs-identifier hs-var hs-var">body</span></a></span></span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CpeRhs -&gt; ([InVar], CpeRhs)
forall b. Int -&gt; Expr b -&gt; ([b], Expr b)
</span><a href="GHC.Core.html#collectNBinders"><span class="hs-identifier hs-var">collectNBinders</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682975390"><span class="hs-identifier hs-var">join_arity</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975388"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-771"></span><span>
</span><span id="line-772"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975395"><span class="annot"><a href="#local-6989586621682975395"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975396"><span class="annot"><a href="#local-6989586621682975396"><span class="hs-identifier hs-var">bndrs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; [InVar] -&gt; UniqSM (CorePrepEnv, [InVar])
</span><a href="GHC.CoreToStg.Prep.html#cpCloneBndrs"><span class="hs-identifier hs-var">cpCloneBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975386"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[InVar]
</span><a href="#local-6989586621682975392"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-773"></span><span>
</span><span id="line-774"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682975397"><span class="annot"><a href="#local-6989586621682975397"><span class="hs-identifier hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeBodyNF"><span class="hs-identifier hs-type">cpeBodyNF</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975395"><span class="hs-identifier hs-type">env'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975393"><span class="hs-identifier hs-type">body</span></a></span><span> </span><span class="hs-comment">-- Will let-bind the body if it starts</span><span>
</span><span id="line-775"></span><span>                                      </span><span class="hs-comment">-- with a lambda</span><span>
</span><span id="line-776"></span><span>
</span><span id="line-777"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682975398"><span class="annot"><a href="#local-6989586621682975398"><span class="hs-identifier hs-var hs-var">rhs'</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[InVar] -&gt; CpeRhs -&gt; CpeRhs
</span><a href="GHC.Core.Make.html#mkCoreLams"><span class="hs-identifier hs-var">mkCoreLams</span></a></span><span> </span><span class="annot"><span class="annottext">[InVar]
</span><a href="#local-6989586621682975396"><span class="hs-identifier hs-var">bndrs'</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975397"><span class="hs-identifier hs-var">body'</span></a></span><span>
</span><span id="line-778"></span><span>             </span><span id="local-6989586621682975400"><span class="annot"><a href="#local-6989586621682975400"><span class="hs-identifier hs-var hs-var">bndr'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975387"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">InVar -&gt; Unfolding -&gt; InVar
</span><a href="GHC.Types.Id.html#setIdUnfolding"><span class="hs-operator hs-var">`setIdUnfolding`</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="GHC.Core.html#evaldUnfolding"><span class="hs-identifier hs-var">evaldUnfolding</span></a></span><span>
</span><span id="line-779"></span><span>                          </span><span class="annot"><span class="annottext">InVar -&gt; Int -&gt; InVar
</span><a href="GHC.Types.Id.html#setIdArity"><span class="hs-operator hs-var">`setIdArity`</span></a></span><span> </span><span class="annot"><span class="annottext">(InVar -&gt; Bool) -&gt; [InVar] -&gt; Int
forall a. (a -&gt; Bool) -&gt; [a] -&gt; Int
</span><a href="GHC.Utils.Misc.html#count"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="annot"><span class="annottext">InVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">[InVar]
</span><a href="#local-6989586621682975392"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-780"></span><span>                            </span><span class="hs-comment">-- See Note [Arity and join points]</span><span>
</span><span id="line-781"></span><span>
</span><span id="line-782"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682975400"><span class="hs-identifier hs-type">bndr'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682975398"><span class="hs-identifier hs-type">rhs'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-783"></span><span>
</span><span id="line-784"></span><span class="hs-comment">{-
Note [Arity and join points]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Up to now, we've allowed a join point to have an arity greater than its join
arity (minus type arguments), since this is what's useful for eta expansion.
However, for code gen purposes, its arity must be exactly the number of value
arguments it will be called with, and it must have exactly that many value
lambdas. Hence if there are extra lambdas we must let-bind the body of the RHS:

  join j x y z = \w -&gt; ... in ...
    =&gt;
  join j x y z = (let f = \w -&gt; ... in f) in ...

This is also what happens with Note [Silly extra arguments]. Note that it's okay
for us to mess with the arity because a join point is never exported.
-}</span><span>
</span><span id="line-800"></span><span>
</span><span id="line-801"></span><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><span id="line-802"></span><span class="hs-comment">--              CpeRhs: produces a result satisfying CpeRhs</span><span>
</span><span id="line-803"></span><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><span id="line-804"></span><span>
</span><span id="line-805"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-type">cpeRhsE</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-806"></span><span class="hs-comment">-- If</span><span>
</span><span id="line-807"></span><span class="hs-comment">--      e  ===&gt;  (bs, e')</span><span>
</span><span id="line-808"></span><span class="hs-comment">-- then</span><span>
</span><span id="line-809"></span><span class="hs-comment">--      e = let bs in e'        (semantically, that is!)</span><span>
</span><span id="line-810"></span><span class="hs-comment">--</span><span>
</span><span id="line-811"></span><span class="hs-comment">-- For example</span><span>
</span><span id="line-812"></span><span class="hs-comment">--      f (g x)   ===&gt;   ([v = g x], f v)</span><span>
</span><span id="line-813"></span><span>
</span><span id="line-814"></span><span id="cpeRhsE"><span class="annot"><span class="annottext">cpeRhsE :: CorePrepEnv -&gt; CpeRhs -&gt; UniqSM (Floats, CpeRhs)
</span><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var hs-var">cpeRhsE</span></a></span></span><span> </span><span id="local-6989586621682975406"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975406"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span id="local-6989586621682975408"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682975408"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-815"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeRhs) -&gt; UniqSM (Floats, CpeRhs)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type -&gt; CpeRhs
forall b. Type -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Type -&gt; Type
</span><a href="GHC.CoreToStg.Prep.html#cpSubstTy"><span class="hs-identifier hs-var">cpSubstTy</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975406"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682975408"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-816"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span id="local-6989586621682975410"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975410"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span id="local-6989586621682975412"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682975412"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-817"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeRhs) -&gt; UniqSM (Floats, CpeRhs)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; CpeRhs
forall b. Coercion -&gt; Expr b
</span><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Coercion -&gt; Coercion
</span><a href="GHC.CoreToStg.Prep.html#cpSubstCo"><span class="hs-identifier hs-var">cpSubstCo</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975410"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682975412"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-818"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span id="local-6989586621682975414"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975414"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682975415"><span class="annot"><span class="annottext">expr :: CpeRhs
</span><a href="#local-6989586621682975415"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-type">Lit</span></a></span><span> </span><span id="local-6989586621682975417"><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621682975417"><span class="hs-identifier hs-var">lit</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-819"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Types.Literal.html#LitNumber"><span class="hs-identifier hs-type">LitNumber</span></a></span><span> </span><span class="annot"><span class="annottext">LitNumType
</span><a href="GHC.Types.Literal.html#LitNumBigNat"><span class="hs-identifier hs-var">LitNumBigNat</span></a></span><span> </span><span id="local-6989586621682975420"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621682975420"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621682975417"><span class="hs-identifier hs-var">lit</span></a></span><span>
</span><span id="line-820"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Integer -&gt; UniqSM (Floats, CpeRhs)
</span><a href="GHC.CoreToStg.Prep.html#cpeBigNatLit"><span class="hs-identifier hs-var">cpeBigNatLit</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975414"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621682975420"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-821"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeRhs) -&gt; UniqSM (Floats, CpeRhs)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975415"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-822"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span id="local-6989586621682975422"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975422"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682975423"><span class="annot"><span class="annottext">expr :: CpeRhs
</span><a href="#local-6989586621682975423"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeRhs -&gt; UniqSM (Floats, CpeRhs)
</span><a href="GHC.CoreToStg.Prep.html#cpeApp"><span class="hs-identifier hs-var">cpeApp</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975422"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975423"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-823"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span id="local-6989586621682975425"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975425"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682975426"><span class="annot"><span class="annottext">expr :: CpeRhs
</span><a href="#local-6989586621682975426"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeRhs -&gt; UniqSM (Floats, CpeRhs)
</span><a href="GHC.CoreToStg.Prep.html#cpeApp"><span class="hs-identifier hs-var">cpeApp</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975425"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975426"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-824"></span><span>
</span><span id="line-825"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span id="local-6989586621682975428"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975428"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621682975430"><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682975430"><span class="hs-identifier hs-var">bind</span></a></span></span><span> </span><span id="local-6989586621682975431"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975431"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-826"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975432"><span class="annot"><a href="#local-6989586621682975432"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975433"><span class="annot"><a href="#local-6989586621682975433"><span class="hs-identifier hs-var">bind_floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975434"><span class="annot"><a href="#local-6989586621682975434"><span class="hs-identifier hs-var">maybe_bind'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
-&gt; CorePrepEnv
-&gt; CoreBind
-&gt; UniqSM (CorePrepEnv, Floats, Maybe CoreBind)
</span><a href="GHC.CoreToStg.Prep.html#cpeBind"><span class="hs-identifier hs-var">cpeBind</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="GHC.Types.Basic.html#NotTopLevel"><span class="hs-identifier hs-var">NotTopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975428"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682975430"><span class="hs-identifier hs-var">bind</span></a></span><span>
</span><span id="line-827"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975436"><span class="annot"><a href="#local-6989586621682975436"><span class="hs-identifier hs-var">body_floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975437"><span class="annot"><a href="#local-6989586621682975437"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-type">cpeRhsE</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975432"><span class="hs-identifier hs-type">env'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975431"><span class="hs-identifier hs-type">body</span></a></span><span>
</span><span id="line-828"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682975438"><span class="annot"><a href="#local-6989586621682975438"><span class="hs-identifier hs-var hs-var">expr'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe CoreBind
</span><a href="#local-6989586621682975434"><span class="hs-identifier hs-var">maybe_bind'</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682975439"><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682975439"><span class="hs-identifier hs-var">bind'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CoreBind -&gt; CpeRhs -&gt; CpeRhs
forall b. Bind b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682975439"><span class="hs-identifier hs-var">bind'</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975437"><span class="hs-identifier hs-var">body'</span></a></span><span>
</span><span id="line-829"></span><span>                                         </span><span class="annot"><span class="annottext">Maybe CoreBind
</span><span class="hs-identifier hs-var">Nothing</span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975437"><span class="hs-identifier hs-var">body'</span></a></span><span>
</span><span id="line-830"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682975433"><span class="hs-identifier hs-type">bind_floats</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#appFloats"><span class="hs-operator hs-type">`appFloats`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975436"><span class="hs-identifier hs-type">body_floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682975438"><span class="hs-identifier hs-type">expr'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-831"></span><span>
</span><span id="line-832"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span id="local-6989586621682975441"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975441"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621682975442"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682975442"><span class="hs-identifier hs-var">tickish</span></a></span></span><span> </span><span id="local-6989586621682975443"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975443"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-833"></span><span>  </span><span class="hs-comment">-- Pull out ticks if they are allowed to be floated.</span><span>
</span><span id="line-834"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682975442"><span class="hs-identifier hs-var">tickish</span></a></span><span>
</span><span id="line-835"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975445"><span class="annot"><a href="#local-6989586621682975445"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975446"><span class="annot"><a href="#local-6989586621682975446"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeRhs -&gt; UniqSM (Floats, CpeRhs)
</span><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975441"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975443"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-836"></span><span>         </span><span class="hs-comment">-- See [Floating Ticks in CorePrep]</span><span>
</span><span id="line-837"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatTick"><span class="hs-identifier hs-type">FloatTick</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975442"><span class="hs-identifier hs-type">tickish</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#consFloat"><span class="hs-operator hs-type">`consFloat`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975445"><span class="hs-identifier hs-type">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682975446"><span class="hs-identifier hs-type">body</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-838"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-839"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682975449"><span class="annot"><a href="#local-6989586621682975449"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeRhs -&gt; UniqSM CpeRhs
</span><a href="GHC.CoreToStg.Prep.html#cpeBodyNF"><span class="hs-identifier hs-var">cpeBodyNF</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975441"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975443"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-840"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-type">emptyFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#mkTick"><span class="hs-identifier hs-type">mkTick</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975451"><span class="hs-identifier hs-type">tickish'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975449"><span class="hs-identifier hs-type">body</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-841"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-842"></span><span>    </span><span id="local-6989586621682975451"><span class="annot"><span class="annottext">tickish' :: CoreTickish
</span><a href="#local-6989586621682975451"><span class="hs-identifier hs-var hs-var">tickish'</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Types.Tickish.html#Breakpoint"><span class="hs-identifier hs-type">Breakpoint</span></a></span><span> </span><span id="local-6989586621682975453"><span class="annot"><span class="annottext">XBreakpoint 'TickishPassCore
</span><a href="#local-6989586621682975453"><span class="hs-identifier hs-var">ext</span></a></span></span><span> </span><span id="local-6989586621682975454"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682975454"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621682975455"><span class="annot"><span class="annottext">[XTickishId 'TickishPassCore]
</span><a href="#local-6989586621682975455"><span class="hs-identifier hs-var">fvs</span></a></span></span><span> </span><span id="local-6989586621682975456"><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682975456"><span class="hs-identifier hs-var">modl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682975442"><span class="hs-identifier hs-var">tickish</span></a></span><span>
</span><span id="line-843"></span><span>             </span><span class="hs-comment">-- See also 'substTickish'</span><span>
</span><span id="line-844"></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">XBreakpoint 'TickishPassCore
-&gt; Int -&gt; [XTickishId 'TickishPassCore] -&gt; Module -&gt; CoreTickish
forall (pass :: TickishPass).
XBreakpoint pass
-&gt; Int -&gt; [XTickishId pass] -&gt; Module -&gt; GenTickish pass
</span><a href="GHC.Types.Tickish.html#Breakpoint"><span class="hs-identifier hs-var">Breakpoint</span></a></span><span> </span><span class="annot"><span class="annottext">XBreakpoint 'TickishPassCore
</span><a href="#local-6989586621682975453"><span class="hs-identifier hs-var">ext</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682975454"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(InVar -&gt; InVar) -&gt; [InVar] -&gt; [InVar]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CpeRhs -&gt; InVar
CpeRhs -&gt; InVar
</span><a href="GHC.Core.Utils.html#getIdFromTrivialExpr"><span class="hs-identifier hs-var">getIdFromTrivialExpr</span></a></span><span> </span><span class="annot"><span class="annottext">(CpeRhs -&gt; InVar) -&gt; (InVar -&gt; CpeRhs) -&gt; InVar -&gt; InVar
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; InVar -&gt; CpeRhs
</span><a href="GHC.CoreToStg.Prep.html#lookupCorePrepEnv"><span class="hs-identifier hs-var">lookupCorePrepEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975441"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[InVar]
[XTickishId 'TickishPassCore]
</span><a href="#local-6989586621682975455"><span class="hs-identifier hs-var">fvs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682975456"><span class="hs-identifier hs-var">modl</span></a></span><span>
</span><span id="line-845"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-846"></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682975442"><span class="hs-identifier hs-var">tickish</span></a></span><span>
</span><span id="line-847"></span><span>
</span><span id="line-848"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span id="local-6989586621682975459"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975459"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682975461"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975461"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span id="local-6989586621682975462"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682975462"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-849"></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975463"><span class="annot"><a href="#local-6989586621682975463"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975464"><span class="annot"><a href="#local-6989586621682975464"><span class="hs-identifier hs-var">expr'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeRhs -&gt; UniqSM (Floats, CpeRhs)
</span><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975459"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975461"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-850"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682975463"><span class="hs-identifier hs-type">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975464"><span class="hs-identifier hs-type">expr'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpSubstCo"><span class="hs-identifier hs-type">cpSubstCo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975459"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975462"><span class="hs-identifier hs-type">co</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-851"></span><span>
</span><span id="line-852"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span id="local-6989586621682975465"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975465"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682975466"><span class="annot"><span class="annottext">expr :: CpeRhs
</span><a href="#local-6989586621682975466"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-853"></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975468"><span class="annot"><span class="annottext">[InVar]
</span><a href="#local-6989586621682975468"><span class="hs-identifier hs-var hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682975469"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975469"><span class="hs-identifier hs-var hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; ([InVar], CpeRhs)
forall b. Expr b -&gt; ([b], Expr b)
</span><a href="GHC.Core.html#collectBinders"><span class="hs-identifier hs-var">collectBinders</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975466"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-854"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975471"><span class="annot"><a href="#local-6989586621682975471"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975472"><span class="annot"><a href="#local-6989586621682975472"><span class="hs-identifier hs-var">bndrs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; [InVar] -&gt; UniqSM (CorePrepEnv, [InVar])
</span><a href="GHC.CoreToStg.Prep.html#cpCloneBndrs"><span class="hs-identifier hs-var">cpCloneBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975465"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[InVar]
</span><a href="#local-6989586621682975468"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-855"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682975473"><span class="annot"><a href="#local-6989586621682975473"><span class="hs-identifier hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeBodyNF"><span class="hs-identifier hs-type">cpeBodyNF</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975471"><span class="hs-identifier hs-type">env'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975469"><span class="hs-identifier hs-type">body</span></a></span><span>
</span><span id="line-856"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-type">emptyFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#mkLams"><span class="hs-identifier hs-type">mkLams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975472"><span class="hs-identifier hs-type">bndrs'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975473"><span class="hs-identifier hs-type">body'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-857"></span><span>
</span><span id="line-858"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span id="local-6989586621682975475"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975475"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span id="local-6989586621682975477"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975477"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621682975478"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975478"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682975479"><span class="annot"><span class="annottext">alts :: [Alt InVar]
</span><a href="#local-6989586621682975479"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span id="local-6989586621682975481"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682975481"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span class="hs-special">[</span><span id="local-6989586621682975482"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975482"><span class="hs-identifier hs-var">covar</span></a></span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><span class="hs-identifier">_</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-859"></span><span>  </span><span class="hs-comment">-- See (U3) in Note [Implementing unsafeCoerce]</span><span>
</span><span id="line-860"></span><span>  </span><span class="hs-comment">-- We need make the Case float, otherwise we get</span><span>
</span><span id="line-861"></span><span>  </span><span class="hs-comment">--   let x = case ... of UnsafeRefl co -&gt;</span><span>
</span><span id="line-862"></span><span>  </span><span class="hs-comment">--           let y = expr in</span><span>
</span><span id="line-863"></span><span>  </span><span class="hs-comment">--           K y</span><span>
</span><span id="line-864"></span><span>  </span><span class="hs-comment">--   in f x</span><span>
</span><span id="line-865"></span><span>  </span><span class="hs-comment">-- instead of</span><span>
</span><span id="line-866"></span><span>  </span><span class="hs-comment">--   case ... of UnsafeRefl co -&gt;</span><span>
</span><span id="line-867"></span><span>  </span><span class="hs-comment">--   let y = expr in</span><span>
</span><span id="line-868"></span><span>  </span><span class="hs-comment">--   let x = K y</span><span>
</span><span id="line-869"></span><span>  </span><span class="hs-comment">--   in f x</span><span>
</span><span id="line-870"></span><span>  </span><span class="hs-comment">-- Note that `x` is a value here. This is visible in the GHCi debugger tests</span><span>
</span><span id="line-871"></span><span>  </span><span class="hs-comment">-- (such as `print003`).</span><span>
</span><span id="line-872"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682975483"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975483"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; InVar -&gt; [Alt InVar] -&gt; Maybe CpeRhs
</span><a href="GHC.Core.Utils.html#isUnsafeEqualityCase"><span class="hs-identifier hs-var">isUnsafeEqualityCase</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975477"><span class="hs-identifier hs-var">scrut</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975478"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt InVar]
</span><a href="#local-6989586621682975479"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-873"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975485"><span class="annot"><a href="#local-6989586621682975485"><span class="hs-identifier hs-var">floats_scrut</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975486"><span class="annot"><a href="#local-6989586621682975486"><span class="hs-identifier hs-var">scrut</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeRhs -&gt; UniqSM (Floats, CpeRhs)
</span><a href="GHC.CoreToStg.Prep.html#cpeBody"><span class="hs-identifier hs-var">cpeBody</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975475"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975477"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-874"></span><span>
</span><span id="line-875"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975488"><span class="annot"><a href="#local-6989586621682975488"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975489"><span class="annot"><a href="#local-6989586621682975489"><span class="hs-identifier hs-var">bndr'</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpCloneBndr"><span class="hs-identifier hs-type">cpCloneBndr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975475"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975478"><span class="hs-identifier hs-type">bndr</span></a></span><span>
</span><span id="line-876"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975490"><span class="annot"><a href="#local-6989586621682975490"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975491"><span class="annot"><a href="#local-6989586621682975491"><span class="hs-identifier hs-var">covar'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpCloneCoVarBndr"><span class="hs-identifier hs-type">cpCloneCoVarBndr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975488"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975482"><span class="hs-identifier hs-type">covar</span></a></span><span>
</span><span id="line-877"></span><span>                          </span><span class="hs-comment">-- Important: here we clone the CoVar</span><span>
</span><span id="line-878"></span><span>                          </span><span class="hs-comment">-- See Note [Cloning CoVars and TyVars]</span><span>
</span><span id="line-879"></span><span>
</span><span id="line-880"></span><span>         </span><span class="hs-comment">-- Up until here this should do exactly the same as the regular code</span><span>
</span><span id="line-881"></span><span>         </span><span class="hs-comment">-- path of `cpeRhsE Case{}`.</span><span>
</span><span id="line-882"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975493"><span class="annot"><a href="#local-6989586621682975493"><span class="hs-identifier hs-var">floats_rhs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975494"><span class="annot"><a href="#local-6989586621682975494"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeBody"><span class="hs-identifier hs-type">cpeBody</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975490"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975483"><span class="hs-identifier hs-type">rhs</span></a></span><span>
</span><span id="line-883"></span><span>         </span><span class="hs-comment">-- ... but we want to float `floats_rhs` as in (U3) so that rhs' might</span><span>
</span><span id="line-884"></span><span>         </span><span class="hs-comment">-- become a value</span><span>
</span><span id="line-885"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682975495"><span class="annot"><a href="#local-6989586621682975495"><span class="hs-identifier hs-var hs-var">case_float</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; InVar -&gt; AltCon -&gt; [InVar] -&gt; FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#UnsafeEqualityCase"><span class="hs-identifier hs-var">UnsafeEqualityCase</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975486"><span class="hs-identifier hs-var">scrut</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975489"><span class="hs-identifier hs-var">bndr'</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682975481"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975491"><span class="hs-identifier hs-var">covar'</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-886"></span><span>         </span><span class="hs-comment">-- NB: It is OK to &quot;evaluate&quot; the proof eagerly.</span><span>
</span><span id="line-887"></span><span>         </span><span class="hs-comment">--     Usually there's the danger that we float the unsafeCoerce out of</span><span>
</span><span id="line-888"></span><span>         </span><span class="hs-comment">--     a branching Case alt. Not so here, because the regular code path</span><span>
</span><span id="line-889"></span><span>         </span><span class="hs-comment">--     for `cpeRhsE Case{}` will not float out of alts.</span><span>
</span><span id="line-890"></span><span>             </span><span id="local-6989586621682975497"><span class="annot"><a href="#local-6989586621682975497"><span class="hs-identifier hs-var hs-var">floats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Floats -&gt; FloatingBind -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#snocFloat"><span class="hs-identifier hs-var">snocFloat</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975485"><span class="hs-identifier hs-var">floats_scrut</span></a></span><span> </span><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621682975495"><span class="hs-identifier hs-var">case_float</span></a></span><span> </span><span class="annot"><span class="annottext">Floats -&gt; Floats -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#appFloats"><span class="hs-operator hs-var">`appFloats`</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975493"><span class="hs-identifier hs-var">floats_rhs</span></a></span><span>
</span><span id="line-891"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682975497"><span class="hs-identifier hs-type">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682975494"><span class="hs-identifier hs-type">rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-892"></span><span>
</span><span id="line-893"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span id="local-6989586621682975498"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975498"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span id="local-6989586621682975499"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975499"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621682975500"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975500"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#DataAlt"><span class="hs-identifier hs-type">DataAlt</span></a></span><span> </span><span id="local-6989586621682975502"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682975502"><span class="hs-identifier hs-var">dc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span id="local-6989586621682975503"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975503"><span class="hs-identifier hs-var">token_out</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975504"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975504"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">]</span><span> </span><span id="local-6989586621682975505"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975505"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-894"></span><span>  </span><span class="hs-comment">-- See item (SEQ4) of Note [seq# magic]. We want to match</span><span>
</span><span id="line-895"></span><span>  </span><span class="hs-comment">--   case seq# @a @RealWorld &lt;ok-to-discard&gt; s of (# s', _ #) -&gt; rhs[s']</span><span>
</span><span id="line-896"></span><span>  </span><span class="hs-comment">-- and simplify to rhs[s]. Triggers in T15226.</span><span>
</span><span id="line-897"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; Bool
</span><a href="GHC.Core.DataCon.html#isUnboxedTupleDataCon"><span class="hs-identifier hs-var">isUnboxedTupleDataCon</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682975502"><span class="hs-identifier hs-var">dc</span></a></span><span>
</span><span id="line-898"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682975507"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975507"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">,</span><span class="hs-special">[</span><span id="local-6989586621682975508"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975508"><span class="hs-identifier hs-var">_ty1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975509"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975509"><span class="hs-identifier hs-var">_ty2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975510"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975510"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682975511"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975511"><span class="hs-identifier hs-var">token_in</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; (CpeRhs, [CpeRhs])
forall b. Expr b -&gt; (Expr b, [Expr b])
</span><a href="GHC.Core.html#collectArgs"><span class="hs-identifier hs-var">collectArgs</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975499"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-899"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975507"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">InVar -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#seqHashKey"><span class="hs-identifier hs-var">seqHashKey</span></a></span><span>
</span><span id="line-900"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprOkToDiscard"><span class="hs-identifier hs-var">exprOkToDiscard</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975510"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-901"></span><span>      </span><span class="hs-comment">-- ok-to-discard, because we want to discard the evaluation of `arg`.</span><span>
</span><span id="line-902"></span><span>      </span><span class="hs-comment">-- ok-to-discard includes ok-for-spec, but *also* CanFail primops such as</span><span>
</span><span id="line-903"></span><span>      </span><span class="hs-comment">-- `quotInt# 1# 0#`, but not ThrowsException primops.</span><span>
</span><span id="line-904"></span><span>      </span><span class="hs-comment">-- See Note [Classifying primop effects]</span><span>
</span><span id="line-905"></span><span>      </span><span class="hs-comment">-- and Note [Transformations affected by primop effects] for why this is</span><span>
</span><span id="line-906"></span><span>      </span><span class="hs-comment">-- the correct choice.</span><span>
</span><span id="line-907"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682975516"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975516"><span class="hs-identifier hs-var">token_in'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; InVar -&gt; CpeRhs
</span><a href="GHC.CoreToStg.Prep.html#lookupCorePrepEnv"><span class="hs-identifier hs-var">lookupCorePrepEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975498"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975511"><span class="hs-identifier hs-var">token_in</span></a></span><span>
</span><span id="line-908"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InVar -&gt; Bool
</span><a href="GHC.Types.Id.html#isDeadBinder"><span class="hs-identifier hs-var">isDeadBinder</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975504"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InVar -&gt; Bool
</span><a href="GHC.Types.Id.html#isDeadBinder"><span class="hs-identifier hs-var">isDeadBinder</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975500"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-909"></span><span>      </span><span class="hs-comment">-- Check that bndr and res are dead</span><span>
</span><span id="line-910"></span><span>      </span><span class="hs-comment">-- We can rely on `isDeadBinder res`, despite the fact that the Simplifier</span><span>
</span><span id="line-911"></span><span>      </span><span class="hs-comment">-- often zaps the OccInfo on case-alternative binders (see Note [DataAlt occ info]</span><span>
</span><span id="line-912"></span><span>      </span><span class="hs-comment">-- in GHC.Core.Opt.Simplify.Iteration) because the scrutinee is not a</span><span>
</span><span id="line-913"></span><span>      </span><span class="hs-comment">-- variable, and in that case the zapping doesn't happen; see that Note.</span><span>
</span><span id="line-914"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeRhs -&gt; UniqSM (Floats, CpeRhs)
</span><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepEnv -&gt; InVar -&gt; InVar -&gt; CorePrepEnv
</span><a href="GHC.CoreToStg.Prep.html#extendCorePrepEnv"><span class="hs-identifier hs-var">extendCorePrepEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975498"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975503"><span class="hs-identifier hs-var">token_out</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975516"><span class="hs-identifier hs-var">token_in'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975505"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-915"></span><span>
</span><span id="line-916"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span id="local-6989586621682975518"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975518"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span id="local-6989586621682975519"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975519"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621682975520"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975520"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682975521"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682975521"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621682975522"><span class="annot"><span class="annottext">[Alt InVar]
</span><a href="#local-6989586621682975522"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-917"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975523"><span class="annot"><a href="#local-6989586621682975523"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975524"><span class="annot"><a href="#local-6989586621682975524"><span class="hs-identifier hs-var">scrut'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeRhs -&gt; UniqSM (Floats, CpeRhs)
</span><a href="GHC.CoreToStg.Prep.html#cpeBody"><span class="hs-identifier hs-var">cpeBody</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975518"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975519"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-918"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975525"><span class="annot"><a href="#local-6989586621682975525"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975526"><span class="annot"><a href="#local-6989586621682975526"><span class="hs-identifier hs-var">bndr2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpCloneBndr"><span class="hs-identifier hs-type">cpCloneBndr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975518"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975520"><span class="hs-identifier hs-type">bndr</span></a></span><span>
</span><span id="line-919"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682975527"><span class="annot"><a href="#local-6989586621682975527"><span class="hs-identifier hs-var hs-var">alts'</span></a></span></span><span>
</span><span id="line-920"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CorePrepConfig -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#cp_catchNonexhaustiveCases"><span class="hs-identifier hs-var">cp_catchNonexhaustiveCases</span></a></span><span> </span><span class="annot"><span class="annottext">(CorePrepConfig -&gt; Bool) -&gt; CorePrepConfig -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CorePrepConfig
</span><a href="GHC.CoreToStg.Prep.html#cpe_config"><span class="hs-identifier hs-var">cpe_config</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975518"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-921"></span><span>                 </span><span class="hs-comment">-- Suppose the alternatives do not cover all the data constructors of the type.</span><span>
</span><span id="line-922"></span><span>                 </span><span class="hs-comment">-- That may be fine: perhaps an earlier case has dealt with the missing cases.</span><span>
</span><span id="line-923"></span><span>                 </span><span class="hs-comment">-- But this is a relatively sophisticated property, so we provide a GHC-debugging flag</span><span>
</span><span id="line-924"></span><span>                 </span><span class="hs-comment">-- `-fcatch-nonexhaustive-cases` which adds a DEFAULT alternative to such cases</span><span>
</span><span id="line-925"></span><span>                 </span><span class="hs-comment">-- (This alternative will only be taken if there is a bug in GHC.)</span><span>
</span><span id="line-926"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Alt InVar] -&gt; Bool
forall b. [Alt b] -&gt; Bool
</span><a href="GHC.Core.Utils.html#altsAreExhaustive"><span class="hs-identifier hs-var">altsAreExhaustive</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt InVar]
</span><a href="#local-6989586621682975522"><span class="hs-identifier hs-var">alts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-927"></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Alt InVar] -&gt; Maybe CpeRhs -&gt; [Alt InVar]
forall b. [Alt b] -&gt; Maybe (Expr b) -&gt; [Alt b]
</span><a href="GHC.Core.Utils.html#addDefault"><span class="hs-identifier hs-var">addDefault</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt InVar]
</span><a href="#local-6989586621682975522"><span class="hs-identifier hs-var">alts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeRhs -&gt; Maybe CpeRhs
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975532"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-928"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Alt InVar]
</span><a href="#local-6989586621682975522"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-929"></span><span>               </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621682975532"><span class="annot"><span class="annottext">err :: CpeRhs
</span><a href="#local-6989586621682975532"><span class="hs-identifier hs-var hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; String -&gt; CpeRhs
</span><a href="GHC.Core.Make.html#mkImpossibleExpr"><span class="hs-identifier hs-var">mkImpossibleExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682975521"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;cpeRhsE: missing case alternative&quot;</span></span><span>
</span><span id="line-930"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682975534"><span class="annot"><a href="#local-6989586621682975534"><span class="hs-identifier hs-var">alts''</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682975536"><span class="hs-identifier hs-type">sat_alt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975525"><span class="hs-identifier hs-type">env'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682975527"><span class="hs-identifier hs-type">alts'</span></a></span><span>
</span><span id="line-931"></span><span>
</span><span id="line-932"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621682975534"><span class="hs-identifier hs-type">alts''</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-933"></span><span>           </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="GHC.Core.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a></span><span> </span><span class="annot"><span class="annottext">[InVar]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682975538"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975538"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- See Note [Flatten case-binds]</span><span>
</span><span id="line-934"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682975539"><span class="annot"><span class="annottext">is_unlifted :: Bool
</span><a href="#local-6989586621682975539"><span class="hs-identifier hs-var hs-var">is_unlifted</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Bool
Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isUnliftedType"><span class="hs-identifier hs-var">isUnliftedType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InVar -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975526"><span class="hs-identifier hs-var">bndr2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-935"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682975540"><span class="annot"><span class="annottext">float :: FloatingBind
</span><a href="#local-6989586621682975540"><span class="hs-identifier hs-var hs-var">float</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; InVar -&gt; CpeRhs -&gt; FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#mkCaseFloat"><span class="hs-identifier hs-var">mkCaseFloat</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682975539"><span class="hs-identifier hs-var">is_unlifted</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975526"><span class="hs-identifier hs-var">bndr2</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975524"><span class="hs-identifier hs-var">scrut'</span></a></span><span>
</span><span id="line-936"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeRhs) -&gt; UniqSM (Floats, CpeRhs)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats -&gt; FloatingBind -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#snocFloat"><span class="hs-identifier hs-var">snocFloat</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975523"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621682975540"><span class="hs-identifier hs-var">float</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975538"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-937"></span><span>           </span><span class="annot"><span class="annottext">[Alt InVar]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeRhs) -&gt; UniqSM (Floats, CpeRhs)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975523"><span class="hs-identifier hs-var">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; InVar -&gt; Type -&gt; [Alt InVar] -&gt; CpeRhs
forall b. Expr b -&gt; b -&gt; Type -&gt; [Alt b] -&gt; Expr b
</span><a href="GHC.Core.html#Case"><span class="hs-identifier hs-var">Case</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975524"><span class="hs-identifier hs-var">scrut'</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975526"><span class="hs-identifier hs-var">bndr2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Type -&gt; Type
</span><a href="GHC.CoreToStg.Prep.html#cpSubstTy"><span class="hs-identifier hs-var">cpSubstTy</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975518"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682975521"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Alt InVar]
</span><a href="#local-6989586621682975534"><span class="hs-identifier hs-var">alts''</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-938"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-939"></span><span>    </span><span id="local-6989586621682975536"><span class="annot"><span class="annottext">sat_alt :: CorePrepEnv -&gt; Alt InVar -&gt; UniqSM (Alt InVar)
</span><a href="#local-6989586621682975536"><span class="hs-identifier hs-var hs-var">sat_alt</span></a></span></span><span> </span><span id="local-6989586621682975545"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975545"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span id="local-6989586621682975546"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682975546"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span id="local-6989586621682975547"><span class="annot"><span class="annottext">[InVar]
</span><a href="#local-6989586621682975547"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621682975548"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975548"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-940"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975549"><span class="annot"><a href="#local-6989586621682975549"><span class="hs-identifier hs-var">env2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975550"><span class="annot"><a href="#local-6989586621682975550"><span class="hs-identifier hs-var">bs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; [InVar] -&gt; UniqSM (CorePrepEnv, [InVar])
</span><a href="GHC.CoreToStg.Prep.html#cpCloneBndrs"><span class="hs-identifier hs-var">cpCloneBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975545"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[InVar]
</span><a href="#local-6989586621682975547"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-941"></span><span>            </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682975551"><span class="annot"><a href="#local-6989586621682975551"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeBodyNF"><span class="hs-identifier hs-type">cpeBodyNF</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975549"><span class="hs-identifier hs-type">env2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975548"><span class="hs-identifier hs-type">rhs</span></a></span><span>
</span><span id="line-942"></span><span>            </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975546"><span class="hs-identifier hs-type">con</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975550"><span class="hs-identifier hs-type">bs'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975551"><span class="hs-identifier hs-type">rhs'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-943"></span><span>
</span><span id="line-944"></span><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><span id="line-945"></span><span class="hs-comment">--              CpeBody: produces a result satisfying CpeBody</span><span>
</span><span id="line-946"></span><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><span id="line-947"></span><span>
</span><span id="line-948"></span><span class="hs-comment">-- | Convert a 'CoreExpr' so it satisfies 'CpeBody', without</span><span>
</span><span id="line-949"></span><span class="hs-comment">-- producing any floats (any generated floats are immediately</span><span>
</span><span id="line-950"></span><span class="hs-comment">-- let-bound using 'wrapBinds').  Generally you want this, esp.</span><span>
</span><span id="line-951"></span><span class="hs-comment">-- when you've reached a binding form (e.g., a lambda) and</span><span>
</span><span id="line-952"></span><span class="hs-comment">-- floating any further would be incorrect.</span><span>
</span><span id="line-953"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeBodyNF"><span class="hs-identifier hs-type">cpeBodyNF</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeBody"><span class="hs-identifier hs-type">CpeBody</span></a></span><span>
</span><span id="line-954"></span><span id="cpeBodyNF"><span class="annot"><span class="annottext">cpeBodyNF :: CorePrepEnv -&gt; CpeRhs -&gt; UniqSM CpeRhs
</span><a href="GHC.CoreToStg.Prep.html#cpeBodyNF"><span class="hs-identifier hs-var hs-var">cpeBodyNF</span></a></span></span><span> </span><span id="local-6989586621682975553"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975553"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682975554"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975554"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-955"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975555"><span class="annot"><a href="#local-6989586621682975555"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975556"><span class="annot"><a href="#local-6989586621682975556"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeRhs -&gt; UniqSM (Floats, CpeRhs)
</span><a href="GHC.CoreToStg.Prep.html#cpeBody"><span class="hs-identifier hs-var">cpeBody</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975553"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975554"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-956"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#wrapBinds"><span class="hs-identifier hs-type">wrapBinds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975555"><span class="hs-identifier hs-type">floats</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975556"><span class="hs-identifier hs-type">body</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-957"></span><span>
</span><span id="line-958"></span><span class="hs-comment">-- | Convert a 'CoreExpr' so it satisfies 'CpeBody'; also produce</span><span>
</span><span id="line-959"></span><span class="hs-comment">-- a list of 'Floats' which are being propagated upwards.  In</span><span>
</span><span id="line-960"></span><span class="hs-comment">-- fact, this function is used in only two cases: to</span><span>
</span><span id="line-961"></span><span class="hs-comment">-- implement 'cpeBodyNF' (which is what you usually want),</span><span>
</span><span id="line-962"></span><span class="hs-comment">-- and in the case when a let-binding is in a case scrutinee--here,</span><span>
</span><span id="line-963"></span><span class="hs-comment">-- we can always float out:</span><span>
</span><span id="line-964"></span><span class="hs-comment">--</span><span>
</span><span id="line-965"></span><span class="hs-comment">--      case (let x = y in z) of ...</span><span>
</span><span id="line-966"></span><span class="hs-comment">--      ==&gt; let x = y in case z of ...</span><span>
</span><span id="line-967"></span><span class="hs-comment">--</span><span>
</span><span id="line-968"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeBody"><span class="hs-identifier hs-type">cpeBody</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeBody"><span class="hs-identifier hs-type">CpeBody</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-969"></span><span id="cpeBody"><span class="annot"><span class="annottext">cpeBody :: CorePrepEnv -&gt; CpeRhs -&gt; UniqSM (Floats, CpeRhs)
</span><a href="GHC.CoreToStg.Prep.html#cpeBody"><span class="hs-identifier hs-var hs-var">cpeBody</span></a></span></span><span> </span><span id="local-6989586621682975558"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975558"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682975559"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975559"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-970"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975560"><span class="annot"><a href="#local-6989586621682975560"><span class="hs-identifier hs-var">floats1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975561"><span class="annot"><a href="#local-6989586621682975561"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeRhs -&gt; UniqSM (Floats, CpeRhs)
</span><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975558"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975559"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-971"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975562"><span class="annot"><a href="#local-6989586621682975562"><span class="hs-identifier hs-var">floats2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975563"><span class="annot"><a href="#local-6989586621682975563"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#rhsToBody"><span class="hs-identifier hs-type">rhsToBody</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975561"><span class="hs-identifier hs-type">rhs</span></a></span><span>
</span><span id="line-972"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682975560"><span class="hs-identifier hs-type">floats1</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#appFloats"><span class="hs-operator hs-type">`appFloats`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975562"><span class="hs-identifier hs-type">floats2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682975563"><span class="hs-identifier hs-type">body</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-973"></span><span>
</span><span id="line-974"></span><span class="hs-comment">--------</span><span>
</span><span id="line-975"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#rhsToBody"><span class="hs-identifier hs-type">rhsToBody</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeBody"><span class="hs-identifier hs-type">CpeBody</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-976"></span><span class="hs-comment">-- Remove top level lambdas by let-binding</span><span>
</span><span id="line-977"></span><span>
</span><span id="line-978"></span><span id="rhsToBody"><span class="annot"><span class="annottext">rhsToBody :: CpeRhs -&gt; UniqSM (Floats, CpeRhs)
</span><a href="GHC.CoreToStg.Prep.html#rhsToBody"><span class="hs-identifier hs-var hs-var">rhsToBody</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621682975565"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682975565"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621682975566"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975566"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-979"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; TickishScoping
forall (pass :: TickishPass). GenTickish pass -&gt; TickishScoping
</span><a href="GHC.Types.Tickish.html#tickishScoped"><span class="hs-identifier hs-var">tickishScoped</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682975565"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">TickishScoping -&gt; TickishScoping -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TickishScoping
</span><a href="GHC.Types.Tickish.html#NoScope"><span class="hs-identifier hs-var">NoScope</span></a></span><span>  </span><span class="hs-comment">-- only float out of non-scoped annotations</span><span>
</span><span id="line-980"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975569"><span class="annot"><a href="#local-6989586621682975569"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975570"><span class="annot"><a href="#local-6989586621682975570"><span class="hs-identifier hs-var">expr'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; UniqSM (Floats, CpeRhs)
</span><a href="GHC.CoreToStg.Prep.html#rhsToBody"><span class="hs-identifier hs-var">rhsToBody</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975566"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-981"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682975569"><span class="hs-identifier hs-type">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#mkTick"><span class="hs-identifier hs-type">mkTick</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975565"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975570"><span class="hs-identifier hs-type">expr'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-982"></span><span>
</span><span id="line-983"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#rhsToBody"><span class="hs-identifier hs-var">rhsToBody</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682975571"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975571"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621682975572"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682975572"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-984"></span><span>        </span><span class="hs-comment">-- You can get things like</span><span>
</span><span id="line-985"></span><span>        </span><span class="hs-comment">--      case e of { p -&gt; coerce t (\s -&gt; ...) }</span><span>
</span><span id="line-986"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975573"><span class="annot"><a href="#local-6989586621682975573"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975574"><span class="annot"><a href="#local-6989586621682975574"><span class="hs-identifier hs-var">e'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; UniqSM (Floats, CpeRhs)
</span><a href="GHC.CoreToStg.Prep.html#rhsToBody"><span class="hs-identifier hs-var">rhsToBody</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975571"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-987"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682975573"><span class="hs-identifier hs-type">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975574"><span class="hs-identifier hs-type">e'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975572"><span class="hs-identifier hs-type">co</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-988"></span><span>
</span><span id="line-989"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#rhsToBody"><span class="hs-identifier hs-var">rhsToBody</span></a></span><span> </span><span id="local-6989586621682975575"><span class="annot"><span class="annottext">expr :: CpeRhs
</span><a href="#local-6989586621682975575"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- See Note [No eta reduction needed in rhsToBody]</span><span>
</span><span id="line-990"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">(InVar -&gt; Bool) -&gt; [InVar] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">InVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">[InVar]
</span><a href="#local-6989586621682975577"><span class="hs-identifier hs-var">bndrs</span></a></span><span>           </span><span class="hs-comment">-- Type lambdas are ok</span><span>
</span><span id="line-991"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeRhs) -&gt; UniqSM (Floats, CpeRhs)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975575"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-992"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                   </span><span class="hs-comment">-- Some value lambdas</span><span>
</span><span id="line-993"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682975578"><span class="annot"><span class="annottext">rhs :: CpeRhs
</span><a href="#local-6989586621682975578"><span class="hs-identifier hs-var hs-var hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CpeRhs -&gt; CpeRhs
</span><a href="GHC.CoreToStg.Prep.html#cpeEtaExpand"><span class="hs-identifier hs-var">cpeEtaExpand</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeRhs -&gt; Int
</span><a href="GHC.Core.Opt.Arity.html#exprArity"><span class="hs-identifier hs-var">exprArity</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975575"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975575"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-994"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682975580"><span class="annot"><a href="#local-6989586621682975580"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; UniqSM InVar
</span><a href="GHC.CoreToStg.Prep.html#newVar"><span class="hs-identifier hs-var">newVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CpeRhs -&gt; Type
CpeRhs -&gt; Type
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975578"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-995"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682975582"><span class="annot"><a href="#local-6989586621682975582"><span class="hs-identifier hs-var hs-var">float</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBind -&gt; BindInfo -&gt; FloatInfo -&gt; FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#Float"><span class="hs-identifier hs-var">Float</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InVar -&gt; CpeRhs -&gt; CoreBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975580"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975578"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">BindInfo
</span><a href="GHC.CoreToStg.Prep.html#LetBound"><span class="hs-identifier hs-var">LetBound</span></a></span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#TopLvlFloatable"><span class="hs-identifier hs-var">TopLvlFloatable</span></a></span><span>
</span><span id="line-996"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#unitFloat"><span class="hs-identifier hs-type">unitFloat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975582"><span class="hs-identifier hs-type">float</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975580"><span class="hs-identifier hs-type">fn</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-997"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-998"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682975577"><span class="annot"><span class="annottext">[InVar]
</span><a href="#local-6989586621682975577"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">CpeRhs
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; ([InVar], CpeRhs)
forall b. Expr b -&gt; ([b], Expr b)
</span><a href="GHC.Core.html#collectBinders"><span class="hs-identifier hs-var">collectBinders</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975575"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-999"></span><span>
</span><span id="line-1000"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#rhsToBody"><span class="hs-identifier hs-var">rhsToBody</span></a></span><span> </span><span id="local-6989586621682975584"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975584"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeRhs) -&gt; UniqSM (Floats, CpeRhs)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975584"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1001"></span><span>
</span><span id="line-1002"></span><span>
</span><span id="line-1003"></span><span class="hs-comment">{- Note [No eta reduction needed in rhsToBody]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Historical note.  In the olden days we used to have a Prep-specific
eta-reduction step in rhsToBody:
  rhsToBody expr@(Lam {})
    | Just no_lam_result &lt;- tryEtaReducePrep bndrs body
    = return (emptyFloats, no_lam_result)

The goal was to reduce
        case x of { p -&gt; \xs. map f xs }
    ==&gt; case x of { p -&gt; map f }

to avoid allocating a lambda.  Of course, we'd allocate a PAP
instead, which is hardly better, but that's the way it was.

Now we simply don't bother with this. It doesn't seem to be a win,
and it's extra work.
-}</span><span>
</span><span id="line-1021"></span><span>
</span><span id="line-1022"></span><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><span id="line-1023"></span><span class="hs-comment">--              CpeApp: produces a result satisfying CpeApp</span><span>
</span><span id="line-1024"></span><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><span id="line-1025"></span><span>
</span><span id="line-1026"></span><span class="hs-keyword">data</span><span> </span><span id="ArgInfo"><span class="annot"><a href="GHC.CoreToStg.Prep.html#ArgInfo"><span class="hs-identifier hs-var">ArgInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="AIApp"><span class="annot"><a href="GHC.CoreToStg.Prep.html#AIApp"><span class="hs-identifier hs-var">AIApp</span></a></span></span><span>  </span><span class="annot"><a href="GHC.Core.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a></span><span> </span><span class="hs-comment">-- NB: Not a CpeApp yet</span><span>
</span><span id="line-1027"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span id="AICast"><span class="annot"><a href="GHC.CoreToStg.Prep.html#AICast"><span class="hs-identifier hs-var">AICast</span></a></span></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>
</span><span id="line-1028"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span id="AITick"><span class="annot"><a href="GHC.CoreToStg.Prep.html#AITick"><span class="hs-identifier hs-var">AITick</span></a></span></span><span> </span><span class="annot"><a href="GHC.Types.Tickish.html#CoreTickish"><span class="hs-identifier hs-type">CoreTickish</span></a></span><span>
</span><span id="line-1029"></span><span>
</span><span id="line-1030"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1031"></span><span>  </span><span id="local-6989586621682975604"><span class="annot"><span class="annottext">ppr :: ArgInfo -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#AIApp"><span class="hs-identifier hs-type">AIApp</span></a></span><span> </span><span id="local-6989586621682975605"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975605"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;app&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975605"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-1032"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#AICast"><span class="hs-identifier hs-type">AICast</span></a></span><span> </span><span id="local-6989586621682975606"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682975606"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;cast&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682975606"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1033"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#AITick"><span class="hs-identifier hs-type">AITick</span></a></span><span> </span><span id="local-6989586621682975607"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682975607"><span class="hs-identifier hs-var">tick</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tick&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682975607"><span class="hs-identifier hs-var">tick</span></a></span><span>
</span><span id="line-1034"></span><span>
</span><span id="line-1035"></span><span class="hs-comment">{- Note [Ticks and mandatory eta expansion]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Something like
    `foo x = ({-# SCC foo #-} tagToEnum#) x :: Bool`
caused a compiler panic in #20938. Why did this happen?
The simplifier will eta-reduce the rhs giving us a partial
application of tagToEnum#. The tick is then pushed inside the
type argument. That is we get
    `(Tick&lt;foo&gt; tagToEnum#) @Bool`
CorePrep would go on to see a undersaturated tagToEnum# application
and eta expand the expression under the tick. Giving us:
    (Tick&lt;scc&gt; (\forall a. x -&gt; tagToEnum# @a x) @Bool
Suddenly tagToEnum# is applied to a polymorphic type and the code generator
panics as it needs a concrete type to determine the representation.

The problem in my eyes was that the tick covers a partial application
of a primop. There is no clear semantic for such a construct as we can't
partially apply a primop since they do not have bindings.
We fix this by expanding the scope of such ticks slightly to cover the body
of the eta-expanded expression.

We do this by:
* Checking if an application is headed by a primOpish thing.
* If so we collect floatable ticks and usually but also profiling ticks
  along with regular arguments.
* When rebuilding the application we check if any profiling ticks appear
  before the primop is fully saturated.
* If the primop isn't fully satured we eta expand the primop application
  and scope the tick to scope over the body of the saturated expression.

Going back to #20938 this means starting with
    `(Tick&lt;foo&gt; tagToEnum#) @Bool`
we check if the function head is a primop (yes). This means we collect the
profiling tick like if it was floatable. Giving us
    (tagToEnum#, [CpeTick foo, CpeApp @Bool]).
cpe_app filters out the tick as a underscoped tick on the expression
`tagToEnum# @Bool`. During eta expansion we then put that tick back onto the
body of the eta-expansion lambdas. Giving us `\x -&gt; Tick&lt;foo&gt; (tagToEnum# @Bool x)`.
-}</span><span>
</span><span id="line-1074"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeApp"><span class="hs-identifier hs-type">cpeApp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1075"></span><span class="hs-comment">-- May return a CpeRhs (instead of CpeApp) because of saturating primops</span><span>
</span><span id="line-1076"></span><span id="cpeApp"><span class="annot"><span class="annottext">cpeApp :: CorePrepEnv -&gt; CpeRhs -&gt; UniqSM (Floats, CpeRhs)
</span><a href="GHC.CoreToStg.Prep.html#cpeApp"><span class="hs-identifier hs-var hs-var">cpeApp</span></a></span></span><span> </span><span id="local-6989586621682975608"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975608"><span class="hs-identifier hs-var">top_env</span></a></span></span><span> </span><span id="local-6989586621682975609"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975609"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-1077"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975610"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975610"><span class="hs-identifier hs-var">terminal</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975611"><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975611"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; (CpeRhs, [ArgInfo])
</span><a href="#local-6989586621682975612"><span class="hs-identifier hs-var">collect_args</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975609"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-1078"></span><span>      </span><span class="hs-comment">--  ; pprTraceM &quot;cpeApp&quot; $ (ppr expr)</span><span>
</span><span id="line-1079"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeRhs -&gt; [ArgInfo] -&gt; UniqSM (Floats, CpeRhs)
</span><a href="#local-6989586621682975613"><span class="hs-identifier hs-var">cpe_app</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975608"><span class="hs-identifier hs-var">top_env</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975610"><span class="hs-identifier hs-var">terminal</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975611"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-1080"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-1081"></span><span>
</span><span id="line-1082"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1083"></span><span>    </span><span class="hs-comment">-- We have a nested data structure of the form</span><span>
</span><span id="line-1084"></span><span>    </span><span class="hs-comment">-- e `App` a1 `App` a2 ... `App` an, convert it into</span><span>
</span><span id="line-1085"></span><span>    </span><span class="hs-comment">-- (e, [CpeApp a1, CpeApp a2, ..., CpeApp an], depth)</span><span>
</span><span id="line-1086"></span><span>    </span><span class="hs-comment">-- We use 'ArgInfo' because we may also need to</span><span>
</span><span id="line-1087"></span><span>    </span><span class="hs-comment">-- record casts and ticks.  Depth counts the number</span><span>
</span><span id="line-1088"></span><span>    </span><span class="hs-comment">-- of arguments that would consume strictness information</span><span>
</span><span id="line-1089"></span><span>    </span><span class="hs-comment">-- (so, no type or coercion arguments.)</span><span>
</span><span id="line-1090"></span><span>    </span><span class="annot"><a href="#local-6989586621682975612"><span class="hs-identifier hs-type">collect_args</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1091"></span><span>    </span><span id="local-6989586621682975612"><span class="annot"><span class="annottext">collect_args :: CpeRhs -&gt; (CpeRhs, [ArgInfo])
</span><a href="#local-6989586621682975612"><span class="hs-identifier hs-var hs-var">collect_args</span></a></span></span><span> </span><span id="local-6989586621682975614"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975614"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; [ArgInfo] -&gt; (CpeRhs, [ArgInfo])
</span><a href="#local-6989586621682975615"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975614"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1092"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-1093"></span><span>        </span><span id="local-6989586621682975615"><span class="annot"><span class="annottext">go :: CpeRhs -&gt; [ArgInfo] -&gt; (CpeRhs, [ArgInfo])
</span><a href="#local-6989586621682975615"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621682975616"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975616"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621682975617"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975617"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span>      </span><span id="local-6989586621682975618"><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975618"><span class="hs-keyword hs-var">as</span></a></span></span><span>
</span><span id="line-1094"></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; [ArgInfo] -&gt; (CpeRhs, [ArgInfo])
</span><a href="#local-6989586621682975615"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975616"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeRhs -&gt; ArgInfo
</span><a href="GHC.CoreToStg.Prep.html#AIApp"><span class="hs-identifier hs-var">AIApp</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975617"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">ArgInfo -&gt; [ArgInfo] -&gt; [ArgInfo]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975618"><span class="hs-keyword hs-var">as</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1095"></span><span>        </span><span class="annot"><a href="#local-6989586621682975615"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682975619"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975619"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621682975620"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682975620"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>      </span><span id="local-6989586621682975621"><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975621"><span class="hs-keyword hs-var">as</span></a></span></span><span>
</span><span id="line-1096"></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; [ArgInfo] -&gt; (CpeRhs, [ArgInfo])
</span><a href="#local-6989586621682975615"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975619"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; ArgInfo
</span><a href="GHC.CoreToStg.Prep.html#AICast"><span class="hs-identifier hs-var">AICast</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682975620"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="annot"><span class="annottext">ArgInfo -&gt; [ArgInfo] -&gt; [ArgInfo]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975621"><span class="hs-keyword hs-var">as</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1097"></span><span>        </span><span class="annot"><a href="#local-6989586621682975615"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621682975622"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682975622"><span class="hs-identifier hs-var">tickish</span></a></span></span><span> </span><span id="local-6989586621682975623"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975623"><span class="hs-identifier hs-var">fun</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682975624"><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975624"><span class="hs-keyword hs-var">as</span></a></span></span><span>
</span><span id="line-1098"></span><span>            </span><span class="hs-comment">-- Profiling ticks are slightly less strict so we expand their scope</span><span>
</span><span id="line-1099"></span><span>            </span><span class="hs-comment">-- if they cover partial applications of things like primOps.</span><span>
</span><span id="line-1100"></span><span>            </span><span class="hs-comment">-- See Note [Ticks and mandatory eta expansion]</span><span>
</span><span id="line-1101"></span><span>            </span><span class="hs-comment">-- Here we look inside `fun` before we make the final decision about</span><span>
</span><span id="line-1102"></span><span>            </span><span class="hs-comment">-- floating the tick which isn't optimal for perf. But this only makes</span><span>
</span><span id="line-1103"></span><span>            </span><span class="hs-comment">-- a difference if we have a non-floatable tick which is somewhat rare.</span><span>
</span><span id="line-1104"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682975625"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975625"><span class="hs-identifier hs-var">vh</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975626"><span class="hs-identifier hs-var">head</span></a></span><span>
</span><span id="line-1105"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682975627"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975627"><span class="hs-identifier hs-var">head'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; InVar -&gt; CpeRhs
</span><a href="GHC.CoreToStg.Prep.html#lookupCorePrepEnv"><span class="hs-identifier hs-var">lookupCorePrepEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975608"><span class="hs-identifier hs-var">top_env</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975625"><span class="hs-identifier hs-var">vh</span></a></span><span>
</span><span id="line-1106"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InVar -&gt; CoreTickish -&gt; Bool
forall (pass :: TickishPass). InVar -&gt; GenTickish pass -&gt; Bool
</span><a href="GHC.Core.Utils.html#etaExpansionTick"><span class="hs-identifier hs-var">etaExpansionTick</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975627"><span class="hs-identifier hs-var">head'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682975622"><span class="hs-identifier hs-var">tickish</span></a></span><span>
</span><span id="line-1107"></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975626"><span class="hs-identifier hs-var">head</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975629"><span class="hs-identifier hs-var">as'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1108"></span><span>            </span><span class="hs-keyword">where</span><span>
</span><span id="line-1109"></span><span>              </span><span class="hs-special">(</span><span id="local-6989586621682975626"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975626"><span class="hs-identifier hs-var">head</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682975629"><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975629"><span class="hs-identifier hs-var">as'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; [ArgInfo] -&gt; (CpeRhs, [ArgInfo])
</span><a href="#local-6989586621682975615"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975623"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; ArgInfo
</span><a href="GHC.CoreToStg.Prep.html#AITick"><span class="hs-identifier hs-var">AITick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682975622"><span class="hs-identifier hs-var">tickish</span></a></span><span> </span><span class="annot"><span class="annottext">ArgInfo -&gt; [ArgInfo] -&gt; [ArgInfo]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975624"><span class="hs-keyword hs-var">as</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1110"></span><span>
</span><span id="line-1111"></span><span>        </span><span class="hs-comment">-- Terminal could still be an app if it's wrapped by a tick.</span><span>
</span><span id="line-1112"></span><span>        </span><span class="hs-comment">-- E.g. Tick&lt;foo&gt; (f x) can give us (f x) as terminal.</span><span>
</span><span id="line-1113"></span><span>        </span><span class="annot"><a href="#local-6989586621682975615"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682975630"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975630"><span class="hs-identifier hs-var">terminal</span></a></span></span><span> </span><span id="local-6989586621682975631"><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975631"><span class="hs-keyword hs-var">as</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975630"><span class="hs-identifier hs-var">terminal</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975631"><span class="hs-keyword hs-var">as</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1114"></span><span>
</span><span id="line-1115"></span><span>    </span><span class="annot"><a href="#local-6989586621682975613"><span class="hs-identifier hs-type">cpe_app</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span>
</span><span id="line-1116"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-comment">-- The thing we are calling</span><span>
</span><span id="line-1117"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1118"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1119"></span><span>    </span><span id="local-6989586621682975613"><span class="annot"><span class="annottext">cpe_app :: CorePrepEnv -&gt; CpeRhs -&gt; [ArgInfo] -&gt; UniqSM (Floats, CpeRhs)
</span><a href="#local-6989586621682975613"><span class="hs-identifier hs-var hs-var">cpe_app</span></a></span></span><span> </span><span id="local-6989586621682975632"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975632"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682975633"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975633"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#AIApp"><span class="hs-identifier hs-type">AIApp</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#AIApp"><span class="hs-identifier hs-type">AIApp</span></a></span><span> </span><span id="local-6989586621682975634"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975634"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682975635"><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975635"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1120"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975633"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">InVar -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#lazyIdKey"><span class="hs-identifier hs-var">lazyIdKey</span></a></span><span>          </span><span class="hs-comment">-- Replace (lazy a) with a, and</span><span>
</span><span id="line-1121"></span><span>            </span><span class="hs-comment">-- See Note [lazyId magic] in GHC.Types.Id.Make</span><span>
</span><span id="line-1122"></span><span>       </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975633"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">InVar -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#noinlineIdKey"><span class="hs-identifier hs-var">noinlineIdKey</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975633"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">InVar -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#noinlineConstraintIdKey"><span class="hs-identifier hs-var">noinlineConstraintIdKey</span></a></span><span>
</span><span id="line-1123"></span><span>            </span><span class="hs-comment">-- Replace (noinline a) with a</span><span>
</span><span id="line-1124"></span><span>            </span><span class="hs-comment">-- See Note [noinlineId magic] in GHC.Types.Id.Make</span><span>
</span><span id="line-1125"></span><span>       </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975633"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">InVar -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#nospecIdKey"><span class="hs-identifier hs-var">nospecIdKey</span></a></span><span>        </span><span class="hs-comment">-- Replace (nospec a) with a</span><span>
</span><span id="line-1126"></span><span>            </span><span class="hs-comment">-- See Note [nospecId magic] in GHC.Types.Id.Make</span><span>
</span><span id="line-1127"></span><span>
</span><span id="line-1128"></span><span>        </span><span class="hs-comment">-- Consider the code:</span><span>
</span><span id="line-1129"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-1130"></span><span>        </span><span class="hs-comment">--      lazy (f x) y</span><span>
</span><span id="line-1131"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-1132"></span><span>        </span><span class="hs-comment">-- We need to make sure that we need to recursively collect arguments on</span><span>
</span><span id="line-1133"></span><span>        </span><span class="hs-comment">-- &quot;f x&quot;, otherwise we'll float &quot;f x&quot; out (it's not a variable) and</span><span>
</span><span id="line-1134"></span><span>        </span><span class="hs-comment">-- end up with this awful -ddump-prep:</span><span>
</span><span id="line-1135"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-1136"></span><span>        </span><span class="hs-comment">--      case f x of f_x {</span><span>
</span><span id="line-1137"></span><span>        </span><span class="hs-comment">--        __DEFAULT -&gt; f_x y</span><span>
</span><span id="line-1138"></span><span>        </span><span class="hs-comment">--      }</span><span>
</span><span id="line-1139"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-1140"></span><span>        </span><span class="hs-comment">-- rather than the far superior &quot;f x y&quot;.  Test case is par01.</span><span>
</span><span id="line-1141"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975640"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975640"><span class="hs-identifier hs-var">terminal</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975641"><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975641"><span class="hs-identifier hs-var">args'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; (CpeRhs, [ArgInfo])
</span><a href="#local-6989586621682975612"><span class="hs-identifier hs-var">collect_args</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975634"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-1142"></span><span>          </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeRhs -&gt; [ArgInfo] -&gt; UniqSM (Floats, CpeRhs)
</span><a href="#local-6989586621682975613"><span class="hs-identifier hs-var">cpe_app</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975632"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975640"><span class="hs-identifier hs-var">terminal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975641"><span class="hs-identifier hs-var">args'</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo] -&gt; [ArgInfo] -&gt; [ArgInfo]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975635"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1143"></span><span>
</span><span id="line-1144"></span><span>    </span><span class="hs-comment">-- runRW# magic</span><span>
</span><span id="line-1145"></span><span>    </span><span class="annot"><a href="#local-6989586621682975613"><span class="hs-identifier hs-var">cpe_app</span></a></span><span> </span><span id="local-6989586621682975642"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975642"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682975643"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975643"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#AIApp"><span class="hs-identifier hs-type">AIApp</span></a></span><span> </span><span id="local-6989586621682975644"><span class="annot"><span class="annottext">_runtimeRep :: CpeRhs
</span><a href="#local-6989586621682975644"><span class="hs-identifier hs-var">_runtimeRep</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#AIApp"><span class="hs-identifier hs-type">AIApp</span></a></span><span> </span><span id="local-6989586621682975645"><span class="annot"><span class="annottext">_type :: CpeRhs
</span><a href="#local-6989586621682975645"><span class="hs-identifier hs-var">_type</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#AIApp"><span class="hs-identifier hs-type">AIApp</span></a></span><span> </span><span id="local-6989586621682975646"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975646"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682975647"><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975647"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1146"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975643"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">InVar -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#runRWKey"><span class="hs-identifier hs-var">runRWKey</span></a></span><span>
</span><span id="line-1147"></span><span>        </span><span class="hs-comment">-- N.B. While it may appear that n == 1 in the case of runRW#</span><span>
</span><span id="line-1148"></span><span>        </span><span class="hs-comment">-- applications, keep in mind that we may have applications that return</span><span>
</span><span id="line-1149"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[ArgInfo] -&gt; Bool
</span><a href="#local-6989586621682975649"><span class="hs-identifier hs-var">has_value_arg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeRhs -&gt; ArgInfo
</span><a href="GHC.CoreToStg.Prep.html#AIApp"><span class="hs-identifier hs-var">AIApp</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975646"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">ArgInfo -&gt; [ArgInfo] -&gt; [ArgInfo]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975647"><span class="hs-identifier hs-var">rest</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1150"></span><span>        </span><span class="hs-comment">-- See Note [runRW magic]</span><span>
</span><span id="line-1151"></span><span>        </span><span class="hs-comment">-- Replace (runRW# f) by (f realWorld#), beta reducing if possible (this</span><span>
</span><span id="line-1152"></span><span>        </span><span class="hs-comment">-- is why we return a CorePrepEnv as well)</span><span>
</span><span id="line-1153"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975646"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1154"></span><span>            </span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621682975650"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975650"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621682975651"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975651"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeRhs -&gt; [ArgInfo] -&gt; UniqSM (Floats, CpeRhs)
</span><a href="#local-6989586621682975613"><span class="hs-identifier hs-var">cpe_app</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepEnv -&gt; InVar -&gt; InVar -&gt; CorePrepEnv
</span><a href="GHC.CoreToStg.Prep.html#extendCorePrepEnv"><span class="hs-identifier hs-var">extendCorePrepEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975642"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975650"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="GHC.Types.Id.Make.html#realWorldPrimId"><span class="hs-identifier hs-var">realWorldPrimId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975651"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975647"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-1155"></span><span>            </span><span class="annot"><span class="annottext">CpeRhs
</span><span class="hs-identifier">_</span></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeRhs -&gt; [ArgInfo] -&gt; UniqSM (Floats, CpeRhs)
</span><a href="#local-6989586621682975613"><span class="hs-identifier hs-var">cpe_app</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975642"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975646"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeRhs -&gt; ArgInfo
</span><a href="GHC.CoreToStg.Prep.html#AIApp"><span class="hs-identifier hs-var">AIApp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InVar -&gt; CpeRhs
forall b. InVar -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="GHC.Types.Id.Make.html#realWorldPrimId"><span class="hs-identifier hs-var">realWorldPrimId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ArgInfo -&gt; [ArgInfo] -&gt; [ArgInfo]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975647"><span class="hs-identifier hs-var">rest</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1156"></span><span>             </span><span class="hs-comment">-- TODO: What about casts?</span><span>
</span><span id="line-1157"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-1158"></span><span>          </span><span id="local-6989586621682975649"><span class="annot"><span class="annottext">has_value_arg :: [ArgInfo] -&gt; Bool
</span><a href="#local-6989586621682975649"><span class="hs-identifier hs-var hs-var">has_value_arg</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1159"></span><span>          </span><span class="annot"><a href="#local-6989586621682975649"><span class="hs-identifier hs-var">has_value_arg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#AIApp"><span class="hs-identifier hs-type">AIApp</span></a></span><span> </span><span id="local-6989586621682975652"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975652"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682975653"><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975653"><span class="hs-identifier hs-var">_rest</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1160"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeRhs -&gt; Bool
forall b. Expr b -&gt; Bool
</span><a href="GHC.Core.html#isTyCoArg"><span class="hs-identifier hs-var">isTyCoArg</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975652"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1161"></span><span>          </span><span class="annot"><a href="#local-6989586621682975649"><span class="hs-identifier hs-var">has_value_arg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArgInfo
</span><span class="hs-identifier">_</span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682975655"><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975655"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ArgInfo] -&gt; Bool
</span><a href="#local-6989586621682975649"><span class="hs-identifier hs-var">has_value_arg</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975655"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-1162"></span><span>
</span><span id="line-1163"></span><span>    </span><span class="hs-comment">-- See Note [seq# magic]. This is the step for CorePrep</span><span>
</span><span id="line-1164"></span><span>    </span><span class="annot"><a href="#local-6989586621682975613"><span class="hs-identifier hs-var">cpe_app</span></a></span><span> </span><span id="local-6989586621682975656"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975656"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682975657"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975657"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#AIApp"><span class="hs-identifier hs-type">AIApp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span id="local-6989586621682975658"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682975658"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#AIApp"><span class="hs-identifier hs-type">AIApp</span></a></span><span> </span><span id="local-6989586621682975659"><span class="annot"><span class="annottext">_st_ty :: CpeRhs
</span><a href="#local-6989586621682975659"><span class="hs-identifier hs-var">_st_ty</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#AIApp"><span class="hs-identifier hs-type">AIApp</span></a></span><span> </span><span id="local-6989586621682975660"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975660"><span class="hs-identifier hs-var">thing</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#AIApp"><span class="hs-identifier hs-type">AIApp</span></a></span><span> </span><span id="local-6989586621682975661"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975661"><span class="hs-identifier hs-var">token</span></a></span></span><span class="hs-special">]</span><span>
</span><span id="line-1165"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975657"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">InVar -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#seqHashKey"><span class="hs-identifier hs-var">seqHashKey</span></a></span><span>
</span><span id="line-1166"></span><span>        </span><span class="hs-comment">-- seq# thing token</span><span>
</span><span id="line-1167"></span><span>        </span><span class="hs-comment">--    ==&gt;   case token of s   { __DEFAULT -&gt;</span><span>
</span><span id="line-1168"></span><span>        </span><span class="hs-comment">--          case thing of res { __DEFAULT -&gt; (# token, res#) } },</span><span>
</span><span id="line-1169"></span><span>        </span><span class="hs-comment">-- allocating CaseBound Floats for token and thing as needed</span><span>
</span><span id="line-1170"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975662"><span class="annot"><a href="#local-6989586621682975662"><span class="hs-identifier hs-var">floats1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975663"><span class="annot"><a href="#local-6989586621682975663"><span class="hs-identifier hs-var">token</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Demand -&gt; CpeRhs -&gt; UniqSM (Floats, CpeRhs)
</span><a href="GHC.CoreToStg.Prep.html#cpeArg"><span class="hs-identifier hs-var">cpeArg</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975656"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="GHC.Types.Demand.html#topDmd"><span class="hs-identifier hs-var">topDmd</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975661"><span class="hs-identifier hs-var">token</span></a></span><span>
</span><span id="line-1171"></span><span>             </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975665"><span class="annot"><a href="#local-6989586621682975665"><span class="hs-identifier hs-var">floats2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975666"><span class="annot"><a href="#local-6989586621682975666"><span class="hs-identifier hs-var">thing</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeBody"><span class="hs-identifier hs-type">cpeBody</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975656"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975660"><span class="hs-identifier hs-type">thing</span></a></span><span>
</span><span id="line-1172"></span><span>             </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682975667"><span class="annot"><a href="#local-6989586621682975667"><span class="hs-identifier hs-var">case_bndr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#newVar"><span class="hs-identifier hs-type">newVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975658"><span class="hs-identifier hs-type">ty</span></a></span><span>
</span><span id="line-1173"></span><span>             </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682975668"><span class="annot"><a href="#local-6989586621682975668"><span class="hs-identifier hs-var hs-var">tup</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CpeRhs] -&gt; CpeRhs
</span><a href="GHC.Core.Make.html#mkCoreUnboxedTuple"><span class="hs-identifier hs-var">mkCoreUnboxedTuple</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975663"><span class="hs-identifier hs-var">token</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InVar -&gt; CpeRhs
forall b. InVar -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975667"><span class="hs-identifier hs-var">case_bndr</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1174"></span><span>             </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682975670"><span class="annot"><a href="#local-6989586621682975670"><span class="hs-identifier hs-var hs-var">is_unlifted</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-comment">-- otherwise seq# would not type-check</span><span>
</span><span id="line-1175"></span><span>             </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682975671"><span class="annot"><a href="#local-6989586621682975671"><span class="hs-identifier hs-var hs-var">float</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; InVar -&gt; CpeRhs -&gt; FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#mkCaseFloat"><span class="hs-identifier hs-var">mkCaseFloat</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682975670"><span class="hs-identifier hs-var">is_unlifted</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975667"><span class="hs-identifier hs-var">case_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975666"><span class="hs-identifier hs-var">thing</span></a></span><span>
</span><span id="line-1176"></span><span>             </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682975662"><span class="hs-identifier hs-type">floats1</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#appFloats"><span class="hs-operator hs-type">`appFloats`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975665"><span class="hs-identifier hs-type">floats2</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#snocFloat"><span class="hs-operator hs-type">`snocFloat`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975671"><span class="hs-identifier hs-type">float</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682975668"><span class="hs-identifier hs-type">tup</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1177"></span><span>
</span><span id="line-1178"></span><span>    </span><span class="annot"><a href="#local-6989586621682975613"><span class="hs-identifier hs-var">cpe_app</span></a></span><span> </span><span id="local-6989586621682975672"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975672"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682975673"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975673"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682975674"><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975674"><span class="hs-identifier hs-var">args</span></a></span></span><span>
</span><span id="line-1179"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682975675"><span class="annot"><a href="#local-6989586621682975675"><span class="hs-identifier hs-var">v1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InVar -&gt; UniqSM InVar
</span><a href="GHC.CoreToStg.Prep.html#fiddleCCall"><span class="hs-identifier hs-var">fiddleCCall</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975673"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1180"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682975677"><span class="annot"><a href="#local-6989586621682975677"><span class="hs-identifier hs-var hs-var">e2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; InVar -&gt; CpeRhs
</span><a href="GHC.CoreToStg.Prep.html#lookupCorePrepEnv"><span class="hs-identifier hs-var">lookupCorePrepEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975672"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975675"><span class="hs-identifier hs-var">v1</span></a></span><span>
</span><span id="line-1181"></span><span>                 </span><span id="local-6989586621682975678"><span class="annot"><a href="#local-6989586621682975678"><span class="hs-identifier hs-var hs-var">hd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; Maybe InVar
</span><a href="GHC.Core.Utils.html#getIdFromTrivialExpr_maybe"><span class="hs-identifier hs-var">getIdFromTrivialExpr_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975677"><span class="hs-identifier hs-var">e2</span></a></span><span>
</span><span id="line-1182"></span><span>                 </span><span class="hs-comment">-- Determine number of required arguments. See Note [Ticks and mandatory eta expansion]</span><span>
</span><span id="line-1183"></span><span>                 </span><span id="local-6989586621682975680"><span class="annot"><a href="#local-6989586621682975680"><span class="hs-identifier hs-var hs-var">min_arity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe InVar
</span><a href="#local-6989586621682975678"><span class="hs-identifier hs-var">hd</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1184"></span><span>                   </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682975681"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975681"><span class="hs-identifier hs-var">v_hd</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">InVar -&gt; Bool
</span><a href="GHC.Types.Id.html#hasNoBinding"><span class="hs-identifier hs-var">hasNoBinding</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975681"><span class="hs-identifier hs-var">v_hd</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Maybe Int) -&gt; Int -&gt; Maybe Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InVar -&gt; Int
</span><a href="GHC.Types.Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975681"><span class="hs-identifier hs-var">v_hd</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe Int
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1185"></span><span>                   </span><span class="annot"><span class="annottext">Maybe InVar
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Int
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1186"></span><span>          </span><span class="hs-comment">--  ; pprTraceM &quot;cpe_app:stricts:&quot; (ppr v &lt;+&gt; ppr args $$ ppr stricts $$ ppr (idCbvMarks_maybe v))</span><span>
</span><span id="line-1187"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975684"><span class="annot"><a href="#local-6989586621682975684"><span class="hs-identifier hs-var">app</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975685"><span class="annot"><a href="#local-6989586621682975685"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975686"><span class="annot"><a href="#local-6989586621682975686"><span class="hs-identifier hs-var">unsat_ticks</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621682975687"><span class="hs-identifier hs-type">rebuild_app</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975672"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975674"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975677"><span class="hs-identifier hs-type">e2</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-type">emptyFloats</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975688"><span class="hs-identifier hs-type">stricts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975680"><span class="hs-identifier hs-type">min_arity</span></a></span><span>
</span><span id="line-1188"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="#local-6989586621682975689"><span class="hs-identifier hs-type">mb_saturate</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975678"><span class="hs-identifier hs-type">hd</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975684"><span class="hs-identifier hs-type">app</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975685"><span class="hs-identifier hs-type">floats</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975686"><span class="hs-identifier hs-type">unsat_ticks</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975690"><span class="hs-identifier hs-type">depth</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1189"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-1190"></span><span>          </span><span id="local-6989586621682975690"><span class="annot"><span class="annottext">depth :: Int
</span><a href="#local-6989586621682975690"><span class="hs-identifier hs-var hs-var">depth</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ArgInfo] -&gt; Int
</span><a href="#local-6989586621682975691"><span class="hs-identifier hs-var">val_args</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975674"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-1191"></span><span>          </span><span id="local-6989586621682975688"><span class="annot"><span class="annottext">stricts :: [Demand]
</span><a href="#local-6989586621682975688"><span class="hs-identifier hs-var hs-var">stricts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">InVar -&gt; DmdSig
</span><a href="GHC.Types.Id.html#idDmdSig"><span class="hs-identifier hs-var">idDmdSig</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975673"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1192"></span><span>                            </span><span class="annot"><a href="GHC.Types.Demand.html#DmdSig"><span class="hs-identifier hs-type">DmdSig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a></span><span> </span><span class="annot"><span class="annottext">DmdEnv
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682975695"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682975695"><span class="hs-identifier hs-var">demands</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1193"></span><span>                              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Demand] -&gt; Int -&gt; Ordering
forall a. [a] -&gt; Int -&gt; Ordering
</span><a href="GHC.Utils.Misc.html#listLengthCmp"><span class="hs-identifier hs-var">listLengthCmp</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682975695"><span class="hs-identifier hs-var">demands</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682975690"><span class="hs-identifier hs-var">depth</span></a></span><span> </span><span class="annot"><span class="annottext">Ordering -&gt; Ordering -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier hs-var">GT</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682975695"><span class="hs-identifier hs-var">demands</span></a></span><span>
</span><span id="line-1194"></span><span>                                    </span><span class="hs-comment">-- length demands &lt;= depth</span><span>
</span><span id="line-1195"></span><span>                              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1196"></span><span>                </span><span class="hs-comment">-- If depth &lt; length demands, then we have too few args to</span><span>
</span><span id="line-1197"></span><span>                </span><span class="hs-comment">-- satisfy strictness  info so we have to  ignore all the</span><span>
</span><span id="line-1198"></span><span>                </span><span class="hs-comment">-- strictness info, e.g. + (error &quot;urk&quot;)</span><span>
</span><span id="line-1199"></span><span>                </span><span class="hs-comment">-- Here, we can't evaluate the arg strictly, because this</span><span>
</span><span id="line-1200"></span><span>                </span><span class="hs-comment">-- partial application might be seq'd</span><span>
</span><span id="line-1201"></span><span>
</span><span id="line-1202"></span><span>        </span><span class="hs-comment">-- We inlined into something that's not a var and has no args.</span><span>
</span><span id="line-1203"></span><span>        </span><span class="hs-comment">-- Bounce it back up to cpeRhsE.</span><span>
</span><span id="line-1204"></span><span>    </span><span class="annot"><a href="#local-6989586621682975613"><span class="hs-identifier hs-var">cpe_app</span></a></span><span> </span><span id="local-6989586621682975697"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975697"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682975698"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975698"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeRhs -&gt; UniqSM (Floats, CpeRhs)
</span><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975697"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975698"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-1205"></span><span>
</span><span id="line-1206"></span><span>    </span><span class="hs-comment">-- Here we get:</span><span>
</span><span id="line-1207"></span><span>    </span><span class="hs-comment">-- N-variable fun, better let-bind it</span><span>
</span><span id="line-1208"></span><span>    </span><span class="hs-comment">-- This case covers literals, apps, lams or let expressions applied to arguments.</span><span>
</span><span id="line-1209"></span><span>    </span><span class="hs-comment">-- Basically things we want to ANF before applying to arguments.</span><span>
</span><span id="line-1210"></span><span>    </span><span class="annot"><a href="#local-6989586621682975613"><span class="hs-identifier hs-var">cpe_app</span></a></span><span> </span><span id="local-6989586621682975699"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975699"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682975700"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975700"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621682975701"><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975701"><span class="hs-identifier hs-var">args</span></a></span></span><span>
</span><span id="line-1211"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975702"><span class="annot"><a href="#local-6989586621682975702"><span class="hs-identifier hs-var">fun_floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975703"><span class="annot"><a href="#local-6989586621682975703"><span class="hs-identifier hs-var">fun'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Demand -&gt; CpeRhs -&gt; UniqSM (Floats, CpeRhs)
</span><a href="GHC.CoreToStg.Prep.html#cpeArg"><span class="hs-identifier hs-var">cpeArg</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975699"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="GHC.Types.Demand.html#evalDmd"><span class="hs-identifier hs-var">evalDmd</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975700"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-1212"></span><span>                          </span><span class="hs-comment">-- If evalDmd says that it's sure to be evaluated,</span><span>
</span><span id="line-1213"></span><span>                          </span><span class="hs-comment">-- we'll end up case-binding it</span><span>
</span><span id="line-1214"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975705"><span class="annot"><a href="#local-6989586621682975705"><span class="hs-identifier hs-var">app</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975706"><span class="annot"><a href="#local-6989586621682975706"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682975707"><span class="annot"><a href="#local-6989586621682975707"><span class="hs-identifier hs-var">unsat_ticks</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621682975687"><span class="hs-identifier hs-type">rebuild_app</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975699"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975701"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975703"><span class="hs-identifier hs-type">fun'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975702"><span class="hs-identifier hs-type">fun_floats</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span>
</span><span id="line-1215"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="#local-6989586621682975689"><span class="hs-identifier hs-type">mb_saturate</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="annot"><a href="#local-6989586621682975705"><span class="hs-identifier hs-type">app</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975706"><span class="hs-identifier hs-type">floats</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975707"><span class="hs-identifier hs-type">unsat_ticks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682975691"><span class="hs-identifier hs-type">val_args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975701"><span class="hs-identifier hs-type">args</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1216"></span><span>
</span><span id="line-1217"></span><span>    </span><span class="hs-comment">-- Count the number of value arguments *and* coercions (since we don't eliminate the later in STG)</span><span>
</span><span id="line-1218"></span><span>    </span><span class="annot"><a href="#local-6989586621682975691"><span class="hs-identifier hs-type">val_args</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-1219"></span><span>    </span><span id="local-6989586621682975691"><span class="annot"><span class="annottext">val_args :: [ArgInfo] -&gt; Int
</span><a href="#local-6989586621682975691"><span class="hs-identifier hs-var hs-var">val_args</span></a></span></span><span> </span><span id="local-6989586621682975708"><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975708"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ArgInfo] -&gt; Int -&gt; Int
forall {t}. Num t =&gt; [ArgInfo] -&gt; t -&gt; t
</span><a href="#local-6989586621682975709"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975708"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1220"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-1221"></span><span>        </span><span id="local-6989586621682975709"><span class="annot"><span class="annottext">go :: [ArgInfo] -&gt; t -&gt; t
</span><a href="#local-6989586621682975709"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682975713"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621682975713"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621682975713"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1222"></span><span>        </span><span class="annot"><a href="#local-6989586621682975709"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975714"><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682975714"><span class="hs-identifier hs-var">info</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682975715"><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975715"><span class="hs-identifier hs-var">infos</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682975716"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621682975716"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1223"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682975714"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1224"></span><span>            </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#AICast"><span class="hs-identifier hs-type">AICast</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[ArgInfo] -&gt; t -&gt; t
</span><a href="#local-6989586621682975709"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975715"><span class="hs-identifier hs-var">infos</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621682975716"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1225"></span><span>            </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#AITick"><span class="hs-identifier hs-type">AITick</span></a></span><span> </span><span id="local-6989586621682975717"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682975717"><span class="hs-identifier hs-var">tickish</span></a></span></span><span>
</span><span id="line-1226"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682975717"><span class="hs-identifier hs-var">tickish</span></a></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[ArgInfo] -&gt; t -&gt; t
</span><a href="#local-6989586621682975709"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975715"><span class="hs-identifier hs-var">infos</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621682975716"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1227"></span><span>              </span><span class="hs-comment">-- If we can't guarantee a tick will be floated out of the application</span><span>
</span><span id="line-1228"></span><span>              </span><span class="hs-comment">-- we can't guarantee the value args following it will be applied.</span><span>
</span><span id="line-1229"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621682975716"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1230"></span><span>            </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#AIApp"><span class="hs-identifier hs-type">AIApp</span></a></span><span> </span><span id="local-6989586621682975718"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975718"><span class="hs-identifier hs-var">e</span></a></span></span><span>                                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[ArgInfo] -&gt; t -&gt; t
</span><a href="#local-6989586621682975709"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975715"><span class="hs-identifier hs-var">infos</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621682975719"><span class="hs-identifier hs-var">n'</span></a></span><span>
</span><span id="line-1231"></span><span>              </span><span class="hs-keyword">where</span><span>
</span><span id="line-1232"></span><span>                </span><span class="hs-glyph">!</span><span id="local-6989586621682975719"><span class="annot"><span class="annottext">n' :: t
</span><a href="#local-6989586621682975719"><span class="hs-identifier hs-var hs-var">n'</span></a></span></span><span>
</span><span id="line-1233"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; Bool
forall b. Expr b -&gt; Bool
</span><a href="GHC.Core.html#isTypeArg"><span class="hs-identifier hs-var">isTypeArg</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975718"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621682975716"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1234"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621682975716"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">t -&gt; t -&gt; t
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span class="annot"><span class="annottext">t
</span><span class="hs-number">1</span></span><span>
</span><span id="line-1235"></span><span>
</span><span id="line-1236"></span><span>    </span><span class="hs-comment">-- Saturate if necessary</span><span>
</span><span id="line-1237"></span><span>    </span><span id="local-6989586621682975689"><span class="annot"><span class="annottext">mb_saturate :: Maybe InVar
-&gt; CpeRhs -&gt; a -&gt; [CoreTickish] -&gt; Int -&gt; UniqSM (a, CpeRhs)
</span><a href="#local-6989586621682975689"><span class="hs-identifier hs-var hs-var">mb_saturate</span></a></span></span><span> </span><span id="local-6989586621682975730"><span class="annot"><span class="annottext">Maybe InVar
</span><a href="#local-6989586621682975730"><span class="hs-identifier hs-var">head</span></a></span></span><span> </span><span id="local-6989586621682975731"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975731"><span class="hs-identifier hs-var">app</span></a></span></span><span> </span><span id="local-6989586621682975732"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682975732"><span class="hs-identifier hs-var">floats</span></a></span></span><span> </span><span id="local-6989586621682975733"><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682975733"><span class="hs-identifier hs-var">unsat_ticks</span></a></span></span><span> </span><span id="local-6989586621682975734"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682975734"><span class="hs-identifier hs-var">depth</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1238"></span><span>       </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe InVar
</span><a href="#local-6989586621682975730"><span class="hs-identifier hs-var">head</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1239"></span><span>         </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682975735"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975735"><span class="hs-identifier hs-var">fn_id</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682975736"><span class="annot"><a href="#local-6989586621682975736"><span class="hs-identifier hs-var">sat_app</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InVar -&gt; CpeRhs -&gt; Int -&gt; [CoreTickish] -&gt; UniqSM CpeRhs
</span><a href="GHC.CoreToStg.Prep.html#maybeSaturate"><span class="hs-identifier hs-var">maybeSaturate</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975735"><span class="hs-identifier hs-var">fn_id</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975731"><span class="hs-identifier hs-var">app</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682975734"><span class="hs-identifier hs-var">depth</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682975733"><span class="hs-identifier hs-var">unsat_ticks</span></a></span><span>
</span><span id="line-1240"></span><span>                          </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682975732"><span class="hs-identifier hs-type">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682975736"><span class="hs-identifier hs-type">sat_app</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1241"></span><span>         </span><span id="local-6989586621682975738"><span class="annot"><span class="annottext">Maybe InVar
</span><a href="#local-6989586621682975738"><span class="hs-identifier hs-var">_other</span></a></span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; UniqSM ()
forall (m :: * -&gt; *). (HasCallStack, Applicative m) =&gt; Bool -&gt; m ()
</span><a href="GHC.Utils.Panic.Plain.html#massert"><span class="hs-identifier hs-var">massert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreTickish] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682975733"><span class="hs-identifier hs-var">unsat_ticks</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1242"></span><span>                          </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(a, CpeRhs) -&gt; UniqSM (a, CpeRhs)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682975732"><span class="hs-identifier hs-var">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975731"><span class="hs-identifier hs-var">app</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1243"></span><span>
</span><span id="line-1244"></span><span>    </span><span class="hs-comment">-- Deconstruct and rebuild the application, floating any non-atomic</span><span>
</span><span id="line-1245"></span><span>    </span><span class="hs-comment">-- arguments to the outside.  We collect the type of the expression,</span><span>
</span><span id="line-1246"></span><span>    </span><span class="hs-comment">-- the head of the application, and the number of actual value arguments,</span><span>
</span><span id="line-1247"></span><span>    </span><span class="hs-comment">-- all of which are used to possibly saturate this application if it</span><span>
</span><span id="line-1248"></span><span>    </span><span class="hs-comment">-- has a constructor or primop at the head.</span><span>
</span><span id="line-1249"></span><span>    </span><span class="annot"><a href="#local-6989586621682975687"><span class="hs-identifier hs-type">rebuild_app</span></a></span><span>
</span><span id="line-1250"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span>
</span><span id="line-1251"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span class="hs-special">]</span><span>                  </span><span class="hs-comment">-- The arguments (inner to outer)</span><span>
</span><span id="line-1252"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeApp"><span class="hs-identifier hs-type">CpeApp</span></a></span><span>                     </span><span class="hs-comment">-- The function</span><span>
</span><span id="line-1253"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span>                     </span><span class="hs-comment">-- INVARIANT: These floats don't bind anything that is in the CpeApp!</span><span>
</span><span id="line-1254"></span><span>                                      </span><span class="hs-comment">-- Just stuff floated out from the head of the application.</span><span>
</span><span id="line-1255"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1256"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span>
</span><span id="line-1257"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeApp"><span class="hs-identifier hs-type">CpeApp</span></a></span><span>
</span><span id="line-1258"></span><span>                  </span><span class="hs-special">,</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span>
</span><span id="line-1259"></span><span>                  </span><span class="hs-special">,</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Tickish.html#CoreTickish"><span class="hs-identifier hs-type">CoreTickish</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- Underscoped ticks. See Note [Ticks and mandatory eta expansion]</span><span>
</span><span id="line-1260"></span><span>                  </span><span class="hs-special">)</span><span>
</span><span id="line-1261"></span><span>    </span><span id="local-6989586621682975687"><span class="annot"><span class="annottext">rebuild_app :: CorePrepEnv
-&gt; [ArgInfo]
-&gt; CpeRhs
-&gt; Floats
-&gt; [Demand]
-&gt; Maybe Int
-&gt; UniqSM (CpeRhs, Floats, [CoreTickish])
</span><a href="#local-6989586621682975687"><span class="hs-identifier hs-var hs-var">rebuild_app</span></a></span></span><span> </span><span id="local-6989586621682975741"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975741"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682975742"><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975742"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621682975743"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975743"><span class="hs-identifier hs-var">app</span></a></span></span><span> </span><span id="local-6989586621682975744"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975744"><span class="hs-identifier hs-var">floats</span></a></span></span><span> </span><span id="local-6989586621682975745"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682975745"><span class="hs-identifier hs-var">ss</span></a></span></span><span> </span><span id="local-6989586621682975746"><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621682975746"><span class="hs-identifier hs-var">req_depth</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1262"></span><span>      </span><span class="annot"><span class="annottext">CorePrepEnv
-&gt; [ArgInfo]
-&gt; CpeRhs
-&gt; Floats
-&gt; [Demand]
-&gt; [CoreTickish]
-&gt; Int
-&gt; UniqSM (CpeRhs, Floats, [CoreTickish])
</span><a href="#local-6989586621682975747"><span class="hs-identifier hs-var">rebuild_app'</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975741"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975742"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975743"><span class="hs-identifier hs-var">app</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975744"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682975745"><span class="hs-identifier hs-var">ss</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Maybe Int -&gt; Int
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621682975746"><span class="hs-identifier hs-var">req_depth</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1263"></span><span>
</span><span id="line-1264"></span><span>    </span><span class="annot"><a href="#local-6989586621682975747"><span class="hs-identifier hs-type">rebuild_app'</span></a></span><span>
</span><span id="line-1265"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span>
</span><span id="line-1266"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- The arguments (inner to outer)</span><span>
</span><span id="line-1267"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeApp"><span class="hs-identifier hs-type">CpeApp</span></a></span><span>
</span><span id="line-1268"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span>
</span><span id="line-1269"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1270"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Tickish.html#CoreTickish"><span class="hs-identifier hs-type">CoreTickish</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1271"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-comment">-- Number of arguments required to satisfy minimal tick scopes.</span><span>
</span><span id="line-1272"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeApp"><span class="hs-identifier hs-type">CpeApp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Tickish.html#CoreTickish"><span class="hs-identifier hs-type">CoreTickish</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1273"></span><span>    </span><span id="local-6989586621682975747"><span class="annot"><span class="annottext">rebuild_app' :: CorePrepEnv
-&gt; [ArgInfo]
-&gt; CpeRhs
-&gt; Floats
-&gt; [Demand]
-&gt; [CoreTickish]
-&gt; Int
-&gt; UniqSM (CpeRhs, Floats, [CoreTickish])
</span><a href="#local-6989586621682975747"><span class="hs-identifier hs-var hs-var">rebuild_app'</span></a></span></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621682975749"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975749"><span class="hs-identifier hs-var">app</span></a></span></span><span> </span><span id="local-6989586621682975750"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975750"><span class="hs-identifier hs-var">floats</span></a></span></span><span> </span><span id="local-6989586621682975751"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682975751"><span class="hs-identifier hs-var">ss</span></a></span></span><span> </span><span id="local-6989586621682975752"><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682975752"><span class="hs-identifier hs-var">rt_ticks</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682975753"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682975753"><span class="hs-identifier hs-var">_req_depth</span></a></span></span><span>
</span><span id="line-1274"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; SDoc
-&gt; ((CpeRhs, Floats, [CoreTickish])
    -&gt; UniqSM (CpeRhs, Floats, [CoreTickish]))
-&gt; (CpeRhs, Floats, [CoreTickish])
-&gt; UniqSM (CpeRhs, Floats, [CoreTickish])
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Demand] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682975751"><span class="hs-identifier hs-var">ss</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Demand] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682975751"><span class="hs-identifier hs-var">ss</span></a></span><span class="hs-special">)</span><span class="hs-comment">-- make sure we used all the strictness info</span><span>
</span><span id="line-1275"></span><span>        </span><span class="annot"><span class="annottext">(CpeRhs, Floats, [CoreTickish])
-&gt; UniqSM (CpeRhs, Floats, [CoreTickish])
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975749"><span class="hs-identifier hs-var">app</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975750"><span class="hs-identifier hs-var">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682975752"><span class="hs-identifier hs-var">rt_ticks</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1276"></span><span>
</span><span id="line-1277"></span><span>    </span><span class="annot"><a href="#local-6989586621682975747"><span class="hs-identifier hs-var">rebuild_app'</span></a></span><span> </span><span id="local-6989586621682975755"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975755"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975756"><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682975756"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682975757"><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975757"><span class="hs-keyword hs-var">as</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682975758"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975758"><span class="hs-identifier hs-var">fun'</span></a></span></span><span> </span><span id="local-6989586621682975759"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975759"><span class="hs-identifier hs-var">floats</span></a></span></span><span> </span><span id="local-6989586621682975760"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682975760"><span class="hs-identifier hs-var">ss</span></a></span></span><span> </span><span id="local-6989586621682975761"><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682975761"><span class="hs-identifier hs-var">rt_ticks</span></a></span></span><span> </span><span id="local-6989586621682975762"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682975762"><span class="hs-identifier hs-var">req_depth</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682975756"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1278"></span><span>      </span><span class="hs-comment">-- See Note [Ticks and mandatory eta expansion]</span><span>
</span><span id="line-1279"></span><span>      </span><span class="annot"><span class="annottext">ArgInfo
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-1280"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreTickish] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682975761"><span class="hs-identifier hs-var">rt_ticks</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1281"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682975762"><span class="hs-identifier hs-var">req_depth</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1282"></span><span>        </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1283"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682975763"><span class="annot"><span class="annottext">tick_fun :: CpeRhs
</span><a href="#local-6989586621682975763"><span class="hs-identifier hs-var hs-var">tick_fun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreTickish -&gt; CpeRhs -&gt; CpeRhs)
-&gt; CpeRhs -&gt; [CoreTickish] -&gt; CpeRhs
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; CpeRhs -&gt; CpeRhs
</span><a href="GHC.Core.Utils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975758"><span class="hs-identifier hs-var">fun'</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682975761"><span class="hs-identifier hs-var">rt_ticks</span></a></span><span>
</span><span id="line-1284"></span><span>            </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
-&gt; [ArgInfo]
-&gt; CpeRhs
-&gt; Floats
-&gt; [Demand]
-&gt; [CoreTickish]
-&gt; Int
-&gt; UniqSM (CpeRhs, Floats, [CoreTickish])
</span><a href="#local-6989586621682975747"><span class="hs-identifier hs-var">rebuild_app'</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975755"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682975756"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">ArgInfo -&gt; [ArgInfo] -&gt; [ArgInfo]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975757"><span class="hs-keyword hs-var">as</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975763"><span class="hs-identifier hs-var">tick_fun</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975759"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682975760"><span class="hs-identifier hs-var">ss</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682975761"><span class="hs-identifier hs-var">rt_ticks</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682975762"><span class="hs-identifier hs-var">req_depth</span></a></span><span>
</span><span id="line-1285"></span><span>
</span><span id="line-1286"></span><span>      </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#AIApp"><span class="hs-identifier hs-type">AIApp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span id="local-6989586621682975765"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682975765"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1287"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
-&gt; [ArgInfo]
-&gt; CpeRhs
-&gt; Floats
-&gt; [Demand]
-&gt; [CoreTickish]
-&gt; Int
-&gt; UniqSM (CpeRhs, Floats, [CoreTickish])
</span><a href="#local-6989586621682975747"><span class="hs-identifier hs-var">rebuild_app'</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975755"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975757"><span class="hs-keyword hs-var">as</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeRhs -&gt; CpeRhs -&gt; CpeRhs
forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-identifier hs-var">App</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975758"><span class="hs-identifier hs-var">fun'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; CpeRhs
forall b. Type -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682975766"><span class="hs-identifier hs-var">arg_ty'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975759"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682975760"><span class="hs-identifier hs-var">ss</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682975761"><span class="hs-identifier hs-var">rt_ticks</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682975762"><span class="hs-identifier hs-var">req_depth</span></a></span><span>
</span><span id="line-1288"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-1289"></span><span>           </span><span id="local-6989586621682975766"><span class="annot"><span class="annottext">arg_ty' :: Type
</span><a href="#local-6989586621682975766"><span class="hs-identifier hs-var hs-var">arg_ty'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Type -&gt; Type
</span><a href="GHC.CoreToStg.Prep.html#cpSubstTy"><span class="hs-identifier hs-var">cpSubstTy</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975755"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682975765"><span class="hs-identifier hs-var">arg_ty</span></a></span><span>
</span><span id="line-1290"></span><span>
</span><span id="line-1291"></span><span>      </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#AIApp"><span class="hs-identifier hs-type">AIApp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span id="local-6989586621682975767"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682975767"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1292"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
-&gt; [ArgInfo]
-&gt; CpeRhs
-&gt; Floats
-&gt; [Demand]
-&gt; [CoreTickish]
-&gt; Int
-&gt; UniqSM (CpeRhs, Floats, [CoreTickish])
</span><a href="#local-6989586621682975747"><span class="hs-identifier hs-var">rebuild_app'</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975755"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975757"><span class="hs-keyword hs-var">as</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeRhs -&gt; CpeRhs -&gt; CpeRhs
forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-identifier hs-var">App</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975758"><span class="hs-identifier hs-var">fun'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; CpeRhs
forall b. Coercion -&gt; Expr b
</span><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682975768"><span class="hs-identifier hs-var">co'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975759"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; [Demand] -&gt; [Demand]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682975760"><span class="hs-identifier hs-var">ss</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682975761"><span class="hs-identifier hs-var">rt_ticks</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682975762"><span class="hs-identifier hs-var">req_depth</span></a></span><span>
</span><span id="line-1293"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-1294"></span><span>           </span><span id="local-6989586621682975768"><span class="annot"><span class="annottext">co' :: Coercion
</span><a href="#local-6989586621682975768"><span class="hs-identifier hs-var hs-var">co'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Coercion -&gt; Coercion
</span><a href="GHC.CoreToStg.Prep.html#cpSubstCo"><span class="hs-identifier hs-var">cpSubstCo</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975755"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682975767"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1295"></span><span>
</span><span id="line-1296"></span><span>      </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#AIApp"><span class="hs-identifier hs-type">AIApp</span></a></span><span> </span><span id="local-6989586621682975770"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975770"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1297"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975771"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682975771"><span class="hs-identifier hs-var hs-var">ss1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975772"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682975772"><span class="hs-identifier hs-var hs-var">ss_rest</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- See Note [lazyId magic] in GHC.Types.Id.Make</span><span>
</span><span id="line-1298"></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682975760"><span class="hs-identifier hs-var">ss</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#isLazyExpr"><span class="hs-identifier hs-var">isLazyExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975770"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1299"></span><span>                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Demand
</span><span class="hs-identifier">_</span></span><span>   </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682975774"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682975774"><span class="hs-identifier hs-var">ss_rest</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Demand
</span><a href="GHC.Types.Demand.html#topDmd"><span class="hs-identifier hs-var">topDmd</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682975774"><span class="hs-identifier hs-var">ss_rest</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1300"></span><span>                   </span><span class="hs-special">(</span><span id="local-6989586621682975775"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682975775"><span class="hs-identifier hs-var">ss1</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682975776"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682975776"><span class="hs-identifier hs-var">ss_rest</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682975775"><span class="hs-identifier hs-var">ss1</span></a></span><span class="hs-special">,</span><span>    </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682975776"><span class="hs-identifier hs-var">ss_rest</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1301"></span><span>                   </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>            </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Demand
</span><a href="GHC.Types.Demand.html#topDmd"><span class="hs-identifier hs-var">topDmd</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1302"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621682975777"><span class="annot"><a href="#local-6989586621682975777"><span class="hs-identifier hs-var">fs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975778"><span class="annot"><a href="#local-6989586621682975778"><span class="hs-identifier hs-var">arg'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Demand -&gt; CpeRhs -&gt; UniqSM (Floats, CpeRhs)
</span><a href="GHC.CoreToStg.Prep.html#cpeArg"><span class="hs-identifier hs-var">cpeArg</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975608"><span class="hs-identifier hs-var">top_env</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682975771"><span class="hs-identifier hs-var">ss1</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975770"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-1303"></span><span>        </span><span class="annot"><a href="#local-6989586621682975747"><span class="hs-identifier hs-type">rebuild_app'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975755"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975757"><span class="hs-keyword hs-type">as</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975758"><span class="hs-identifier hs-type">fun'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975778"><span class="hs-identifier hs-type">arg'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682975777"><span class="hs-identifier hs-type">fs</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#zipFloats"><span class="hs-operator hs-type">`zipFloats`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975759"><span class="hs-identifier hs-type">floats</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682975772"><span class="hs-identifier hs-type">ss_rest</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975761"><span class="hs-identifier hs-type">rt_ticks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682975762"><span class="hs-identifier hs-type">req_depth</span></a></span><span class="annot"><span class="hs-glyph hs-type">-</span></span><span class="annot"><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-1304"></span><span>
</span><span id="line-1305"></span><span>      </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#AICast"><span class="hs-identifier hs-type">AICast</span></a></span><span> </span><span id="local-6989586621682975779"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682975779"><span class="hs-identifier hs-var">co</span></a></span></span><span>
</span><span id="line-1306"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
-&gt; [ArgInfo]
-&gt; CpeRhs
-&gt; Floats
-&gt; [Demand]
-&gt; [CoreTickish]
-&gt; Int
-&gt; UniqSM (CpeRhs, Floats, [CoreTickish])
</span><a href="#local-6989586621682975747"><span class="hs-identifier hs-var">rebuild_app'</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975755"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975757"><span class="hs-keyword hs-var">as</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeRhs -&gt; Coercion -&gt; CpeRhs
forall b. Expr b -&gt; Coercion -&gt; Expr b
</span><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-var">Cast</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975758"><span class="hs-identifier hs-var">fun'</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682975780"><span class="hs-identifier hs-var">co'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975759"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682975760"><span class="hs-identifier hs-var">ss</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682975761"><span class="hs-identifier hs-var">rt_ticks</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682975762"><span class="hs-identifier hs-var">req_depth</span></a></span><span>
</span><span id="line-1307"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-1308"></span><span>           </span><span id="local-6989586621682975780"><span class="annot"><span class="annottext">co' :: Coercion
</span><a href="#local-6989586621682975780"><span class="hs-identifier hs-var hs-var">co'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Coercion -&gt; Coercion
</span><a href="GHC.CoreToStg.Prep.html#cpSubstCo"><span class="hs-identifier hs-var">cpSubstCo</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975755"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682975779"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1309"></span><span>
</span><span id="line-1310"></span><span>      </span><span class="hs-comment">-- See Note [Ticks and mandatory eta expansion]</span><span>
</span><span id="line-1311"></span><span>      </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#AITick"><span class="hs-identifier hs-type">AITick</span></a></span><span> </span><span id="local-6989586621682975781"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682975781"><span class="hs-identifier hs-var">tickish</span></a></span></span><span>
</span><span id="line-1312"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; TickishPlacement
forall (pass :: TickishPass). GenTickish pass -&gt; TickishPlacement
</span><a href="GHC.Types.Tickish.html#tickishPlace"><span class="hs-identifier hs-var">tickishPlace</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682975781"><span class="hs-identifier hs-var">tickish</span></a></span><span> </span><span class="annot"><span class="annottext">TickishPlacement -&gt; TickishPlacement -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TickishPlacement
</span><a href="GHC.Types.Tickish.html#PlaceRuntime"><span class="hs-identifier hs-var">PlaceRuntime</span></a></span><span>
</span><span id="line-1313"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682975762"><span class="hs-identifier hs-var">req_depth</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1314"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; UniqSM (CpeRhs, Floats, [CoreTickish])
-&gt; UniqSM (CpeRhs, Floats, [CoreTickish])
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#isProfTick"><span class="hs-identifier hs-var">isProfTick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682975781"><span class="hs-identifier hs-var">tickish</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(UniqSM (CpeRhs, Floats, [CoreTickish])
 -&gt; UniqSM (CpeRhs, Floats, [CoreTickish]))
-&gt; UniqSM (CpeRhs, Floats, [CoreTickish])
-&gt; UniqSM (CpeRhs, Floats, [CoreTickish])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1315"></span><span>           </span><span class="annot"><span class="annottext">CorePrepEnv
-&gt; [ArgInfo]
-&gt; CpeRhs
-&gt; Floats
-&gt; [Demand]
-&gt; [CoreTickish]
-&gt; Int
-&gt; UniqSM (CpeRhs, Floats, [CoreTickish])
</span><a href="#local-6989586621682975747"><span class="hs-identifier hs-var">rebuild_app'</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975755"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975757"><span class="hs-keyword hs-var">as</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975758"><span class="hs-identifier hs-var">fun'</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975759"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682975760"><span class="hs-identifier hs-var">ss</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682975781"><span class="hs-identifier hs-var">tickish</span></a></span><span class="annot"><span class="annottext">CoreTickish -&gt; [CoreTickish] -&gt; [CoreTickish]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682975761"><span class="hs-identifier hs-var">rt_ticks</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682975762"><span class="hs-identifier hs-var">req_depth</span></a></span><span>
</span><span id="line-1316"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1317"></span><span>        </span><span class="hs-comment">-- See [Floating Ticks in CorePrep]</span><span>
</span><span id="line-1318"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
-&gt; [ArgInfo]
-&gt; CpeRhs
-&gt; Floats
-&gt; [Demand]
-&gt; [CoreTickish]
-&gt; Int
-&gt; UniqSM (CpeRhs, Floats, [CoreTickish])
</span><a href="#local-6989586621682975747"><span class="hs-identifier hs-var">rebuild_app'</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975755"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621682975757"><span class="hs-keyword hs-var">as</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975758"><span class="hs-identifier hs-var">fun'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats -&gt; FloatingBind -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#snocFloat"><span class="hs-identifier hs-var">snocFloat</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975759"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#FloatTick"><span class="hs-identifier hs-var">FloatTick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682975781"><span class="hs-identifier hs-var">tickish</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682975760"><span class="hs-identifier hs-var">ss</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682975761"><span class="hs-identifier hs-var">rt_ticks</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682975762"><span class="hs-identifier hs-var">req_depth</span></a></span><span>
</span><span id="line-1319"></span><span>
</span><span id="line-1320"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#isLazyExpr"><span class="hs-identifier hs-type">isLazyExpr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1321"></span><span class="hs-comment">-- See Note [lazyId magic] in GHC.Types.Id.Make</span><span>
</span><span id="line-1322"></span><span id="isLazyExpr"><span class="annot"><span class="annottext">isLazyExpr :: CpeRhs -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#isLazyExpr"><span class="hs-identifier hs-var hs-var">isLazyExpr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682975786"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975786"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#isLazyExpr"><span class="hs-identifier hs-var">isLazyExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975786"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1323"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#isLazyExpr"><span class="hs-identifier hs-var">isLazyExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682975787"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975787"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#isLazyExpr"><span class="hs-identifier hs-var">isLazyExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975787"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1324"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#isLazyExpr"><span class="hs-identifier hs-var">isLazyExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682975788"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975788"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-operator hs-type">`App`</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-operator hs-type">`App`</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975788"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">InVar -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#lazyIdKey"><span class="hs-identifier hs-var">lazyIdKey</span></a></span><span>
</span><span id="line-1325"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#isLazyExpr"><span class="hs-identifier hs-var">isLazyExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><span class="hs-identifier">_</span></span><span>                       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1326"></span><span>
</span><span id="line-1327"></span><span class="hs-comment">{- Note [runRW magic]
~~~~~~~~~~~~~~~~~~~~~
Some definitions, for instance @runST@, must have careful control over float out
of the bindings in their body. Consider this use of @runST@,

    f x = runST ( \ s -&gt; let (a, s')  = newArray# 100 [] s
                             (_, s'') = fill_in_array_or_something a x s'
                         in freezeArray# a s'' )

If we inline @runST@, we'll get:

    f x = let (a, s')  = newArray# 100 [] realWorld#{-NB-}
              (_, s'') = fill_in_array_or_something a x s'
          in freezeArray# a s''

And now if we allow the @newArray#@ binding to float out to become a CAF,
we end up with a result that is totally and utterly wrong:

    f = let (a, s')  = newArray# 100 [] realWorld#{-NB-} -- YIKES!!!
        in \ x -&gt;
            let (_, s'') = fill_in_array_or_something a x s'
            in freezeArray# a s''

All calls to @f@ will share a {\em single} array! Clearly this is nonsense and
must be prevented.

This is what @runRW#@ gives us: by being inlined extremely late in the
optimization (right before lowering to STG, in CorePrep), we can ensure that
no further floating will occur. This allows us to safely inline things like
@runST@, which are otherwise needlessly expensive (see #10678 and #5916).

'runRW' has a variety of quirks:

 * 'runRW' is known-key with a NOINLINE definition in
   GHC.Magic. This definition is used in cases where runRW is curried.

 * In addition to its normal Haskell definition in GHC.Magic, we give it
   a special late inlining here in CorePrep and GHC.StgToByteCode, avoiding
   the incorrect sharing due to float-out noted above.

 * It is levity-polymorphic:

    runRW# :: forall (r1 :: RuntimeRep). (o :: TYPE r)
           =&gt; (State# RealWorld -&gt; (# State# RealWorld, o #))
           -&gt; (# State# RealWorld, o #)

 * It has some special simplification logic to allow unboxing of results when
   runRW# appears in a strict context. See Note [Simplification of runRW#]
   below.

 * Since its body is inlined, we allow runRW#'s argument to contain jumps to
   join points. That is, the following is allowed:

    join j x = ...
    in runRW# @_ @_ (\s -&gt; ... jump j 42 ...)

   The Core Linter knows about this. See Note [Linting of runRW#] in
   GHC.Core.Lint for details.

   The occurrence analyser and SetLevels also know about this, as described in
   Note [Simplification of runRW#].

Other relevant Notes:

 * Note [Simplification of runRW#] below, describing a transformation of runRW
   applications in strict contexts performed by the simplifier.
 * Note [Linting of runRW#] in GHC.Core.Lint
 * Note [runRW arg] below, describing a non-obvious case where the
   late-inlining could go wrong.

Note [runRW arg]
~~~~~~~~~~~~~~~~~~~
Consider the Core program (from #11291),

   runRW# (case bot of {})

The late inlining logic in cpe_app would transform this into:

   (case bot of {}) realWorld#

Which would rise to a panic in CoreToStg.myCollectArgs, which expects only
variables in function position.

However, as runRW#'s strictness signature captures the fact that it will call
its argument this can't happen: the simplifier will transform the bottoming
application into simply (case bot of {}).

Note that this reasoning does *not* apply to non-bottoming continuations like:

    hello :: Bool -&gt; Int
    hello n =
      runRW# (
          case n of
            True -&gt; \s -&gt; 23
            _    -&gt; \s -&gt; 10)

Why? The difference is that (case bot of {}) is considered by okCpeArg to be
trivial, consequently cpeArg (which the catch-all case of cpe_app calls on both
the function and the arguments) will forgo binding it to a variable. By
contrast, in the non-bottoming case of `hello` above  the function will be
deemed non-trivial and consequently will be case-bound.

Note [Simplification of runRW#]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider the program,

    case runRW# (\s -&gt; I# 42#) of
      I# n# -&gt; f n#

There is no reason why we should allocate an I# constructor given that we
immediately destructure it.

To avoid this the simplifier has a special transformation rule, specific to
runRW#, that pushes a strict context into runRW#'s continuation.  See the
`runRW#` guard in `GHC.Core.Opt.Simplify.rebuildCall`.  That is, it transforms

    K[ runRW# @r @ty cont ]
              ~&gt;
    runRW# @r @ty (\s -&gt; K[cont s])

This has a few interesting implications. Consider, for instance, this program:

    join j = ...
    in case runRW# @r @ty cont of
         result -&gt; jump j result

Performing the transform described above would result in:

    join j x = ...
    in runRW# @r @ty (\s -&gt;
         case cont of in
           result -&gt; jump j result
       )

If runRW# were a &quot;normal&quot; function this call to join point j would not be
allowed in its continuation argument. However, since runRW# is inlined (as
described in Note [runRW magic] above), such join point occurrences are
completely fine. Both occurrence analysis (see the runRW guard in occAnalApp)
and Core Lint (see the App case of lintCoreExpr) have special treatment for
runRW# applications. See Note [Linting of runRW#] for details on the latter.

Moreover, it's helpful to ensure that runRW's continuation isn't floated out
For instance, if we have

    runRW# (\s -&gt; do_something)

where do_something contains only top-level free variables, we may be tempted to
float the argument to the top-level. However, we must resist this urge as since
doing so would then require that runRW# produce an allocation and call, e.g.:

    let lvl = \s -&gt; do_somethign
    in
    ....(runRW# lvl)....

whereas without floating the inlining of the definition of runRW would result
in straight-line code. Consequently, GHC.Core.Opt.SetLevels.lvlApp has special
treatment for runRW# applications, ensure the arguments are not floated as
MFEs.

Now that we float evaluation context into runRW#, we also have to give runRW# a
special higher-order CPR transformer lest we risk #19822. E.g.,

  case runRW# (\s -&gt; doThings) of x -&gt; Data.Text.Text x something something'
      ~&gt;
  runRW# (\s -&gt; case doThings s of x -&gt; Data.Text.Text x something something')

The former had the CPR property, and so should the latter.

Other considered designs
------------------------

One design that was rejected was to *require* that runRW#'s continuation be
headed by a lambda. However, this proved to be quite fragile. For instance,
SetLevels is very eager to float bottoming expressions. For instance given
something of the form,

    runRW# @r @ty (\s -&gt; case expr of x -&gt; undefined)

SetLevels will see that the body the lambda is bottoming and will consequently
float it to the top-level (assuming expr has no free coercion variables which
prevent this). We therefore end up with

    runRW# @r @ty (\s -&gt; lvl s)

Which the simplifier will beta reduce, leaving us with

    runRW# @r @ty lvl

Breaking our desired invariant. Ultimately we decided to simply accept that
the continuation may not be a manifest lambda.


-- ---------------------------------------------------------------------------
--      CpeArg: produces a result satisfying CpeArg
-- ---------------------------------------------------------------------------

Note [ANF-ising literal string arguments]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider a Core program like,

    data Foo = Foo Addr#
    foo = Foo &quot;turtle&quot;#

String literals are non-trivial, see 'GHC.Types.Literal.litIsTrivial', hence
they are non-atomic in STG.
With -O1, FloatOut is likely to have floated most of these strings to top-level,
not least to give CSE a chance to deduplicate strings early (before the
linker, that is).
(Notable exceptions seem to be applications of 'unpackAppendCString#'.)
But with -O0, there is no FloatOut, so CorePrep must do the ANFisation to

    s = &quot;turtle&quot;#
    foo = Foo s

(String literals are the only kind of binding allowed at top-level and hence
their `FloatInfo` is `TopLvlFloatable`.)

This appears to lead to bad code if the arg is under a lambda, because CorePrep
doesn't float out of RHSs, e.g., (T23270)

    foo x = ... patError &quot;turtle&quot;# ...
==&gt; foo x = ... case &quot;turtle&quot;# of s { __DEFAULT -&gt; petError s } ...

This looks bad because it evals an HNF on every call.
But actually, it doesn't, because &quot;turtle&quot;# is already an HNF. Here is the Cmm:

  [section &quot;&quot;cstring&quot; . cB4_str&quot; {
       cB4_str:
           I8[] &quot;turtle&quot;
   }
  ...
  _sAG::I64 = cB4_str;
  R2 = _sAG::I64;
  Sp = Sp + 8;
  call Control.Exception.Base.patError_info(R2) args: 8, res: 0, upd: 8;

Wrinkles:

(FS1) We detect string literals in `cpeBind Rec{}` and float them out anyway;
      otherwise we'd try to bind a string literal in a letrec, violating
      Note [Core letrec invariant]. Since we know that literals don't have
      free variables, we float further.
      Arguably, we could just as well relax the letrec invariant for
      string literals, or anthing that is a value (lifted or not).
      This is tracked in #24036.
-}</span><span>
</span><span id="line-1573"></span><span>
</span><span id="line-1574"></span><span class="hs-comment">-- This is where we arrange that a non-trivial argument is let-bound</span><span>
</span><span id="line-1575"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeArg"><span class="hs-identifier hs-type">cpeArg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span>
</span><span id="line-1576"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeArg"><span class="hs-identifier hs-type">CpeArg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1577"></span><span id="cpeArg"><span class="annot"><span class="annottext">cpeArg :: CorePrepEnv -&gt; Demand -&gt; CpeRhs -&gt; UniqSM (Floats, CpeRhs)
</span><a href="GHC.CoreToStg.Prep.html#cpeArg"><span class="hs-identifier hs-var hs-var">cpeArg</span></a></span></span><span> </span><span id="local-6989586621682975789"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975789"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682975790"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682975790"><span class="hs-identifier hs-var">dmd</span></a></span></span><span> </span><span id="local-6989586621682975791"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975791"><span class="hs-identifier hs-var">arg</span></a></span></span><span>
</span><span id="line-1578"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975792"><span class="annot"><a href="#local-6989586621682975792"><span class="hs-identifier hs-var">floats1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975793"><span class="annot"><a href="#local-6989586621682975793"><span class="hs-identifier hs-var">arg1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeRhs -&gt; UniqSM (Floats, CpeRhs)
</span><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975789"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975791"><span class="hs-identifier hs-var">arg</span></a></span><span>     </span><span class="hs-comment">-- arg1 can be a lambda</span><span>
</span><span id="line-1579"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682975794"><span class="annot"><a href="#local-6989586621682975794"><span class="hs-identifier hs-var hs-var">arg_ty</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CpeRhs -&gt; Type
CpeRhs -&gt; Type
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975793"><span class="hs-identifier hs-var">arg1</span></a></span><span>
</span><span id="line-1580"></span><span>             </span><span id="local-6989586621682975795"><span class="annot"><a href="#local-6989586621682975795"><span class="hs-identifier hs-var hs-var">is_unlifted</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Bool
Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isUnliftedType"><span class="hs-identifier hs-var">isUnliftedType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682975794"><span class="hs-identifier hs-var">arg_ty</span></a></span><span>
</span><span id="line-1581"></span><span>             </span><span id="local-6989586621682975796"><span class="annot"><a href="#local-6989586621682975796"><span class="hs-identifier hs-var hs-var">dec</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RecFlag -&gt; Demand -&gt; Bool -&gt; Floats -&gt; CpeRhs -&gt; FloatDecision
</span><a href="GHC.CoreToStg.Prep.html#wantFloatLocal"><span class="hs-identifier hs-var">wantFloatLocal</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="GHC.Types.Basic.html#NonRecursive"><span class="hs-identifier hs-var">NonRecursive</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682975790"><span class="hs-identifier hs-var">dmd</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682975795"><span class="hs-identifier hs-var">is_unlifted</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975792"><span class="hs-identifier hs-var">floats1</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975793"><span class="hs-identifier hs-var">arg1</span></a></span><span>
</span><span id="line-1582"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682975797"><span class="annot"><a href="#local-6989586621682975797"><span class="hs-identifier hs-var">floats2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975798"><span class="annot"><a href="#local-6989586621682975798"><span class="hs-identifier hs-var">arg2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#executeFloatDecision"><span class="hs-identifier hs-type">executeFloatDecision</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975796"><span class="hs-identifier hs-type">dec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975792"><span class="hs-identifier hs-type">floats1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975793"><span class="hs-identifier hs-type">arg1</span></a></span><span>
</span><span id="line-1583"></span><span>                </span><span class="hs-comment">-- Else case: arg1 might have lambdas, and we can't</span><span>
</span><span id="line-1584"></span><span>                </span><span class="hs-comment">--            put them inside a wrapBinds</span><span>
</span><span id="line-1585"></span><span>
</span><span id="line-1586"></span><span>       </span><span class="hs-comment">-- Now ANF-ise any non-trivial argument</span><span>
</span><span id="line-1587"></span><span>       </span><span class="hs-comment">-- NB: &quot;non-trivial&quot; includes string literals;</span><span>
</span><span id="line-1588"></span><span>       </span><span class="hs-comment">-- see Note [ANF-ising literal string arguments]</span><span>
</span><span id="line-1589"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#exprIsTrivial"><span class="hs-identifier hs-type">exprIsTrivial</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975798"><span class="hs-identifier hs-type">arg2</span></a></span><span>
</span><span id="line-1590"></span><span>         </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682975797"><span class="hs-identifier hs-type">floats2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682975798"><span class="hs-identifier hs-type">arg2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1591"></span><span>         </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682975799"><span class="annot"><a href="#local-6989586621682975799"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">`setIdDemandInfo`</span></span><span> </span><span class="annot"><span class="hs-identifier">dmd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#newVar"><span class="hs-identifier hs-type">newVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975794"><span class="hs-identifier hs-type">arg_ty</span></a></span><span>
</span><span id="line-1592"></span><span>                       </span><span class="hs-comment">-- See Note [Pin demand info on floats]</span><span>
</span><span id="line-1593"></span><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682975802"><span class="annot"><a href="#local-6989586621682975802"><span class="hs-identifier hs-var hs-var">arity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; FloatDecision -&gt; Floats -&gt; CpeRhs -&gt; Int
</span><a href="GHC.CoreToStg.Prep.html#cpeArgArity"><span class="hs-identifier hs-var">cpeArgArity</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975789"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">FloatDecision
</span><a href="#local-6989586621682975796"><span class="hs-identifier hs-var">dec</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975792"><span class="hs-identifier hs-var">floats1</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975798"><span class="hs-identifier hs-var">arg2</span></a></span><span>
</span><span id="line-1594"></span><span>                       </span><span id="local-6989586621682975804"><span class="annot"><a href="#local-6989586621682975804"><span class="hs-identifier hs-var hs-var">arg3</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CpeRhs -&gt; CpeRhs
</span><a href="GHC.CoreToStg.Prep.html#cpeEtaExpand"><span class="hs-identifier hs-var">cpeEtaExpand</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682975802"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975798"><span class="hs-identifier hs-var">arg2</span></a></span><span>
</span><span id="line-1595"></span><span>                       </span><span class="hs-comment">-- See Note [Eta expansion of arguments in CorePrep]</span><span>
</span><span id="line-1596"></span><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682975805"><span class="annot"><a href="#local-6989586621682975805"><span class="hs-identifier hs-var hs-var">arg_float</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Bool -&gt; InVar -&gt; CpeRhs -&gt; FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#mkNonRecFloat"><span class="hs-identifier hs-var">mkNonRecFloat</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975789"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682975795"><span class="hs-identifier hs-var">is_unlifted</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975799"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975804"><span class="hs-identifier hs-var">arg3</span></a></span><span>
</span><span id="line-1597"></span><span>                 </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#snocFloat"><span class="hs-identifier hs-type">snocFloat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975797"><span class="hs-identifier hs-type">floats2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975805"><span class="hs-identifier hs-type">arg_float</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#varToCoreExpr"><span class="hs-identifier hs-type">varToCoreExpr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682975799"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1598"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-1599"></span><span>
</span><span id="line-1600"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeArgArity"><span class="hs-identifier hs-type">cpeArgArity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatDecision"><span class="hs-identifier hs-type">FloatDecision</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span>
</span><span id="line-1601"></span><span class="hs-comment">-- ^ See Note [Eta expansion of arguments in CorePrep]</span><span>
</span><span id="line-1602"></span><span class="hs-comment">-- Returning 0 means &quot;no eta-expansion&quot;; see cpeEtaExpand</span><span>
</span><span id="line-1603"></span><span id="cpeArgArity"><span class="annot"><span class="annottext">cpeArgArity :: CorePrepEnv -&gt; FloatDecision -&gt; Floats -&gt; CpeRhs -&gt; Int
</span><a href="GHC.CoreToStg.Prep.html#cpeArgArity"><span class="hs-identifier hs-var hs-var">cpeArgArity</span></a></span></span><span> </span><span id="local-6989586621682975807"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975807"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682975808"><span class="annot"><span class="annottext">FloatDecision
</span><a href="#local-6989586621682975808"><span class="hs-identifier hs-var">float_decision</span></a></span></span><span> </span><span id="local-6989586621682975809"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975809"><span class="hs-identifier hs-var">floats1</span></a></span></span><span> </span><span id="local-6989586621682975810"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975810"><span class="hs-identifier hs-var">arg</span></a></span></span><span>
</span><span id="line-1604"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">FloatDecision
</span><a href="GHC.CoreToStg.Prep.html#FloatNone"><span class="hs-identifier hs-var">FloatNone</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FloatDecision
</span><a href="#local-6989586621682975808"><span class="hs-identifier hs-var">float_decision</span></a></span><span>
</span><span id="line-1605"></span><span>         </span><span class="hs-comment">-- If we did not float</span><span>
</span><span id="line-1606"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#isEmptyFloats"><span class="hs-identifier hs-var">isEmptyFloats</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975809"><span class="hs-identifier hs-var">floats1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1607"></span><span>         </span><span class="hs-comment">-- ... but there was something to float</span><span>
</span><span id="line-1608"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Floats -&gt; FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#fs_info"><span class="hs-identifier hs-var">fs_info</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975809"><span class="hs-identifier hs-var">floats1</span></a></span><span> </span><span class="annot"><span class="annottext">FloatInfo -&gt; FloatInfo -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#floatsAtLeastAsFarAs"><span class="hs-operator hs-var">`floatsAtLeastAsFarAs`</span></a></span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#LazyContextFloatable"><span class="hs-identifier hs-var">LazyContextFloatable</span></a></span><span>
</span><span id="line-1609"></span><span>         </span><span class="hs-comment">-- ... and we could have floated it out of a lazy arg</span><span>
</span><span id="line-1610"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>    </span><span class="hs-comment">-- ... then short-cut, because floats1 is likely expensive!</span><span>
</span><span id="line-1611"></span><span>         </span><span class="hs-comment">-- See wrinkle (EA2) in Note [Eta expansion of arguments in CorePrep]</span><span>
</span><span id="line-1612"></span><span>
</span><span id="line-1613"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682975816"><span class="annot"><span class="annottext">ArityOpts
</span><a href="#local-6989586621682975816"><span class="hs-identifier hs-var">ao</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepConfig -&gt; Maybe ArityOpts
</span><a href="GHC.CoreToStg.Prep.html#cp_arityOpts"><span class="hs-identifier hs-var">cp_arityOpts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CorePrepConfig
</span><a href="GHC.CoreToStg.Prep.html#cpe_config"><span class="hs-identifier hs-var">cpe_config</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975807"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Just &lt;=&gt; -O1 or -O2</span><span>
</span><span id="line-1614"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeRhs -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#eta_would_wreck_join"><span class="hs-identifier hs-var">eta_would_wreck_join</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975810"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1615"></span><span>            </span><span class="hs-comment">-- See Wrinkle (EA1) of Note [Eta expansion of arguments in CorePrep]</span><span>
</span><span id="line-1616"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; ArityOpts -&gt; CpeRhs -&gt; Maybe SafeArityType
ArityOpts -&gt; CpeRhs -&gt; Maybe SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#exprEtaExpandArity"><span class="hs-identifier hs-var">exprEtaExpandArity</span></a></span><span> </span><span class="annot"><span class="annottext">ArityOpts
</span><a href="#local-6989586621682975816"><span class="hs-identifier hs-var">ao</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975810"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1617"></span><span>      </span><span class="annot"><span class="annottext">Maybe SafeArityType
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1618"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682975820"><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682975820"><span class="hs-identifier hs-var">at</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SafeArityType -&gt; Int
</span><a href="GHC.Core.Opt.Arity.html#arityTypeArity"><span class="hs-identifier hs-var">arityTypeArity</span></a></span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682975820"><span class="hs-identifier hs-var">at</span></a></span><span>
</span><span id="line-1619"></span><span>
</span><span id="line-1620"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1621"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; Int
</span><a href="GHC.Core.Opt.Arity.html#exprArity"><span class="hs-identifier hs-var">exprArity</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975810"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="hs-comment">-- this is cheap enough for -O0</span><span>
</span><span id="line-1622"></span><span>
</span><span id="line-1623"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#eta_would_wreck_join"><span class="hs-identifier hs-type">eta_would_wreck_join</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1624"></span><span class="hs-comment">-- ^ Identify the cases where we'd generate invalid `CpeApp`s as described in</span><span>
</span><span id="line-1625"></span><span class="hs-comment">-- Wrinkle (EA1) of Note [Eta expansion of arguments in CorePrep]</span><span>
</span><span id="line-1626"></span><span id="eta_would_wreck_join"><span class="annot"><span class="annottext">eta_would_wreck_join :: CpeRhs -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#eta_would_wreck_join"><span class="hs-identifier hs-var hs-var">eta_would_wreck_join</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621682975822"><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682975822"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621682975823"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975823"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBind -&gt; Bool
</span><a href="GHC.Core.Utils.html#isJoinBind"><span class="hs-identifier hs-var">isJoinBind</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682975822"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#eta_would_wreck_join"><span class="hs-identifier hs-var">eta_would_wreck_join</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975823"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1627"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#eta_would_wreck_join"><span class="hs-identifier hs-var">eta_would_wreck_join</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682975825"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975825"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#eta_would_wreck_join"><span class="hs-identifier hs-var">eta_would_wreck_join</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975825"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1628"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#eta_would_wreck_join"><span class="hs-identifier hs-var">eta_would_wreck_join</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682975826"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975826"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#eta_would_wreck_join"><span class="hs-identifier hs-var">eta_would_wreck_join</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975826"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1629"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#eta_would_wreck_join"><span class="hs-identifier hs-var">eta_would_wreck_join</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682975827"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975827"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#eta_would_wreck_join"><span class="hs-identifier hs-var">eta_would_wreck_join</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975827"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1630"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#eta_would_wreck_join"><span class="hs-identifier hs-var">eta_would_wreck_join</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">InVar
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682975828"><span class="annot"><span class="annottext">[Alt InVar]
</span><a href="#local-6989586621682975828"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CpeRhs -&gt; Bool) -&gt; [CpeRhs] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#eta_would_wreck_join"><span class="hs-identifier hs-var">eta_would_wreck_join</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Alt InVar] -&gt; [CpeRhs]
forall b. [Alt b] -&gt; [Expr b]
</span><a href="GHC.Core.html#rhssOfAlts"><span class="hs-identifier hs-var">rhssOfAlts</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt InVar]
</span><a href="#local-6989586621682975828"><span class="hs-identifier hs-var">alts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1631"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#eta_would_wreck_join"><span class="hs-identifier hs-var">eta_would_wreck_join</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><span class="hs-identifier">_</span></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1632"></span><span>
</span><span id="line-1633"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#maybeSaturate"><span class="hs-identifier hs-type">maybeSaturate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeApp"><span class="hs-identifier hs-type">CpeApp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Tickish.html#CoreTickish"><span class="hs-identifier hs-type">CoreTickish</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a></span><span>
</span><span id="line-1634"></span><span id="maybeSaturate"><span class="annot"><span class="annottext">maybeSaturate :: InVar -&gt; CpeRhs -&gt; Int -&gt; [CoreTickish] -&gt; UniqSM CpeRhs
</span><a href="GHC.CoreToStg.Prep.html#maybeSaturate"><span class="hs-identifier hs-var hs-var">maybeSaturate</span></a></span></span><span> </span><span id="local-6989586621682975832"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975832"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span id="local-6989586621682975833"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975833"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span id="local-6989586621682975834"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682975834"><span class="hs-identifier hs-var">n_args</span></a></span></span><span> </span><span id="local-6989586621682975835"><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682975835"><span class="hs-identifier hs-var">unsat_ticks</span></a></span></span><span>
</span><span id="line-1635"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">InVar -&gt; Bool
</span><a href="GHC.Types.Id.html#hasNoBinding"><span class="hs-identifier hs-var">hasNoBinding</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975832"><span class="hs-identifier hs-var">fn</span></a></span><span>        </span><span class="hs-comment">-- There's no binding</span><span>
</span><span id="line-1636"></span><span>    </span><span class="hs-comment">-- See Note [Eta expansion of hasNoBinding things in CorePrep]</span><span>
</span><span id="line-1637"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; UniqSM CpeRhs
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(CpeRhs -&gt; UniqSM CpeRhs) -&gt; CpeRhs -&gt; UniqSM CpeRhs
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(CpeRhs -&gt; CpeRhs) -&gt; CpeRhs -&gt; CpeRhs
</span><a href="GHC.Core.html#wrapLamBody"><span class="hs-identifier hs-var">wrapLamBody</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682975837"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975837"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(CoreTickish -&gt; CpeRhs -&gt; CpeRhs)
-&gt; CpeRhs -&gt; [CoreTickish] -&gt; CpeRhs
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; CpeRhs -&gt; CpeRhs
</span><a href="GHC.Core.Utils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975837"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682975835"><span class="hs-identifier hs-var">unsat_ticks</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975838"><span class="hs-identifier hs-var">sat_expr</span></a></span><span>
</span><span id="line-1638"></span><span>
</span><span id="line-1639"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682975839"><span class="hs-identifier hs-var">mark_arity</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-comment">-- A call-by-value function. See Note [CBV Function Ids]</span><span>
</span><span id="line-1640"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682975840"><span class="hs-identifier hs-var">applied_marks</span></a></span><span>
</span><span id="line-1641"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; UniqSM CpeRhs -&gt; UniqSM CpeRhs
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span>
</span><span id="line-1642"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InVar -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975832"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- See Note [Do not eta-expand join points]</span><span>
</span><span id="line-1643"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">InVar -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975832"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;expr:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975833"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;n_args:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682975834"><span class="hs-identifier hs-var">n_args</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-1644"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;marks:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe [CbvMark] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InVar -&gt; Maybe [CbvMark]
</span><a href="GHC.Types.Id.html#idCbvMarks_maybe"><span class="hs-identifier hs-var">idCbvMarks_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975832"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-1645"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;join_arity&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">JoinPointHood -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InVar -&gt; JoinPointHood
</span><a href="GHC.Types.Id.html#idJoinPointHood"><span class="hs-identifier hs-var">idJoinPointHood</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975832"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-1646"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;fn_arity&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682975843"><span class="hs-identifier hs-var">fn_arity</span></a></span><span>
</span><span id="line-1647"></span><span>       </span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(UniqSM CpeRhs -&gt; UniqSM CpeRhs) -&gt; UniqSM CpeRhs -&gt; UniqSM CpeRhs
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1648"></span><span>    </span><span class="hs-comment">-- pprTrace &quot;maybeSat&quot;</span><span>
</span><span id="line-1649"></span><span>    </span><span class="hs-comment">--   ( ppr fn $$ text &quot;expr:&quot; &lt;+&gt; ppr expr $$ text &quot;n_args:&quot; &lt;+&gt; ppr n_args $$</span><span>
</span><span id="line-1650"></span><span>    </span><span class="hs-comment">--       text &quot;marks:&quot; &lt;+&gt; ppr (idCbvMarks_maybe fn) $$</span><span>
</span><span id="line-1651"></span><span>    </span><span class="hs-comment">--       text &quot;join_arity&quot; &lt;+&gt; ppr (isJoinId_maybe fn) $$</span><span>
</span><span id="line-1652"></span><span>    </span><span class="hs-comment">--       text &quot;fn_arity&quot; &lt;+&gt; ppr fn_arity $$</span><span>
</span><span id="line-1653"></span><span>    </span><span class="hs-comment">--       text &quot;excess_arity&quot; &lt;+&gt; ppr excess_arity $$</span><span>
</span><span id="line-1654"></span><span>    </span><span class="hs-comment">--       text &quot;mark_arity&quot; &lt;+&gt; ppr mark_arity</span><span>
</span><span id="line-1655"></span><span>    </span><span class="hs-comment">--    ) $</span><span>
</span><span id="line-1656"></span><span>    </span><span class="annot"><span class="annottext">CpeRhs -&gt; UniqSM CpeRhs
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975838"><span class="hs-identifier hs-var">sat_expr</span></a></span><span>
</span><span id="line-1657"></span><span>
</span><span id="line-1658"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1659"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; UniqSM CpeRhs -&gt; UniqSM CpeRhs
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreTickish] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682975835"><span class="hs-identifier hs-var">unsat_ticks</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(UniqSM CpeRhs -&gt; UniqSM CpeRhs) -&gt; UniqSM CpeRhs -&gt; UniqSM CpeRhs
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1660"></span><span>    </span><span class="annot"><span class="annottext">CpeRhs -&gt; UniqSM CpeRhs
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975833"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-1661"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1662"></span><span>    </span><span id="local-6989586621682975839"><span class="annot"><span class="annottext">mark_arity :: Int
</span><a href="#local-6989586621682975839"><span class="hs-identifier hs-var hs-var">mark_arity</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InVar -&gt; Int
</span><a href="GHC.Types.Id.html#idCbvMarkArity"><span class="hs-identifier hs-var">idCbvMarkArity</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975832"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-1663"></span><span>    </span><span id="local-6989586621682975843"><span class="annot"><span class="annottext">fn_arity :: Int
</span><a href="#local-6989586621682975843"><span class="hs-identifier hs-var hs-var">fn_arity</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InVar -&gt; Int
</span><a href="GHC.Types.Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975832"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-1664"></span><span>    </span><span id="local-6989586621682975845"><span class="annot"><span class="annottext">excess_arity :: Int
</span><a href="#local-6989586621682975845"><span class="hs-identifier hs-var hs-var">excess_arity</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682975843"><span class="hs-identifier hs-var">fn_arity</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682975839"><span class="hs-identifier hs-var">mark_arity</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682975834"><span class="hs-identifier hs-var">n_args</span></a></span><span>
</span><span id="line-1665"></span><span>    </span><span id="local-6989586621682975838"><span class="annot"><span class="annottext">sat_expr :: CpeRhs
</span><a href="#local-6989586621682975838"><span class="hs-identifier hs-var hs-var">sat_expr</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CpeRhs -&gt; CpeRhs
</span><a href="GHC.CoreToStg.Prep.html#cpeEtaExpand"><span class="hs-identifier hs-var">cpeEtaExpand</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682975845"><span class="hs-identifier hs-var">excess_arity</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975833"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-1666"></span><span>    </span><span id="local-6989586621682975840"><span class="annot"><span class="annottext">applied_marks :: Bool
</span><a href="#local-6989586621682975840"><span class="hs-identifier hs-var hs-var">applied_marks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682975834"><span class="hs-identifier hs-var">n_args</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CbvMark] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">([CbvMark] -&gt; Int)
-&gt; (Maybe [CbvMark] -&gt; [CbvMark]) -&gt; Maybe [CbvMark] -&gt; Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(CbvMark -&gt; Bool) -&gt; [CbvMark] -&gt; [CbvMark]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">dropWhile</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; (CbvMark -&gt; Bool) -&gt; CbvMark -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">CbvMark -&gt; Bool
</span><a href="GHC.Types.Basic.html#isMarkedCbv"><span class="hs-identifier hs-var">isMarkedCbv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([CbvMark] -&gt; [CbvMark])
-&gt; (Maybe [CbvMark] -&gt; [CbvMark]) -&gt; Maybe [CbvMark] -&gt; [CbvMark]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span>
</span><span id="line-1667"></span><span>                               </span><span class="annot"><span class="annottext">[CbvMark] -&gt; [CbvMark]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">([CbvMark] -&gt; [CbvMark])
-&gt; (Maybe [CbvMark] -&gt; [CbvMark]) -&gt; Maybe [CbvMark] -&gt; [CbvMark]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe [CbvMark] -&gt; [CbvMark]
forall a. HasDebugCallStack =&gt; String -&gt; Maybe a -&gt; a
</span><a href="GHC.Data.Maybe.html#expectJust"><span class="hs-identifier hs-var">expectJust</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;maybeSaturate&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe [CbvMark] -&gt; Int) -&gt; Maybe [CbvMark] -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InVar -&gt; Maybe [CbvMark]
</span><a href="GHC.Types.Id.html#idCbvMarks_maybe"><span class="hs-identifier hs-var">idCbvMarks_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975832"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1668"></span><span>    </span><span class="hs-comment">-- For join points we never eta-expand (See Note [Do not eta-expand join points])</span><span>
</span><span id="line-1669"></span><span>    </span><span class="hs-comment">-- so we assert all arguments that need to be passed cbv are visible so that the</span><span>
</span><span id="line-1670"></span><span>    </span><span class="hs-comment">-- backend can evalaute them if required..</span><span>
</span><span id="line-1671"></span><span>
</span><span id="line-1672"></span><span class="hs-comment">{- Note [Eta expansion]
~~~~~~~~~~~~~~~~~~~~~~~
Eta expand to match the arity claimed by the binder Remember,
CorePrep must not change arity

Eta expansion might not have happened already, because it is done by
the simplifier only when there at least one lambda already.

NB1:we could refrain when the RHS is trivial (which can happen
    for exported things).  This would reduce the amount of code
    generated (a little) and make things a little worse for
    code compiled without -O.  The case in point is data constructor
    wrappers.

NB2: we have to be careful that the result of etaExpand doesn't
   invalidate any of the assumptions that CorePrep is attempting
   to establish.  One possible cause is eta expanding inside of
   an SCC note - we're now careful in etaExpand to make sure the
   SCC is pushed inside any new lambdas that are generated.

Note [Eta expansion of hasNoBinding things in CorePrep]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
maybeSaturate deals with eta expanding to saturate things that can't deal
with unsaturated applications (identified by 'hasNoBinding', currently
foreign calls, unboxed tuple/sum constructors, and representation-polymorphic
primitives such as 'coerce' and 'unsafeCoerce#').

Historical Note: Note that eta expansion in CorePrep used to be very fragile
due to the &quot;prediction&quot; of CAFfyness that we used to make during tidying.  We
previously saturated primop applications here as well but due to this
fragility (see #16846) we now deal with this another way, as described in
Note [Primop wrappers] in GHC.Builtin.PrimOps.

Note [Eta expansion and the CorePrep invariants]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It turns out to be much much easier to do eta expansion
*after* the main CorePrep stuff.  But that places constraints
on the eta expander: given a CpeRhs, it must return a CpeRhs.

For example here is what we do not want:
                f = /\a -&gt; g (h 3)      -- h has arity 2
After ANFing we get
                f = /\a -&gt; let s = h 3 in g s
and now we do NOT want eta expansion to give
                f = /\a -&gt; \ y -&gt; (let s = h 3 in g s) y

Instead GHC.Core.Opt.Arity.etaExpand gives
                f = /\a -&gt; \y -&gt; let s = h 3 in g s y

Note [Eta expansion of arguments in CorePrep]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose `g = \x y. blah` and consider the expression `f (g x)`; we ANFise to

  let t = g x
  in f t

We really don't want that `t` to be a thunk! That just wastes runtime, updating
a thunk with a PAP etc. The code generator could in principle allocate a PAP,
but in fact it does not know how to do that -- it's easier just to eta-expand:

  let t = \y. g x y
  in f t

To what arity should we eta-expand the argument? `cpeArg` uses two strategies,
governed by the presence of `-fdo-clever-arg-eta-expansion` (implied by -O):

  1. Cheap, with -O0: just use `exprArity`.
  2. More clever but expensive, with -O1 -O2: use `exprEtaExpandArity`,
     same function the Simplifier uses to eta expand RHSs and lambda bodies.

The only reason for using (1) rather than (2) is to keep compile times down.
Using (2) in -O0 bumped up compiler allocations by 2-3% in tests T4801 and
T5321*. However, Plan (2) catches cases that (1) misses.
For example (#23083, assuming -fno-pedantic-bottoms):

  let t = case z of __DEFAULT -&gt; g x
  in f t

to

  let t = \y -&gt; case z of __DEFAULT -&gt; g x y
  in f t

Note that there is a missed opportunity in eta expanding `t` earlier, in the
Simplifier: It would allow us to inline `g`, potentially enabling further
simplification. But then we could have inlined `g` into the PAP to begin with,
and that is discussed in #23150; hence we needn't worry about that in CorePrep.

There is a nasty Wrinkle:

(EA1) When eta expanding an argument headed by a join point, we might get
      &quot;crap&quot;, as Note [Eta expansion for join points] in GHC.Core.Opt.Arity puts
      it.  This crap means the output does not conform to the syntax in
      Note [CorePrep invariants], which then makes later passes crash (#25033).
      Consider

        f (join j x = rhs in ...(j 1)...(j 2)...)

      where the argument has arity 1. We might be tempted to eta expand, to

        f (\y -&gt; (join j x = rhs in ...(j 1)...(j 2)...) y)

      Why hasn't the App to `y` been pushed into the join point? That's exactly
      the crap of Note [Eta expansion for join points], so we have to put up
      with it here.
      In our case, (join j x = rhs in ...(j 1)...(j 2)...) is not a valid
      `CpeApp` (see Note [CorePrep invariants]) and we'd get a crash in the App
      case of `coreToStgExpr`.

      Hence, in `eta_would_wreck_join`, we check for the cases where an
      intervening join point binding in the tail context of the argument would
      make eta-expansion break Note [CorePrep invariants], in which
      case we abstain from eta expansion.

      This scenario occurs rarely; hence it's OK to generate sub-optimal code.
      The alternative would be to fix Note [Eta expansion for join points], but
      that's quite challenging due to unfoldings of (recursive) join points.

      `eta_would_wreck_join` sees if there are any join points, like `j` above
      that would be messed up.   It must look inside lambdas (#25033); consider
             f (\x. join j y = ... in ...(j 1)...(j 3)...)
      We can't eta expand that `\x` any more than we could if the join was at
      the top.  (And when there's a lambda, we don't have a thunk anyway.)

(EA2) In cpeArgArity, if float_decision=FloatNone the `arg` will look like
           let &lt;binds&gt; in rhs
      where &lt;binds&gt; is non-empty and can't be floated out of a lazy context (see
      `wantFloatLocal`). So we can't eta-expand it anyway, so we can return 0
      forthwith.  Without this short-cut we will call exprEtaExpandArity on the
      `arg`, and &lt;binds&gt; might be enormous. exprEtaExpandArity be very expensive
      on this: it uses arityType, and may look at &lt;binds&gt;.

      On the other hand, if float_decision = FloatAll, there will be no
      let-bindings around 'arg'; they will have floated out.  So
      exprEtaExpandArity is cheap.

      This can make a huge difference on deeply nested expressions like
         f (f (f (f (f  ...))))
      #24471 is a good example, where Prep took 25% of compile time!
-}</span><span>
</span><span id="line-1812"></span><span>
</span><span id="line-1813"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeEtaExpand"><span class="hs-identifier hs-type">cpeEtaExpand</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a></span><span>
</span><span id="line-1814"></span><span id="cpeEtaExpand"><span class="annot"><span class="annottext">cpeEtaExpand :: Int -&gt; CpeRhs -&gt; CpeRhs
</span><a href="GHC.CoreToStg.Prep.html#cpeEtaExpand"><span class="hs-identifier hs-var hs-var">cpeEtaExpand</span></a></span></span><span> </span><span id="local-6989586621682975852"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682975852"><span class="hs-identifier hs-var">arity</span></a></span></span><span> </span><span id="local-6989586621682975853"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975853"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-1815"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682975852"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975853"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-1816"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CpeRhs -&gt; CpeRhs
</span><a href="GHC.Core.Opt.Arity.html#etaExpand"><span class="hs-identifier hs-var">etaExpand</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682975852"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975853"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-1817"></span><span>
</span><span id="line-1818"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Floats
*                                                                      *
************************************************************************

Note [Pin demand info on floats]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We pin demand info on floated lets, so that we can see the one-shot thunks.
For example,
  f (g x)
where `f` uses its argument at least once, creates a Float for `y = g x` and we
should better pin appropriate demand info on `y`.

Note [Flatten case-binds]
~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have the following call, where f is strict:
   f (case x of DEFAULT -&gt; blah)
(For the moment, ignore the fact that the Simplifier will have floated that
`case` out because `f` is strict.)
In Prep, `cpeArg` will ANF-ise that argument, and we'll get a `FloatingBind`

    Float (a = case x of y { DEFAULT -&gt; blah }) CaseBound top_lvl

with the call `f a`.  When we wrap that `Float` we will get

   case (case x of y { DEFAULT -&gt; blah }) of a { DEFAULT -&gt; f a }

which is a bit silly. Actually the rest of the back end can cope with nested
cases like this, but it is harder to read and we'd prefer the more direct:

   case x of y { DEFAULT -&gt;
   case blah of a { DEFAULT -&gt; f a }}

This is easy to avoid: turn that

   case x of DEFAULT -&gt; blah

into a FloatingBind of its own.  This is easily done in the Case
equation for `cpsRhsE`.  Then our example will generate /two/ floats:

    Float (y = x)    CaseBound top_lvl
    Float (a = blah) CaseBound top_lvl

and we'll end up with nested cases.

Of course, the Simplifier never leaves us with an argument like this, but we
/can/ see

  data T a = T !a
  ... case seq# (case x of y { __DEFAULT -&gt; T y }) s of (# s', x' #) -&gt; rhs

and the above footwork in cpsRhsE avoids generating a nested case.


Note [Speculative evaluation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Since call-by-value is much cheaper than call-by-need, we case-bind arguments
that are either

  1. Strictly evaluated anyway, according to the DmdSig of the callee, or
  2. ok-for-spec, according to 'exprOkForSpeculation'.
     This includes DFuns `$fEqList a`, for example.
     (Could identify more in the future; see reference to !1866 below.)

While (1) is a no-brainer and always beneficial, (2) is a bit
more subtle, as the careful haddock for 'exprOkForSpeculation'
points out. Still, by case-binding the argument we don't need
to allocate a thunk for it, whose closure must be retained as
long as the callee might evaluate it. And if it is evaluated on
most code paths anyway, we get to turn the unknown eval in the
callee into a known call at the call site.

Very Nasty Wrinkle

We must be very careful not to speculate recursive calls!  Doing so
might well change termination behavior.

That comes up in practice for DFuns, which are considered ok-for-spec,
because they always immediately return a constructor.
See Note [NON-BOTTOM-DICTS invariant] in GHC.Core.

But not so if you speculate the recursive call, as #20836 shows:

  class Foo m =&gt; Foo m where
    runFoo :: m a -&gt; m a
  newtype Trans m a = Trans { runTrans :: m a }
  instance Monad m =&gt; Foo (Trans m) where
    runFoo = id

(NB: class Foo m =&gt; Foo m` looks weird and needs -XUndecidableSuperClasses. The
example in #20836 is more compelling, but boils down to the same thing.)
This program compiles to the following DFun for the `Trans` instance:

  Rec {
  $fFooTrans
    = \ @m $dMonad -&gt; C:Foo ($fFooTrans $dMonad) (\ @a -&gt; id)
  end Rec }

Note that the DFun immediately terminates and produces a dictionary, just
like DFuns ought to, but it calls itself recursively to produce the `Foo m`
dictionary. But alas, if we treat `$fFooTrans` as always-terminating, so
that we can speculate its calls, and hence use call-by-value, we get:

  $fFooTrans
    = \ @m $dMonad -&gt; case ($fFooTrans $dMonad) of sc -&gt;
                      C:Foo sc (\ @a -&gt; id)

and that's an infinite loop!
Note that this bad-ness only happens in `$fFooTrans`'s own RHS. In the
*body* of the letrec, it's absolutely fine to use call-by-value on
`foo ($fFooTrans d)`.

Our solution is this: we track in cpe_rec_ids the set of enclosing
recursively-bound Ids, the RHSs of which we are currently transforming and then
in 'exprOkForSpecEval' (a special entry point to 'exprOkForSpeculation',
basically) we'll say that any binder in this set is not ok-for-spec.

Note if we have a letrec group `Rec { f1 = rhs1; ...; fn = rhsn }`, and we
prep up `rhs1`, we have to include not only `f1`, but all binders of the group
`f1..fn` in this set, otherwise our fix is not robust wrt. mutual recursive
DFuns.

NB: If at some point we decide to have a termination analysis for general
functions (#8655, !1866), we need to take similar precautions for (guarded)
recursive functions:

  repeat x = x : repeat x

Same problem here: As written, repeat evaluates rapidly to WHNF. So `repeat x`
is a cheap call that we are willing to speculate, but *not* in repeat's RHS.
Fortunately, pce_rec_ids already has all the information we need in that case.

The problem is very similar to Note [Eta reduction in recursive RHSs].
Here as well as there it is *unsound* to change the termination properties
of the very function whose termination properties we are exploiting.

It is also similar to Note [Do not strictify a DFun's parameter dictionaries],
where marking recursive DFuns (of undecidable *instances*) strict in dictionary
*parameters* leads to quite the same change in termination as above.

Note [BindInfo and FloatInfo]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The `BindInfo` of a `Float` describes whether it will be case-bound or
let-bound:

  * `LetBound`: A let binding `let x = rhs in ...`, can be Rec or NonRec.
  * `CaseBound`: A case binding `case rhs of x -&gt; { __DEFAULT -&gt; .. }`.
                 (So always NonRec.)
                 Some case-bound things (string literals, lifted bindings)
                 can float to top-level (but not all), hence it is similar
                 to, but not the same as `StrictContextFloatable :: FloatInfo`
                 described below.

This info is used in `wrapBinds` to pick the corresponding binding form.

We want to case-bind iff the binding is (non-recursive, and) either

  * ok-for-spec-eval (and perhaps lifted, see Note [Speculative evaluation]), or
  * unlifted, or
  * strictly used

The `FloatInfo` of a `Float` describes how far it can float without
(a) violating Core invariants and (b) changing semantics.

  * Any binding is at least `StrictContextFloatable`, meaning we may float it
    out of a strict context such as `f &lt;&gt;` where `f` is strict.
    We may never float out of a Case alternative `case e of p -&gt; &lt;&gt;`, though,
    even if we made sure that `p` does not capture any variables of the float,
    because that risks sequencing guarantees of Note [seq# magic].

  * A binding is `LazyContextFloatable` if we may float it out of a lazy context
    such as `let x = &lt;&gt; in Just x`.
    Counterexample: A strict or unlifted binding that isn't ok-for-spec-eval
                    such as `case divInt# x y of r -&gt; { __DEFAULT -&gt; I# r }`.
                    Here, we may not foat out the strict `r = divInt# x y`.

  * A binding is `TopLvlFloatable` if it is `LazyContextFloatable` and also can
    be bound at the top level.
    Counterexample: A strict or unlifted binding (ok-for-spec-eval or not)
                    such as `case x +# y of r -&gt; { __DEFAULT -&gt; I# r }`.

This meaning of &quot;at least&quot; is encoded in `floatsAtLeastAsFarAs`.
Note that today, `LetBound` implies `TopLvlFloatable`, so we could make do with
the the following enum (check `mkNonRecFloat` for whether this is up to date):

   LetBoundTopLvlFloatable          (lifted or boxed values)
  CaseBoundTopLvlFloatable          (strings, ok-for-spec-eval and lifted)
  CaseBoundLazyContextFloatable     (ok-for-spec-eval and unlifted)
  CaseBoundStrictContextFloatable   (not ok-for-spec-eval and unlifted)

Although there is redundancy in the current encoding, SG thinks it is cleaner
conceptually.

See also Note [Floats and FloatDecision] for how we maintain whole groups of
floats and how far they go.

Note [Controlling Speculative Evaluation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Most of the time, speculative evaluation has a positive effect on performance,
but we have found a case where speculative evaluation of dictionary functions
leads to a performance regression #25284.

Therefore we have some flags to control it. See the optimization section in
the User's Guide for the description of these flags and when to use them.

Note [Floats and FloatDecision]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We have a special datatype `Floats` for modelling a telescope of `FloatingBind`
and caching its &quot;maximum&quot; `FloatInfo`, according to `floatsAtLeastAsFarAs`
(see Note [BindInfo and FloatInfo] for the ordering).
There are several operations for creating and combining `Floats` that maintain
scoping and the cached `FloatInfo`.

When deciding whether we want to float out a `Floats` out of a binding context
such as `let x = &lt;&gt; in e` (let), `f &lt;&gt;` (app), or `x = &lt;&gt;; ...` (top-level),
we consult the cached `FloatInfo` of the `Floats`:

  * If we want to float to the top-level (`x = &lt;&gt;; ...`), we check whether
    we may float-at-least-as-far-as `TopLvlFloatable`, in which case we
    respond with `FloatAll :: FloatDecision`; otherwise we say `FloatNone`.
  * If we want to float locally (let or app), then the floating decision is
    described in Note [wantFloatLocal].

`executeFloatDecision` is then used to act on the particular `FloatDecision`.
-}</span><span>
</span><span id="line-2046"></span><span>
</span><span id="line-2047"></span><span class="hs-comment">-- See Note [BindInfo and FloatInfo]</span><span>
</span><span id="line-2048"></span><span class="hs-keyword">data</span><span> </span><span id="BindInfo"><span class="annot"><a href="GHC.CoreToStg.Prep.html#BindInfo"><span class="hs-identifier hs-var">BindInfo</span></a></span></span><span>
</span><span id="line-2049"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="CaseBound"><span class="annot"><a href="GHC.CoreToStg.Prep.html#CaseBound"><span class="hs-identifier hs-var">CaseBound</span></a></span></span><span> </span><span class="annot"><span class="hs-comment">-- ^ A strict binding</span></span><span>
</span><span id="line-2050"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="LetBound"><span class="annot"><a href="GHC.CoreToStg.Prep.html#LetBound"><span class="hs-identifier hs-var">LetBound</span></a></span></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ A lazy or value binding</span></span><span>
</span><span id="line-2051"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621682975856"><span id="local-6989586621682975861"><span class="annot"><span class="annottext">BindInfo -&gt; BindInfo -&gt; Bool
(BindInfo -&gt; BindInfo -&gt; Bool)
-&gt; (BindInfo -&gt; BindInfo -&gt; Bool) -&gt; Eq BindInfo
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: BindInfo -&gt; BindInfo -&gt; Bool
== :: BindInfo -&gt; BindInfo -&gt; Bool
$c/= :: BindInfo -&gt; BindInfo -&gt; Bool
/= :: BindInfo -&gt; BindInfo -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span>
</span><span id="line-2052"></span><span>
</span><span id="line-2053"></span><span class="hs-comment">-- See Note [BindInfo and FloatInfo]</span><span>
</span><span id="line-2054"></span><span class="hs-keyword">data</span><span> </span><span id="FloatInfo"><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatInfo"><span class="hs-identifier hs-var">FloatInfo</span></a></span></span><span>
</span><span id="line-2055"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="TopLvlFloatable"><span class="annot"><a href="GHC.CoreToStg.Prep.html#TopLvlFloatable"><span class="hs-identifier hs-var">TopLvlFloatable</span></a></span></span><span>
</span><span id="line-2056"></span><span>  </span><span class="hs-comment">-- ^ Anything that can be bound at top-level, such as arbitrary lifted</span><span>
</span><span id="line-2057"></span><span>  </span><span class="hs-comment">-- bindings or anything that responds True to `exprIsHNF`, such as literals or</span><span>
</span><span id="line-2058"></span><span>  </span><span class="hs-comment">-- saturated DataCon apps where unlifted or strict args are values.</span><span>
</span><span id="line-2059"></span><span>
</span><span id="line-2060"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="LazyContextFloatable"><span class="annot"><a href="GHC.CoreToStg.Prep.html#LazyContextFloatable"><span class="hs-identifier hs-var">LazyContextFloatable</span></a></span></span><span>
</span><span id="line-2061"></span><span>  </span><span class="hs-comment">-- ^ Anything that can be floated out of a lazy context.</span><span>
</span><span id="line-2062"></span><span>  </span><span class="hs-comment">-- In addition to any 'TopLvlFloatable' things, this includes (unlifted)</span><span>
</span><span id="line-2063"></span><span>  </span><span class="hs-comment">-- bindings that are ok-for-spec that we intend to case-bind.</span><span>
</span><span id="line-2064"></span><span>
</span><span id="line-2065"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="StrictContextFloatable"><span class="annot"><a href="GHC.CoreToStg.Prep.html#StrictContextFloatable"><span class="hs-identifier hs-var">StrictContextFloatable</span></a></span></span><span>
</span><span id="line-2066"></span><span>  </span><span class="hs-comment">-- ^ Anything that can be floated out of a strict evaluation context.</span><span>
</span><span id="line-2067"></span><span>  </span><span class="hs-comment">-- That is possible for all bindings; this is the Top element of 'FloatInfo'.</span><span>
</span><span id="line-2068"></span><span>
</span><span id="line-2069"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621682975867"><span id="local-6989586621682975871"><span class="annot"><span class="annottext">FloatInfo -&gt; FloatInfo -&gt; Bool
(FloatInfo -&gt; FloatInfo -&gt; Bool)
-&gt; (FloatInfo -&gt; FloatInfo -&gt; Bool) -&gt; Eq FloatInfo
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: FloatInfo -&gt; FloatInfo -&gt; Bool
== :: FloatInfo -&gt; FloatInfo -&gt; Bool
$c/= :: FloatInfo -&gt; FloatInfo -&gt; Bool
/= :: FloatInfo -&gt; FloatInfo -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span>
</span><span id="line-2070"></span><span>
</span><span id="line-2071"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#BindInfo"><span class="hs-identifier hs-type">BindInfo</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-2072"></span><span>  </span><span id="local-6989586621682975877"><span class="annot"><span class="annottext">ppr :: BindInfo -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="annot"><span class="annottext">BindInfo
</span><a href="GHC.CoreToStg.Prep.html#CaseBound"><span class="hs-identifier hs-var">CaseBound</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Case&quot;</span></span><span>
</span><span id="line-2073"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">BindInfo
</span><a href="GHC.CoreToStg.Prep.html#LetBound"><span class="hs-identifier hs-var">LetBound</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Let&quot;</span></span><span>
</span><span id="line-2074"></span><span>
</span><span id="line-2075"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatInfo"><span class="hs-identifier hs-type">FloatInfo</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-2076"></span><span>  </span><span id="local-6989586621682975883"><span class="annot"><span class="annottext">ppr :: FloatInfo -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#TopLvlFloatable"><span class="hs-identifier hs-var">TopLvlFloatable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;top-lvl&quot;</span></span><span>
</span><span id="line-2077"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#LazyContextFloatable"><span class="hs-identifier hs-var">LazyContextFloatable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;lzy-ctx&quot;</span></span><span>
</span><span id="line-2078"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#StrictContextFloatable"><span class="hs-identifier hs-var">StrictContextFloatable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;str-ctx&quot;</span></span><span>
</span><span id="line-2079"></span><span>
</span><span id="line-2080"></span><span class="hs-comment">-- See Note [Floating in CorePrep]</span><span>
</span><span id="line-2081"></span><span class="hs-comment">-- and Note [BindInfo and FloatInfo]</span><span>
</span><span id="line-2082"></span><span class="hs-keyword">data</span><span> </span><span id="FloatingBind"><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatingBind"><span class="hs-identifier hs-var">FloatingBind</span></a></span></span><span>
</span><span id="line-2083"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="Float"><span class="annot"><a href="GHC.CoreToStg.Prep.html#Float"><span class="hs-identifier hs-var">Float</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#BindInfo"><span class="hs-identifier hs-type">BindInfo</span></a></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatInfo"><span class="hs-identifier hs-type">FloatInfo</span></a></span><span>    </span><span class="hs-comment">-- Never a join-point binding</span><span>
</span><span id="line-2084"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="UnsafeEqualityCase"><span class="annot"><a href="GHC.CoreToStg.Prep.html#UnsafeEqualityCase"><span class="hs-identifier hs-var">UnsafeEqualityCase</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2085"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="FloatTick"><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatTick"><span class="hs-identifier hs-var">FloatTick</span></a></span></span><span> </span><span class="annot"><a href="GHC.Types.Tickish.html#CoreTickish"><span class="hs-identifier hs-type">CoreTickish</span></a></span><span>
</span><span id="line-2086"></span><span>
</span><span id="line-2087"></span><span class="hs-comment">-- See Note [Floats and FloatDecision]</span><span>
</span><span id="line-2088"></span><span class="hs-keyword">data</span><span> </span><span id="Floats"><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-var">Floats</span></a></span></span><span>
</span><span id="line-2089"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="Floats"><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-var">Floats</span></a></span></span><span>
</span><span id="line-2090"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="fs_info"><span class="annot"><span class="annottext">Floats -&gt; FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#fs_info"><span class="hs-identifier hs-var hs-var">fs_info</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatInfo"><span class="hs-identifier hs-type">FloatInfo</span></a></span><span>
</span><span id="line-2091"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="fs_binds"><span class="annot"><span class="annottext">Floats -&gt; OrdList FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#fs_binds"><span class="hs-identifier hs-var hs-var">fs_binds</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.OrdList.html#OrdList"><span class="hs-identifier hs-type">OrdList</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatingBind"><span class="hs-identifier hs-type">FloatingBind</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2092"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-2093"></span><span>
</span><span id="line-2094"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatingBind"><span class="hs-identifier hs-type">FloatingBind</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-2095"></span><span>  </span><span id="local-6989586621682975910"><span class="annot"><span class="annottext">ppr :: FloatingBind -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Float"><span class="hs-identifier hs-type">Float</span></a></span><span> </span><span id="local-6989586621682975911"><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682975911"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682975912"><span class="annot"><span class="annottext">BindInfo
</span><a href="#local-6989586621682975912"><span class="hs-identifier hs-var">bi</span></a></span></span><span> </span><span id="local-6989586621682975913"><span class="annot"><span class="annottext">FloatInfo
</span><a href="#local-6989586621682975913"><span class="hs-identifier hs-var">fi</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BindInfo -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">BindInfo
</span><a href="#local-6989586621682975912"><span class="hs-identifier hs-var">bi</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">FloatInfo -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="#local-6989586621682975913"><span class="hs-identifier hs-var">fi</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682975911"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-2096"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatTick"><span class="hs-identifier hs-type">FloatTick</span></a></span><span> </span><span id="local-6989586621682975914"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682975914"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682975914"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-2097"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#UnsafeEqualityCase"><span class="hs-identifier hs-type">UnsafeEqualityCase</span></a></span><span> </span><span id="local-6989586621682975915"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975915"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621682975916"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975916"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682975917"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682975917"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621682975918"><span class="annot"><span class="annottext">[InVar]
</span><a href="#local-6989586621682975918"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;case&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975915"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-2098"></span><span>                                </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;of&quot;</span></span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">InVar -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975916"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;@&quot;</span></span><span>
</span><span id="line-2099"></span><span>                                </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[InVar]
</span><a href="#local-6989586621682975918"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2100"></span><span>                                   </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">AltCon -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682975917"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-2101"></span><span>                                   </span><span class="annot"><span class="annottext">[InVar]
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AltCon -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682975917"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[InVar] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[InVar]
</span><a href="#local-6989586621682975918"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2102"></span><span>
</span><span id="line-2103"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-2104"></span><span>  </span><span id="local-6989586621682975932"><span class="annot"><span class="annottext">ppr :: Floats -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span id="local-6989586621682975933"><span class="annot"><span class="annottext">FloatInfo
</span><a href="#local-6989586621682975933"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span id="local-6989586621682975934"><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621682975934"><span class="hs-identifier hs-var">binds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Floats&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#brackets"><span class="hs-identifier hs-var">brackets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FloatInfo -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="#local-6989586621682975933"><span class="hs-identifier hs-var">info</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#braces"><span class="hs-identifier hs-var">braces</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OrdList FloatingBind -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621682975934"><span class="hs-identifier hs-var">binds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2105"></span><span>
</span><span id="line-2106"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#lubFloatInfo"><span class="hs-identifier hs-type">lubFloatInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatInfo"><span class="hs-identifier hs-type">FloatInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatInfo"><span class="hs-identifier hs-type">FloatInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatInfo"><span class="hs-identifier hs-type">FloatInfo</span></a></span><span>
</span><span id="line-2107"></span><span id="lubFloatInfo"><span class="annot"><span class="annottext">lubFloatInfo :: FloatInfo -&gt; FloatInfo -&gt; FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#lubFloatInfo"><span class="hs-identifier hs-var hs-var">lubFloatInfo</span></a></span></span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#StrictContextFloatable"><span class="hs-identifier hs-var">StrictContextFloatable</span></a></span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><span class="hs-identifier">_</span></span><span>                      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#StrictContextFloatable"><span class="hs-identifier hs-var">StrictContextFloatable</span></a></span><span>
</span><span id="line-2108"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#lubFloatInfo"><span class="hs-identifier hs-var">lubFloatInfo</span></a></span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><span class="hs-identifier">_</span></span><span>                      </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#StrictContextFloatable"><span class="hs-identifier hs-var">StrictContextFloatable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#StrictContextFloatable"><span class="hs-identifier hs-var">StrictContextFloatable</span></a></span><span>
</span><span id="line-2109"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#lubFloatInfo"><span class="hs-identifier hs-var">lubFloatInfo</span></a></span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#LazyContextFloatable"><span class="hs-identifier hs-var">LazyContextFloatable</span></a></span><span>   </span><span class="annot"><span class="annottext">FloatInfo
</span><span class="hs-identifier">_</span></span><span>                      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#LazyContextFloatable"><span class="hs-identifier hs-var">LazyContextFloatable</span></a></span><span>
</span><span id="line-2110"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#lubFloatInfo"><span class="hs-identifier hs-var">lubFloatInfo</span></a></span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><span class="hs-identifier">_</span></span><span>                      </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#LazyContextFloatable"><span class="hs-identifier hs-var">LazyContextFloatable</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#LazyContextFloatable"><span class="hs-identifier hs-var">LazyContextFloatable</span></a></span><span>
</span><span id="line-2111"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#lubFloatInfo"><span class="hs-identifier hs-var">lubFloatInfo</span></a></span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#TopLvlFloatable"><span class="hs-identifier hs-var">TopLvlFloatable</span></a></span><span>        </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#TopLvlFloatable"><span class="hs-identifier hs-var">TopLvlFloatable</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#TopLvlFloatable"><span class="hs-identifier hs-var">TopLvlFloatable</span></a></span><span>
</span><span id="line-2112"></span><span>
</span><span id="line-2113"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#floatsAtLeastAsFarAs"><span class="hs-identifier hs-type">floatsAtLeastAsFarAs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatInfo"><span class="hs-identifier hs-type">FloatInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatInfo"><span class="hs-identifier hs-type">FloatInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-2114"></span><span class="hs-comment">-- See Note [Floats and FloatDecision]</span><span>
</span><span id="line-2115"></span><span id="floatsAtLeastAsFarAs"><span class="annot"><span class="annottext">floatsAtLeastAsFarAs :: FloatInfo -&gt; FloatInfo -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#floatsAtLeastAsFarAs"><span class="hs-identifier hs-var hs-var">floatsAtLeastAsFarAs</span></a></span></span><span> </span><span id="local-6989586621682975937"><span class="annot"><span class="annottext">FloatInfo
</span><a href="#local-6989586621682975937"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621682975938"><span class="annot"><span class="annottext">FloatInfo
</span><a href="#local-6989586621682975938"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="#local-6989586621682975937"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">FloatInfo -&gt; FloatInfo -&gt; FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#lubFloatInfo"><span class="hs-operator hs-var">`lubFloatInfo`</span></a></span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="#local-6989586621682975938"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">FloatInfo -&gt; FloatInfo -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="#local-6989586621682975938"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-2116"></span><span>
</span><span id="line-2117"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-type">emptyFloats</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span>
</span><span id="line-2118"></span><span id="emptyFloats"><span class="annot"><span class="annottext">emptyFloats :: Floats
</span><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-var hs-var">emptyFloats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FloatInfo -&gt; OrdList FloatingBind -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-var">Floats</span></a></span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#TopLvlFloatable"><span class="hs-identifier hs-var">TopLvlFloatable</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind
forall a. OrdList a
</span><a href="GHC.Data.OrdList.html#nilOL"><span class="hs-identifier hs-var">nilOL</span></a></span><span>
</span><span id="line-2119"></span><span>
</span><span id="line-2120"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#isEmptyFloats"><span class="hs-identifier hs-type">isEmptyFloats</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-2121"></span><span id="isEmptyFloats"><span class="annot"><span class="annottext">isEmptyFloats :: Floats -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#isEmptyFloats"><span class="hs-identifier hs-var hs-var">isEmptyFloats</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682975940"><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621682975940"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind -&gt; Bool
forall a. OrdList a -&gt; Bool
</span><a href="GHC.Data.OrdList.html#isNilOL"><span class="hs-identifier hs-var">isNilOL</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621682975940"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-2122"></span><span>
</span><span id="line-2123"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#getFloats"><span class="hs-identifier hs-type">getFloats</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Data.OrdList.html#OrdList"><span class="hs-identifier hs-type">OrdList</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatingBind"><span class="hs-identifier hs-type">FloatingBind</span></a></span><span>
</span><span id="line-2124"></span><span id="getFloats"><span class="annot"><span class="annottext">getFloats :: Floats -&gt; OrdList FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#getFloats"><span class="hs-identifier hs-var hs-var">getFloats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Floats -&gt; OrdList FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#fs_binds"><span class="hs-identifier hs-var">fs_binds</span></a></span><span>
</span><span id="line-2125"></span><span>
</span><span id="line-2126"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#unitFloat"><span class="hs-identifier hs-type">unitFloat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatingBind"><span class="hs-identifier hs-type">FloatingBind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span>
</span><span id="line-2127"></span><span id="unitFloat"><span class="annot"><span class="annottext">unitFloat :: FloatingBind -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#unitFloat"><span class="hs-identifier hs-var hs-var">unitFloat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Floats -&gt; FloatingBind -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#snocFloat"><span class="hs-identifier hs-var">snocFloat</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span>
</span><span id="line-2128"></span><span>
</span><span id="line-2129"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#floatInfo"><span class="hs-identifier hs-type">floatInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatingBind"><span class="hs-identifier hs-type">FloatingBind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatInfo"><span class="hs-identifier hs-type">FloatInfo</span></a></span><span>
</span><span id="line-2130"></span><span id="floatInfo"><span class="annot"><span class="annottext">floatInfo :: FloatingBind -&gt; FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#floatInfo"><span class="hs-identifier hs-var hs-var">floatInfo</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Float"><span class="hs-identifier hs-type">Float</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">BindInfo
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682975943"><span class="annot"><span class="annottext">FloatInfo
</span><a href="#local-6989586621682975943"><span class="hs-identifier hs-var">info</span></a></span></span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="#local-6989586621682975943"><span class="hs-identifier hs-var">info</span></a></span><span>
</span><span id="line-2131"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#floatInfo"><span class="hs-identifier hs-var">floatInfo</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#UnsafeEqualityCase"><span class="hs-identifier hs-type">UnsafeEqualityCase</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#LazyContextFloatable"><span class="hs-identifier hs-var">LazyContextFloatable</span></a></span><span> </span><span class="hs-comment">-- See Note [Floating in CorePrep]</span><span>
</span><span id="line-2132"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#floatInfo"><span class="hs-identifier hs-var">floatInfo</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatTick"><span class="hs-identifier hs-type">FloatTick</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#TopLvlFloatable"><span class="hs-identifier hs-var">TopLvlFloatable</span></a></span><span>      </span><span class="hs-comment">-- We filter these out in cpePair,</span><span>
</span><span id="line-2133"></span><span>                                                      </span><span class="hs-comment">-- see Note [Floating Ticks in CorePrep]</span><span>
</span><span id="line-2134"></span><span>
</span><span id="line-2135"></span><span class="hs-comment">-- | Append a `FloatingBind` `b` to a `Floats` telescope `bs` that may reference any</span><span>
</span><span id="line-2136"></span><span class="hs-comment">-- binding of the 'Floats'.</span><span>
</span><span id="line-2137"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#snocFloat"><span class="hs-identifier hs-type">snocFloat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatingBind"><span class="hs-identifier hs-type">FloatingBind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span>
</span><span id="line-2138"></span><span id="snocFloat"><span class="annot"><span class="annottext">snocFloat :: Floats -&gt; FloatingBind -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#snocFloat"><span class="hs-identifier hs-var hs-var">snocFloat</span></a></span></span><span> </span><span id="local-6989586621682975944"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975944"><span class="hs-identifier hs-var">floats</span></a></span></span><span> </span><span id="local-6989586621682975945"><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621682975945"><span class="hs-identifier hs-var">fb</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2139"></span><span>  </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fs_info :: FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#fs_info"><span class="hs-identifier hs-var">fs_info</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FloatInfo -&gt; FloatInfo -&gt; FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#lubFloatInfo"><span class="hs-identifier hs-var">lubFloatInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats -&gt; FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#fs_info"><span class="hs-identifier hs-var">fs_info</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975944"><span class="hs-identifier hs-var">floats</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FloatingBind -&gt; FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#floatInfo"><span class="hs-identifier hs-var">floatInfo</span></a></span><span> </span><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621682975945"><span class="hs-identifier hs-var">fb</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2140"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fs_binds :: OrdList FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#fs_binds"><span class="hs-identifier hs-var">fs_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Floats -&gt; OrdList FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#fs_binds"><span class="hs-identifier hs-var">fs_binds</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975944"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind -&gt; FloatingBind -&gt; OrdList FloatingBind
forall a. OrdList a -&gt; a -&gt; OrdList a
</span><a href="GHC.Data.OrdList.html#snocOL"><span class="hs-operator hs-var">`snocOL`</span></a></span><span> </span><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621682975945"><span class="hs-identifier hs-var">fb</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2141"></span><span>
</span><span id="line-2142"></span><span class="hs-comment">-- | Cons a `FloatingBind` `b` to a `Floats` telescope `bs` which scopes over</span><span>
</span><span id="line-2143"></span><span class="hs-comment">-- `b`.</span><span>
</span><span id="line-2144"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#consFloat"><span class="hs-identifier hs-type">consFloat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatingBind"><span class="hs-identifier hs-type">FloatingBind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span>
</span><span id="line-2145"></span><span id="consFloat"><span class="annot"><span class="annottext">consFloat :: FloatingBind -&gt; Floats -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#consFloat"><span class="hs-identifier hs-var hs-var">consFloat</span></a></span></span><span> </span><span id="local-6989586621682975947"><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621682975947"><span class="hs-identifier hs-var">fb</span></a></span></span><span> </span><span id="local-6989586621682975948"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975948"><span class="hs-identifier hs-var">floats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2146"></span><span>  </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fs_info :: FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#fs_info"><span class="hs-identifier hs-var">fs_info</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FloatInfo -&gt; FloatInfo -&gt; FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#lubFloatInfo"><span class="hs-identifier hs-var">lubFloatInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats -&gt; FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#fs_info"><span class="hs-identifier hs-var">fs_info</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975948"><span class="hs-identifier hs-var">floats</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FloatingBind -&gt; FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#floatInfo"><span class="hs-identifier hs-var">floatInfo</span></a></span><span> </span><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621682975947"><span class="hs-identifier hs-var">fb</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2147"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fs_binds :: OrdList FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#fs_binds"><span class="hs-identifier hs-var">fs_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621682975947"><span class="hs-identifier hs-var">fb</span></a></span><span> </span><span class="annot"><span class="annottext">FloatingBind -&gt; OrdList FloatingBind -&gt; OrdList FloatingBind
forall a. a -&gt; OrdList a -&gt; OrdList a
</span><a href="GHC.Data.OrdList.html#consOL"><span class="hs-operator hs-var">`consOL`</span></a></span><span>  </span><span class="annot"><span class="annottext">Floats -&gt; OrdList FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#fs_binds"><span class="hs-identifier hs-var">fs_binds</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975948"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2148"></span><span>
</span><span id="line-2149"></span><span class="annot"><span class="hs-comment">-- | Append two telescopes, nesting the right inside the left.</span></span><span>
</span><span id="line-2150"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#appFloats"><span class="hs-identifier hs-type">appFloats</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span>
</span><span id="line-2151"></span><span id="appFloats"><span class="annot"><span class="annottext">appFloats :: Floats -&gt; Floats -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#appFloats"><span class="hs-identifier hs-var hs-var">appFloats</span></a></span></span><span> </span><span id="local-6989586621682975950"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975950"><span class="hs-identifier hs-var">outer</span></a></span></span><span> </span><span id="local-6989586621682975951"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975951"><span class="hs-identifier hs-var">inner</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2152"></span><span>  </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fs_info :: FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#fs_info"><span class="hs-identifier hs-var">fs_info</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FloatInfo -&gt; FloatInfo -&gt; FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#lubFloatInfo"><span class="hs-identifier hs-var">lubFloatInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats -&gt; FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#fs_info"><span class="hs-identifier hs-var">fs_info</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975950"><span class="hs-identifier hs-var">outer</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats -&gt; FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#fs_info"><span class="hs-identifier hs-var">fs_info</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975951"><span class="hs-identifier hs-var">inner</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2153"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fs_binds :: OrdList FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#fs_binds"><span class="hs-identifier hs-var">fs_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Floats -&gt; OrdList FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#fs_binds"><span class="hs-identifier hs-var">fs_binds</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975950"><span class="hs-identifier hs-var">outer</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind
-&gt; OrdList FloatingBind -&gt; OrdList FloatingBind
forall a. OrdList a -&gt; OrdList a -&gt; OrdList a
</span><a href="GHC.Data.OrdList.html#appOL"><span class="hs-operator hs-var">`appOL`</span></a></span><span> </span><span class="annot"><span class="annottext">Floats -&gt; OrdList FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#fs_binds"><span class="hs-identifier hs-var">fs_binds</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975951"><span class="hs-identifier hs-var">inner</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2154"></span><span>
</span><span id="line-2155"></span><span class="annot"><span class="hs-comment">-- | Zip up two `Floats`, none of which scope over the other</span></span><span>
</span><span id="line-2156"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#zipFloats"><span class="hs-identifier hs-type">zipFloats</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span>
</span><span id="line-2157"></span><span class="hs-comment">-- We may certainly just nest one telescope in the other, so appFloats is a</span><span>
</span><span id="line-2158"></span><span class="hs-comment">-- valid implementation strategy.</span><span>
</span><span id="line-2159"></span><span id="zipFloats"><span class="annot"><span class="annottext">zipFloats :: Floats -&gt; Floats -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#zipFloats"><span class="hs-identifier hs-var hs-var">zipFloats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Floats -&gt; Floats -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#appFloats"><span class="hs-identifier hs-var">appFloats</span></a></span><span>
</span><span id="line-2160"></span><span>
</span><span id="line-2161"></span><span class="annot"><span class="hs-comment">-- | `zipFloats` a bunch of independent telescopes.</span></span><span>
</span><span id="line-2162"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#zipManyFloats"><span class="hs-identifier hs-type">zipManyFloats</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span>
</span><span id="line-2163"></span><span id="zipManyFloats"><span class="annot"><span class="annottext">zipManyFloats :: [Floats] -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#zipManyFloats"><span class="hs-identifier hs-var hs-var">zipManyFloats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Floats -&gt; Floats -&gt; Floats) -&gt; Floats -&gt; [Floats] -&gt; Floats
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="annot"><span class="annottext">Floats -&gt; Floats -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#zipFloats"><span class="hs-identifier hs-var">zipFloats</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span>
</span><span id="line-2164"></span><span>
</span><span id="line-2165"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#mkCaseFloat"><span class="hs-identifier hs-type">mkCaseFloat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatingBind"><span class="hs-identifier hs-type">FloatingBind</span></a></span><span>
</span><span id="line-2166"></span><span id="mkCaseFloat"><span class="annot"><span class="annottext">mkCaseFloat :: Bool -&gt; InVar -&gt; CpeRhs -&gt; FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#mkCaseFloat"><span class="hs-identifier hs-var hs-var">mkCaseFloat</span></a></span></span><span> </span><span id="local-6989586621682975953"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682975953"><span class="hs-identifier hs-var">is_unlifted</span></a></span></span><span> </span><span id="local-6989586621682975954"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975954"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682975955"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975955"><span class="hs-identifier hs-var">scrut</span></a></span></span><span>
</span><span id="line-2167"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBind -&gt; BindInfo -&gt; FloatInfo -&gt; FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#Float"><span class="hs-identifier hs-var">Float</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InVar -&gt; CpeRhs -&gt; CoreBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975954"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975955"><span class="hs-identifier hs-var">scrut</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">BindInfo
</span><a href="#local-6989586621682975956"><span class="hs-identifier hs-var">bound</span></a></span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="#local-6989586621682975957"><span class="hs-identifier hs-var">info</span></a></span><span>
</span><span id="line-2168"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2169"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682975956"><span class="annot"><span class="annottext">BindInfo
</span><a href="#local-6989586621682975956"><span class="hs-identifier hs-var">bound</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975957"><span class="annot"><span class="annottext">FloatInfo
</span><a href="#local-6989586621682975957"><span class="hs-identifier hs-var">info</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2170"></span><span class="hs-comment">{-
Eventually we want the following code, when #20749 is fixed.
      | is_lifted, is_hnf        = (LetBound,  TopLvlFloatable)
          -- `seq# (case x of x' { __DEFAULT -&gt; StrictBox x' }) s` should
          -- let-bind `StrictBox x'` after Note [Flatten case-binds].
-}</span><span>
</span><span id="line-2176"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsTickedString"><span class="hs-identifier hs-var">exprIsTickedString</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975955"><span class="hs-identifier hs-var">scrut</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BindInfo
</span><a href="GHC.CoreToStg.Prep.html#CaseBound"><span class="hs-identifier hs-var">CaseBound</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#TopLvlFloatable"><span class="hs-identifier hs-var">TopLvlFloatable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2177"></span><span>          </span><span class="hs-comment">-- String literals are unboxed (so must be case-bound) and float to</span><span>
</span><span id="line-2178"></span><span>          </span><span class="hs-comment">-- the top-level</span><span>
</span><span id="line-2179"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BindInfo
</span><a href="GHC.CoreToStg.Prep.html#CaseBound"><span class="hs-identifier hs-var">CaseBound</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#StrictContextFloatable"><span class="hs-identifier hs-var">StrictContextFloatable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2180"></span><span>         </span><span class="hs-comment">-- For a Case, we never want to drop the eval; hence no need to test</span><span>
</span><span id="line-2181"></span><span>         </span><span class="hs-comment">-- for ok-for-spec-eval</span><span>
</span><span id="line-2182"></span><span>    </span><span id="local-6989586621682975958"><span class="annot"><span class="annottext">_is_lifted :: Bool
</span><a href="#local-6989586621682975958"><span class="hs-identifier hs-var hs-var">_is_lifted</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682975953"><span class="hs-identifier hs-var">is_unlifted</span></a></span><span>
</span><span id="line-2183"></span><span>    </span><span id="local-6989586621682975959"><span class="annot"><span class="annottext">_is_hnf :: Bool
</span><a href="#local-6989586621682975959"><span class="hs-identifier hs-var hs-var">_is_hnf</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsHNF"><span class="hs-identifier hs-var">exprIsHNF</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975955"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-2184"></span><span>
</span><span id="line-2185"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#mkNonRecFloat"><span class="hs-identifier hs-type">mkNonRecFloat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatingBind"><span class="hs-identifier hs-type">FloatingBind</span></a></span><span>
</span><span id="line-2186"></span><span id="mkNonRecFloat"><span class="annot"><span class="annottext">mkNonRecFloat :: CorePrepEnv -&gt; Bool -&gt; InVar -&gt; CpeRhs -&gt; FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#mkNonRecFloat"><span class="hs-identifier hs-var hs-var">mkNonRecFloat</span></a></span></span><span> </span><span id="local-6989586621682975960"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975960"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682975961"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682975961"><span class="hs-identifier hs-var">is_unlifted</span></a></span></span><span> </span><span id="local-6989586621682975962"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975962"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682975963"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975963"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-2187"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;mkNonRecFloat&quot; (ppr bndr &lt;+&gt; ppr (bound,info)</span><span>
</span><span id="line-2188"></span><span>    </span><span class="hs-comment">--                             &lt;+&gt; ppr is_lifted &lt;+&gt; ppr is_strict</span><span>
</span><span id="line-2189"></span><span>    </span><span class="hs-comment">--                             &lt;+&gt; ppr ok_for_spec</span><span>
</span><span id="line-2190"></span><span>    </span><span class="hs-comment">--                           $$ ppr rhs) $</span><span>
</span><span id="line-2191"></span><span>    </span><span class="annot"><span class="annottext">CoreBind -&gt; BindInfo -&gt; FloatInfo -&gt; FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#Float"><span class="hs-identifier hs-var">Float</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InVar -&gt; CpeRhs -&gt; CoreBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975962"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975963"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">BindInfo
</span><a href="#local-6989586621682975964"><span class="hs-identifier hs-var">bound</span></a></span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="#local-6989586621682975965"><span class="hs-identifier hs-var">info</span></a></span><span>
</span><span id="line-2192"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2193"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682975964"><span class="annot"><span class="annottext">BindInfo
</span><a href="#local-6989586621682975964"><span class="hs-identifier hs-var">bound</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682975965"><span class="annot"><span class="annottext">FloatInfo
</span><a href="#local-6989586621682975965"><span class="hs-identifier hs-var">info</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2194"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682975966"><span class="hs-identifier hs-var">is_lifted</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682975967"><span class="hs-identifier hs-var">is_hnf</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BindInfo
</span><a href="GHC.CoreToStg.Prep.html#LetBound"><span class="hs-identifier hs-var">LetBound</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#TopLvlFloatable"><span class="hs-identifier hs-var">TopLvlFloatable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2195"></span><span>          </span><span class="hs-comment">-- is_lifted: We currently don't allow unlifted values at the</span><span>
</span><span id="line-2196"></span><span>          </span><span class="hs-comment">--            top-level or inside letrecs</span><span>
</span><span id="line-2197"></span><span>          </span><span class="hs-comment">--            (but SG thinks that in principle, we should)</span><span>
</span><span id="line-2198"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">InVar -&gt; Bool
</span><a href="#local-6989586621682975968"><span class="hs-identifier hs-var">is_data_con</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975962"><span class="hs-identifier hs-var">bndr</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BindInfo
</span><a href="GHC.CoreToStg.Prep.html#LetBound"><span class="hs-identifier hs-var">LetBound</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#TopLvlFloatable"><span class="hs-identifier hs-var">TopLvlFloatable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2199"></span><span>          </span><span class="hs-comment">-- We need this special case for nullary unlifted DataCon</span><span>
</span><span id="line-2200"></span><span>          </span><span class="hs-comment">-- workers/wrappers (top-level bindings) until #17521 is fixed</span><span>
</span><span id="line-2201"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsTickedString"><span class="hs-identifier hs-var">exprIsTickedString</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975963"><span class="hs-identifier hs-var">rhs</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BindInfo
</span><a href="GHC.CoreToStg.Prep.html#CaseBound"><span class="hs-identifier hs-var">CaseBound</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#TopLvlFloatable"><span class="hs-identifier hs-var">TopLvlFloatable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2202"></span><span>          </span><span class="hs-comment">-- String literals are unboxed (so must be case-bound) and float to</span><span>
</span><span id="line-2203"></span><span>          </span><span class="hs-comment">-- the top-level</span><span>
</span><span id="line-2204"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682975961"><span class="hs-identifier hs-var">is_unlifted</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682975969"><span class="hs-identifier hs-var">ok_for_spec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BindInfo
</span><a href="GHC.CoreToStg.Prep.html#CaseBound"><span class="hs-identifier hs-var">CaseBound</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#LazyContextFloatable"><span class="hs-identifier hs-var">LazyContextFloatable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2205"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682975966"><span class="hs-identifier hs-var">is_lifted</span></a></span><span class="hs-special">,</span><span>   </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682975969"><span class="hs-identifier hs-var">ok_for_spec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BindInfo
</span><a href="GHC.CoreToStg.Prep.html#CaseBound"><span class="hs-identifier hs-var">CaseBound</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#TopLvlFloatable"><span class="hs-identifier hs-var">TopLvlFloatable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2206"></span><span>          </span><span class="hs-comment">-- See Note [Speculative evaluation]</span><span>
</span><span id="line-2207"></span><span>          </span><span class="hs-comment">-- Ok-for-spec-eval things will be case-bound, lifted or not.</span><span>
</span><span id="line-2208"></span><span>          </span><span class="hs-comment">-- But when it's lifted we are ok with floating it to top-level</span><span>
</span><span id="line-2209"></span><span>          </span><span class="hs-comment">-- (where it is actually bound lazily).</span><span>
</span><span id="line-2210"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682975961"><span class="hs-identifier hs-var">is_unlifted</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682975970"><span class="hs-identifier hs-var">is_strict</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BindInfo
</span><a href="GHC.CoreToStg.Prep.html#CaseBound"><span class="hs-identifier hs-var">CaseBound</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#StrictContextFloatable"><span class="hs-identifier hs-var">StrictContextFloatable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2211"></span><span>          </span><span class="hs-comment">-- These will never be floated out of a lazy RHS context</span><span>
</span><span id="line-2212"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; (BindInfo, FloatInfo) -&gt; (BindInfo, FloatInfo)
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682975966"><span class="hs-identifier hs-var">is_lifted</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeRhs -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975963"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((BindInfo, FloatInfo) -&gt; (BindInfo, FloatInfo))
-&gt; (BindInfo, FloatInfo) -&gt; (BindInfo, FloatInfo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2213"></span><span>                                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BindInfo
</span><a href="GHC.CoreToStg.Prep.html#LetBound"><span class="hs-identifier hs-var">LetBound</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#TopLvlFloatable"><span class="hs-identifier hs-var">TopLvlFloatable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2214"></span><span>          </span><span class="hs-comment">-- And these float freely but can't be speculated, hence LetBound</span><span>
</span><span id="line-2215"></span><span>
</span><span id="line-2216"></span><span>    </span><span id="local-6989586621682975971"><span class="annot"><span class="annottext">cfg :: CorePrepConfig
</span><a href="#local-6989586621682975971"><span class="hs-identifier hs-var hs-var">cfg</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CorePrepConfig
</span><a href="GHC.CoreToStg.Prep.html#cpe_config"><span class="hs-identifier hs-var">cpe_config</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975960"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-2217"></span><span>    </span><span id="local-6989586621682975966"><span class="annot"><span class="annottext">is_lifted :: Bool
</span><a href="#local-6989586621682975966"><span class="hs-identifier hs-var hs-var">is_lifted</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682975961"><span class="hs-identifier hs-var">is_unlifted</span></a></span><span>
</span><span id="line-2218"></span><span>    </span><span id="local-6989586621682975967"><span class="annot"><span class="annottext">is_hnf :: Bool
</span><a href="#local-6989586621682975967"><span class="hs-identifier hs-var hs-var">is_hnf</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsHNF"><span class="hs-identifier hs-var">exprIsHNF</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975963"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-2219"></span><span>    </span><span id="local-6989586621682975972"><span class="annot"><span class="annottext">dmd :: Demand
</span><a href="#local-6989586621682975972"><span class="hs-identifier hs-var hs-var">dmd</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InVar -&gt; Demand
</span><a href="GHC.Types.Id.html#idDemandInfo"><span class="hs-identifier hs-var">idDemandInfo</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975962"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-2220"></span><span>    </span><span id="local-6989586621682975970"><span class="annot"><span class="annottext">is_strict :: Bool
</span><a href="#local-6989586621682975970"><span class="hs-identifier hs-var hs-var">is_strict</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Demand -&gt; Bool
</span><a href="GHC.Types.Demand.html#isStrUsedDmd"><span class="hs-identifier hs-var">isStrUsedDmd</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682975972"><span class="hs-identifier hs-var">dmd</span></a></span><span>
</span><span id="line-2221"></span><span>    </span><span id="local-6989586621682975969"><span class="annot"><span class="annottext">ok_for_spec :: Bool
</span><a href="#local-6989586621682975969"><span class="hs-identifier hs-var hs-var">ok_for_spec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(InVar -&gt; Bool) -&gt; CpeRhs -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprOkForSpecEval"><span class="hs-identifier hs-var">exprOkForSpecEval</span></a></span><span> </span><span class="annot"><span class="annottext">InVar -&gt; Bool
</span><a href="#local-6989586621682975975"><span class="hs-identifier hs-var">call_ok_for_spec</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975963"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-2222"></span><span>    </span><span class="hs-comment">-- See Note [Controlling Speculative Evaluation]</span><span>
</span><span id="line-2223"></span><span>    </span><span id="local-6989586621682975975"><span class="annot"><span class="annottext">call_ok_for_spec :: InVar -&gt; Bool
</span><a href="#local-6989586621682975975"><span class="hs-identifier hs-var hs-var">call_ok_for_spec</span></a></span></span><span> </span><span id="local-6989586621682975976"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975976"><span class="hs-identifier hs-var">x</span></a></span></span><span>
</span><span id="line-2224"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">InVar -&gt; Bool
</span><a href="#local-6989586621682975977"><span class="hs-identifier hs-var">is_rec_call</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975976"><span class="hs-identifier hs-var">x</span></a></span><span>                           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-2225"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepConfig -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#cp_specEval"><span class="hs-identifier hs-var">cp_specEval</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepConfig
</span><a href="#local-6989586621682975971"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-2226"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepConfig -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#cp_specEvalDFun"><span class="hs-identifier hs-var">cp_specEvalDFun</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepConfig
</span><a href="#local-6989586621682975971"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">InVar -&gt; Bool
</span><a href="GHC.Types.Id.html#isDFunId"><span class="hs-identifier hs-var">isDFunId</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975976"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-2227"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-2228"></span><span>    </span><span id="local-6989586621682975977"><span class="annot"><span class="annottext">is_rec_call :: InVar -&gt; Bool
</span><a href="#local-6989586621682975977"><span class="hs-identifier hs-var hs-var">is_rec_call</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InVar -&gt; UnVarSet -&gt; Bool
</span><a href="GHC.Data.Graph.UnVar.html#elemUnVarSet"><span class="hs-operator hs-var">`elemUnVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; UnVarSet
</span><a href="GHC.CoreToStg.Prep.html#cpe_rec_ids"><span class="hs-identifier hs-var">cpe_rec_ids</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682975960"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2229"></span><span>    </span><span id="local-6989586621682975968"><span class="annot"><span class="annottext">is_data_con :: InVar -&gt; Bool
</span><a href="#local-6989586621682975968"><span class="hs-identifier hs-var hs-var">is_data_con</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe DataCon -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">(Maybe DataCon -&gt; Bool)
-&gt; (InVar -&gt; Maybe DataCon) -&gt; InVar -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">InVar -&gt; Maybe DataCon
</span><a href="GHC.Types.Id.html#isDataConId_maybe"><span class="hs-identifier hs-var">isDataConId_maybe</span></a></span><span>
</span><span id="line-2230"></span><span>
</span><span id="line-2231"></span><span class="annot"><span class="hs-comment">-- | Wrap floats around an expression</span></span><span>
</span><span id="line-2232"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#wrapBinds"><span class="hs-identifier hs-type">wrapBinds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeBody"><span class="hs-identifier hs-type">CpeBody</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeBody"><span class="hs-identifier hs-type">CpeBody</span></a></span><span>
</span><span id="line-2233"></span><span id="wrapBinds"><span class="annot"><span class="annottext">wrapBinds :: Floats -&gt; CpeRhs -&gt; CpeRhs
</span><a href="GHC.CoreToStg.Prep.html#wrapBinds"><span class="hs-identifier hs-var hs-var">wrapBinds</span></a></span></span><span> </span><span id="local-6989586621682975986"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975986"><span class="hs-identifier hs-var">floats</span></a></span></span><span> </span><span id="local-6989586621682975987"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975987"><span class="hs-identifier hs-var">body</span></a></span></span><span>
</span><span id="line-2234"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTraceWith &quot;wrapBinds&quot; (\res -&gt; ppr floats $$ ppr body $$ ppr res) $</span><span>
</span><span id="line-2235"></span><span>    </span><span class="annot"><span class="annottext">(FloatingBind -&gt; CpeRhs -&gt; CpeRhs)
-&gt; CpeRhs -&gt; OrdList FloatingBind -&gt; CpeRhs
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; OrdList a -&gt; b
</span><a href="GHC.Data.OrdList.html#foldrOL"><span class="hs-identifier hs-var">foldrOL</span></a></span><span> </span><span class="annot"><span class="annottext">FloatingBind -&gt; CpeRhs -&gt; CpeRhs
</span><a href="#local-6989586621682975988"><span class="hs-identifier hs-var">mk_bind</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975987"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats -&gt; OrdList FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#getFloats"><span class="hs-identifier hs-var">getFloats</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682975986"><span class="hs-identifier hs-var">floats</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2236"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2237"></span><span>    </span><span class="hs-comment">-- See Note [BindInfo and FloatInfo] on whether we pick Case or Let here</span><span>
</span><span id="line-2238"></span><span>    </span><span id="local-6989586621682975988"><span class="annot"><span class="annottext">mk_bind :: FloatingBind -&gt; CpeRhs -&gt; CpeRhs
</span><a href="#local-6989586621682975988"><span class="hs-identifier hs-var hs-var">mk_bind</span></a></span></span><span> </span><span id="local-6989586621682975992"><span class="annot"><span class="annottext">f :: FloatingBind
</span><a href="#local-6989586621682975992"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Float"><span class="hs-identifier hs-type">Float</span></a></span><span> </span><span id="local-6989586621682975993"><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682975993"><span class="hs-identifier hs-var">bind</span></a></span></span><span> </span><span class="annot"><span class="annottext">BindInfo
</span><a href="GHC.CoreToStg.Prep.html#CaseBound"><span class="hs-identifier hs-var">CaseBound</span></a></span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682975994"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975994"><span class="hs-identifier hs-var">body</span></a></span></span><span>
</span><span id="line-2239"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span id="local-6989586621682975995"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975995"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682975996"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975996"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682975993"><span class="hs-identifier hs-var">bind</span></a></span><span>
</span><span id="line-2240"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; InVar -&gt; CpeRhs -&gt; CpeRhs
</span><a href="GHC.Core.Utils.html#mkDefaultCase"><span class="hs-identifier hs-var">mkDefaultCase</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975996"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682975995"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975994"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-2241"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2242"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; CpeRhs
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;wrapBinds&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FloatingBind -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621682975992"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2243"></span><span>    </span><span class="annot"><a href="#local-6989586621682975988"><span class="hs-identifier hs-var">mk_bind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Float"><span class="hs-identifier hs-type">Float</span></a></span><span> </span><span id="local-6989586621682975998"><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682975998"><span class="hs-identifier hs-var">bind</span></a></span></span><span> </span><span class="annot"><span class="annottext">BindInfo
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682975999"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975999"><span class="hs-identifier hs-var">body</span></a></span></span><span>
</span><span id="line-2244"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBind -&gt; CpeRhs -&gt; CpeRhs
forall b. Bind b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682975998"><span class="hs-identifier hs-var">bind</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682975999"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-2245"></span><span>    </span><span class="annot"><a href="#local-6989586621682975988"><span class="hs-identifier hs-var">mk_bind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#UnsafeEqualityCase"><span class="hs-identifier hs-type">UnsafeEqualityCase</span></a></span><span> </span><span id="local-6989586621682976000"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682976000"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621682976001"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976001"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682976002"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682976002"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span id="local-6989586621682976003"><span class="annot"><span class="annottext">[InVar]
</span><a href="#local-6989586621682976003"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682976004"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682976004"><span class="hs-identifier hs-var">body</span></a></span></span><span>
</span><span id="line-2246"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; InVar -&gt; AltCon -&gt; [InVar] -&gt; CpeRhs -&gt; CpeRhs
</span><a href="GHC.Core.Utils.html#mkSingleAltCase"><span class="hs-identifier hs-var">mkSingleAltCase</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682976000"><span class="hs-identifier hs-var">scrut</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976001"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682976002"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">[InVar]
</span><a href="#local-6989586621682976003"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682976004"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-2247"></span><span>    </span><span class="annot"><a href="#local-6989586621682975988"><span class="hs-identifier hs-var">mk_bind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatTick"><span class="hs-identifier hs-type">FloatTick</span></a></span><span> </span><span id="local-6989586621682976006"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682976006"><span class="hs-identifier hs-var">tickish</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682976007"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682976007"><span class="hs-identifier hs-var">body</span></a></span></span><span>
</span><span id="line-2248"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; CpeRhs -&gt; CpeRhs
</span><a href="GHC.Core.Utils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682976006"><span class="hs-identifier hs-var">tickish</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682976007"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-2249"></span><span>
</span><span id="line-2250"></span><span class="annot"><span class="hs-comment">-- | Put floats at top-level</span></span><span>
</span><span id="line-2251"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#deFloatTop"><span class="hs-identifier hs-type">deFloatTop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2252"></span><span class="hs-comment">-- Precondition: No Strict or LazyContextFloatable 'FloatInfo', no ticks!</span><span>
</span><span id="line-2253"></span><span id="deFloatTop"><span class="annot"><span class="annottext">deFloatTop :: Floats -&gt; CoreProgram
</span><a href="GHC.CoreToStg.Prep.html#deFloatTop"><span class="hs-identifier hs-var hs-var">deFloatTop</span></a></span></span><span> </span><span id="local-6989586621682976008"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682976008"><span class="hs-identifier hs-var">floats</span></a></span></span><span>
</span><span id="line-2254"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FloatingBind -&gt; CoreProgram -&gt; CoreProgram)
-&gt; CoreProgram -&gt; OrdList FloatingBind -&gt; CoreProgram
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; OrdList a -&gt; b
</span><a href="GHC.Data.OrdList.html#foldrOL"><span class="hs-identifier hs-var">foldrOL</span></a></span><span> </span><span class="annot"><span class="annottext">FloatingBind -&gt; CoreProgram -&gt; CoreProgram
</span><a href="#local-6989586621682976009"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats -&gt; OrdList FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#getFloats"><span class="hs-identifier hs-var">getFloats</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682976008"><span class="hs-identifier hs-var">floats</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2255"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2256"></span><span>    </span><span id="local-6989586621682976009"><span class="annot"><span class="annottext">get :: FloatingBind -&gt; CoreProgram -&gt; CoreProgram
</span><a href="#local-6989586621682976009"><span class="hs-identifier hs-var hs-var">get</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Float"><span class="hs-identifier hs-type">Float</span></a></span><span> </span><span id="local-6989586621682976013"><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682976013"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="annot"><span class="annottext">BindInfo
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#TopLvlFloatable"><span class="hs-identifier hs-var">TopLvlFloatable</span></a></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682976014"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621682976014"><span class="hs-identifier hs-var">bs</span></a></span></span><span>
</span><span id="line-2257"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBind -&gt; CoreBind
</span><a href="#local-6989586621682976015"><span class="hs-identifier hs-var">get_bind</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682976013"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind -&gt; CoreProgram -&gt; CoreProgram
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621682976014"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-2258"></span><span>    </span><span class="annot"><a href="#local-6989586621682976009"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span id="local-6989586621682976016"><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621682976016"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; CoreProgram
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;deFloatTop&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FloatingBind -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621682976016"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2259"></span><span>
</span><span id="line-2260"></span><span>    </span><span class="hs-comment">-- See Note [Dead code in CorePrep]</span><span>
</span><span id="line-2261"></span><span>    </span><span id="local-6989586621682976015"><span class="annot"><span class="annottext">get_bind :: CoreBind -&gt; CoreBind
</span><a href="#local-6989586621682976015"><span class="hs-identifier hs-var hs-var">get_bind</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span id="local-6989586621682976017"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976017"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621682976018"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682976018"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InVar -&gt; CpeRhs -&gt; CoreBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976017"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeRhs -&gt; CpeRhs
</span><a href="GHC.Core.Opt.OccurAnal.html#occurAnalyseExpr"><span class="hs-identifier hs-var">occurAnalyseExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682976018"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2262"></span><span>    </span><span class="annot"><a href="#local-6989586621682976015"><span class="hs-identifier hs-var">get_bind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span id="local-6989586621682976020"><span class="annot"><span class="annottext">[(InVar, CpeRhs)]
</span><a href="#local-6989586621682976020"><span class="hs-identifier hs-var">xes</span></a></span></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(InVar, CpeRhs)] -&gt; CoreBind
forall b. [(b, Expr b)] -&gt; Bind b
</span><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-var">Rec</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976021"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; CpeRhs
</span><a href="GHC.Core.Opt.OccurAnal.html#occurAnalyseExpr"><span class="hs-identifier hs-var">occurAnalyseExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682976022"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682976021"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976021"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682976022"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682976022"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(InVar, CpeRhs)]
</span><a href="#local-6989586621682976020"><span class="hs-identifier hs-var">xes</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2263"></span><span>
</span><span id="line-2264"></span><span class="hs-comment">---------------------------------------------------------------------------</span><span>
</span><span id="line-2265"></span><span>
</span><span id="line-2266"></span><span class="hs-comment">{- Note [wantFloatLocal]
~~~~~~~~~~~~~~~~~~~~~~~~
Consider
  let x = let y = e1 in e2
  in e
Similarly for `(\x. e) (let y = e1 in e2)`.
Do we want to float out `y` out of `x`?
(This is discussed in detail in the paper
&quot;Let-floating: moving bindings to give faster programs&quot;.)

`wantFloatLocal` is concerned with answering this question.
It considers the Demand on `x`, whether or not `e2` is unlifted and the
`FloatInfo` of the `y` binding (e.g., it might itself be unlifted, a value,
strict, or ok-for-spec).

We float out if ...
  1. ... the binding context is strict anyway, so either `x` is used strictly
     or has unlifted type.
     Doing so is trivially sound and won`t increase allocations, so we
     return `FloatAll`.
     This might happen while ANF-ising `f (g (h 13))` where `f`,`g` are strict:
       f (g (h 13))
       ==&gt; { ANF }
       case (case h 13 of r -&gt; g r) of r2 -&gt; f r2
       ==&gt; { Float }
       case h 13 of r -&gt; case g r of r2 -&gt; f r2
     The latter is easier to read and grows less stack.
  2. ... `e2` becomes a value in doing so, in which case we won't need to
     allocate a thunk for `x`/the arg that closes over the FVs of `e1`.
     In general, this is only sound if `y=e1` is `LazyContextFloatable`.
     (See Note [BindInfo and FloatInfo].)
     Nothing is won if `x` doesn't become a value
     (i.e., `let x = let sat = f 14 in g sat in e`),
     so we return `FloatNone` if there is any float that is
     `StrictContextFloatable`, and return `FloatAll` otherwise.

To elaborate on (2), consider the case when the floated binding is
`e1 = divInt# a b`, e.g., not `LazyContextFloatable`:
  let x = I# (a `divInt#` b)
  in e
this ANFises to
  let x = case a `divInt#` b of r { __DEFAULT -&gt; I# r }
  in e
If `x` is used lazily, we may not float `r` further out.
A float binding `x +# y` is OK, though, and so every ok-for-spec-eval
binding is `LazyContextFloatable`.

Wrinkles:

 (W1) When the outer binding is a letrec, i.e.,
        letrec x = case a +# b of r { __DEFAULT -&gt; f y r }
               y = [x]
        in e
      we don't want to float `LazyContextFloatable` bindings such as `r` either
      and require `TopLvlFloatable` instead.
      The reason is that we don't track FV of FloatBindings, so we would need
      to park them in the letrec,
        letrec r = a +# b -- NB: r`s RHS might scope over x and y
               x = f y r
               y = [x]
        in e
      and now we have violated Note [Core letrec invariant].
      So we preempt this case in `wantFloatLocal`, responding `FloatNone` unless
      all floats are `TopLvlFloatable`.
-}</span><span>
</span><span id="line-2331"></span><span>
</span><span id="line-2332"></span><span class="hs-keyword">data</span><span> </span><span id="FloatDecision"><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatDecision"><span class="hs-identifier hs-var">FloatDecision</span></a></span></span><span>
</span><span id="line-2333"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="FloatNone"><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatNone"><span class="hs-identifier hs-var">FloatNone</span></a></span></span><span>
</span><span id="line-2334"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="FloatAll"><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatAll"><span class="hs-identifier hs-var">FloatAll</span></a></span></span><span>
</span><span id="line-2335"></span><span>
</span><span id="line-2336"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#executeFloatDecision"><span class="hs-identifier hs-type">executeFloatDecision</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatDecision"><span class="hs-identifier hs-type">FloatDecision</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2337"></span><span id="executeFloatDecision"><span class="annot"><span class="annottext">executeFloatDecision :: FloatDecision -&gt; Floats -&gt; CpeRhs -&gt; UniqSM (Floats, CpeRhs)
</span><a href="GHC.CoreToStg.Prep.html#executeFloatDecision"><span class="hs-identifier hs-var hs-var">executeFloatDecision</span></a></span></span><span> </span><span id="local-6989586621682976024"><span class="annot"><span class="annottext">FloatDecision
</span><a href="#local-6989586621682976024"><span class="hs-identifier hs-var">dec</span></a></span></span><span> </span><span id="local-6989586621682976025"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682976025"><span class="hs-identifier hs-var">floats</span></a></span></span><span> </span><span id="local-6989586621682976026"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682976026"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-2338"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">FloatDecision
</span><a href="#local-6989586621682976024"><span class="hs-identifier hs-var">dec</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2339"></span><span>      </span><span class="annot"><span class="annottext">FloatDecision
</span><a href="GHC.CoreToStg.Prep.html#FloatAll"><span class="hs-identifier hs-var">FloatAll</span></a></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeRhs) -&gt; UniqSM (Floats, CpeRhs)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682976025"><span class="hs-identifier hs-var">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682976026"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2340"></span><span>      </span><span class="annot"><span class="annottext">FloatDecision
</span><a href="GHC.CoreToStg.Prep.html#FloatNone"><span class="hs-identifier hs-var">FloatNone</span></a></span><span>
</span><span id="line-2341"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Floats -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#isEmptyFloats"><span class="hs-identifier hs-var">isEmptyFloats</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682976025"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeRhs) -&gt; UniqSM (Floats, CpeRhs)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682976026"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2342"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682976027"><span class="annot"><a href="#local-6989586621682976027"><span class="hs-identifier hs-var">floats'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682976028"><span class="annot"><a href="#local-6989586621682976028"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; UniqSM (Floats, CpeRhs)
</span><a href="GHC.CoreToStg.Prep.html#rhsToBody"><span class="hs-identifier hs-var">rhsToBody</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682976026"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-2343"></span><span>                                     </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-type">emptyFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#wrapBinds"><span class="hs-identifier hs-type">wrapBinds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682976025"><span class="hs-identifier hs-type">floats</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-2344"></span><span>                                                            </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#wrapBinds"><span class="hs-identifier hs-type">wrapBinds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682976027"><span class="hs-identifier hs-type">floats'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682976028"><span class="hs-identifier hs-type">body</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2345"></span><span>            </span><span class="hs-comment">-- FloatNone case: `rhs` might have lambdas, and we can't</span><span>
</span><span id="line-2346"></span><span>            </span><span class="hs-comment">-- put them inside a wrapBinds, which expects a `CpeBody`.</span><span>
</span><span id="line-2347"></span><span>
</span><span id="line-2348"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#wantFloatTop"><span class="hs-identifier hs-type">wantFloatTop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatDecision"><span class="hs-identifier hs-type">FloatDecision</span></a></span><span>
</span><span id="line-2349"></span><span id="wantFloatTop"><span class="annot"><span class="annottext">wantFloatTop :: Floats -&gt; FloatDecision
</span><a href="GHC.CoreToStg.Prep.html#wantFloatTop"><span class="hs-identifier hs-var hs-var">wantFloatTop</span></a></span></span><span> </span><span id="local-6989586621682976029"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682976029"><span class="hs-identifier hs-var">fs</span></a></span></span><span>
</span><span id="line-2350"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Floats -&gt; FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#fs_info"><span class="hs-identifier hs-var">fs_info</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682976029"><span class="hs-identifier hs-var">fs</span></a></span><span> </span><span class="annot"><span class="annottext">FloatInfo -&gt; FloatInfo -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#floatsAtLeastAsFarAs"><span class="hs-operator hs-var">`floatsAtLeastAsFarAs`</span></a></span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#TopLvlFloatable"><span class="hs-identifier hs-var">TopLvlFloatable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FloatDecision
</span><a href="GHC.CoreToStg.Prep.html#FloatAll"><span class="hs-identifier hs-var">FloatAll</span></a></span><span>
</span><span id="line-2351"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                                         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FloatDecision
</span><a href="GHC.CoreToStg.Prep.html#FloatNone"><span class="hs-identifier hs-var">FloatNone</span></a></span><span>
</span><span id="line-2352"></span><span>
</span><span id="line-2353"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#wantFloatLocal"><span class="hs-identifier hs-type">wantFloatLocal</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#RecFlag"><span class="hs-identifier hs-type">RecFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatDecision"><span class="hs-identifier hs-type">FloatDecision</span></a></span><span>
</span><span id="line-2354"></span><span class="hs-comment">-- See Note [wantFloatLocal]</span><span>
</span><span id="line-2355"></span><span id="wantFloatLocal"><span class="annot"><span class="annottext">wantFloatLocal :: RecFlag -&gt; Demand -&gt; Bool -&gt; Floats -&gt; CpeRhs -&gt; FloatDecision
</span><a href="GHC.CoreToStg.Prep.html#wantFloatLocal"><span class="hs-identifier hs-var hs-var">wantFloatLocal</span></a></span></span><span> </span><span id="local-6989586621682976030"><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621682976030"><span class="hs-identifier hs-var">is_rec</span></a></span></span><span> </span><span id="local-6989586621682976031"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682976031"><span class="hs-identifier hs-var">rhs_dmd</span></a></span></span><span> </span><span id="local-6989586621682976032"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682976032"><span class="hs-identifier hs-var">rhs_is_unlifted</span></a></span></span><span> </span><span id="local-6989586621682976033"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682976033"><span class="hs-identifier hs-var">floats</span></a></span></span><span> </span><span id="local-6989586621682976034"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682976034"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-2356"></span><span>  </span><span class="hs-glyph">|</span><span>  </span><span class="annot"><span class="annottext">Floats -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#isEmptyFloats"><span class="hs-identifier hs-var">isEmptyFloats</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682976033"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="hs-comment">-- Well yeah...</span><span>
</span><span id="line-2357"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Demand -&gt; Bool
</span><a href="GHC.Types.Demand.html#isStrUsedDmd"><span class="hs-identifier hs-var">isStrUsedDmd</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682976031"><span class="hs-identifier hs-var">rhs_dmd</span></a></span><span> </span><span class="hs-comment">-- Case (1) of Note [wantFloatLocal]</span><span>
</span><span id="line-2358"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682976032"><span class="hs-identifier hs-var">rhs_is_unlifted</span></a></span><span>      </span><span class="hs-comment">-- dito</span><span>
</span><span id="line-2359"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats -&gt; FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#fs_info"><span class="hs-identifier hs-var">fs_info</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682976033"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="annot"><span class="annottext">FloatInfo -&gt; FloatInfo -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#floatsAtLeastAsFarAs"><span class="hs-operator hs-var">`floatsAtLeastAsFarAs`</span></a></span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="#local-6989586621682976035"><span class="hs-identifier hs-var">max_float_info</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">CpeRhs -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsHNF"><span class="hs-identifier hs-var">exprIsHNF</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682976034"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2360"></span><span>                          </span><span class="hs-comment">-- Case (2) of Note [wantFloatLocal]</span><span>
</span><span id="line-2361"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FloatDecision
</span><a href="GHC.CoreToStg.Prep.html#FloatAll"><span class="hs-identifier hs-var">FloatAll</span></a></span><span>
</span><span id="line-2362"></span><span>
</span><span id="line-2363"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2364"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FloatDecision
</span><a href="GHC.CoreToStg.Prep.html#FloatNone"><span class="hs-identifier hs-var">FloatNone</span></a></span><span>
</span><span id="line-2365"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2366"></span><span>    </span><span id="local-6989586621682976035"><span class="annot"><span class="annottext">max_float_info :: FloatInfo
</span><a href="#local-6989586621682976035"><span class="hs-identifier hs-var hs-var">max_float_info</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">RecFlag -&gt; Bool
</span><a href="GHC.Types.Basic.html#isRec"><span class="hs-identifier hs-var">isRec</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621682976030"><span class="hs-identifier hs-var">is_rec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#TopLvlFloatable"><span class="hs-identifier hs-var">TopLvlFloatable</span></a></span><span>
</span><span id="line-2367"></span><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="GHC.CoreToStg.Prep.html#LazyContextFloatable"><span class="hs-identifier hs-var">LazyContextFloatable</span></a></span><span>
</span><span id="line-2368"></span><span>                    </span><span class="hs-comment">-- See Note [wantFloatLocal], Wrinkle (W1)</span><span>
</span><span id="line-2369"></span><span>                    </span><span class="hs-comment">-- for 'is_rec'</span><span>
</span><span id="line-2370"></span><span>
</span><span id="line-2371"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Cloning
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-2378"></span><span>
</span><span id="line-2379"></span><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><span id="line-2380"></span><span class="hs-comment">--                      The environment</span><span>
</span><span id="line-2381"></span><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><span id="line-2382"></span><span>
</span><span id="line-2383"></span><span class="hs-comment">{- Note [Inlining in CorePrep]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
There is a subtle but important invariant that must be upheld in the output
of CorePrep: there are no &quot;trivial&quot; updatable thunks.  Thus, this Core
is impermissible:

     let x :: ()
         x = y

(where y is a reference to a GLOBAL variable).  Thunks like this are silly:
they can always be profitably replaced by inlining x with y. Consequently,
the code generator/runtime does not bother implementing this properly
(specifically, there is no implementation of stg_ap_0_upd_info, which is the
stack frame that would be used to update this thunk.  The &quot;0&quot; means it has
zero free variables.)

In general, the inliner is good at eliminating these let-bindings.  However,
there is one case where these trivial updatable thunks can arise: when
we are optimizing away 'lazy' (see Note [lazyId magic], and also
'cpeRhsE'.)  Then, we could have started with:

     let x :: ()
         x = lazy @() y

which is a perfectly fine, non-trivial thunk, but then CorePrep will drop
'lazy', giving us 'x = y' which is trivial and impermissible.  The solution is
CorePrep to have a miniature inlining pass which deals with cases like this.
We can then drop the let-binding altogether.

Why does the removal of 'lazy' have to occur in CorePrep?  The gory details
are in Note [lazyId magic] in GHC.Types.Id.Make, but the main reason is that
lazy must appear in unfoldings (optimizer output) and it must prevent
call-by-value for catch# (which is implemented by CorePrep.)

An alternate strategy for solving this problem is to have the inliner treat
'lazy e' as a trivial expression if 'e' is trivial.  We decided not to adopt
this solution to keep the definition of 'exprIsTrivial' simple.

There is ONE caveat however: for top-level bindings we have
to preserve the binding so that we float the (hacky) non-recursive
binding for data constructors; see Note [Data constructor workers].

Note [CorePrepEnv: cpe_subst]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
CorePrepEnv carries a substitution `Subst` in the `cpe_subst1 field,
for these reasons:

1. To support cloning of local Ids so that they are
   all unique (see Note [Cloning in CorePrep])

2. To support beta-reduction of runRW, see Note [runRW magic] and
   Note [runRW arg].

3. To let us inline trivial RHSs of non top-level let-bindings,
   see Note [lazyId magic], Note [Inlining in CorePrep] (#12076)

   Note that, if (y::forall a. a-&gt;a), we could get
      x = lazy @(forall a.a) y @Bool
   so after eliminating `lazy`, we need to replace occurrences of `x` with
   `y @Bool`, not just `y`.  Situations like this can easily arise with
   higher-rank types; thus, `cpe_subst` must map to CoreExprs, not Ids, which
   oc course it does

4. The TyCoVar part of the substitution is used only for
   Note [Cloning CoVars and TyVars]
-}</span><span>
</span><span id="line-2449"></span><span>
</span><span id="line-2450"></span><span class="hs-keyword">data</span><span> </span><span id="CorePrepConfig"><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepConfig"><span class="hs-identifier hs-var">CorePrepConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="CorePrepConfig"><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepConfig"><span class="hs-identifier hs-var">CorePrepConfig</span></a></span></span><span>
</span><span id="line-2451"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="cp_catchNonexhaustiveCases"><span class="annot"><span class="annottext">CorePrepConfig -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#cp_catchNonexhaustiveCases"><span class="hs-identifier hs-var hs-var">cp_catchNonexhaustiveCases</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-2452"></span><span>  </span><span class="hs-comment">-- ^ Whether to generate a default alternative with ``error`` in these</span><span>
</span><span id="line-2453"></span><span>  </span><span class="hs-comment">-- cases. This is helpful when debugging demand analysis or type</span><span>
</span><span id="line-2454"></span><span>  </span><span class="hs-comment">-- checker bugs which can sometimes manifest as segmentation faults.</span><span>
</span><span id="line-2455"></span><span>
</span><span id="line-2456"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="cp_platform"><span class="annot"><span class="annottext">CorePrepConfig -&gt; Platform
</span><a href="GHC.CoreToStg.Prep.html#cp_platform"><span class="hs-identifier hs-var hs-var">cp_platform</span></a></span></span><span>                </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Platform.html#Platform"><span class="hs-identifier hs-type">Platform</span></a></span><span>
</span><span id="line-2457"></span><span>
</span><span id="line-2458"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="cp_arityOpts"><span class="annot"><span class="annottext">CorePrepConfig -&gt; Maybe ArityOpts
</span><a href="GHC.CoreToStg.Prep.html#cp_arityOpts"><span class="hs-identifier hs-var hs-var">cp_arityOpts</span></a></span></span><span>               </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityOpts"><span class="hs-identifier hs-type">ArityOpts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2459"></span><span>  </span><span class="hs-comment">-- ^ Configuration for arity analysis ('exprEtaExpandArity').</span><span>
</span><span id="line-2460"></span><span>  </span><span class="hs-comment">-- See Note [Eta expansion of arguments in CorePrep]</span><span>
</span><span id="line-2461"></span><span>  </span><span class="hs-comment">-- When 'Nothing' (e.g., -O0, -O1), use the cheaper 'exprArity' instead</span><span>
</span><span id="line-2462"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="cp_specEval"><span class="annot"><span class="annottext">CorePrepConfig -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#cp_specEval"><span class="hs-identifier hs-var hs-var">cp_specEval</span></a></span></span><span>                </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-2463"></span><span>  </span><span class="hs-comment">-- ^ Whether to perform speculative evaluation</span><span>
</span><span id="line-2464"></span><span>  </span><span class="hs-comment">-- See Note [Controlling Speculative Evaluation]</span><span>
</span><span id="line-2465"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="cp_specEvalDFun"><span class="annot"><span class="annottext">CorePrepConfig -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#cp_specEvalDFun"><span class="hs-identifier hs-var hs-var">cp_specEvalDFun</span></a></span></span><span>            </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-2466"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Whether to perform speculative evaluation on DFuns</span></span><span>
</span><span id="line-2467"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-2468"></span><span>
</span><span id="line-2469"></span><span class="hs-keyword">data</span><span> </span><span id="CorePrepEnv"><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-var">CorePrepEnv</span></a></span></span><span>
</span><span id="line-2470"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="CPE"><span class="annot"><a href="GHC.CoreToStg.Prep.html#CPE"><span class="hs-identifier hs-var">CPE</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="cpe_config"><span class="annot"><span class="annottext">CorePrepEnv -&gt; CorePrepConfig
</span><a href="GHC.CoreToStg.Prep.html#cpe_config"><span class="hs-identifier hs-var hs-var">cpe_config</span></a></span></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepConfig"><span class="hs-identifier hs-type">CorePrepConfig</span></a></span><span>
</span><span id="line-2471"></span><span>        </span><span class="hs-comment">-- ^ This flag is intended to aid in debugging strictness</span><span>
</span><span id="line-2472"></span><span>        </span><span class="hs-comment">-- analysis bugs. These are particularly nasty to chase down as</span><span>
</span><span id="line-2473"></span><span>        </span><span class="hs-comment">-- they may manifest as segmentation faults. When this flag is</span><span>
</span><span id="line-2474"></span><span>        </span><span class="hs-comment">-- enabled we instead produce an 'error' expression to catch</span><span>
</span><span id="line-2475"></span><span>        </span><span class="hs-comment">-- the case where a function we think should bottom</span><span>
</span><span id="line-2476"></span><span>        </span><span class="hs-comment">-- unexpectedly returns.</span><span>
</span><span id="line-2477"></span><span>
</span><span id="line-2478"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="cpe_subst"><span class="annot"><span class="annottext">CorePrepEnv -&gt; Subst
</span><a href="GHC.CoreToStg.Prep.html#cpe_subst"><span class="hs-identifier hs-var hs-var">cpe_subst</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ See Note [CorePrepEnv: cpe_subst]</span></span><span>
</span><span id="line-2479"></span><span>
</span><span id="line-2480"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="cpe_rec_ids"><span class="annot"><span class="annottext">CorePrepEnv -&gt; UnVarSet
</span><a href="GHC.CoreToStg.Prep.html#cpe_rec_ids"><span class="hs-identifier hs-var hs-var">cpe_rec_ids</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Data.Graph.UnVar.html#UnVarSet"><span class="hs-identifier hs-type">UnVarSet</span></a></span><span> </span><span class="hs-comment">-- Faster OutIdSet; See Note [Speculative evaluation]</span><span>
</span><span id="line-2481"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-2482"></span><span>
</span><span id="line-2483"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#mkInitialCorePrepEnv"><span class="hs-identifier hs-type">mkInitialCorePrepEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepConfig"><span class="hs-identifier hs-type">CorePrepConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span>
</span><span id="line-2484"></span><span id="mkInitialCorePrepEnv"><span class="annot"><span class="annottext">mkInitialCorePrepEnv :: CorePrepConfig -&gt; CorePrepEnv
</span><a href="GHC.CoreToStg.Prep.html#mkInitialCorePrepEnv"><span class="hs-identifier hs-var hs-var">mkInitialCorePrepEnv</span></a></span></span><span> </span><span id="local-6989586621682976042"><span class="annot"><span class="annottext">CorePrepConfig
</span><a href="#local-6989586621682976042"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CPE"><span class="hs-identifier hs-type">CPE</span></a></span><span>
</span><span id="line-2485"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cpe_config :: CorePrepConfig
</span><a href="GHC.CoreToStg.Prep.html#cpe_config"><span class="hs-identifier hs-var">cpe_config</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepConfig
</span><a href="#local-6989586621682976042"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-2486"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cpe_subst :: Subst
</span><a href="GHC.CoreToStg.Prep.html#cpe_subst"><span class="hs-identifier hs-var">cpe_subst</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="GHC.Core.TyCo.Subst.html#emptySubst"><span class="hs-identifier hs-var">emptySubst</span></a></span><span>
</span><span id="line-2487"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cpe_rec_ids :: UnVarSet
</span><a href="GHC.CoreToStg.Prep.html#cpe_rec_ids"><span class="hs-identifier hs-var">cpe_rec_ids</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnVarSet
</span><a href="GHC.Data.Graph.UnVar.html#emptyUnVarSet"><span class="hs-identifier hs-var">emptyUnVarSet</span></a></span><span>
</span><span id="line-2488"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-2489"></span><span>
</span><span id="line-2490"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#extendCorePrepEnv"><span class="hs-identifier hs-type">extendCorePrepEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span>
</span><span id="line-2491"></span><span id="extendCorePrepEnv"><span class="annot"><span class="annottext">extendCorePrepEnv :: CorePrepEnv -&gt; InVar -&gt; InVar -&gt; CorePrepEnv
</span><a href="GHC.CoreToStg.Prep.html#extendCorePrepEnv"><span class="hs-identifier hs-var hs-var">extendCorePrepEnv</span></a></span></span><span> </span><span id="local-6989586621682976045"><span class="annot"><span class="annottext">cpe :: CorePrepEnv
</span><a href="#local-6989586621682976045"><span class="hs-identifier hs-var">cpe</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CPE"><span class="hs-identifier hs-type">CPE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cpe_subst :: CorePrepEnv -&gt; Subst
</span><a href="GHC.CoreToStg.Prep.html#cpe_subst"><span class="hs-identifier hs-var">cpe_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682976046"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682976046"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621682976047"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976047"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span id="local-6989586621682976048"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976048"><span class="hs-identifier hs-var">id'</span></a></span></span><span>
</span><span id="line-2492"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682976045"><span class="hs-identifier hs-var">cpe</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpe_subst"><span class="hs-identifier hs-var">cpe_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682976049"><span class="hs-identifier hs-type">subst2</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2493"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-2494"></span><span>      </span><span id="local-6989586621682976050"><span class="annot"><span class="annottext">subst1 :: Subst
</span><a href="#local-6989586621682976050"><span class="hs-identifier hs-var hs-var">subst1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; InVar -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#extendSubstInScope"><span class="hs-identifier hs-var">extendSubstInScope</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682976046"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976048"><span class="hs-identifier hs-var">id'</span></a></span><span>
</span><span id="line-2495"></span><span>      </span><span id="local-6989586621682976049"><span class="annot"><span class="annottext">subst2 :: Subst
</span><a href="#local-6989586621682976049"><span class="hs-identifier hs-var hs-var">subst2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; InVar -&gt; CpeRhs -&gt; Subst
</span><a href="GHC.Core.Subst.html#extendIdSubst"><span class="hs-identifier hs-var">extendIdSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682976050"><span class="hs-identifier hs-var">subst1</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976047"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InVar -&gt; CpeRhs
forall b. InVar -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976048"><span class="hs-identifier hs-var">id'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2496"></span><span>
</span><span id="line-2497"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#extendCorePrepEnvList"><span class="hs-identifier hs-type">extendCorePrepEnvList</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span>
</span><span id="line-2498"></span><span id="extendCorePrepEnvList"><span class="annot"><span class="annottext">extendCorePrepEnvList :: CorePrepEnv -&gt; [(InVar, InVar)] -&gt; CorePrepEnv
</span><a href="GHC.CoreToStg.Prep.html#extendCorePrepEnvList"><span class="hs-identifier hs-var hs-var">extendCorePrepEnvList</span></a></span></span><span> </span><span id="local-6989586621682976053"><span class="annot"><span class="annottext">cpe :: CorePrepEnv
</span><a href="#local-6989586621682976053"><span class="hs-identifier hs-var">cpe</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CPE"><span class="hs-identifier hs-type">CPE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cpe_subst :: CorePrepEnv -&gt; Subst
</span><a href="GHC.CoreToStg.Prep.html#cpe_subst"><span class="hs-identifier hs-var">cpe_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682976054"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682976054"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621682976055"><span class="annot"><span class="annottext">[(InVar, InVar)]
</span><a href="#local-6989586621682976055"><span class="hs-identifier hs-var">prs</span></a></span></span><span>
</span><span id="line-2499"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682976053"><span class="hs-identifier hs-var">cpe</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpe_subst"><span class="hs-identifier hs-var">cpe_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682976056"><span class="hs-identifier hs-type">subst2</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2500"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-2501"></span><span>      </span><span id="local-6989586621682976057"><span class="annot"><span class="annottext">subst1 :: Subst
</span><a href="#local-6989586621682976057"><span class="hs-identifier hs-var hs-var">subst1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; [InVar] -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#extendSubstInScopeList"><span class="hs-identifier hs-var">extendSubstInScopeList</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682976054"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((InVar, InVar) -&gt; InVar) -&gt; [(InVar, InVar)] -&gt; [InVar]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(InVar, InVar) -&gt; InVar
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">[(InVar, InVar)]
</span><a href="#local-6989586621682976055"><span class="hs-identifier hs-var">prs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2502"></span><span>      </span><span id="local-6989586621682976056"><span class="annot"><span class="annottext">subst2 :: Subst
</span><a href="#local-6989586621682976056"><span class="hs-identifier hs-var hs-var">subst2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; [(InVar, CpeRhs)] -&gt; Subst
</span><a href="GHC.Core.Subst.html#extendIdSubstList"><span class="hs-identifier hs-var">extendIdSubstList</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682976057"><span class="hs-identifier hs-var">subst1</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976061"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InVar -&gt; CpeRhs
forall b. InVar -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976062"><span class="hs-identifier hs-var">id'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682976061"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976061"><span class="hs-identifier hs-var">id</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682976062"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976062"><span class="hs-identifier hs-var">id'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(InVar, InVar)]
</span><a href="#local-6989586621682976055"><span class="hs-identifier hs-var">prs</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2503"></span><span>
</span><span id="line-2504"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#extendCorePrepEnvExpr"><span class="hs-identifier hs-type">extendCorePrepEnvExpr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span>
</span><span id="line-2505"></span><span id="extendCorePrepEnvExpr"><span class="annot"><span class="annottext">extendCorePrepEnvExpr :: CorePrepEnv -&gt; InVar -&gt; CpeRhs -&gt; CorePrepEnv
</span><a href="GHC.CoreToStg.Prep.html#extendCorePrepEnvExpr"><span class="hs-identifier hs-var hs-var">extendCorePrepEnvExpr</span></a></span></span><span> </span><span id="local-6989586621682976063"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682976063"><span class="hs-identifier hs-var">cpe</span></a></span></span><span> </span><span id="local-6989586621682976064"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976064"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span id="local-6989586621682976065"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682976065"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-2506"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682976063"><span class="hs-identifier hs-var">cpe</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpe_subst"><span class="hs-identifier hs-var">cpe_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#extendIdSubst"><span class="hs-identifier hs-type">extendIdSubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpe_subst"><span class="hs-identifier hs-var">cpe_subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682976063"><span class="hs-identifier hs-type">cpe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682976064"><span class="hs-identifier hs-type">id</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682976065"><span class="hs-identifier hs-type">expr</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2507"></span><span>
</span><span id="line-2508"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#lookupCorePrepEnv"><span class="hs-identifier hs-type">lookupCorePrepEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-2509"></span><span id="lookupCorePrepEnv"><span class="annot"><span class="annottext">lookupCorePrepEnv :: CorePrepEnv -&gt; InVar -&gt; CpeRhs
</span><a href="GHC.CoreToStg.Prep.html#lookupCorePrepEnv"><span class="hs-identifier hs-var hs-var">lookupCorePrepEnv</span></a></span></span><span> </span><span id="local-6989586621682976066"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682976066"><span class="hs-identifier hs-var">cpe</span></a></span></span><span> </span><span id="local-6989586621682976067"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976067"><span class="hs-identifier hs-var">id</span></a></span></span><span>
</span><span id="line-2510"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; InVar -&gt; Maybe CpeRhs
Subst -&gt; InVar -&gt; Maybe CpeRhs
</span><a href="GHC.Core.Subst.html#lookupIdSubst_maybe"><span class="hs-identifier hs-var">lookupIdSubst_maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Subst
</span><a href="GHC.CoreToStg.Prep.html#cpe_subst"><span class="hs-identifier hs-var">cpe_subst</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682976066"><span class="hs-identifier hs-var">cpe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976067"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2511"></span><span>       </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682976069"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682976069"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682976069"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-2512"></span><span>       </span><span class="annot"><span class="annottext">Maybe CpeRhs
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InVar -&gt; CpeRhs
forall b. InVar -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976067"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-2513"></span><span>    </span><span class="hs-comment">-- Do not use GHC.Core.Subs.lookupIdSubst because that is a no-op on GblIds;</span><span>
</span><span id="line-2514"></span><span>    </span><span class="hs-comment">-- and Tidy has made top-level externally-visible Ids into GblIds</span><span>
</span><span id="line-2515"></span><span>
</span><span id="line-2516"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#enterRecGroupRHSs"><span class="hs-identifier hs-type">enterRecGroupRHSs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span>
</span><span id="line-2517"></span><span id="enterRecGroupRHSs"><span class="annot"><span class="annottext">enterRecGroupRHSs :: CorePrepEnv -&gt; [InVar] -&gt; CorePrepEnv
</span><a href="GHC.CoreToStg.Prep.html#enterRecGroupRHSs"><span class="hs-identifier hs-var hs-var">enterRecGroupRHSs</span></a></span></span><span> </span><span id="local-6989586621682976070"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682976070"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682976071"><span class="annot"><span class="annottext">[InVar]
</span><a href="#local-6989586621682976071"><span class="hs-identifier hs-var">grp</span></a></span></span><span>
</span><span id="line-2518"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682976070"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpe_rec_ids"><span class="hs-identifier hs-var">cpe_rec_ids</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Data.Graph.UnVar.html#extendUnVarSetList"><span class="hs-identifier hs-type">extendUnVarSetList</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682976071"><span class="hs-identifier hs-type">grp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpe_rec_ids"><span class="hs-identifier hs-var">cpe_rec_ids</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682976070"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2519"></span><span>
</span><span id="line-2520"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpSubstTy"><span class="hs-identifier hs-type">cpSubstTy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-2521"></span><span id="cpSubstTy"><span class="annot"><span class="annottext">cpSubstTy :: CorePrepEnv -&gt; Type -&gt; Type
</span><a href="GHC.CoreToStg.Prep.html#cpSubstTy"><span class="hs-identifier hs-var hs-var">cpSubstTy</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CPE"><span class="hs-identifier hs-type">CPE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cpe_subst :: CorePrepEnv -&gt; Subst
</span><a href="GHC.CoreToStg.Prep.html#cpe_subst"><span class="hs-identifier hs-var">cpe_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682976073"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682976073"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621682976074"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682976074"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Type -&gt; Type
Subst -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Subst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682976073"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682976074"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2522"></span><span>          </span><span class="hs-comment">-- substTy has a short-cut if the TCvSubst is empty</span><span>
</span><span id="line-2523"></span><span>
</span><span id="line-2524"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpSubstCo"><span class="hs-identifier hs-type">cpSubstCo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>
</span><span id="line-2525"></span><span id="cpSubstCo"><span class="annot"><span class="annottext">cpSubstCo :: CorePrepEnv -&gt; Coercion -&gt; Coercion
</span><a href="GHC.CoreToStg.Prep.html#cpSubstCo"><span class="hs-identifier hs-var hs-var">cpSubstCo</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CPE"><span class="hs-identifier hs-type">CPE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cpe_subst :: CorePrepEnv -&gt; Subst
</span><a href="GHC.CoreToStg.Prep.html#cpe_subst"><span class="hs-identifier hs-var">cpe_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682976076"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682976076"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621682976077"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682976077"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Coercion -&gt; Coercion
Subst -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.TyCo.Subst.html#substCo"><span class="hs-identifier hs-var">substCo</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682976076"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682976077"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-2526"></span><span>          </span><span class="hs-comment">-- substCo has a short-cut if the TCvSubst is empty</span><span>
</span><span id="line-2527"></span><span>
</span><span id="line-2528"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-2529"></span><span class="hs-comment">-- Cloning binders</span><span>
</span><span id="line-2530"></span><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><span id="line-2531"></span><span>
</span><span id="line-2532"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpCloneBndrs"><span class="hs-identifier hs-type">cpCloneBndrs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#InVar"><span class="hs-identifier hs-type">InVar</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#OutVar"><span class="hs-identifier hs-type">OutVar</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2533"></span><span id="cpCloneBndrs"><span class="annot"><span class="annottext">cpCloneBndrs :: CorePrepEnv -&gt; [InVar] -&gt; UniqSM (CorePrepEnv, [InVar])
</span><a href="GHC.CoreToStg.Prep.html#cpCloneBndrs"><span class="hs-identifier hs-var hs-var">cpCloneBndrs</span></a></span></span><span> </span><span id="local-6989586621682976080"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682976080"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682976081"><span class="annot"><span class="annottext">[InVar]
</span><a href="#local-6989586621682976081"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CorePrepEnv -&gt; InVar -&gt; UniqSM (CorePrepEnv, InVar))
-&gt; CorePrepEnv -&gt; [InVar] -&gt; UniqSM (CorePrepEnv, [InVar])
forall (m :: * -&gt; *) (t :: * -&gt; *) acc x y.
(Monad m, Traversable t) =&gt;
(acc -&gt; x -&gt; m (acc, y)) -&gt; acc -&gt; t x -&gt; m (acc, t y)
</span><a href="GHC.Utils.Monad.html#mapAccumLM"><span class="hs-identifier hs-var">mapAccumLM</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; InVar -&gt; UniqSM (CorePrepEnv, InVar)
</span><a href="GHC.CoreToStg.Prep.html#cpCloneBndr"><span class="hs-identifier hs-var">cpCloneBndr</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682976080"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[InVar]
</span><a href="#local-6989586621682976081"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-2534"></span><span>
</span><span id="line-2535"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpCloneCoVarBndr"><span class="hs-identifier hs-type">cpCloneCoVarBndr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InVar"><span class="hs-identifier hs-type">InVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutVar"><span class="hs-identifier hs-type">OutVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2536"></span><span class="hs-comment">-- Clone the CoVar</span><span>
</span><span id="line-2537"></span><span class="hs-comment">-- See Note [Cloning CoVars and TyVars]</span><span>
</span><span id="line-2538"></span><span id="cpCloneCoVarBndr"><span class="annot"><span class="annottext">cpCloneCoVarBndr :: CorePrepEnv -&gt; InVar -&gt; UniqSM (CorePrepEnv, InVar)
</span><a href="GHC.CoreToStg.Prep.html#cpCloneCoVarBndr"><span class="hs-identifier hs-var hs-var">cpCloneCoVarBndr</span></a></span></span><span> </span><span id="local-6989586621682976082"><span class="annot"><span class="annottext">env :: CorePrepEnv
</span><a href="#local-6989586621682976082"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CPE"><span class="hs-identifier hs-type">CPE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cpe_subst :: CorePrepEnv -&gt; Subst
</span><a href="GHC.CoreToStg.Prep.html#cpe_subst"><span class="hs-identifier hs-var">cpe_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682976083"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682976083"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621682976084"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976084"><span class="hs-identifier hs-var">covar</span></a></span></span><span>
</span><span id="line-2539"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; SDoc
-&gt; UniqSM (CorePrepEnv, InVar)
-&gt; UniqSM (CorePrepEnv, InVar)
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976084"><span class="hs-identifier hs-var">covar</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InVar -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976084"><span class="hs-identifier hs-var">covar</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(UniqSM (CorePrepEnv, InVar) -&gt; UniqSM (CorePrepEnv, InVar))
-&gt; UniqSM (CorePrepEnv, InVar) -&gt; UniqSM (CorePrepEnv, InVar)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2540"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682976086"><span class="annot"><a href="#local-6989586621682976086"><span class="hs-identifier hs-var">uniq</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UniqSM Unique
forall (m :: * -&gt; *). MonadUnique m =&gt; m Unique
</span><a href="GHC.Types.Unique.Supply.html#getUniqueM"><span class="hs-identifier hs-var">getUniqueM</span></a></span><span>
</span><span id="line-2541"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682976088"><span class="annot"><a href="#local-6989586621682976088"><span class="hs-identifier hs-var hs-var">covar1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InVar -&gt; Unique -&gt; InVar
</span><a href="GHC.Types.Var.html#setVarUnique"><span class="hs-identifier hs-var">setVarUnique</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976084"><span class="hs-identifier hs-var">covar</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682976086"><span class="hs-identifier hs-var">uniq</span></a></span><span>
</span><span id="line-2542"></span><span>             </span><span id="local-6989586621682976090"><span class="annot"><a href="#local-6989586621682976090"><span class="hs-identifier hs-var hs-var">covar2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Type) -&gt; InVar -&gt; InVar
</span><a href="GHC.Types.Var.html#updateVarType"><span class="hs-identifier hs-var">updateVarType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Type -&gt; Type
Subst -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Subst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682976083"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976088"><span class="hs-identifier hs-var">covar1</span></a></span><span>
</span><span id="line-2543"></span><span>             </span><span id="local-6989586621682976092"><span class="annot"><a href="#local-6989586621682976092"><span class="hs-identifier hs-var hs-var">subst1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; InVar -&gt; InVar -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#extendTCvSubstWithClone"><span class="hs-identifier hs-var">extendTCvSubstWithClone</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682976083"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976084"><span class="hs-identifier hs-var">covar</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976090"><span class="hs-identifier hs-var">covar2</span></a></span><span>
</span><span id="line-2544"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682976082"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpe_subst"><span class="hs-identifier hs-var">cpe_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682976092"><span class="hs-identifier hs-type">subst1</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682976090"><span class="hs-identifier hs-type">covar2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2545"></span><span>
</span><span id="line-2546"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpCloneBndr"><span class="hs-identifier hs-type">cpCloneBndr</span></a></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InVar"><span class="hs-identifier hs-type">InVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutVar"><span class="hs-identifier hs-type">OutVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2547"></span><span class="hs-comment">-- See Note [Cloning in CorePrep]</span><span>
</span><span id="line-2548"></span><span id="cpCloneBndr"><span class="annot"><span class="annottext">cpCloneBndr :: CorePrepEnv -&gt; InVar -&gt; UniqSM (CorePrepEnv, InVar)
</span><a href="GHC.CoreToStg.Prep.html#cpCloneBndr"><span class="hs-identifier hs-var hs-var">cpCloneBndr</span></a></span></span><span> </span><span id="local-6989586621682976094"><span class="annot"><span class="annottext">env :: CorePrepEnv
</span><a href="#local-6989586621682976094"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CPE"><span class="hs-identifier hs-type">CPE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cpe_subst :: CorePrepEnv -&gt; Subst
</span><a href="GHC.CoreToStg.Prep.html#cpe_subst"><span class="hs-identifier hs-var">cpe_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682976095"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682976095"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621682976096"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976096"><span class="hs-identifier hs-var">bndr</span></a></span></span><span>
</span><span id="line-2549"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">InVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyCoVar"><span class="hs-identifier hs-var">isTyCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976096"><span class="hs-identifier hs-var">bndr</span></a></span><span>  </span><span class="hs-comment">-- See Note [Cloning CoVars and TyVars]</span><span>
</span><span id="line-2550"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Bool
</span><a href="GHC.Core.TyCo.Subst.html#isEmptyTCvSubst"><span class="hs-identifier hs-var">isEmptyTCvSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682976095"><span class="hs-identifier hs-var">subst</span></a></span><span>    </span><span class="hs-comment">-- The common case</span><span>
</span><span id="line-2551"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">(CorePrepEnv, InVar) -&gt; UniqSM (CorePrepEnv, InVar)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682976094"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpe_subst"><span class="hs-identifier hs-var">cpe_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#extendSubstInScope"><span class="hs-identifier hs-type">extendSubstInScope</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682976095"><span class="hs-identifier hs-type">subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682976096"><span class="hs-identifier hs-type">bndr</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976096"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2552"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-comment">-- No need to clone the Unique; but we must apply the substitution</span><span>
</span><span id="line-2553"></span><span>         </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682976099"><span class="annot"><span class="annottext">bndr1 :: InVar
</span><a href="#local-6989586621682976099"><span class="hs-identifier hs-var hs-var">bndr1</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Type) -&gt; InVar -&gt; InVar
</span><a href="GHC.Types.Var.html#updateVarType"><span class="hs-identifier hs-var">updateVarType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Type -&gt; Type
Subst -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Subst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682976095"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976096"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-2554"></span><span>             </span><span id="local-6989586621682976100"><span class="annot"><span class="annottext">subst1 :: Subst
</span><a href="#local-6989586621682976100"><span class="hs-identifier hs-var hs-var">subst1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; InVar -&gt; InVar -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#extendTCvSubstWithClone"><span class="hs-identifier hs-var">extendTCvSubstWithClone</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682976095"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976096"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976099"><span class="hs-identifier hs-var">bndr1</span></a></span><span>
</span><span id="line-2555"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(CorePrepEnv, InVar) -&gt; UniqSM (CorePrepEnv, InVar)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682976094"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpe_subst"><span class="hs-identifier hs-var">cpe_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682976100"><span class="hs-identifier hs-type">subst1</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976099"><span class="hs-identifier hs-var">bndr1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2556"></span><span>
</span><span id="line-2557"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>  </span><span class="hs-comment">-- A non-CoVar Id</span><span>
</span><span id="line-2558"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682976101"><span class="annot"><a href="#local-6989586621682976101"><span class="hs-identifier hs-var">bndr1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InVar -&gt; UniqSM InVar
forall {m :: * -&gt; *}. MonadUnique m =&gt; InVar -&gt; m InVar
</span><a href="#local-6989586621682976102"><span class="hs-identifier hs-var">clone_it</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976096"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-2559"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682976103"><span class="annot"><a href="#local-6989586621682976103"><span class="hs-identifier hs-var hs-var">bndr2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Type) -&gt; InVar -&gt; InVar
</span><a href="GHC.Types.Var.html#updateIdTypeAndMult"><span class="hs-identifier hs-var">updateIdTypeAndMult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Type -&gt; Type
Subst -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Subst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682976095"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976101"><span class="hs-identifier hs-var">bndr1</span></a></span><span>
</span><span id="line-2560"></span><span>
</span><span id="line-2561"></span><span>       </span><span class="hs-comment">-- Drop (now-useless) rules/unfoldings</span><span>
</span><span id="line-2562"></span><span>       </span><span class="hs-comment">-- See Note [Drop unfoldings and rules]</span><span>
</span><span id="line-2563"></span><span>       </span><span class="hs-comment">-- and Note [Preserve evaluatedness] in GHC.Core.Tidy</span><span>
</span><span id="line-2564"></span><span>       </span><span class="hs-comment">-- And force it.. otherwise the old unfolding is just retained.</span><span>
</span><span id="line-2565"></span><span>       </span><span class="hs-comment">-- See #22071</span><span>
</span><span id="line-2566"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682976105"><span class="annot"><a href="#local-6989586621682976105"><span class="hs-identifier hs-var hs-var">unfolding'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; Unfolding
</span><a href="GHC.Types.Id.Info.html#trimUnfolding"><span class="hs-identifier hs-var">trimUnfolding</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InVar -&gt; Unfolding
</span><a href="GHC.Types.Id.html#realIdUnfolding"><span class="hs-identifier hs-var">realIdUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976096"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2567"></span><span>                          </span><span class="hs-comment">-- Simplifier will set the Id's unfolding</span><span>
</span><span id="line-2568"></span><span>
</span><span id="line-2569"></span><span>             </span><span id="local-6989586621682976108"><span class="annot"><a href="#local-6989586621682976108"><span class="hs-identifier hs-var hs-var">bndr3</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976103"><span class="hs-identifier hs-var">bndr2</span></a></span><span> </span><span class="annot"><span class="annottext">InVar -&gt; Unfolding -&gt; InVar
</span><a href="GHC.Types.Id.html#setIdUnfolding"><span class="hs-operator hs-var">`setIdUnfolding`</span></a></span><span>      </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682976105"><span class="hs-identifier hs-var">unfolding'</span></a></span><span>
</span><span id="line-2570"></span><span>                           </span><span class="annot"><span class="annottext">InVar -&gt; RuleInfo -&gt; InVar
</span><a href="GHC.Types.Id.html#setIdSpecialisation"><span class="hs-operator hs-var">`setIdSpecialisation`</span></a></span><span> </span><span class="annot"><span class="annottext">RuleInfo
</span><a href="GHC.Types.Id.Info.html#emptyRuleInfo"><span class="hs-identifier hs-var">emptyRuleInfo</span></a></span><span>
</span><span id="line-2571"></span><span>
</span><span id="line-2572"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#extendCorePrepEnv"><span class="hs-identifier hs-type">extendCorePrepEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682976094"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682976096"><span class="hs-identifier hs-type">bndr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682976108"><span class="hs-identifier hs-type">bndr3</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682976108"><span class="hs-identifier hs-type">bndr3</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2573"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2574"></span><span>    </span><span id="local-6989586621682976102"><span class="annot"><span class="annottext">clone_it :: InVar -&gt; m InVar
</span><a href="#local-6989586621682976102"><span class="hs-identifier hs-var hs-var">clone_it</span></a></span></span><span> </span><span id="local-6989586621682976127"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976127"><span class="hs-identifier hs-var">bndr</span></a></span></span><span>
</span><span id="line-2575"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">InVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isLocalId"><span class="hs-identifier hs-var">isLocalId</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976127"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-2576"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682976129"><span class="annot"><a href="#local-6989586621682976129"><span class="hs-identifier hs-var">uniq</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m Unique
forall (m :: * -&gt; *). MonadUnique m =&gt; m Unique
</span><a href="GHC.Types.Unique.Supply.html#getUniqueM"><span class="hs-identifier hs-var">getUniqueM</span></a></span><span>
</span><span id="line-2577"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#setVarUnique"><span class="hs-identifier hs-type">setVarUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682976127"><span class="hs-identifier hs-type">bndr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682976129"><span class="hs-identifier hs-type">uniq</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2578"></span><span>
</span><span id="line-2579"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>   </span><span class="hs-comment">-- Top level things, which we don't want</span><span>
</span><span id="line-2580"></span><span>                    </span><span class="hs-comment">-- to clone, have become GlobalIds by now</span><span>
</span><span id="line-2581"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InVar -&gt; m InVar
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976127"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-2582"></span><span>
</span><span id="line-2583"></span><span class="hs-comment">{- Note [Drop unfoldings and rules]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We want to drop the unfolding/rules on every Id:

  - We are now past interface-file generation, and in the
    codegen pipeline, so we really don't need full unfoldings/rules

  - The unfolding/rule may be keeping stuff alive that we'd like
    to discard.  See  Note [Dead code in CorePrep]

  - Getting rid of unnecessary unfoldings reduces heap usage

  - We are changing uniques, so if we didn't discard unfoldings/rules
    we'd have to substitute in them

HOWEVER, we want to preserve evaluated-ness;
see Note [Preserve evaluatedness] in GHC.Core.Tidy.
-}</span><span>
</span><span id="line-2601"></span><span>
</span><span id="line-2602"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-2603"></span><span class="hs-comment">-- Cloning ccall Ids; each must have a unique name,</span><span>
</span><span id="line-2604"></span><span class="hs-comment">-- to give the code generator a handle to hang it on</span><span>
</span><span id="line-2605"></span><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><span id="line-2606"></span><span>
</span><span id="line-2607"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#fiddleCCall"><span class="hs-identifier hs-type">fiddleCCall</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>
</span><span id="line-2608"></span><span id="fiddleCCall"><span class="annot"><span class="annottext">fiddleCCall :: InVar -&gt; UniqSM InVar
</span><a href="GHC.CoreToStg.Prep.html#fiddleCCall"><span class="hs-identifier hs-var hs-var">fiddleCCall</span></a></span></span><span> </span><span id="local-6989586621682976130"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976130"><span class="hs-identifier hs-var">id</span></a></span></span><span>
</span><span id="line-2609"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">InVar -&gt; Bool
</span><a href="GHC.Types.Id.html#isFCallId"><span class="hs-identifier hs-var">isFCallId</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976130"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976130"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">InVar -&gt; Unique -&gt; InVar
</span><a href="GHC.Types.Var.html#setVarUnique"><span class="hs-operator hs-var">`setVarUnique`</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Unique -&gt; InVar) -&gt; UniqSM Unique -&gt; UniqSM InVar
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">UniqSM Unique
forall (m :: * -&gt; *). MonadUnique m =&gt; m Unique
</span><a href="GHC.Types.Unique.Supply.html#getUniqueM"><span class="hs-identifier hs-var">getUniqueM</span></a></span><span>
</span><span id="line-2610"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InVar -&gt; UniqSM InVar
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976130"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-2611"></span><span>
</span><span id="line-2612"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-2613"></span><span class="hs-comment">-- Generating new binders</span><span>
</span><span id="line-2614"></span><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><span id="line-2615"></span><span>
</span><span id="line-2616"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#newVar"><span class="hs-identifier hs-type">newVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>
</span><span id="line-2617"></span><span id="newVar"><span class="annot"><span class="annottext">newVar :: Type -&gt; UniqSM InVar
</span><a href="GHC.CoreToStg.Prep.html#newVar"><span class="hs-identifier hs-var hs-var">newVar</span></a></span></span><span> </span><span id="local-6989586621682976132"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682976132"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-2618"></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; ()
</span><a href="GHC.Core.Type.html#seqType"><span class="hs-identifier hs-var">seqType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682976132"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">() -&gt; UniqSM InVar -&gt; UniqSM InVar
forall a b. a -&gt; b -&gt; b
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="annot"><span class="annottext">FastString -&gt; Type -&gt; Type -&gt; UniqSM InVar
forall (m :: * -&gt; *).
MonadUnique m =&gt;
FastString -&gt; Type -&gt; Type -&gt; m InVar
</span><a href="GHC.Types.Id.html#mkSysLocalOrCoVarM"><span class="hs-identifier hs-var">mkSysLocalOrCoVarM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; FastString
</span><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;sat&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Core.Type.html#ManyTy"><span class="hs-identifier hs-var">ManyTy</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682976132"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2619"></span><span>
</span><span id="line-2620"></span><span>
</span><span id="line-2621"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-2622"></span><span class="hs-comment">-- Floating ticks</span><span>
</span><span id="line-2623"></span><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><span id="line-2624"></span><span class="hs-comment">--</span><span>
</span><span id="line-2625"></span><span class="hs-comment">-- Note [Floating Ticks in CorePrep]</span><span>
</span><span id="line-2626"></span><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><span id="line-2627"></span><span class="hs-comment">-- It might seem counter-intuitive to float ticks by default, given</span><span>
</span><span id="line-2628"></span><span class="hs-comment">-- that we don't actually want to move them if we can help it. On the</span><span>
</span><span id="line-2629"></span><span class="hs-comment">-- other hand, nothing gets very far in CorePrep anyway, and we want</span><span>
</span><span id="line-2630"></span><span class="hs-comment">-- to preserve the order of let bindings and tick annotations in</span><span>
</span><span id="line-2631"></span><span class="hs-comment">-- relation to each other. For example, if we just wrapped let floats</span><span>
</span><span id="line-2632"></span><span class="hs-comment">-- when they pass through ticks, we might end up performing the</span><span>
</span><span id="line-2633"></span><span class="hs-comment">-- following transformation:</span><span>
</span><span id="line-2634"></span><span class="hs-comment">--</span><span>
</span><span id="line-2635"></span><span class="hs-comment">--   src&lt;...&gt; let foo = bar in baz</span><span>
</span><span id="line-2636"></span><span class="hs-comment">--   ==&gt;  let foo = src&lt;...&gt; bar in src&lt;...&gt; baz</span><span>
</span><span id="line-2637"></span><span class="hs-comment">--</span><span>
</span><span id="line-2638"></span><span class="hs-comment">-- Because the let-binding would float through the tick, and then</span><span>
</span><span id="line-2639"></span><span class="hs-comment">-- immediately materialize, achieving nothing but decreasing tick</span><span>
</span><span id="line-2640"></span><span class="hs-comment">-- accuracy. The only special case is the following scenario:</span><span>
</span><span id="line-2641"></span><span class="hs-comment">--</span><span>
</span><span id="line-2642"></span><span class="hs-comment">--   let foo = src&lt;...&gt; (let a = b in bar) in baz</span><span>
</span><span id="line-2643"></span><span class="hs-comment">--   ==&gt;  let foo = src&lt;...&gt; bar; a = src&lt;...&gt; b in baz</span><span>
</span><span id="line-2644"></span><span class="hs-comment">--</span><span>
</span><span id="line-2645"></span><span class="hs-comment">-- Here we would not want the source tick to end up covering &quot;baz&quot; and</span><span>
</span><span id="line-2646"></span><span class="hs-comment">-- therefore refrain from pushing ticks outside. Instead, we copy them</span><span>
</span><span id="line-2647"></span><span class="hs-comment">-- into the floating binds (here &quot;a&quot;) in cpePair. Note that where &quot;b&quot;</span><span>
</span><span id="line-2648"></span><span class="hs-comment">-- or &quot;bar&quot; are (value) lambdas we have to push the annotations</span><span>
</span><span id="line-2649"></span><span class="hs-comment">-- further inside in order to uphold our rules.</span><span>
</span><span id="line-2650"></span><span class="hs-comment">--</span><span>
</span><span id="line-2651"></span><span class="hs-comment">-- All of this is implemented below in @wrapTicks@.</span><span>
</span><span id="line-2652"></span><span>
</span><span id="line-2653"></span><span class="annot"><span class="hs-comment">-- | Like wrapFloats, but only wraps tick floats</span></span><span>
</span><span id="line-2654"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#wrapTicks"><span class="hs-identifier hs-type">wrapTicks</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2655"></span><span id="wrapTicks"><span class="annot"><span class="annottext">wrapTicks :: Floats -&gt; CpeRhs -&gt; (Floats, CpeRhs)
</span><a href="GHC.CoreToStg.Prep.html#wrapTicks"><span class="hs-identifier hs-var hs-var">wrapTicks</span></a></span></span><span> </span><span id="local-6989586621682976137"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682976137"><span class="hs-identifier hs-var">floats</span></a></span></span><span> </span><span id="local-6989586621682976138"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682976138"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-2656"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682976139"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682976139"><span class="hs-identifier hs-var">floats1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682976140"><span class="annot"><span class="annottext">OrdList CoreTickish
</span><a href="#local-6989586621682976140"><span class="hs-identifier hs-var">ticks1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((OrdList FloatingBind, OrdList CoreTickish)
 -&gt; FloatingBind -&gt; (OrdList FloatingBind, OrdList CoreTickish))
-&gt; Floats -&gt; (Floats, OrdList CoreTickish)
forall {a}.
((OrdList FloatingBind, OrdList a)
 -&gt; FloatingBind -&gt; (OrdList FloatingBind, OrdList a))
-&gt; Floats -&gt; (Floats, OrdList a)
</span><a href="#local-6989586621682976141"><span class="hs-identifier hs-var">fold_fun</span></a></span><span> </span><span class="annot"><span class="annottext">(OrdList FloatingBind, OrdList CoreTickish)
-&gt; FloatingBind -&gt; (OrdList FloatingBind, OrdList CoreTickish)
</span><a href="#local-6989586621682976142"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682976137"><span class="hs-identifier hs-var">floats</span></a></span><span>
</span><span id="line-2657"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682976139"><span class="hs-identifier hs-var">floats1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(CoreTickish -&gt; CpeRhs -&gt; CpeRhs)
-&gt; CpeRhs -&gt; OrdList CoreTickish -&gt; CpeRhs
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; OrdList a -&gt; b
</span><a href="GHC.Data.OrdList.html#foldrOL"><span class="hs-identifier hs-var">foldrOL</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; CpeRhs -&gt; CpeRhs
</span><a href="GHC.Core.Utils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682976138"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList CoreTickish
</span><a href="#local-6989586621682976140"><span class="hs-identifier hs-var">ticks1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2658"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621682976141"><span class="annot"><span class="annottext">fold_fun :: ((OrdList FloatingBind, OrdList a)
 -&gt; FloatingBind -&gt; (OrdList FloatingBind, OrdList a))
-&gt; Floats -&gt; (Floats, OrdList a)
</span><a href="#local-6989586621682976141"><span class="hs-identifier hs-var hs-var">fold_fun</span></a></span></span><span> </span><span id="local-6989586621682976143"><span class="annot"><span class="annottext">(OrdList FloatingBind, OrdList a)
-&gt; FloatingBind -&gt; (OrdList FloatingBind, OrdList a)
</span><a href="#local-6989586621682976143"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621682976144"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682976144"><span class="hs-identifier hs-var">floats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2659"></span><span>           </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682976145"><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621682976145"><span class="hs-identifier hs-var">binds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682976146"><span class="annot"><span class="annottext">OrdList a
</span><a href="#local-6989586621682976146"><span class="hs-identifier hs-var">ticks</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((OrdList FloatingBind, OrdList a)
 -&gt; FloatingBind -&gt; (OrdList FloatingBind, OrdList a))
-&gt; (OrdList FloatingBind, OrdList a)
-&gt; OrdList FloatingBind
-&gt; (OrdList FloatingBind, OrdList a)
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; OrdList a -&gt; b
</span><a href="GHC.Data.OrdList.html#foldlOL"><span class="hs-identifier hs-var">foldlOL</span></a></span><span> </span><span class="annot"><span class="annottext">(OrdList FloatingBind, OrdList a)
-&gt; FloatingBind -&gt; (OrdList FloatingBind, OrdList a)
</span><a href="#local-6989586621682976143"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OrdList FloatingBind
forall a. OrdList a
</span><a href="GHC.Data.OrdList.html#nilOL"><span class="hs-identifier hs-var">nilOL</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">OrdList a
forall a. OrdList a
</span><a href="GHC.Data.OrdList.html#nilOL"><span class="hs-identifier hs-var">nilOL</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats -&gt; OrdList FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#fs_binds"><span class="hs-identifier hs-var">fs_binds</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682976144"><span class="hs-identifier hs-var">floats</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2660"></span><span>           </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621682976144"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#fs_binds"><span class="hs-identifier hs-var">fs_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682976145"><span class="hs-identifier hs-type">binds</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OrdList a
</span><a href="#local-6989586621682976146"><span class="hs-identifier hs-var">ticks</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2661"></span><span>        </span><span class="hs-comment">-- Deeply nested constructors will produce long lists of</span><span>
</span><span id="line-2662"></span><span>        </span><span class="hs-comment">-- redundant source note floats here. We need to eliminate</span><span>
</span><span id="line-2663"></span><span>        </span><span class="hs-comment">-- those early, as relying on mkTick to spot it after the fact</span><span>
</span><span id="line-2664"></span><span>        </span><span class="hs-comment">-- can yield O(n^3) complexity [#11095]</span><span>
</span><span id="line-2665"></span><span>        </span><span id="local-6989586621682976142"><span class="annot"><span class="annottext">go :: (OrdList FloatingBind, OrdList CoreTickish)
-&gt; FloatingBind -&gt; (OrdList FloatingBind, OrdList CoreTickish)
</span><a href="#local-6989586621682976142"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682976155"><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621682976155"><span class="hs-identifier hs-var">flt_binds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682976156"><span class="annot"><span class="annottext">OrdList CoreTickish
</span><a href="#local-6989586621682976156"><span class="hs-identifier hs-var">ticks</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatTick"><span class="hs-identifier hs-type">FloatTick</span></a></span><span> </span><span id="local-6989586621682976157"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682976157"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2666"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; (OrdList FloatingBind, OrdList CoreTickish)
-&gt; (OrdList FloatingBind, OrdList CoreTickish)
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; TickishPlacement
forall (pass :: TickishPass). GenTickish pass -&gt; TickishPlacement
</span><a href="GHC.Types.Tickish.html#tickishPlace"><span class="hs-identifier hs-var">tickishPlace</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682976157"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">TickishPlacement -&gt; TickishPlacement -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TickishPlacement
</span><a href="GHC.Types.Tickish.html#PlaceNonLam"><span class="hs-identifier hs-var">PlaceNonLam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2667"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621682976155"><span class="hs-identifier hs-var">flt_binds</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">(CoreTickish -&gt; Bool) -&gt; OrdList CoreTickish -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CoreTickish -&gt; CoreTickish -&gt; Bool)
-&gt; CoreTickish -&gt; CoreTickish -&gt; Bool
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; CoreTickish -&gt; Bool
forall (pass :: TickishPass).
Eq (GenTickish pass) =&gt;
GenTickish pass -&gt; GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishContains"><span class="hs-identifier hs-var">tickishContains</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682976157"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OrdList CoreTickish
</span><a href="#local-6989586621682976156"><span class="hs-identifier hs-var">ticks</span></a></span><span>
</span><span id="line-2668"></span><span>                        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">OrdList CoreTickish
</span><a href="#local-6989586621682976156"><span class="hs-identifier hs-var">ticks</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">OrdList CoreTickish
</span><a href="#local-6989586621682976156"><span class="hs-identifier hs-var">ticks</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList CoreTickish -&gt; CoreTickish -&gt; OrdList CoreTickish
forall a. OrdList a -&gt; a -&gt; OrdList a
</span><a href="GHC.Data.OrdList.html#snocOL"><span class="hs-operator hs-var">`snocOL`</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682976157"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2669"></span><span>        </span><span class="annot"><a href="#local-6989586621682976142"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682976161"><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621682976161"><span class="hs-identifier hs-var">flt_binds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682976162"><span class="annot"><span class="annottext">OrdList CoreTickish
</span><a href="#local-6989586621682976162"><span class="hs-identifier hs-var">ticks</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682976163"><span class="annot"><span class="annottext">f :: FloatingBind
</span><a href="#local-6989586621682976163"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#UnsafeEqualityCase"><span class="hs-identifier hs-type">UnsafeEqualityCase</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>
</span><span id="line-2670"></span><span>          </span><span class="hs-comment">-- unsafe equality case will be erased; don't wrap anything!</span><span>
</span><span id="line-2671"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621682976161"><span class="hs-identifier hs-var">flt_binds</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind -&gt; FloatingBind -&gt; OrdList FloatingBind
forall a. OrdList a -&gt; a -&gt; OrdList a
</span><a href="GHC.Data.OrdList.html#snocOL"><span class="hs-operator hs-var">`snocOL`</span></a></span><span> </span><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621682976163"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OrdList CoreTickish
</span><a href="#local-6989586621682976162"><span class="hs-identifier hs-var">ticks</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2672"></span><span>        </span><span class="annot"><a href="#local-6989586621682976142"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682976164"><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621682976164"><span class="hs-identifier hs-var">flt_binds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682976165"><span class="annot"><span class="annottext">OrdList CoreTickish
</span><a href="#local-6989586621682976165"><span class="hs-identifier hs-var">ticks</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682976166"><span class="annot"><span class="annottext">f :: FloatingBind
</span><a href="#local-6989586621682976166"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Float"><span class="hs-identifier hs-type">Float</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>
</span><span id="line-2673"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621682976164"><span class="hs-identifier hs-var">flt_binds</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind -&gt; FloatingBind -&gt; OrdList FloatingBind
forall a. OrdList a -&gt; a -&gt; OrdList a
</span><a href="GHC.Data.OrdList.html#snocOL"><span class="hs-operator hs-var">`snocOL`</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreTickish -&gt; FloatingBind -&gt; FloatingBind)
-&gt; FloatingBind -&gt; OrdList CoreTickish -&gt; FloatingBind
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; OrdList a -&gt; b
</span><a href="GHC.Data.OrdList.html#foldrOL"><span class="hs-identifier hs-var">foldrOL</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; FloatingBind -&gt; FloatingBind
</span><a href="#local-6989586621682976167"><span class="hs-identifier hs-var">wrap</span></a></span><span> </span><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621682976166"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList CoreTickish
</span><a href="#local-6989586621682976165"><span class="hs-identifier hs-var">ticks</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OrdList CoreTickish
</span><a href="#local-6989586621682976165"><span class="hs-identifier hs-var">ticks</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2674"></span><span>
</span><span id="line-2675"></span><span>        </span><span id="local-6989586621682976167"><span class="annot"><span class="annottext">wrap :: CoreTickish -&gt; FloatingBind -&gt; FloatingBind
</span><a href="#local-6989586621682976167"><span class="hs-identifier hs-var hs-var">wrap</span></a></span></span><span> </span><span id="local-6989586621682976171"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682976171"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Float"><span class="hs-identifier hs-type">Float</span></a></span><span> </span><span id="local-6989586621682976172"><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682976172"><span class="hs-identifier hs-var">bind</span></a></span></span><span> </span><span id="local-6989586621682976173"><span class="annot"><span class="annottext">BindInfo
</span><a href="#local-6989586621682976173"><span class="hs-identifier hs-var">bound</span></a></span></span><span> </span><span id="local-6989586621682976174"><span class="annot"><span class="annottext">FloatInfo
</span><a href="#local-6989586621682976174"><span class="hs-identifier hs-var">info</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBind -&gt; BindInfo -&gt; FloatInfo -&gt; FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#Float"><span class="hs-identifier hs-var">Float</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; CoreBind -&gt; CoreBind
</span><a href="#local-6989586621682976175"><span class="hs-identifier hs-var">wrapBind</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682976171"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682976172"><span class="hs-identifier hs-var">bind</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">BindInfo
</span><a href="#local-6989586621682976173"><span class="hs-identifier hs-var">bound</span></a></span><span> </span><span class="annot"><span class="annottext">FloatInfo
</span><a href="#local-6989586621682976174"><span class="hs-identifier hs-var">info</span></a></span><span>
</span><span id="line-2676"></span><span>        </span><span class="annot"><a href="#local-6989586621682976167"><span class="hs-identifier hs-var">wrap</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682976176"><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621682976176"><span class="hs-identifier hs-var">f</span></a></span></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; FloatingBind
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Unexpected FloatingBind&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FloatingBind -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621682976176"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2677"></span><span>        </span><span id="local-6989586621682976175"><span class="annot"><span class="annottext">wrapBind :: CoreTickish -&gt; CoreBind -&gt; CoreBind
</span><a href="#local-6989586621682976175"><span class="hs-identifier hs-var hs-var">wrapBind</span></a></span></span><span> </span><span id="local-6989586621682976179"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682976179"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span id="local-6989586621682976180"><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976180"><span class="hs-identifier hs-var">binder</span></a></span></span><span> </span><span id="local-6989586621682976181"><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682976181"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InVar -&gt; CpeRhs -&gt; CoreBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976180"><span class="hs-identifier hs-var">binder</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; CpeRhs -&gt; CpeRhs
</span><a href="GHC.Core.Utils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682976179"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682976181"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2678"></span><span>        </span><span class="annot"><a href="#local-6989586621682976175"><span class="hs-identifier hs-var">wrapBind</span></a></span><span> </span><span id="local-6989586621682976182"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682976182"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span id="local-6989586621682976183"><span class="annot"><span class="annottext">[(InVar, CpeRhs)]
</span><a href="#local-6989586621682976183"><span class="hs-identifier hs-var">pairs</span></a></span></span><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(InVar, CpeRhs)] -&gt; CoreBind
forall b. [(b, Expr b)] -&gt; Bind b
</span><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-var">Rec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CpeRhs -&gt; CpeRhs) -&gt; [(InVar, CpeRhs)] -&gt; [(InVar, CpeRhs)]
forall (f :: * -&gt; *) b c a.
Functor f =&gt;
(b -&gt; c) -&gt; f (a, b) -&gt; f (a, c)
</span><a href="GHC.Utils.Misc.html#mapSnd"><span class="hs-identifier hs-var">mapSnd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; CpeRhs -&gt; CpeRhs
</span><a href="GHC.Core.Utils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682976182"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(InVar, CpeRhs)]
</span><a href="#local-6989586621682976183"><span class="hs-identifier hs-var">pairs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2679"></span><span>
</span><span id="line-2680"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-2681"></span><span class="hs-comment">-- Numeric literals</span><span>
</span><span id="line-2682"></span><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><span id="line-2683"></span><span>
</span><span id="line-2684"></span><span class="annot"><span class="hs-comment">-- | Converts Bignum literals into their final CoreExpr</span></span><span>
</span><span id="line-2685"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeBigNatLit"><span class="hs-identifier hs-type">cpeBigNatLit</span></a></span><span>
</span><span id="line-2686"></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Integer</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2687"></span><span id="cpeBigNatLit"><span class="annot"><span class="annottext">cpeBigNatLit :: CorePrepEnv -&gt; Integer -&gt; UniqSM (Floats, CpeRhs)
</span><a href="GHC.CoreToStg.Prep.html#cpeBigNatLit"><span class="hs-identifier hs-var hs-var">cpeBigNatLit</span></a></span></span><span> </span><span id="local-6989586621682976185"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682976185"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682976186"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621682976186"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; UniqSM (Floats, CpeRhs) -&gt; UniqSM (Floats, CpeRhs)
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621682976186"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(UniqSM (Floats, CpeRhs) -&gt; UniqSM (Floats, CpeRhs))
-&gt; UniqSM (Floats, CpeRhs) -&gt; UniqSM (Floats, CpeRhs)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2688"></span><span>  </span><span class="hs-keyword">let</span><span>
</span><span id="line-2689"></span><span>    </span><span id="local-6989586621682976187"><span class="annot"><span class="annottext">platform :: Platform
</span><a href="#local-6989586621682976187"><span class="hs-identifier hs-var hs-var hs-var">platform</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepConfig -&gt; Platform
</span><a href="GHC.CoreToStg.Prep.html#cp_platform"><span class="hs-identifier hs-var">cp_platform</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CorePrepConfig
</span><a href="GHC.CoreToStg.Prep.html#cpe_config"><span class="hs-identifier hs-var">cpe_config</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682976185"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2690"></span><span>
</span><span id="line-2691"></span><span>    </span><span class="hs-comment">-- Per the documentation in GHC.Num.BigNat, a BigNat# is:</span><span>
</span><span id="line-2692"></span><span>    </span><span class="hs-comment">--   &quot;Represented as an array of limbs (Word#) stored in</span><span>
</span><span id="line-2693"></span><span>    </span><span class="hs-comment">--   little-endian order (Word# themselves use machine order).&quot;</span><span>
</span><span id="line-2694"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-2695"></span><span>    </span><span class="hs-comment">--   &quot;Invariant (canonical representation): higher Word# is non-zero.&quot;</span><span>
</span><span id="line-2696"></span><span>    </span><span class="hs-comment">-- So we need to break up the integer into target-word-sized chunks,</span><span>
</span><span id="line-2697"></span><span>    </span><span class="hs-comment">-- and encode each of them using the target's byte-order.</span><span>
</span><span id="line-2698"></span><span>    </span><span class="annot"><a href="#local-6989586621682976188"><span class="hs-identifier hs-type">encodeBigNat</span></a></span><span>
</span><span id="line-2699"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621682974838"><span class="annot"><a href="#local-6989586621682974838"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Num</span></span><span> </span><span class="annot"><a href="#local-6989586621682974838"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../bytestring-0.12.2.0-7dd0/src/Data.ByteString.Builder.Prim.Internal.html#FixedPrim"><span class="hs-identifier hs-type">FixedPrim</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682974838"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../bytestring-0.12.2.0-7dd0/src/Data.ByteString.Internal.Type.html#ByteString"><span class="hs-identifier hs-type">BS.ByteString</span></a></span><span>
</span><span id="line-2700"></span><span>    </span><span id="local-6989586621682976188"><span class="annot"><span class="annottext">encodeBigNat :: forall a. Num a =&gt; FixedPrim a -&gt; ByteString
</span><a href="#local-6989586621682976188"><span class="hs-identifier hs-var hs-var hs-var">encodeBigNat</span></a></span></span><span> </span><span id="local-6989586621682976196"><span class="annot"><span class="annottext">FixedPrim a
</span><a href="#local-6989586621682976196"><span class="hs-identifier hs-var">encodeWord</span></a></span></span><span>
</span><span id="line-2701"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LazyByteString -&gt; ByteString
</span><a href="../../bytestring-0.12.2.0-7dd0/src/Data.ByteString.Lazy.Internal.html#toStrict"><span class="hs-identifier hs-var">BS.toStrict</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Builder -&gt; LazyByteString
</span><a href="../../bytestring-0.12.2.0-7dd0/src/Data.ByteString.Builder.Internal.html#toLazyByteString"><span class="hs-identifier hs-var">BB.toLazyByteString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FixedPrim a
-&gt; (Integer -&gt; Maybe (a, Integer)) -&gt; Integer -&gt; Builder
forall b a. FixedPrim b -&gt; (a -&gt; Maybe (b, a)) -&gt; a -&gt; Builder
</span><a href="../../bytestring-0.12.2.0-7dd0/src/Data.ByteString.Builder.Prim.html#primUnfoldrFixed"><span class="hs-identifier hs-var">primUnfoldrFixed</span></a></span><span> </span><span class="annot"><span class="annottext">FixedPrim a
</span><a href="#local-6989586621682976196"><span class="hs-identifier hs-var">encodeWord</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Maybe (a, Integer)
</span><a href="#local-6989586621682976200"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621682976186"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2702"></span><span>      </span><span class="hs-comment">-- (quadratic complexity due to repeated shifts... ok for now)</span><span>
</span><span id="line-2703"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-2704"></span><span>        </span><span id="local-6989586621682976200"><span class="annot"><span class="annottext">f :: Integer -&gt; Maybe (a, Integer)
</span><a href="#local-6989586621682976200"><span class="hs-identifier hs-var hs-var">f</span></a></span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (a, Integer)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-2705"></span><span>        </span><span class="annot"><a href="#local-6989586621682976200"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span id="local-6989586621682976201"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621682976201"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682976202"><span class="annot"><span class="annottext">low :: a
</span><a href="#local-6989586621682976202"><span class="hs-identifier hs-var hs-var">low</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; a
forall a. Num a =&gt; Integer -&gt; a
</span><span class="hs-identifier hs-var">fromInteger</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621682976201"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621682974838"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-2706"></span><span>                  </span><span id="local-6989586621682976203"><span class="annot"><span class="annottext">high :: Integer
</span><a href="#local-6989586621682976203"><span class="hs-identifier hs-var hs-var">high</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621682976201"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Int -&gt; Integer
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="GHC.Prelude.Basic.html#shiftR"><span class="hs-operator hs-var">`shiftR`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682976205"><span class="hs-identifier hs-var">bits</span></a></span><span>
</span><span id="line-2707"></span><span>              </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(a, Integer) -&gt; Maybe (a, Integer)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682976202"><span class="hs-identifier hs-var">low</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621682976203"><span class="hs-identifier hs-var">high</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2708"></span><span>        </span><span id="local-6989586621682976205"><span class="annot"><span class="annottext">bits :: Int
</span><a href="#local-6989586621682976205"><span class="hs-identifier hs-var hs-var">bits</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Platform -&gt; Int
</span><a href="GHC.Platform.html#platformWordSizeInBits"><span class="hs-identifier hs-var">platformWordSizeInBits</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682976187"><span class="hs-identifier hs-var">platform</span></a></span><span>
</span><span id="line-2709"></span><span>
</span><span id="line-2710"></span><span>    </span><span class="annot"><a href="#local-6989586621682976207"><span class="hs-identifier hs-type">words</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../bytestring-0.12.2.0-7dd0/src/Data.ByteString.Internal.Type.html#ByteString"><span class="hs-identifier hs-type">BS.ByteString</span></a></span><span>
</span><span id="line-2711"></span><span>    </span><span id="local-6989586621682976207"><span class="annot"><span class="annottext">words :: ByteString
</span><a href="#local-6989586621682976207"><span class="hs-identifier hs-var hs-var hs-var">words</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Platform -&gt; PlatformWordSize
</span><a href="GHC.Platform.html#platformWordSize"><span class="hs-identifier hs-var">platformWordSize</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682976187"><span class="hs-identifier hs-var">platform</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Platform -&gt; ByteOrder
</span><a href="GHC.Platform.html#platformByteOrder"><span class="hs-identifier hs-var">platformByteOrder</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682976187"><span class="hs-identifier hs-var">platform</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2712"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PlatformWordSize
</span><a href="GHC.Platform.html#PW4"><span class="hs-identifier hs-var">PW4</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteOrder
</span><span class="hs-identifier hs-var">LittleEndian</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FixedPrim Word32 -&gt; ByteString
forall a. Num a =&gt; FixedPrim a -&gt; ByteString
</span><a href="#local-6989586621682976188"><span class="hs-identifier hs-var">encodeBigNat</span></a></span><span> </span><span class="annot"><span class="annottext">FixedPrim Word32
</span><a href="../../bytestring-0.12.2.0-7dd0/src/Data.ByteString.Builder.Prim.Binary.html#word32LE"><span class="hs-identifier hs-var">word32LE</span></a></span><span>
</span><span id="line-2713"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PlatformWordSize
</span><a href="GHC.Platform.html#PW4"><span class="hs-identifier hs-var">PW4</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteOrder
</span><span class="hs-identifier hs-var">BigEndian</span></span><span>   </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FixedPrim Word32 -&gt; ByteString
forall a. Num a =&gt; FixedPrim a -&gt; ByteString
</span><a href="#local-6989586621682976188"><span class="hs-identifier hs-var">encodeBigNat</span></a></span><span> </span><span class="annot"><span class="annottext">FixedPrim Word32
</span><a href="../../bytestring-0.12.2.0-7dd0/src/Data.ByteString.Builder.Prim.Binary.html#word32BE"><span class="hs-identifier hs-var">word32BE</span></a></span><span>
</span><span id="line-2714"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PlatformWordSize
</span><a href="GHC.Platform.html#PW8"><span class="hs-identifier hs-var">PW8</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteOrder
</span><span class="hs-identifier hs-var">LittleEndian</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FixedPrim Word64 -&gt; ByteString
forall a. Num a =&gt; FixedPrim a -&gt; ByteString
</span><a href="#local-6989586621682976188"><span class="hs-identifier hs-var">encodeBigNat</span></a></span><span> </span><span class="annot"><span class="annottext">FixedPrim Word64
</span><a href="../../bytestring-0.12.2.0-7dd0/src/Data.ByteString.Builder.Prim.Binary.html#word64LE"><span class="hs-identifier hs-var">word64LE</span></a></span><span>
</span><span id="line-2715"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PlatformWordSize
</span><a href="GHC.Platform.html#PW8"><span class="hs-identifier hs-var">PW8</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteOrder
</span><span class="hs-identifier hs-var">BigEndian</span></span><span>   </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FixedPrim Word64 -&gt; ByteString
forall a. Num a =&gt; FixedPrim a -&gt; ByteString
</span><a href="#local-6989586621682976188"><span class="hs-identifier hs-var">encodeBigNat</span></a></span><span> </span><span class="annot"><span class="annottext">FixedPrim Word64
</span><a href="../../bytestring-0.12.2.0-7dd0/src/Data.ByteString.Builder.Prim.Binary.html#word64BE"><span class="hs-identifier hs-var">word64BE</span></a></span><span>
</span><span id="line-2716"></span><span>
</span><span id="line-2717"></span><span>  </span><span class="hs-comment">-- Ideally we would just generate a ByteArray# literal here:</span><span>
</span><span id="line-2718"></span><span>  </span><span class="hs-comment">--   pure (emptyFloats, Lit (LitByteArray words))</span><span>
</span><span id="line-2719"></span><span>  </span><span class="hs-comment">-- But sadly we don't have those yet, even in Core. (See also #17747.)</span><span>
</span><span id="line-2720"></span><span>  </span><span class="hs-comment">-- So instead we generate:</span><span>
</span><span id="line-2721"></span><span>  </span><span class="hs-comment">--   * An `Addr#` literal that contains the contents of the</span><span>
</span><span id="line-2722"></span><span>  </span><span class="hs-comment">--      `ByteArray#` we want to create.  This gets its own float.</span><span>
</span><span id="line-2723"></span><span>  </span><span class="hs-comment">--   * A call to `newByteArray#` with the appropriate size</span><span>
</span><span id="line-2724"></span><span>  </span><span class="hs-comment">--   * A call to `copyAddrToByteArray#` to initialize the `ByteArray#`</span><span>
</span><span id="line-2725"></span><span>  </span><span class="hs-comment">--   * A call to `unsafeFreezeByteArray#` to make the types match</span><span>
</span><span id="line-2726"></span><span>  </span><span id="local-6989586621682976218"><span class="annot"><a href="#local-6989586621682976218"><span class="hs-identifier hs-var">litAddrId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FastString -&gt; Type -&gt; Type -&gt; UniqSM InVar
forall (m :: * -&gt; *).
MonadUnique m =&gt;
FastString -&gt; Type -&gt; Type -&gt; m InVar
</span><a href="GHC.Types.Id.html#mkSysLocalM"><span class="hs-identifier hs-var">mkSysLocalM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; FastString
</span><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;bigNatGuts&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Core.Type.html#ManyTy"><span class="hs-identifier hs-var">ManyTy</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Builtin.Types.Prim.html#addrPrimTy"><span class="hs-identifier hs-var">addrPrimTy</span></a></span><span>
</span><span id="line-2727"></span><span>  </span><span class="hs-comment">-- returned from newByteArray#:</span><span>
</span><span id="line-2728"></span><span>  </span><span id="local-6989586621682976221"><span class="annot"><a href="#local-6989586621682976221"><span class="hs-identifier hs-var">deadNewByteArrayTupleId</span></a></span></span><span>
</span><span id="line-2729"></span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">`setIdOccInfo`</span></span><span> </span><span class="annot"><span class="hs-identifier">IAmDead</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><a href="GHC.Types.Id.html#mkSysLocalM"><span class="hs-identifier hs-type">mkSysLocalM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier hs-type">fsLit</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;tup&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="GHC.Core.Type.html#ManyTy"><span class="hs-identifier hs-type">ManyTy</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-2730"></span><span>         </span><span class="annot"><a href="GHC.Builtin.Types.html#mkTupleTy"><span class="hs-identifier hs-type">mkTupleTy</span></a></span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Unboxed"><span class="hs-identifier hs-type">Unboxed</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.Prim.html#realWorldStatePrimTy"><span class="hs-identifier hs-type">realWorldStatePrimTy</span></a></span><span>
</span><span id="line-2731"></span><span>                           </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.Prim.html#realWorldMutableByteArrayPrimTy"><span class="hs-identifier hs-type">realWorldMutableByteArrayPrimTy</span></a></span><span>
</span><span id="line-2732"></span><span>                           </span><span class="hs-special">]</span><span>
</span><span id="line-2733"></span><span>  </span><span id="local-6989586621682976228"><span class="annot"><a href="#local-6989586621682976228"><span class="hs-identifier hs-var">stateTokenFromNewByteArrayId</span></a></span></span><span>
</span><span id="line-2734"></span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Types.Id.html#mkSysLocalM"><span class="hs-identifier hs-type">mkSysLocalM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier hs-type">fsLit</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;token&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="GHC.Core.Type.html#ManyTy"><span class="hs-identifier hs-type">ManyTy</span></a></span><span> </span><span class="annot"><a href="GHC.Builtin.Types.Prim.html#realWorldStatePrimTy"><span class="hs-identifier hs-type">realWorldStatePrimTy</span></a></span><span>
</span><span id="line-2735"></span><span>  </span><span id="local-6989586621682976229"><span class="annot"><a href="#local-6989586621682976229"><span class="hs-identifier hs-var">mutableByteArrayId</span></a></span></span><span>
</span><span id="line-2736"></span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Types.Id.html#mkSysLocalM"><span class="hs-identifier hs-type">mkSysLocalM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier hs-type">fsLit</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;mba&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="GHC.Core.Type.html#ManyTy"><span class="hs-identifier hs-type">ManyTy</span></a></span><span> </span><span class="annot"><a href="GHC.Builtin.Types.Prim.html#realWorldMutableByteArrayPrimTy"><span class="hs-identifier hs-type">realWorldMutableByteArrayPrimTy</span></a></span><span>
</span><span id="line-2737"></span><span>  </span><span class="hs-comment">-- returned from copyAddrToByteArray#:</span><span>
</span><span id="line-2738"></span><span>  </span><span id="local-6989586621682976230"><span class="annot"><a href="#local-6989586621682976230"><span class="hs-identifier hs-var">stateTokenFromCopyId</span></a></span></span><span>
</span><span id="line-2739"></span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Types.Id.html#mkSysLocalM"><span class="hs-identifier hs-type">mkSysLocalM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier hs-type">fsLit</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;token&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="GHC.Core.Type.html#ManyTy"><span class="hs-identifier hs-type">ManyTy</span></a></span><span> </span><span class="annot"><a href="GHC.Builtin.Types.Prim.html#realWorldStatePrimTy"><span class="hs-identifier hs-type">realWorldStatePrimTy</span></a></span><span>
</span><span id="line-2740"></span><span>  </span><span class="hs-comment">-- returned from unsafeFreezeByteArray#:</span><span>
</span><span id="line-2741"></span><span>  </span><span id="local-6989586621682976231"><span class="annot"><a href="#local-6989586621682976231"><span class="hs-identifier hs-var">deadFreezeTupleId</span></a></span></span><span>
</span><span id="line-2742"></span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">`setIdOccInfo`</span></span><span> </span><span class="annot"><span class="hs-identifier">IAmDead</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><a href="GHC.Types.Id.html#mkSysLocalM"><span class="hs-identifier hs-type">mkSysLocalM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier hs-type">fsLit</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;tup&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="GHC.Core.Type.html#ManyTy"><span class="hs-identifier hs-type">ManyTy</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-2743"></span><span>         </span><span class="annot"><a href="GHC.Builtin.Types.html#mkTupleTy"><span class="hs-identifier hs-type">mkTupleTy</span></a></span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Unboxed"><span class="hs-identifier hs-type">Unboxed</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Builtin.Types.Prim.html#realWorldStatePrimTy"><span class="hs-identifier hs-type">realWorldStatePrimTy</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.Prim.html#byteArrayPrimTy"><span class="hs-identifier hs-type">byteArrayPrimTy</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2744"></span><span>  </span><span id="local-6989586621682976233"><span class="annot"><a href="#local-6989586621682976233"><span class="hs-identifier hs-var">stateTokenFromFreezeId</span></a></span></span><span>
</span><span id="line-2745"></span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">`setIdOccInfo`</span></span><span> </span><span class="annot"><span class="hs-identifier">IAmDead</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span>
</span><span id="line-2746"></span><span>         </span><span class="annot"><a href="GHC.Types.Id.html#mkSysLocalM"><span class="hs-identifier hs-type">mkSysLocalM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier hs-type">fsLit</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;token&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="GHC.Core.Type.html#ManyTy"><span class="hs-identifier hs-type">ManyTy</span></a></span><span> </span><span class="annot"><a href="GHC.Builtin.Types.Prim.html#realWorldStatePrimTy"><span class="hs-identifier hs-type">realWorldStatePrimTy</span></a></span><span>
</span><span id="line-2747"></span><span>  </span><span id="local-6989586621682976234"><span class="annot"><a href="#local-6989586621682976234"><span class="hs-identifier hs-var">byteArrayId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Types.Id.html#mkSysLocalM"><span class="hs-identifier hs-type">mkSysLocalM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier hs-type">fsLit</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;ba&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="GHC.Core.Type.html#ManyTy"><span class="hs-identifier hs-type">ManyTy</span></a></span><span> </span><span class="annot"><a href="GHC.Builtin.Types.Prim.html#byteArrayPrimTy"><span class="hs-identifier hs-type">byteArrayPrimTy</span></a></span><span>
</span><span id="line-2748"></span><span>
</span><span id="line-2749"></span><span>  </span><span class="hs-keyword">let</span><span>
</span><span id="line-2750"></span><span>    </span><span id="local-6989586621682976235"><span class="annot"><a href="#local-6989586621682976235"><span class="hs-identifier hs-var hs-var">litAddrRhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Literal -&gt; Expr b
forall b. Literal -&gt; Expr b
</span><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-var">Lit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Literal
</span><a href="GHC.Types.Literal.html#LitString"><span class="hs-identifier hs-var">LitString</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621682976207"><span class="hs-identifier hs-var">words</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2751"></span><span>      </span><span class="hs-comment">-- not &quot;mkLitString&quot;; that does UTF-8 encoding, which we don't want here</span><span>
</span><span id="line-2752"></span><span>    </span><span id="local-6989586621682976237"><span class="annot"><a href="#local-6989586621682976237"><span class="hs-identifier hs-var hs-var">litAddrFloat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Bool -&gt; InVar -&gt; CpeRhs -&gt; FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#mkNonRecFloat"><span class="hs-identifier hs-var">mkNonRecFloat</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621682976185"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976218"><span class="hs-identifier hs-var">litAddrId</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
forall {b}. Expr b
</span><a href="#local-6989586621682976235"><span class="hs-identifier hs-var">litAddrRhs</span></a></span><span>
</span><span id="line-2753"></span><span>
</span><span id="line-2754"></span><span>    </span><span id="local-6989586621682976238"><span class="annot"><a href="#local-6989586621682976238"><span class="hs-identifier hs-var hs-var">contentsLength</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Platform -&gt; Integer -&gt; CpeRhs
forall b. Platform -&gt; Integer -&gt; Expr b
</span><a href="GHC.Core.html#mkIntLit"><span class="hs-identifier hs-var">mkIntLit</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682976187"><span class="hs-identifier hs-var">platform</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Integer
forall a. Integral a =&gt; a -&gt; Integer
</span><span class="hs-identifier hs-var">toInteger</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><a href="../../bytestring-0.12.2.0-7dd0/src/Data.ByteString.html#length"><span class="hs-identifier hs-var">BS.length</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621682976207"><span class="hs-identifier hs-var">words</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2755"></span><span>
</span><span id="line-2756"></span><span>    </span><span id="local-6989586621682976241"><span class="annot"><a href="#local-6989586621682976241"><span class="hs-identifier hs-var hs-var">newByteArrayCall</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2757"></span><span>      </span><span class="annot"><span class="annottext">InVar -&gt; CpeRhs
forall b. InVar -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimOp -&gt; InVar
</span><a href="GHC.Builtin.PrimOps.Ids.html#primOpId"><span class="hs-identifier hs-var">primOpId</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="GHC.Builtin.PrimOps.html#NewByteArrayOp_Char"><span class="hs-identifier hs-var">NewByteArrayOp_Char</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2758"></span><span>        </span><span class="annot"><span class="annottext">CpeRhs -&gt; CpeRhs -&gt; CpeRhs
forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-operator hs-var">`App`</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; CpeRhs
forall b. Type -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Builtin.Types.Prim.html#realWorldTy"><span class="hs-identifier hs-var">realWorldTy</span></a></span><span>
</span><span id="line-2759"></span><span>        </span><span class="annot"><span class="annottext">CpeRhs -&gt; CpeRhs -&gt; CpeRhs
forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-operator hs-var">`App`</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682976238"><span class="hs-identifier hs-var">contentsLength</span></a></span><span>
</span><span id="line-2760"></span><span>        </span><span class="annot"><span class="annottext">CpeRhs -&gt; CpeRhs -&gt; CpeRhs
forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-operator hs-var">`App`</span></a></span><span> </span><span class="annot"><span class="annottext">InVar -&gt; CpeRhs
forall b. InVar -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="GHC.Types.Id.Make.html#realWorldPrimId"><span class="hs-identifier hs-var">realWorldPrimId</span></a></span><span>
</span><span id="line-2761"></span><span>
</span><span id="line-2762"></span><span>    </span><span id="local-6989586621682976245"><span class="annot"><a href="#local-6989586621682976245"><span class="hs-identifier hs-var hs-var">copyContentsCall</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2763"></span><span>      </span><span class="annot"><span class="annottext">InVar -&gt; CpeRhs
forall b. InVar -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimOp -&gt; InVar
</span><a href="GHC.Builtin.PrimOps.Ids.html#primOpId"><span class="hs-identifier hs-var">primOpId</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="GHC.Builtin.PrimOps.html#CopyAddrToByteArrayOp"><span class="hs-identifier hs-var">CopyAddrToByteArrayOp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2764"></span><span>        </span><span class="annot"><span class="annottext">CpeRhs -&gt; CpeRhs -&gt; CpeRhs
forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-operator hs-var">`App`</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; CpeRhs
forall b. Type -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Builtin.Types.Prim.html#realWorldTy"><span class="hs-identifier hs-var">realWorldTy</span></a></span><span>
</span><span id="line-2765"></span><span>        </span><span class="annot"><span class="annottext">CpeRhs -&gt; CpeRhs -&gt; CpeRhs
forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-operator hs-var">`App`</span></a></span><span> </span><span class="annot"><span class="annottext">InVar -&gt; CpeRhs
forall b. InVar -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976218"><span class="hs-identifier hs-var">litAddrId</span></a></span><span>
</span><span id="line-2766"></span><span>        </span><span class="annot"><span class="annottext">CpeRhs -&gt; CpeRhs -&gt; CpeRhs
forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-operator hs-var">`App`</span></a></span><span> </span><span class="annot"><span class="annottext">InVar -&gt; CpeRhs
forall b. InVar -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976229"><span class="hs-identifier hs-var">mutableByteArrayId</span></a></span><span>
</span><span id="line-2767"></span><span>        </span><span class="annot"><span class="annottext">CpeRhs -&gt; CpeRhs -&gt; CpeRhs
forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-operator hs-var">`App`</span></a></span><span> </span><span class="annot"><span class="annottext">Platform -&gt; Integer -&gt; CpeRhs
forall b. Platform -&gt; Integer -&gt; Expr b
</span><a href="GHC.Core.html#mkIntLit"><span class="hs-identifier hs-var">mkIntLit</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682976187"><span class="hs-identifier hs-var">platform</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span>
</span><span id="line-2768"></span><span>        </span><span class="annot"><span class="annottext">CpeRhs -&gt; CpeRhs -&gt; CpeRhs
forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-operator hs-var">`App`</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682976238"><span class="hs-identifier hs-var">contentsLength</span></a></span><span>
</span><span id="line-2769"></span><span>        </span><span class="annot"><span class="annottext">CpeRhs -&gt; CpeRhs -&gt; CpeRhs
forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-operator hs-var">`App`</span></a></span><span> </span><span class="annot"><span class="annottext">InVar -&gt; CpeRhs
forall b. InVar -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976228"><span class="hs-identifier hs-var">stateTokenFromNewByteArrayId</span></a></span><span>
</span><span id="line-2770"></span><span>
</span><span id="line-2771"></span><span>    </span><span id="local-6989586621682976247"><span class="annot"><a href="#local-6989586621682976247"><span class="hs-identifier hs-var hs-var">unsafeFreezeCall</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2772"></span><span>      </span><span class="annot"><span class="annottext">InVar -&gt; CpeRhs
forall b. InVar -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimOp -&gt; InVar
</span><a href="GHC.Builtin.PrimOps.Ids.html#primOpId"><span class="hs-identifier hs-var">primOpId</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="GHC.Builtin.PrimOps.html#UnsafeFreezeByteArrayOp"><span class="hs-identifier hs-var">UnsafeFreezeByteArrayOp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2773"></span><span>        </span><span class="annot"><span class="annottext">CpeRhs -&gt; CpeRhs -&gt; CpeRhs
forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-operator hs-var">`App`</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; CpeRhs
forall b. Type -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Builtin.Types.Prim.html#realWorldTy"><span class="hs-identifier hs-var">realWorldTy</span></a></span><span>
</span><span id="line-2774"></span><span>        </span><span class="annot"><span class="annottext">CpeRhs -&gt; CpeRhs -&gt; CpeRhs
forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-operator hs-var">`App`</span></a></span><span> </span><span class="annot"><span class="annottext">InVar -&gt; CpeRhs
forall b. InVar -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976229"><span class="hs-identifier hs-var">mutableByteArrayId</span></a></span><span>
</span><span id="line-2775"></span><span>        </span><span class="annot"><span class="annottext">CpeRhs -&gt; CpeRhs -&gt; CpeRhs
forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-operator hs-var">`App`</span></a></span><span> </span><span class="annot"><span class="annottext">InVar -&gt; CpeRhs
forall b. InVar -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976230"><span class="hs-identifier hs-var">stateTokenFromCopyId</span></a></span><span>
</span><span id="line-2776"></span><span>
</span><span id="line-2777"></span><span>    </span><span class="annot"><a href="#local-6989586621682976249"><span class="hs-identifier hs-type">unboxed2tuple_altcon</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a></span><span>
</span><span id="line-2778"></span><span>    </span><span id="local-6989586621682976249"><span class="annot"><a href="#local-6989586621682976249"><span class="hs-identifier hs-var hs-var">unboxed2tuple_altcon</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; AltCon
</span><a href="GHC.Core.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Boxity -&gt; Int -&gt; DataCon
</span><a href="GHC.Builtin.Types.html#tupleDataCon"><span class="hs-identifier hs-var">tupleDataCon</span></a></span><span> </span><span class="annot"><span class="annottext">Boxity
</span><a href="Language.Haskell.Syntax.Basic.html#Unboxed"><span class="hs-identifier hs-var">Unboxed</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span>
</span><span id="line-2779"></span><span>
</span><span id="line-2780"></span><span>    </span><span id="local-6989586621682976251"><span class="annot"><a href="#local-6989586621682976251"><span class="hs-identifier hs-var hs-var">finalRhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2781"></span><span>      </span><span class="annot"><span class="annottext">CpeRhs -&gt; InVar -&gt; Type -&gt; [Alt InVar] -&gt; CpeRhs
forall b. Expr b -&gt; b -&gt; Type -&gt; [Alt b] -&gt; Expr b
</span><a href="GHC.Core.html#Case"><span class="hs-identifier hs-var">Case</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682976241"><span class="hs-identifier hs-var">newByteArrayCall</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976221"><span class="hs-identifier hs-var">deadNewByteArrayTupleId</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Builtin.Types.Prim.html#byteArrayPrimTy"><span class="hs-identifier hs-var">byteArrayPrimTy</span></a></span><span>
</span><span id="line-2782"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">AltCon -&gt; [InVar] -&gt; CpeRhs -&gt; Alt InVar
forall b. AltCon -&gt; [b] -&gt; Expr b -&gt; Alt b
</span><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-var">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682976249"><span class="hs-identifier hs-var">unboxed2tuple_altcon</span></a></span><span>
</span><span id="line-2783"></span><span>              </span><span class="hs-special">[</span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976228"><span class="hs-identifier hs-var">stateTokenFromNewByteArrayId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976229"><span class="hs-identifier hs-var">mutableByteArrayId</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2784"></span><span>              </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682976252"><span class="hs-identifier hs-var">copyContentsCase</span></a></span><span>
</span><span id="line-2785"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-2786"></span><span>
</span><span id="line-2787"></span><span>    </span><span id="local-6989586621682976252"><span class="annot"><a href="#local-6989586621682976252"><span class="hs-identifier hs-var hs-var">copyContentsCase</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2788"></span><span>      </span><span class="annot"><span class="annottext">CpeRhs -&gt; InVar -&gt; Type -&gt; [Alt InVar] -&gt; CpeRhs
forall b. Expr b -&gt; b -&gt; Type -&gt; [Alt b] -&gt; Expr b
</span><a href="GHC.Core.html#Case"><span class="hs-identifier hs-var">Case</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682976245"><span class="hs-identifier hs-var">copyContentsCall</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976230"><span class="hs-identifier hs-var">stateTokenFromCopyId</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Builtin.Types.Prim.html#byteArrayPrimTy"><span class="hs-identifier hs-var">byteArrayPrimTy</span></a></span><span>
</span><span id="line-2789"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">AltCon -&gt; [InVar] -&gt; CpeRhs -&gt; Alt InVar
forall b. AltCon -&gt; [b] -&gt; Expr b -&gt; Alt b
</span><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-var">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="GHC.Core.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682976253"><span class="hs-identifier hs-var">unsafeFreezeCase</span></a></span><span>
</span><span id="line-2790"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-2791"></span><span>
</span><span id="line-2792"></span><span>    </span><span id="local-6989586621682976253"><span class="annot"><a href="#local-6989586621682976253"><span class="hs-identifier hs-var hs-var">unsafeFreezeCase</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2793"></span><span>      </span><span class="annot"><span class="annottext">CpeRhs -&gt; InVar -&gt; Type -&gt; [Alt InVar] -&gt; CpeRhs
forall b. Expr b -&gt; b -&gt; Type -&gt; [Alt b] -&gt; Expr b
</span><a href="GHC.Core.html#Case"><span class="hs-identifier hs-var">Case</span></a></span><span> </span><span class="annot"><span class="annottext">CpeRhs
</span><a href="#local-6989586621682976247"><span class="hs-identifier hs-var">unsafeFreezeCall</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976231"><span class="hs-identifier hs-var">deadFreezeTupleId</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Builtin.Types.Prim.html#byteArrayPrimTy"><span class="hs-identifier hs-var">byteArrayPrimTy</span></a></span><span>
</span><span id="line-2794"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">AltCon -&gt; [InVar] -&gt; CpeRhs -&gt; Alt InVar
forall b. AltCon -&gt; [b] -&gt; Expr b -&gt; Alt b
</span><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-var">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682976249"><span class="hs-identifier hs-var">unboxed2tuple_altcon</span></a></span><span>
</span><span id="line-2795"></span><span>              </span><span class="hs-special">[</span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976233"><span class="hs-identifier hs-var">stateTokenFromFreezeId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976234"><span class="hs-identifier hs-var">byteArrayId</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2796"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InVar -&gt; CpeRhs
forall b. InVar -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">InVar
</span><a href="#local-6989586621682976234"><span class="hs-identifier hs-var">byteArrayId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2797"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-2798"></span><span>
</span><span id="line-2799"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-type">emptyFloats</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#snocFloat"><span class="hs-operator hs-type">`snocFloat`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682976237"><span class="hs-identifier hs-type">litAddrFloat</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682976251"><span class="hs-identifier hs-type">finalRhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2800"></span></pre></body></html>