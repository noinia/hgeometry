<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The AQUA Project, Glasgow University, 1993-1998

\section[Simplify]{The main module of the simplifier}
-}</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE MultiWayIf #-}</span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# OPTIONS_GHC -Wno-incomplete-uni-patterns #-}</span><span>
</span><span id="line-12"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html"><span class="hs-identifier">GHC.Core.Opt.Simplify.Iteration</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplTopBinds"><span class="hs-identifier">simplTopBinds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExpr"><span class="hs-identifier">simplExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplImpRules"><span class="hs-identifier">simplImpRules</span></a></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-13"></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Flags.html"><span class="hs-identifier">GHC.Driver.Flags</span></a></span><span>
</span><span id="line-17"></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.html"><span class="hs-identifier">GHC.Core</span></a></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html"><span class="hs-identifier">GHC.Core.Opt.Simplify.Monad</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.ConstantFold.html"><span class="hs-identifier">GHC.Core.Opt.ConstantFold</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Type.html"><span class="hs-identifier">GHC.Core.Type</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#substCo"><span class="hs-identifier">substCo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#substTy"><span class="hs-identifier">substTy</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#substTyVar"><span class="hs-identifier">substTyVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#extendTvSubst"><span class="hs-identifier">extendTvSubst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#extendCvSubst"><span class="hs-identifier">extendCvSubst</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Compare.html"><span class="hs-identifier">GHC.Core.TyCo.Compare</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Compare.html#eqType"><span class="hs-identifier">eqType</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html"><span class="hs-identifier">GHC.Core.Opt.Simplify.Env</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Inline.html"><span class="hs-identifier">GHC.Core.Opt.Simplify.Inline</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html"><span class="hs-identifier">GHC.Core.Opt.Simplify.Utils</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html"><span class="hs-identifier">GHC.Core.Opt.OccurAnal</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occurAnalyseExpr"><span class="hs-identifier">occurAnalyseExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#zapLambdaBndrs"><span class="hs-identifier">zapLambdaBndrs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#scrutOkForBinderSwap"><span class="hs-identifier">scrutOkForBinderSwap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#BinderSwapDecision"><span class="hs-identifier">BinderSwapDecision</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Make.html"><span class="hs-identifier">GHC.Core.Make</span></a></span><span>       </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Make.html#FloatBind"><span class="hs-identifier">FloatBind</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Make.html#mkImpossibleExpr"><span class="hs-identifier">mkImpossibleExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Make.html#castBottomExpr"><span class="hs-identifier">castBottomExpr</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="GHC.Core.Make.html"><span class="hs-identifier">GHC.Core.Make</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html"><span class="hs-identifier">GHC.Core.Coercion</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#substCo"><span class="hs-identifier">substCo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#substCoVar"><span class="hs-identifier">substCoVar</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html"><span class="hs-identifier">GHC.Core.Reduction</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Opt.html"><span class="hs-identifier">GHC.Core.Coercion.Opt</span></a></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#optCoercion"><span class="hs-identifier">optCoercion</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html"><span class="hs-identifier">GHC.Core.FamInstEnv</span></a></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnv"><span class="hs-identifier">FamInstEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#topNormaliseType_maybe"><span class="hs-identifier">topNormaliseType_maybe</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html"><span class="hs-identifier">GHC.Core.DataCon</span></a></span><span>
</span><span id="line-34"></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#DataCon"><span class="hs-identifier">DataCon</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#dataConWorkId"><span class="hs-identifier">dataConWorkId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#dataConRepStrictness"><span class="hs-identifier">dataConRepStrictness</span></a></span><span>
</span><span id="line-35"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#dataConRepArgTys"><span class="hs-identifier">dataConRepArgTys</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#isUnboxedTupleDataCon"><span class="hs-identifier">isUnboxedTupleDataCon</span></a></span><span>
</span><span id="line-36"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#StrictnessMark"><span class="hs-identifier">StrictnessMark</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#dataConWrapId_maybe"><span class="hs-identifier">dataConWrapId_maybe</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Stats.html"><span class="hs-identifier">GHC.Core.Opt.Stats</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Stats.html#Tick"><span class="hs-identifier">Tick</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Ppr.html"><span class="hs-identifier">GHC.Core.Ppr</span></a></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Ppr.html#pprCoreExpr"><span class="hs-identifier">pprCoreExpr</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html"><span class="hs-identifier">GHC.Core.Unfold</span></a></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.Make.html"><span class="hs-identifier">GHC.Core.Unfold.Make</span></a></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html"><span class="hs-identifier">GHC.Core.Utils</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html"><span class="hs-identifier">GHC.Core.Opt.Arity</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier">ArityType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#exprArity"><span class="hs-identifier">exprArity</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityTypeBotSigs_maybe"><span class="hs-identifier">arityTypeBotSigs_maybe</span></a></span><span>
</span><span id="line-43"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pushCoTyArg"><span class="hs-identifier">pushCoTyArg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pushCoValArg"><span class="hs-identifier">pushCoValArg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#exprIsDeadEnd"><span class="hs-identifier">exprIsDeadEnd</span></a></span><span>
</span><span id="line-44"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#typeArity"><span class="hs-identifier">typeArity</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityTypeArity"><span class="hs-identifier">arityTypeArity</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#etaExpandAT"><span class="hs-identifier">etaExpandAT</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.SimpleOpt.html"><span class="hs-identifier">GHC.Core.SimpleOpt</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.SimpleOpt.html#exprIsConApp_maybe"><span class="hs-identifier">exprIsConApp_maybe</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.SimpleOpt.html#joinPointBinding_maybe"><span class="hs-identifier">joinPointBinding_maybe</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.SimpleOpt.html#joinPointBindings_maybe"><span class="hs-identifier">joinPointBindings_maybe</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.FVs.html"><span class="hs-identifier">GHC.Core.FVs</span></a></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.FVs.html#mkRuleInfo"><span class="hs-identifier">mkRuleInfo</span></a></span><span> </span><span class="hs-comment">{- exprsFreeIds -}</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html"><span class="hs-identifier">GHC.Core.Rules</span></a></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#lookupRule"><span class="hs-identifier">lookupRule</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#getRules"><span class="hs-identifier">getRules</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Multiplicity.html"><span class="hs-identifier">GHC.Core.Multiplicity</span></a></span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Literal.html"><span class="hs-identifier">GHC.Types.Literal</span></a></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Literal.html#litIsLifted"><span class="hs-identifier">litIsLifted</span></a></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-comment">--, mkLitInt ) -- temporarily commented out. See #8326</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.SourceText.html"><span class="hs-identifier">GHC.Types.SourceText</span></a></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.html"><span class="hs-identifier">GHC.Types.Id</span></a></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.Make.html"><span class="hs-identifier">GHC.Types.Id.Make</span></a></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Id.Make.html#seqId"><span class="hs-identifier">seqId</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.Info.html"><span class="hs-identifier">GHC.Types.Id.Info</span></a></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.html"><span class="hs-identifier">GHC.Types.Name</span></a></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#mkSystemVarName"><span class="hs-identifier">mkSystemVarName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#isExternalName"><span class="hs-identifier">isExternalName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#getOccFS"><span class="hs-identifier">getOccFS</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html"><span class="hs-identifier">GHC.Types.Demand</span></a></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.html"><span class="hs-identifier">GHC.Types.Unique</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Unique.html#hasKey"><span class="hs-identifier">hasKey</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html"><span class="hs-identifier">GHC.Types.Basic</span></a></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Tickish.html"><span class="hs-identifier">GHC.Types.Tickish</span></a></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.html"><span class="hs-identifier">GHC.Types.Var</span></a></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#isTyCoVar"><span class="hs-identifier">isTyCoVar</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.Prim.html"><span class="hs-identifier">GHC.Builtin.Types.Prim</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.Prim.html#realWorldStatePrimTy"><span class="hs-identifier">realWorldStatePrimTy</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html"><span class="hs-identifier">GHC.Builtin.Names</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html#runRWKey"><span class="hs-identifier">runRWKey</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html#seqHashKey"><span class="hs-identifier">seqHashKey</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Maybe.html"><span class="hs-identifier">GHC.Data.Maybe</span></a></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">isNothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Data.Maybe.html#orElse"><span class="hs-identifier">orElse</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">mapMaybe</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html"><span class="hs-identifier">GHC.Data.FastString</span></a></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Module.html"><span class="hs-identifier">GHC.Unit.Module</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Unit.Types.html#moduleName"><span class="hs-identifier">moduleName</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Constants.html"><span class="hs-identifier">GHC.Utils.Constants</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Constants.html#debugIsOn"><span class="hs-identifier">debugIsOn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Monad.html"><span class="hs-identifier">GHC.Utils.Monad</span></a></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Utils.Monad.html#mapAccumLM"><span class="hs-identifier">mapAccumLM</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">liftIO</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html"><span class="hs-identifier">GHC.Utils.Logger</span></a></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>
</span><span id="line-73"></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span class="hs-comment">{-
The guts of the simplifier is in this module, but the driver loop for
the simplifier is in GHC.Core.Opt.Pipeline

Note [The big picture]
~~~~~~~~~~~~~~~~~~~~~~
The general shape of the simplifier is this:

  simplExpr :: SimplEnv -&gt; InExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, OutExpr)
  simplBind :: SimplEnv -&gt; InBind -&gt; SimplM (SimplFloats, SimplEnv)

 * SimplEnv contains
     - Simplifier mode
     - Ambient substitution
     - InScopeSet

 * SimplFloats contains
     - Let-floats (which includes ok-for-spec case-floats)
     - Join floats
     - InScopeSet (including all the floats)

 * Expressions
      simplExpr :: SimplEnv -&gt; InExpr -&gt; SimplCont
                -&gt; SimplM (SimplFloats, OutExpr)
   The result of simplifying an /expression/ is (floats, expr)
      - A bunch of floats (let bindings, join bindings)
      - A simplified expression.
   The overall result is effectively (let floats in expr)

 * Bindings
      simplBind :: SimplEnv -&gt; InBind -&gt; SimplM (SimplFloats, SimplEnv)
   The result of simplifying a binding is
     - A bunch of floats, the last of which is the simplified binding
       There may be auxiliary bindings too; see prepareRhs
     - An environment suitable for simplifying the scope of the binding

   The floats may also be empty, if the binding is inlined unconditionally;
   in that case the returned SimplEnv will have an augmented substitution.

   The returned floats and env both have an in-scope set, and they are
   guaranteed to be the same.

Eta expansion
~~~~~~~~~~~~~~
For eta expansion, we want to catch things like

        case e of (a,b) -&gt; \x -&gt; case a of (p,q) -&gt; \y -&gt; r

If the \x was on the RHS of a let, we'd eta expand to bring the two
lambdas together.  And in general that's a good thing to do.  Perhaps
we should eta expand wherever we find a (value) lambda?  Then the eta
expansion at a let RHS can concentrate solely on the PAP case.

Note [In-scope set as a substitution]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
As per Note [Lookups in in-scope set], an in-scope set can act as
a substitution. Specifically, it acts as a substitution from variable to
variables /with the same unique/.

Why do we need this? Well, during the course of the simplifier, we may want to
adjust inessential properties of a variable. For instance, when performing a
beta-reduction, we change

    (\x. e) u ==&gt; let x = u in e

We typically want to add an unfolding to `x` so that it inlines to (the
simplification of) `u`.

We do that by adding the unfolding to the binder `x`, which is added to the
in-scope set. When simplifying occurrences of `x` (every occurrence!), they are
replaced by their &#8220;updated&#8221; version from the in-scope set, hence inherit the
unfolding. This happens in `SimplEnv.substId`.

Another example. Consider

   case x of y { Node a b -&gt; ...y...
               ; Leaf v   -&gt; ...y... }

In the Node branch want y's unfolding to be (Node a b); in the Leaf branch we
want y's unfolding to be (Leaf v). We achieve this by adding the appropriate
unfolding to y, and re-adding it to the in-scope set. See the calls to
`addBinderUnfolding` in `Simplify.addAltUnfoldings` and elsewhere.

It's quite convenient. This way we don't need to manipulate the substitution all
the time: every update to a binder is automatically reflected to its bound
occurrences.

Note [Bangs in the Simplifier]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Both SimplFloats and SimplEnv do *not* generally benefit from making
their fields strict. I don't know if this is because of good use of
laziness or unintended side effects like closures capturing more variables
after WW has run.

But the end result is that we keep these lazy, but force them in some places
where we know it's beneficial to the compiler.

Similarly environments returned from functions aren't *always* beneficial to
force. In some places they would never be demanded so forcing them early
increases allocation. In other places they almost always get demanded so
it's worthwhile to force them early.

Would it be better to through every allocation of e.g. SimplEnv and decide
wether or not to make this one strict? Absolutely! Would be a good use of
someones time? Absolutely not! I made these strict that showed up during
a profiled build or which I noticed while looking at core for one reason
or another.

The result sadly is that we end up with &quot;random&quot; bangs in the simplifier
where we sometimes force e.g. the returned environment from a function and
sometimes we don't for the same function. Depending on the context around
the call. The treatment is also not very consistent. I only added bangs
where I saw it making a difference either in the core or benchmarks. Some
patterns where it would be beneficial aren't convered as a consequence as
I neither have the time to go through all of the core and some cases are
too small to show up in benchmarks.



************************************************************************
*                                                                      *
\subsection{Bindings}
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-201"></span><span>
</span><span id="line-202"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplTopBinds"><span class="hs-identifier hs-type">simplTopBinds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#InBind"><span class="hs-identifier hs-type">InBind</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-203"></span><span class="hs-comment">-- See Note [The big picture]</span><span>
</span><span id="line-204"></span><span id="simplTopBinds"><span class="annot"><span class="annottext">simplTopBinds :: SimplEnv -&gt; [InBind] -&gt; SimplM (SimplFloats, SimplEnv)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplTopBinds"><span class="hs-identifier hs-var hs-var">simplTopBinds</span></a></span></span><span> </span><span id="local-6989586621682978952"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682978952"><span class="hs-identifier hs-var">env0</span></a></span></span><span> </span><span id="local-6989586621682978953"><span class="annot"><span class="annottext">[InBind]
</span><a href="#local-6989586621682978953"><span class="hs-identifier hs-var">binds0</span></a></span></span><span>
</span><span id="line-205"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span>       </span><span class="hs-comment">-- Put all the top-level binders into scope at the start</span><span>
</span><span id="line-206"></span><span>                </span><span class="hs-comment">-- so that if a rewrite rule has unexpectedly brought</span><span>
</span><span id="line-207"></span><span>                </span><span class="hs-comment">-- anything into scope, then we don't get a complaint about that.</span><span>
</span><span id="line-208"></span><span>                </span><span class="hs-comment">-- It's rather as if the top-level binders were imported.</span><span>
</span><span id="line-209"></span><span>                </span><span class="hs-comment">-- See Note [Glomming] in &quot;GHC.Core.Opt.OccurAnal&quot;.</span><span>
</span><span id="line-210"></span><span>        </span><span class="hs-comment">-- See Note [Bangs in the Simplifier]</span><span>
</span><span id="line-211"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682978954"><span class="annot"><a href="#local-6989586621682978954"><span class="hs-identifier hs-var">env1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-pragma">{-#SCC</span><span> </span><span class="hs-pragma">&quot;simplTopBinds-simplRecBndrs&quot;</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; [CoreBndr] -&gt; SimplM SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#simplRecBndrs"><span class="hs-identifier hs-var">simplRecBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682978952"><span class="hs-identifier hs-var">env0</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[InBind] -&gt; [CoreBndr]
forall b. [Bind b] -&gt; [b]
</span><a href="GHC.Core.html#bindersOfBinds"><span class="hs-identifier hs-var">bindersOfBinds</span></a></span><span> </span><span class="annot"><span class="annottext">[InBind]
</span><a href="#local-6989586621682978953"><span class="hs-identifier hs-var">binds0</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-212"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682978957"><span class="annot"><a href="#local-6989586621682978957"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682978958"><span class="annot"><a href="#local-6989586621682978958"><span class="hs-identifier hs-var">env2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-pragma">{-#SCC</span><span> </span><span class="hs-pragma">&quot;simplTopBinds-simpl_binds&quot;</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="annot"><a href="#local-6989586621682978959"><span class="hs-identifier hs-type">simpl_binds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682978954"><span class="hs-identifier hs-type">env1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682978953"><span class="hs-identifier hs-type">binds0</span></a></span><span>
</span><span id="line-213"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#freeTick"><span class="hs-identifier hs-type">freeTick</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Stats.html#SimplifierDone"><span class="hs-identifier hs-type">SimplifierDone</span></a></span><span>
</span><span id="line-214"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682978957"><span class="hs-identifier hs-type">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682978958"><span class="hs-identifier hs-type">env2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-215"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-216"></span><span>        </span><span class="hs-comment">-- We need to track the zapped top-level binders, because</span><span>
</span><span id="line-217"></span><span>        </span><span class="hs-comment">-- they should have their fragile IdInfo zapped (notably occurrence info)</span><span>
</span><span id="line-218"></span><span>        </span><span class="hs-comment">-- That's why we run down binds and bndrs' simultaneously.</span><span>
</span><span id="line-219"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-220"></span><span>    </span><span class="annot"><a href="#local-6989586621682978959"><span class="hs-identifier hs-type">simpl_binds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#InBind"><span class="hs-identifier hs-type">InBind</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span>    </span><span id="local-6989586621682978959"><span class="annot"><span class="annottext">simpl_binds :: SimplEnv -&gt; [InBind] -&gt; SimplM (SimplFloats, SimplEnv)
</span><a href="#local-6989586621682978959"><span class="hs-identifier hs-var hs-var">simpl_binds</span></a></span></span><span> </span><span id="local-6989586621682978962"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682978962"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SimplFloats, SimplEnv) -&gt; SimplM (SimplFloats, SimplEnv)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682978962"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682978962"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span>    </span><span class="annot"><a href="#local-6989586621682978959"><span class="hs-identifier hs-var">simpl_binds</span></a></span><span> </span><span id="local-6989586621682978964"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682978964"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682978965"><span class="annot"><span class="annottext">InBind
</span><a href="#local-6989586621682978965"><span class="hs-identifier hs-var">bind</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682978966"><span class="annot"><span class="annottext">[InBind]
</span><a href="#local-6989586621682978966"><span class="hs-identifier hs-var">binds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682978967"><span class="annot"><a href="#local-6989586621682978967"><span class="hs-identifier hs-var">float</span></a></span></span><span class="hs-special">,</span><span>  </span><span id="local-6989586621682978968"><span class="annot"><a href="#local-6989586621682978968"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; InBind -&gt; SimplM (SimplFloats, SimplEnv)
</span><a href="#local-6989586621682978969"><span class="hs-identifier hs-var">simpl_bind</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682978964"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">InBind
</span><a href="#local-6989586621682978965"><span class="hs-identifier hs-var">bind</span></a></span><span>
</span><span id="line-223"></span><span>                                      </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682978970"><span class="annot"><a href="#local-6989586621682978970"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682978971"><span class="annot"><a href="#local-6989586621682978971"><span class="hs-identifier hs-var">env2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621682978959"><span class="hs-identifier hs-type">simpl_binds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682978968"><span class="hs-identifier hs-type">env1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682978966"><span class="hs-identifier hs-type">binds</span></a></span><span>
</span><span id="line-224"></span><span>                                      </span><span class="hs-comment">-- See Note [Bangs in the Simplifier]</span><span>
</span><span id="line-225"></span><span>                                      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682978972"><span class="annot"><a href="#local-6989586621682978972"><span class="hs-identifier hs-var hs-var">floats1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682978967"><span class="hs-identifier hs-var">float</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats -&gt; SimplFloats -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#addFloats"><span class="hs-operator hs-var">`addFloats`</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682978970"><span class="hs-identifier hs-var">floats</span></a></span><span>
</span><span id="line-226"></span><span>                                      </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682978972"><span class="hs-identifier hs-type">floats1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682978971"><span class="hs-identifier hs-type">env2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-227"></span><span>
</span><span id="line-228"></span><span>    </span><span id="local-6989586621682978969"><span class="annot"><span class="annottext">simpl_bind :: SimplEnv -&gt; InBind -&gt; SimplM (SimplFloats, SimplEnv)
</span><a href="#local-6989586621682978969"><span class="hs-identifier hs-var hs-var">simpl_bind</span></a></span></span><span> </span><span id="local-6989586621682978975"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682978975"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span id="local-6989586621682978977"><span class="annot"><span class="annottext">[(CoreBndr, CoreExpr)]
</span><a href="#local-6989586621682978977"><span class="hs-identifier hs-var">pairs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-229"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; BindContext
-&gt; [(CoreBndr, CoreExpr)]
-&gt; SimplM (SimplFloats, SimplEnv)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplRecBind"><span class="hs-identifier hs-var">simplRecBind</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682978975"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelFlag -&gt; RecFlag -&gt; BindContext
</span><a href="GHC.Core.Opt.Simplify.Utils.html#BC_Let"><span class="hs-identifier hs-var">BC_Let</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="GHC.Types.Basic.html#TopLevel"><span class="hs-identifier hs-var">TopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="GHC.Types.Basic.html#Recursive"><span class="hs-identifier hs-var">Recursive</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(CoreBndr, CoreExpr)]
</span><a href="#local-6989586621682978977"><span class="hs-identifier hs-var">pairs</span></a></span><span>
</span><span id="line-230"></span><span>    </span><span class="annot"><a href="#local-6989586621682978969"><span class="hs-identifier hs-var">simpl_bind</span></a></span><span> </span><span id="local-6989586621682978982"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682978982"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span id="local-6989586621682978984"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682978984"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682978985"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682978985"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-231"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682978986"><span class="annot"><span class="annottext">bind_cxt :: BindContext
</span><a href="#local-6989586621682978986"><span class="hs-identifier hs-var hs-var hs-var">bind_cxt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; RecFlag -&gt; BindContext
</span><a href="GHC.Core.Opt.Simplify.Utils.html#BC_Let"><span class="hs-identifier hs-var">BC_Let</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="GHC.Types.Basic.html#TopLevel"><span class="hs-identifier hs-var">TopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="GHC.Types.Basic.html#NonRecursive"><span class="hs-identifier hs-var">NonRecursive</span></a></span><span>
</span><span id="line-232"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682978988"><span class="annot"><a href="#local-6989586621682978988"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682978989"><span class="annot"><a href="#local-6989586621682978989"><span class="hs-identifier hs-var">b'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; CoreBndr
-&gt; CoreBndr
-&gt; BindContext
-&gt; SimplM (SimplEnv, CoreBndr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#addBndrRules"><span class="hs-identifier hs-var">addBndrRules</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682978982"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682978984"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; CoreBndr
</span><a href="GHC.Core.Opt.Simplify.Env.html#lookupRecBndr"><span class="hs-identifier hs-var">lookupRecBndr</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682978982"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682978984"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">BindContext
</span><a href="#local-6989586621682978986"><span class="hs-identifier hs-var">bind_cxt</span></a></span><span>
</span><span id="line-233"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplRecOrTopPair"><span class="hs-identifier hs-type">simplRecOrTopPair</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682978988"><span class="hs-identifier hs-type">env'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682978986"><span class="hs-identifier hs-type">bind_cxt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682978984"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682978989"><span class="hs-identifier hs-type">b'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682978985"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-234"></span><span>
</span><span id="line-235"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Lazy bindings
*                                                                      *
************************************************************************

simplRecBind is used for
        * recursive bindings only
-}</span><span>
</span><span id="line-245"></span><span>
</span><span id="line-246"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplRecBind"><span class="hs-identifier hs-type">simplRecBind</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BindContext"><span class="hs-identifier hs-type">BindContext</span></a></span><span>
</span><span id="line-247"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-248"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-249"></span><span id="simplRecBind"><span class="annot"><span class="annottext">simplRecBind :: SimplEnv
-&gt; BindContext
-&gt; [(CoreBndr, CoreExpr)]
-&gt; SimplM (SimplFloats, SimplEnv)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplRecBind"><span class="hs-identifier hs-var hs-var">simplRecBind</span></a></span></span><span> </span><span id="local-6989586621682978995"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682978995"><span class="hs-identifier hs-var">env0</span></a></span></span><span> </span><span id="local-6989586621682978996"><span class="annot"><span class="annottext">BindContext
</span><a href="#local-6989586621682978996"><span class="hs-identifier hs-var">bind_cxt</span></a></span></span><span> </span><span id="local-6989586621682978997"><span class="annot"><span class="annottext">[(CoreBndr, CoreExpr)]
</span><a href="#local-6989586621682978997"><span class="hs-identifier hs-var">pairs0</span></a></span></span><span>
</span><span id="line-250"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682978998"><span class="annot"><a href="#local-6989586621682978998"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682978999"><span class="annot"><a href="#local-6989586621682978999"><span class="hs-identifier hs-var">triples</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SimplEnv
 -&gt; (CoreBndr, CoreExpr)
 -&gt; SimplM (SimplEnv, (CoreBndr, CoreBndr, CoreExpr)))
-&gt; SimplEnv
-&gt; [(CoreBndr, CoreExpr)]
-&gt; SimplM (SimplEnv, [(CoreBndr, CoreBndr, CoreExpr)])
forall (m :: * -&gt; *) (t :: * -&gt; *) acc x y.
(Monad m, Traversable t) =&gt;
(acc -&gt; x -&gt; m (acc, y)) -&gt; acc -&gt; t x -&gt; m (acc, t y)
</span><a href="GHC.Utils.Monad.html#mapAccumLM"><span class="hs-identifier hs-var">mapAccumLM</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; (CoreBndr, CoreExpr)
-&gt; SimplM (SimplEnv, (CoreBndr, CoreBndr, CoreExpr))
</span><a href="#local-6989586621682979000"><span class="hs-identifier hs-var">add_rules</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682978995"><span class="hs-identifier hs-var">env0</span></a></span><span> </span><span class="annot"><span class="annottext">[(CoreBndr, CoreExpr)]
</span><a href="#local-6989586621682978997"><span class="hs-identifier hs-var">pairs0</span></a></span><span>
</span><span id="line-251"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682979001"><span class="annot"><a href="#local-6989586621682979001"><span class="hs-identifier hs-var hs-var">new_bndrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((CoreBndr, CoreBndr, CoreExpr) -&gt; CoreBndr)
-&gt; [(CoreBndr, CoreBndr, CoreExpr)] -&gt; [CoreBndr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(CoreBndr, CoreBndr, CoreExpr) -&gt; CoreBndr
forall a b c. (a, b, c) -&gt; b
</span><a href="GHC.Utils.Misc.html#sndOf3"><span class="hs-identifier hs-var">sndOf3</span></a></span><span> </span><span class="annot"><span class="annottext">[(CoreBndr, CoreBndr, CoreExpr)]
</span><a href="#local-6989586621682978999"><span class="hs-identifier hs-var">triples</span></a></span><span>
</span><span id="line-252"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979003"><span class="annot"><a href="#local-6989586621682979003"><span class="hs-identifier hs-var">rec_floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979004"><span class="annot"><a href="#local-6989586621682979004"><span class="hs-identifier hs-var">env2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#enterRecGroupRHSs"><span class="hs-identifier hs-type">enterRecGroupRHSs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682978998"><span class="hs-identifier hs-type">env1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979001"><span class="hs-identifier hs-type">new_bndrs</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682979006"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979006"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-253"></span><span>                                </span><span class="annot"><span class="annottext">SimplEnv
-&gt; [(CoreBndr, CoreBndr, CoreExpr)]
-&gt; SimplM (SimplFloats, SimplEnv)
</span><a href="#local-6989586621682979007"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979006"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[(CoreBndr, CoreBndr, CoreExpr)]
</span><a href="#local-6989586621682978999"><span class="hs-identifier hs-var">triples</span></a></span><span>
</span><span id="line-254"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#mkRecFloats"><span class="hs-identifier hs-type">mkRecFloats</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979003"><span class="hs-identifier hs-type">rec_floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682979004"><span class="hs-identifier hs-type">env2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-255"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-256"></span><span>    </span><span class="annot"><a href="#local-6989586621682979000"><span class="hs-identifier hs-type">add_rules</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#InBndr"><span class="hs-identifier hs-type">InBndr</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#InBndr"><span class="hs-identifier hs-type">InBndr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutBndr"><span class="hs-identifier hs-type">OutBndr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-257"></span><span>        </span><span class="hs-comment">-- Add the (substituted) rules to the binder</span><span>
</span><span id="line-258"></span><span>    </span><span id="local-6989586621682979000"><span class="annot"><span class="annottext">add_rules :: SimplEnv
-&gt; (CoreBndr, CoreExpr)
-&gt; SimplM (SimplEnv, (CoreBndr, CoreBndr, CoreExpr))
</span><a href="#local-6989586621682979000"><span class="hs-identifier hs-var hs-var">add_rules</span></a></span></span><span> </span><span id="local-6989586621682979011"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979011"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979012"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979012"><span class="hs-identifier hs-var">bndr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979013"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979013"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-259"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979014"><span class="annot"><a href="#local-6989586621682979014"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979015"><span class="annot"><a href="#local-6989586621682979015"><span class="hs-identifier hs-var">bndr'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; CoreBndr
-&gt; CoreBndr
-&gt; BindContext
-&gt; SimplM (SimplEnv, CoreBndr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#addBndrRules"><span class="hs-identifier hs-var">addBndrRules</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979011"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979012"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; CoreBndr
</span><a href="GHC.Core.Opt.Simplify.Env.html#lookupRecBndr"><span class="hs-identifier hs-var">lookupRecBndr</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979011"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979012"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">BindContext
</span><a href="#local-6989586621682978996"><span class="hs-identifier hs-var">bind_cxt</span></a></span><span>
</span><span id="line-260"></span><span>             </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979014"><span class="hs-identifier hs-type">env'</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979012"><span class="hs-identifier hs-type">bndr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682979015"><span class="hs-identifier hs-type">bndr'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682979013"><span class="hs-identifier hs-type">rhs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-261"></span><span>
</span><span id="line-262"></span><span>    </span><span id="local-6989586621682979007"><span class="annot"><span class="annottext">go :: SimplEnv
-&gt; [(CoreBndr, CoreBndr, CoreExpr)]
-&gt; SimplM (SimplFloats, SimplEnv)
</span><a href="#local-6989586621682979007"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621682979016"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979016"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SimplFloats, SimplEnv) -&gt; SimplM (SimplFloats, SimplEnv)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979016"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979016"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-263"></span><span>
</span><span id="line-264"></span><span>    </span><span class="annot"><a href="#local-6989586621682979007"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682979017"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979017"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621682979018"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979018"><span class="hs-identifier hs-var">old_bndr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979019"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979019"><span class="hs-identifier hs-var">new_bndr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979020"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979020"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682979021"><span class="annot"><span class="annottext">[(CoreBndr, CoreBndr, CoreExpr)]
</span><a href="#local-6989586621682979021"><span class="hs-identifier hs-var">pairs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-265"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979022"><span class="annot"><a href="#local-6989586621682979022"><span class="hs-identifier hs-var">float</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979023"><span class="annot"><a href="#local-6989586621682979023"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; BindContext
-&gt; CoreBndr
-&gt; CoreBndr
-&gt; CoreExpr
-&gt; SimplM (SimplFloats, SimplEnv)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplRecOrTopPair"><span class="hs-identifier hs-var">simplRecOrTopPair</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979017"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">BindContext
</span><a href="#local-6989586621682978996"><span class="hs-identifier hs-var">bind_cxt</span></a></span><span>
</span><span id="line-266"></span><span>                                                  </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979018"><span class="hs-identifier hs-var">old_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979019"><span class="hs-identifier hs-var">new_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979020"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-267"></span><span>             </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979024"><span class="annot"><a href="#local-6989586621682979024"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979025"><span class="annot"><a href="#local-6989586621682979025"><span class="hs-identifier hs-var">env2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621682979007"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979023"><span class="hs-identifier hs-type">env1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979021"><span class="hs-identifier hs-type">pairs</span></a></span><span>
</span><span id="line-268"></span><span>             </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979022"><span class="hs-identifier hs-type">float</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#addFloats"><span class="hs-operator hs-type">`addFloats`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979024"><span class="hs-identifier hs-type">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682979025"><span class="hs-identifier hs-type">env2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-269"></span><span>
</span><span id="line-270"></span><span class="hs-comment">{-
simplOrTopPair is used for
        * recursive bindings (whether top level or not)
        * top-level non-recursive bindings

It assumes the binder has already been simplified, but not its IdInfo.
-}</span><span>
</span><span id="line-277"></span><span>
</span><span id="line-278"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplRecOrTopPair"><span class="hs-identifier hs-type">simplRecOrTopPair</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span>
</span><span id="line-279"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BindContext"><span class="hs-identifier hs-type">BindContext</span></a></span><span>
</span><span id="line-280"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutBndr"><span class="hs-identifier hs-type">OutBndr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span>  </span><span class="hs-comment">-- Binder and rhs</span><span>
</span><span id="line-281"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-282"></span><span>
</span><span id="line-283"></span><span id="simplRecOrTopPair"><span class="annot"><span class="annottext">simplRecOrTopPair :: SimplEnv
-&gt; BindContext
-&gt; CoreBndr
-&gt; CoreBndr
-&gt; CoreExpr
-&gt; SimplM (SimplFloats, SimplEnv)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplRecOrTopPair"><span class="hs-identifier hs-var hs-var">simplRecOrTopPair</span></a></span></span><span> </span><span id="local-6989586621682979026"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979026"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979027"><span class="annot"><span class="annottext">BindContext
</span><a href="#local-6989586621682979027"><span class="hs-identifier hs-var">bind_cxt</span></a></span></span><span> </span><span id="local-6989586621682979028"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979028"><span class="hs-identifier hs-var">old_bndr</span></a></span></span><span> </span><span id="local-6989586621682979029"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979029"><span class="hs-identifier hs-var">new_bndr</span></a></span></span><span> </span><span id="local-6989586621682979030"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979030"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-284"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682979031"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979031"><span class="hs-identifier hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; TopLevelFlag
-&gt; CoreBndr
-&gt; CoreExpr
-&gt; SimplEnv
-&gt; Maybe SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Utils.html#preInlineUnconditionally"><span class="hs-identifier hs-var">preInlineUnconditionally</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979026"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BindContext -&gt; TopLevelFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#bindContextLevel"><span class="hs-identifier hs-var">bindContextLevel</span></a></span><span> </span><span class="annot"><span class="annottext">BindContext
</span><a href="#local-6989586621682979027"><span class="hs-identifier hs-var">bind_cxt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-285"></span><span>                                          </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979028"><span class="hs-identifier hs-var">old_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979030"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979026"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-286"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-#SCC</span><span> </span><span class="hs-pragma">&quot;simplRecOrTopPair-pre-inline-uncond&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-287"></span><span>    </span><span class="annot"><span class="annottext">String
-&gt; SDoc
-&gt; SimplM (SimplFloats, SimplEnv)
-&gt; SimplM (SimplFloats, SimplEnv)
forall a. String -&gt; SDoc -&gt; SimplM a -&gt; SimplM a
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplTrace"><span class="hs-identifier hs-var">simplTrace</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SimplBindr:inline-uncond&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979028"><span class="hs-identifier hs-var">old_bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SimplM (SimplFloats, SimplEnv) -&gt; SimplM (SimplFloats, SimplEnv))
-&gt; SimplM (SimplFloats, SimplEnv) -&gt; SimplM (SimplFloats, SimplEnv)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-288"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Tick -&gt; SimplM ()
</span><a href="GHC.Core.Opt.Simplify.Monad.html#tick"><span class="hs-identifier hs-var">tick</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Tick
</span><a href="GHC.Core.Opt.Stats.html#PreInlineUnconditionally"><span class="hs-identifier hs-var">PreInlineUnconditionally</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979028"><span class="hs-identifier hs-var">old_bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-289"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(SimplFloats, SimplEnv) -&gt; SimplM (SimplFloats, SimplEnv)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979026"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979031"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-290"></span><span>
</span><span id="line-291"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-292"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">BindContext
</span><a href="#local-6989586621682979027"><span class="hs-identifier hs-var">bind_cxt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-293"></span><span>      </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BC_Join"><span class="hs-identifier hs-type">BC_Join</span></a></span><span> </span><span id="local-6989586621682979039"><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621682979039"><span class="hs-identifier hs-var">is_rec</span></a></span></span><span> </span><span id="local-6989586621682979040"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979040"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
-&gt; SDoc
-&gt; SimplM (SimplFloats, SimplEnv)
-&gt; SimplM (SimplFloats, SimplEnv)
forall a. String -&gt; SDoc -&gt; SimplM a -&gt; SimplM a
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplTrace"><span class="hs-identifier hs-var">simplTrace</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SimplBind:join&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979028"><span class="hs-identifier hs-var">old_bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SimplM (SimplFloats, SimplEnv) -&gt; SimplM (SimplFloats, SimplEnv))
-&gt; SimplM (SimplFloats, SimplEnv) -&gt; SimplM (SimplFloats, SimplEnv)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-294"></span><span>                             </span><span class="annot"><span class="annottext">RecFlag
-&gt; SimplCont
-&gt; (CoreBndr, SimplEnv)
-&gt; (CoreBndr, SimplEnv)
-&gt; (CoreExpr, SimplEnv)
-&gt; SimplM (SimplFloats, SimplEnv)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplJoinBind"><span class="hs-identifier hs-var">simplJoinBind</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621682979039"><span class="hs-identifier hs-var">is_rec</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979040"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-295"></span><span>                                           </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979028"><span class="hs-identifier hs-var">old_bndr</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979026"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979029"><span class="hs-identifier hs-var">new_bndr</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979026"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979030"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979026"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-296"></span><span>
</span><span id="line-297"></span><span>      </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BC_Let"><span class="hs-identifier hs-type">BC_Let</span></a></span><span> </span><span id="local-6989586621682979042"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682979042"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621682979043"><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621682979043"><span class="hs-identifier hs-var">is_rec</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
-&gt; SDoc
-&gt; SimplM (SimplFloats, SimplEnv)
-&gt; SimplM (SimplFloats, SimplEnv)
forall a. String -&gt; SDoc -&gt; SimplM a -&gt; SimplM a
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplTrace"><span class="hs-identifier hs-var">simplTrace</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SimplBind:normal&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979028"><span class="hs-identifier hs-var">old_bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SimplM (SimplFloats, SimplEnv) -&gt; SimplM (SimplFloats, SimplEnv))
-&gt; SimplM (SimplFloats, SimplEnv) -&gt; SimplM (SimplFloats, SimplEnv)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-298"></span><span>                               </span><span class="annot"><span class="annottext">TopLevelFlag
-&gt; RecFlag
-&gt; (CoreBndr, SimplEnv)
-&gt; (CoreBndr, SimplEnv)
-&gt; (CoreExpr, SimplEnv)
-&gt; SimplM (SimplFloats, SimplEnv)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplLazyBind"><span class="hs-identifier hs-var">simplLazyBind</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682979042"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621682979043"><span class="hs-identifier hs-var">is_rec</span></a></span><span>
</span><span id="line-299"></span><span>                                             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979028"><span class="hs-identifier hs-var">old_bndr</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979026"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979029"><span class="hs-identifier hs-var">new_bndr</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979026"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979030"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979026"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-300"></span><span>
</span><span id="line-301"></span><span id="local-6989586621682978191"><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplTrace"><span class="hs-identifier hs-type">simplTrace</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682978191"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682978191"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-302"></span><span id="simplTrace"><span class="annot"><span class="annottext">simplTrace :: forall a. String -&gt; SDoc -&gt; SimplM a -&gt; SimplM a
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplTrace"><span class="hs-identifier hs-var hs-var">simplTrace</span></a></span></span><span> </span><span id="local-6989586621682979047"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621682979047"><span class="hs-identifier hs-var">herald</span></a></span></span><span> </span><span id="local-6989586621682979048"><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621682979048"><span class="hs-identifier hs-var">doc</span></a></span></span><span> </span><span id="local-6989586621682979049"><span class="annot"><span class="annottext">SimplM a
</span><a href="#local-6989586621682979049"><span class="hs-identifier hs-var">thing_inside</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-303"></span><span>  </span><span id="local-6989586621682979050"><span class="annot"><a href="#local-6989586621682979050"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplM Logger
forall (m :: * -&gt; *). HasLogger m =&gt; m Logger
</span><a href="GHC.Utils.Logger.html#getLogger"><span class="hs-identifier hs-var">getLogger</span></a></span><span>
</span><span id="line-304"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#logHasDumpFlag"><span class="hs-identifier hs-type">logHasDumpFlag</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979050"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><a href="GHC.Driver.Flags.html#Opt_D_verbose_core2core"><span class="hs-identifier hs-type">Opt_D_verbose_core2core</span></a></span><span>
</span><span id="line-305"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#logTraceMsg"><span class="hs-identifier hs-type">logTraceMsg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979050"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979047"><span class="hs-identifier hs-type">herald</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979048"><span class="hs-identifier hs-type">doc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979049"><span class="hs-identifier hs-type">thing_inside</span></a></span><span>
</span><span id="line-306"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><a href="#local-6989586621682979049"><span class="hs-identifier hs-type">thing_inside</span></a></span><span>
</span><span id="line-307"></span><span>
</span><span id="line-308"></span><span class="hs-comment">--------------------------</span><span>
</span><span id="line-309"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplLazyBind"><span class="hs-identifier hs-type">simplLazyBind</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#RecFlag"><span class="hs-identifier hs-type">RecFlag</span></a></span><span>
</span><span id="line-310"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span class="hs-special">)</span><span>       </span><span class="hs-comment">-- InBinder, and static env for its unfolding (if any)</span><span>
</span><span id="line-311"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span class="hs-special">)</span><span>      </span><span class="hs-comment">-- OutBinder, and SimplEnv after simplifying that binder</span><span>
</span><span id="line-312"></span><span>                                        </span><span class="hs-comment">-- The OutId has IdInfo (notably RULES),</span><span>
</span><span id="line-313"></span><span>                                        </span><span class="hs-comment">-- except arity, unfolding</span><span>
</span><span id="line-314"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span class="hs-special">)</span><span>     </span><span class="hs-comment">-- The RHS and its static environment</span><span>
</span><span id="line-315"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-316"></span><span class="hs-comment">-- Precondition: Ids only, no TyVars; not a JoinId</span><span>
</span><span id="line-317"></span><span class="hs-comment">-- Precondition: rhs obeys the let-can-float invariant</span><span>
</span><span id="line-318"></span><span id="simplLazyBind"><span class="annot"><span class="annottext">simplLazyBind :: TopLevelFlag
-&gt; RecFlag
-&gt; (CoreBndr, SimplEnv)
-&gt; (CoreBndr, SimplEnv)
-&gt; (CoreExpr, SimplEnv)
-&gt; SimplM (SimplFloats, SimplEnv)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplLazyBind"><span class="hs-identifier hs-var hs-var">simplLazyBind</span></a></span></span><span> </span><span id="local-6989586621682979056"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682979056"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621682979057"><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621682979057"><span class="hs-identifier hs-var">is_rec</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979058"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979058"><span class="hs-identifier hs-var">bndr</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682979059"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979059"><span class="hs-identifier hs-var">unf_se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979060"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979060"><span class="hs-identifier hs-var">bndr1</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682979061"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979061"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979062"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979062"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682979063"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979063"><span class="hs-identifier hs-var">rhs_se</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-319"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; (Bool
    -&gt; SDoc
    -&gt; SimplM (SimplFloats, SimplEnv)
    -&gt; SimplM (SimplFloats, SimplEnv))
-&gt; Bool
-&gt; SDoc
-&gt; SimplM (SimplFloats, SimplEnv)
-&gt; SimplM (SimplFloats, SimplEnv)
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979058"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-320"></span><span>    </span><span class="annot"><span class="annottext">Bool
-&gt; SDoc
-&gt; SimplM (SimplFloats, SimplEnv)
-&gt; SimplM (SimplFloats, SimplEnv)
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979058"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979058"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SimplM (SimplFloats, SimplEnv) -&gt; SimplM (SimplFloats, SimplEnv))
-&gt; SimplM (SimplFloats, SimplEnv) -&gt; SimplM (SimplFloats, SimplEnv)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-321"></span><span>    </span><span class="hs-comment">-- pprTrace &quot;simplLazyBind&quot; ((ppr bndr &lt;+&gt; ppr bndr1) $$ ppr rhs $$ ppr (seIdSubst rhs_se)) $</span><span>
</span><span id="line-322"></span><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span>   </span><span class="hs-glyph">!</span><span id="local-6989586621682979069"><span class="annot"><span class="annottext">rhs_env :: SimplEnv
</span><a href="#local-6989586621682979069"><span class="hs-identifier hs-var hs-var hs-var">rhs_env</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979063"><span class="hs-identifier hs-var">rhs_se</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplEnv -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#setInScopeFromE"><span class="hs-operator hs-var">`setInScopeFromE`</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979061"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-comment">-- See Note [Bangs in the Simplifier]</span><span>
</span><span id="line-323"></span><span>                </span><span class="hs-special">(</span><span id="local-6989586621682979071"><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682979071"><span class="hs-identifier hs-var hs-var">tvs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979072"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979072"><span class="hs-identifier hs-var hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; ([CoreBndr], [CoreBndr], CoreExpr)
</span><a href="GHC.Core.html#collectTyAndValBinders"><span class="hs-identifier hs-var">collectTyAndValBinders</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979062"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-324"></span><span>                                </span><span class="hs-special">(</span><span id="local-6989586621682979074"><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682979074"><span class="hs-identifier hs-var">tvs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979075"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979075"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-325"></span><span>                                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
forall {b}. Expr b -&gt; Bool
</span><a href="#local-6989586621682979076"><span class="hs-identifier hs-var">surely_not_lam</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979075"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682979074"><span class="hs-identifier hs-var">tvs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979075"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-326"></span><span>                                </span><span class="annot"><span class="annottext">([CoreBndr], [CoreBndr], CoreExpr)
</span><span class="hs-identifier">_</span></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979062"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-327"></span><span>
</span><span id="line-328"></span><span>                </span><span id="local-6989586621682979076"><span class="annot"><span class="annottext">surely_not_lam :: Expr b -&gt; Bool
</span><a href="#local-6989586621682979076"><span class="hs-identifier hs-var hs-var hs-var">surely_not_lam</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-329"></span><span>                </span><span class="annot"><a href="#local-6989586621682979076"><span class="hs-identifier hs-var">surely_not_lam</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621682979079"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682979079"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621682979080"><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621682979080"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-330"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682979079"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr b -&gt; Bool
</span><a href="#local-6989586621682979076"><span class="hs-identifier hs-var">surely_not_lam</span></a></span><span> </span><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621682979080"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-331"></span><span>                   </span><span class="hs-comment">-- eta-reduction could float</span><span>
</span><span id="line-332"></span><span>                </span><span class="annot"><a href="#local-6989586621682979076"><span class="hs-identifier hs-var">surely_not_lam</span></a></span><span> </span><span class="annot"><span class="annottext">Expr b
</span><span class="hs-identifier">_</span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-333"></span><span>                        </span><span class="hs-comment">-- Do not do the &quot;abstract tyvar&quot; thing if there's</span><span>
</span><span id="line-334"></span><span>                        </span><span class="hs-comment">-- a lambda inside, because it defeats eta-reduction</span><span>
</span><span id="line-335"></span><span>                        </span><span class="hs-comment">--    f = /\a. \x. g a x</span><span>
</span><span id="line-336"></span><span>                        </span><span class="hs-comment">-- should eta-reduce.</span><span>
</span><span id="line-337"></span><span>
</span><span id="line-338"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979082"><span class="annot"><a href="#local-6989586621682979082"><span class="hs-identifier hs-var">body_env</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979083"><span class="annot"><a href="#local-6989586621682979083"><span class="hs-identifier hs-var">tvs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-pragma">{-#SCC</span><span> </span><span class="hs-pragma">&quot;simplBinders&quot;</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; [CoreBndr] -&gt; SimplM (SimplEnv, [CoreBndr])
</span><a href="GHC.Core.Opt.Simplify.Env.html#simplBinders"><span class="hs-identifier hs-var">simplBinders</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979069"><span class="hs-identifier hs-var">rhs_env</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682979071"><span class="hs-identifier hs-var">tvs</span></a></span><span>
</span><span id="line-339"></span><span>                </span><span class="hs-comment">-- See Note [Floating and type abstraction] in GHC.Core.Opt.Simplify.Utils</span><span>
</span><span id="line-340"></span><span>
</span><span id="line-341"></span><span>        </span><span class="hs-comment">-- Simplify the RHS</span><span>
</span><span id="line-342"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682979085"><span class="annot"><a href="#local-6989586621682979085"><span class="hs-identifier hs-var hs-var">rhs_cont</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Kind -&gt; RecFlag -&gt; Demand -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#mkRhsStop"><span class="hs-identifier hs-var">mkRhsStop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; SimplEnv -&gt; Kind -&gt; Kind
SimplEnv -&gt; Kind -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Env.html#substTy"><span class="hs-identifier hs-var">substTy</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979082"><span class="hs-identifier hs-var">body_env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; Kind
CoreExpr -&gt; Kind
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979072"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-343"></span><span>                                   </span><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621682979057"><span class="hs-identifier hs-var">is_rec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Demand
</span><a href="GHC.Types.Id.html#idDemandInfo"><span class="hs-identifier hs-var">idDemandInfo</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979058"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-344"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979090"><span class="annot"><a href="#local-6989586621682979090"><span class="hs-identifier hs-var">body_floats0</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979091"><span class="annot"><a href="#local-6989586621682979091"><span class="hs-identifier hs-var">body0</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-pragma">{-#SCC</span><span> </span><span class="hs-pragma">&quot;simplExprF&quot;</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF"><span class="hs-identifier hs-type">simplExprF</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979082"><span class="hs-identifier hs-type">body_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979072"><span class="hs-identifier hs-type">body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979085"><span class="hs-identifier hs-type">rhs_cont</span></a></span><span>
</span><span id="line-345"></span><span>
</span><span id="line-346"></span><span>        </span><span class="hs-comment">-- ANF-ise a constructor or PAP rhs</span><span>
</span><span id="line-347"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979093"><span class="annot"><a href="#local-6989586621682979093"><span class="hs-identifier hs-var">body_floats2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979094"><span class="annot"><a href="#local-6989586621682979094"><span class="hs-identifier hs-var">body2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-pragma">{-#SCC</span><span> </span><span class="hs-pragma">&quot;prepareBinding&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-348"></span><span>                                   </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#prepareBinding"><span class="hs-identifier hs-type">prepareBinding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979061"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979056"><span class="hs-identifier hs-type">top_lvl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979057"><span class="hs-identifier hs-type">is_rec</span></a></span><span>
</span><span id="line-349"></span><span>                                                  </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span>  </span><span class="hs-comment">-- Not strict; this is simplLazyBind</span><span>
</span><span id="line-350"></span><span>                                                  </span><span class="annot"><a href="#local-6989586621682979060"><span class="hs-identifier hs-type">bndr1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979090"><span class="hs-identifier hs-type">body_floats0</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979091"><span class="hs-identifier hs-type">body0</span></a></span><span>
</span><span id="line-351"></span><span>          </span><span class="hs-comment">-- Subtle point: we do not need or want tvs' in the InScope set</span><span>
</span><span id="line-352"></span><span>          </span><span class="hs-comment">-- of body_floats2, so we pass in 'env' not 'body_env'.</span><span>
</span><span id="line-353"></span><span>          </span><span class="hs-comment">-- Don't want: if tvs' are in-scope in the scope of this let-binding, we may do</span><span>
</span><span id="line-354"></span><span>          </span><span class="hs-comment">-- more renaming than necessary =&gt; extra work (see !7777 and test T16577).</span><span>
</span><span id="line-355"></span><span>          </span><span class="hs-comment">-- Don't need: we wrap tvs' around the RHS anyway.</span><span>
</span><span id="line-356"></span><span>
</span><span id="line-357"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979096"><span class="annot"><a href="#local-6989586621682979096"><span class="hs-identifier hs-var">rhs_floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979097"><span class="annot"><a href="#local-6989586621682979097"><span class="hs-identifier hs-var">body3</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-358"></span><span>            </span><span class="hs-glyph">&lt;-</span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#isEmptyFloats"><span class="hs-identifier hs-type">isEmptyFloats</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979093"><span class="hs-identifier hs-type">body_floats2</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">||</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">null</span></span><span> </span><span class="annot"><a href="#local-6989586621682979071"><span class="hs-identifier hs-type">tvs</span></a></span><span> </span><span class="hs-keyword">then</span><span>   </span><span class="hs-comment">-- Simple floating</span><span>
</span><span id="line-359"></span><span>                     </span><span class="hs-pragma">{-#SCC</span><span> </span><span class="hs-pragma">&quot;simplLazyBind-simple-floating&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-360"></span><span>                     </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979093"><span class="hs-identifier hs-type">body_floats2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682979094"><span class="hs-identifier hs-type">body2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-361"></span><span>
</span><span id="line-362"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-comment">-- Non-empty floats, and non-empty tyvars: do type-abstraction first</span><span>
</span><span id="line-363"></span><span>                     </span><span class="hs-pragma">{-#SCC</span><span> </span><span class="hs-pragma">&quot;simplLazyBind-type-abstraction-first&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-364"></span><span>                     </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979101"><span class="annot"><a href="#local-6989586621682979101"><span class="hs-identifier hs-var">poly_binds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979102"><span class="annot"><a href="#local-6989586621682979102"><span class="hs-identifier hs-var">body3</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#abstractFloats"><span class="hs-identifier hs-type">abstractFloats</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#seUnfoldingOpts"><span class="hs-identifier hs-type">seUnfoldingOpts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979061"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682979056"><span class="hs-identifier hs-type">top_lvl</span></a></span><span>
</span><span id="line-365"></span><span>                                                                </span><span class="annot"><a href="#local-6989586621682979083"><span class="hs-identifier hs-type">tvs'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979093"><span class="hs-identifier hs-type">body_floats2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979094"><span class="hs-identifier hs-type">body2</span></a></span><span>
</span><span id="line-366"></span><span>                        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682979105"><span class="annot"><a href="#local-6989586621682979105"><span class="hs-identifier hs-var hs-var">poly_floats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SimplFloats -&gt; InBind -&gt; SimplFloats)
-&gt; SimplFloats -&gt; [InBind] -&gt; SimplFloats
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="annot"><span class="annottext">SimplFloats -&gt; InBind -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#extendFloats"><span class="hs-identifier hs-var">extendFloats</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979061"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[InBind]
</span><a href="#local-6989586621682979101"><span class="hs-identifier hs-var">poly_binds</span></a></span><span>
</span><span id="line-367"></span><span>                        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979105"><span class="hs-identifier hs-type">poly_floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682979102"><span class="hs-identifier hs-type">body3</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-368"></span><span>
</span><span id="line-369"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682979108"><span class="annot"><a href="#local-6989586621682979108"><span class="hs-identifier hs-var hs-var">env1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979061"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplFloats -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#setInScopeFromF"><span class="hs-operator hs-var">`setInScopeFromF`</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682979096"><span class="hs-identifier hs-var">rhs_floats</span></a></span><span>
</span><span id="line-370"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682979110"><span class="annot"><a href="#local-6989586621682979110"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#rebuildLam"><span class="hs-identifier hs-type">rebuildLam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979108"><span class="hs-identifier hs-type">env1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979083"><span class="hs-identifier hs-type">tvs'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979097"><span class="hs-identifier hs-type">body3</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979085"><span class="hs-identifier hs-type">rhs_cont</span></a></span><span>
</span><span id="line-371"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979112"><span class="annot"><a href="#local-6989586621682979112"><span class="hs-identifier hs-var">bind_float</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979113"><span class="annot"><a href="#local-6989586621682979113"><span class="hs-identifier hs-var">env2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#completeBind"><span class="hs-identifier hs-type">completeBind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BC_Let"><span class="hs-identifier hs-type">BC_Let</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979056"><span class="hs-identifier hs-type">top_lvl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979057"><span class="hs-identifier hs-type">is_rec</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979058"><span class="hs-identifier hs-type">bndr</span></a></span><span class="hs-special">,</span><span class="annot"><a href="#local-6989586621682979059"><span class="hs-identifier hs-type">unf_se</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979060"><span class="hs-identifier hs-type">bndr1</span></a></span><span class="hs-special">,</span><span class="annot"><a href="#local-6989586621682979110"><span class="hs-identifier hs-type">rhs'</span></a></span><span class="hs-special">,</span><span class="annot"><a href="#local-6989586621682979108"><span class="hs-identifier hs-type">env1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-372"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979096"><span class="hs-identifier hs-type">rhs_floats</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#addFloats"><span class="hs-operator hs-type">`addFloats`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979112"><span class="hs-identifier hs-type">bind_float</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682979113"><span class="hs-identifier hs-type">env2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-373"></span><span>
</span><span id="line-374"></span><span class="hs-comment">--------------------------</span><span>
</span><span id="line-375"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplJoinBind"><span class="hs-identifier hs-type">simplJoinBind</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#RecFlag"><span class="hs-identifier hs-type">RecFlag</span></a></span><span>
</span><span id="line-376"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-377"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span class="hs-special">)</span><span>       </span><span class="hs-comment">-- InBinder, with static env for its unfolding</span><span>
</span><span id="line-378"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span class="hs-special">)</span><span>      </span><span class="hs-comment">-- OutBinder; SimplEnv has the binder in scope</span><span>
</span><span id="line-379"></span><span>                                        </span><span class="hs-comment">-- The OutId has IdInfo, except arity, unfolding</span><span>
</span><span id="line-380"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span class="hs-special">)</span><span>     </span><span class="hs-comment">-- The right hand side and its env</span><span>
</span><span id="line-381"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-382"></span><span id="simplJoinBind"><span class="annot"><span class="annottext">simplJoinBind :: RecFlag
-&gt; SimplCont
-&gt; (CoreBndr, SimplEnv)
-&gt; (CoreBndr, SimplEnv)
-&gt; (CoreExpr, SimplEnv)
-&gt; SimplM (SimplFloats, SimplEnv)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplJoinBind"><span class="hs-identifier hs-var hs-var">simplJoinBind</span></a></span></span><span> </span><span id="local-6989586621682979115"><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621682979115"><span class="hs-identifier hs-var">is_rec</span></a></span></span><span> </span><span id="local-6989586621682979116"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979116"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979117"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979117"><span class="hs-identifier hs-var">old_bndr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979118"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979118"><span class="hs-identifier hs-var">unf_se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979119"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979119"><span class="hs-identifier hs-var">new_bndr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979120"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979120"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979121"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979121"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979122"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979122"><span class="hs-identifier hs-var">rhs_se</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-383"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682979123"><span class="annot"><span class="annottext">rhs_env :: SimplEnv
</span><a href="#local-6989586621682979123"><span class="hs-identifier hs-var hs-var hs-var">rhs_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979122"><span class="hs-identifier hs-var">rhs_se</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplEnv -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#setInScopeFromE"><span class="hs-operator hs-var">`setInScopeFromE`</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979120"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-384"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682979124"><span class="annot"><a href="#local-6989586621682979124"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplJoinRhs"><span class="hs-identifier hs-var">simplJoinRhs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979123"><span class="hs-identifier hs-var">rhs_env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979117"><span class="hs-identifier hs-var">old_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979121"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979116"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-385"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#completeBind"><span class="hs-identifier hs-type">completeBind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BC_Join"><span class="hs-identifier hs-type">BC_Join</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979115"><span class="hs-identifier hs-type">is_rec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979116"><span class="hs-identifier hs-type">cont</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979117"><span class="hs-identifier hs-type">old_bndr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682979118"><span class="hs-identifier hs-type">unf_se</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979119"><span class="hs-identifier hs-type">new_bndr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682979124"><span class="hs-identifier hs-type">rhs'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682979120"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-386"></span><span>
</span><span id="line-387"></span><span class="hs-comment">--------------------------</span><span>
</span><span id="line-388"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplAuxBind"><span class="hs-identifier hs-type">simplAuxBind</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-389"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span>
</span><span id="line-390"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span>            </span><span class="hs-comment">-- Old binder; not a JoinId</span><span>
</span><span id="line-391"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>         </span><span class="hs-comment">-- Simplified RHS</span><span>
</span><span id="line-392"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-393"></span><span class="hs-comment">-- A specialised variant of completeBindX used to construct non-recursive</span><span>
</span><span id="line-394"></span><span class="hs-comment">-- auxiliary bindings, notably in knownCon.</span><span>
</span><span id="line-395"></span><span class="hs-comment">--</span><span>
</span><span id="line-396"></span><span class="hs-comment">-- The binder comes from a case expression (case binder or alternative)</span><span>
</span><span id="line-397"></span><span class="hs-comment">-- and so does not have rules, unfolding, inline pragmas etc.</span><span>
</span><span id="line-398"></span><span class="hs-comment">--</span><span>
</span><span id="line-399"></span><span class="hs-comment">-- Precondition: rhs satisfies the let-can-float invariant</span><span>
</span><span id="line-400"></span><span>
</span><span id="line-401"></span><span id="simplAuxBind"><span class="annot"><span class="annottext">simplAuxBind :: String
-&gt; SimplEnv
-&gt; CoreBndr
-&gt; CoreExpr
-&gt; SimplM (SimplFloats, SimplEnv)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplAuxBind"><span class="hs-identifier hs-var hs-var">simplAuxBind</span></a></span></span><span> </span><span id="local-6989586621682979128"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621682979128"><span class="hs-identifier hs-var">_str</span></a></span></span><span> </span><span id="local-6989586621682979129"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979129"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979130"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979130"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682979131"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979131"><span class="hs-identifier hs-var">new_rhs</span></a></span></span><span>
</span><span id="line-402"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; Bool -&gt; Bool
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979130"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979130"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979130"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-403"></span><span>    </span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Id.html#isDeadBinder"><span class="hs-identifier hs-var">isDeadBinder</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979130"><span class="hs-identifier hs-var">bndr</span></a></span><span>   </span><span class="hs-comment">-- Not uncommon; e.g. case (a,b) of c { (p,q) -&gt; p }</span><span>
</span><span id="line-404"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SimplFloats, SimplEnv) -&gt; SimplM (SimplFloats, SimplEnv)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979129"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979129"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>    </span><span class="hs-comment">--  Here c is dead, and we avoid</span><span>
</span><span id="line-405"></span><span>                                     </span><span class="hs-comment">--  creating the binding c = (a,b)</span><span>
</span><span id="line-406"></span><span>
</span><span id="line-407"></span><span>  </span><span class="hs-comment">-- Next we have a fast-path for cases that would be inlined unconditionally by</span><span>
</span><span id="line-408"></span><span>  </span><span class="hs-comment">-- completeBind: but it seems not uncommon, and it turns to be a little more</span><span>
</span><span id="line-409"></span><span>  </span><span class="hs-comment">-- efficient (in compile time allocations) to do it here.</span><span>
</span><span id="line-410"></span><span>  </span><span class="hs-comment">-- Effectively this is just a vastly-simplified postInlineUnconditionally</span><span>
</span><span id="line-411"></span><span>  </span><span class="hs-comment">--   See Note [Post-inline for single-use things] in GHC.Core.Opt.Simplify.Utils</span><span>
</span><span id="line-412"></span><span>  </span><span class="hs-comment">-- We could instead use postInlineUnconditionally itself, but I think it's simpler</span><span>
</span><span id="line-413"></span><span>  </span><span class="hs-comment">--   and more direct to focus on the &quot;hot&quot; cases.</span><span>
</span><span id="line-414"></span><span>  </span><span class="hs-comment">-- e.g. auxiliary bindings have no NOLINE pragmas, RULEs, or stable unfoldings</span><span>
</span><span id="line-415"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979131"><span class="hs-identifier hs-var">new_rhs</span></a></span><span>  </span><span class="hs-comment">-- Short-cut for let x = y in ...</span><span>
</span><span id="line-416"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; OccInfo
</span><a href="GHC.Types.Id.html#idOccInfo"><span class="hs-identifier hs-var">idOccInfo</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979130"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-417"></span><span>          </span><span class="annot"><a href="GHC.Types.Basic.html#OneOcc"><span class="hs-identifier hs-type">OneOcc</span></a></span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">occ_n_br :: OccInfo -&gt; Int
</span><a href="GHC.Types.Basic.html#occ_n_br"><span class="hs-identifier hs-var">occ_n_br</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">occ_in_lam :: OccInfo -&gt; InsideLam
</span><a href="GHC.Types.Basic.html#occ_in_lam"><span class="hs-identifier hs-var">occ_in_lam</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InsideLam
</span><a href="GHC.Types.Basic.html#NotInsideLam"><span class="hs-identifier hs-var">NotInsideLam</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-418"></span><span>          </span><span class="annot"><span class="annottext">OccInfo
</span><span class="hs-identifier">_</span></span><span>                                                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-419"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SimplFloats, SimplEnv) -&gt; SimplM (SimplFloats, SimplEnv)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979129"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-420"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; CoreExpr -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#extendCvIdSubst"><span class="hs-identifier hs-var">extendCvIdSubst</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979129"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979130"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979131"><span class="hs-identifier hs-var">new_rhs</span></a></span><span> </span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- bndr can be a CoVar</span><span>
</span><span id="line-421"></span><span>
</span><span id="line-422"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-423"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- ANF-ise the RHS</span><span>
</span><span id="line-424"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682979141"><span class="annot"><span class="annottext">occ_fs :: FastString
</span><a href="#local-6989586621682979141"><span class="hs-identifier hs-var hs-var hs-var">occ_fs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; FastString
forall a. NamedThing a =&gt; a -&gt; FastString
</span><a href="GHC.Types.Name.html#getOccFS"><span class="hs-identifier hs-var">getOccFS</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979130"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-425"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979142"><span class="annot"><a href="#local-6989586621682979142"><span class="hs-identifier hs-var">anf_floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979143"><span class="annot"><a href="#local-6989586621682979143"><span class="hs-identifier hs-var">rhs1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
SimplEnv
-&gt; TopLevelFlag
-&gt; FastString
-&gt; CoreExpr
-&gt; SimplM (LetFloats, CoreExpr)
SimplEnv
-&gt; TopLevelFlag
-&gt; FastString
-&gt; CoreExpr
-&gt; SimplM (LetFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#prepareRhs"><span class="hs-identifier hs-var">prepareRhs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979129"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="GHC.Types.Basic.html#NotTopLevel"><span class="hs-identifier hs-var">NotTopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621682979141"><span class="hs-identifier hs-var">occ_fs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979131"><span class="hs-identifier hs-var">new_rhs</span></a></span><span>
</span><span id="line-426"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#isEmptyLetFloats"><span class="hs-identifier hs-type">isEmptyLetFloats</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979142"><span class="hs-identifier hs-type">anf_floats</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#tick"><span class="hs-identifier hs-type">tick</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Stats.html#LetFloatFromLet"><span class="hs-identifier hs-type">LetFloatFromLet</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-427"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682979149"><span class="annot"><a href="#local-6989586621682979149"><span class="hs-identifier hs-var hs-var">rhs_floats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979129"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats -&gt; LetFloats -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#addLetFloats"><span class="hs-operator hs-var">`addLetFloats`</span></a></span><span> </span><span class="annot"><span class="annottext">LetFloats
</span><a href="#local-6989586621682979142"><span class="hs-identifier hs-var">anf_floats</span></a></span><span>
</span><span id="line-428"></span><span>
</span><span id="line-429"></span><span>          </span><span class="hs-comment">-- Simplify the binder and complete the binding</span><span>
</span><span id="line-430"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979151"><span class="annot"><a href="#local-6989586621682979151"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979152"><span class="annot"><a href="#local-6989586621682979152"><span class="hs-identifier hs-var">new_bndr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#simplBinder"><span class="hs-identifier hs-type">simplBinder</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979129"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#setInScopeFromF"><span class="hs-operator hs-type">`setInScopeFromF`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979149"><span class="hs-identifier hs-type">rhs_floats</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682979130"><span class="hs-identifier hs-type">bndr</span></a></span><span>
</span><span id="line-431"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979154"><span class="annot"><a href="#local-6989586621682979154"><span class="hs-identifier hs-var">bind_float</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979155"><span class="annot"><a href="#local-6989586621682979155"><span class="hs-identifier hs-var">env2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#completeBind"><span class="hs-identifier hs-type">completeBind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BC_Let"><span class="hs-identifier hs-type">BC_Let</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#NotTopLevel"><span class="hs-identifier hs-type">NotTopLevel</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#NonRecursive"><span class="hs-identifier hs-type">NonRecursive</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-432"></span><span>                                             </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979130"><span class="hs-identifier hs-type">bndr</span></a></span><span class="hs-special">,</span><span class="annot"><a href="#local-6989586621682979129"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979152"><span class="hs-identifier hs-type">new_bndr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682979143"><span class="hs-identifier hs-type">rhs1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682979151"><span class="hs-identifier hs-type">env1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-433"></span><span>
</span><span id="line-434"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979149"><span class="hs-identifier hs-type">rhs_floats</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#addFloats"><span class="hs-operator hs-type">`addFloats`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979154"><span class="hs-identifier hs-type">bind_float</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682979155"><span class="hs-identifier hs-type">env2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-435"></span><span>
</span><span id="line-436"></span><span>
</span><span id="line-437"></span><span class="annot"><span class="hs-comment">{- *********************************************************************
*                                                                      *
           Cast worker/wrapper
*                                                                      *
************************************************************************

Note [Cast worker/wrapper]
~~~~~~~~~~~~~~~~~~~~~~~~~~
When we have a binding
   x = e |&gt; co
we want to do something very similar to worker/wrapper:
   $wx = e
   x = $wx |&gt; co

We call this making a cast worker/wrapper in tryCastWorkerWrapper.

The main motivaiton is that x can be inlined freely.  There's a chance
that e will be a constructor application or function, or something
like that, so moving the coercion to the usage site may well cancel
the coercions and lead to further optimisation.  Example:

     data family T a :: *
     data instance T Int = T Int

     foo :: Int -&gt; Int -&gt; Int
     foo m n = ...
        where
          t = T m
          go 0 = 0
          go n = case t of { T m -&gt; go (n-m) }
                -- This case should optimise

A second reason for doing cast worker/wrapper is that the worker/wrapper
pass after strictness analysis can't deal with RHSs like
     f = (\ a b c. blah) |&gt; co
Instead, it relies on cast worker/wrapper to get rid of the cast,
leaving a simpler job for demand-analysis worker/wrapper.  See #19874.

Wrinkles

1. We must /not/ do cast w/w on
     f = g |&gt; co
   otherwise it'll just keep repeating forever! You might think this
   is avoided because the call to tryCastWorkerWrapper is guarded by
   preInlineUnconditinally, but I'm worried that a loop-breaker or an
   exported Id might say False to preInlineUnonditionally.

2. We need to be careful with inline/noinline pragmas:
       rec { {-# NOINLINE f #-}
             f = (...g...) |&gt; co
           ; g = ...f... }
   This is legitimate -- it tells GHC to use f as the loop breaker
   rather than g.  Now we do the cast thing, to get something like
       rec { $wf = ...g...
           ; f = $wf |&gt; co
           ; g = ...f... }
   Where should the NOINLINE pragma go?  If we leave it on f we'll get
     rec { $wf = ...g...
         ; {-# NOINLINE f #-}
           f = $wf |&gt; co
         ; g = ...f... }
   and that is bad: the whole point is that we want to inline that
   cast!  We want to transfer the pagma to $wf:
      rec { {-# NOINLINE $wf #-}
            $wf = ...g...
          ; f = $wf |&gt; co
          ; g = ...f... }
   c.f. Note [Worker/wrapper for NOINLINE functions] in GHC.Core.Opt.WorkWrap.

3. We should still do cast w/w even if `f` is INLINEABLE.  E.g.
      {- f: Stable unfolding = &lt;stable-big&gt; -}
      f = (\xy. &lt;big-body&gt;) |&gt; co
   Then we want to w/w to
      {- $wf: Stable unfolding = &lt;stable-big&gt; |&gt; sym co -}
      $wf = \xy. &lt;big-body&gt;
      f = $wf |&gt; co
   Notice that the stable unfolding moves to the worker!  Now demand analysis
   will work fine on $wf, whereas it has trouble with the original f.
   c.f. Note [Worker/wrapper for INLINABLE functions] in GHC.Core.Opt.WorkWrap.
   This point also applies to strong loopbreakers with INLINE pragmas, see
   wrinkle (4).

4. We should /not/ do cast w/w for non-loop-breaker INLINE functions (hence
   hasInlineUnfolding in tryCastWorkerWrapper, which responds False to
   loop-breakers) because they'll definitely be inlined anyway, cast and
   all. And if we do cast w/w for an INLINE function with arity zero, we get
   something really silly: we inline that &quot;worker&quot; right back into the wrapper!
   Worse than a no-op, because we have then lost the stable unfolding.

All these wrinkles are exactly like worker/wrapper for strictness analysis:
  f is the wrapper and must inline like crazy
  $wf is the worker and must carry f's original pragma
See Note [Worker/wrapper for INLINABLE functions]
and Note [Worker/wrapper for NOINLINE functions] in GHC.Core.Opt.WorkWrap.

See #17673, #18093, #18078, #19890.

Note [Preserve strictness in cast w/w]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In the Note [Cast worker/wrapper] transformation, keep the strictness info.
Eg
        f = e `cast` co    -- f has strictness SSL
When we transform to
        f' = e             -- f' also has strictness SSL
        f = f' `cast` co   -- f still has strictness SSL

Its not wrong to drop it on the floor, but better to keep it.

Note [Preserve RuntimeRep info in cast w/w]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We must not do cast w/w when the presence of the coercion is needed in order
to determine the runtime representation.

Example:

  Suppose we have a type family:

    type F :: RuntimeRep
    type family F where
      F = LiftedRep

  together with a type `ty :: TYPE F` and a top-level binding

    a :: ty |&gt; TYPE F[0]

  The kind of `ty |&gt; TYPE F[0]` is `LiftedRep`, so `a` is a top-level lazy binding.
  However, were we to apply cast w/w, we would get:

    b :: ty
    b = ...

    a :: ty |&gt; TYPE F[0]
    a = b `cast` GRefl (TYPE F[0])

  Now we are in trouble because `ty :: TYPE F` does not have a known runtime
  representation, because we need to be able to reduce the nullary type family
  application `F` to find that out.

Conclusion: only do cast w/w when doing so would not lose the RuntimeRep
information. That is, when handling `Cast rhs co`, don't attempt cast w/w
unless the kind of the type of rhs is concrete, in the sense of
Note [Concrete types] in GHC.Tc.Utils.Concrete.
-}</span></span><span>
</span><span id="line-580"></span><span>
</span><span id="line-581"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#tryCastWorkerWrapper"><span class="hs-identifier hs-type">tryCastWorkerWrapper</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BindContext"><span class="hs-identifier hs-type">BindContext</span></a></span><span>
</span><span id="line-582"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>
</span><span id="line-583"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-584"></span><span class="hs-comment">-- See Note [Cast worker/wrapper]</span><span>
</span><span id="line-585"></span><span id="tryCastWorkerWrapper"><span class="annot"><span class="annottext">tryCastWorkerWrapper :: SimplEnv
-&gt; BindContext
-&gt; CoreBndr
-&gt; CoreBndr
-&gt; CoreExpr
-&gt; SimplM (SimplFloats, SimplEnv)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#tryCastWorkerWrapper"><span class="hs-identifier hs-var hs-var">tryCastWorkerWrapper</span></a></span></span><span> </span><span id="local-6989586621682979157"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979157"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979158"><span class="annot"><span class="annottext">BindContext
</span><a href="#local-6989586621682979158"><span class="hs-identifier hs-var">bind_cxt</span></a></span></span><span> </span><span id="local-6989586621682979159"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979159"><span class="hs-identifier hs-var">old_bndr</span></a></span></span><span> </span><span id="local-6989586621682979160"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979160"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682979162"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979162"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span id="local-6989586621682979163"><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979163"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-586"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BC_Let"><span class="hs-identifier hs-type">BC_Let</span></a></span><span> </span><span id="local-6989586621682979164"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682979164"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621682979165"><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621682979165"><span class="hs-identifier hs-var">is_rec</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BindContext
</span><a href="#local-6989586621682979158"><span class="hs-identifier hs-var">bind_cxt</span></a></span><span>  </span><span class="hs-comment">-- Not join points</span><span>
</span><span id="line-587"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Id.html#isDFunId"><span class="hs-identifier hs-var">isDFunId</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979160"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- nor DFuns; cast w/w is no help, and we can't transform</span><span>
</span><span id="line-588"></span><span>                        </span><span class="hs-comment">--            a DFunUnfolding in mk_worker_unfolding</span><span>
</span><span id="line-589"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979162"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>        </span><span class="hs-comment">-- Not x = y |&gt; co; Wrinkle 1</span><span>
</span><span id="line-590"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdInfo -&gt; Bool
</span><a href="GHC.Types.Id.Info.html#hasInlineUnfolding"><span class="hs-identifier hs-var">hasInlineUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621682979168"><span class="hs-identifier hs-var">info</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Not INLINE things: Wrinkle 4</span><span>
</span><span id="line-591"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Kind -&gt; Bool
Kind -&gt; Bool
</span><a href="GHC.Core.Type.html#typeHasFixedRuntimeRep"><span class="hs-identifier hs-var">typeHasFixedRuntimeRep</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979170"><span class="hs-identifier hs-var">work_ty</span></a></span><span>    </span><span class="hs-comment">-- Don't peel off a cast if doing so would</span><span>
</span><span id="line-592"></span><span>                                      </span><span class="hs-comment">-- lose the underlying runtime representation.</span><span>
</span><span id="line-593"></span><span>                                      </span><span class="hs-comment">-- See Note [Preserve RuntimeRep info in cast w/w]</span><span>
</span><span id="line-594"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InlinePragma -&gt; Bool
</span><a href="GHC.Types.Basic.html#isOpaquePragma"><span class="hs-identifier hs-var">isOpaquePragma</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; InlinePragma
</span><a href="GHC.Types.Id.html#idInlinePragma"><span class="hs-identifier hs-var">idInlinePragma</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979159"><span class="hs-identifier hs-var">old_bndr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Not for OPAQUE bindings</span><span>
</span><span id="line-595"></span><span>                                                   </span><span class="hs-comment">-- See Note [OPAQUE pragma]</span><span>
</span><span id="line-596"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682979173"><span class="annot"><a href="#local-6989586621682979173"><span class="hs-identifier hs-var">uniq</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplM Unique
forall (m :: * -&gt; *). MonadUnique m =&gt; m Unique
</span><a href="GHC.Types.Unique.Supply.html#getUniqueM"><span class="hs-identifier hs-var">getUniqueM</span></a></span><span>
</span><span id="line-597"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682979175"><span class="annot"><a href="#local-6989586621682979175"><span class="hs-identifier hs-var hs-var">work_name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unique -&gt; FastString -&gt; Name
</span><a href="GHC.Types.Name.html#mkSystemVarName"><span class="hs-identifier hs-var">mkSystemVarName</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682979173"><span class="hs-identifier hs-var">uniq</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621682979176"><span class="hs-identifier hs-var">occ_fs</span></a></span><span>
</span><span id="line-598"></span><span>              </span><span id="local-6989586621682979177"><span class="annot"><a href="#local-6989586621682979177"><span class="hs-identifier hs-var hs-var">work_id</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Name -&gt; Kind -&gt; Kind -&gt; IdInfo -&gt; CoreBndr
Name -&gt; Kind -&gt; Kind -&gt; IdInfo -&gt; CoreBndr
</span><a href="GHC.Types.Id.html#mkLocalIdWithInfo"><span class="hs-identifier hs-var">mkLocalIdWithInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682979175"><span class="hs-identifier hs-var">work_name</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="GHC.Core.Type.html#ManyTy"><span class="hs-identifier hs-var">ManyTy</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979170"><span class="hs-identifier hs-var">work_ty</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621682979180"><span class="hs-identifier hs-var">work_info</span></a></span><span>
</span><span id="line-599"></span><span>              </span><span id="local-6989586621682979181"><span class="annot"><a href="#local-6989586621682979181"><span class="hs-identifier hs-var hs-var">is_strict</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Id.html#isStrictId"><span class="hs-identifier hs-var">isStrictId</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979160"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-600"></span><span>
</span><span id="line-601"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979183"><span class="annot"><a href="#local-6989586621682979183"><span class="hs-identifier hs-var">rhs_floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979184"><span class="annot"><a href="#local-6989586621682979184"><span class="hs-identifier hs-var">work_rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#prepareBinding"><span class="hs-identifier hs-type">prepareBinding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979157"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979164"><span class="hs-identifier hs-type">top_lvl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979165"><span class="hs-identifier hs-type">is_rec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979181"><span class="hs-identifier hs-type">is_strict</span></a></span><span>
</span><span id="line-602"></span><span>                                                   </span><span class="annot"><a href="#local-6989586621682979177"><span class="hs-identifier hs-type">work_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#emptyFloats"><span class="hs-identifier hs-type">emptyFloats</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979157"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682979162"><span class="hs-identifier hs-type">rhs</span></a></span><span>
</span><span id="line-603"></span><span>
</span><span id="line-604"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682979185"><span class="annot"><a href="#local-6989586621682979185"><span class="hs-identifier hs-var">work_unf</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621682979186"><span class="hs-identifier hs-type">mk_worker_unfolding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979164"><span class="hs-identifier hs-type">top_lvl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979177"><span class="hs-identifier hs-type">work_id</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979184"><span class="hs-identifier hs-type">work_rhs</span></a></span><span>
</span><span id="line-605"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span>  </span><span id="local-6989586621682979187"><span class="annot"><a href="#local-6989586621682979187"><span class="hs-identifier hs-var hs-var">work_id_w_unf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979177"><span class="hs-identifier hs-var">work_id</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Unfolding -&gt; CoreBndr
</span><a href="GHC.Types.Id.html#setIdUnfolding"><span class="hs-operator hs-var">`setIdUnfolding`</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682979185"><span class="hs-identifier hs-var">work_unf</span></a></span><span>
</span><span id="line-606"></span><span>               </span><span id="local-6989586621682979189"><span class="annot"><a href="#local-6989586621682979189"><span class="hs-identifier hs-var hs-var">floats</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682979183"><span class="hs-identifier hs-var">rhs_floats</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats -&gt; LetFloats -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#addLetFloats"><span class="hs-operator hs-var">`addLetFloats`</span></a></span><span>
</span><span id="line-607"></span><span>                          </span><span class="annot"><span class="annottext">InBind -&gt; LetFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#unitLetFloat"><span class="hs-identifier hs-var">unitLetFloat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; CoreExpr -&gt; InBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979187"><span class="hs-identifier hs-var">work_id_w_unf</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979184"><span class="hs-identifier hs-var">work_rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-608"></span><span>
</span><span id="line-609"></span><span>               </span><span id="local-6989586621682979191"><span class="annot"><a href="#local-6989586621682979191"><span class="hs-identifier hs-var hs-var">triv_rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoercionR -&gt; CoreExpr
forall b. Expr b -&gt; CoercionR -&gt; Expr b
</span><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-var">Cast</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; CoreExpr
forall b. CoreBndr -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979187"><span class="hs-identifier hs-var">work_id_w_unf</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979163"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-610"></span><span>
</span><span id="line-611"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#postInlineUnconditionally"><span class="hs-identifier hs-type">postInlineUnconditionally</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979157"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979158"><span class="hs-identifier hs-type">bind_cxt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979159"><span class="hs-identifier hs-type">old_bndr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979160"><span class="hs-identifier hs-type">bndr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979191"><span class="hs-identifier hs-type">triv_rhs</span></a></span><span>
</span><span id="line-612"></span><span>             </span><span class="hs-comment">-- Almost always True, because the RHS is trivial</span><span>
</span><span id="line-613"></span><span>             </span><span class="hs-comment">-- In that case we want to eliminate the binding fast</span><span>
</span><span id="line-614"></span><span>             </span><span class="hs-comment">-- We conservatively use postInlineUnconditionally so that we</span><span>
</span><span id="line-615"></span><span>             </span><span class="hs-comment">-- check all the right things</span><span>
</span><span id="line-616"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#tick"><span class="hs-identifier hs-type">tick</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Stats.html#PostInlineUnconditionally"><span class="hs-identifier hs-type">PostInlineUnconditionally</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979160"><span class="hs-identifier hs-type">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-617"></span><span>                  </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="#local-6989586621682979189"><span class="hs-identifier hs-type">floats</span></a></span><span>
</span><span id="line-618"></span><span>                           </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#extendIdSubst"><span class="hs-identifier hs-type">extendIdSubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#setInScopeFromF"><span class="hs-identifier hs-type">setInScopeFromF</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979157"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979189"><span class="hs-identifier hs-type">floats</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682979159"><span class="hs-identifier hs-type">old_bndr</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-619"></span><span>                             </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#DoneEx"><span class="hs-identifier hs-type">DoneEx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979191"><span class="hs-identifier hs-type">triv_rhs</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#NotJoinPoint"><span class="hs-identifier hs-type">NotJoinPoint</span></a></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-620"></span><span>
</span><span id="line-621"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682979198"><span class="annot"><a href="#local-6989586621682979198"><span class="hs-identifier hs-var">wrap_unf</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#mkLetUnfolding"><span class="hs-identifier hs-type">mkLetUnfolding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979157"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979164"><span class="hs-identifier hs-type">top_lvl</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#VanillaSrc"><span class="hs-identifier hs-type">VanillaSrc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979160"><span class="hs-identifier hs-type">bndr</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span> </span><span class="annot"><a href="#local-6989586621682979191"><span class="hs-identifier hs-type">triv_rhs</span></a></span><span>
</span><span id="line-622"></span><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682979201"><span class="annot"><a href="#local-6989586621682979201"><span class="hs-identifier hs-var hs-var">bndr'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979160"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; InlinePragma -&gt; CoreBndr
</span><a href="GHC.Types.Id.html#setInlinePragma"><span class="hs-operator hs-var">`setInlinePragma`</span></a></span><span> </span><span class="annot"><span class="annottext">InlinePragma -&gt; InlinePragma
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#mkCastWrapperInlinePrag"><span class="hs-identifier hs-var">mkCastWrapperInlinePrag</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; InlinePragma
</span><a href="GHC.Types.Id.html#idInlinePragma"><span class="hs-identifier hs-var">idInlinePragma</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979160"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-623"></span><span>                                </span><span class="annot"><span class="annottext">CoreBndr -&gt; Unfolding -&gt; CoreBndr
</span><a href="GHC.Types.Id.html#setIdUnfolding"><span class="hs-operator hs-var">`setIdUnfolding`</span></a></span><span>  </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682979198"><span class="hs-identifier hs-var">wrap_unf</span></a></span><span>
</span><span id="line-624"></span><span>                        </span><span id="local-6989586621682979204"><span class="annot"><a href="#local-6989586621682979204"><span class="hs-identifier hs-var hs-var">floats'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682979189"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats -&gt; InBind -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#extendFloats"><span class="hs-operator hs-var">`extendFloats`</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; CoreExpr -&gt; InBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979201"><span class="hs-identifier hs-var">bndr'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979191"><span class="hs-identifier hs-var">triv_rhs</span></a></span><span>
</span><span id="line-625"></span><span>                  </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="#local-6989586621682979204"><span class="hs-identifier hs-type">floats'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#setInScopeFromF"><span class="hs-identifier hs-type">setInScopeFromF</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979157"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979204"><span class="hs-identifier hs-type">floats'</span></a></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-626"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-627"></span><span>    </span><span class="hs-comment">-- Force the occ_fs so that the old Id is not retained in the new Id.</span><span>
</span><span id="line-628"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621682979176"><span class="annot"><span class="annottext">occ_fs :: FastString
</span><a href="#local-6989586621682979176"><span class="hs-identifier hs-var hs-var">occ_fs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; FastString
forall a. NamedThing a =&gt; a -&gt; FastString
</span><a href="GHC.Types.Name.html#getOccFS"><span class="hs-identifier hs-var">getOccFS</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979160"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-629"></span><span>    </span><span id="local-6989586621682979170"><span class="annot"><span class="annottext">work_ty :: Kind
</span><a href="#local-6989586621682979170"><span class="hs-identifier hs-var hs-var">work_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoercionR -&gt; Kind
CoercionR -&gt; Kind
</span><a href="GHC.Core.Coercion.html#coercionLKind"><span class="hs-identifier hs-var">coercionLKind</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979163"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-630"></span><span>    </span><span id="local-6989586621682979168"><span class="annot"><span class="annottext">info :: IdInfo
</span><a href="#local-6989586621682979168"><span class="hs-identifier hs-var hs-var">info</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreBndr -&gt; IdInfo
CoreBndr -&gt; IdInfo
</span><a href="GHC.Types.Var.html#idInfo"><span class="hs-identifier hs-var">idInfo</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979160"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-631"></span><span>    </span><span id="local-6989586621682979207"><span class="annot"><span class="annottext">work_arity :: Int
</span><a href="#local-6989586621682979207"><span class="hs-identifier hs-var hs-var">work_arity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdInfo -&gt; Int
</span><a href="GHC.Types.Id.Info.html#arityInfo"><span class="hs-identifier hs-var">arityInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621682979168"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`min`</span></span><span> </span><span class="annot"><span class="annottext">Kind -&gt; Int
</span><a href="GHC.Core.Opt.Arity.html#typeArity"><span class="hs-identifier hs-var">typeArity</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979170"><span class="hs-identifier hs-var">work_ty</span></a></span><span>
</span><span id="line-632"></span><span>
</span><span id="line-633"></span><span>    </span><span id="local-6989586621682979180"><span class="annot"><span class="annottext">work_info :: IdInfo
</span><a href="#local-6989586621682979180"><span class="hs-identifier hs-var hs-var">work_info</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="GHC.Types.Id.Info.html#vanillaIdInfo"><span class="hs-identifier hs-var">vanillaIdInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo -&gt; DmdSig -&gt; IdInfo
</span><a href="GHC.Types.Id.Info.html#setDmdSigInfo"><span class="hs-operator hs-var">`setDmdSigInfo`</span></a></span><span>     </span><span class="annot"><span class="annottext">IdInfo -&gt; DmdSig
</span><a href="GHC.Types.Id.Info.html#dmdSigInfo"><span class="hs-identifier hs-var">dmdSigInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621682979168"><span class="hs-identifier hs-var">info</span></a></span><span>
</span><span id="line-634"></span><span>                              </span><span class="annot"><span class="annottext">IdInfo -&gt; CprSig -&gt; IdInfo
</span><a href="GHC.Types.Id.Info.html#setCprSigInfo"><span class="hs-operator hs-var">`setCprSigInfo`</span></a></span><span>     </span><span class="annot"><span class="annottext">IdInfo -&gt; CprSig
</span><a href="GHC.Types.Id.Info.html#cprSigInfo"><span class="hs-identifier hs-var">cprSigInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621682979168"><span class="hs-identifier hs-var">info</span></a></span><span>
</span><span id="line-635"></span><span>                              </span><span class="annot"><span class="annottext">IdInfo -&gt; Demand -&gt; IdInfo
</span><a href="GHC.Types.Id.Info.html#setDemandInfo"><span class="hs-operator hs-var">`setDemandInfo`</span></a></span><span>     </span><span class="annot"><span class="annottext">IdInfo -&gt; Demand
</span><a href="GHC.Types.Id.Info.html#demandInfo"><span class="hs-identifier hs-var">demandInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621682979168"><span class="hs-identifier hs-var">info</span></a></span><span>
</span><span id="line-636"></span><span>                              </span><span class="annot"><span class="annottext">IdInfo -&gt; InlinePragma -&gt; IdInfo
</span><a href="GHC.Types.Id.Info.html#setInlinePragInfo"><span class="hs-operator hs-var">`setInlinePragInfo`</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo -&gt; InlinePragma
</span><a href="GHC.Types.Id.Info.html#inlinePragInfo"><span class="hs-identifier hs-var">inlinePragInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621682979168"><span class="hs-identifier hs-var">info</span></a></span><span>
</span><span id="line-637"></span><span>                              </span><span class="annot"><span class="annottext">IdInfo -&gt; Int -&gt; IdInfo
</span><a href="GHC.Types.Id.Info.html#setArityInfo"><span class="hs-operator hs-var">`setArityInfo`</span></a></span><span>      </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682979207"><span class="hs-identifier hs-var">work_arity</span></a></span><span>
</span><span id="line-638"></span><span>           </span><span class="hs-comment">-- We do /not/ want to transfer OccInfo, Rules</span><span>
</span><span id="line-639"></span><span>           </span><span class="hs-comment">-- Note [Preserve strictness in cast w/w]</span><span>
</span><span id="line-640"></span><span>           </span><span class="hs-comment">-- and Wrinkle 2 of Note [Cast worker/wrapper]</span><span>
</span><span id="line-641"></span><span>
</span><span id="line-642"></span><span>    </span><span class="hs-comment">----------- Worker unfolding -----------</span><span>
</span><span id="line-643"></span><span>    </span><span class="hs-comment">-- Stable case: if there is a stable unfolding we have to compose with (Sym co);</span><span>
</span><span id="line-644"></span><span>    </span><span class="hs-comment">--   the next round of simplification will do the job</span><span>
</span><span id="line-645"></span><span>    </span><span class="hs-comment">-- Non-stable case: use work_rhs</span><span>
</span><span id="line-646"></span><span>    </span><span class="hs-comment">-- Wrinkle 3 of Note [Cast worker/wrapper]</span><span>
</span><span id="line-647"></span><span>    </span><span id="local-6989586621682979186"><span class="annot"><span class="annottext">mk_worker_unfolding :: TopLevelFlag -&gt; CoreBndr -&gt; CoreExpr -&gt; SimplM Unfolding
</span><a href="#local-6989586621682979186"><span class="hs-identifier hs-var hs-var">mk_worker_unfolding</span></a></span></span><span> </span><span id="local-6989586621682979220"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682979220"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621682979221"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979221"><span class="hs-identifier hs-var">work_id</span></a></span></span><span> </span><span id="local-6989586621682979222"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979222"><span class="hs-identifier hs-var">work_rhs</span></a></span></span><span>
</span><span id="line-648"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IdInfo -&gt; Unfolding
</span><a href="GHC.Types.Id.Info.html#realUnfoldingInfo"><span class="hs-identifier hs-var">realUnfoldingInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621682979168"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-comment">-- NB: the real one, even for loop-breakers</span><span>
</span><span id="line-649"></span><span>           </span><span id="local-6989586621682979224"><span class="annot"><span class="annottext">unf :: Unfolding
</span><a href="#local-6989586621682979224"><span class="hs-identifier hs-var">unf</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#CoreUnfolding"><span class="hs-identifier hs-type">CoreUnfolding</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">uf_tmpl :: Unfolding -&gt; CoreExpr
</span><a href="GHC.Core.html#uf_tmpl"><span class="hs-identifier hs-var">uf_tmpl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979227"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979227"><span class="hs-identifier hs-var">unf_rhs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uf_src :: Unfolding -&gt; UnfoldingSource
</span><a href="GHC.Core.html#uf_src"><span class="hs-identifier hs-var">uf_src</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979229"><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621682979229"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-650"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">UnfoldingSource -&gt; Bool
</span><a href="GHC.Types.Basic.html#isStableSource"><span class="hs-identifier hs-var">isStableSource</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621682979229"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; SimplM Unfolding
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682979224"><span class="hs-identifier hs-var">unf</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.html#uf_tmpl"><span class="hs-identifier hs-var">uf_tmpl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#mkCast"><span class="hs-identifier hs-type">mkCast</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979227"><span class="hs-identifier hs-type">unf_rhs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-type">mkSymCo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979163"><span class="hs-identifier hs-type">co</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-651"></span><span>           </span><span class="annot"><span class="annottext">Unfolding
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; TopLevelFlag
-&gt; UnfoldingSource
-&gt; CoreBndr
-&gt; Bool
-&gt; CoreExpr
-&gt; SimplM Unfolding
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#mkLetUnfolding"><span class="hs-identifier hs-var">mkLetUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979157"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682979220"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="GHC.Types.Basic.html#VanillaSrc"><span class="hs-identifier hs-var">VanillaSrc</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979221"><span class="hs-identifier hs-var">work_id</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979222"><span class="hs-identifier hs-var">work_rhs</span></a></span><span>
</span><span id="line-652"></span><span>
</span><span id="line-653"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#tryCastWorkerWrapper"><span class="hs-identifier hs-var">tryCastWorkerWrapper</span></a></span><span> </span><span id="local-6989586621682979233"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979233"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="annot"><span class="annottext">BindContext
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682979234"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979234"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682979235"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979235"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>  </span><span class="hs-comment">-- All other bindings</span><span>
</span><span id="line-654"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; SimplM ()
</span><a href="GHC.Core.Opt.Simplify.Monad.html#traceSmpl"><span class="hs-identifier hs-var">traceSmpl</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tcww:no&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;bndr:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979234"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-655"></span><span>                                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rhs:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979235"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-656"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(SimplFloats, SimplEnv) -&gt; SimplM (SimplFloats, SimplEnv)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv -&gt; InBind -&gt; (SimplFloats, SimplEnv)
</span><a href="GHC.Core.Opt.Simplify.Env.html#mkFloatBind"><span class="hs-identifier hs-var">mkFloatBind</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979233"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; CoreExpr -&gt; InBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979234"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979235"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-657"></span><span>
</span><span id="line-658"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#mkCastWrapperInlinePrag"><span class="hs-identifier hs-type">mkCastWrapperInlinePrag</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#InlinePragma"><span class="hs-identifier hs-type">InlinePragma</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#InlinePragma"><span class="hs-identifier hs-type">InlinePragma</span></a></span><span>
</span><span id="line-659"></span><span class="hs-comment">-- See Note [Cast worker/wrapper]</span><span>
</span><span id="line-660"></span><span id="mkCastWrapperInlinePrag"><span class="annot"><span class="annottext">mkCastWrapperInlinePrag :: InlinePragma -&gt; InlinePragma
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#mkCastWrapperInlinePrag"><span class="hs-identifier hs-var hs-var">mkCastWrapperInlinePrag</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Basic.html#InlinePragma"><span class="hs-identifier hs-type">InlinePragma</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">inl_inline :: InlinePragma -&gt; InlineSpec
</span><a href="GHC.Types.Basic.html#inl_inline"><span class="hs-identifier hs-var">inl_inline</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979243"><span class="annot"><span class="annottext">InlineSpec
</span><a href="#local-6989586621682979243"><span class="hs-identifier hs-var">fn_inl</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">inl_act :: InlinePragma -&gt; Activation
</span><a href="GHC.Types.Basic.html#inl_act"><span class="hs-identifier hs-var">inl_act</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979245"><span class="annot"><span class="annottext">Activation
</span><a href="#local-6989586621682979245"><span class="hs-identifier hs-var">fn_act</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">inl_rule :: InlinePragma -&gt; RuleMatchInfo
</span><a href="GHC.Types.Basic.html#inl_rule"><span class="hs-identifier hs-var">inl_rule</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979247"><span class="annot"><span class="annottext">RuleMatchInfo
</span><a href="#local-6989586621682979247"><span class="hs-identifier hs-var">rule_info</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-661"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#InlinePragma"><span class="hs-identifier hs-type">InlinePragma</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">inl_src :: SourceText
</span><a href="GHC.Types.Basic.html#inl_src"><span class="hs-identifier hs-var">inl_src</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FastString -&gt; SourceText
</span><a href="GHC.Types.SourceText.html#SourceText"><span class="hs-identifier hs-var">SourceText</span></a></span><span> </span><span class="annot"><span class="annottext">(FastString -&gt; SourceText) -&gt; FastString -&gt; SourceText
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; FastString
</span><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;{-# INLINE&quot;</span></span><span>
</span><span id="line-662"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">inl_inline :: InlineSpec
</span><a href="GHC.Types.Basic.html#inl_inline"><span class="hs-identifier hs-var">inl_inline</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InlineSpec
</span><a href="#local-6989586621682979243"><span class="hs-identifier hs-var">fn_inl</span></a></span><span>       </span><span class="hs-comment">-- See Note [Worker/wrapper for INLINABLE functions]</span><span>
</span><span id="line-663"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">inl_sat :: Maybe Int
</span><a href="GHC.Types.Basic.html#inl_sat"><span class="hs-identifier hs-var">inl_sat</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Int
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>      </span><span class="hs-comment">--     in GHC.Core.Opt.WorkWrap</span><span>
</span><span id="line-664"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">inl_act :: Activation
</span><a href="GHC.Types.Basic.html#inl_act"><span class="hs-identifier hs-var">inl_act</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Activation
</span><a href="#local-6989586621682979252"><span class="hs-identifier hs-var">wrap_act</span></a></span><span>     </span><span class="hs-comment">-- See Note [Wrapper activation]</span><span>
</span><span id="line-665"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">inl_rule :: RuleMatchInfo
</span><a href="GHC.Types.Basic.html#inl_rule"><span class="hs-identifier hs-var">inl_rule</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleMatchInfo
</span><a href="#local-6989586621682979247"><span class="hs-identifier hs-var">rule_info</span></a></span><span> </span><span class="hs-special">}</span><span>  </span><span class="hs-comment">--     in GHC.Core.Opt.WorkWrap</span><span>
</span><span id="line-666"></span><span>                                </span><span class="hs-comment">-- RuleMatchInfo is (and must be) unaffected</span><span>
</span><span id="line-667"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-668"></span><span>    </span><span class="hs-comment">-- See Note [Wrapper activation] in GHC.Core.Opt.WorkWrap</span><span>
</span><span id="line-669"></span><span>    </span><span class="hs-comment">-- But simpler, because we don't need to disable during InitialPhase</span><span>
</span><span id="line-670"></span><span>    </span><span id="local-6989586621682979252"><span class="annot"><span class="annottext">wrap_act :: Activation
</span><a href="#local-6989586621682979252"><span class="hs-identifier hs-var hs-var">wrap_act</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Activation -&gt; Bool
</span><a href="GHC.Types.Basic.html#isNeverActive"><span class="hs-identifier hs-var">isNeverActive</span></a></span><span> </span><span class="annot"><span class="annottext">Activation
</span><a href="#local-6989586621682979245"><span class="hs-identifier hs-var">fn_act</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Activation
</span><a href="GHC.Types.Basic.html#activateDuringFinal"><span class="hs-identifier hs-var">activateDuringFinal</span></a></span><span>
</span><span id="line-671"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Activation
</span><a href="#local-6989586621682979245"><span class="hs-identifier hs-var">fn_act</span></a></span><span>
</span><span id="line-672"></span><span>
</span><span id="line-673"></span><span>
</span><span id="line-674"></span><span class="annot"><span class="hs-comment">{- *********************************************************************
*                                                                      *
           prepareBinding, prepareRhs, makeTrivial
*                                                                      *
********************************************************************* -}</span></span><span>
</span><span id="line-679"></span><span>
</span><span id="line-680"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#prepareBinding"><span class="hs-identifier hs-type">prepareBinding</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#RecFlag"><span class="hs-identifier hs-type">RecFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-681"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>   </span><span class="hs-comment">-- Used only for its OccName; can be InId or OutId</span><span>
</span><span id="line-682"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>
</span><span id="line-683"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-684"></span><span class="hs-comment">-- In (prepareBinding ... bndr floats rhs), the binding is really just</span><span>
</span><span id="line-685"></span><span class="hs-comment">--    bndr = let floats in rhs</span><span>
</span><span id="line-686"></span><span class="hs-comment">-- Maybe we can ANF-ise this binding and float out; e.g.</span><span>
</span><span id="line-687"></span><span class="hs-comment">--    bndr = let a = f x in K a a (g x)</span><span>
</span><span id="line-688"></span><span class="hs-comment">-- we could float out to give</span><span>
</span><span id="line-689"></span><span class="hs-comment">--    a    = f x</span><span>
</span><span id="line-690"></span><span class="hs-comment">--    tmp  = g x</span><span>
</span><span id="line-691"></span><span class="hs-comment">--    bndr = K a a tmp</span><span>
</span><span id="line-692"></span><span class="hs-comment">-- That's what prepareBinding does</span><span>
</span><span id="line-693"></span><span class="hs-comment">-- Precondition: binder is not a JoinId</span><span>
</span><span id="line-694"></span><span class="hs-comment">-- Postcondition: the returned SimplFloats contains only let-floats</span><span>
</span><span id="line-695"></span><span id="prepareBinding"><span class="annot"><span class="annottext">prepareBinding :: SimplEnv
-&gt; TopLevelFlag
-&gt; RecFlag
-&gt; Bool
-&gt; CoreBndr
-&gt; SimplFloats
-&gt; CoreExpr
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#prepareBinding"><span class="hs-identifier hs-var hs-var">prepareBinding</span></a></span></span><span> </span><span id="local-6989586621682979256"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979256"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979257"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682979257"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621682979258"><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621682979258"><span class="hs-identifier hs-var">is_rec</span></a></span></span><span> </span><span id="local-6989586621682979259"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682979259"><span class="hs-identifier hs-var">strict_bind</span></a></span></span><span> </span><span id="local-6989586621682979260"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979260"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682979261"><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682979261"><span class="hs-identifier hs-var">rhs_floats</span></a></span></span><span> </span><span id="local-6989586621682979262"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979262"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-696"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Never float join-floats out of a non-join let-binding (which this is)</span><span>
</span><span id="line-697"></span><span>         </span><span class="hs-comment">-- So wrap the body in the join-floats right now</span><span>
</span><span id="line-698"></span><span>         </span><span class="hs-comment">-- Hence: rhs_floats1 consists only of let-floats</span><span>
</span><span id="line-699"></span><span>         </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979263"><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682979263"><span class="hs-identifier hs-var hs-var">rhs_floats1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979264"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979264"><span class="hs-identifier hs-var hs-var">rhs1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplFloats -&gt; CoreExpr -&gt; (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Env.html#wrapJoinFloatsX"><span class="hs-identifier hs-var">wrapJoinFloatsX</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682979261"><span class="hs-identifier hs-var">rhs_floats</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979262"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-700"></span><span>
</span><span id="line-701"></span><span>         </span><span class="hs-comment">-- rhs_env: add to in-scope set the binders from rhs_floats</span><span>
</span><span id="line-702"></span><span>         </span><span class="hs-comment">-- so that prepareRhs knows what is in scope in rhs</span><span>
</span><span id="line-703"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682979266"><span class="annot"><span class="annottext">rhs_env :: SimplEnv
</span><a href="#local-6989586621682979266"><span class="hs-identifier hs-var hs-var hs-var">rhs_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979256"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplFloats -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#setInScopeFromF"><span class="hs-operator hs-var">`setInScopeFromF`</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682979263"><span class="hs-identifier hs-var">rhs_floats1</span></a></span><span>
</span><span id="line-704"></span><span>             </span><span class="hs-comment">-- Force the occ_fs so that the old Id is not retained in the new Id.</span><span>
</span><span id="line-705"></span><span>             </span><span class="hs-glyph">!</span><span id="local-6989586621682979267"><span class="annot"><span class="annottext">occ_fs :: FastString
</span><a href="#local-6989586621682979267"><span class="hs-identifier hs-var hs-var hs-var">occ_fs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; FastString
forall a. NamedThing a =&gt; a -&gt; FastString
</span><a href="GHC.Types.Name.html#getOccFS"><span class="hs-identifier hs-var">getOccFS</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979260"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-706"></span><span>
</span><span id="line-707"></span><span>       </span><span class="hs-comment">-- Now ANF-ise the remaining rhs</span><span>
</span><span id="line-708"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979268"><span class="annot"><a href="#local-6989586621682979268"><span class="hs-identifier hs-var">anf_floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979269"><span class="annot"><a href="#local-6989586621682979269"><span class="hs-identifier hs-var">rhs2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
SimplEnv
-&gt; TopLevelFlag
-&gt; FastString
-&gt; CoreExpr
-&gt; SimplM (LetFloats, CoreExpr)
SimplEnv
-&gt; TopLevelFlag
-&gt; FastString
-&gt; CoreExpr
-&gt; SimplM (LetFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#prepareRhs"><span class="hs-identifier hs-var">prepareRhs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979266"><span class="hs-identifier hs-var">rhs_env</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682979257"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621682979267"><span class="hs-identifier hs-var">occ_fs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979264"><span class="hs-identifier hs-var">rhs1</span></a></span><span>
</span><span id="line-709"></span><span>
</span><span id="line-710"></span><span>       </span><span class="hs-comment">-- Finally, decide whether or not to float</span><span>
</span><span id="line-711"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682979270"><span class="annot"><a href="#local-6989586621682979270"><span class="hs-identifier hs-var hs-var">all_floats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682979263"><span class="hs-identifier hs-var">rhs_floats1</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats -&gt; LetFloats -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#addLetFloats"><span class="hs-operator hs-var">`addLetFloats`</span></a></span><span> </span><span class="annot"><span class="annottext">LetFloats
</span><a href="#local-6989586621682979268"><span class="hs-identifier hs-var">anf_floats</span></a></span><span>
</span><span id="line-712"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#doFloatFromRhs"><span class="hs-identifier hs-type">doFloatFromRhs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#seFloatEnable"><span class="hs-identifier hs-type">seFloatEnable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979256"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682979257"><span class="hs-identifier hs-type">top_lvl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979258"><span class="hs-identifier hs-type">is_rec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979259"><span class="hs-identifier hs-type">strict_bind</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979270"><span class="hs-identifier hs-type">all_floats</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979269"><span class="hs-identifier hs-type">rhs2</span></a></span><span>
</span><span id="line-713"></span><span>         </span><span class="hs-keyword">then</span><span> </span><span class="hs-comment">-- Float!</span><span>
</span><span id="line-714"></span><span>              </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#tick"><span class="hs-identifier hs-type">tick</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Stats.html#LetFloatFromLet"><span class="hs-identifier hs-type">LetFloatFromLet</span></a></span><span>
</span><span id="line-715"></span><span>                 </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979270"><span class="hs-identifier hs-type">all_floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682979269"><span class="hs-identifier hs-type">rhs2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-716"></span><span>
</span><span id="line-717"></span><span>         </span><span class="hs-keyword">else</span><span> </span><span class="hs-comment">-- Abandon floating altogether; revert to original rhs</span><span>
</span><span id="line-718"></span><span>              </span><span class="hs-comment">-- Since we have already built rhs1, we just need to add</span><span>
</span><span id="line-719"></span><span>              </span><span class="hs-comment">-- rhs_floats1 to it</span><span>
</span><span id="line-720"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#emptyFloats"><span class="hs-identifier hs-type">emptyFloats</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979256"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#wrapFloats"><span class="hs-identifier hs-type">wrapFloats</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979263"><span class="hs-identifier hs-type">rhs_floats1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979264"><span class="hs-identifier hs-type">rhs1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-721"></span><span>
</span><span id="line-722"></span><span class="hs-comment">{- Note [prepareRhs]
~~~~~~~~~~~~~~~~~~~~
prepareRhs takes a putative RHS, checks whether it's a PAP or
constructor application and, if so, converts it to ANF, so that the
resulting thing can be inlined more easily.  Thus
        x = (f a, g b)
becomes
        t1 = f a
        t2 = g b
        x = (t1,t2)

We also want to deal well cases like this
        v = (f e1 `cast` co) e2
Here we want to make e1,e2 trivial and get
        x1 = e1; x2 = e2; v = (f x1 `cast` co) v2
That's what the 'go' loop in prepareRhs does
-}</span><span>
</span><span id="line-739"></span><span>
</span><span id="line-740"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#prepareRhs"><span class="hs-identifier hs-type">prepareRhs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span>
</span><span id="line-741"></span><span>           </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span>
</span><span id="line-742"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a></span><span>    </span><span class="hs-comment">-- Base for any new variables</span><span>
</span><span id="line-743"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>
</span><span id="line-744"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#LetFloats"><span class="hs-identifier hs-type">LetFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-745"></span><span class="hs-comment">-- Transforms a RHS into a better RHS by ANF'ing args</span><span>
</span><span id="line-746"></span><span class="hs-comment">-- for expandable RHSs: constructors and PAPs</span><span>
</span><span id="line-747"></span><span class="hs-comment">-- e.g        x = Just e</span><span>
</span><span id="line-748"></span><span class="hs-comment">-- becomes    a = e               -- 'a' is fresh</span><span>
</span><span id="line-749"></span><span class="hs-comment">--            x = Just a</span><span>
</span><span id="line-750"></span><span class="hs-comment">-- See Note [prepareRhs]</span><span>
</span><span id="line-751"></span><span id="prepareRhs"><span class="annot"><span class="annottext">prepareRhs :: HasDebugCallStack =&gt;
SimplEnv
-&gt; TopLevelFlag
-&gt; FastString
-&gt; CoreExpr
-&gt; SimplM (LetFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#prepareRhs"><span class="hs-identifier hs-var hs-var">prepareRhs</span></a></span></span><span> </span><span id="local-6989586621682979292"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979292"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979293"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682979293"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621682979294"><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621682979294"><span class="hs-identifier hs-var">occ</span></a></span></span><span> </span><span id="local-6989586621682979295"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979295"><span class="hs-identifier hs-var">rhs0</span></a></span></span><span>
</span><span id="line-752"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682979296"><span class="hs-identifier hs-var">is_expandable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; SimplM (LetFloats, CoreExpr)
</span><a href="#local-6989586621682979297"><span class="hs-identifier hs-var">anfise</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979295"><span class="hs-identifier hs-var">rhs0</span></a></span><span>
</span><span id="line-753"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LetFloats, CoreExpr) -&gt; SimplM (LetFloats, CoreExpr)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LetFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#emptyLetFloats"><span class="hs-identifier hs-var">emptyLetFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979295"><span class="hs-identifier hs-var">rhs0</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-754"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-755"></span><span>    </span><span class="hs-comment">-- We can't use exprIsExpandable because the WHOLE POINT is that</span><span>
</span><span id="line-756"></span><span>    </span><span class="hs-comment">-- we want to treat (K &lt;big&gt;) as expandable, because we are just</span><span>
</span><span id="line-757"></span><span>    </span><span class="hs-comment">-- about &quot;anfise&quot; the &lt;big&gt; expression.  exprIsExpandable would</span><span>
</span><span id="line-758"></span><span>    </span><span class="hs-comment">-- just say no!</span><span>
</span><span id="line-759"></span><span>    </span><span id="local-6989586621682979296"><span class="annot"><span class="annottext">is_expandable :: Bool
</span><a href="#local-6989586621682979296"><span class="hs-identifier hs-var hs-var">is_expandable</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Int -&gt; Bool
forall {b}. Expr b -&gt; Int -&gt; Bool
</span><a href="#local-6989586621682979299"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979295"><span class="hs-identifier hs-var">rhs0</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-760"></span><span>       </span><span class="hs-keyword">where</span><span>
</span><span id="line-761"></span><span>         </span><span id="local-6989586621682979299"><span class="annot"><span class="annottext">go :: Expr b -&gt; Int -&gt; Bool
</span><a href="#local-6989586621682979299"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682979302"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979302"><span class="hs-identifier hs-var">fun</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682979303"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682979303"><span class="hs-identifier hs-var">n_val_args</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CheapAppFun
</span><a href="GHC.Core.Utils.html#isExpandableApp"><span class="hs-identifier hs-var">isExpandableApp</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979302"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682979303"><span class="hs-identifier hs-var">n_val_args</span></a></span><span>
</span><span id="line-762"></span><span>         </span><span class="annot"><a href="#local-6989586621682979299"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621682979306"><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621682979306"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621682979307"><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621682979307"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682979308"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682979308"><span class="hs-identifier hs-var">n_val_args</span></a></span></span><span>
</span><span id="line-763"></span><span>           </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Expr b -&gt; Bool
forall {b}. Expr b -&gt; Bool
</span><a href="GHC.Core.html#isTypeArg"><span class="hs-identifier hs-var">isTypeArg</span></a></span><span> </span><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621682979307"><span class="hs-identifier hs-var">arg</span></a></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr b -&gt; Int -&gt; Bool
</span><a href="#local-6989586621682979299"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621682979306"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682979308"><span class="hs-identifier hs-var">n_val_args</span></a></span><span>
</span><span id="line-764"></span><span>           </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr b -&gt; Int -&gt; Bool
</span><a href="#local-6989586621682979299"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621682979306"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682979308"><span class="hs-identifier hs-var">n_val_args</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-765"></span><span>         </span><span class="annot"><a href="#local-6989586621682979299"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682979311"><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621682979311"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>  </span><span id="local-6989586621682979312"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682979312"><span class="hs-identifier hs-var">n_val_args</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr b -&gt; Int -&gt; Bool
</span><a href="#local-6989586621682979299"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621682979311"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682979312"><span class="hs-identifier hs-var">n_val_args</span></a></span><span>
</span><span id="line-766"></span><span>         </span><span class="annot"><a href="#local-6989586621682979299"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682979313"><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621682979313"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span>  </span><span id="local-6989586621682979314"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682979314"><span class="hs-identifier hs-var">n_val_args</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr b -&gt; Int -&gt; Bool
</span><a href="#local-6989586621682979299"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621682979313"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682979314"><span class="hs-identifier hs-var">n_val_args</span></a></span><span>
</span><span id="line-767"></span><span>         </span><span class="annot"><a href="#local-6989586621682979299"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Expr b
</span><span class="hs-identifier">_</span></span><span>             </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-768"></span><span>
</span><span id="line-769"></span><span>    </span><span class="annot"><a href="#local-6989586621682979297"><span class="hs-identifier hs-type">anfise</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#LetFloats"><span class="hs-identifier hs-type">LetFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-770"></span><span>    </span><span id="local-6989586621682979297"><span class="annot"><span class="annottext">anfise :: CoreExpr -&gt; SimplM (LetFloats, CoreExpr)
</span><a href="#local-6989586621682979297"><span class="hs-identifier hs-var hs-var">anfise</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682979315"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979315"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span id="local-6989586621682979316"><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979316"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-771"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979317"><span class="annot"><a href="#local-6989586621682979317"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979318"><span class="annot"><a href="#local-6989586621682979318"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; SimplM (LetFloats, CoreExpr)
</span><a href="#local-6989586621682979297"><span class="hs-identifier hs-var">anfise</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979315"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-772"></span><span>             </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979317"><span class="hs-identifier hs-type">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979318"><span class="hs-identifier hs-type">rhs'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979316"><span class="hs-identifier hs-type">co</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-773"></span><span>    </span><span class="annot"><a href="#local-6989586621682979297"><span class="hs-identifier hs-var">anfise</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621682979319"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979319"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span id="local-6989586621682979321"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979321"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-774"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979322"><span class="annot"><a href="#local-6989586621682979322"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979323"><span class="annot"><a href="#local-6989586621682979323"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; SimplM (LetFloats, CoreExpr)
</span><a href="#local-6989586621682979297"><span class="hs-identifier hs-var">anfise</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979319"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-775"></span><span>             </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979322"><span class="hs-identifier hs-type">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979323"><span class="hs-identifier hs-type">rhs'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979321"><span class="hs-identifier hs-type">ty</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-776"></span><span>    </span><span class="annot"><a href="#local-6989586621682979297"><span class="hs-identifier hs-var">anfise</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621682979324"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979324"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621682979325"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979325"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-777"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979326"><span class="annot"><a href="#local-6989586621682979326"><span class="hs-identifier hs-var">floats1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979327"><span class="annot"><a href="#local-6989586621682979327"><span class="hs-identifier hs-var">fun'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; SimplM (LetFloats, CoreExpr)
</span><a href="#local-6989586621682979297"><span class="hs-identifier hs-var">anfise</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979324"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-778"></span><span>             </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979328"><span class="annot"><a href="#local-6989586621682979328"><span class="hs-identifier hs-var">floats2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979329"><span class="annot"><a href="#local-6989586621682979329"><span class="hs-identifier hs-var">arg'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#makeTrivial"><span class="hs-identifier hs-type">makeTrivial</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979292"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979293"><span class="hs-identifier hs-type">top_lvl</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#topDmd"><span class="hs-identifier hs-type">topDmd</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979294"><span class="hs-identifier hs-type">occ</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979325"><span class="hs-identifier hs-type">arg</span></a></span><span>
</span><span id="line-779"></span><span>             </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979326"><span class="hs-identifier hs-type">floats1</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#addLetFlts"><span class="hs-operator hs-type">`addLetFlts`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979328"><span class="hs-identifier hs-type">floats2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979327"><span class="hs-identifier hs-type">fun'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979329"><span class="hs-identifier hs-type">arg'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-780"></span><span>    </span><span class="annot"><a href="#local-6989586621682979297"><span class="hs-identifier hs-var">anfise</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682979333"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979333"><span class="hs-identifier hs-var">fun</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-781"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LetFloats, CoreExpr) -&gt; SimplM (LetFloats, CoreExpr)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LetFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#emptyLetFloats"><span class="hs-identifier hs-var">emptyLetFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; CoreExpr
forall b. CoreBndr -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979333"><span class="hs-identifier hs-var">fun</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-782"></span><span>
</span><span id="line-783"></span><span>    </span><span class="annot"><a href="#local-6989586621682979297"><span class="hs-identifier hs-var">anfise</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621682979334"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682979334"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621682979335"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979335"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-784"></span><span>        </span><span class="hs-comment">-- We want to be able to float bindings past this</span><span>
</span><span id="line-785"></span><span>        </span><span class="hs-comment">-- tick. Non-scoping ticks don't care.</span><span>
</span><span id="line-786"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; TickishScoping
forall (pass :: TickishPass). GenTickish pass -&gt; TickishScoping
</span><a href="GHC.Types.Tickish.html#tickishScoped"><span class="hs-identifier hs-var">tickishScoped</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682979334"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">TickishScoping -&gt; TickishScoping -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TickishScoping
</span><a href="GHC.Types.Tickish.html#NoScope"><span class="hs-identifier hs-var">NoScope</span></a></span><span>
</span><span id="line-787"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979338"><span class="annot"><a href="#local-6989586621682979338"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979339"><span class="annot"><a href="#local-6989586621682979339"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; SimplM (LetFloats, CoreExpr)
</span><a href="#local-6989586621682979297"><span class="hs-identifier hs-var">anfise</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979335"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-788"></span><span>             </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979338"><span class="hs-identifier hs-type">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979334"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979339"><span class="hs-identifier hs-type">rhs'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-789"></span><span>
</span><span id="line-790"></span><span>        </span><span class="hs-comment">-- On the other hand, for scoping ticks we need to be able to</span><span>
</span><span id="line-791"></span><span>        </span><span class="hs-comment">-- copy them on the floats, which in turn is only allowed if</span><span>
</span><span id="line-792"></span><span>        </span><span class="hs-comment">-- we can obtain non-counting ticks.</span><span>
</span><span id="line-793"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishCounts"><span class="hs-identifier hs-var">tickishCounts</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682979334"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishCanSplit"><span class="hs-identifier hs-var">tickishCanSplit</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682979334"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-794"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979342"><span class="annot"><a href="#local-6989586621682979342"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979343"><span class="annot"><a href="#local-6989586621682979343"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; SimplM (LetFloats, CoreExpr)
</span><a href="#local-6989586621682979297"><span class="hs-identifier hs-var">anfise</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979335"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-795"></span><span>             </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682979344"><span class="annot"><a href="#local-6989586621682979344"><span class="hs-identifier hs-var hs-var">tickIt</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979345"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979345"><span class="hs-identifier hs-var">id</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979346"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979346"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979345"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; CoreTickish
forall (pass :: TickishPass). GenTickish pass -&gt; GenTickish pass
</span><a href="GHC.Types.Tickish.html#mkNoCount"><span class="hs-identifier hs-var">mkNoCount</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682979334"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979346"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-796"></span><span>                   </span><span id="local-6989586621682979349"><span class="annot"><a href="#local-6989586621682979349"><span class="hs-identifier hs-var hs-var">floats'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LetFloats
-&gt; ((CoreBndr, CoreExpr) -&gt; (CoreBndr, CoreExpr)) -&gt; LetFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#mapLetFloats"><span class="hs-identifier hs-var">mapLetFloats</span></a></span><span> </span><span class="annot"><span class="annottext">LetFloats
</span><a href="#local-6989586621682979342"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreBndr, CoreExpr) -&gt; (CoreBndr, CoreExpr)
</span><a href="#local-6989586621682979344"><span class="hs-identifier hs-var">tickIt</span></a></span><span>
</span><span id="line-797"></span><span>             </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979349"><span class="hs-identifier hs-type">floats'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979334"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979343"><span class="hs-identifier hs-type">rhs'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-798"></span><span>
</span><span id="line-799"></span><span>    </span><span class="annot"><a href="#local-6989586621682979297"><span class="hs-identifier hs-var">anfise</span></a></span><span> </span><span id="local-6989586621682979351"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979351"><span class="hs-identifier hs-var">other</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LetFloats, CoreExpr) -&gt; SimplM (LetFloats, CoreExpr)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LetFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#emptyLetFloats"><span class="hs-identifier hs-var">emptyLetFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979351"><span class="hs-identifier hs-var">other</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-800"></span><span>
</span><span id="line-801"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#makeTrivialArg"><span class="hs-identifier hs-type">makeTrivialArg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgSpec"><span class="hs-identifier hs-type">ArgSpec</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#LetFloats"><span class="hs-identifier hs-type">LetFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgSpec"><span class="hs-identifier hs-type">ArgSpec</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-802"></span><span id="makeTrivialArg"><span class="annot"><span class="annottext">makeTrivialArg :: HasDebugCallStack =&gt;
SimplEnv -&gt; ArgSpec -&gt; SimplM (LetFloats, ArgSpec)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#makeTrivialArg"><span class="hs-identifier hs-var hs-var">makeTrivialArg</span></a></span></span><span> </span><span id="local-6989586621682979358"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979358"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979359"><span class="annot"><span class="annottext">arg :: ArgSpec
</span><a href="#local-6989586621682979359"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ValArg"><span class="hs-identifier hs-type">ValArg</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">as_arg :: ArgSpec -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#as_arg"><span class="hs-identifier hs-var">as_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979362"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979362"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">as_dmd :: ArgSpec -&gt; Demand
</span><a href="GHC.Core.Opt.Simplify.Utils.html#as_dmd"><span class="hs-identifier hs-var">as_dmd</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979364"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682979364"><span class="hs-identifier hs-var">dmd</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-803"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979365"><span class="annot"><a href="#local-6989586621682979365"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979366"><span class="annot"><a href="#local-6989586621682979366"><span class="hs-identifier hs-var">e'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
SimplEnv
-&gt; TopLevelFlag
-&gt; Demand
-&gt; FastString
-&gt; CoreExpr
-&gt; SimplM (LetFloats, CoreExpr)
SimplEnv
-&gt; TopLevelFlag
-&gt; Demand
-&gt; FastString
-&gt; CoreExpr
-&gt; SimplM (LetFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#makeTrivial"><span class="hs-identifier hs-var">makeTrivial</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979358"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="GHC.Types.Basic.html#NotTopLevel"><span class="hs-identifier hs-var">NotTopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682979364"><span class="hs-identifier hs-var">dmd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; FastString
</span><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;arg&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979362"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-804"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979365"><span class="hs-identifier hs-type">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682979359"><span class="hs-identifier hs-type">arg</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#as_arg"><span class="hs-identifier hs-var">as_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682979366"><span class="hs-identifier hs-type">e'</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-805"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#makeTrivialArg"><span class="hs-identifier hs-var">makeTrivialArg</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682979367"><span class="annot"><span class="annottext">ArgSpec
</span><a href="#local-6989586621682979367"><span class="hs-identifier hs-var">arg</span></a></span></span><span>
</span><span id="line-806"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LetFloats, ArgSpec) -&gt; SimplM (LetFloats, ArgSpec)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LetFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#emptyLetFloats"><span class="hs-identifier hs-var">emptyLetFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ArgSpec
</span><a href="#local-6989586621682979367"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- CastBy, TyArg</span><span>
</span><span id="line-807"></span><span>
</span><span id="line-808"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#makeTrivial"><span class="hs-identifier hs-type">makeTrivial</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span>
</span><span id="line-809"></span><span>            </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span>
</span><span id="line-810"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ A &quot;friendly name&quot; to build the new binder from</span></span><span>
</span><span id="line-811"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>
</span><span id="line-812"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#LetFloats"><span class="hs-identifier hs-type">LetFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-813"></span><span class="hs-comment">-- Binds the expression to a variable, if it's not trivial, returning the variable</span><span>
</span><span id="line-814"></span><span class="hs-comment">-- For the Demand argument, see Note [Keeping demand info in StrictArg Plan A]</span><span>
</span><span id="line-815"></span><span id="makeTrivial"><span class="annot"><span class="annottext">makeTrivial :: HasDebugCallStack =&gt;
SimplEnv
-&gt; TopLevelFlag
-&gt; Demand
-&gt; FastString
-&gt; CoreExpr
-&gt; SimplM (LetFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#makeTrivial"><span class="hs-identifier hs-var hs-var">makeTrivial</span></a></span></span><span> </span><span id="local-6989586621682979390"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979390"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979391"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682979391"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621682979392"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682979392"><span class="hs-identifier hs-var">dmd</span></a></span></span><span> </span><span id="local-6989586621682979393"><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621682979393"><span class="hs-identifier hs-var">occ_fs</span></a></span></span><span> </span><span id="local-6989586621682979394"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979394"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-816"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979394"><span class="hs-identifier hs-var">expr</span></a></span><span>                          </span><span class="hs-comment">-- Already trivial</span><span>
</span><span id="line-817"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelFlag -&gt; CoreExpr -&gt; Kind -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#bindingOk"><span class="hs-identifier hs-var">bindingOk</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682979391"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979394"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979396"><span class="hs-identifier hs-var">expr_ty</span></a></span><span class="hs-special">)</span><span>       </span><span class="hs-comment">-- Cannot trivialise</span><span>
</span><span id="line-818"></span><span>                                                </span><span class="hs-comment">--   See Note [Cannot trivialise]</span><span>
</span><span id="line-819"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LetFloats, CoreExpr) -&gt; SimplM (LetFloats, CoreExpr)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LetFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#emptyLetFloats"><span class="hs-identifier hs-var">emptyLetFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979394"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-820"></span><span>
</span><span id="line-821"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682979397"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979397"><span class="hs-identifier hs-var">expr'</span></a></span></span><span> </span><span id="local-6989586621682979398"><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979398"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979394"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-822"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979399"><span class="annot"><a href="#local-6989586621682979399"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979400"><span class="annot"><a href="#local-6989586621682979400"><span class="hs-identifier hs-var">triv_expr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
SimplEnv
-&gt; TopLevelFlag
-&gt; Demand
-&gt; FastString
-&gt; CoreExpr
-&gt; SimplM (LetFloats, CoreExpr)
SimplEnv
-&gt; TopLevelFlag
-&gt; Demand
-&gt; FastString
-&gt; CoreExpr
-&gt; SimplM (LetFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#makeTrivial"><span class="hs-identifier hs-var">makeTrivial</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979390"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682979391"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682979392"><span class="hs-identifier hs-var">dmd</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621682979393"><span class="hs-identifier hs-var">occ_fs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979397"><span class="hs-identifier hs-var">expr'</span></a></span><span>
</span><span id="line-823"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979399"><span class="hs-identifier hs-type">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979400"><span class="hs-identifier hs-type">triv_expr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979398"><span class="hs-identifier hs-type">co</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-824"></span><span>
</span><span id="line-825"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-comment">-- 'expr' is not of form (Cast e co)</span><span>
</span><span id="line-826"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979401"><span class="annot"><a href="#local-6989586621682979401"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979402"><span class="annot"><a href="#local-6989586621682979402"><span class="hs-identifier hs-var">expr1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
SimplEnv
-&gt; TopLevelFlag
-&gt; FastString
-&gt; CoreExpr
-&gt; SimplM (LetFloats, CoreExpr)
SimplEnv
-&gt; TopLevelFlag
-&gt; FastString
-&gt; CoreExpr
-&gt; SimplM (LetFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#prepareRhs"><span class="hs-identifier hs-var">prepareRhs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979390"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682979391"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621682979393"><span class="hs-identifier hs-var">occ_fs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979394"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-827"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682979403"><span class="annot"><a href="#local-6989586621682979403"><span class="hs-identifier hs-var">uniq</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#getUniqueM"><span class="hs-identifier hs-type">getUniqueM</span></a></span><span>
</span><span id="line-828"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682979404"><span class="annot"><a href="#local-6989586621682979404"><span class="hs-identifier hs-var hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unique -&gt; FastString -&gt; Name
</span><a href="GHC.Types.Name.html#mkSystemVarName"><span class="hs-identifier hs-var">mkSystemVarName</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682979403"><span class="hs-identifier hs-var">uniq</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621682979393"><span class="hs-identifier hs-var">occ_fs</span></a></span><span>
</span><span id="line-829"></span><span>              </span><span id="local-6989586621682979405"><span class="annot"><a href="#local-6989586621682979405"><span class="hs-identifier hs-var hs-var">var</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Name -&gt; Kind -&gt; Kind -&gt; IdInfo -&gt; CoreBndr
Name -&gt; Kind -&gt; Kind -&gt; IdInfo -&gt; CoreBndr
</span><a href="GHC.Types.Id.html#mkLocalIdWithInfo"><span class="hs-identifier hs-var">mkLocalIdWithInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682979404"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="GHC.Core.Type.html#ManyTy"><span class="hs-identifier hs-var">ManyTy</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979396"><span class="hs-identifier hs-var">expr_ty</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621682979406"><span class="hs-identifier hs-var">id_info</span></a></span><span>
</span><span id="line-830"></span><span>
</span><span id="line-831"></span><span>        </span><span class="hs-comment">-- Now something very like completeBind,</span><span>
</span><span id="line-832"></span><span>        </span><span class="hs-comment">-- but without the postInlineUnconditionally part</span><span>
</span><span id="line-833"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979407"><span class="annot"><a href="#local-6989586621682979407"><span class="hs-identifier hs-var">arity_type</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979408"><span class="annot"><a href="#local-6989586621682979408"><span class="hs-identifier hs-var">expr2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#tryEtaExpandRhs"><span class="hs-identifier hs-type">tryEtaExpandRhs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979390"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BC_Let"><span class="hs-identifier hs-type">BC_Let</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979391"><span class="hs-identifier hs-type">top_lvl</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#NonRecursive"><span class="hs-identifier hs-type">NonRecursive</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682979405"><span class="hs-identifier hs-type">var</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979402"><span class="hs-identifier hs-type">expr1</span></a></span><span>
</span><span id="line-834"></span><span>          </span><span class="hs-comment">-- Technically we should extend the in-scope set in 'env' with</span><span>
</span><span id="line-835"></span><span>          </span><span class="hs-comment">-- the 'floats' from prepareRHS; but they are all fresh, so there is</span><span>
</span><span id="line-836"></span><span>          </span><span class="hs-comment">-- no danger of introducing name shadowing in eta expansion</span><span>
</span><span id="line-837"></span><span>
</span><span id="line-838"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682979410"><span class="annot"><a href="#local-6989586621682979410"><span class="hs-identifier hs-var">unf</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#mkLetUnfolding"><span class="hs-identifier hs-type">mkLetUnfolding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979390"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979391"><span class="hs-identifier hs-type">top_lvl</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#VanillaSrc"><span class="hs-identifier hs-type">VanillaSrc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979405"><span class="hs-identifier hs-type">var</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span> </span><span class="annot"><a href="#local-6989586621682979408"><span class="hs-identifier hs-type">expr2</span></a></span><span>
</span><span id="line-839"></span><span>
</span><span id="line-840"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682979411"><span class="annot"><a href="#local-6989586621682979411"><span class="hs-identifier hs-var hs-var">final_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; ArityType -&gt; Unfolding -&gt; CoreBndr
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#addLetBndrInfo"><span class="hs-identifier hs-var">addLetBndrInfo</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979405"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621682979407"><span class="hs-identifier hs-var">arity_type</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682979410"><span class="hs-identifier hs-var">unf</span></a></span><span>
</span><span id="line-841"></span><span>              </span><span id="local-6989586621682979413"><span class="annot"><a href="#local-6989586621682979413"><span class="hs-identifier hs-var hs-var">bind</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; CoreExpr -&gt; InBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979411"><span class="hs-identifier hs-var">final_id</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979408"><span class="hs-identifier hs-var">expr2</span></a></span><span>
</span><span id="line-842"></span><span>
</span><span id="line-843"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#traceSmpl"><span class="hs-identifier hs-type">traceSmpl</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;makeTrivial&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-type">vcat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;final_id&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979411"><span class="hs-identifier hs-type">final_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;rhs&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979408"><span class="hs-identifier hs-type">expr2</span></a></span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-844"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="#local-6989586621682979401"><span class="hs-identifier hs-type">floats</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#addLetFlts"><span class="hs-operator hs-type">`addLetFlts`</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#unitLetFloat"><span class="hs-identifier hs-type">unitLetFloat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979413"><span class="hs-identifier hs-type">bind</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979411"><span class="hs-identifier hs-type">final_id</span></a></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-845"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-846"></span><span>    </span><span id="local-6989586621682979406"><span class="annot"><span class="annottext">id_info :: IdInfo
</span><a href="#local-6989586621682979406"><span class="hs-identifier hs-var hs-var">id_info</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="GHC.Types.Id.Info.html#vanillaIdInfo"><span class="hs-identifier hs-var">vanillaIdInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo -&gt; Demand -&gt; IdInfo
</span><a href="GHC.Types.Id.Info.html#setDemandInfo"><span class="hs-operator hs-var">`setDemandInfo`</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682979392"><span class="hs-identifier hs-var">dmd</span></a></span><span>
</span><span id="line-847"></span><span>    </span><span id="local-6989586621682979396"><span class="annot"><span class="annottext">expr_ty :: Kind
</span><a href="#local-6989586621682979396"><span class="hs-identifier hs-var hs-var">expr_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; Kind
CoreExpr -&gt; Kind
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979394"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-848"></span><span>
</span><span id="line-849"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#bindingOk"><span class="hs-identifier hs-type">bindingOk</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-850"></span><span class="hs-comment">-- True iff we can have a binding of this expression at this level</span><span>
</span><span id="line-851"></span><span class="hs-comment">-- Precondition: the type is the type of the expression</span><span>
</span><span id="line-852"></span><span id="bindingOk"><span class="annot"><span class="annottext">bindingOk :: TopLevelFlag -&gt; CoreExpr -&gt; Kind -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#bindingOk"><span class="hs-identifier hs-var hs-var">bindingOk</span></a></span></span><span> </span><span id="local-6989586621682979415"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682979415"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621682979416"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979416"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span id="local-6989586621682979417"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979417"><span class="hs-identifier hs-var">expr_ty</span></a></span></span><span>
</span><span id="line-853"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; Bool
</span><a href="GHC.Types.Basic.html#isTopLevel"><span class="hs-identifier hs-var">isTopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682979415"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Kind -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsTopLevelBindable"><span class="hs-identifier hs-var">exprIsTopLevelBindable</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979416"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979417"><span class="hs-identifier hs-var">expr_ty</span></a></span><span>
</span><span id="line-854"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-855"></span><span>
</span><span id="line-856"></span><span class="hs-comment">{- Note [Cannot trivialise]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider:
   f :: Int -&gt; Addr#

   foo :: Bar
   foo = Bar (f 3)

Then we can't ANF-ise foo, even though we'd like to, because
we can't make a top-level binding for the Addr# (f 3). And if
so we don't want to turn it into
   foo = let x = f 3 in Bar x
because we'll just end up inlining x back, and that makes the
simplifier loop.  Better not to ANF-ise it at all.

Literal strings are an exception.

   foo = Ptr &quot;blob&quot;#

We want to turn this into:

   foo1 = &quot;blob&quot;#
   foo = Ptr foo1

See Note [Core top-level string literals] in GHC.Core.

************************************************************************
*                                                                      *
          Completing a lazy binding
*                                                                      *
************************************************************************

completeBind
  * deals only with Ids, not TyVars
  * takes an already-simplified binder and RHS
  * is used for both recursive and non-recursive bindings
  * is used for both top-level and non-top-level bindings

It does the following:
  - tries discarding a dead binding
  - tries PostInlineUnconditionally
  - add unfolding [this is the only place we add an unfolding]
  - add arity
  - extend the InScopeSet of the SimplEnv

It does *not* attempt to do let-to-case.  Why?  Because it is used for
  - top-level bindings (when let-to-case is impossible)
  - many situations where the &quot;rhs&quot; is known to be a WHNF
                (so let-to-case is inappropriate).

Nor does it do the atomic-argument thing
-}</span><span>
</span><span id="line-908"></span><span>
</span><span id="line-909"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#completeBind"><span class="hs-identifier hs-type">completeBind</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BindContext"><span class="hs-identifier hs-type">BindContext</span></a></span><span>
</span><span id="line-910"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span class="hs-special">)</span><span>           </span><span class="hs-comment">-- Old binder, and the static envt in which to simplify</span><span>
</span><span id="line-911"></span><span>                                           </span><span class="hs-comment">--   its stable unfolding (if any)</span><span>
</span><span id="line-912"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- New binder and rhs; can be a JoinId.</span><span>
</span><span id="line-913"></span><span>                                           </span><span class="hs-comment">-- And the SimplEnv with that OutId in scope.</span><span>
</span><span id="line-914"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-915"></span><span class="hs-comment">-- completeBind may choose to do its work</span><span>
</span><span id="line-916"></span><span class="hs-comment">--      * by extending the substitution (e.g. let x = y in ...)</span><span>
</span><span id="line-917"></span><span class="hs-comment">--      * or by adding to the floats in the envt</span><span>
</span><span id="line-918"></span><span class="hs-comment">--</span><span>
</span><span id="line-919"></span><span class="hs-comment">-- Binder /can/ be a JoinId</span><span>
</span><span id="line-920"></span><span class="hs-comment">-- Precondition: rhs obeys the let-can-float invariant</span><span>
</span><span id="line-921"></span><span id="completeBind"><span class="annot"><span class="annottext">completeBind :: BindContext
-&gt; (CoreBndr, SimplEnv)
-&gt; (CoreBndr, CoreExpr, SimplEnv)
-&gt; SimplM (SimplFloats, SimplEnv)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#completeBind"><span class="hs-identifier hs-var hs-var">completeBind</span></a></span></span><span> </span><span id="local-6989586621682979420"><span class="annot"><span class="annottext">BindContext
</span><a href="#local-6989586621682979420"><span class="hs-identifier hs-var">bind_cxt</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979421"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979421"><span class="hs-identifier hs-var">old_bndr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979422"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979422"><span class="hs-identifier hs-var">unf_se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979423"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979423"><span class="hs-identifier hs-var">new_bndr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979424"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979424"><span class="hs-identifier hs-var">new_rhs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979425"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979425"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-922"></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979421"><span class="hs-identifier hs-var">old_bndr</span></a></span><span>
</span><span id="line-923"></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979424"><span class="hs-identifier hs-var">new_rhs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-924"></span><span>     </span><span class="annot"><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span id="local-6989586621682979428"><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979428"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(SimplFloats, SimplEnv) -&gt; SimplM (SimplFloats, SimplEnv)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979425"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; CoercionR -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#extendCvSubst"><span class="hs-identifier hs-var">extendCvSubst</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979425"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979421"><span class="hs-identifier hs-var">old_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979428"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-925"></span><span>     </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(SimplFloats, SimplEnv) -&gt; SimplM (SimplFloats, SimplEnv)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv -&gt; InBind -&gt; (SimplFloats, SimplEnv)
</span><a href="GHC.Core.Opt.Simplify.Env.html#mkFloatBind"><span class="hs-identifier hs-var">mkFloatBind</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979425"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; CoreExpr -&gt; InBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979423"><span class="hs-identifier hs-var">new_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979424"><span class="hs-identifier hs-var">new_rhs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-926"></span><span>
</span><span id="line-927"></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-928"></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; SimplM (SimplFloats, SimplEnv) -&gt; SimplM (SimplFloats, SimplEnv)
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979423"><span class="hs-identifier hs-var">new_bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SimplM (SimplFloats, SimplEnv) -&gt; SimplM (SimplFloats, SimplEnv))
-&gt; SimplM (SimplFloats, SimplEnv) -&gt; SimplM (SimplFloats, SimplEnv)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-929"></span><span>   </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682979430"><span class="annot"><span class="annottext">old_info :: IdInfo
</span><a href="#local-6989586621682979430"><span class="hs-identifier hs-var hs-var hs-var">old_info</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreBndr -&gt; IdInfo
CoreBndr -&gt; IdInfo
</span><a href="GHC.Types.Var.html#idInfo"><span class="hs-identifier hs-var">idInfo</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979421"><span class="hs-identifier hs-var">old_bndr</span></a></span><span>
</span><span id="line-930"></span><span>            </span><span id="local-6989586621682979431"><span class="annot"><span class="annottext">old_unf :: Unfolding
</span><a href="#local-6989586621682979431"><span class="hs-identifier hs-var hs-var hs-var">old_unf</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdInfo -&gt; Unfolding
</span><a href="GHC.Types.Id.Info.html#realUnfoldingInfo"><span class="hs-identifier hs-var">realUnfoldingInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621682979430"><span class="hs-identifier hs-var">old_info</span></a></span><span>
</span><span id="line-931"></span><span>
</span><span id="line-932"></span><span>         </span><span class="hs-comment">-- Do eta-expansion on the RHS of the binding</span><span>
</span><span id="line-933"></span><span>         </span><span class="hs-comment">-- See Note [Eta-expanding at let bindings] in GHC.Core.Opt.Simplify.Utils</span><span>
</span><span id="line-934"></span><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979432"><span class="annot"><a href="#local-6989586621682979432"><span class="hs-identifier hs-var">new_arity</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979433"><span class="annot"><a href="#local-6989586621682979433"><span class="hs-identifier hs-var">eta_rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; BindContext
-&gt; CoreBndr
-&gt; CoreExpr
-&gt; SimplM (ArityType, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Utils.html#tryEtaExpandRhs"><span class="hs-identifier hs-var">tryEtaExpandRhs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979425"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">BindContext
</span><a href="#local-6989586621682979420"><span class="hs-identifier hs-var">bind_cxt</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979423"><span class="hs-identifier hs-var">new_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979424"><span class="hs-identifier hs-var">new_rhs</span></a></span><span>
</span><span id="line-935"></span><span>
</span><span id="line-936"></span><span>        </span><span class="hs-comment">-- Simplify the unfolding; see Note [Environment for simplLetUnfolding]</span><span>
</span><span id="line-937"></span><span>      </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682979434"><span class="annot"><a href="#local-6989586621682979434"><span class="hs-identifier hs-var">new_unfolding</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplLetUnfolding"><span class="hs-identifier hs-type">simplLetUnfolding</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979422"><span class="hs-identifier hs-type">unf_se</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#setInScopeFromE"><span class="hs-operator hs-type">`setInScopeFromE`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979425"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-938"></span><span>                            </span><span class="annot"><a href="#local-6989586621682979420"><span class="hs-identifier hs-type">bind_cxt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979421"><span class="hs-identifier hs-type">old_bndr</span></a></span><span>
</span><span id="line-939"></span><span>                            </span><span class="annot"><a href="#local-6989586621682979433"><span class="hs-identifier hs-type">eta_rhs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-type">idType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979423"><span class="hs-identifier hs-type">new_bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682979432"><span class="hs-identifier hs-type">new_arity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979431"><span class="hs-identifier hs-type">old_unf</span></a></span><span>
</span><span id="line-940"></span><span>
</span><span id="line-941"></span><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682979437"><span class="annot"><a href="#local-6989586621682979437"><span class="hs-identifier hs-var hs-var">new_bndr_w_info</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; ArityType -&gt; Unfolding -&gt; CoreBndr
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#addLetBndrInfo"><span class="hs-identifier hs-var">addLetBndrInfo</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979423"><span class="hs-identifier hs-var">new_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621682979432"><span class="hs-identifier hs-var">new_arity</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682979434"><span class="hs-identifier hs-var">new_unfolding</span></a></span><span>
</span><span id="line-942"></span><span>        </span><span class="hs-comment">-- See Note [In-scope set as a substitution]</span><span>
</span><span id="line-943"></span><span>
</span><span id="line-944"></span><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#postInlineUnconditionally"><span class="hs-identifier hs-type">postInlineUnconditionally</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979425"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979420"><span class="hs-identifier hs-type">bind_cxt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979421"><span class="hs-identifier hs-type">old_bndr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979437"><span class="hs-identifier hs-type">new_bndr_w_info</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979433"><span class="hs-identifier hs-type">eta_rhs</span></a></span><span>
</span><span id="line-945"></span><span>
</span><span id="line-946"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-comment">-- Inline and discard the binding</span><span>
</span><span id="line-947"></span><span>             </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#tick"><span class="hs-identifier hs-type">tick</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Stats.html#PostInlineUnconditionally"><span class="hs-identifier hs-type">PostInlineUnconditionally</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979421"><span class="hs-identifier hs-type">old_bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-948"></span><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682979438"><span class="annot"><a href="#local-6989586621682979438"><span class="hs-identifier hs-var hs-var">unf_rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; Maybe CoreExpr
</span><a href="GHC.Core.html#maybeUnfoldingTemplate"><span class="hs-identifier hs-var">maybeUnfoldingTemplate</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682979434"><span class="hs-identifier hs-var">new_unfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe CoreExpr -&gt; CoreExpr -&gt; CoreExpr
forall a. Maybe a -&gt; a -&gt; a
</span><a href="GHC.Data.Maybe.html#orElse"><span class="hs-operator hs-var">`orElse`</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979433"><span class="hs-identifier hs-var">eta_rhs</span></a></span><span>
</span><span id="line-949"></span><span>                          </span><span class="hs-comment">-- See Note [Use occ-anald RHS in postInlineUnconditionally]</span><span>
</span><span id="line-950"></span><span>                 </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplTrace"><span class="hs-identifier hs-type">simplTrace</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;PostInlineUnconditionally&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979423"><span class="hs-identifier hs-type">new_bndr</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979438"><span class="hs-identifier hs-type">unf_rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-951"></span><span>                   </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#emptyFloats"><span class="hs-identifier hs-type">emptyFloats</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979425"><span class="hs-identifier hs-type">env</span></a></span><span>
</span><span id="line-952"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#extendIdSubst"><span class="hs-identifier hs-type">extendIdSubst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979425"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979421"><span class="hs-identifier hs-type">old_bndr</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-953"></span><span>                            </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#DoneEx"><span class="hs-identifier hs-type">DoneEx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979438"><span class="hs-identifier hs-type">unf_rhs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Id.html#idJoinPointHood"><span class="hs-identifier hs-type">idJoinPointHood</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979423"><span class="hs-identifier hs-type">new_bndr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-954"></span><span>                </span><span class="hs-comment">-- Use the substitution to make quite, quite sure that the</span><span>
</span><span id="line-955"></span><span>                </span><span class="hs-comment">-- substitution will happen, since we are going to discard the binding</span><span>
</span><span id="line-956"></span><span>
</span><span id="line-957"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-comment">-- Keep the binding; do cast worker/wrapper</span><span>
</span><span id="line-958"></span><span class="hs-comment">--             simplTrace &quot;completeBind&quot; (vcat [ text &quot;bndrs&quot; &lt;+&gt; ppr old_bndr &lt;+&gt; ppr new_bndr</span><span>
</span><span id="line-959"></span><span class="hs-comment">--                                             , text &quot;eta_rhs&quot; &lt;+&gt; ppr eta_rhs ]) $</span><span>
</span><span id="line-960"></span><span>             </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#tryCastWorkerWrapper"><span class="hs-identifier hs-type">tryCastWorkerWrapper</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979425"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979420"><span class="hs-identifier hs-type">bind_cxt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979421"><span class="hs-identifier hs-type">old_bndr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979437"><span class="hs-identifier hs-type">new_bndr_w_info</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979433"><span class="hs-identifier hs-type">eta_rhs</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-961"></span><span>
</span><span id="line-962"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#addLetBndrInfo"><span class="hs-identifier hs-type">addLetBndrInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span>
</span><span id="line-963"></span><span id="addLetBndrInfo"><span class="annot"><span class="annottext">addLetBndrInfo :: CoreBndr -&gt; ArityType -&gt; Unfolding -&gt; CoreBndr
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#addLetBndrInfo"><span class="hs-identifier hs-var hs-var">addLetBndrInfo</span></a></span></span><span> </span><span id="local-6989586621682979441"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979441"><span class="hs-identifier hs-var">new_bndr</span></a></span></span><span> </span><span id="local-6989586621682979442"><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621682979442"><span class="hs-identifier hs-var">new_arity_type</span></a></span></span><span> </span><span id="local-6989586621682979443"><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682979443"><span class="hs-identifier hs-var">new_unf</span></a></span></span><span>
</span><span id="line-964"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979441"><span class="hs-identifier hs-var">new_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; IdInfo -&gt; CoreBndr
</span><a href="GHC.Types.Id.html#setIdInfo"><span class="hs-operator hs-var">`setIdInfo`</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621682979445"><span class="hs-identifier hs-var">info5</span></a></span><span>
</span><span id="line-965"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-966"></span><span>    </span><span id="local-6989586621682979446"><span class="annot"><span class="annottext">new_arity :: Int
</span><a href="#local-6989586621682979446"><span class="hs-identifier hs-var hs-var">new_arity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityType -&gt; Int
</span><a href="GHC.Core.Opt.Arity.html#arityTypeArity"><span class="hs-identifier hs-var">arityTypeArity</span></a></span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621682979442"><span class="hs-identifier hs-var">new_arity_type</span></a></span><span>
</span><span id="line-967"></span><span>    </span><span id="local-6989586621682979447"><span class="annot"><span class="annottext">info1 :: IdInfo
</span><a href="#local-6989586621682979447"><span class="hs-identifier hs-var hs-var">info1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreBndr -&gt; IdInfo
CoreBndr -&gt; IdInfo
</span><a href="GHC.Types.Var.html#idInfo"><span class="hs-identifier hs-var">idInfo</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979441"><span class="hs-identifier hs-var">new_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo -&gt; Int -&gt; IdInfo
</span><a href="GHC.Types.Id.Info.html#setArityInfo"><span class="hs-operator hs-var">`setArityInfo`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682979446"><span class="hs-identifier hs-var">new_arity</span></a></span><span>
</span><span id="line-968"></span><span>
</span><span id="line-969"></span><span>    </span><span class="hs-comment">-- Unfolding info: Note [Setting the new unfolding]</span><span>
</span><span id="line-970"></span><span>    </span><span id="local-6989586621682979448"><span class="annot"><span class="annottext">info2 :: IdInfo
</span><a href="#local-6989586621682979448"><span class="hs-identifier hs-var hs-var">info2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621682979447"><span class="hs-identifier hs-var">info1</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo -&gt; Unfolding -&gt; IdInfo
</span><a href="GHC.Types.Id.Info.html#setUnfoldingInfo"><span class="hs-operator hs-var">`setUnfoldingInfo`</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682979443"><span class="hs-identifier hs-var">new_unf</span></a></span><span>
</span><span id="line-971"></span><span>
</span><span id="line-972"></span><span>    </span><span class="hs-comment">-- Demand info: Note [Setting the demand info]</span><span>
</span><span id="line-973"></span><span>    </span><span id="local-6989586621682979450"><span class="annot"><span class="annottext">info3 :: IdInfo
</span><a href="#local-6989586621682979450"><span class="hs-identifier hs-var hs-var">info3</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; Bool
</span><a href="GHC.Core.html#isEvaldUnfolding"><span class="hs-identifier hs-var">isEvaldUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682979443"><span class="hs-identifier hs-var">new_unf</span></a></span><span>
</span><span id="line-974"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdInfo -&gt; Maybe IdInfo
</span><a href="GHC.Types.Id.Info.html#lazifyDemandInfo"><span class="hs-identifier hs-var">lazifyDemandInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621682979448"><span class="hs-identifier hs-var">info2</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe IdInfo -&gt; IdInfo -&gt; IdInfo
forall a. Maybe a -&gt; a -&gt; a
</span><a href="GHC.Data.Maybe.html#orElse"><span class="hs-operator hs-var">`orElse`</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621682979448"><span class="hs-identifier hs-var">info2</span></a></span><span>
</span><span id="line-975"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-976"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621682979448"><span class="hs-identifier hs-var">info2</span></a></span><span>
</span><span id="line-977"></span><span>
</span><span id="line-978"></span><span>    </span><span class="hs-comment">-- Bottoming bindings: see Note [Bottoming bindings]</span><span>
</span><span id="line-979"></span><span>    </span><span id="local-6989586621682979453"><span class="annot"><span class="annottext">info4 :: IdInfo
</span><a href="#local-6989586621682979453"><span class="hs-identifier hs-var hs-var">info4</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ArityType -&gt; Maybe (Int, DmdSig, CprSig)
</span><a href="GHC.Core.Opt.Arity.html#arityTypeBotSigs_maybe"><span class="hs-identifier hs-var">arityTypeBotSigs_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621682979442"><span class="hs-identifier hs-var">new_arity_type</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-980"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Int, DmdSig, CprSig)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621682979450"><span class="hs-identifier hs-var">info3</span></a></span><span>
</span><span id="line-981"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979454"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682979454"><span class="hs-identifier hs-var">ar</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979455"><span class="annot"><span class="annottext">DmdSig
</span><a href="#local-6989586621682979455"><span class="hs-identifier hs-var">str_sig</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979456"><span class="annot"><span class="annottext">CprSig
</span><a href="#local-6989586621682979456"><span class="hs-identifier hs-var">cpr_sig</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IdInfo -&gt; IdInfo
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682979454"><span class="hs-identifier hs-var">ar</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682979446"><span class="hs-identifier hs-var">new_arity</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IdInfo -&gt; IdInfo) -&gt; IdInfo -&gt; IdInfo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-982"></span><span>                                       </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621682979450"><span class="hs-identifier hs-var">info3</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo -&gt; DmdSig -&gt; IdInfo
</span><a href="GHC.Types.Id.Info.html#setDmdSigInfo"><span class="hs-operator hs-var">`setDmdSigInfo`</span></a></span><span> </span><span class="annot"><span class="annottext">DmdSig
</span><a href="#local-6989586621682979455"><span class="hs-identifier hs-var">str_sig</span></a></span><span>
</span><span id="line-983"></span><span>                                             </span><span class="annot"><span class="annottext">IdInfo -&gt; CprSig -&gt; IdInfo
</span><a href="GHC.Types.Id.Info.html#setCprSigInfo"><span class="hs-operator hs-var">`setCprSigInfo`</span></a></span><span> </span><span class="annot"><span class="annottext">CprSig
</span><a href="#local-6989586621682979456"><span class="hs-identifier hs-var">cpr_sig</span></a></span><span>
</span><span id="line-984"></span><span>
</span><span id="line-985"></span><span>     </span><span class="hs-comment">-- Zap call arity info. We have used it by now (via</span><span>
</span><span id="line-986"></span><span>     </span><span class="hs-comment">-- `tryEtaExpandRhs`), and the simplifier can invalidate this</span><span>
</span><span id="line-987"></span><span>     </span><span class="hs-comment">-- information, leading to broken code later (e.g. #13479)</span><span>
</span><span id="line-988"></span><span>    </span><span id="local-6989586621682979445"><span class="annot"><span class="annottext">info5 :: IdInfo
</span><a href="#local-6989586621682979445"><span class="hs-identifier hs-var hs-var">info5</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdInfo -&gt; IdInfo
</span><a href="GHC.Types.Id.Info.html#zapCallArityInfo"><span class="hs-identifier hs-var">zapCallArityInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621682979453"><span class="hs-identifier hs-var">info4</span></a></span><span>
</span><span id="line-989"></span><span>
</span><span id="line-990"></span><span>
</span><span id="line-991"></span><span class="hs-comment">{- Note [Bottoming bindings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have
   let x = error &quot;urk&quot;
   in ...(case x of &lt;alts&gt;)...
or
   let f = \y. error (y ++ &quot;urk&quot;)
   in ...(case f &quot;foo&quot; of &lt;alts&gt;)...

Then we'd like to drop the dead &lt;alts&gt; immediately.  So it's good to
propagate the info that x's (or f's) RHS is bottom to x's (or f's)
IdInfo as rapidly as possible.

We use tryEtaExpandRhs on every binding, and it turns out that the
arity computation it performs (via GHC.Core.Opt.Arity.findRhsArity) already
does a simple bottoming-expression analysis.  So all we need to do
is propagate that info to the binder's IdInfo.

This showed up in #12150; see comment:16.

There is a second reason for settting  the strictness signature. Consider
   let -- f :: &lt;[S]b&gt;
       f = \x. error &quot;urk&quot;
   in ...(f a b c)...
Then, in GHC.Core.Opt.Arity.findRhsArity we'll use the demand-info on `f`
to eta-expand to
   let f = \x y z. error &quot;urk&quot;
   in ...(f a b c)...

But now f's strictness signature has too short an arity; see
GHC.Core.Opt.DmdAnal Note [idArity varies independently of dmdTypeDepth].
Fortuitously, the same strictness-signature-fixup code
gives the function a new strictness signature with the right number of
arguments.  Example in stranal/should_compile/EtaExpansion.

Note [Setting the demand info]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If the unfolding is a value, the demand info may
go pear-shaped, so we nuke it.  Example:
     let x = (a,b) in
     case x of (p,q) -&gt; h p q x
Here x is certainly demanded. But after we've nuked
the case, we'll get just
     let x = (a,b) in h a b x
and now x is not demanded (I'm assuming h is lazy)
This really happens.  Similarly
     let f = \x -&gt; e in ...f..f...
After inlining f at some of its call sites the original binding may
(for example) be no longer strictly demanded.
The solution here is a bit ad hoc...

Note [Use occ-anald RHS in postInlineUnconditionally]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we postInlineUnconditionally 'f in
  let f = \x -&gt; x True in ...(f blah)...
then we'd like to inline the /occ-anald/ RHS for 'f'.  If we
use the non-occ-anald version, we'll end up with a
    ...(let x = blah in x True)...
and hence an extra Simplifier iteration.

We already /have/ the occ-anald version in the Unfolding for
the Id.  Well, maybe not /quite/ always.  If the binder is Dead,
postInlineUnconditionally will return True, but we may not have an
unfolding because it's too big. Hence the belt-and-braces `orElse`
in the defn of unf_rhs.  The Nothing case probably never happens.

Note [Environment for simplLetUnfolding]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We need to be rather careful about the static environment in which
we simplify a stable unfolding.  Consider (#24242):

  f x = let y_Xb = ... in
        let step1_Xb {Stable unfolding = ....y_Xb...} = rhs in
         ...

Note that `y_Xb` and `step1_Xb` have the same unique (`Xb`). This can happen;
see Note [Shadowing in Core] in GHC.Core, and Note [Shadowing in the Simplifier].
This is perfectly fine. The `y_Xb` in the stable unfolding of the non-
recursive binding for `step1` refers, of course, to `let y_Xb = ....`.
When simplifying the binder `step1_Xb` we'll give it a new unique, and
extend the static environment with [Xb :-&gt; step1_Xc], say.

But when simplifying step1's stable unfolding, we must use static environment
/before/ simplifying the binder `step1_Xb`; that is, a static envt that maps
[Xb :-&gt; y_Xb], /not/ [Xb :-&gt; step1_Xc].

That is why we pass around a pair `(InId, SimplEnv)` for the binder, keeping
track of the right environment for the unfolding of that InId.  See the type
of `simplLazyBind`, `simplJoinBind`, `completeBind`.

This only matters when we have
  - A non-recursive binding for f
  - has a stable unfolding
  - and that unfolding mentions a variable y
  - that has the same unique as f.
So triggering  a bug here is really hard!

************************************************************************
*                                                                      *
\subsection[Simplify-simplExpr]{The main function: simplExpr}
*                                                                      *
************************************************************************

The reason for this OutExprStuff stuff is that we want to float *after*
simplifying a RHS, not before.  If we do so naively we get quadratic
behaviour as things float out.

To see why it's important to do it after, consider this (real) example:

        let t = f x
        in fst t
==&gt;
        let t = let a = e1
                    b = e2
                in (a,b)
        in fst t
==&gt;
        let a = e1
            b = e2
            t = (a,b)
        in
        a       -- Can't inline a this round, cos it appears twice
==&gt;
        e1

Each of the ==&gt; steps is a round of simplification.  We'd save a
whole round if we float first.  This can cascade.  Consider

        let f = g d
        in \x -&gt; ...f...
==&gt;
        let f = let d1 = ..d.. in \y -&gt; e
        in \x -&gt; ...f...
==&gt;
        let d1 = ..d..
        in \x -&gt; ...(\y -&gt;e)...

Only in this second round can the \y be applied, and it
might do the same again.
-}</span><span>
</span><span id="line-1131"></span><span>
</span><span id="line-1132"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExpr"><span class="hs-identifier hs-type">simplExpr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-1133"></span><span id="simplExpr"><span class="annot"><span class="annottext">simplExpr :: SimplEnv -&gt; CoreExpr -&gt; SimplM CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExpr"><span class="hs-identifier hs-var hs-var">simplExpr</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682979458"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979458"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span id="local-6989586621682979459"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979459"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- See Note [Bangs in the Simplifier]</span><span>
</span><span id="line-1134"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682979460"><span class="annot"><a href="#local-6989586621682979460"><span class="hs-identifier hs-var">ty'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; Kind -&gt; SimplM Kind
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplType"><span class="hs-identifier hs-var">simplType</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979458"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979459"><span class="hs-identifier hs-var">ty</span></a></span><span>  </span><span class="hs-comment">-- See Note [Avoiding space leaks in OutType]</span><span>
</span><span id="line-1135"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979460"><span class="hs-identifier hs-type">ty'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1136"></span><span>
</span><span id="line-1137"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExpr"><span class="hs-identifier hs-var">simplExpr</span></a></span><span> </span><span id="local-6989586621682979462"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979462"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979463"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979463"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-1138"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprC"><span class="hs-identifier hs-var">simplExprC</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979462"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979463"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Kind -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#mkBoringStop"><span class="hs-identifier hs-var">mkBoringStop</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979466"><span class="hs-identifier hs-var">expr_out_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1139"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1140"></span><span>    </span><span class="annot"><a href="#local-6989586621682979466"><span class="hs-identifier hs-type">expr_out_ty</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#OutType"><span class="hs-identifier hs-type">OutType</span></a></span><span>
</span><span id="line-1141"></span><span>    </span><span id="local-6989586621682979466"><span class="annot"><span class="annottext">expr_out_ty :: Kind
</span><a href="#local-6989586621682979466"><span class="hs-identifier hs-var hs-var">expr_out_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; SimplEnv -&gt; Kind -&gt; Kind
SimplEnv -&gt; Kind -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Env.html#substTy"><span class="hs-identifier hs-var">substTy</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979462"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; Kind
CoreExpr -&gt; Kind
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979463"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1142"></span><span>    </span><span class="hs-comment">-- NB: Since 'expr' is term-valued, not (Type ty), this call</span><span>
</span><span id="line-1143"></span><span>    </span><span class="hs-comment">--     to exprType will succeed.  exprType fails on (Type ty).</span><span>
</span><span id="line-1144"></span><span>
</span><span id="line-1145"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprC"><span class="hs-identifier hs-type">simplExprC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span>
</span><span id="line-1146"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span>     </span><span class="hs-comment">-- A term-valued expression, never (Type ty)</span><span>
</span><span id="line-1147"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-1148"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>
</span><span id="line-1149"></span><span>        </span><span class="hs-comment">-- Simplify an expression, given a continuation</span><span>
</span><span id="line-1150"></span><span id="simplExprC"><span class="annot"><span class="annottext">simplExprC :: SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprC"><span class="hs-identifier hs-var hs-var">simplExprC</span></a></span></span><span> </span><span id="local-6989586621682979468"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979468"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979469"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979469"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span id="local-6989586621682979470"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979470"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-1151"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;simplExprC&quot; (ppr expr $$ ppr cont) $</span><span>
</span><span id="line-1152"></span><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979471"><span class="annot"><a href="#local-6989586621682979471"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979472"><span class="annot"><a href="#local-6989586621682979472"><span class="hs-identifier hs-var">expr'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979468"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979469"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979470"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1153"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-comment">-- pprTrace &quot;simplExprC ret&quot; (ppr expr $$ ppr expr') $</span><span>
</span><span id="line-1154"></span><span>          </span><span class="hs-comment">-- pprTrace &quot;simplExprC ret3&quot; (ppr (seInScope env')) $</span><span>
</span><span id="line-1155"></span><span>          </span><span class="hs-comment">-- pprTrace &quot;simplExprC ret4&quot; (ppr (seLetFloats env')) $</span><span>
</span><span id="line-1156"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#wrapFloats"><span class="hs-identifier hs-type">wrapFloats</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979471"><span class="hs-identifier hs-type">floats</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979472"><span class="hs-identifier hs-type">expr'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1157"></span><span>
</span><span id="line-1158"></span><span class="hs-comment">--------------------------------------------------</span><span>
</span><span id="line-1159"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF"><span class="hs-identifier hs-type">simplExprF</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span>
</span><span id="line-1160"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span>     </span><span class="hs-comment">-- A term-valued expression, never (Type ty)</span><span>
</span><span id="line-1161"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-1162"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1163"></span><span>
</span><span id="line-1164"></span><span id="simplExprF"><span class="annot"><span class="annottext">simplExprF :: SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF"><span class="hs-identifier hs-var hs-var">simplExprF</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682979473"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979473"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979474"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979474"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682979475"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979475"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-comment">-- See Note [Bangs in the Simplifier]</span><span>
</span><span id="line-1165"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">{- pprTrace &quot;simplExprF&quot; (vcat
      [ ppr e
      , text &quot;cont =&quot; &lt;+&gt; ppr cont
      , text &quot;inscope =&quot; &lt;+&gt; ppr (seInScope env)
      , text &quot;tvsubst =&quot; &lt;+&gt; ppr (seTvSubst env)
      , text &quot;idsubst =&quot; &lt;+&gt; ppr (seIdSubst env)
      , text &quot;cvsubst =&quot; &lt;+&gt; ppr (seCvSubst env)
      ]) $ -}</span><span>
</span><span id="line-1173"></span><span>    </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF1"><span class="hs-identifier hs-var">simplExprF1</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979473"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979474"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979475"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1174"></span><span>
</span><span id="line-1175"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF1"><span class="hs-identifier hs-type">simplExprF1</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span>
</span><span id="line-1176"></span><span>            </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-1177"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1178"></span><span>
</span><span id="line-1179"></span><span id="simplExprF1"><span class="annot"><span class="annottext">simplExprF1 :: HasDebugCallStack =&gt;
SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF1"><span class="hs-identifier hs-var hs-var">simplExprF1</span></a></span></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span id="local-6989586621682979495"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979495"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682979496"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979496"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-1180"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; SimplM (SimplFloats, CoreExpr)
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;simplExprF: type&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Kind -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979495"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;cont: &quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979496"><span class="hs-identifier hs-var">cont</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1181"></span><span>    </span><span class="hs-comment">-- simplExprF does only with term-valued expressions</span><span>
</span><span id="line-1182"></span><span>    </span><span class="hs-comment">-- The (Type ty) case is handled separately by simplExpr</span><span>
</span><span id="line-1183"></span><span>    </span><span class="hs-comment">-- and by the other callers of simplExprF</span><span>
</span><span id="line-1184"></span><span>
</span><span id="line-1185"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF1"><span class="hs-identifier hs-var">simplExprF1</span></a></span><span> </span><span id="local-6989586621682979498"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979498"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682979499"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979499"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span>        </span><span id="local-6989586621682979500"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979500"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-#SCC</span><span> </span><span class="hs-pragma">&quot;simplIdF&quot;</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplIdF"><span class="hs-identifier hs-var">simplIdF</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979498"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979499"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979500"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1186"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF1"><span class="hs-identifier hs-var">simplExprF1</span></a></span><span> </span><span id="local-6989586621682979502"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979502"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-type">Lit</span></a></span><span> </span><span id="local-6989586621682979504"><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621682979504"><span class="hs-identifier hs-var">lit</span></a></span></span><span class="hs-special">)</span><span>      </span><span id="local-6989586621682979505"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979505"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-#SCC</span><span> </span><span class="hs-pragma">&quot;rebuild&quot;</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuild"><span class="hs-identifier hs-var">rebuild</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979502"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Literal -&gt; CoreExpr
forall b. Literal -&gt; Expr b
</span><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-var">Lit</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621682979504"><span class="hs-identifier hs-var">lit</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979505"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1187"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF1"><span class="hs-identifier hs-var">simplExprF1</span></a></span><span> </span><span id="local-6989586621682979507"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979507"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621682979508"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682979508"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621682979509"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979509"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-special">)</span><span>  </span><span id="local-6989586621682979510"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979510"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-#SCC</span><span> </span><span class="hs-pragma">&quot;simplTick&quot;</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; CoreTickish
-&gt; CoreExpr
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplTick"><span class="hs-identifier hs-var">simplTick</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979507"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682979508"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979509"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979510"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1188"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF1"><span class="hs-identifier hs-var">simplExprF1</span></a></span><span> </span><span id="local-6989586621682979512"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979512"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682979513"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979513"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621682979514"><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979514"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682979515"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979515"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-#SCC</span><span> </span><span class="hs-pragma">&quot;simplCast&quot;</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; CoreExpr
-&gt; CoercionR
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplCast"><span class="hs-identifier hs-var">simplCast</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979512"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979513"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979514"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979515"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1189"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF1"><span class="hs-identifier hs-var">simplExprF1</span></a></span><span> </span><span id="local-6989586621682979517"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979517"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span id="local-6989586621682979518"><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979518"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>  </span><span id="local-6989586621682979519"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979519"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-#SCC</span><span> </span><span class="hs-pragma">&quot;simplCoercionF&quot;</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; CoercionR -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplCoercionF"><span class="hs-identifier hs-var">simplCoercionF</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979517"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979518"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979519"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1190"></span><span>
</span><span id="line-1191"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF1"><span class="hs-identifier hs-var">simplExprF1</span></a></span><span> </span><span id="local-6989586621682979521"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979521"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621682979522"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979522"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621682979523"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979523"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682979524"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979524"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-1192"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-#SCC</span><span> </span><span class="hs-pragma">&quot;simplExprF1-App&quot;</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979523"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1193"></span><span>      </span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span id="local-6989586621682979525"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979525"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- The argument type will (almost) certainly be used</span><span>
</span><span id="line-1194"></span><span>                      </span><span class="hs-comment">-- in the output program, so just force it now.</span><span>
</span><span id="line-1195"></span><span>                      </span><span class="hs-comment">-- See Note [Avoiding space leaks in OutType]</span><span>
</span><span id="line-1196"></span><span>                      </span><span id="local-6989586621682979526"><span class="annot"><a href="#local-6989586621682979526"><span class="hs-identifier hs-var">arg'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; Kind -&gt; SimplM Kind
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplType"><span class="hs-identifier hs-var">simplType</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979521"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979525"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1197"></span><span>
</span><span id="line-1198"></span><span>                      </span><span class="hs-comment">-- But use substTy, not simplType, to avoid forcing</span><span>
</span><span id="line-1199"></span><span>                      </span><span class="hs-comment">-- the hole type; it will likely not be needed.</span><span>
</span><span id="line-1200"></span><span>                      </span><span class="hs-comment">-- See Note [The hole type in ApplyToTy]</span><span>
</span><span id="line-1201"></span><span>                    </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682979527"><span class="annot"><a href="#local-6989586621682979527"><span class="hs-identifier hs-var hs-var">hole'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; SimplEnv -&gt; Kind -&gt; Kind
SimplEnv -&gt; Kind -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Env.html#substTy"><span class="hs-identifier hs-var">substTy</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979521"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; Kind
CoreExpr -&gt; Kind
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979522"><span class="hs-identifier hs-var">fun</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1202"></span><span>
</span><span id="line-1203"></span><span>                    </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF"><span class="hs-identifier hs-type">simplExprF</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979521"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979522"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-1204"></span><span>                      </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToTy"><span class="hs-identifier hs-type">ApplyToTy</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_arg_ty"><span class="hs-identifier hs-var">sc_arg_ty</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682979526"><span class="hs-identifier hs-type">arg'</span></a></span><span>
</span><span id="line-1205"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_hole_ty"><span class="hs-identifier hs-var">sc_hole_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682979527"><span class="hs-identifier hs-type">hole'</span></a></span><span>
</span><span id="line-1206"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682979524"><span class="hs-identifier hs-type">cont</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1207"></span><span>      </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span>       </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1208"></span><span>          </span><span class="hs-comment">-- Crucially, sc_hole_ty is a /lazy/ binding.  It will</span><span>
</span><span id="line-1209"></span><span>          </span><span class="hs-comment">-- be forced only if we need to run contHoleType.</span><span>
</span><span id="line-1210"></span><span>          </span><span class="hs-comment">-- When these are forced, we might get quadratic behavior;</span><span>
</span><span id="line-1211"></span><span>          </span><span class="hs-comment">-- this quadratic blowup could be avoided by drilling down</span><span>
</span><span id="line-1212"></span><span>          </span><span class="hs-comment">-- to the function and getting its multiplicities all at once</span><span>
</span><span id="line-1213"></span><span>          </span><span class="hs-comment">-- (instead of one-at-a-time). But in practice, we have not</span><span>
</span><span id="line-1214"></span><span>          </span><span class="hs-comment">-- observed the quadratic behavior, so this extra entanglement</span><span>
</span><span id="line-1215"></span><span>          </span><span class="hs-comment">-- seems not worthwhile.</span><span>
</span><span id="line-1216"></span><span>        </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979521"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979522"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">(SimplCont -&gt; SimplM (SimplFloats, CoreExpr))
-&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1217"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToVal"><span class="hs-identifier hs-type">ApplyToVal</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_arg :: CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_arg"><span class="hs-identifier hs-var">sc_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979523"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_env :: SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_env"><span class="hs-identifier hs-var">sc_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979521"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1218"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_hole_ty :: Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_hole_ty"><span class="hs-identifier hs-var">sc_hole_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; SimplEnv -&gt; Kind -&gt; Kind
SimplEnv -&gt; Kind -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Env.html#substTy"><span class="hs-identifier hs-var">substTy</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979521"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; Kind
CoreExpr -&gt; Kind
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979522"><span class="hs-identifier hs-var">fun</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1219"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_dup :: DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_dup"><span class="hs-identifier hs-var">sc_dup</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#NoDup"><span class="hs-identifier hs-var">NoDup</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979524"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1220"></span><span>
</span><span id="line-1221"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF1"><span class="hs-identifier hs-var">simplExprF1</span></a></span><span> </span><span id="local-6989586621682979537"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979537"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979538"><span class="annot"><span class="annottext">expr :: CoreExpr
</span><a href="#local-6989586621682979538"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621682979539"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979539"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-1222"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-#SCC</span><span> </span><span class="hs-pragma">&quot;simplExprF1-Lam&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1223"></span><span>    </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplLam"><span class="hs-identifier hs-var">simplLam</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979537"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; Int -&gt; CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#zapLambdaBndrs"><span class="hs-identifier hs-var">zapLambdaBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979538"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682979541"><span class="hs-identifier hs-var">n_args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979539"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1224"></span><span>        </span><span class="hs-comment">-- zapLambdaBndrs: the issue here is under-saturated lambdas</span><span>
</span><span id="line-1225"></span><span>        </span><span class="hs-comment">--   (\x1. \x2. e) arg1</span><span>
</span><span id="line-1226"></span><span>        </span><span class="hs-comment">-- Here x1 might have &quot;occurs-once&quot; occ-info, because occ-info</span><span>
</span><span id="line-1227"></span><span>        </span><span class="hs-comment">-- is computed assuming that a group of lambdas is applied</span><span>
</span><span id="line-1228"></span><span>        </span><span class="hs-comment">-- all at once.  If there are too few args, we must zap the</span><span>
</span><span id="line-1229"></span><span>        </span><span class="hs-comment">-- occ-info, UNLESS the remaining binders are one-shot</span><span>
</span><span id="line-1230"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1231"></span><span>    </span><span id="local-6989586621682979541"><span class="annot"><span class="annottext">n_args :: Int
</span><a href="#local-6989586621682979541"><span class="hs-identifier hs-var hs-var">n_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Int
</span><a href="GHC.Core.Opt.Simplify.Utils.html#countArgs"><span class="hs-identifier hs-var">countArgs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979539"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1232"></span><span>        </span><span class="hs-comment">-- NB: countArgs counts all the args (incl type args)</span><span>
</span><span id="line-1233"></span><span>        </span><span class="hs-comment">-- and likewise drop counts all binders (incl type lambdas)</span><span>
</span><span id="line-1234"></span><span>
</span><span id="line-1235"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF1"><span class="hs-identifier hs-var">simplExprF1</span></a></span><span> </span><span id="local-6989586621682979543"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979543"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span id="local-6989586621682979545"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979545"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621682979546"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979546"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="annot"><span class="annottext">Kind
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682979547"><span class="annot"><span class="annottext">[Alt CoreBndr]
</span><a href="#local-6989586621682979547"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682979548"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979548"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-1236"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-#SCC</span><span> </span><span class="hs-pragma">&quot;simplExprF1-Case&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1237"></span><span>    </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979543"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979545"><span class="hs-identifier hs-var">scrut</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#Select"><span class="hs-identifier hs-type">Select</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_dup :: DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_dup"><span class="hs-identifier hs-var">sc_dup</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#NoDup"><span class="hs-identifier hs-var">NoDup</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_bndr :: CoreBndr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_bndr"><span class="hs-identifier hs-var">sc_bndr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979546"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-1238"></span><span>                                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_alts :: [Alt CoreBndr]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_alts"><span class="hs-identifier hs-var">sc_alts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Alt CoreBndr]
</span><a href="#local-6989586621682979547"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-1239"></span><span>                                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_env :: SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_env"><span class="hs-identifier hs-var">sc_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979543"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979548"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1240"></span><span>
</span><span id="line-1241"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF1"><span class="hs-identifier hs-var">simplExprF1</span></a></span><span> </span><span id="local-6989586621682979552"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979552"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span id="local-6989586621682979554"><span class="annot"><span class="annottext">[(CoreBndr, CoreExpr)]
</span><a href="#local-6989586621682979554"><span class="hs-identifier hs-var">pairs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682979555"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979555"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682979556"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979556"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-1242"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682979557"><span class="annot"><span class="annottext">[(CoreBndr, CoreExpr)]
</span><a href="#local-6989586621682979557"><span class="hs-identifier hs-var">pairs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(CoreBndr, CoreExpr)] -&gt; Maybe [(CoreBndr, CoreExpr)]
</span><a href="GHC.Core.SimpleOpt.html#joinPointBindings_maybe"><span class="hs-identifier hs-var">joinPointBindings_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">[(CoreBndr, CoreExpr)]
</span><a href="#local-6989586621682979554"><span class="hs-identifier hs-var">pairs</span></a></span><span>
</span><span id="line-1243"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-#SCC</span><span> </span><span class="hs-pragma">&quot;simplRecJoinPoin&quot;</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; [(CoreBndr, CoreExpr)]
-&gt; CoreExpr
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplRecJoinPoint"><span class="hs-identifier hs-var">simplRecJoinPoint</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979552"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[(CoreBndr, CoreExpr)]
</span><a href="#local-6989586621682979557"><span class="hs-identifier hs-var">pairs'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979555"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979556"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1244"></span><span>
</span><span id="line-1245"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1246"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-#SCC</span><span> </span><span class="hs-pragma">&quot;simplRecE&quot;</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; [(CoreBndr, CoreExpr)]
-&gt; CoreExpr
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplRecE"><span class="hs-identifier hs-var">simplRecE</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979552"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[(CoreBndr, CoreExpr)]
</span><a href="#local-6989586621682979554"><span class="hs-identifier hs-var">pairs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979555"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979556"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1247"></span><span>
</span><span id="line-1248"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF1"><span class="hs-identifier hs-var">simplExprF1</span></a></span><span> </span><span id="local-6989586621682979560"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979560"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span id="local-6989586621682979561"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979561"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682979562"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979562"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682979563"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979563"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682979564"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979564"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-1249"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span id="local-6989586621682979565"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979565"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979562"><span class="hs-identifier hs-var">rhs</span></a></span><span>    </span><span class="hs-comment">-- First deal with type lets (let a = Type ty in e)</span><span>
</span><span id="line-1250"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-#SCC</span><span> </span><span class="hs-pragma">&quot;simplExprF1-NonRecLet-Type&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1251"></span><span>    </span><span class="annot"><span class="annottext">Bool
-&gt; SimplM (SimplFloats, CoreExpr) -&gt; SimplM (SimplFloats, CoreExpr)
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979561"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SimplM (SimplFloats, CoreExpr) -&gt; SimplM (SimplFloats, CoreExpr))
-&gt; SimplM (SimplFloats, CoreExpr) -&gt; SimplM (SimplFloats, CoreExpr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1252"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682979567"><span class="annot"><a href="#local-6989586621682979567"><span class="hs-identifier hs-var">ty'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; Kind -&gt; SimplM Kind
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplType"><span class="hs-identifier hs-var">simplType</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979560"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979565"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1253"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF"><span class="hs-identifier hs-type">simplExprF</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#extendTvSubst"><span class="hs-identifier hs-type">extendTvSubst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979560"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979561"><span class="hs-identifier hs-type">bndr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979567"><span class="hs-identifier hs-type">ty'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682979563"><span class="hs-identifier hs-type">body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979564"><span class="hs-identifier hs-type">cont</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1254"></span><span>
</span><span id="line-1255"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682979569"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979569"><span class="hs-identifier hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; TopLevelFlag
-&gt; CoreBndr
-&gt; CoreExpr
-&gt; SimplEnv
-&gt; Maybe SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Utils.html#preInlineUnconditionally"><span class="hs-identifier hs-var">preInlineUnconditionally</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979560"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="GHC.Types.Basic.html#NotTopLevel"><span class="hs-identifier hs-var">NotTopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979561"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979562"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979560"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1256"></span><span>    </span><span class="hs-comment">-- Because of the let-can-float invariant, it's ok to</span><span>
</span><span id="line-1257"></span><span>    </span><span class="hs-comment">-- inline freely, or to drop the binding if it is dead.</span><span>
</span><span id="line-1258"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Tick -&gt; SimplM ()
</span><a href="GHC.Core.Opt.Simplify.Monad.html#tick"><span class="hs-identifier hs-var">tick</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Tick
</span><a href="GHC.Core.Opt.Stats.html#PreInlineUnconditionally"><span class="hs-identifier hs-var">PreInlineUnconditionally</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979561"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1259"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979569"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979563"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979564"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1260"></span><span>
</span><span id="line-1261"></span><span>  </span><span class="hs-comment">-- Now check for a join point.  It's better to do the preInlineUnconditionally</span><span>
</span><span id="line-1262"></span><span>  </span><span class="hs-comment">-- test first, because joinPointBinding_maybe has to eta-expand, so a trivial</span><span>
</span><span id="line-1263"></span><span>  </span><span class="hs-comment">-- binding like { j = j2 |&gt; co } would first be eta-expanded and then inlined</span><span>
</span><span id="line-1264"></span><span>  </span><span class="hs-comment">-- Better to test preInlineUnconditionally first.</span><span>
</span><span id="line-1265"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979570"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979570"><span class="hs-identifier hs-var">bndr'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979571"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979571"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; CoreExpr -&gt; Maybe (CoreBndr, CoreExpr)
</span><a href="GHC.Core.SimpleOpt.html#joinPointBinding_maybe"><span class="hs-identifier hs-var">joinPointBinding_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979561"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979562"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1266"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-#SCC</span><span> </span><span class="hs-pragma">&quot;simplNonRecJoinPoint&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1267"></span><span>    </span><span class="annot"><span class="annottext">SimplEnv
-&gt; CoreBndr
-&gt; CoreExpr
-&gt; CoreExpr
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplNonRecJoinPoint"><span class="hs-identifier hs-var">simplNonRecJoinPoint</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979560"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979570"><span class="hs-identifier hs-var">bndr'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979571"><span class="hs-identifier hs-var">rhs'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979563"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979564"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1268"></span><span>
</span><span id="line-1269"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1270"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-#SCC</span><span> </span><span class="hs-pragma">&quot;simplNonRecE&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1271"></span><span>    </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
SimplEnv
-&gt; FromWhat
-&gt; CoreBndr
-&gt; (CoreExpr, SimplEnv)
-&gt; CoreExpr
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
SimplEnv
-&gt; FromWhat
-&gt; CoreBndr
-&gt; (CoreExpr, SimplEnv)
-&gt; CoreExpr
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplNonRecE"><span class="hs-identifier hs-var">simplNonRecE</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979560"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">FromWhat
</span><a href="GHC.Core.Opt.Simplify.Utils.html#FromLet"><span class="hs-identifier hs-var">FromLet</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979561"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979562"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979560"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979563"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979564"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1272"></span><span>
</span><span id="line-1273"></span><span class="hs-comment">{- Note [Avoiding space leaks in OutType]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Since the simplifier is run for multiple iterations, we need to ensure
that any thunks in the output of one simplifier iteration are forced
by the evaluation of the next simplifier iteration. Otherwise we may
retain multiple copies of the Core program and leak a terrible amount
of memory (as in #13426).

The simplifier is naturally strict in the entire &quot;Expr part&quot; of the
input Core program, because any expression may contain binders, which
we must find in order to extend the SimplEnv accordingly. But types
do not contain binders and so it is tempting to write things like

    simplExpr env (Type ty) = return (Type (substTy env ty))   -- Bad!

This is Bad because the result includes a thunk (substTy env ty) which
retains a reference to the whole simplifier environment; and the next
simplifier iteration will not force this thunk either, because the
line above is not strict in ty.

So instead our strategy is for the simplifier to fully evaluate
OutTypes when it emits them into the output Core program, for example

    simplExpr env (Type ty) = do { ty' &lt;- simplType env ty     -- Good
                                 ; return (Type ty') }

where the only difference from above is that simplType calls seqType
on the result of substTy.

However, SimplCont can also contain OutTypes and it's not necessarily
a good idea to force types on the way in to SimplCont, because they
may end up not being used and forcing them could be a lot of wasted
work. T5631 is a good example of this.

- For ApplyToTy's sc_arg_ty, we force the type on the way in because
  the type will almost certainly appear as a type argument in the
  output program.

- For the hole types in Stop and ApplyToTy, we force the type when we
  emit it into the output program, after obtaining it from
  contResultType. (The hole type in ApplyToTy is only directly used
  to form the result type in a new Stop continuation.)
-}</span><span>
</span><span id="line-1316"></span><span>
</span><span id="line-1317"></span><span class="hs-comment">---------------------------------</span><span>
</span><span id="line-1318"></span><span class="hs-comment">-- Simplify a join point, adding the context.</span><span>
</span><span id="line-1319"></span><span class="hs-comment">-- Context goes *inside* the lambdas. IOW, if the join point has arity n, we do:</span><span>
</span><span id="line-1320"></span><span class="hs-comment">--   \x1 .. xn -&gt; e =&gt; \x1 .. xn -&gt; E[e]</span><span>
</span><span id="line-1321"></span><span class="hs-comment">-- Note that we need the arity of the join point, since e may be a lambda</span><span>
</span><span id="line-1322"></span><span class="hs-comment">-- (though this is unlikely). See Note [Join points and case-of-case].</span><span>
</span><span id="line-1323"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplJoinRhs"><span class="hs-identifier hs-type">simplJoinRhs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-1324"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>
</span><span id="line-1325"></span><span id="simplJoinRhs"><span class="annot"><span class="annottext">simplJoinRhs :: SimplEnv -&gt; CoreBndr -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplJoinRhs"><span class="hs-identifier hs-var hs-var">simplJoinRhs</span></a></span></span><span> </span><span id="local-6989586621682979575"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979575"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979576"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979576"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682979577"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979577"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span id="local-6989586621682979578"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979578"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-1326"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#JoinPoint"><span class="hs-identifier hs-type">JoinPoint</span></a></span><span> </span><span id="local-6989586621682979580"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682979580"><span class="hs-identifier hs-var">arity</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; JoinPointHood
</span><a href="GHC.Types.Id.html#idJoinPointHood"><span class="hs-identifier hs-var">idJoinPointHood</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979576"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-1327"></span><span>  </span><span class="hs-glyph">=</span><span>  </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979581"><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682979581"><span class="hs-identifier hs-var hs-var">join_bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979582"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979582"><span class="hs-identifier hs-var hs-var">join_body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CoreExpr -&gt; ([CoreBndr], CoreExpr)
forall b. Int -&gt; Expr b -&gt; ([b], Expr b)
</span><a href="GHC.Core.html#collectNBinders"><span class="hs-identifier hs-var">collectNBinders</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682979580"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979577"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-1328"></span><span>              </span><span id="local-6989586621682979584"><span class="annot"><span class="annottext">mult :: Kind
</span><a href="#local-6989586621682979584"><span class="hs-identifier hs-var hs-var hs-var">mult</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleScaling"><span class="hs-identifier hs-var">contHoleScaling</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979578"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1329"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979586"><span class="annot"><a href="#local-6989586621682979586"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979587"><span class="annot"><a href="#local-6989586621682979587"><span class="hs-identifier hs-var">join_bndrs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; [CoreBndr] -&gt; SimplM (SimplEnv, [CoreBndr])
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplLamBndrs"><span class="hs-identifier hs-var">simplLamBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979575"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CoreBndr -&gt; CoreBndr) -&gt; [CoreBndr] -&gt; [CoreBndr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Kind -&gt; CoreBndr -&gt; CoreBndr
</span><a href="GHC.Types.Id.html#scaleVarBy"><span class="hs-identifier hs-var">scaleVarBy</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979584"><span class="hs-identifier hs-var">mult</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682979581"><span class="hs-identifier hs-var">join_bndrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1330"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682979590"><span class="annot"><a href="#local-6989586621682979590"><span class="hs-identifier hs-var">join_body'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprC"><span class="hs-identifier hs-type">simplExprC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979586"><span class="hs-identifier hs-type">env'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979582"><span class="hs-identifier hs-type">join_body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979578"><span class="hs-identifier hs-type">cont</span></a></span><span>
</span><span id="line-1331"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Core.html#mkLams"><span class="hs-identifier hs-type">mkLams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979587"><span class="hs-identifier hs-type">join_bndrs'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979590"><span class="hs-identifier hs-type">join_body'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1332"></span><span>
</span><span id="line-1333"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1334"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; SimplM CoreExpr
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;simplJoinRhs&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979576"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1335"></span><span>
</span><span id="line-1336"></span><span class="hs-comment">---------------------------------</span><span>
</span><span id="line-1337"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplType"><span class="hs-identifier hs-type">simplType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InType"><span class="hs-identifier hs-type">InType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#OutType"><span class="hs-identifier hs-type">OutType</span></a></span><span>
</span><span id="line-1338"></span><span>        </span><span class="hs-comment">-- Kept monadic just so we can do the seqType</span><span>
</span><span id="line-1339"></span><span>        </span><span class="hs-comment">-- See Note [Avoiding space leaks in OutType]</span><span>
</span><span id="line-1340"></span><span id="simplType"><span class="annot"><span class="annottext">simplType :: SimplEnv -&gt; Kind -&gt; SimplM Kind
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplType"><span class="hs-identifier hs-var hs-var">simplType</span></a></span></span><span> </span><span id="local-6989586621682979593"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979593"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979594"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979594"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-1341"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;simplType&quot; (ppr ty $$ ppr (seTvSubst env)) $</span><span>
</span><span id="line-1342"></span><span>    </span><span class="annot"><span class="annottext">Kind -&gt; ()
</span><a href="GHC.Core.Type.html#seqType"><span class="hs-identifier hs-var">seqType</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979596"><span class="hs-identifier hs-var">new_ty</span></a></span><span> </span><span class="annot"><span class="annottext">() -&gt; SimplM Kind -&gt; SimplM Kind
forall a b. a -&gt; b -&gt; b
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="annot"><span class="annottext">Kind -&gt; SimplM Kind
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979596"><span class="hs-identifier hs-var">new_ty</span></a></span><span>
</span><span id="line-1343"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1344"></span><span>    </span><span id="local-6989586621682979596"><span class="annot"><span class="annottext">new_ty :: Kind
</span><a href="#local-6989586621682979596"><span class="hs-identifier hs-var hs-var">new_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; SimplEnv -&gt; Kind -&gt; Kind
SimplEnv -&gt; Kind -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Env.html#substTy"><span class="hs-identifier hs-var">substTy</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979593"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979594"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1345"></span><span>
</span><span id="line-1346"></span><span class="hs-comment">---------------------------------</span><span>
</span><span id="line-1347"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplCoercionF"><span class="hs-identifier hs-type">simplCoercionF</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InCoercion"><span class="hs-identifier hs-type">InCoercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-1348"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1349"></span><span id="simplCoercionF"><span class="annot"><span class="annottext">simplCoercionF :: SimplEnv
-&gt; CoercionR -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplCoercionF"><span class="hs-identifier hs-var hs-var">simplCoercionF</span></a></span></span><span> </span><span id="local-6989586621682979598"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979598"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979599"><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979599"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span id="local-6989586621682979600"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979600"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-1350"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682979601"><span class="annot"><a href="#local-6989586621682979601"><span class="hs-identifier hs-var">co'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoercionR -&gt; SimplM CoercionR
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplCoercion"><span class="hs-identifier hs-var">simplCoercion</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979598"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979599"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1351"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuild"><span class="hs-identifier hs-type">rebuild</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979598"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979601"><span class="hs-identifier hs-type">co'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682979600"><span class="hs-identifier hs-type">cont</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1352"></span><span>
</span><span id="line-1353"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplCoercion"><span class="hs-identifier hs-type">simplCoercion</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InCoercion"><span class="hs-identifier hs-type">InCoercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#OutCoercion"><span class="hs-identifier hs-type">OutCoercion</span></a></span><span>
</span><span id="line-1354"></span><span id="simplCoercion"><span class="annot"><span class="annottext">simplCoercion :: SimplEnv -&gt; CoercionR -&gt; SimplM CoercionR
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplCoercion"><span class="hs-identifier hs-var hs-var">simplCoercion</span></a></span></span><span> </span><span id="local-6989586621682979604"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979604"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979605"><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979605"><span class="hs-identifier hs-var">co</span></a></span></span><span>
</span><span id="line-1355"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682979606"><span class="annot"><span class="annottext">opt_co :: CoercionR
</span><a href="#local-6989586621682979606"><span class="hs-identifier hs-var hs-var">opt_co</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Env.html#reSimplifying"><span class="hs-identifier hs-var">reSimplifying</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979604"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoercionR -&gt; CoercionR
</span><a href="GHC.Core.Opt.Simplify.Env.html#substCo"><span class="hs-identifier hs-var">substCo</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979604"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979605"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1356"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OptCoercionOpts -&gt; Subst -&gt; CoercionR -&gt; CoercionR
</span><a href="GHC.Core.Coercion.Opt.html#optCoercion"><span class="hs-identifier hs-var">optCoercion</span></a></span><span> </span><span class="annot"><span class="annottext">OptCoercionOpts
</span><a href="#local-6989586621682979609"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682979610"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979605"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1357"></span><span>             </span><span class="hs-comment">-- If (reSimplifying env) is True we have already simplified</span><span>
</span><span id="line-1358"></span><span>             </span><span class="hs-comment">-- this coercion once, and we don't want do so again; doing</span><span>
</span><span id="line-1359"></span><span>             </span><span class="hs-comment">-- so repeatedly risks non-linear behaviour</span><span>
</span><span id="line-1360"></span><span>             </span><span class="hs-comment">-- See Note [Inline depth] in GHC.Core.Opt.Simplify.Env</span><span>
</span><span id="line-1361"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CoercionR -&gt; ()
</span><a href="GHC.Core.Coercion.html#seqCo"><span class="hs-identifier hs-var">seqCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979606"><span class="hs-identifier hs-var">opt_co</span></a></span><span> </span><span class="annot"><span class="annottext">() -&gt; SimplM CoercionR -&gt; SimplM CoercionR
forall a b. a -&gt; b -&gt; b
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="annot"><span class="annottext">CoercionR -&gt; SimplM CoercionR
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979606"><span class="hs-identifier hs-var">opt_co</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1362"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1363"></span><span>    </span><span id="local-6989586621682979610"><span class="annot"><span class="annottext">subst :: Subst
</span><a href="#local-6989586621682979610"><span class="hs-identifier hs-var hs-var">subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; Subst
</span><a href="GHC.Core.Opt.Simplify.Env.html#getSubst"><span class="hs-identifier hs-var">getSubst</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979604"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1364"></span><span>    </span><span id="local-6989586621682979609"><span class="annot"><span class="annottext">opts :: OptCoercionOpts
</span><a href="#local-6989586621682979609"><span class="hs-identifier hs-var hs-var">opts</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; OptCoercionOpts
</span><a href="GHC.Core.Opt.Simplify.Env.html#seOptCoercionOpts"><span class="hs-identifier hs-var">seOptCoercionOpts</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979604"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1365"></span><span>
</span><span id="line-1366"></span><span class="hs-comment">-----------------------------------</span><span>
</span><span id="line-1367"></span><span class="hs-comment">-- | Push a TickIt context outwards past applications and cases, as</span><span>
</span><span id="line-1368"></span><span class="hs-comment">-- long as this is a non-scoping tick, to let case and application</span><span>
</span><span id="line-1369"></span><span class="hs-comment">-- optimisations apply.</span><span>
</span><span id="line-1370"></span><span>
</span><span id="line-1371"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplTick"><span class="hs-identifier hs-type">simplTick</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Tickish.html#CoreTickish"><span class="hs-identifier hs-type">CoreTickish</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-1372"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1373"></span><span id="simplTick"><span class="annot"><span class="annottext">simplTick :: SimplEnv
-&gt; CoreTickish
-&gt; CoreExpr
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplTick"><span class="hs-identifier hs-var hs-var">simplTick</span></a></span></span><span> </span><span id="local-6989586621682979614"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979614"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979615"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682979615"><span class="hs-identifier hs-var">tickish</span></a></span></span><span> </span><span id="local-6989586621682979616"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979616"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span id="local-6989586621682979617"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979617"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-1374"></span><span>  </span><span class="hs-comment">-- A scoped tick turns into a continuation, so that we can spot</span><span>
</span><span id="line-1375"></span><span>  </span><span class="hs-comment">-- (scc t (\x . e)) in simplLam and eliminate the scc.  If we didn't do</span><span>
</span><span id="line-1376"></span><span>  </span><span class="hs-comment">-- it this way, then it would take two passes of the simplifier to</span><span>
</span><span id="line-1377"></span><span>  </span><span class="hs-comment">-- reduce ((scc t (\x . e)) e').</span><span>
</span><span id="line-1378"></span><span>  </span><span class="hs-comment">-- NB, don't do this with counting ticks, because if the expr is</span><span>
</span><span id="line-1379"></span><span>  </span><span class="hs-comment">-- bottom, then rebuildCall will discard the continuation.</span><span>
</span><span id="line-1380"></span><span>
</span><span id="line-1381"></span><span class="hs-comment">--------------------------</span><span>
</span><span id="line-1382"></span><span class="hs-comment">--  | tickishScoped tickish &amp;&amp; not (tickishCounts tickish)</span><span>
</span><span id="line-1383"></span><span class="hs-comment">--  = simplExprF env expr (TickIt tickish cont)</span><span>
</span><span id="line-1384"></span><span class="hs-comment">-- XXX: we cannot do this, because the simplifier assumes that</span><span>
</span><span id="line-1385"></span><span class="hs-comment">-- the context can be pushed into a case with a single branch. e.g.</span><span>
</span><span id="line-1386"></span><span class="hs-comment">--    scc&lt;f&gt;  case expensive of p -&gt; e</span><span>
</span><span id="line-1387"></span><span class="hs-comment">-- becomes</span><span>
</span><span id="line-1388"></span><span class="hs-comment">--    case expensive of p -&gt; scc&lt;f&gt; e</span><span>
</span><span id="line-1389"></span><span class="hs-comment">--</span><span>
</span><span id="line-1390"></span><span class="hs-comment">-- So I'm disabling this for now.  It just means we will do more</span><span>
</span><span id="line-1391"></span><span class="hs-comment">-- simplifier iterations that necessary in some cases.</span><span>
</span><span id="line-1392"></span><span class="hs-comment">--------------------------</span><span>
</span><span id="line-1393"></span><span>
</span><span id="line-1394"></span><span>  </span><span class="hs-comment">-- For unscoped or soft-scoped ticks, we are allowed to float in new</span><span>
</span><span id="line-1395"></span><span>  </span><span class="hs-comment">-- cost, so we simply push the continuation inside the tick.  This</span><span>
</span><span id="line-1396"></span><span>  </span><span class="hs-comment">-- has the effect of moving the tick to the outside of a case or</span><span>
</span><span id="line-1397"></span><span>  </span><span class="hs-comment">-- application context, allowing the normal case and application</span><span>
</span><span id="line-1398"></span><span>  </span><span class="hs-comment">-- optimisations to fire.</span><span>
</span><span id="line-1399"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682979615"><span class="hs-identifier hs-var">tickish</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; TickishScoping -&gt; Bool
forall (pass :: TickishPass).
GenTickish pass -&gt; TickishScoping -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishScopesLike"><span class="hs-operator hs-var">`tickishScopesLike`</span></a></span><span> </span><span class="annot"><span class="annottext">TickishScoping
</span><a href="GHC.Types.Tickish.html#SoftScope"><span class="hs-identifier hs-var">SoftScope</span></a></span><span>
</span><span id="line-1400"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979620"><span class="annot"><a href="#local-6989586621682979620"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979621"><span class="annot"><a href="#local-6989586621682979621"><span class="hs-identifier hs-var">expr'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979614"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979616"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979617"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1401"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979620"><span class="hs-identifier hs-type">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#mkTick"><span class="hs-identifier hs-type">mkTick</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979615"><span class="hs-identifier hs-type">tickish</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979621"><span class="hs-identifier hs-type">expr'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1402"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-1403"></span><span>
</span><span id="line-1404"></span><span>  </span><span class="hs-comment">-- Push tick inside if the context looks like this will allow us to</span><span>
</span><span id="line-1405"></span><span>  </span><span class="hs-comment">-- do a case-of-case - see Note [case-of-scc-of-case]</span><span>
</span><span id="line-1406"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#Select"><span class="hs-identifier hs-type">Select</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979617"><span class="hs-identifier hs-var">cont</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682979622"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979622"><span class="hs-identifier hs-var">expr'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe CoreExpr
</span><a href="#local-6989586621682979623"><span class="hs-identifier hs-var">push_tick_inside</span></a></span><span>
</span><span id="line-1407"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979614"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979622"><span class="hs-identifier hs-var">expr'</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979617"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1408"></span><span>
</span><span id="line-1409"></span><span>  </span><span class="hs-comment">-- We don't want to move the tick, but we might still want to allow</span><span>
</span><span id="line-1410"></span><span>  </span><span class="hs-comment">-- floats to pass through with appropriate wrapping (or not, see</span><span>
</span><span id="line-1411"></span><span>  </span><span class="hs-comment">-- wrap_floats below)</span><span>
</span><span id="line-1412"></span><span>  </span><span class="hs-comment">--- | not (tickishCounts tickish) || tickishCanSplit tickish</span><span>
</span><span id="line-1413"></span><span>  </span><span class="hs-comment">-- = wrap_floats</span><span>
</span><span id="line-1414"></span><span>
</span><span id="line-1415"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1416"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplM (SimplFloats, CoreExpr)
</span><a href="#local-6989586621682979624"><span class="hs-identifier hs-var">no_floating_past_tick</span></a></span><span>
</span><span id="line-1417"></span><span>
</span><span id="line-1418"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1419"></span><span>
</span><span id="line-1420"></span><span>  </span><span class="hs-comment">-- Try to push tick inside a case, see Note [case-of-scc-of-case].</span><span>
</span><span id="line-1421"></span><span>  </span><span id="local-6989586621682979623"><span class="annot"><span class="annottext">push_tick_inside :: Maybe CoreExpr
</span><a href="#local-6989586621682979623"><span class="hs-identifier hs-var hs-var">push_tick_inside</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1422"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979625"><span class="hs-identifier hs-var">expr0</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1423"></span><span>      </span><span class="annot"><a href="GHC.Core.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span id="local-6989586621682979626"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979626"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621682979627"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979627"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682979628"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979628"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621682979629"><span class="annot"><span class="annottext">[Alt CoreBndr]
</span><a href="#local-6989586621682979629"><span class="hs-identifier hs-var">alts</span></a></span></span><span>
</span><span id="line-1424"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Maybe CoreExpr
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; Maybe CoreExpr) -&gt; CoreExpr -&gt; Maybe CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreBndr -&gt; Kind -&gt; [Alt CoreBndr] -&gt; CoreExpr
forall b. Expr b -&gt; b -&gt; Kind -&gt; [Alt b] -&gt; Expr b
</span><a href="GHC.Core.html#Case"><span class="hs-identifier hs-var">Case</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682979630"><span class="hs-identifier hs-var">tickScrut</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979626"><span class="hs-identifier hs-var">scrut</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979627"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979628"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Alt CoreBndr -&gt; Alt CoreBndr) -&gt; [Alt CoreBndr] -&gt; [Alt CoreBndr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Alt CoreBndr -&gt; Alt CoreBndr
</span><a href="#local-6989586621682979631"><span class="hs-identifier hs-var">tickAlt</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt CoreBndr]
</span><a href="#local-6989586621682979629"><span class="hs-identifier hs-var">alts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1425"></span><span>      </span><span id="local-6989586621682979632"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979632"><span class="hs-identifier hs-var">_other</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe CoreExpr
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1426"></span><span>   </span><span class="hs-keyword">where</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979633"><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682979633"><span class="hs-identifier hs-var">ticks</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979625"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979625"><span class="hs-identifier hs-var">expr0</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreTickish -&gt; Bool) -&gt; CoreExpr -&gt; ([CoreTickish], CoreExpr)
forall b.
(CoreTickish -&gt; Bool) -&gt; Expr b -&gt; ([CoreTickish], Expr b)
</span><a href="GHC.Core.Utils.html#stripTicksTop"><span class="hs-identifier hs-var">stripTicksTop</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="#local-6989586621682979635"><span class="hs-identifier hs-var">movable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; CoreExpr -&gt; CoreExpr
forall b. CoreTickish -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-var">Tick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682979615"><span class="hs-identifier hs-var">tickish</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979616"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1427"></span><span>         </span><span id="local-6989586621682979635"><span class="annot"><span class="annottext">movable :: GenTickish pass -&gt; Bool
</span><a href="#local-6989586621682979635"><span class="hs-identifier hs-var hs-var">movable</span></a></span></span><span> </span><span id="local-6989586621682979636"><span class="annot"><span class="annottext">GenTickish pass
</span><a href="#local-6989586621682979636"><span class="hs-identifier hs-var">t</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GenTickish pass -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishCounts"><span class="hs-identifier hs-var">tickishCounts</span></a></span><span> </span><span class="annot"><span class="annottext">GenTickish pass
</span><a href="#local-6989586621682979636"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span>
</span><span id="line-1428"></span><span>                          </span><span class="annot"><span class="annottext">GenTickish pass
</span><a href="#local-6989586621682979636"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">GenTickish pass -&gt; TickishScoping -&gt; Bool
forall (pass :: TickishPass).
GenTickish pass -&gt; TickishScoping -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishScopesLike"><span class="hs-operator hs-var">`tickishScopesLike`</span></a></span><span> </span><span class="annot"><span class="annottext">TickishScoping
</span><a href="GHC.Types.Tickish.html#NoScope"><span class="hs-identifier hs-var">NoScope</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span>
</span><span id="line-1429"></span><span>                          </span><span class="annot"><span class="annottext">GenTickish pass -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishCanSplit"><span class="hs-identifier hs-var">tickishCanSplit</span></a></span><span> </span><span class="annot"><span class="annottext">GenTickish pass
</span><a href="#local-6989586621682979636"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-1430"></span><span>         </span><span id="local-6989586621682979630"><span class="annot"><span class="annottext">tickScrut :: CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682979630"><span class="hs-identifier hs-var hs-var">tickScrut</span></a></span></span><span> </span><span id="local-6989586621682979637"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979637"><span class="hs-identifier hs-var">e</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreTickish -&gt; CoreExpr -&gt; CoreExpr)
-&gt; CoreExpr -&gt; [CoreTickish] -&gt; CoreExpr
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979637"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682979633"><span class="hs-identifier hs-var">ticks</span></a></span><span>
</span><span id="line-1431"></span><span>         </span><span class="hs-comment">-- Alternatives get annotated with all ticks that scope in some way,</span><span>
</span><span id="line-1432"></span><span>         </span><span class="hs-comment">-- but we don't want to count entries.</span><span>
</span><span id="line-1433"></span><span>         </span><span id="local-6989586621682979631"><span class="annot"><span class="annottext">tickAlt :: Alt CoreBndr -&gt; Alt CoreBndr
</span><a href="#local-6989586621682979631"><span class="hs-identifier hs-var hs-var">tickAlt</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span id="local-6989586621682979640"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682979640"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621682979641"><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682979641"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621682979642"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979642"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AltCon -&gt; [CoreBndr] -&gt; CoreExpr -&gt; Alt CoreBndr
forall b. AltCon -&gt; [b] -&gt; Expr b -&gt; Alt b
</span><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-var">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682979640"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682979641"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CoreTickish -&gt; CoreExpr -&gt; CoreExpr)
-&gt; CoreExpr -&gt; [CoreTickish] -&gt; CoreExpr
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979642"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682979643"><span class="hs-identifier hs-var">ts_scope</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1434"></span><span>         </span><span id="local-6989586621682979643"><span class="annot"><span class="annottext">ts_scope :: [CoreTickish]
</span><a href="#local-6989586621682979643"><span class="hs-identifier hs-var hs-var">ts_scope</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreTickish -&gt; CoreTickish) -&gt; [CoreTickish] -&gt; [CoreTickish]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; CoreTickish
forall (pass :: TickishPass). GenTickish pass -&gt; GenTickish pass
</span><a href="GHC.Types.Tickish.html#mkNoCount"><span class="hs-identifier hs-var">mkNoCount</span></a></span><span> </span><span class="annot"><span class="annottext">([CoreTickish] -&gt; [CoreTickish]) -&gt; [CoreTickish] -&gt; [CoreTickish]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1435"></span><span>                            </span><span class="annot"><span class="annottext">(CoreTickish -&gt; Bool) -&gt; [CoreTickish] -&gt; [CoreTickish]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; (CoreTickish -&gt; Bool) -&gt; CoreTickish -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; TickishScoping -&gt; Bool
forall (pass :: TickishPass).
GenTickish pass -&gt; TickishScoping -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishScopesLike"><span class="hs-operator hs-var">`tickishScopesLike`</span></a></span><span> </span><span class="annot"><span class="annottext">TickishScoping
</span><a href="GHC.Types.Tickish.html#NoScope"><span class="hs-identifier hs-var">NoScope</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682979633"><span class="hs-identifier hs-var">ticks</span></a></span><span>
</span><span id="line-1436"></span><span>
</span><span id="line-1437"></span><span>  </span><span id="local-6989586621682979624"><span class="annot"><span class="annottext">no_floating_past_tick :: SimplM (SimplFloats, CoreExpr)
</span><a href="#local-6989586621682979624"><span class="hs-identifier hs-var hs-var">no_floating_past_tick</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1438"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979645"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979645"><span class="hs-identifier hs-var hs-var">inc</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682979646"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979646"><span class="hs-identifier hs-var hs-var">outc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; (SimplCont, SimplCont)
</span><a href="#local-6989586621682979647"><span class="hs-identifier hs-var">splitCont</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979617"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1439"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979648"><span class="annot"><a href="#local-6989586621682979648"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979649"><span class="annot"><a href="#local-6989586621682979649"><span class="hs-identifier hs-var">expr1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979614"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979616"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979645"><span class="hs-identifier hs-var">inc</span></a></span><span>
</span><span id="line-1440"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682979650"><span class="annot"><a href="#local-6989586621682979650"><span class="hs-identifier hs-var hs-var">expr2</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplFloats -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Env.html#wrapFloats"><span class="hs-identifier hs-var">wrapFloats</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682979648"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979649"><span class="hs-identifier hs-var">expr1</span></a></span><span>
</span><span id="line-1441"></span><span>             </span><span id="local-6989586621682979651"><span class="annot"><a href="#local-6989586621682979651"><span class="hs-identifier hs-var hs-var">tickish'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreTickish -&gt; CoreTickish
forall {pass :: TickishPass}.
(XTickishId pass ~ CoreBndr) =&gt;
SimplEnv -&gt; GenTickish pass -&gt; GenTickish pass
</span><a href="#local-6989586621682979652"><span class="hs-identifier hs-var">simplTickish</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979614"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682979615"><span class="hs-identifier hs-var">tickish</span></a></span><span>
</span><span id="line-1442"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuild"><span class="hs-identifier hs-type">rebuild</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979614"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Utils.html#mkTick"><span class="hs-identifier hs-type">mkTick</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979651"><span class="hs-identifier hs-type">tickish'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979650"><span class="hs-identifier hs-type">expr2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682979646"><span class="hs-identifier hs-type">outc</span></a></span><span>
</span><span id="line-1443"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-1444"></span><span>
</span><span id="line-1445"></span><span class="hs-comment">-- Alternative version that wraps outgoing floats with the tick.  This</span><span>
</span><span id="line-1446"></span><span class="hs-comment">-- results in ticks being duplicated, as we don't make any attempt to</span><span>
</span><span id="line-1447"></span><span class="hs-comment">-- eliminate the tick if we re-inline the binding (because the tick</span><span>
</span><span id="line-1448"></span><span class="hs-comment">-- semantics allows unrestricted inlining of HNFs), so I'm not doing</span><span>
</span><span id="line-1449"></span><span class="hs-comment">-- this any more.  FloatOut will catch any real opportunities for</span><span>
</span><span id="line-1450"></span><span class="hs-comment">-- floating.</span><span>
</span><span id="line-1451"></span><span class="hs-comment">--</span><span>
</span><span id="line-1452"></span><span class="hs-comment">--  wrap_floats =</span><span>
</span><span id="line-1453"></span><span class="hs-comment">--    do { let (inc,outc) = splitCont cont</span><span>
</span><span id="line-1454"></span><span class="hs-comment">--       ; (env', expr') &lt;- simplExprF (zapFloats env) expr inc</span><span>
</span><span id="line-1455"></span><span class="hs-comment">--       ; let tickish' = simplTickish env tickish</span><span>
</span><span id="line-1456"></span><span class="hs-comment">--       ; let wrap_float (b,rhs) = (zapIdDmdSig (setIdArity b 0),</span><span>
</span><span id="line-1457"></span><span class="hs-comment">--                                   mkTick (mkNoCount tickish') rhs)</span><span>
</span><span id="line-1458"></span><span class="hs-comment">--              -- when wrapping a float with mkTick, we better zap the Id's</span><span>
</span><span id="line-1459"></span><span class="hs-comment">--              -- strictness info and arity, because it might be wrong now.</span><span>
</span><span id="line-1460"></span><span class="hs-comment">--       ; let env'' = addFloats env (mapFloats env' wrap_float)</span><span>
</span><span id="line-1461"></span><span class="hs-comment">--       ; rebuild env'' expr' (TickIt tickish' outc)</span><span>
</span><span id="line-1462"></span><span class="hs-comment">--       }</span><span>
</span><span id="line-1463"></span><span>
</span><span id="line-1464"></span><span>
</span><span id="line-1465"></span><span>  </span><span id="local-6989586621682979652"><span class="annot"><span class="annottext">simplTickish :: SimplEnv -&gt; GenTickish pass -&gt; GenTickish pass
</span><a href="#local-6989586621682979652"><span class="hs-identifier hs-var hs-var">simplTickish</span></a></span></span><span> </span><span id="local-6989586621682979655"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979655"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979656"><span class="annot"><span class="annottext">GenTickish pass
</span><a href="#local-6989586621682979656"><span class="hs-identifier hs-var">tickish</span></a></span></span><span>
</span><span id="line-1466"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Types.Tickish.html#Breakpoint"><span class="hs-identifier hs-type">Breakpoint</span></a></span><span> </span><span id="local-6989586621682979658"><span class="annot"><span class="annottext">XBreakpoint pass
</span><a href="#local-6989586621682979658"><span class="hs-identifier hs-var">ext</span></a></span></span><span> </span><span id="local-6989586621682979659"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682979659"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621682979660"><span class="annot"><span class="annottext">[XTickishId pass]
</span><a href="#local-6989586621682979660"><span class="hs-identifier hs-var">ids</span></a></span></span><span> </span><span id="local-6989586621682979661"><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682979661"><span class="hs-identifier hs-var">modl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">GenTickish pass
</span><a href="#local-6989586621682979656"><span class="hs-identifier hs-var">tickish</span></a></span><span>
</span><span id="line-1467"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">XBreakpoint pass
-&gt; Int -&gt; [XTickishId pass] -&gt; Module -&gt; GenTickish pass
forall (pass :: TickishPass).
XBreakpoint pass
-&gt; Int -&gt; [XTickishId pass] -&gt; Module -&gt; GenTickish pass
</span><a href="GHC.Types.Tickish.html#Breakpoint"><span class="hs-identifier hs-var">Breakpoint</span></a></span><span> </span><span class="annot"><span class="annottext">XBreakpoint pass
</span><a href="#local-6989586621682979658"><span class="hs-identifier hs-var">ext</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682979659"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CoreBndr -&gt; Maybe CoreBndr) -&gt; [CoreBndr] -&gt; [CoreBndr]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplSR -&gt; Maybe CoreBndr
</span><a href="#local-6989586621682979662"><span class="hs-identifier hs-var">getDoneId</span></a></span><span> </span><span class="annot"><span class="annottext">(SimplSR -&gt; Maybe CoreBndr)
-&gt; (CoreBndr -&gt; SimplSR) -&gt; CoreBndr -&gt; Maybe CoreBndr
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; SimplSR
</span><a href="GHC.Core.Opt.Simplify.Env.html#substId"><span class="hs-identifier hs-var">substId</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979655"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
[XTickishId pass]
</span><a href="#local-6989586621682979660"><span class="hs-identifier hs-var">ids</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682979661"><span class="hs-identifier hs-var">modl</span></a></span><span>
</span><span id="line-1468"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GenTickish pass
</span><a href="#local-6989586621682979656"><span class="hs-identifier hs-var">tickish</span></a></span><span>
</span><span id="line-1469"></span><span>
</span><span id="line-1470"></span><span>  </span><span class="hs-comment">-- Push type application and coercion inside a tick</span><span>
</span><span id="line-1471"></span><span>  </span><span class="annot"><a href="#local-6989586621682979647"><span class="hs-identifier hs-type">splitCont</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1472"></span><span>  </span><span id="local-6989586621682979647"><span class="annot"><span class="annottext">splitCont :: SimplCont -&gt; (SimplCont, SimplCont)
</span><a href="#local-6989586621682979647"><span class="hs-identifier hs-var hs-var">splitCont</span></a></span></span><span> </span><span id="local-6989586621682979664"><span class="annot"><span class="annottext">cont :: SimplCont
</span><a href="#local-6989586621682979664"><span class="hs-identifier hs-var">cont</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToTy"><span class="hs-identifier hs-type">ApplyToTy</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979665"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979665"><span class="hs-identifier hs-var">tail</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979664"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682979666"><span class="hs-identifier hs-type">inc</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979667"><span class="hs-identifier hs-var">outc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1473"></span><span>    </span><span class="hs-keyword">where</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979666"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979666"><span class="hs-identifier hs-var">inc</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682979667"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979667"><span class="hs-identifier hs-var">outc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; (SimplCont, SimplCont)
</span><a href="#local-6989586621682979647"><span class="hs-identifier hs-var">splitCont</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979665"><span class="hs-identifier hs-var">tail</span></a></span><span>
</span><span id="line-1474"></span><span>  </span><span class="annot"><a href="#local-6989586621682979647"><span class="hs-identifier hs-var">splitCont</span></a></span><span> </span><span id="local-6989586621682979668"><span class="annot"><span class="annottext">cont :: SimplCont
</span><a href="#local-6989586621682979668"><span class="hs-identifier hs-var">cont</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#CastIt"><span class="hs-identifier hs-type">CastIt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979670"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979670"><span class="hs-identifier hs-var">tail</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979668"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682979671"><span class="hs-identifier hs-type">inc</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979672"><span class="hs-identifier hs-var">outc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1475"></span><span>    </span><span class="hs-keyword">where</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979671"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979671"><span class="hs-identifier hs-var">inc</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682979672"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979672"><span class="hs-identifier hs-var">outc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; (SimplCont, SimplCont)
</span><a href="#local-6989586621682979647"><span class="hs-identifier hs-var">splitCont</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979670"><span class="hs-identifier hs-var">tail</span></a></span><span>
</span><span id="line-1476"></span><span>  </span><span class="annot"><a href="#local-6989586621682979647"><span class="hs-identifier hs-var">splitCont</span></a></span><span> </span><span id="local-6989586621682979673"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979673"><span class="hs-identifier hs-var">other</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Kind -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#mkBoringStop"><span class="hs-identifier hs-var">mkBoringStop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplCont -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleType"><span class="hs-identifier hs-var">contHoleType</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979673"><span class="hs-identifier hs-var">other</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979673"><span class="hs-identifier hs-var">other</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1477"></span><span>
</span><span id="line-1478"></span><span>  </span><span id="local-6989586621682979662"><span class="annot"><span class="annottext">getDoneId :: SimplSR -&gt; Maybe CoreBndr
</span><a href="#local-6989586621682979662"><span class="hs-identifier hs-var hs-var">getDoneId</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#DoneId"><span class="hs-identifier hs-type">DoneId</span></a></span><span> </span><span id="local-6989586621682979680"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979680"><span class="hs-identifier hs-var">id</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Maybe CoreBndr
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979680"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-1479"></span><span>  </span><span class="annot"><a href="#local-6989586621682979662"><span class="hs-identifier hs-var">getDoneId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#DoneEx"><span class="hs-identifier hs-type">DoneEx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682979681"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979681"><span class="hs-identifier hs-var">id</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">JoinPointHood
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Maybe CoreBndr
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979681"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-1480"></span><span>  </span><span class="annot"><a href="#local-6989586621682979662"><span class="hs-identifier hs-var">getDoneId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#DoneEx"><span class="hs-identifier hs-type">DoneEx</span></a></span><span> </span><span id="local-6989586621682979682"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979682"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">JoinPointHood
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Maybe CoreBndr
</span><a href="GHC.Core.Utils.html#getIdFromTrivialExpr_maybe"><span class="hs-identifier hs-var">getIdFromTrivialExpr_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979682"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-comment">-- Note [substTickish] in GHC.Core.Subst</span><span>
</span><span id="line-1481"></span><span>  </span><span class="annot"><a href="#local-6989586621682979662"><span class="hs-identifier hs-var">getDoneId</span></a></span><span> </span><span id="local-6989586621682979684"><span class="annot"><span class="annottext">SimplSR
</span><a href="#local-6989586621682979684"><span class="hs-identifier hs-var">other</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; Maybe CoreBndr
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;getDoneId&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplSR -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">SimplSR
</span><a href="#local-6989586621682979684"><span class="hs-identifier hs-var">other</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1482"></span><span>
</span><span id="line-1483"></span><span class="hs-comment">-- Note [case-of-scc-of-case]</span><span>
</span><span id="line-1484"></span><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><span id="line-1485"></span><span class="hs-comment">-- It's pretty important to be able to transform case-of-case when</span><span>
</span><span id="line-1486"></span><span class="hs-comment">-- there's an SCC in the way.  For example, the following comes up</span><span>
</span><span id="line-1487"></span><span class="hs-comment">-- in nofib/real/compress/Encode.hs:</span><span>
</span><span id="line-1488"></span><span class="hs-comment">--</span><span>
</span><span id="line-1489"></span><span class="hs-comment">--        case scctick&lt;code_string.r1&gt;</span><span>
</span><span id="line-1490"></span><span class="hs-comment">--             case $wcode_string_r13s wild_XC w1_s137 w2_s138 l_aje</span><span>
</span><span id="line-1491"></span><span class="hs-comment">--             of _ { (# ww1_s13f, ww2_s13g, ww3_s13h #) -&gt;</span><span>
</span><span id="line-1492"></span><span class="hs-comment">--             (ww1_s13f, ww2_s13g, ww3_s13h)</span><span>
</span><span id="line-1493"></span><span class="hs-comment">--             }</span><span>
</span><span id="line-1494"></span><span class="hs-comment">--        of _ { (ww_s12Y, ww1_s12Z, ww2_s130) -&gt;</span><span>
</span><span id="line-1495"></span><span class="hs-comment">--        tick&lt;code_string.f1&gt;</span><span>
</span><span id="line-1496"></span><span class="hs-comment">--        (ww_s12Y,</span><span>
</span><span id="line-1497"></span><span class="hs-comment">--         ww1_s12Z,</span><span>
</span><span id="line-1498"></span><span class="hs-comment">--         PTTrees.PT</span><span>
</span><span id="line-1499"></span><span class="hs-comment">--           @ GHC.Types.Char @ GHC.Types.Int wild2_Xj ww2_s130 r_ajf)</span><span>
</span><span id="line-1500"></span><span class="hs-comment">--        }</span><span>
</span><span id="line-1501"></span><span class="hs-comment">--</span><span>
</span><span id="line-1502"></span><span class="hs-comment">-- We really want this case-of-case to fire, because then the 3-tuple</span><span>
</span><span id="line-1503"></span><span class="hs-comment">-- will go away (indeed, the CPR optimisation is relying on this</span><span>
</span><span id="line-1504"></span><span class="hs-comment">-- happening).  But the scctick is in the way - we need to push it</span><span>
</span><span id="line-1505"></span><span class="hs-comment">-- inside to expose the case-of-case.  So we perform this</span><span>
</span><span id="line-1506"></span><span class="hs-comment">-- transformation on the inner case:</span><span>
</span><span id="line-1507"></span><span class="hs-comment">--</span><span>
</span><span id="line-1508"></span><span class="hs-comment">--   scctick c (case e of { p1 -&gt; e1; ...; pn -&gt; en })</span><span>
</span><span id="line-1509"></span><span class="hs-comment">--    ==&gt;</span><span>
</span><span id="line-1510"></span><span class="hs-comment">--   case (scctick c e) of { p1 -&gt; scc c e1; ...; pn -&gt; scc c en }</span><span>
</span><span id="line-1511"></span><span class="hs-comment">--</span><span>
</span><span id="line-1512"></span><span class="hs-comment">-- So we've moved a constant amount of work out of the scc to expose</span><span>
</span><span id="line-1513"></span><span class="hs-comment">-- the case.  We only do this when the continuation is interesting: in</span><span>
</span><span id="line-1514"></span><span class="hs-comment">-- for now, it has to be another Case (maybe generalise this later).</span><span>
</span><span id="line-1515"></span><span>
</span><span id="line-1516"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{The main rebuilder}
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-1523"></span><span>
</span><span id="line-1524"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuild"><span class="hs-identifier hs-type">rebuild</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1525"></span><span class="hs-comment">-- At this point the substitution in the SimplEnv should be irrelevant;</span><span>
</span><span id="line-1526"></span><span class="hs-comment">-- only the in-scope set matters</span><span>
</span><span id="line-1527"></span><span id="rebuild"><span class="annot"><span class="annottext">rebuild :: SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuild"><span class="hs-identifier hs-var hs-var">rebuild</span></a></span></span><span> </span><span id="local-6989586621682979685"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979685"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979686"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979686"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span id="local-6989586621682979687"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979687"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-1528"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979687"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1529"></span><span>      </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#Stop"><span class="hs-identifier hs-type">Stop</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(SimplFloats, CoreExpr) -&gt; SimplM (SimplFloats, CoreExpr)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979685"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979686"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1530"></span><span>      </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#TickIt"><span class="hs-identifier hs-type">TickIt</span></a></span><span> </span><span id="local-6989586621682979690"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682979690"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621682979691"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979691"><span class="hs-identifier hs-var">cont</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuild"><span class="hs-identifier hs-var">rebuild</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979685"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682979690"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979686"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979691"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1531"></span><span>      </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#CastIt"><span class="hs-identifier hs-type">CastIt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_co :: SimplCont -&gt; CoercionR
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_co"><span class="hs-identifier hs-var">sc_co</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979693"><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979693"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_opt :: SimplCont -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_opt"><span class="hs-identifier hs-var">sc_opt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979695"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682979695"><span class="hs-identifier hs-var">opt</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979696"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979696"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1532"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuild"><span class="hs-identifier hs-var">rebuild</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979685"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; CoercionR -&gt; CoreExpr
CoreExpr -&gt; CoercionR -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkCast"><span class="hs-identifier hs-var">mkCast</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979686"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979697"><span class="hs-identifier hs-var">co'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979696"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1533"></span><span>           </span><span class="hs-comment">-- NB: mkCast implements the (Coercion co |&gt; g) optimisation</span><span>
</span><span id="line-1534"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-1535"></span><span>          </span><span id="local-6989586621682979697"><span class="annot"><span class="annottext">co' :: CoercionR
</span><a href="#local-6989586621682979697"><span class="hs-identifier hs-var hs-var">co'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoercionR -&gt; Bool -&gt; CoercionR
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#optOutCoercion"><span class="hs-identifier hs-var">optOutCoercion</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979685"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979693"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682979695"><span class="hs-identifier hs-var">opt</span></a></span><span>
</span><span id="line-1536"></span><span>
</span><span id="line-1537"></span><span>      </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#Select"><span class="hs-identifier hs-type">Select</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_bndr :: SimplCont -&gt; CoreBndr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_bndr"><span class="hs-identifier hs-var">sc_bndr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979699"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979699"><span class="hs-identifier hs-var">bndr</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_alts :: SimplCont -&gt; [Alt CoreBndr]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_alts"><span class="hs-identifier hs-var">sc_alts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979700"><span class="annot"><span class="annottext">[Alt CoreBndr]
</span><a href="#local-6989586621682979700"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_env :: SimplCont -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_env"><span class="hs-identifier hs-var">sc_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979701"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979701"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979702"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979702"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1538"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; CoreExpr
-&gt; CoreBndr
-&gt; [Alt CoreBndr]
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuildCase"><span class="hs-identifier hs-var">rebuildCase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979701"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplEnv -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#setInScopeFromE"><span class="hs-operator hs-var">`setInScopeFromE`</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979685"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979686"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979699"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt CoreBndr]
</span><a href="#local-6989586621682979700"><span class="hs-identifier hs-var">alts</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979702"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1539"></span><span>
</span><span id="line-1540"></span><span>      </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StrictArg"><span class="hs-identifier hs-type">StrictArg</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_fun :: SimplCont -&gt; ArgInfo
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_fun"><span class="hs-identifier hs-var">sc_fun</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979706"><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682979706"><span class="hs-identifier hs-var">fun</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979707"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979707"><span class="hs-identifier hs-var">cont</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_fun_ty :: SimplCont -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_fun_ty"><span class="hs-identifier hs-var">sc_fun_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979709"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979709"><span class="hs-identifier hs-var">fun_ty</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1541"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; ArgInfo -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuildCall"><span class="hs-identifier hs-var">rebuildCall</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979685"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArgInfo -&gt; CoreExpr -&gt; Kind -&gt; ArgInfo
</span><a href="GHC.Core.Opt.Simplify.Utils.html#addValArgTo"><span class="hs-identifier hs-var">addValArgTo</span></a></span><span> </span><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682979706"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979686"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979709"><span class="hs-identifier hs-var">fun_ty</span></a></span><span> </span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979707"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1542"></span><span>
</span><span id="line-1543"></span><span>      </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StrictBind"><span class="hs-identifier hs-type">StrictBind</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_bndr :: SimplCont -&gt; CoreBndr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_bndr"><span class="hs-identifier hs-var">sc_bndr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979713"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979713"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_body :: SimplCont -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_body"><span class="hs-identifier hs-var">sc_body</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979715"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979715"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_env :: SimplCont -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_env"><span class="hs-identifier hs-var">sc_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979716"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979716"><span class="hs-identifier hs-var">se</span></a></span></span><span>
</span><span id="line-1544"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979717"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979717"><span class="hs-identifier hs-var">cont</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_from :: SimplCont -&gt; FromWhat
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_from"><span class="hs-identifier hs-var">sc_from</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979719"><span class="annot"><span class="annottext">FromWhat
</span><a href="#local-6989586621682979719"><span class="hs-identifier hs-var">from_what</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1545"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; FromWhat
-&gt; CoreBndr
-&gt; CoreExpr
-&gt; CoreExpr
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#completeBindX"><span class="hs-identifier hs-var">completeBindX</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979716"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplEnv -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#setInScopeFromE"><span class="hs-operator hs-var">`setInScopeFromE`</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979685"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">FromWhat
</span><a href="#local-6989586621682979719"><span class="hs-identifier hs-var">from_what</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979713"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979686"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979715"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979717"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1546"></span><span>
</span><span id="line-1547"></span><span>      </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToTy"><span class="hs-identifier hs-type">ApplyToTy</span></a></span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_arg_ty :: SimplCont -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_arg_ty"><span class="hs-identifier hs-var">sc_arg_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979721"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979721"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979722"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979722"><span class="hs-identifier hs-var">cont</span></a></span></span><span class="hs-special">}</span><span>
</span><span id="line-1548"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuild"><span class="hs-identifier hs-var">rebuild</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979685"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr -&gt; CoreExpr
forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-identifier hs-var">App</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979686"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Kind -&gt; CoreExpr
forall b. Kind -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979721"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979722"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1549"></span><span>
</span><span id="line-1550"></span><span>      </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToVal"><span class="hs-identifier hs-type">ApplyToVal</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_arg :: SimplCont -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_arg"><span class="hs-identifier hs-var">sc_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979723"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979723"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_env :: SimplCont -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_env"><span class="hs-identifier hs-var">sc_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979724"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979724"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_dup :: SimplCont -&gt; DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_dup"><span class="hs-identifier hs-var">sc_dup</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979725"><span class="annot"><span class="annottext">DupFlag
</span><a href="#local-6989586621682979725"><span class="hs-identifier hs-var">dup_flag</span></a></span></span><span>
</span><span id="line-1551"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979726"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979726"><span class="hs-identifier hs-var">cont</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_hole_ty :: SimplCont -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_hole_ty"><span class="hs-identifier hs-var">sc_hole_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979727"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979727"><span class="hs-identifier hs-var">fun_ty</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1552"></span><span>        </span><span class="hs-comment">-- See Note [Avoid redundant simplification]</span><span>
</span><span id="line-1553"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979728"><span class="annot"><a href="#local-6989586621682979728"><span class="hs-identifier hs-var">arg'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; DupFlag
-&gt; Kind
-&gt; Maybe ArgInfo
-&gt; SimplEnv
-&gt; CoreExpr
-&gt; SimplM (DupFlag, SimplEnv, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplLazyArg"><span class="hs-identifier hs-var">simplLazyArg</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979685"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">DupFlag
</span><a href="#local-6989586621682979725"><span class="hs-identifier hs-var">dup_flag</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979727"><span class="hs-identifier hs-var">fun_ty</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ArgInfo
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979724"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979723"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-1554"></span><span>              </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuild"><span class="hs-identifier hs-type">rebuild</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979685"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979686"><span class="hs-identifier hs-type">expr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979728"><span class="hs-identifier hs-type">arg'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682979726"><span class="hs-identifier hs-type">cont</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1555"></span><span>
</span><span id="line-1556"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#completeBindX"><span class="hs-identifier hs-type">completeBindX</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span>
</span><span id="line-1557"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#FromWhat"><span class="hs-identifier hs-type">FromWhat</span></a></span><span>
</span><span id="line-1558"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>   </span><span class="hs-comment">-- Non-recursively bind this Id to this (simplified) expression</span><span>
</span><span id="line-1559"></span><span>                                   </span><span class="hs-comment">-- (the let-can-float invariant may not be satisfied)</span><span>
</span><span id="line-1560"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span>            </span><span class="hs-comment">-- In this body</span><span>
</span><span id="line-1561"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>         </span><span class="hs-comment">-- Consumed by this continuation</span><span>
</span><span id="line-1562"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1563"></span><span id="completeBindX"><span class="annot"><span class="annottext">completeBindX :: SimplEnv
-&gt; FromWhat
-&gt; CoreBndr
-&gt; CoreExpr
-&gt; CoreExpr
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#completeBindX"><span class="hs-identifier hs-var hs-var">completeBindX</span></a></span></span><span> </span><span id="local-6989586621682979730"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979730"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979731"><span class="annot"><span class="annottext">FromWhat
</span><a href="#local-6989586621682979731"><span class="hs-identifier hs-var">from_what</span></a></span></span><span> </span><span id="local-6989586621682979732"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979732"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682979733"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979733"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span id="local-6989586621682979734"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979734"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621682979735"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979735"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-1564"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#FromBeta"><span class="hs-identifier hs-type">FromBeta</span></a></span><span> </span><span id="local-6989586621682979737"><span class="annot"><span class="annottext">Levity
</span><a href="#local-6989586621682979737"><span class="hs-identifier hs-var">arg_levity</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FromWhat
</span><a href="#local-6989586621682979731"><span class="hs-identifier hs-var">from_what</span></a></span><span>
</span><span id="line-1565"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Levity -&gt; CoreExpr -&gt; Bool
</span><a href="GHC.Core.Utils.html#needsCaseBindingL"><span class="hs-identifier hs-var">needsCaseBindingL</span></a></span><span> </span><span class="annot"><span class="annottext">Levity
</span><a href="#local-6989586621682979737"><span class="hs-identifier hs-var">arg_levity</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979733"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="hs-comment">-- Enforcing the let-can-float-invariant</span><span>
</span><span id="line-1566"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979739"><span class="annot"><a href="#local-6989586621682979739"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979740"><span class="annot"><a href="#local-6989586621682979740"><span class="hs-identifier hs-var">bndr1</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; SimplM (SimplEnv, CoreBndr)
</span><a href="GHC.Core.Opt.Simplify.Env.html#simplNonRecBndr"><span class="hs-identifier hs-var">simplNonRecBndr</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979730"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979732"><span class="hs-identifier hs-var">bndr</span></a></span><span>  </span><span class="hs-comment">-- Lambda binders don't have rules</span><span>
</span><span id="line-1567"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979742"><span class="annot"><a href="#local-6989586621682979742"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979743"><span class="annot"><a href="#local-6989586621682979743"><span class="hs-identifier hs-var">expr'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplNonRecBody"><span class="hs-identifier hs-type">simplNonRecBody</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979739"><span class="hs-identifier hs-type">env1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979731"><span class="hs-identifier hs-type">from_what</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979734"><span class="hs-identifier hs-type">body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979735"><span class="hs-identifier hs-type">cont</span></a></span><span>
</span><span id="line-1568"></span><span>       </span><span class="hs-comment">-- Do not float floats past the Case binder below</span><span>
</span><span id="line-1569"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682979745"><span class="annot"><a href="#local-6989586621682979745"><span class="hs-identifier hs-var hs-var">expr''</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplFloats -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Env.html#wrapFloats"><span class="hs-identifier hs-var">wrapFloats</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682979742"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979743"><span class="hs-identifier hs-var">expr'</span></a></span><span>
</span><span id="line-1570"></span><span>             </span><span id="local-6989586621682979746"><span class="annot"><a href="#local-6989586621682979746"><span class="hs-identifier hs-var hs-var">case_expr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreBndr -&gt; Kind -&gt; [Alt CoreBndr] -&gt; CoreExpr
forall b. Expr b -&gt; b -&gt; Kind -&gt; [Alt b] -&gt; Expr b
</span><a href="GHC.Core.html#Case"><span class="hs-identifier hs-var">Case</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979733"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979740"><span class="hs-identifier hs-var">bndr1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplCont -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979735"><span class="hs-identifier hs-var">cont</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">AltCon -&gt; [CoreBndr] -&gt; CoreExpr -&gt; Alt CoreBndr
forall b. AltCon -&gt; [b] -&gt; Expr b -&gt; Alt b
</span><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-var">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="GHC.Core.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979745"><span class="hs-identifier hs-var">expr''</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1571"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#emptyFloats"><span class="hs-identifier hs-type">emptyFloats</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979730"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682979746"><span class="hs-identifier hs-type">case_expr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1572"></span><span>
</span><span id="line-1573"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-comment">-- Make a let-binding</span><span>
</span><span id="line-1574"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979749"><span class="annot"><a href="#local-6989586621682979749"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979750"><span class="annot"><a href="#local-6989586621682979750"><span class="hs-identifier hs-var">bndr1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; SimplM (SimplEnv, CoreBndr)
</span><a href="GHC.Core.Opt.Simplify.Env.html#simplNonRecBndr"><span class="hs-identifier hs-var">simplNonRecBndr</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979730"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979732"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-1575"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979751"><span class="annot"><a href="#local-6989586621682979751"><span class="hs-identifier hs-var">env2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979752"><span class="annot"><a href="#local-6989586621682979752"><span class="hs-identifier hs-var">bndr2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#addBndrRules"><span class="hs-identifier hs-type">addBndrRules</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979749"><span class="hs-identifier hs-type">env1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979732"><span class="hs-identifier hs-type">bndr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979750"><span class="hs-identifier hs-type">bndr1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BC_Let"><span class="hs-identifier hs-type">BC_Let</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#NotTopLevel"><span class="hs-identifier hs-type">NotTopLevel</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#NonRecursive"><span class="hs-identifier hs-type">NonRecursive</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1576"></span><span>
</span><span id="line-1577"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682979753"><span class="annot"><a href="#local-6989586621682979753"><span class="hs-identifier hs-var hs-var">is_strict</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Id.html#isStrictId"><span class="hs-identifier hs-var">isStrictId</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979752"><span class="hs-identifier hs-var">bndr2</span></a></span><span>
</span><span id="line-1578"></span><span>              </span><span class="hs-comment">-- isStrictId: use simplified binder because the InId bndr might not have</span><span>
</span><span id="line-1579"></span><span>              </span><span class="hs-comment">-- a fixed runtime representation, which isStrictId doesn't expect</span><span>
</span><span id="line-1580"></span><span>              </span><span class="hs-comment">-- c.f. Note [Dark corner with representation polymorphism]</span><span>
</span><span id="line-1581"></span><span>
</span><span id="line-1582"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979754"><span class="annot"><a href="#local-6989586621682979754"><span class="hs-identifier hs-var">rhs_floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979755"><span class="annot"><a href="#local-6989586621682979755"><span class="hs-identifier hs-var">rhs1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#prepareBinding"><span class="hs-identifier hs-type">prepareBinding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979730"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#NotTopLevel"><span class="hs-identifier hs-type">NotTopLevel</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#NonRecursive"><span class="hs-identifier hs-type">NonRecursive</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979753"><span class="hs-identifier hs-type">is_strict</span></a></span><span>
</span><span id="line-1583"></span><span>                                               </span><span class="annot"><a href="#local-6989586621682979752"><span class="hs-identifier hs-type">bndr2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#emptyFloats"><span class="hs-identifier hs-type">emptyFloats</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979730"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682979733"><span class="hs-identifier hs-type">rhs</span></a></span><span>
</span><span id="line-1584"></span><span>              </span><span class="hs-comment">-- NB: it makes a surprisingly big difference (5% in compiler allocation</span><span>
</span><span id="line-1585"></span><span>              </span><span class="hs-comment">-- in T9630) to pass 'env' rather than 'env1'.  It's fine to pass 'env',</span><span>
</span><span id="line-1586"></span><span>              </span><span class="hs-comment">-- because this is completeBindX, so bndr is not in scope in the RHS.</span><span>
</span><span id="line-1587"></span><span>
</span><span id="line-1588"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682979756"><span class="annot"><a href="#local-6989586621682979756"><span class="hs-identifier hs-var hs-var">env3</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979751"><span class="hs-identifier hs-var">env2</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplFloats -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#setInScopeFromF"><span class="hs-operator hs-var">`setInScopeFromF`</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682979754"><span class="hs-identifier hs-var">rhs_floats</span></a></span><span>
</span><span id="line-1589"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979757"><span class="annot"><a href="#local-6989586621682979757"><span class="hs-identifier hs-var">bind_float</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979758"><span class="annot"><a href="#local-6989586621682979758"><span class="hs-identifier hs-var">env4</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#completeBind"><span class="hs-identifier hs-type">completeBind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BC_Let"><span class="hs-identifier hs-type">BC_Let</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#NotTopLevel"><span class="hs-identifier hs-type">NotTopLevel</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#NonRecursive"><span class="hs-identifier hs-type">NonRecursive</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1590"></span><span>                                             </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979732"><span class="hs-identifier hs-type">bndr</span></a></span><span class="hs-special">,</span><span class="annot"><a href="#local-6989586621682979730"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979752"><span class="hs-identifier hs-type">bndr2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682979755"><span class="hs-identifier hs-type">rhs1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682979756"><span class="hs-identifier hs-type">env3</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1591"></span><span>              </span><span class="hs-comment">-- Must pass env1 to completeBind in case simplBinder had to clone,</span><span>
</span><span id="line-1592"></span><span>              </span><span class="hs-comment">-- and extended the substitution with [bndr :-&gt; new_bndr]</span><span>
</span><span id="line-1593"></span><span>
</span><span id="line-1594"></span><span>        </span><span class="hs-comment">-- Simplify the body</span><span>
</span><span id="line-1595"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979759"><span class="annot"><a href="#local-6989586621682979759"><span class="hs-identifier hs-var">body_floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979760"><span class="annot"><a href="#local-6989586621682979760"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplNonRecBody"><span class="hs-identifier hs-type">simplNonRecBody</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979758"><span class="hs-identifier hs-type">env4</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979731"><span class="hs-identifier hs-type">from_what</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979734"><span class="hs-identifier hs-type">body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979735"><span class="hs-identifier hs-type">cont</span></a></span><span>
</span><span id="line-1596"></span><span>
</span><span id="line-1597"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682979761"><span class="annot"><a href="#local-6989586621682979761"><span class="hs-identifier hs-var hs-var">all_floats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682979754"><span class="hs-identifier hs-var">rhs_floats</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats -&gt; SimplFloats -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#addFloats"><span class="hs-operator hs-var">`addFloats`</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682979757"><span class="hs-identifier hs-var">bind_float</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats -&gt; SimplFloats -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#addFloats"><span class="hs-operator hs-var">`addFloats`</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682979759"><span class="hs-identifier hs-var">body_floats</span></a></span><span>
</span><span id="line-1598"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="#local-6989586621682979761"><span class="hs-identifier hs-type">all_floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682979760"><span class="hs-identifier hs-type">body'</span></a></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1599"></span><span>
</span><span id="line-1600"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Lambdas}
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-1607"></span><span>
</span><span id="line-1608"></span><span class="hs-comment">{- Note [Optimising reflexivity]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It's important (for compiler performance) to get rid of reflexivity as soon
as it appears.  See #11735, #14737, and #15019.

In particular, we want to behave well on

 *  e |&gt; co1 |&gt; co2
    where the two happen to cancel out entirely. That is quite common;
    e.g. a newtype wrapping and unwrapping cancel.


 * (f |&gt; co) @t1 @t2 ... @tn x1 .. xm
   Here we will use pushCoTyArg and pushCoValArg successively, which
   build up SelCo stacks.  Silly to do that if co is reflexive.

However, we don't want to call isReflexiveCo too much, because it uses
type equality which is expensive on big types (#14737 comment:7).

A good compromise (determined experimentally) seems to be to call
isReflexiveCo
 * when composing casts, and
 * at the end

In investigating this I saw missed opportunities for on-the-fly
coercion shrinkage. See #15090.

Note [Avoid re-simplifying coercions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In some benchmarks (with deeply nested cases) we successively push
casts onto the SimplCont.  We don't want to call the coercion optimiser
on each successive composition -- that's at least quadratic.  So:

* The CastIt constructor in SimplCont has a `sc_opt :: Bool` flag to
  record whether the coercion optimiser has been applied to the coercion.

* In `simplCast`, when we see (Cast e co), we simplify `co` to get
  an OutCoercion, and built a CastIt with sc_opt=True.

  Actually not quite: if we are simplifying the result of inlining an
  unfolding (seInlineDepth &gt; 0), then instead of /optimising/ it again,
  just /substitute/ which is cheaper.  See `simplCoercion`.

* In `addCoerce` (in `simplCast`) if we combine this new coercion with
  an existing once, we build a CastIt for (co1 ; co2) with sc_opt=False.

* When unpacking a CastIt, in `rebuildCall` and `rebuild`, we optimise
  the (presumably composed) coercion if sc_opt=False; this is done
  by `optOutCoercion`.

* When duplicating a continuation in `mkDupableContWithDmds`, before
  duplicating a CastIt, optimise the coercion. Otherwise we'll end up
  optimising it separately in the duplicate copies.
-}</span><span>
</span><span id="line-1662"></span><span>
</span><span id="line-1663"></span><span>
</span><span id="line-1664"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#optOutCoercion"><span class="hs-identifier hs-type">optOutCoercion</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutCoercion"><span class="hs-identifier hs-type">OutCoercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutCoercion"><span class="hs-identifier hs-type">OutCoercion</span></a></span><span>
</span><span id="line-1665"></span><span class="hs-comment">-- See Note [Avoid re-simplifying coercions]</span><span>
</span><span id="line-1666"></span><span id="optOutCoercion"><span class="annot"><span class="annottext">optOutCoercion :: SimplEnv -&gt; CoercionR -&gt; Bool -&gt; CoercionR
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#optOutCoercion"><span class="hs-identifier hs-var hs-var">optOutCoercion</span></a></span></span><span> </span><span id="local-6989586621682979762"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979762"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979763"><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979763"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span id="local-6989586621682979764"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682979764"><span class="hs-identifier hs-var">already_optimised</span></a></span></span><span>
</span><span id="line-1667"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682979764"><span class="hs-identifier hs-var">already_optimised</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979763"><span class="hs-identifier hs-var">co</span></a></span><span>  </span><span class="hs-comment">-- See Note [Avoid re-simplifying coercions]</span><span>
</span><span id="line-1668"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OptCoercionOpts -&gt; Subst -&gt; CoercionR -&gt; CoercionR
</span><a href="GHC.Core.Coercion.Opt.html#optCoercion"><span class="hs-identifier hs-var">optCoercion</span></a></span><span> </span><span class="annot"><span class="annottext">OptCoercionOpts
</span><a href="#local-6989586621682979765"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682979766"><span class="hs-identifier hs-var">empty_subst</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979763"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1669"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1670"></span><span>    </span><span id="local-6989586621682979766"><span class="annot"><span class="annottext">empty_subst :: Subst
</span><a href="#local-6989586621682979766"><span class="hs-identifier hs-var hs-var">empty_subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#mkEmptySubst"><span class="hs-identifier hs-var">mkEmptySubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv -&gt; InScopeSet
</span><a href="GHC.Core.Opt.Simplify.Env.html#seInScope"><span class="hs-identifier hs-var">seInScope</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979762"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1671"></span><span>    </span><span id="local-6989586621682979765"><span class="annot"><span class="annottext">opts :: OptCoercionOpts
</span><a href="#local-6989586621682979765"><span class="hs-identifier hs-var hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; OptCoercionOpts
</span><a href="GHC.Core.Opt.Simplify.Env.html#seOptCoercionOpts"><span class="hs-identifier hs-var">seOptCoercionOpts</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979762"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1672"></span><span>
</span><span id="line-1673"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplCast"><span class="hs-identifier hs-type">simplCast</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InCoercion"><span class="hs-identifier hs-type">InCoercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-1674"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1675"></span><span id="simplCast"><span class="annot"><span class="annottext">simplCast :: SimplEnv
-&gt; CoreExpr
-&gt; CoercionR
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplCast"><span class="hs-identifier hs-var hs-var">simplCast</span></a></span></span><span> </span><span id="local-6989586621682979769"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979769"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979770"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979770"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621682979771"><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979771"><span class="hs-identifier hs-var">co0</span></a></span></span><span> </span><span id="local-6989586621682979772"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979772"><span class="hs-identifier hs-var">cont0</span></a></span></span><span>
</span><span id="line-1676"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682979773"><span class="annot"><a href="#local-6989586621682979773"><span class="hs-identifier hs-var">co1</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-pragma">{-#SCC</span><span> </span><span class="hs-pragma">&quot;simplCast-simplCoercion&quot;</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoercionR -&gt; SimplM CoercionR
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplCoercion"><span class="hs-identifier hs-var">simplCoercion</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979769"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979771"><span class="hs-identifier hs-var">co0</span></a></span><span>
</span><span id="line-1677"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682979774"><span class="annot"><a href="#local-6989586621682979774"><span class="hs-identifier hs-var">cont1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-pragma">{-#SCC</span><span> </span><span class="hs-pragma">&quot;simplCast-addCoerce&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1678"></span><span>                   </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#isReflCo"><span class="hs-identifier hs-type">isReflCo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979773"><span class="hs-identifier hs-type">co1</span></a></span><span>
</span><span id="line-1679"></span><span>                   </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621682979772"><span class="hs-identifier hs-type">cont0</span></a></span><span>  </span><span class="hs-comment">-- See Note [Optimising reflexivity]</span><span>
</span><span id="line-1680"></span><span>                   </span><span class="hs-keyword">else</span><span> </span><span class="annot"><a href="#local-6989586621682979776"><span class="hs-identifier hs-type">addCoerce</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979773"><span class="hs-identifier hs-type">co1</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">True</span></span><span> </span><span class="annot"><a href="#local-6989586621682979772"><span class="hs-identifier hs-type">cont0</span></a></span><span>
</span><span id="line-1681"></span><span>                        </span><span class="hs-comment">-- True &lt;=&gt; co1 is optimised</span><span>
</span><span id="line-1682"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-pragma">{-#SCC</span><span> </span><span class="hs-pragma">&quot;simplCast-simplExprF&quot;</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF"><span class="hs-identifier hs-type">simplExprF</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979769"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979770"><span class="hs-identifier hs-type">body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979774"><span class="hs-identifier hs-type">cont1</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1683"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1684"></span><span>
</span><span id="line-1685"></span><span>        </span><span class="hs-comment">-- If the first parameter is MRefl, then simplifying revealed a</span><span>
</span><span id="line-1686"></span><span>        </span><span class="hs-comment">-- reflexive coercion. Omit.</span><span>
</span><span id="line-1687"></span><span>        </span><span class="annot"><a href="#local-6989586621682979777"><span class="hs-identifier hs-type">addCoerceM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#MOutCoercion"><span class="hs-identifier hs-type">MOutCoercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-1688"></span><span>        </span><span id="local-6989586621682979777"><span class="annot"><span class="annottext">addCoerceM :: MOutCoercion -&gt; Bool -&gt; SimplCont -&gt; SimplM SimplCont
</span><a href="#local-6989586621682979777"><span class="hs-identifier hs-var hs-var">addCoerceM</span></a></span></span><span> </span><span class="annot"><span class="annottext">MOutCoercion
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span>    </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span>   </span><span id="local-6989586621682979779"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979779"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; SimplM SimplCont
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979779"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1689"></span><span>        </span><span class="annot"><a href="#local-6989586621682979777"><span class="hs-identifier hs-var">addCoerceM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCo"><span class="hs-identifier hs-type">MCo</span></a></span><span> </span><span id="local-6989586621682979781"><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979781"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682979782"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682979782"><span class="hs-identifier hs-var">opt</span></a></span></span><span> </span><span id="local-6989586621682979783"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979783"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoercionR -&gt; Bool -&gt; SimplCont -&gt; SimplM SimplCont
</span><a href="#local-6989586621682979776"><span class="hs-identifier hs-var">addCoerce</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979781"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682979782"><span class="hs-identifier hs-var">opt</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979783"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1690"></span><span>
</span><span id="line-1691"></span><span>        </span><span class="annot"><a href="#local-6989586621682979776"><span class="hs-identifier hs-type">addCoerce</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#OutCoercion"><span class="hs-identifier hs-type">OutCoercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-1692"></span><span>        </span><span id="local-6989586621682979776"><span class="annot"><span class="annottext">addCoerce :: CoercionR -&gt; Bool -&gt; SimplCont -&gt; SimplM SimplCont
</span><a href="#local-6989586621682979776"><span class="hs-identifier hs-var hs-var">addCoerce</span></a></span></span><span> </span><span id="local-6989586621682979784"><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979784"><span class="hs-identifier hs-var">co1</span></a></span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#CastIt"><span class="hs-identifier hs-type">CastIt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_co :: SimplCont -&gt; CoercionR
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_co"><span class="hs-identifier hs-var">sc_co</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979785"><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979785"><span class="hs-identifier hs-var">co2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979786"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979786"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- See Note [Optimising reflexivity]</span><span>
</span><span id="line-1693"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoercionR -&gt; Bool -&gt; SimplCont -&gt; SimplM SimplCont
</span><a href="#local-6989586621682979776"><span class="hs-identifier hs-var">addCoerce</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoercionR -&gt; CoercionR -&gt; CoercionR
CoercionR -&gt; CoercionR -&gt; CoercionR
</span><a href="GHC.Core.Coercion.html#mkTransCo"><span class="hs-identifier hs-var">mkTransCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979784"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979785"><span class="hs-identifier hs-var">co2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979786"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1694"></span><span>                      </span><span class="hs-comment">-- False: (mkTransCo co1 co2) is not fully optimised</span><span>
</span><span id="line-1695"></span><span>                      </span><span class="hs-comment">-- See Note [Avoid re-simplifying coercions]</span><span>
</span><span id="line-1696"></span><span>
</span><span id="line-1697"></span><span>        </span><span class="annot"><a href="#local-6989586621682979776"><span class="hs-identifier hs-var">addCoerce</span></a></span><span> </span><span id="local-6989586621682979788"><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979788"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span id="local-6989586621682979789"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682979789"><span class="hs-identifier hs-var">opt</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToTy"><span class="hs-identifier hs-type">ApplyToTy</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_arg_ty :: SimplCont -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_arg_ty"><span class="hs-identifier hs-var">sc_arg_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979790"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979790"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979791"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979791"><span class="hs-identifier hs-var">tail</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1698"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979792"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979792"><span class="hs-identifier hs-var">arg_ty'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979793"><span class="annot"><span class="annottext">MOutCoercion
</span><a href="#local-6989586621682979793"><span class="hs-identifier hs-var">m_co'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoercionR -&gt; Kind -&gt; Maybe (Kind, MOutCoercion)
</span><a href="GHC.Core.Opt.Arity.html#pushCoTyArg"><span class="hs-identifier hs-var">pushCoTyArg</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979788"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979790"><span class="hs-identifier hs-var">arg_ty</span></a></span><span>
</span><span id="line-1699"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-#SCC</span><span> </span><span class="hs-pragma">&quot;addCoerce-pushCoTyArg&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1700"></span><span>            </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682979794"><span class="annot"><a href="#local-6989586621682979794"><span class="hs-identifier hs-var">tail'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MOutCoercion -&gt; Bool -&gt; SimplCont -&gt; SimplM SimplCont
</span><a href="#local-6989586621682979777"><span class="hs-identifier hs-var">addCoerceM</span></a></span><span> </span><span class="annot"><span class="annottext">MOutCoercion
</span><a href="#local-6989586621682979793"><span class="hs-identifier hs-var">m_co'</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682979789"><span class="hs-identifier hs-var">opt</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979791"><span class="hs-identifier hs-var">tail</span></a></span><span>
</span><span id="line-1701"></span><span>               </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToTy"><span class="hs-identifier hs-type">ApplyToTy</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_arg_ty"><span class="hs-identifier hs-var">sc_arg_ty</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682979792"><span class="hs-identifier hs-type">arg_ty'</span></a></span><span>
</span><span id="line-1702"></span><span>                                   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682979794"><span class="hs-identifier hs-type">tail'</span></a></span><span>
</span><span id="line-1703"></span><span>                                   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_hole_ty"><span class="hs-identifier hs-var">sc_hole_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#coercionLKind"><span class="hs-identifier hs-type">coercionLKind</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979788"><span class="hs-identifier hs-type">co</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1704"></span><span>                                        </span><span class="hs-comment">-- NB!  As the cast goes past, the</span><span>
</span><span id="line-1705"></span><span>                                        </span><span class="hs-comment">-- type of the hole changes (#16312)</span><span>
</span><span id="line-1706"></span><span>        </span><span class="hs-comment">-- (f |&gt; co) e   ===&gt;   (f (e |&gt; co1)) |&gt; co2</span><span>
</span><span id="line-1707"></span><span>        </span><span class="hs-comment">-- where   co :: (s1-&gt;s2) ~ (t1-&gt;t2)</span><span>
</span><span id="line-1708"></span><span>        </span><span class="hs-comment">--         co1 :: t1 ~ s1</span><span>
</span><span id="line-1709"></span><span>        </span><span class="hs-comment">--         co2 :: s2 ~ t2</span><span>
</span><span id="line-1710"></span><span>        </span><span class="annot"><a href="#local-6989586621682979776"><span class="hs-identifier hs-var">addCoerce</span></a></span><span> </span><span id="local-6989586621682979795"><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979795"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span id="local-6989586621682979796"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682979796"><span class="hs-identifier hs-var">opt</span></a></span></span><span> </span><span id="local-6989586621682979797"><span class="annot"><span class="annottext">cont :: SimplCont
</span><a href="#local-6989586621682979797"><span class="hs-identifier hs-var">cont</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToVal"><span class="hs-identifier hs-type">ApplyToVal</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_arg :: SimplCont -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_arg"><span class="hs-identifier hs-var">sc_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979798"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979798"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_env :: SimplCont -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_env"><span class="hs-identifier hs-var">sc_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979799"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979799"><span class="hs-identifier hs-var">arg_se</span></a></span></span><span>
</span><span id="line-1711"></span><span>                                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_dup :: SimplCont -&gt; DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_dup"><span class="hs-identifier hs-var">sc_dup</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979800"><span class="annot"><span class="annottext">DupFlag
</span><a href="#local-6989586621682979800"><span class="hs-identifier hs-var">dup</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979801"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979801"><span class="hs-identifier hs-var">tail</span></a></span></span><span>
</span><span id="line-1712"></span><span>                                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_hole_ty :: SimplCont -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_hole_ty"><span class="hs-identifier hs-var">sc_hole_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979802"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979802"><span class="hs-identifier hs-var">fun_ty</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1713"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682979796"><span class="hs-identifier hs-var">opt</span></a></span><span>  </span><span class="hs-comment">-- pushCoValArg duplicates the coercion, so optimise first</span><span>
</span><span id="line-1714"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoercionR -&gt; Bool -&gt; SimplCont -&gt; SimplM SimplCont
</span><a href="#local-6989586621682979776"><span class="hs-identifier hs-var">addCoerce</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv -&gt; CoercionR -&gt; Bool -&gt; CoercionR
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#optOutCoercion"><span class="hs-identifier hs-var">optOutCoercion</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979769"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979795"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682979796"><span class="hs-identifier hs-var">opt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979797"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1715"></span><span>
</span><span id="line-1716"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979803"><span class="annot"><span class="annottext">MOutCoercion
</span><a href="#local-6989586621682979803"><span class="hs-identifier hs-var">m_co1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979804"><span class="annot"><span class="annottext">MOutCoercion
</span><a href="#local-6989586621682979804"><span class="hs-identifier hs-var">m_co2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoercionR -&gt; Maybe (MOutCoercion, MOutCoercion)
</span><a href="GHC.Core.Opt.Arity.html#pushCoValArg"><span class="hs-identifier hs-var">pushCoValArg</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979795"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1717"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MOutCoercion -&gt; Bool
</span><a href="#local-6989586621682979805"><span class="hs-identifier hs-var">fixed_rep</span></a></span><span> </span><span class="annot"><span class="annottext">MOutCoercion
</span><a href="#local-6989586621682979803"><span class="hs-identifier hs-var">m_co1</span></a></span><span>
</span><span id="line-1718"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-#SCC</span><span> </span><span class="hs-pragma">&quot;addCoerce-pushCoValArg&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1719"></span><span>            </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682979806"><span class="annot"><a href="#local-6989586621682979806"><span class="hs-identifier hs-var">tail'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MOutCoercion -&gt; Bool -&gt; SimplCont -&gt; SimplM SimplCont
</span><a href="#local-6989586621682979777"><span class="hs-identifier hs-var">addCoerceM</span></a></span><span> </span><span class="annot"><span class="annottext">MOutCoercion
</span><a href="#local-6989586621682979804"><span class="hs-identifier hs-var">m_co2</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682979796"><span class="hs-identifier hs-var">opt</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979801"><span class="hs-identifier hs-var">tail</span></a></span><span>
</span><span id="line-1720"></span><span>               </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621682979803"><span class="hs-identifier hs-type">m_co1</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1721"></span><span>                   </span><span class="annot"><span class="annottext">MOutCoercion
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; SimplM SimplCont
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979797"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682979806"><span class="hs-identifier hs-type">tail'</span></a></span><span>
</span><span id="line-1722"></span><span>                                         </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_hole_ty"><span class="hs-identifier hs-var">sc_hole_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#coercionLKind"><span class="hs-identifier hs-type">coercionLKind</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979795"><span class="hs-identifier hs-type">co</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">;</span><span>
</span><span id="line-1723"></span><span>                      </span><span class="hs-comment">-- See Note [Avoiding simplifying repeatedly]</span><span>
</span><span id="line-1724"></span><span>
</span><span id="line-1725"></span><span>                   </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCo"><span class="hs-identifier hs-type">MCo</span></a></span><span> </span><span id="local-6989586621682979807"><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979807"><span class="hs-identifier hs-var">co1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1726"></span><span>            </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979808"><span class="annot"><a href="#local-6989586621682979808"><span class="hs-identifier hs-var">dup'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979809"><span class="annot"><a href="#local-6989586621682979809"><span class="hs-identifier hs-var">arg_se'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979810"><span class="annot"><a href="#local-6989586621682979810"><span class="hs-identifier hs-var">arg'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; DupFlag
-&gt; Kind
-&gt; Maybe ArgInfo
-&gt; SimplEnv
-&gt; CoreExpr
-&gt; SimplM (DupFlag, SimplEnv, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplLazyArg"><span class="hs-identifier hs-var">simplLazyArg</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979769"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">DupFlag
</span><a href="#local-6989586621682979800"><span class="hs-identifier hs-var">dup</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979802"><span class="hs-identifier hs-var">fun_ty</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ArgInfo
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979799"><span class="hs-identifier hs-var">arg_se</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979798"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-1727"></span><span>                    </span><span class="hs-comment">-- When we build the ApplyTo we can't mix the OutCoercion</span><span>
</span><span id="line-1728"></span><span>                    </span><span class="hs-comment">-- 'co' with the InExpr 'arg', so we simplify</span><span>
</span><span id="line-1729"></span><span>                    </span><span class="hs-comment">-- to make it all consistent.  It's a bit messy.</span><span>
</span><span id="line-1730"></span><span>                    </span><span class="hs-comment">-- But it isn't a common case.</span><span>
</span><span id="line-1731"></span><span>                    </span><span class="hs-comment">-- Example of use: #995</span><span>
</span><span id="line-1732"></span><span>               </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToVal"><span class="hs-identifier hs-type">ApplyToVal</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_arg"><span class="hs-identifier hs-var">sc_arg</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#mkCast"><span class="hs-identifier hs-type">mkCast</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979810"><span class="hs-identifier hs-type">arg'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979807"><span class="hs-identifier hs-type">co1</span></a></span><span>
</span><span id="line-1733"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_env"><span class="hs-identifier hs-var">sc_env</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682979809"><span class="hs-identifier hs-type">arg_se'</span></a></span><span>
</span><span id="line-1734"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_dup"><span class="hs-identifier hs-var">sc_dup</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682979808"><span class="hs-identifier hs-type">dup'</span></a></span><span>
</span><span id="line-1735"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682979806"><span class="hs-identifier hs-type">tail'</span></a></span><span>
</span><span id="line-1736"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_hole_ty"><span class="hs-identifier hs-var">sc_hole_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#coercionLKind"><span class="hs-identifier hs-type">coercionLKind</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979795"><span class="hs-identifier hs-type">co</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1737"></span><span>
</span><span id="line-1738"></span><span>        </span><span class="annot"><a href="#local-6989586621682979776"><span class="hs-identifier hs-var">addCoerce</span></a></span><span> </span><span id="local-6989586621682979811"><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979811"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span id="local-6989586621682979812"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682979812"><span class="hs-identifier hs-var">opt</span></a></span></span><span> </span><span id="local-6989586621682979813"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979813"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-1739"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoercionR -&gt; Bool
</span><a href="GHC.Core.Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979811"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; SimplM SimplCont
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979813"><span class="hs-identifier hs-var">cont</span></a></span><span>  </span><span class="hs-comment">-- Having this at the end makes a huge</span><span>
</span><span id="line-1740"></span><span>                                       </span><span class="hs-comment">-- difference in T12227, for some reason</span><span>
</span><span id="line-1741"></span><span>                                       </span><span class="hs-comment">-- See Note [Optimising reflexivity]</span><span>
</span><span id="line-1742"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; SimplM SimplCont
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#CastIt"><span class="hs-identifier hs-type">CastIt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_co :: CoercionR
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_co"><span class="hs-identifier hs-var">sc_co</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979811"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_opt :: Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_opt"><span class="hs-identifier hs-var">sc_opt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682979812"><span class="hs-identifier hs-var">opt</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979813"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1743"></span><span>
</span><span id="line-1744"></span><span>        </span><span class="annot"><a href="#local-6989586621682979805"><span class="hs-identifier hs-type">fixed_rep</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCoercionR"><span class="hs-identifier hs-type">MCoercionR</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1745"></span><span>        </span><span id="local-6989586621682979805"><span class="annot"><span class="annottext">fixed_rep :: MOutCoercion -&gt; Bool
</span><a href="#local-6989586621682979805"><span class="hs-identifier hs-var hs-var">fixed_rep</span></a></span></span><span> </span><span class="annot"><span class="annottext">MOutCoercion
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1746"></span><span>        </span><span class="annot"><a href="#local-6989586621682979805"><span class="hs-identifier hs-var">fixed_rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCo"><span class="hs-identifier hs-type">MCo</span></a></span><span> </span><span id="local-6989586621682979815"><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979815"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Kind -&gt; Bool
Kind -&gt; Bool
</span><a href="GHC.Core.Type.html#typeHasFixedRuntimeRep"><span class="hs-identifier hs-var">typeHasFixedRuntimeRep</span></a></span><span> </span><span class="annot"><span class="annottext">(Kind -&gt; Bool) -&gt; Kind -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoercionR -&gt; Kind
CoercionR -&gt; Kind
</span><a href="GHC.Core.Coercion.html#coercionRKind"><span class="hs-identifier hs-var">coercionRKind</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979815"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1747"></span><span>          </span><span class="hs-comment">-- Without this check, we can get an argument which does not</span><span>
</span><span id="line-1748"></span><span>          </span><span class="hs-comment">-- have a fixed runtime representation.</span><span>
</span><span id="line-1749"></span><span>          </span><span class="hs-comment">-- See Note [Representation polymorphism invariants] in GHC.Core</span><span>
</span><span id="line-1750"></span><span>          </span><span class="hs-comment">-- test: typecheck/should_run/EtaExpandLevPoly</span><span>
</span><span id="line-1751"></span><span>
</span><span id="line-1752"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplLazyArg"><span class="hs-identifier hs-type">simplLazyArg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#DupFlag"><span class="hs-identifier hs-type">DupFlag</span></a></span><span>
</span><span id="line-1753"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutType"><span class="hs-identifier hs-type">OutType</span></a></span><span>                 </span><span class="annot"><span class="hs-comment">-- ^ Type of the function applied to this arg</span></span><span>
</span><span id="line-1754"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span>           </span><span class="hs-comment">-- ^ Just &lt;=&gt; This arg `ai` occurs in an app</span><span>
</span><span id="line-1755"></span><span>                                        </span><span class="hs-comment">--   `f a1 ... an` where we have ArgInfo on</span><span>
</span><span id="line-1756"></span><span>                                        </span><span class="hs-comment">--   how `f` uses `ai`, affecting the Stop</span><span>
</span><span id="line-1757"></span><span>                                        </span><span class="hs-comment">--   continuation passed to 'simplExprC'</span><span>
</span><span id="line-1758"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StaticEnv"><span class="hs-identifier hs-type">StaticEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>   </span><span class="annot"><span class="hs-comment">-- ^ Expression with its static envt</span></span><span>
</span><span id="line-1759"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#DupFlag"><span class="hs-identifier hs-type">DupFlag</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StaticEnv"><span class="hs-identifier hs-type">StaticEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1760"></span><span id="simplLazyArg"><span class="annot"><span class="annottext">simplLazyArg :: SimplEnv
-&gt; DupFlag
-&gt; Kind
-&gt; Maybe ArgInfo
-&gt; SimplEnv
-&gt; CoreExpr
-&gt; SimplM (DupFlag, SimplEnv, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplLazyArg"><span class="hs-identifier hs-var hs-var">simplLazyArg</span></a></span></span><span> </span><span id="local-6989586621682979818"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979818"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979819"><span class="annot"><span class="annottext">DupFlag
</span><a href="#local-6989586621682979819"><span class="hs-identifier hs-var">dup_flag</span></a></span></span><span> </span><span id="local-6989586621682979820"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979820"><span class="hs-identifier hs-var">fun_ty</span></a></span></span><span> </span><span id="local-6989586621682979821"><span class="annot"><span class="annottext">Maybe ArgInfo
</span><a href="#local-6989586621682979821"><span class="hs-identifier hs-var">mb_arg_info</span></a></span></span><span> </span><span id="local-6989586621682979822"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979822"><span class="hs-identifier hs-var">arg_env</span></a></span></span><span> </span><span id="local-6989586621682979823"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979823"><span class="hs-identifier hs-var">arg</span></a></span></span><span>
</span><span id="line-1761"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">DupFlag -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#isSimplified"><span class="hs-identifier hs-var">isSimplified</span></a></span><span> </span><span class="annot"><span class="annottext">DupFlag
</span><a href="#local-6989586621682979819"><span class="hs-identifier hs-var">dup_flag</span></a></span><span>
</span><span id="line-1762"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DupFlag, SimplEnv, CoreExpr)
-&gt; SimplM (DupFlag, SimplEnv, CoreExpr)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DupFlag
</span><a href="#local-6989586621682979819"><span class="hs-identifier hs-var">dup_flag</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979822"><span class="hs-identifier hs-var">arg_env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979823"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1763"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1764"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682979825"><span class="annot"><span class="annottext">arg_env' :: SimplEnv
</span><a href="#local-6989586621682979825"><span class="hs-identifier hs-var hs-var hs-var">arg_env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979822"><span class="hs-identifier hs-var">arg_env</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplEnv -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#setInScopeFromE"><span class="hs-operator hs-var">`setInScopeFromE`</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979818"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1765"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682979826"><span class="annot"><span class="annottext">arg_ty :: Kind
</span><a href="#local-6989586621682979826"><span class="hs-identifier hs-var hs-var hs-var">arg_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Kind -&gt; Kind
Kind -&gt; Kind
</span><a href="GHC.Core.Type.html#funArgTy"><span class="hs-identifier hs-var">funArgTy</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979820"><span class="hs-identifier hs-var">fun_ty</span></a></span><span>
</span><span id="line-1766"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682979828"><span class="annot"><span class="annottext">stop :: SimplCont
</span><a href="#local-6989586621682979828"><span class="hs-identifier hs-var hs-var hs-var">stop</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe ArgInfo
</span><a href="#local-6989586621682979821"><span class="hs-identifier hs-var">mb_arg_info</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1767"></span><span>               </span><span class="annot"><span class="annottext">Maybe ArgInfo
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Kind -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#mkBoringStop"><span class="hs-identifier hs-var">mkBoringStop</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979826"><span class="hs-identifier hs-var">arg_ty</span></a></span><span>
</span><span id="line-1768"></span><span>               </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682979829"><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682979829"><span class="hs-identifier hs-var">ai</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Kind -&gt; ArgInfo -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#mkLazyArgStop"><span class="hs-identifier hs-var">mkLazyArgStop</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979826"><span class="hs-identifier hs-var">arg_ty</span></a></span><span> </span><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682979829"><span class="hs-identifier hs-var">ai</span></a></span><span>
</span><span id="line-1769"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682979831"><span class="annot"><a href="#local-6989586621682979831"><span class="hs-identifier hs-var">arg'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprC"><span class="hs-identifier hs-var">simplExprC</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979825"><span class="hs-identifier hs-var">arg_env'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979823"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979828"><span class="hs-identifier hs-var">stop</span></a></span><span>
</span><span id="line-1770"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#Simplified"><span class="hs-identifier hs-type">Simplified</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#zapSubstEnv"><span class="hs-identifier hs-type">zapSubstEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979825"><span class="hs-identifier hs-type">arg_env'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682979831"><span class="hs-identifier hs-type">arg'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1771"></span><span>         </span><span class="hs-comment">-- Return a StaticEnv that includes the in-scope set from 'env',</span><span>
</span><span id="line-1772"></span><span>         </span><span class="hs-comment">-- because arg' may well mention those variables (#20639)</span><span>
</span><span id="line-1773"></span><span>
</span><span id="line-1774"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Lambdas}
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-1781"></span><span>
</span><span id="line-1782"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplNonRecBody"><span class="hs-identifier hs-type">simplNonRecBody</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#FromWhat"><span class="hs-identifier hs-type">FromWhat</span></a></span><span>
</span><span id="line-1783"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-1784"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1785"></span><span id="simplNonRecBody"><span class="annot"><span class="annottext">simplNonRecBody :: SimplEnv
-&gt; FromWhat
-&gt; CoreExpr
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplNonRecBody"><span class="hs-identifier hs-var hs-var">simplNonRecBody</span></a></span></span><span> </span><span id="local-6989586621682979834"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979834"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979835"><span class="annot"><span class="annottext">FromWhat
</span><a href="#local-6989586621682979835"><span class="hs-identifier hs-var">from_what</span></a></span></span><span> </span><span id="local-6989586621682979836"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979836"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621682979837"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979837"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-1786"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">FromWhat
</span><a href="#local-6989586621682979835"><span class="hs-identifier hs-var">from_what</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1787"></span><span>      </span><span class="annot"><span class="annottext">FromWhat
</span><a href="GHC.Core.Opt.Simplify.Utils.html#FromLet"><span class="hs-identifier hs-var">FromLet</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979834"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979836"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979837"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1788"></span><span>      </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#FromBeta"><span class="hs-identifier hs-type">FromBeta</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplLam"><span class="hs-identifier hs-var">simplLam</span></a></span><span>   </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979834"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979836"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979837"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1789"></span><span>
</span><span id="line-1790"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplLam"><span class="hs-identifier hs-type">simplLam</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-1791"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1792"></span><span>
</span><span id="line-1793"></span><span id="simplLam"><span class="annot"><span class="annottext">simplLam :: SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplLam"><span class="hs-identifier hs-var hs-var">simplLam</span></a></span></span><span> </span><span id="local-6989586621682979838"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979838"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621682979839"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979839"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682979840"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979840"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682979841"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979841"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
SimplEnv
-&gt; CoreBndr
-&gt; CoreExpr
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
SimplEnv
-&gt; CoreBndr
-&gt; CoreExpr
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simpl_lam"><span class="hs-identifier hs-var">simpl_lam</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979838"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979839"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979840"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979841"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1794"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplLam"><span class="hs-identifier hs-var">simplLam</span></a></span><span> </span><span id="local-6989586621682979843"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979843"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979844"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979844"><span class="hs-identifier hs-var">expr</span></a></span></span><span>            </span><span id="local-6989586621682979845"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979845"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979843"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979844"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979845"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1795"></span><span>
</span><span id="line-1796"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simpl_lam"><span class="hs-identifier hs-type">simpl_lam</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span>
</span><span id="line-1797"></span><span>          </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InBndr"><span class="hs-identifier hs-type">InBndr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-1798"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1799"></span><span>
</span><span id="line-1800"></span><span class="hs-comment">-- Type beta-reduction</span><span>
</span><span id="line-1801"></span><span id="simpl_lam"><span class="annot"><span class="annottext">simpl_lam :: HasDebugCallStack =&gt;
SimplEnv
-&gt; CoreBndr
-&gt; CoreExpr
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simpl_lam"><span class="hs-identifier hs-var hs-var">simpl_lam</span></a></span></span><span> </span><span id="local-6989586621682979864"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979864"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979865"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979865"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682979866"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979866"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToTy"><span class="hs-identifier hs-type">ApplyToTy</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_arg_ty :: SimplCont -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_arg_ty"><span class="hs-identifier hs-var">sc_arg_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979867"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979867"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979868"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979868"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1802"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Tick -&gt; SimplM ()
</span><a href="GHC.Core.Opt.Simplify.Monad.html#tick"><span class="hs-identifier hs-var">tick</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Tick
</span><a href="GHC.Core.Opt.Stats.html#BetaReduction"><span class="hs-identifier hs-var">BetaReduction</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979865"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1803"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplLam"><span class="hs-identifier hs-var">simplLam</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; Kind -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#extendTvSubst"><span class="hs-identifier hs-var">extendTvSubst</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979864"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979865"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979867"><span class="hs-identifier hs-var">arg_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979866"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979868"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1804"></span><span>
</span><span id="line-1805"></span><span class="hs-comment">-- Coercion beta-reduction</span><span>
</span><span id="line-1806"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simpl_lam"><span class="hs-identifier hs-var">simpl_lam</span></a></span><span> </span><span id="local-6989586621682979870"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979870"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979871"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979871"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682979872"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979872"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToVal"><span class="hs-identifier hs-type">ApplyToVal</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_arg :: SimplCont -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_arg"><span class="hs-identifier hs-var">sc_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span id="local-6989586621682979873"><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979873"><span class="hs-identifier hs-var">arg_co</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_env :: SimplCont -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_env"><span class="hs-identifier hs-var">sc_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979874"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979874"><span class="hs-identifier hs-var">arg_se</span></a></span></span><span>
</span><span id="line-1807"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979875"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979875"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1808"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; SDoc
-&gt; SimplM (SimplFloats, CoreExpr)
-&gt; SimplM (SimplFloats, CoreExpr)
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979871"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979871"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SimplM (SimplFloats, CoreExpr) -&gt; SimplM (SimplFloats, CoreExpr))
-&gt; SimplM (SimplFloats, CoreExpr) -&gt; SimplM (SimplFloats, CoreExpr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1809"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Tick -&gt; SimplM ()
</span><a href="GHC.Core.Opt.Simplify.Monad.html#tick"><span class="hs-identifier hs-var">tick</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Tick
</span><a href="GHC.Core.Opt.Stats.html#BetaReduction"><span class="hs-identifier hs-var">BetaReduction</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979871"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1810"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682979876"><span class="annot"><span class="annottext">arg_co' :: CoercionR
</span><a href="#local-6989586621682979876"><span class="hs-identifier hs-var hs-var">arg_co'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoercionR -&gt; CoercionR
</span><a href="GHC.Core.Opt.Simplify.Env.html#substCo"><span class="hs-identifier hs-var">substCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979874"><span class="hs-identifier hs-var">arg_se</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplEnv -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#setInScopeFromE"><span class="hs-operator hs-var">`setInScopeFromE`</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979870"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979873"><span class="hs-identifier hs-var">arg_co</span></a></span><span>
</span><span id="line-1811"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplLam"><span class="hs-identifier hs-var">simplLam</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; CoercionR -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#extendCvSubst"><span class="hs-identifier hs-var">extendCvSubst</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979870"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979871"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682979876"><span class="hs-identifier hs-var">arg_co'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979872"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979875"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1812"></span><span>
</span><span id="line-1813"></span><span class="hs-comment">-- Value beta-reduction</span><span>
</span><span id="line-1814"></span><span class="hs-comment">-- This works for /coercion/ lambdas too</span><span>
</span><span id="line-1815"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simpl_lam"><span class="hs-identifier hs-var">simpl_lam</span></a></span><span> </span><span id="local-6989586621682979877"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979877"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979878"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979878"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682979879"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979879"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToVal"><span class="hs-identifier hs-type">ApplyToVal</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_arg :: SimplCont -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_arg"><span class="hs-identifier hs-var">sc_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979880"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979880"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_env :: SimplCont -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_env"><span class="hs-identifier hs-var">sc_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979881"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979881"><span class="hs-identifier hs-var">arg_se</span></a></span></span><span>
</span><span id="line-1816"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979882"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979882"><span class="hs-identifier hs-var">cont</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_dup :: SimplCont -&gt; DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_dup"><span class="hs-identifier hs-var">sc_dup</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979883"><span class="annot"><span class="annottext">DupFlag
</span><a href="#local-6989586621682979883"><span class="hs-identifier hs-var">dup</span></a></span></span><span>
</span><span id="line-1817"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_hole_ty :: SimplCont -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_hole_ty"><span class="hs-identifier hs-var">sc_hole_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682979884"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979884"><span class="hs-identifier hs-var">fun_ty</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1818"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Tick -&gt; SimplM ()
</span><a href="GHC.Core.Opt.Simplify.Monad.html#tick"><span class="hs-identifier hs-var">tick</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Tick
</span><a href="GHC.Core.Opt.Stats.html#BetaReduction"><span class="hs-identifier hs-var">BetaReduction</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979878"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1819"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682979885"><span class="annot"><span class="annottext">from_what :: FromWhat
</span><a href="#local-6989586621682979885"><span class="hs-identifier hs-var hs-var">from_what</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Levity -&gt; FromWhat
</span><a href="GHC.Core.Opt.Simplify.Utils.html#FromBeta"><span class="hs-identifier hs-var">FromBeta</span></a></span><span> </span><span class="annot"><span class="annottext">Levity
</span><a href="#local-6989586621682979886"><span class="hs-identifier hs-var">arg_levity</span></a></span><span>
</span><span id="line-1820"></span><span>             </span><span id="local-6989586621682979886"><span class="annot"><span class="annottext">arg_levity :: Levity
</span><a href="#local-6989586621682979886"><span class="hs-identifier hs-var hs-var">arg_levity</span></a></span></span><span>
</span><span id="line-1821"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Kind -&gt; Bool
</span><a href="GHC.Core.Type.html#isForAllTy"><span class="hs-identifier hs-var">isForAllTy</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979884"><span class="hs-identifier hs-var">fun_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; Levity -&gt; Levity
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979878"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979878"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Levity
</span><a href="GHC.Types.Basic.html#Unlifted"><span class="hs-identifier hs-var">Unlifted</span></a></span><span>
</span><span id="line-1822"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Kind -&gt; Levity
Kind -&gt; Levity
</span><a href="GHC.Core.Type.html#typeLevity"><span class="hs-identifier hs-var">typeLevity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Kind -&gt; Kind
Kind -&gt; Kind
</span><a href="GHC.Core.Type.html#funArgTy"><span class="hs-identifier hs-var">funArgTy</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979884"><span class="hs-identifier hs-var">fun_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1823"></span><span>             </span><span class="hs-comment">-- Example:  (\(cv::a ~# b). blah) co</span><span>
</span><span id="line-1824"></span><span>             </span><span class="hs-comment">-- The type of (\cv.blah) can be (forall cv. ty); see GHC.Core.Utils.mkLamType</span><span>
</span><span id="line-1825"></span><span>
</span><span id="line-1826"></span><span>             </span><span class="hs-comment">-- Using fun_ty: see Note [Dark corner with representation polymorphism]</span><span>
</span><span id="line-1827"></span><span>             </span><span class="hs-comment">-- e.g  (\r \(a::TYPE r) \(x::a). blah) @LiftedRep @Int arg</span><span>
</span><span id="line-1828"></span><span>             </span><span class="hs-comment">--      When we come to `x=arg` we must choose lazy/strict correctly</span><span>
</span><span id="line-1829"></span><span>             </span><span class="hs-comment">--      It's wrong to err in either direction</span><span>
</span><span id="line-1830"></span><span>             </span><span class="hs-comment">--      But fun_ty is an OutType, so is fully substituted</span><span>
</span><span id="line-1831"></span><span>
</span><span id="line-1832"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">DupFlag -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#isSimplified"><span class="hs-identifier hs-var">isSimplified</span></a></span><span> </span><span class="annot"><span class="annottext">DupFlag
</span><a href="#local-6989586621682979883"><span class="hs-identifier hs-var">dup</span></a></span><span>  </span><span class="hs-comment">-- Don't re-simplify if we've simplified it once</span><span>
</span><span id="line-1833"></span><span>                                </span><span class="hs-comment">-- Including don't preInlineUnconditionally</span><span>
</span><span id="line-1834"></span><span>                                </span><span class="hs-comment">-- See Note [Avoiding simplifying repeatedly]</span><span>
</span><span id="line-1835"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; FromWhat
-&gt; CoreBndr
-&gt; CoreExpr
-&gt; CoreExpr
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#completeBindX"><span class="hs-identifier hs-var">completeBindX</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979877"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">FromWhat
</span><a href="#local-6989586621682979885"><span class="hs-identifier hs-var">from_what</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979878"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979880"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979879"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979882"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1836"></span><span>
</span><span id="line-1837"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682979890"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979890"><span class="hs-identifier hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; TopLevelFlag
-&gt; CoreBndr
-&gt; CoreExpr
-&gt; SimplEnv
-&gt; Maybe SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Utils.html#preInlineUnconditionally"><span class="hs-identifier hs-var">preInlineUnconditionally</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979877"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="GHC.Types.Basic.html#NotTopLevel"><span class="hs-identifier hs-var">NotTopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979878"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979880"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979881"><span class="hs-identifier hs-var">arg_se</span></a></span><span>
</span><span id="line-1838"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Levity -&gt; CoreExpr -&gt; Bool
</span><a href="GHC.Core.Utils.html#needsCaseBindingL"><span class="hs-identifier hs-var">needsCaseBindingL</span></a></span><span> </span><span class="annot"><span class="annottext">Levity
</span><a href="#local-6989586621682979886"><span class="hs-identifier hs-var">arg_levity</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979880"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1839"></span><span>              </span><span class="hs-comment">-- Ok to test arg::InExpr in needsCaseBinding because</span><span>
</span><span id="line-1840"></span><span>              </span><span class="hs-comment">-- exprOkForSpeculation is stable under simplification</span><span>
</span><span id="line-1841"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Tick -&gt; SimplM ()
</span><a href="GHC.Core.Opt.Simplify.Monad.html#tick"><span class="hs-identifier hs-var">tick</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Tick
</span><a href="GHC.Core.Opt.Stats.html#PreInlineUnconditionally"><span class="hs-identifier hs-var">PreInlineUnconditionally</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979878"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1842"></span><span>                  </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplLam"><span class="hs-identifier hs-var">simplLam</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979890"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979879"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979882"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1843"></span><span>
</span><span id="line-1844"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1845"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
SimplEnv
-&gt; FromWhat
-&gt; CoreBndr
-&gt; (CoreExpr, SimplEnv)
-&gt; CoreExpr
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
SimplEnv
-&gt; FromWhat
-&gt; CoreBndr
-&gt; (CoreExpr, SimplEnv)
-&gt; CoreExpr
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplNonRecE"><span class="hs-identifier hs-var">simplNonRecE</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979877"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">FromWhat
</span><a href="#local-6989586621682979885"><span class="hs-identifier hs-var">from_what</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979878"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979880"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979881"><span class="hs-identifier hs-var">arg_se</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979879"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979882"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1846"></span><span>
</span><span id="line-1847"></span><span class="hs-comment">-- Discard a non-counting tick on a lambda.  This may change the</span><span>
</span><span id="line-1848"></span><span class="hs-comment">-- cost attribution slightly (moving the allocation of the</span><span>
</span><span id="line-1849"></span><span class="hs-comment">-- lambda elsewhere), but we don't care: optimisation changes</span><span>
</span><span id="line-1850"></span><span class="hs-comment">-- cost attribution all the time.</span><span>
</span><span id="line-1851"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simpl_lam"><span class="hs-identifier hs-var">simpl_lam</span></a></span><span> </span><span id="local-6989586621682979891"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979891"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979892"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979892"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682979893"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979893"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#TickIt"><span class="hs-identifier hs-type">TickIt</span></a></span><span> </span><span id="local-6989586621682979894"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682979894"><span class="hs-identifier hs-var">tickish</span></a></span></span><span> </span><span id="local-6989586621682979895"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979895"><span class="hs-identifier hs-var">cont</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1852"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishCounts"><span class="hs-identifier hs-var">tickishCounts</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682979894"><span class="hs-identifier hs-var">tickish</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1853"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
SimplEnv
-&gt; CoreBndr
-&gt; CoreExpr
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
SimplEnv
-&gt; CoreBndr
-&gt; CoreExpr
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simpl_lam"><span class="hs-identifier hs-var">simpl_lam</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979891"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979892"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979893"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979895"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-1854"></span><span>
</span><span id="line-1855"></span><span class="hs-comment">-- Not enough args, so there are real lambdas left to put in the result</span><span>
</span><span id="line-1856"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simpl_lam"><span class="hs-identifier hs-var">simpl_lam</span></a></span><span> </span><span id="local-6989586621682979896"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979896"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979897"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979897"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682979898"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979898"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621682979899"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979899"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-1857"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979900"><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682979900"><span class="hs-identifier hs-var hs-var">inner_bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979901"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979901"><span class="hs-identifier hs-var hs-var">inner_body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; ([CoreBndr], CoreExpr)
forall b. Expr b -&gt; ([b], Expr b)
</span><a href="GHC.Core.html#collectBinders"><span class="hs-identifier hs-var">collectBinders</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979898"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-1858"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979903"><span class="annot"><a href="#local-6989586621682979903"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979904"><span class="annot"><a href="#local-6989586621682979904"><span class="hs-identifier hs-var">bndrs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; [CoreBndr] -&gt; SimplM (SimplEnv, [CoreBndr])
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplLamBndrs"><span class="hs-identifier hs-var">simplLamBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979896"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979897"><span class="hs-identifier hs-var">bndr</span></a></span><span class="annot"><span class="annottext">CoreBndr -&gt; [CoreBndr] -&gt; [CoreBndr]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682979900"><span class="hs-identifier hs-var">inner_bndrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1859"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682979905"><span class="annot"><a href="#local-6989586621682979905"><span class="hs-identifier hs-var">body'</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExpr"><span class="hs-identifier hs-type">simplExpr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979903"><span class="hs-identifier hs-type">env'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979901"><span class="hs-identifier hs-type">inner_body</span></a></span><span>
</span><span id="line-1860"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682979906"><span class="annot"><a href="#local-6989586621682979906"><span class="hs-identifier hs-var">new_lam</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#rebuildLam"><span class="hs-identifier hs-type">rebuildLam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979903"><span class="hs-identifier hs-type">env'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979904"><span class="hs-identifier hs-type">bndrs'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979905"><span class="hs-identifier hs-type">body'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979899"><span class="hs-identifier hs-type">cont</span></a></span><span>
</span><span id="line-1861"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuild"><span class="hs-identifier hs-type">rebuild</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979903"><span class="hs-identifier hs-type">env'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979906"><span class="hs-identifier hs-type">new_lam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979899"><span class="hs-identifier hs-type">cont</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1862"></span><span>
</span><span id="line-1863"></span><span class="hs-comment">-------------</span><span>
</span><span id="line-1864"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplLamBndr"><span class="hs-identifier hs-type">simplLamBndr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InBndr"><span class="hs-identifier hs-type">InBndr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutBndr"><span class="hs-identifier hs-type">OutBndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1865"></span><span class="hs-comment">-- Historically this had a special case for when a lambda-binder</span><span>
</span><span id="line-1866"></span><span class="hs-comment">-- could have a stable unfolding;</span><span>
</span><span id="line-1867"></span><span class="hs-comment">-- see Historical Note [Case binders and join points]</span><span>
</span><span id="line-1868"></span><span class="hs-comment">-- But now it is much simpler! We now only remove unfoldings.</span><span>
</span><span id="line-1869"></span><span class="hs-comment">-- See Note [Never put `OtherCon` unfoldings on lambda binders]</span><span>
</span><span id="line-1870"></span><span id="simplLamBndr"><span class="annot"><span class="annottext">simplLamBndr :: SimplEnv -&gt; CoreBndr -&gt; SimplM (SimplEnv, CoreBndr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplLamBndr"><span class="hs-identifier hs-var hs-var">simplLamBndr</span></a></span></span><span> </span><span id="local-6989586621682979908"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979908"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979909"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979909"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; SimplM (SimplEnv, CoreBndr)
</span><a href="GHC.Core.Opt.Simplify.Env.html#simplBinder"><span class="hs-identifier hs-var">simplBinder</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979908"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; CoreBndr
</span><a href="GHC.Types.Id.html#zapIdUnfolding"><span class="hs-identifier hs-var">zapIdUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979909"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1871"></span><span>
</span><span id="line-1872"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplLamBndrs"><span class="hs-identifier hs-type">simplLamBndrs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#InBndr"><span class="hs-identifier hs-type">InBndr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#OutBndr"><span class="hs-identifier hs-type">OutBndr</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1873"></span><span id="simplLamBndrs"><span class="annot"><span class="annottext">simplLamBndrs :: SimplEnv -&gt; [CoreBndr] -&gt; SimplM (SimplEnv, [CoreBndr])
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplLamBndrs"><span class="hs-identifier hs-var hs-var">simplLamBndrs</span></a></span></span><span> </span><span id="local-6989586621682979911"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979911"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979912"><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682979912"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SimplEnv -&gt; CoreBndr -&gt; SimplM (SimplEnv, CoreBndr))
-&gt; SimplEnv -&gt; [CoreBndr] -&gt; SimplM (SimplEnv, [CoreBndr])
forall (m :: * -&gt; *) (t :: * -&gt; *) acc x y.
(Monad m, Traversable t) =&gt;
(acc -&gt; x -&gt; m (acc, y)) -&gt; acc -&gt; t x -&gt; m (acc, t y)
</span><a href="GHC.Utils.Monad.html#mapAccumLM"><span class="hs-identifier hs-var">mapAccumLM</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; SimplM (SimplEnv, CoreBndr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplLamBndr"><span class="hs-identifier hs-var">simplLamBndr</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979911"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682979912"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-1874"></span><span>
</span><span id="line-1875"></span><span class="hs-comment">------------------</span><span>
</span><span id="line-1876"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplNonRecE"><span class="hs-identifier hs-type">simplNonRecE</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span>
</span><span id="line-1877"></span><span>             </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span>
</span><span id="line-1878"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#FromWhat"><span class="hs-identifier hs-type">FromWhat</span></a></span><span>
</span><span id="line-1879"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span>               </span><span class="hs-comment">-- The binder, always an Id</span><span>
</span><span id="line-1880"></span><span>                                   </span><span class="hs-comment">-- Never a join point</span><span>
</span><span id="line-1881"></span><span>                                   </span><span class="hs-comment">-- The static env for its unfolding (if any) is the first parameter</span><span>
</span><span id="line-1882"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Rhs of binding (or arg of lambda)</span><span>
</span><span id="line-1883"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span>             </span><span class="hs-comment">-- Body of the let/lambda</span><span>
</span><span id="line-1884"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-1885"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1886"></span><span>
</span><span id="line-1887"></span><span class="hs-comment">-- simplNonRecE is used for</span><span>
</span><span id="line-1888"></span><span class="hs-comment">--  * from=FromLet:  a non-top-level non-recursive non-join-point let-expression</span><span>
</span><span id="line-1889"></span><span class="hs-comment">--  * from=FromBeta: a binding arising from a beta reduction</span><span>
</span><span id="line-1890"></span><span class="hs-comment">--</span><span>
</span><span id="line-1891"></span><span class="hs-comment">-- simplNonRecE env b (rhs, rhs_se) body k</span><span>
</span><span id="line-1892"></span><span class="hs-comment">--   = let env in</span><span>
</span><span id="line-1893"></span><span class="hs-comment">--     cont&lt; let b = rhs_se(rhs) in body &gt;</span><span>
</span><span id="line-1894"></span><span class="hs-comment">--</span><span>
</span><span id="line-1895"></span><span class="hs-comment">-- It deals with strict bindings, via the StrictBind continuation,</span><span>
</span><span id="line-1896"></span><span class="hs-comment">-- which may abort the whole process.</span><span>
</span><span id="line-1897"></span><span class="hs-comment">--</span><span>
</span><span id="line-1898"></span><span class="hs-comment">-- from_what=FromLet =&gt; the RHS satisfies the let-can-float invariant</span><span>
</span><span id="line-1899"></span><span class="hs-comment">-- Otherwise it may or may not satisfy it.</span><span>
</span><span id="line-1900"></span><span>
</span><span id="line-1901"></span><span id="simplNonRecE"><span class="annot"><span class="annottext">simplNonRecE :: HasDebugCallStack =&gt;
SimplEnv
-&gt; FromWhat
-&gt; CoreBndr
-&gt; (CoreExpr, SimplEnv)
-&gt; CoreExpr
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplNonRecE"><span class="hs-identifier hs-var hs-var">simplNonRecE</span></a></span></span><span> </span><span id="local-6989586621682979921"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979921"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979922"><span class="annot"><span class="annottext">FromWhat
</span><a href="#local-6989586621682979922"><span class="hs-identifier hs-var">from_what</span></a></span></span><span> </span><span id="local-6989586621682979923"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979923"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979924"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979924"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979925"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979925"><span class="hs-identifier hs-var">rhs_se</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682979926"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979926"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621682979927"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979927"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-1902"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979923"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979923"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1903"></span><span>    </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682979928"><span class="hs-identifier hs-var">is_strict_bind</span></a></span><span>
</span><span id="line-1904"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- Evaluate RHS strictly</span><span>
</span><span id="line-1905"></span><span>    </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979925"><span class="hs-identifier hs-var">rhs_se</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplEnv -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#setInScopeFromE"><span class="hs-operator hs-var">`setInScopeFromE`</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979921"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979924"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1906"></span><span>               </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StrictBind"><span class="hs-identifier hs-type">StrictBind</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_bndr :: CoreBndr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_bndr"><span class="hs-identifier hs-var">sc_bndr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979923"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_body :: CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_body"><span class="hs-identifier hs-var">sc_body</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979926"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_from :: FromWhat
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_from"><span class="hs-identifier hs-var">sc_from</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FromWhat
</span><a href="#local-6989586621682979922"><span class="hs-identifier hs-var">from_what</span></a></span><span>
</span><span id="line-1907"></span><span>                           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_env :: SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_env"><span class="hs-identifier hs-var">sc_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979921"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979927"><span class="hs-identifier hs-var">cont</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_dup :: DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_dup"><span class="hs-identifier hs-var">sc_dup</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#NoDup"><span class="hs-identifier hs-var">NoDup</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1908"></span><span>
</span><span id="line-1909"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>  </span><span class="hs-comment">-- Evaluate RHS lazily</span><span>
</span><span id="line-1910"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979929"><span class="annot"><a href="#local-6989586621682979929"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979930"><span class="annot"><a href="#local-6989586621682979930"><span class="hs-identifier hs-var">bndr1</span></a></span></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; SimplM (SimplEnv, CoreBndr)
</span><a href="GHC.Core.Opt.Simplify.Env.html#simplNonRecBndr"><span class="hs-identifier hs-var">simplNonRecBndr</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979921"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979923"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-1911"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979931"><span class="annot"><a href="#local-6989586621682979931"><span class="hs-identifier hs-var">env2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979932"><span class="annot"><a href="#local-6989586621682979932"><span class="hs-identifier hs-var">bndr2</span></a></span></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#addBndrRules"><span class="hs-identifier hs-type">addBndrRules</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979929"><span class="hs-identifier hs-type">env1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979923"><span class="hs-identifier hs-type">bndr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979930"><span class="hs-identifier hs-type">bndr1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BC_Let"><span class="hs-identifier hs-type">BC_Let</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#NotTopLevel"><span class="hs-identifier hs-type">NotTopLevel</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#NonRecursive"><span class="hs-identifier hs-type">NonRecursive</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1912"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979933"><span class="annot"><a href="#local-6989586621682979933"><span class="hs-identifier hs-var">floats1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979934"><span class="annot"><a href="#local-6989586621682979934"><span class="hs-identifier hs-var">env3</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplLazyBind"><span class="hs-identifier hs-type">simplLazyBind</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#NotTopLevel"><span class="hs-identifier hs-type">NotTopLevel</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#NonRecursive"><span class="hs-identifier hs-type">NonRecursive</span></a></span><span>
</span><span id="line-1913"></span><span>                                           </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979923"><span class="hs-identifier hs-type">bndr</span></a></span><span class="hs-special">,</span><span class="annot"><a href="#local-6989586621682979921"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979932"><span class="hs-identifier hs-type">bndr2</span></a></span><span class="hs-special">,</span><span class="annot"><a href="#local-6989586621682979931"><span class="hs-identifier hs-type">env2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979924"><span class="hs-identifier hs-type">rhs</span></a></span><span class="hs-special">,</span><span class="annot"><a href="#local-6989586621682979925"><span class="hs-identifier hs-type">rhs_se</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1914"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979935"><span class="annot"><a href="#local-6989586621682979935"><span class="hs-identifier hs-var">floats2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979936"><span class="annot"><a href="#local-6989586621682979936"><span class="hs-identifier hs-var">expr'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplNonRecBody"><span class="hs-identifier hs-type">simplNonRecBody</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979934"><span class="hs-identifier hs-type">env3</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979922"><span class="hs-identifier hs-type">from_what</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979926"><span class="hs-identifier hs-type">body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979927"><span class="hs-identifier hs-type">cont</span></a></span><span>
</span><span id="line-1915"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979933"><span class="hs-identifier hs-type">floats1</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#addFloats"><span class="hs-operator hs-type">`addFloats`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979935"><span class="hs-identifier hs-type">floats2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682979936"><span class="hs-identifier hs-type">expr'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1916"></span><span>
</span><span id="line-1917"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1918"></span><span>    </span><span id="local-6989586621682979928"><span class="annot"><span class="annottext">is_strict_bind :: Bool
</span><a href="#local-6989586621682979928"><span class="hs-identifier hs-var hs-var">is_strict_bind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">FromWhat
</span><a href="#local-6989586621682979922"><span class="hs-identifier hs-var">from_what</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1919"></span><span>       </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#FromBeta"><span class="hs-identifier hs-type">FromBeta</span></a></span><span> </span><span class="annot"><span class="annottext">Levity
</span><a href="GHC.Types.Basic.html#Unlifted"><span class="hs-identifier hs-var">Unlifted</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1920"></span><span>       </span><span class="hs-comment">-- If we are coming from a beta-reduction (FromBeta) we must</span><span>
</span><span id="line-1921"></span><span>       </span><span class="hs-comment">-- establish the let-can-float invariant, so go via StrictBind</span><span>
</span><span id="line-1922"></span><span>       </span><span class="hs-comment">-- If not, the invariant holds already, and it's optional.</span><span>
</span><span id="line-1923"></span><span>
</span><span id="line-1924"></span><span>       </span><span class="hs-comment">-- (FromBeta Lifted) or FromLet: look at the demand info</span><span>
</span><span id="line-1925"></span><span>       </span><span class="annot"><span class="annottext">FromWhat
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Env.html#seCaseCase"><span class="hs-identifier hs-var">seCaseCase</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979921"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Demand -&gt; Bool
</span><a href="GHC.Types.Demand.html#isStrUsedDmd"><span class="hs-identifier hs-var">isStrUsedDmd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Demand
</span><a href="GHC.Types.Id.html#idDemandInfo"><span class="hs-identifier hs-var">idDemandInfo</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979923"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1926"></span><span>
</span><span id="line-1927"></span><span>
</span><span id="line-1928"></span><span class="hs-comment">------------------</span><span>
</span><span id="line-1929"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplRecE"><span class="hs-identifier hs-type">simplRecE</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span>
</span><span id="line-1930"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-1931"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span>
</span><span id="line-1932"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-1933"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1934"></span><span>
</span><span id="line-1935"></span><span class="hs-comment">-- simplRecE is used for</span><span>
</span><span id="line-1936"></span><span class="hs-comment">--  * non-top-level recursive lets in expressions</span><span>
</span><span id="line-1937"></span><span class="hs-comment">-- Precondition: not a join-point binding</span><span>
</span><span id="line-1938"></span><span id="simplRecE"><span class="annot"><span class="annottext">simplRecE :: SimplEnv
-&gt; [(CoreBndr, CoreExpr)]
-&gt; CoreExpr
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplRecE"><span class="hs-identifier hs-var hs-var">simplRecE</span></a></span></span><span> </span><span id="local-6989586621682979939"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979939"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979940"><span class="annot"><span class="annottext">[(CoreBndr, CoreExpr)]
</span><a href="#local-6989586621682979940"><span class="hs-identifier hs-var">pairs</span></a></span></span><span> </span><span id="local-6989586621682979941"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979941"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621682979942"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979942"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-1939"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682979943"><span class="annot"><span class="annottext">bndrs :: [CoreBndr]
</span><a href="#local-6989586621682979943"><span class="hs-identifier hs-var hs-var hs-var">bndrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((CoreBndr, CoreExpr) -&gt; CoreBndr)
-&gt; [(CoreBndr, CoreExpr)] -&gt; [CoreBndr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(CoreBndr, CoreExpr) -&gt; CoreBndr
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(CoreBndr, CoreExpr)]
</span><a href="#local-6989586621682979940"><span class="hs-identifier hs-var">pairs</span></a></span><span>
</span><span id="line-1940"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SimplM ()
forall (m :: * -&gt; *). (HasCallStack, Applicative m) =&gt; Bool -&gt; m ()
</span><a href="GHC.Utils.Panic.Plain.html#massert"><span class="hs-identifier hs-var">massert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CoreBndr -&gt; Bool) -&gt; [CoreBndr] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; (CoreBndr -&gt; Bool) -&gt; CoreBndr -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682979943"><span class="hs-identifier hs-var">bndrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1941"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682979947"><span class="annot"><a href="#local-6989586621682979947"><span class="hs-identifier hs-var">env1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; [CoreBndr] -&gt; SimplM SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#simplRecBndrs"><span class="hs-identifier hs-var">simplRecBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979939"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682979943"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-1942"></span><span>                </span><span class="hs-comment">-- NB: bndrs' don't have unfoldings or rules</span><span>
</span><span id="line-1943"></span><span>                </span><span class="hs-comment">-- We add them as we go down</span><span>
</span><span id="line-1944"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979948"><span class="annot"><a href="#local-6989586621682979948"><span class="hs-identifier hs-var">floats1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979949"><span class="annot"><a href="#local-6989586621682979949"><span class="hs-identifier hs-var">env2</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplRecBind"><span class="hs-identifier hs-type">simplRecBind</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979947"><span class="hs-identifier hs-type">env1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BC_Let"><span class="hs-identifier hs-type">BC_Let</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#NotTopLevel"><span class="hs-identifier hs-type">NotTopLevel</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Recursive"><span class="hs-identifier hs-type">Recursive</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682979940"><span class="hs-identifier hs-type">pairs</span></a></span><span>
</span><span id="line-1945"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979950"><span class="annot"><a href="#local-6989586621682979950"><span class="hs-identifier hs-var">floats2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979951"><span class="annot"><a href="#local-6989586621682979951"><span class="hs-identifier hs-var">expr'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF"><span class="hs-identifier hs-type">simplExprF</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979949"><span class="hs-identifier hs-type">env2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979941"><span class="hs-identifier hs-type">body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979942"><span class="hs-identifier hs-type">cont</span></a></span><span>
</span><span id="line-1946"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979948"><span class="hs-identifier hs-type">floats1</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#addFloats"><span class="hs-operator hs-type">`addFloats`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979950"><span class="hs-identifier hs-type">floats2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682979951"><span class="hs-identifier hs-type">expr'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1947"></span><span>
</span><span id="line-1948"></span><span class="hs-comment">{- Note [Dark corner with representation polymorphism]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In `simplNonRecE`, the call to `needsCaseBinding` or to `isStrictId` will fail
if the binder does not have a fixed runtime representation, e.g. if it is of kind (TYPE r).
So we are careful to call `isStrictId` on the OutId, not the InId, in case we have
     ((\(r::RuntimeRep) \(x::TYPE r). blah) Lifted arg)
That will lead to `simplNonRecE env (x::TYPE r) arg`, and we can't tell
if x is lifted or unlifted from that.

We only get such redexes from the compulsory inlining of a wired-in,
representation-polymorphic function like `rightSection` (see
GHC.Types.Id.Make).  Mind you, SimpleOpt should probably have inlined
such compulsory inlinings already, but belt and braces does no harm.

Plus, it turns out that GHC.Driver.Main.hscCompileCoreExpr calls the
Simplifier without first calling SimpleOpt, so anything involving
GHCi or TH and operator sections will fall over if we don't take
care here.

Note [Avoiding simplifying repeatedly]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
One way in which we can get exponential behaviour is if we simplify a
big expression, and then re-simplify it -- and then this happens in a
deeply-nested way.  So we must be jolly careful about re-simplifying
an expression (#13379).

Example:
  f BIG, where f has a RULE
Then
 * We simplify BIG before trying the rule; but the rule does not fire
   (forcing this simplification is why we have the RULE in this example)
 * We inline f = \x. g x, in `simpl_lam`
 * So if `simpl_lam` did preInlineUnconditionally we get (g BIG)
 * Now if g has a RULE we'll simplify BIG again, and this whole thing can
   iterate.
 * However, if `f` did not have a RULE, so that BIG has /not/ already been
   simplified, we /want/ to do preInlineUnconditionally in simpl_lam.

So we go to some effort to avoid repeatedly simplifying the same thing:

* ApplyToVal has a (sc_dup :: DupFlag) field which records if the argument
  has been evaluated.

* simplArg checks this flag to avoid re-simplifying.

* simpl_lam has:
    - a case for (isSimplified dup), which goes via completeBindX, and
    - a case for an un-simplified argument, which tries preInlineUnconditionally

* We go to some efforts to avoid unnecessarily simplifying ApplyToVal,
  in at least two places
    - In simplCast/addCoerce, where we check for isReflCo
    - In rebuildCall we avoid simplifying arguments before we have to
      (see Note [Trying rewrite rules])

All that said /postInlineUnconditionally/ (called in `completeBind`) does
fire in the above (f BIG) situation.  See Note [Post-inline for single-use
things] in Simplify.Utils.  This certainly risks repeated simplification, but
in practice seems to be a small win.


************************************************************************
*                                                                      *
                     Join points
*                                                                      *
********************************************************************* -}</span><span>
</span><span id="line-2014"></span><span>
</span><span id="line-2015"></span><span class="hs-comment">{- Note [Rules and unfolding for join points]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have

   simplExpr (join j x = rhs                         ) cont
             (      {- RULE j (p:ps) = blah -}       )
             (      {- StableUnfolding j = blah -}   )
             (in blah                                )

Then we will push 'cont' into the rhs of 'j'.  But we should *also* push
'cont' into the RHS of
  * Any RULEs for j, e.g. generated by SpecConstr
  * Any stable unfolding for j, e.g. the result of an INLINE pragma

Simplifying rules and stable-unfoldings happens a bit after
simplifying the right-hand side, so we remember whether or not it
is a join point, and what 'cont' is, in a value of type MaybeJoinCont

#13900 was caused by forgetting to push 'cont' into the RHS
of a SpecConstr-generated RULE for a join point.
-}</span><span>
</span><span id="line-2036"></span><span>
</span><span id="line-2037"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplNonRecJoinPoint"><span class="hs-identifier hs-type">simplNonRecJoinPoint</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span>
</span><span id="line-2038"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-2039"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2040"></span><span id="simplNonRecJoinPoint"><span class="annot"><span class="annottext">simplNonRecJoinPoint :: SimplEnv
-&gt; CoreBndr
-&gt; CoreExpr
-&gt; CoreExpr
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplNonRecJoinPoint"><span class="hs-identifier hs-var hs-var">simplNonRecJoinPoint</span></a></span></span><span> </span><span id="local-6989586621682979952"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979952"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979953"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979953"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682979954"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979954"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span id="local-6989586621682979955"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979955"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621682979956"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979956"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-2041"></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; SimplM (SimplFloats, CoreExpr) -&gt; SimplM (SimplFloats, CoreExpr)
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979953"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SimplM (SimplFloats, CoreExpr) -&gt; SimplM (SimplFloats, CoreExpr))
-&gt; SimplM (SimplFloats, CoreExpr) -&gt; SimplM (SimplFloats, CoreExpr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2042"></span><span>     </span><span class="annot"><span class="annottext">SimplEnv
-&gt; SimplCont
-&gt; (SimplEnv -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr))
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#wrapJoinCont"><span class="hs-identifier hs-var">wrapJoinCont</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979952"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979956"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="annot"><span class="annottext">((SimplEnv -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr))
 -&gt; SimplM (SimplFloats, CoreExpr))
-&gt; (SimplEnv -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr))
-&gt; SimplM (SimplFloats, CoreExpr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621682979958"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979958"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979959"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979959"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2043"></span><span>     </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- We push join_cont into the join RHS and the body;</span><span>
</span><span id="line-2044"></span><span>          </span><span class="hs-comment">-- and wrap wrap_cont around the whole thing</span><span>
</span><span id="line-2045"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682979960"><span class="annot"><span class="annottext">mult :: Kind
</span><a href="#local-6989586621682979960"><span class="hs-identifier hs-var hs-var hs-var">mult</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleScaling"><span class="hs-identifier hs-var">contHoleScaling</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979959"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-2046"></span><span>              </span><span id="local-6989586621682979961"><span class="annot"><span class="annottext">res_ty :: Kind
</span><a href="#local-6989586621682979961"><span class="hs-identifier hs-var hs-var hs-var">res_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979959"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-2047"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979962"><span class="annot"><a href="#local-6989586621682979962"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979963"><span class="annot"><a href="#local-6989586621682979963"><span class="hs-identifier hs-var">bndr1</span></a></span></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; Kind -&gt; Kind -&gt; SimplM (SimplEnv, CoreBndr)
</span><a href="GHC.Core.Opt.Simplify.Env.html#simplNonRecJoinBndr"><span class="hs-identifier hs-var">simplNonRecJoinBndr</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979958"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682979953"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979960"><span class="hs-identifier hs-var">mult</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979961"><span class="hs-identifier hs-var">res_ty</span></a></span><span>
</span><span id="line-2048"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979965"><span class="annot"><a href="#local-6989586621682979965"><span class="hs-identifier hs-var">env2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979966"><span class="annot"><a href="#local-6989586621682979966"><span class="hs-identifier hs-var">bndr2</span></a></span></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#addBndrRules"><span class="hs-identifier hs-type">addBndrRules</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979962"><span class="hs-identifier hs-type">env1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979953"><span class="hs-identifier hs-type">bndr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979963"><span class="hs-identifier hs-type">bndr1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BC_Join"><span class="hs-identifier hs-type">BC_Join</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#NonRecursive"><span class="hs-identifier hs-type">NonRecursive</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979959"><span class="hs-identifier hs-type">cont</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2049"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979967"><span class="annot"><a href="#local-6989586621682979967"><span class="hs-identifier hs-var">floats1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979968"><span class="annot"><a href="#local-6989586621682979968"><span class="hs-identifier hs-var">env3</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplJoinBind"><span class="hs-identifier hs-type">simplJoinBind</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#NonRecursive"><span class="hs-identifier hs-type">NonRecursive</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979959"><span class="hs-identifier hs-type">cont</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979953"><span class="hs-identifier hs-type">bndr</span></a></span><span class="hs-special">,</span><span class="annot"><a href="#local-6989586621682979958"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979966"><span class="hs-identifier hs-type">bndr2</span></a></span><span class="hs-special">,</span><span class="annot"><a href="#local-6989586621682979965"><span class="hs-identifier hs-type">env2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979954"><span class="hs-identifier hs-type">rhs</span></a></span><span class="hs-special">,</span><span class="annot"><a href="#local-6989586621682979958"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2050"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979969"><span class="annot"><a href="#local-6989586621682979969"><span class="hs-identifier hs-var">floats2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979970"><span class="annot"><a href="#local-6989586621682979970"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF"><span class="hs-identifier hs-type">simplExprF</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979968"><span class="hs-identifier hs-type">env3</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979955"><span class="hs-identifier hs-type">body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979959"><span class="hs-identifier hs-type">cont</span></a></span><span>
</span><span id="line-2051"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979967"><span class="hs-identifier hs-type">floats1</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#addFloats"><span class="hs-operator hs-type">`addFloats`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979969"><span class="hs-identifier hs-type">floats2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682979970"><span class="hs-identifier hs-type">body'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2052"></span><span>
</span><span id="line-2053"></span><span>
</span><span id="line-2054"></span><span class="hs-comment">------------------</span><span>
</span><span id="line-2055"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplRecJoinPoint"><span class="hs-identifier hs-type">simplRecJoinPoint</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-2056"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-2057"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2058"></span><span id="simplRecJoinPoint"><span class="annot"><span class="annottext">simplRecJoinPoint :: SimplEnv
-&gt; [(CoreBndr, CoreExpr)]
-&gt; CoreExpr
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplRecJoinPoint"><span class="hs-identifier hs-var hs-var">simplRecJoinPoint</span></a></span></span><span> </span><span id="local-6989586621682979971"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979971"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979972"><span class="annot"><span class="annottext">[(CoreBndr, CoreExpr)]
</span><a href="#local-6989586621682979972"><span class="hs-identifier hs-var">pairs</span></a></span></span><span> </span><span id="local-6989586621682979973"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682979973"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621682979974"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979974"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-2059"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; SimplCont
-&gt; (SimplEnv -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr))
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#wrapJoinCont"><span class="hs-identifier hs-var">wrapJoinCont</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979971"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979974"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="annot"><span class="annottext">((SimplEnv -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr))
 -&gt; SimplM (SimplFloats, CoreExpr))
-&gt; (SimplEnv -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr))
-&gt; SimplM (SimplFloats, CoreExpr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621682979975"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979975"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979976"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979976"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2060"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682979977"><span class="annot"><span class="annottext">bndrs :: [CoreBndr]
</span><a href="#local-6989586621682979977"><span class="hs-identifier hs-var hs-var hs-var">bndrs</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((CoreBndr, CoreExpr) -&gt; CoreBndr)
-&gt; [(CoreBndr, CoreExpr)] -&gt; [CoreBndr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(CoreBndr, CoreExpr) -&gt; CoreBndr
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(CoreBndr, CoreExpr)]
</span><a href="#local-6989586621682979972"><span class="hs-identifier hs-var">pairs</span></a></span><span>
</span><span id="line-2061"></span><span>             </span><span id="local-6989586621682979978"><span class="annot"><span class="annottext">mult :: Kind
</span><a href="#local-6989586621682979978"><span class="hs-identifier hs-var hs-var hs-var">mult</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleScaling"><span class="hs-identifier hs-var">contHoleScaling</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979976"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-2062"></span><span>             </span><span id="local-6989586621682979979"><span class="annot"><span class="annottext">res_ty :: Kind
</span><a href="#local-6989586621682979979"><span class="hs-identifier hs-var hs-var hs-var">res_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979976"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-2063"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682979980"><span class="annot"><a href="#local-6989586621682979980"><span class="hs-identifier hs-var">env1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; [CoreBndr] -&gt; Kind -&gt; Kind -&gt; SimplM SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#simplRecJoinBndrs"><span class="hs-identifier hs-var">simplRecJoinBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979975"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682979977"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979978"><span class="hs-identifier hs-var">mult</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682979979"><span class="hs-identifier hs-var">res_ty</span></a></span><span>
</span><span id="line-2064"></span><span>               </span><span class="hs-comment">-- NB: bndrs' don't have unfoldings or rules</span><span>
</span><span id="line-2065"></span><span>               </span><span class="hs-comment">-- We add them as we go down</span><span>
</span><span id="line-2066"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979982"><span class="annot"><a href="#local-6989586621682979982"><span class="hs-identifier hs-var">floats1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979983"><span class="annot"><a href="#local-6989586621682979983"><span class="hs-identifier hs-var">env2</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplRecBind"><span class="hs-identifier hs-type">simplRecBind</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979980"><span class="hs-identifier hs-type">env1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BC_Join"><span class="hs-identifier hs-type">BC_Join</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Recursive"><span class="hs-identifier hs-type">Recursive</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979976"><span class="hs-identifier hs-type">cont</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682979972"><span class="hs-identifier hs-type">pairs</span></a></span><span>
</span><span id="line-2067"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979984"><span class="annot"><a href="#local-6989586621682979984"><span class="hs-identifier hs-var">floats2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979985"><span class="annot"><a href="#local-6989586621682979985"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF"><span class="hs-identifier hs-type">simplExprF</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979983"><span class="hs-identifier hs-type">env2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979973"><span class="hs-identifier hs-type">body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979976"><span class="hs-identifier hs-type">cont</span></a></span><span>
</span><span id="line-2068"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979982"><span class="hs-identifier hs-type">floats1</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#addFloats"><span class="hs-operator hs-type">`addFloats`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979984"><span class="hs-identifier hs-type">floats2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682979985"><span class="hs-identifier hs-type">body'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2069"></span><span>
</span><span id="line-2070"></span><span class="hs-comment">--------------------</span><span>
</span><span id="line-2071"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#wrapJoinCont"><span class="hs-identifier hs-type">wrapJoinCont</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-2072"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2073"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2074"></span><span class="hs-comment">-- Deal with making the continuation duplicable if necessary,</span><span>
</span><span id="line-2075"></span><span class="hs-comment">-- and with the no-case-of-case situation.</span><span>
</span><span id="line-2076"></span><span id="wrapJoinCont"><span class="annot"><span class="annottext">wrapJoinCont :: SimplEnv
-&gt; SimplCont
-&gt; (SimplEnv -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr))
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#wrapJoinCont"><span class="hs-identifier hs-var hs-var">wrapJoinCont</span></a></span></span><span> </span><span id="local-6989586621682979986"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979986"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682979987"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979987"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span id="local-6989586621682979988"><span class="annot"><span class="annottext">SimplEnv -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="#local-6989586621682979988"><span class="hs-identifier hs-var">thing_inside</span></a></span></span><span>
</span><span id="line-2077"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contIsStop"><span class="hs-identifier hs-var">contIsStop</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979987"><span class="hs-identifier hs-var">cont</span></a></span><span>        </span><span class="hs-comment">-- Common case; no need for fancy footwork</span><span>
</span><span id="line-2078"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="#local-6989586621682979988"><span class="hs-identifier hs-var">thing_inside</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979986"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979987"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-2079"></span><span>
</span><span id="line-2080"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Env.html#seCaseCase"><span class="hs-identifier hs-var">seCaseCase</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979986"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2081"></span><span>    </span><span class="hs-comment">-- See Note [Join points with -fno-case-of-case]</span><span>
</span><span id="line-2082"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979990"><span class="annot"><a href="#local-6989586621682979990"><span class="hs-identifier hs-var">floats1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979991"><span class="annot"><a href="#local-6989586621682979991"><span class="hs-identifier hs-var">expr1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="#local-6989586621682979988"><span class="hs-identifier hs-var">thing_inside</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979986"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Kind -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#mkBoringStop"><span class="hs-identifier hs-var">mkBoringStop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplCont -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleType"><span class="hs-identifier hs-var">contHoleType</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979987"><span class="hs-identifier hs-var">cont</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2083"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979992"><span class="annot"><a href="#local-6989586621682979992"><span class="hs-identifier hs-var">floats2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979993"><span class="annot"><a href="#local-6989586621682979993"><span class="hs-identifier hs-var">expr2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#wrapJoinFloatsX"><span class="hs-identifier hs-type">wrapJoinFloatsX</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979990"><span class="hs-identifier hs-type">floats1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979991"><span class="hs-identifier hs-type">expr1</span></a></span><span>
</span><span id="line-2084"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979994"><span class="annot"><a href="#local-6989586621682979994"><span class="hs-identifier hs-var">floats3</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979995"><span class="annot"><a href="#local-6989586621682979995"><span class="hs-identifier hs-var">expr3</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuild"><span class="hs-identifier hs-type">rebuild</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979986"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#setInScopeFromF"><span class="hs-operator hs-type">`setInScopeFromF`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979992"><span class="hs-identifier hs-type">floats2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682979993"><span class="hs-identifier hs-type">expr2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979987"><span class="hs-identifier hs-type">cont</span></a></span><span>
</span><span id="line-2085"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979992"><span class="hs-identifier hs-type">floats2</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#addFloats"><span class="hs-operator hs-type">`addFloats`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979994"><span class="hs-identifier hs-type">floats3</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682979995"><span class="hs-identifier hs-type">expr3</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2086"></span><span>
</span><span id="line-2087"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2088"></span><span>    </span><span class="hs-comment">-- Normal case; see Note [Join points and case-of-case]</span><span>
</span><span id="line-2089"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979996"><span class="annot"><a href="#local-6989586621682979996"><span class="hs-identifier hs-var">floats1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682979997"><span class="annot"><a href="#local-6989586621682979997"><span class="hs-identifier hs-var">cont'</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplCont -&gt; SimplM (SimplFloats, SimplCont)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#mkDupableCont"><span class="hs-identifier hs-var">mkDupableCont</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682979986"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682979987"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-2090"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682979999"><span class="annot"><a href="#local-6989586621682979999"><span class="hs-identifier hs-var">floats2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980000"><span class="annot"><a href="#local-6989586621682980000"><span class="hs-identifier hs-var">result</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621682979988"><span class="hs-identifier hs-type">thing_inside</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979986"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#setInScopeFromF"><span class="hs-operator hs-type">`setInScopeFromF`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979996"><span class="hs-identifier hs-type">floats1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682979997"><span class="hs-identifier hs-type">cont'</span></a></span><span>
</span><span id="line-2091"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682979996"><span class="hs-identifier hs-type">floats1</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#addFloats"><span class="hs-operator hs-type">`addFloats`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682979999"><span class="hs-identifier hs-type">floats2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682980000"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2092"></span><span>
</span><span id="line-2093"></span><span>
</span><span id="line-2094"></span><span class="hs-comment">--------------------</span><span>
</span><span id="line-2095"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#trimJoinCont"><span class="hs-identifier hs-type">trimJoinCont</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>         </span><span class="hs-comment">-- Used only in error message</span><span>
</span><span id="line-2096"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#JoinPointHood"><span class="hs-identifier hs-type">JoinPointHood</span></a></span><span>
</span><span id="line-2097"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-2098"></span><span class="hs-comment">-- Drop outer context from join point invocation (jump)</span><span>
</span><span id="line-2099"></span><span class="hs-comment">-- See Note [Join points and case-of-case]</span><span>
</span><span id="line-2100"></span><span>
</span><span id="line-2101"></span><span id="trimJoinCont"><span class="annot"><span class="annottext">trimJoinCont :: CoreBndr -&gt; JoinPointHood -&gt; SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#trimJoinCont"><span class="hs-identifier hs-var hs-var">trimJoinCont</span></a></span></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">JoinPointHood
</span><a href="GHC.Utils.Outputable.html#NotJoinPoint"><span class="hs-identifier hs-var">NotJoinPoint</span></a></span><span> </span><span id="local-6989586621682980002"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980002"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-2102"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980002"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="hs-comment">-- Not a jump</span><span>
</span><span id="line-2103"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#trimJoinCont"><span class="hs-identifier hs-var">trimJoinCont</span></a></span><span> </span><span id="local-6989586621682980003"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980003"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#JoinPoint"><span class="hs-identifier hs-type">JoinPoint</span></a></span><span> </span><span id="local-6989586621682980004"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682980004"><span class="hs-identifier hs-var">arity</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682980005"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980005"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-2104"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; SimplCont -&gt; SimplCont
</span><a href="#local-6989586621682980006"><span class="hs-identifier hs-var">trim</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682980004"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980005"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-2105"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2106"></span><span>    </span><span id="local-6989586621682980006"><span class="annot"><span class="annottext">trim :: Int -&gt; SimplCont -&gt; SimplCont
</span><a href="#local-6989586621682980006"><span class="hs-identifier hs-var hs-var">trim</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span id="local-6989586621682980007"><span class="annot"><span class="annottext">cont :: SimplCont
</span><a href="#local-6989586621682980007"><span class="hs-identifier hs-var">cont</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#Stop"><span class="hs-identifier hs-type">Stop</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2107"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980007"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-2108"></span><span>    </span><span class="annot"><a href="#local-6989586621682980006"><span class="hs-identifier hs-var">trim</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span id="local-6989586621682980008"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980008"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-2109"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Kind -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#mkBoringStop"><span class="hs-identifier hs-var">mkBoringStop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplCont -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980008"><span class="hs-identifier hs-var">cont</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2110"></span><span>    </span><span class="annot"><a href="#local-6989586621682980006"><span class="hs-identifier hs-var">trim</span></a></span><span> </span><span id="local-6989586621682980009"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682980009"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621682980010"><span class="annot"><span class="annottext">cont :: SimplCont
</span><a href="#local-6989586621682980010"><span class="hs-identifier hs-var">cont</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToVal"><span class="hs-identifier hs-type">ApplyToVal</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980011"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980011"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2111"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980010"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682980006"><span class="hs-identifier hs-type">trim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682980009"><span class="hs-identifier hs-type">n</span></a></span><span class="annot"><span class="hs-glyph hs-type">-</span></span><span class="annot"><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682980011"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2112"></span><span>    </span><span class="annot"><a href="#local-6989586621682980006"><span class="hs-identifier hs-var">trim</span></a></span><span> </span><span id="local-6989586621682980012"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682980012"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621682980013"><span class="annot"><span class="annottext">cont :: SimplCont
</span><a href="#local-6989586621682980013"><span class="hs-identifier hs-var">cont</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToTy"><span class="hs-identifier hs-type">ApplyToTy</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980014"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980014"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2113"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980013"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682980006"><span class="hs-identifier hs-type">trim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682980012"><span class="hs-identifier hs-type">n</span></a></span><span class="annot"><span class="hs-glyph hs-type">-</span></span><span class="annot"><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682980014"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-comment">-- join arity counts types!</span><span>
</span><span id="line-2114"></span><span>    </span><span class="annot"><a href="#local-6989586621682980006"><span class="hs-identifier hs-var">trim</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682980015"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980015"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-2115"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; SimplCont
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;completeCall&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; SimplCont) -&gt; SDoc -&gt; SimplCont
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980003"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980015"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-2116"></span><span>
</span><span id="line-2117"></span><span>
</span><span id="line-2118"></span><span class="hs-comment">{- Note [Join points and case-of-case]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we perform the case-of-case transform (or otherwise push continuations
inward), we want to treat join points specially. Since they're always
tail-called and we want to maintain this invariant, we can do this (for any
evaluation context E):

  E[join j = e
    in case ... of
         A -&gt; jump j 1
         B -&gt; jump j 2
         C -&gt; f 3]

    --&gt;

  join j = E[e]
  in case ... of
       A -&gt; jump j 1
       B -&gt; jump j 2
       C -&gt; E[f 3]

As is evident from the example, there are two components to this behavior:

  1. When entering the RHS of a join point, copy the context inside.
  2. When a join point is invoked, discard the outer context.

We need to be very careful here to remain consistent---neither part is
optional!

We need do make the continuation E duplicable (since we are duplicating it)
with mkDupableCont.


Note [Join points with -fno-case-of-case]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Supose case-of-case is switched off, and we are simplifying

    case (join j x = &lt;j-rhs&gt; in
          case y of
             A -&gt; j 1
             B -&gt; j 2
             C -&gt; e) of &lt;outer-alts&gt;

Usually, we'd push the outer continuation (case . of &lt;outer-alts&gt;) into
both the RHS and the body of the join point j.  But since we aren't doing
case-of-case we may then end up with this totally bogus result

    join x = case &lt;j-rhs&gt; of &lt;outer-alts&gt; in
    case (case y of
             A -&gt; j 1
             B -&gt; j 2
             C -&gt; e) of &lt;outer-alts&gt;

This would be OK in the language of the paper, but not in GHC: j is no longer
a join point.  We can only do the &quot;push continuation into the RHS of the
join point j&quot; if we also push the continuation right down to the /jumps/ to
j, so that it can evaporate there.  If we are doing case-of-case, we'll get to

    join x = case &lt;j-rhs&gt; of &lt;outer-alts&gt; in
    case y of
      A -&gt; j 1
      B -&gt; j 2
      C -&gt; case e of &lt;outer-alts&gt;

which is great.

Bottom line: if case-of-case is off, we must stop pushing the continuation
inwards altogether at any join point.  Instead simplify the (join ... in ...)
with a Stop continuation, and wrap the original continuation around the
outside.  Surprisingly tricky!


************************************************************************
*                                                                      *
                     Variables
*                                                                      *
************************************************************************

Note [zapSubstEnv]
~~~~~~~~~~~~~~~~~~
When simplifying something that has already been simplified, be sure to
zap the SubstEnv.  This is VITAL.  Consider
     let x = e in
     let y = \z -&gt; ...x... in
     \ x -&gt; ...y...

We'll clone the inner \x, adding x-&gt;x' in the id_subst Then when we
inline y, we must *not* replace x by x' in the inlined copy!!

Note [Fast path for data constructors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For applications of a data constructor worker, the full glory of
rebuildCall is a waste of effort;
* They never inline, obviously
* They have no rewrite rules
* They are not strict (see Note [Data-con worker strictness]
  in GHC.Core.DataCon)
So it's fine to zoom straight to `rebuild` which just rebuilds the
call in a very straightforward way.

Some programs have a /lot/ of data constructors in the source program
(compiler/perf/T9961 is an example), so this fast path can be very
valuable.
-}</span><span>
</span><span id="line-2222"></span><span>
</span><span id="line-2223"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplVar"><span class="hs-identifier hs-type">simplVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InVar"><span class="hs-identifier hs-type">InVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>
</span><span id="line-2224"></span><span class="hs-comment">-- Look up an InVar in the environment</span><span>
</span><span id="line-2225"></span><span id="simplVar"><span class="annot"><span class="annottext">simplVar :: SimplEnv -&gt; CoreBndr -&gt; SimplM CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplVar"><span class="hs-identifier hs-var hs-var">simplVar</span></a></span></span><span> </span><span id="local-6989586621682980019"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980019"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980020"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980020"><span class="hs-identifier hs-var">var</span></a></span></span><span>
</span><span id="line-2226"></span><span>  </span><span class="hs-comment">-- Why $! ? See Note [Bangs in the Simplifier]</span><span>
</span><span id="line-2227"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980020"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; SimplM CoreExpr
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; SimplM CoreExpr) -&gt; CoreExpr -&gt; SimplM CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">Kind -&gt; CoreExpr
forall b. Kind -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">(Kind -&gt; CoreExpr) -&gt; Kind -&gt; CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Env.html#substTyVar"><span class="hs-identifier hs-var">substTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980019"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980020"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2228"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980020"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; SimplM CoreExpr
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; SimplM CoreExpr) -&gt; CoreExpr -&gt; SimplM CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">CoercionR -&gt; CoreExpr
forall b. CoercionR -&gt; Expr b
</span><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a></span><span> </span><span class="annot"><span class="annottext">(CoercionR -&gt; CoreExpr) -&gt; CoercionR -&gt; CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; CoercionR
</span><a href="GHC.Core.Opt.Simplify.Env.html#substCoVar"><span class="hs-identifier hs-var">substCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980019"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980020"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2229"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2230"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; SimplSR
</span><a href="GHC.Core.Opt.Simplify.Env.html#substId"><span class="hs-identifier hs-var">substId</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980019"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980020"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2231"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#ContEx"><span class="hs-identifier hs-type">ContEx</span></a></span><span> </span><span id="local-6989586621682980025"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621682980025"><span class="hs-identifier hs-var">tvs</span></a></span></span><span> </span><span id="local-6989586621682980026"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621682980026"><span class="hs-identifier hs-var">cvs</span></a></span></span><span> </span><span id="local-6989586621682980027"><span class="annot"><span class="annottext">SimplIdSubst
</span><a href="#local-6989586621682980027"><span class="hs-identifier hs-var">ids</span></a></span></span><span> </span><span id="local-6989586621682980028"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980028"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682980029"><span class="annot"><span class="annottext">env' :: SimplEnv
</span><a href="#local-6989586621682980029"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; TvSubstEnv -&gt; CvSubstEnv -&gt; SimplIdSubst -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#setSubstEnv"><span class="hs-identifier hs-var">setSubstEnv</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980019"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621682980025"><span class="hs-identifier hs-var">tvs</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621682980026"><span class="hs-identifier hs-var">cvs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplIdSubst
</span><a href="#local-6989586621682980027"><span class="hs-identifier hs-var">ids</span></a></span><span>
</span><span id="line-2232"></span><span>                                </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplM CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExpr"><span class="hs-identifier hs-var">simplExpr</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980029"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980028"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-2233"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#DoneId"><span class="hs-identifier hs-type">DoneId</span></a></span><span> </span><span id="local-6989586621682980031"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980031"><span class="hs-identifier hs-var">var1</span></a></span></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; SimplM CoreExpr
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; CoreExpr
forall b. CoreBndr -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980031"><span class="hs-identifier hs-var">var1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2234"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#DoneEx"><span class="hs-identifier hs-type">DoneEx</span></a></span><span> </span><span id="local-6989586621682980032"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980032"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">JoinPointHood
</span><span class="hs-identifier">_</span></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; SimplM CoreExpr
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980032"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-2235"></span><span>
</span><span id="line-2236"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplIdF"><span class="hs-identifier hs-type">simplIdF</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2237"></span><span id="simplIdF"><span class="annot"><span class="annottext">simplIdF :: SimplEnv -&gt; CoreBndr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplIdF"><span class="hs-identifier hs-var hs-var">simplIdF</span></a></span></span><span> </span><span id="local-6989586621682980033"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980033"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980034"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980034"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span id="local-6989586621682980035"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980035"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-2238"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Id.html#isDataConWorkId"><span class="hs-identifier hs-var">isDataConWorkId</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980034"><span class="hs-identifier hs-var">var</span></a></span><span>         </span><span class="hs-comment">-- See Note [Fast path for data constructors]</span><span>
</span><span id="line-2239"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuild"><span class="hs-identifier hs-var">rebuild</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980033"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; CoreExpr
forall b. CoreBndr -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980034"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980035"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-2240"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2241"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; SimplSR
</span><a href="GHC.Core.Opt.Simplify.Env.html#substId"><span class="hs-identifier hs-var">substId</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980033"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980034"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2242"></span><span>      </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#ContEx"><span class="hs-identifier hs-type">ContEx</span></a></span><span> </span><span id="local-6989586621682980037"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621682980037"><span class="hs-identifier hs-var">tvs</span></a></span></span><span> </span><span id="local-6989586621682980038"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621682980038"><span class="hs-identifier hs-var">cvs</span></a></span></span><span> </span><span id="local-6989586621682980039"><span class="annot"><span class="annottext">SimplIdSubst
</span><a href="#local-6989586621682980039"><span class="hs-identifier hs-var">ids</span></a></span></span><span> </span><span id="local-6989586621682980040"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980040"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980041"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980040"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980035"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-2243"></span><span>        </span><span class="hs-comment">-- Don't trimJoinCont; haven't already simplified e,</span><span>
</span><span id="line-2244"></span><span>        </span><span class="hs-comment">-- so the cont is not embodied in e</span><span>
</span><span id="line-2245"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-2246"></span><span>          </span><span id="local-6989586621682980041"><span class="annot"><span class="annottext">env' :: SimplEnv
</span><a href="#local-6989586621682980041"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; TvSubstEnv -&gt; CvSubstEnv -&gt; SimplIdSubst -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#setSubstEnv"><span class="hs-identifier hs-var">setSubstEnv</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980033"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621682980037"><span class="hs-identifier hs-var">tvs</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621682980038"><span class="hs-identifier hs-var">cvs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplIdSubst
</span><a href="#local-6989586621682980039"><span class="hs-identifier hs-var">ids</span></a></span><span>
</span><span id="line-2247"></span><span>
</span><span id="line-2248"></span><span>      </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#DoneId"><span class="hs-identifier hs-type">DoneId</span></a></span><span> </span><span id="local-6989586621682980042"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980042"><span class="hs-identifier hs-var">var1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2249"></span><span>        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682980043"><span class="annot"><a href="#local-6989586621682980043"><span class="hs-identifier hs-var">rule_base</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplM RuleEnv
</span><a href="GHC.Core.Opt.Simplify.Monad.html#getSimplRules"><span class="hs-identifier hs-var">getSimplRules</span></a></span><span>
</span><span id="line-2250"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682980045"><span class="annot"><a href="#local-6989586621682980045"><span class="hs-identifier hs-var hs-var">cont'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; JoinPointHood -&gt; SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#trimJoinCont"><span class="hs-identifier hs-var">trimJoinCont</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980042"><span class="hs-identifier hs-var">var1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; JoinPointHood
</span><a href="GHC.Types.Id.html#idJoinPointHood"><span class="hs-identifier hs-var">idJoinPointHood</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980042"><span class="hs-identifier hs-var">var1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980035"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-2251"></span><span>                 </span><span id="local-6989586621682980046"><span class="annot"><a href="#local-6989586621682980046"><span class="hs-identifier hs-var hs-var">info</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; RuleEnv -&gt; CoreBndr -&gt; SimplCont -&gt; ArgInfo
</span><a href="GHC.Core.Opt.Simplify.Utils.html#mkArgInfo"><span class="hs-identifier hs-var">mkArgInfo</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980033"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">RuleEnv
</span><a href="#local-6989586621682980043"><span class="hs-identifier hs-var">rule_base</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980042"><span class="hs-identifier hs-var">var1</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980045"><span class="hs-identifier hs-var">cont'</span></a></span><span>
</span><span id="line-2252"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuildCall"><span class="hs-identifier hs-type">rebuildCall</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980033"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980046"><span class="hs-identifier hs-type">info</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980045"><span class="hs-identifier hs-type">cont'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2253"></span><span>
</span><span id="line-2254"></span><span>      </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#DoneEx"><span class="hs-identifier hs-type">DoneEx</span></a></span><span> </span><span id="local-6989586621682980048"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980048"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621682980049"><span class="annot"><span class="annottext">JoinPointHood
</span><a href="#local-6989586621682980049"><span class="hs-identifier hs-var">mb_join</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980050"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980048"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980051"><span class="hs-identifier hs-var">cont'</span></a></span><span>
</span><span id="line-2255"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-2256"></span><span>          </span><span id="local-6989586621682980051"><span class="annot"><span class="annottext">cont' :: SimplCont
</span><a href="#local-6989586621682980051"><span class="hs-identifier hs-var hs-var">cont'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; JoinPointHood -&gt; SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#trimJoinCont"><span class="hs-identifier hs-var">trimJoinCont</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980034"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">JoinPointHood
</span><a href="#local-6989586621682980049"><span class="hs-identifier hs-var">mb_join</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980035"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-2257"></span><span>          </span><span id="local-6989586621682980050"><span class="annot"><span class="annottext">env' :: SimplEnv
</span><a href="#local-6989586621682980050"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#zapSubstEnv"><span class="hs-identifier hs-var">zapSubstEnv</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980033"><span class="hs-identifier hs-var">env</span></a></span><span>  </span><span class="hs-comment">-- See Note [zapSubstEnv]</span><span>
</span><span id="line-2258"></span><span>
</span><span id="line-2259"></span><span class="hs-comment">---------------------------------------------------------</span><span>
</span><span id="line-2260"></span><span class="hs-comment">--      Dealing with a call site</span><span>
</span><span id="line-2261"></span><span>
</span><span id="line-2262"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuildCall"><span class="hs-identifier hs-type">rebuildCall</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-2263"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2264"></span><span>
</span><span id="line-2265"></span><span class="hs-comment">---------- Bottoming applications --------------</span><span>
</span><span id="line-2266"></span><span id="rebuildCall"><span class="annot"><span class="annottext">rebuildCall :: SimplEnv -&gt; ArgInfo -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuildCall"><span class="hs-identifier hs-var hs-var">rebuildCall</span></a></span></span><span> </span><span id="local-6989586621682980052"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980052"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ai_fun :: ArgInfo -&gt; CoreBndr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_fun"><span class="hs-identifier hs-var">ai_fun</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980055"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980055"><span class="hs-identifier hs-var">fun</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ai_args :: ArgInfo -&gt; [ArgSpec]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_args"><span class="hs-identifier hs-var">ai_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980057"><span class="annot"><span class="annottext">[ArgSpec]
</span><a href="#local-6989586621682980057"><span class="hs-identifier hs-var">rev_args</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ai_dmds :: ArgInfo -&gt; [Demand]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_dmds"><span class="hs-identifier hs-var">ai_dmds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621682980059"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980059"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-2267"></span><span>  </span><span class="hs-comment">-- When we run out of strictness args, it means</span><span>
</span><span id="line-2268"></span><span>  </span><span class="hs-comment">-- that the call is definitely bottom; see GHC.Core.Opt.Simplify.Utils.mkArgInfo</span><span>
</span><span id="line-2269"></span><span>  </span><span class="hs-comment">-- Then we want to discard the entire strict continuation.  E.g.</span><span>
</span><span id="line-2270"></span><span>  </span><span class="hs-comment">--    * case (error &quot;hello&quot;) of { ... }</span><span>
</span><span id="line-2271"></span><span>  </span><span class="hs-comment">--    * (error &quot;Hello&quot;) arg</span><span>
</span><span id="line-2272"></span><span>  </span><span class="hs-comment">--    * f (error &quot;Hello&quot;) where f is strict</span><span>
</span><span id="line-2273"></span><span>  </span><span class="hs-comment">--    etc</span><span>
</span><span id="line-2274"></span><span>  </span><span class="hs-comment">-- Then, especially in the first of these cases, we'd like to discard</span><span>
</span><span id="line-2275"></span><span>  </span><span class="hs-comment">-- the continuation, leaving just the bottoming expression.  But the</span><span>
</span><span id="line-2276"></span><span>  </span><span class="hs-comment">-- type might not be right, so we may have to add a coerce.</span><span>
</span><span id="line-2277"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplCont -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contIsTrivial"><span class="hs-identifier hs-var">contIsTrivial</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980059"><span class="hs-identifier hs-var">cont</span></a></span><span class="hs-special">)</span><span>     </span><span class="hs-comment">-- Only do this if there is a non-trivial</span><span>
</span><span id="line-2278"></span><span>                                 </span><span class="hs-comment">-- continuation to discard, else we do it</span><span>
</span><span id="line-2279"></span><span>                                 </span><span class="hs-comment">-- again and again!</span><span>
</span><span id="line-2280"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Kind -&gt; ()
</span><a href="GHC.Core.Type.html#seqType"><span class="hs-identifier hs-var">seqType</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980061"><span class="hs-identifier hs-var">cont_ty</span></a></span><span> </span><span class="annot"><span class="annottext">()
-&gt; SimplM (SimplFloats, CoreExpr) -&gt; SimplM (SimplFloats, CoreExpr)
forall a b. a -&gt; b -&gt; b
</span><span class="hs-operator hs-var">`seq`</span></span><span>        </span><span class="hs-comment">-- See Note [Avoiding space leaks in OutType]</span><span>
</span><span id="line-2281"></span><span>    </span><span class="annot"><span class="annottext">(SimplFloats, CoreExpr) -&gt; SimplM (SimplFloats, CoreExpr)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980052"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Kind -&gt; CoreExpr
</span><a href="GHC.Core.Make.html#castBottomExpr"><span class="hs-identifier hs-var">castBottomExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980062"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980061"><span class="hs-identifier hs-var">cont_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2282"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2283"></span><span>    </span><span id="local-6989586621682980062"><span class="annot"><span class="annottext">res :: CoreExpr
</span><a href="#local-6989586621682980062"><span class="hs-identifier hs-var hs-var">res</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; [ArgSpec] -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#argInfoExpr"><span class="hs-identifier hs-var">argInfoExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980055"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgSpec]
</span><a href="#local-6989586621682980057"><span class="hs-identifier hs-var">rev_args</span></a></span><span>
</span><span id="line-2284"></span><span>    </span><span id="local-6989586621682980061"><span class="annot"><span class="annottext">cont_ty :: Kind
</span><a href="#local-6989586621682980061"><span class="hs-identifier hs-var hs-var">cont_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980059"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-2285"></span><span>
</span><span id="line-2286"></span><span class="hs-comment">---------- Try inlining, if ai_rewrite = TryInlining --------</span><span>
</span><span id="line-2287"></span><span class="hs-comment">-- In the TryInlining case we try inlining immediately, before simplifying</span><span>
</span><span id="line-2288"></span><span class="hs-comment">-- any (more) arguments. Why?  See Note [Rewrite rules and inlining].</span><span>
</span><span id="line-2289"></span><span class="hs-comment">--</span><span>
</span><span id="line-2290"></span><span class="hs-comment">-- If there are rewrite rules we'll skip this case until we have</span><span>
</span><span id="line-2291"></span><span class="hs-comment">-- simplified enough args to satisfy nr_wanted==0 in the TryRules case below</span><span>
</span><span id="line-2292"></span><span class="hs-comment">-- Then we'll try the rules, and if that fails, we'll do TryInlining</span><span>
</span><span id="line-2293"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuildCall"><span class="hs-identifier hs-var">rebuildCall</span></a></span><span> </span><span id="local-6989586621682980064"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980064"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980065"><span class="annot"><span class="annottext">info :: ArgInfo
</span><a href="#local-6989586621682980065"><span class="hs-identifier hs-var">info</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ai_fun :: ArgInfo -&gt; CoreBndr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_fun"><span class="hs-identifier hs-var">ai_fun</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980066"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980066"><span class="hs-identifier hs-var">fun</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ai_args :: ArgInfo -&gt; [ArgSpec]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_args"><span class="hs-identifier hs-var">ai_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980067"><span class="annot"><span class="annottext">[ArgSpec]
</span><a href="#local-6989586621682980067"><span class="hs-identifier hs-var">rev_args</span></a></span></span><span>
</span><span id="line-2294"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ai_rewrite :: ArgInfo -&gt; RewriteCall
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_rewrite"><span class="hs-identifier hs-var">ai_rewrite</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RewriteCall
</span><a href="GHC.Core.Opt.Simplify.Utils.html#TryInlining"><span class="hs-identifier hs-var">TryInlining</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621682980070"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980070"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-2295"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682980071"><span class="annot"><a href="#local-6989586621682980071"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplM Logger
forall (m :: * -&gt; *). HasLogger m =&gt; m Logger
</span><a href="GHC.Utils.Logger.html#getLogger"><span class="hs-identifier hs-var">getLogger</span></a></span><span>
</span><span id="line-2296"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682980072"><span class="annot"><a href="#local-6989586621682980072"><span class="hs-identifier hs-var hs-var">full_cont</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; [ArgSpec] -&gt; SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#pushSimplifiedRevArgs"><span class="hs-identifier hs-var">pushSimplifiedRevArgs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980064"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgSpec]
</span><a href="#local-6989586621682980067"><span class="hs-identifier hs-var">rev_args</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980070"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-2297"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682980074"><span class="annot"><a href="#local-6989586621682980074"><span class="hs-identifier hs-var">mb_inline</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#tryInlining"><span class="hs-identifier hs-type">tryInlining</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980064"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980071"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980066"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980072"><span class="hs-identifier hs-type">full_cont</span></a></span><span>
</span><span id="line-2298"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621682980074"><span class="hs-identifier hs-type">mb_inline</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2299"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682980076"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980076"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Tick -&gt; SimplM ()
</span><a href="GHC.Core.Opt.Simplify.Monad.html#checkedTick"><span class="hs-identifier hs-var">checkedTick</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Tick
</span><a href="GHC.Core.Opt.Stats.html#UnfoldingDone"><span class="hs-identifier hs-var">UnfoldingDone</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980066"><span class="hs-identifier hs-var">fun</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2300"></span><span>                            </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682980079"><span class="annot"><span class="annottext">env1 :: SimplEnv
</span><a href="#local-6989586621682980079"><span class="hs-identifier hs-var hs-var">env1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#zapSubstEnv"><span class="hs-identifier hs-var">zapSubstEnv</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980064"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-2301"></span><span>                            </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980079"><span class="hs-identifier hs-var">env1</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980076"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980072"><span class="hs-identifier hs-var">full_cont</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2302"></span><span>            </span><span class="annot"><span class="annottext">Maybe CoreExpr
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; ArgInfo -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuildCall"><span class="hs-identifier hs-var">rebuildCall</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980064"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682980065"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ai_rewrite"><span class="hs-identifier hs-var">ai_rewrite</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#TryNothing"><span class="hs-identifier hs-type">TryNothing</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980070"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-2303"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-2304"></span><span>
</span><span id="line-2305"></span><span class="hs-comment">---------- Try rewrite RULES, if ai_rewrite = TryRules --------------</span><span>
</span><span id="line-2306"></span><span class="hs-comment">-- See Note [Rewrite rules and inlining]</span><span>
</span><span id="line-2307"></span><span class="hs-comment">-- See also Note [Trying rewrite rules]</span><span>
</span><span id="line-2308"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuildCall"><span class="hs-identifier hs-var">rebuildCall</span></a></span><span> </span><span id="local-6989586621682980081"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980081"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980082"><span class="annot"><span class="annottext">info :: ArgInfo
</span><a href="#local-6989586621682980082"><span class="hs-identifier hs-var">info</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ai_fun :: ArgInfo -&gt; CoreBndr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_fun"><span class="hs-identifier hs-var">ai_fun</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980083"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980083"><span class="hs-identifier hs-var">fun</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ai_args :: ArgInfo -&gt; [ArgSpec]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_args"><span class="hs-identifier hs-var">ai_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980084"><span class="annot"><span class="annottext">[ArgSpec]
</span><a href="#local-6989586621682980084"><span class="hs-identifier hs-var">rev_args</span></a></span></span><span>
</span><span id="line-2309"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ai_rewrite :: ArgInfo -&gt; RewriteCall
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_rewrite"><span class="hs-identifier hs-var">ai_rewrite</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#TryRules"><span class="hs-identifier hs-type">TryRules</span></a></span><span> </span><span id="local-6989586621682980086"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682980086"><span class="hs-identifier hs-var">nr_wanted</span></a></span></span><span> </span><span id="local-6989586621682980087"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682980087"><span class="hs-identifier hs-var">rules</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621682980088"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980088"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-2310"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682980086"><span class="hs-identifier hs-var">nr_wanted</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682980089"><span class="hs-identifier hs-var">no_more_args</span></a></span><span>
</span><span id="line-2311"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- We've accumulated a simplified call in &lt;fun,rev_args&gt;</span><span>
</span><span id="line-2312"></span><span>    </span><span class="hs-comment">-- so try rewrite rules; see Note [RULES apply to simplified arguments]</span><span>
</span><span id="line-2313"></span><span>    </span><span class="hs-comment">-- See also Note [Rules for recursive functions]</span><span>
</span><span id="line-2314"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682980090"><span class="annot"><a href="#local-6989586621682980090"><span class="hs-identifier hs-var">mb_match</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; [CoreRule]
-&gt; CoreBndr
-&gt; [ArgSpec]
-&gt; SimplCont
-&gt; SimplM (Maybe (SimplEnv, CoreExpr, SimplCont))
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#tryRules"><span class="hs-identifier hs-var">tryRules</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980081"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682980087"><span class="hs-identifier hs-var">rules</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980083"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ArgSpec] -&gt; [ArgSpec]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[ArgSpec]
</span><a href="#local-6989586621682980084"><span class="hs-identifier hs-var">rev_args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980088"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-2315"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621682980090"><span class="hs-identifier hs-type">mb_match</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2316"></span><span>             </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980093"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980093"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980094"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980094"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980095"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980095"><span class="hs-identifier hs-var">cont'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980093"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980094"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980095"><span class="hs-identifier hs-var">cont'</span></a></span><span>
</span><span id="line-2317"></span><span>             </span><span class="annot"><span class="annottext">Maybe (SimplEnv, CoreExpr, SimplCont)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; ArgInfo -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuildCall"><span class="hs-identifier hs-var">rebuildCall</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980081"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682980082"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ai_rewrite"><span class="hs-identifier hs-var">ai_rewrite</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#TryInlining"><span class="hs-identifier hs-type">TryInlining</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980088"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2318"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2319"></span><span>    </span><span class="hs-comment">-- If we have run out of arguments, just try the rules; there might</span><span>
</span><span id="line-2320"></span><span>    </span><span class="hs-comment">-- be some with lower arity.  Casts get in the way -- they aren't</span><span>
</span><span id="line-2321"></span><span>    </span><span class="hs-comment">-- allowed on rule LHSs</span><span>
</span><span id="line-2322"></span><span>    </span><span id="local-6989586621682980089"><span class="annot"><span class="annottext">no_more_args :: Bool
</span><a href="#local-6989586621682980089"><span class="hs-identifier hs-var hs-var">no_more_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980088"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2323"></span><span>                      </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToTy"><span class="hs-identifier hs-type">ApplyToTy</span></a></span><span>  </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-2324"></span><span>                      </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToVal"><span class="hs-identifier hs-type">ApplyToVal</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-2325"></span><span>                      </span><span class="annot"><span class="annottext">SimplCont
</span><span class="hs-identifier">_</span></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-2326"></span><span>
</span><span id="line-2327"></span><span class="hs-comment">---------- Simplify type applications and casts --------------</span><span>
</span><span id="line-2328"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuildCall"><span class="hs-identifier hs-var">rebuildCall</span></a></span><span> </span><span id="local-6989586621682980096"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980096"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980097"><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682980097"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#CastIt"><span class="hs-identifier hs-type">CastIt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_co :: SimplCont -&gt; CoercionR
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_co"><span class="hs-identifier hs-var">sc_co</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980098"><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682980098"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_opt :: SimplCont -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_opt"><span class="hs-identifier hs-var">sc_opt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980099"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682980099"><span class="hs-identifier hs-var">opt</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980100"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980100"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2329"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; ArgInfo -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuildCall"><span class="hs-identifier hs-var">rebuildCall</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980096"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArgInfo -&gt; CoercionR -&gt; ArgInfo
</span><a href="GHC.Core.Opt.Simplify.Utils.html#addCastTo"><span class="hs-identifier hs-var">addCastTo</span></a></span><span> </span><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682980097"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682980102"><span class="hs-identifier hs-var">co'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980100"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-2330"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2331"></span><span>    </span><span id="local-6989586621682980102"><span class="annot"><span class="annottext">co' :: CoercionR
</span><a href="#local-6989586621682980102"><span class="hs-identifier hs-var hs-var">co'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoercionR -&gt; Bool -&gt; CoercionR
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#optOutCoercion"><span class="hs-identifier hs-var">optOutCoercion</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980096"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682980098"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682980099"><span class="hs-identifier hs-var">opt</span></a></span><span>
</span><span id="line-2332"></span><span>
</span><span id="line-2333"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuildCall"><span class="hs-identifier hs-var">rebuildCall</span></a></span><span> </span><span id="local-6989586621682980103"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980103"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980104"><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682980104"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToTy"><span class="hs-identifier hs-type">ApplyToTy</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_arg_ty :: SimplCont -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_arg_ty"><span class="hs-identifier hs-var">sc_arg_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980105"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980105"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_hole_ty :: SimplCont -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_hole_ty"><span class="hs-identifier hs-var">sc_hole_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980106"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980106"><span class="hs-identifier hs-var">hole_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980107"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980107"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2334"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; ArgInfo -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuildCall"><span class="hs-identifier hs-var">rebuildCall</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980103"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArgInfo -&gt; Kind -&gt; Kind -&gt; ArgInfo
</span><a href="GHC.Core.Opt.Simplify.Utils.html#addTyArgTo"><span class="hs-identifier hs-var">addTyArgTo</span></a></span><span> </span><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682980104"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980105"><span class="hs-identifier hs-var">arg_ty</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980106"><span class="hs-identifier hs-var">hole_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980107"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-2335"></span><span>
</span><span id="line-2336"></span><span class="hs-comment">---------- The runRW# rule. Do this after absorbing all arguments ------</span><span>
</span><span id="line-2337"></span><span class="hs-comment">-- See Note [Simplification of runRW#] in GHC.CoreToSTG.Prep.</span><span>
</span><span id="line-2338"></span><span class="hs-comment">--</span><span>
</span><span id="line-2339"></span><span class="hs-comment">-- runRW# :: forall (r :: RuntimeRep) (o :: TYPE r). (State# RealWorld -&gt; o) -&gt; o</span><span>
</span><span id="line-2340"></span><span class="hs-comment">-- K[ runRW# rr ty body ]   --&gt;   runRW rr' ty' (\s. K[ body s ])</span><span>
</span><span id="line-2341"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuildCall"><span class="hs-identifier hs-var">rebuildCall</span></a></span><span> </span><span id="local-6989586621682980109"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980109"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ai_fun :: ArgInfo -&gt; CoreBndr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_fun"><span class="hs-identifier hs-var">ai_fun</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980110"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980110"><span class="hs-identifier hs-var">fun_id</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ai_args :: ArgInfo -&gt; [ArgSpec]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_args"><span class="hs-identifier hs-var">ai_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980111"><span class="annot"><span class="annottext">[ArgSpec]
</span><a href="#local-6989586621682980111"><span class="hs-identifier hs-var">rev_args</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2342"></span><span>            </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToVal"><span class="hs-identifier hs-type">ApplyToVal</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_arg :: SimplCont -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_arg"><span class="hs-identifier hs-var">sc_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980112"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980112"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_env :: SimplCont -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_env"><span class="hs-identifier hs-var">sc_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980113"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980113"><span class="hs-identifier hs-var">arg_se</span></a></span></span><span>
</span><span id="line-2343"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980114"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980114"><span class="hs-identifier hs-var">cont</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_hole_ty :: SimplCont -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_hole_ty"><span class="hs-identifier hs-var">sc_hole_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980115"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980115"><span class="hs-identifier hs-var">fun_ty</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2344"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980110"><span class="hs-identifier hs-var">fun_id</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#runRWKey"><span class="hs-identifier hs-var">runRWKey</span></a></span><span>
</span><span id="line-2345"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#TyArg"><span class="hs-identifier hs-type">TyArg</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">as_arg_ty :: ArgSpec -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#as_arg_ty"><span class="hs-identifier hs-var">as_arg_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980118"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980118"><span class="hs-identifier hs-var">hole_ty</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#TyArg"><span class="hs-identifier hs-type">TyArg</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[ArgSpec]
</span><a href="#local-6989586621682980111"><span class="hs-identifier hs-var">rev_args</span></a></span><span>
</span><span id="line-2346"></span><span>  </span><span class="hs-comment">-- Do this even if (contIsStop cont), or if seCaseCase is off.</span><span>
</span><span id="line-2347"></span><span>  </span><span class="hs-comment">-- See Note [No eta-expansion in runRW#]</span><span>
</span><span id="line-2348"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682980119"><span class="annot"><span class="annottext">arg_env :: SimplEnv
</span><a href="#local-6989586621682980119"><span class="hs-identifier hs-var hs-var hs-var">arg_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980113"><span class="hs-identifier hs-var">arg_se</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplEnv -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#setInScopeFromE"><span class="hs-operator hs-var">`setInScopeFromE`</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980109"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-2349"></span><span>
</span><span id="line-2350"></span><span>             </span><span id="local-6989586621682980120"><span class="annot"><span class="annottext">overall_res_ty :: Kind
</span><a href="#local-6989586621682980120"><span class="hs-identifier hs-var hs-var hs-var">overall_res_ty</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980114"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-2351"></span><span>             </span><span class="hs-comment">-- hole_ty is the type of the current runRW# application</span><span>
</span><span id="line-2352"></span><span>             </span><span class="hs-special">(</span><span id="local-6989586621682980121"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980121"><span class="hs-identifier hs-var hs-var">outer_cont</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980122"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980122"><span class="hs-identifier hs-var hs-var">new_runrw_res_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980123"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980123"><span class="hs-identifier hs-var hs-var">inner_cont</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2353"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Env.html#seCaseCase"><span class="hs-identifier hs-var">seCaseCase</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980109"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Kind -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#mkBoringStop"><span class="hs-identifier hs-var">mkBoringStop</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980120"><span class="hs-identifier hs-var">overall_res_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980120"><span class="hs-identifier hs-var">overall_res_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980114"><span class="hs-identifier hs-var">cont</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2354"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980114"><span class="hs-identifier hs-var">cont</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980118"><span class="hs-identifier hs-var">hole_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Kind -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#mkBoringStop"><span class="hs-identifier hs-var">mkBoringStop</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980118"><span class="hs-identifier hs-var">hole_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2355"></span><span>                </span><span class="hs-comment">-- Only when case-of-case is on. See GHC.Driver.Config.Core.Opt.Simplify</span><span>
</span><span id="line-2356"></span><span>                </span><span class="hs-comment">--    Note [Case-of-case and full laziness]</span><span>
</span><span id="line-2357"></span><span>
</span><span id="line-2358"></span><span>       </span><span class="hs-comment">-- If the argument is a literal lambda already, take a short cut</span><span>
</span><span id="line-2359"></span><span>       </span><span class="hs-comment">-- This isn't just efficiency:</span><span>
</span><span id="line-2360"></span><span>       </span><span class="hs-comment">--    * If we don't do this we get a beta-redex every time, so the</span><span>
</span><span id="line-2361"></span><span>       </span><span class="hs-comment">--      simplifier keeps doing more iterations.</span><span>
</span><span id="line-2362"></span><span>       </span><span class="hs-comment">--    * Even more important: see Note [No eta-expansion in runRW#]</span><span>
</span><span id="line-2363"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682980124"><span class="annot"><a href="#local-6989586621682980124"><span class="hs-identifier hs-var">arg'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980112"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2364"></span><span>           </span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621682980125"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980125"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621682980126"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980126"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980127"><span class="annot"><a href="#local-6989586621682980127"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980128"><span class="annot"><a href="#local-6989586621682980128"><span class="hs-identifier hs-var">s'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; SimplM (SimplEnv, CoreBndr)
</span><a href="GHC.Core.Opt.Simplify.Env.html#simplBinder"><span class="hs-identifier hs-var">simplBinder</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980119"><span class="hs-identifier hs-var">arg_env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980125"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-2365"></span><span>                            </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682980129"><span class="annot"><a href="#local-6989586621682980129"><span class="hs-identifier hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprC"><span class="hs-identifier hs-type">simplExprC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980127"><span class="hs-identifier hs-type">env'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980126"><span class="hs-identifier hs-type">body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980123"><span class="hs-identifier hs-type">inner_cont</span></a></span><span>
</span><span id="line-2366"></span><span>                            </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980128"><span class="hs-identifier hs-type">s'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980129"><span class="hs-identifier hs-type">body'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2367"></span><span>                            </span><span class="hs-comment">-- Important: do not try to eta-expand this lambda</span><span>
</span><span id="line-2368"></span><span>                            </span><span class="hs-comment">-- See Note [No eta-expansion in runRW#]</span><span>
</span><span id="line-2369"></span><span>
</span><span id="line-2370"></span><span>           </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682980130"><span class="annot"><a href="#local-6989586621682980130"><span class="hs-identifier hs-var">s'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FastString -&gt; Kind -&gt; Kind -&gt; SimplM CoreBndr
</span><a href="GHC.Core.Opt.Simplify.Monad.html#newId"><span class="hs-identifier hs-var">newId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; FastString
</span><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;s&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="GHC.Core.Type.html#ManyTy"><span class="hs-identifier hs-var">ManyTy</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="GHC.Builtin.Types.Prim.html#realWorldStatePrimTy"><span class="hs-identifier hs-var">realWorldStatePrimTy</span></a></span><span>
</span><span id="line-2371"></span><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980132"><span class="annot"><a href="#local-6989586621682980132"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">,</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Type.html#splitFunTy"><span class="hs-identifier hs-type">splitFunTy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980115"><span class="hs-identifier hs-type">fun_ty</span></a></span><span>
</span><span id="line-2372"></span><span>                         </span><span id="local-6989586621682980134"><span class="annot"><a href="#local-6989586621682980134"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980119"><span class="hs-identifier hs-var">arg_env</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; [CoreBndr] -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#addNewInScopeIds"><span class="hs-operator hs-var">`addNewInScopeIds`</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980130"><span class="hs-identifier hs-var">s'</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2373"></span><span>                         </span><span id="local-6989586621682980136"><span class="annot"><a href="#local-6989586621682980136"><span class="hs-identifier hs-var hs-var">cont'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToVal"><span class="hs-identifier hs-type">ApplyToVal</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_dup :: DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_dup"><span class="hs-identifier hs-var">sc_dup</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#Simplified"><span class="hs-identifier hs-var">Simplified</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_arg :: CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_arg"><span class="hs-identifier hs-var">sc_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; CoreExpr
forall b. CoreBndr -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980130"><span class="hs-identifier hs-var">s'</span></a></span><span>
</span><span id="line-2374"></span><span>                                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_env :: SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_env"><span class="hs-identifier hs-var">sc_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980134"><span class="hs-identifier hs-var">env'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980123"><span class="hs-identifier hs-var">inner_cont</span></a></span><span>
</span><span id="line-2375"></span><span>                                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_hole_ty :: Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_hole_ty"><span class="hs-identifier hs-var">sc_hole_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Kind -&gt; Kind -&gt; Kind -&gt; Kind
Kind -&gt; Kind -&gt; Kind -&gt; Kind
</span><a href="GHC.Core.TyCo.Rep.html#mkVisFunTy"><span class="hs-identifier hs-var">mkVisFunTy</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980132"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="GHC.Builtin.Types.Prim.html#realWorldStatePrimTy"><span class="hs-identifier hs-var">realWorldStatePrimTy</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980122"><span class="hs-identifier hs-var">new_runrw_res_ty</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2376"></span><span>                                </span><span class="hs-comment">-- cont' applies to s', then K</span><span>
</span><span id="line-2377"></span><span>                   </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682980138"><span class="annot"><a href="#local-6989586621682980138"><span class="hs-identifier hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprC"><span class="hs-identifier hs-type">simplExprC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980134"><span class="hs-identifier hs-type">env'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980112"><span class="hs-identifier hs-type">arg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980136"><span class="hs-identifier hs-type">cont'</span></a></span><span>
</span><span id="line-2378"></span><span>                   </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980130"><span class="hs-identifier hs-type">s'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980138"><span class="hs-identifier hs-type">body'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2379"></span><span>
</span><span id="line-2380"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682980139"><span class="annot"><a href="#local-6989586621682980139"><span class="hs-identifier hs-var hs-var">rr'</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Kind -&gt; Kind
Kind -&gt; Kind
</span><a href="GHC.Core.Type.html#getRuntimeRep"><span class="hs-identifier hs-var">getRuntimeRep</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980122"><span class="hs-identifier hs-var">new_runrw_res_ty</span></a></span><span>
</span><span id="line-2381"></span><span>             </span><span id="local-6989586621682980141"><span class="annot"><a href="#local-6989586621682980141"><span class="hs-identifier hs-var hs-var">call'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; CoreExpr
forall b. Expr b -&gt; [Expr b] -&gt; Expr b
</span><a href="GHC.Core.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; CoreExpr
forall b. CoreBndr -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980110"><span class="hs-identifier hs-var">fun_id</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Kind -&gt; CoreExpr
forall b. Kind -&gt; Expr b
</span><a href="GHC.Core.html#mkTyArg"><span class="hs-identifier hs-var">mkTyArg</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980139"><span class="hs-identifier hs-var">rr'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Kind -&gt; CoreExpr
forall b. Kind -&gt; Expr b
</span><a href="GHC.Core.html#mkTyArg"><span class="hs-identifier hs-var">mkTyArg</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980122"><span class="hs-identifier hs-var">new_runrw_res_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980124"><span class="hs-identifier hs-var">arg'</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2382"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuild"><span class="hs-identifier hs-type">rebuild</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980109"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980141"><span class="hs-identifier hs-type">call'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980121"><span class="hs-identifier hs-type">outer_cont</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2383"></span><span>
</span><span id="line-2384"></span><span class="hs-comment">---------- Simplify value arguments --------------------</span><span>
</span><span id="line-2385"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuildCall"><span class="hs-identifier hs-var">rebuildCall</span></a></span><span> </span><span id="local-6989586621682980144"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980144"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980145"><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682980145"><span class="hs-identifier hs-var">fun_info</span></a></span></span><span>
</span><span id="line-2386"></span><span>            </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToVal"><span class="hs-identifier hs-type">ApplyToVal</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_arg :: SimplCont -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_arg"><span class="hs-identifier hs-var">sc_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980146"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980146"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_env :: SimplCont -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_env"><span class="hs-identifier hs-var">sc_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980147"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980147"><span class="hs-identifier hs-var">arg_se</span></a></span></span><span>
</span><span id="line-2387"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_dup :: SimplCont -&gt; DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_dup"><span class="hs-identifier hs-var">sc_dup</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980148"><span class="annot"><span class="annottext">DupFlag
</span><a href="#local-6989586621682980148"><span class="hs-identifier hs-var">dup_flag</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_hole_ty :: SimplCont -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_hole_ty"><span class="hs-identifier hs-var">sc_hole_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980149"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980149"><span class="hs-identifier hs-var">fun_ty</span></a></span></span><span>
</span><span id="line-2388"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980150"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980150"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2389"></span><span>  </span><span class="hs-comment">-- Argument is already simplified</span><span>
</span><span id="line-2390"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">DupFlag -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#isSimplified"><span class="hs-identifier hs-var">isSimplified</span></a></span><span> </span><span class="annot"><span class="annottext">DupFlag
</span><a href="#local-6989586621682980148"><span class="hs-identifier hs-var">dup_flag</span></a></span><span>     </span><span class="hs-comment">-- See Note [Avoid redundant simplification]</span><span>
</span><span id="line-2391"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; ArgInfo -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuildCall"><span class="hs-identifier hs-var">rebuildCall</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980144"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArgInfo -&gt; CoreExpr -&gt; Kind -&gt; ArgInfo
</span><a href="GHC.Core.Opt.Simplify.Utils.html#addValArgTo"><span class="hs-identifier hs-var">addValArgTo</span></a></span><span> </span><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682980145"><span class="hs-identifier hs-var">fun_info</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980146"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980149"><span class="hs-identifier hs-var">fun_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980150"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-2392"></span><span>
</span><span id="line-2393"></span><span>  </span><span class="hs-comment">-- Strict arguments</span><span>
</span><span id="line-2394"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ArgInfo -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#isStrictArgInfo"><span class="hs-identifier hs-var">isStrictArgInfo</span></a></span><span> </span><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682980145"><span class="hs-identifier hs-var">fun_info</span></a></span><span>
</span><span id="line-2395"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Env.html#seCaseCase"><span class="hs-identifier hs-var">seCaseCase</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980144"><span class="hs-identifier hs-var">env</span></a></span><span>    </span><span class="hs-comment">-- Only when case-of-case is on. See GHC.Driver.Config.Core.Opt.Simplify</span><span>
</span><span id="line-2396"></span><span>                      </span><span class="hs-comment">--    Note [Case-of-case and full laziness]</span><span>
</span><span id="line-2397"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;Strict Arg&quot; (ppr arg $$ ppr (seIdSubst env) $$ ppr (seInScope env)) $</span><span>
</span><span id="line-2398"></span><span>    </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980147"><span class="hs-identifier hs-var">arg_se</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplEnv -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#setInScopeFromE"><span class="hs-operator hs-var">`setInScopeFromE`</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980144"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980146"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-2399"></span><span>               </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StrictArg"><span class="hs-identifier hs-type">StrictArg</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_fun :: ArgInfo
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_fun"><span class="hs-identifier hs-var">sc_fun</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682980145"><span class="hs-identifier hs-var">fun_info</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_fun_ty :: Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_fun_ty"><span class="hs-identifier hs-var">sc_fun_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980149"><span class="hs-identifier hs-var">fun_ty</span></a></span><span>
</span><span id="line-2400"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_dup :: DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_dup"><span class="hs-identifier hs-var">sc_dup</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#Simplified"><span class="hs-identifier hs-var">Simplified</span></a></span><span>
</span><span id="line-2401"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980150"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2402"></span><span>                </span><span class="hs-comment">-- Note [Shadowing in the Simplifier]</span><span>
</span><span id="line-2403"></span><span>
</span><span id="line-2404"></span><span>  </span><span class="hs-comment">-- Lazy arguments</span><span>
</span><span id="line-2405"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2406"></span><span>        </span><span class="hs-comment">-- DO NOT float anything outside, hence simplExprC</span><span>
</span><span id="line-2407"></span><span>        </span><span class="hs-comment">-- There is no benefit (unlike in a let-binding), and we'd</span><span>
</span><span id="line-2408"></span><span>        </span><span class="hs-comment">-- have to be very careful about bogus strictness through</span><span>
</span><span id="line-2409"></span><span>        </span><span class="hs-comment">-- floating a demanded let.</span><span>
</span><span id="line-2410"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980152"><span class="annot"><a href="#local-6989586621682980152"><span class="hs-identifier hs-var">arg'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; DupFlag
-&gt; Kind
-&gt; Maybe ArgInfo
-&gt; SimplEnv
-&gt; CoreExpr
-&gt; SimplM (DupFlag, SimplEnv, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplLazyArg"><span class="hs-identifier hs-var">simplLazyArg</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980144"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">DupFlag
</span><a href="#local-6989586621682980148"><span class="hs-identifier hs-var">dup_flag</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980149"><span class="hs-identifier hs-var">fun_ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArgInfo -&gt; Maybe ArgInfo
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682980145"><span class="hs-identifier hs-var">fun_info</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980147"><span class="hs-identifier hs-var">arg_se</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980146"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-2411"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuildCall"><span class="hs-identifier hs-type">rebuildCall</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980144"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#addValArgTo"><span class="hs-identifier hs-type">addValArgTo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980145"><span class="hs-identifier hs-type">fun_info</span></a></span><span>  </span><span class="annot"><a href="#local-6989586621682980152"><span class="hs-identifier hs-type">arg'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980149"><span class="hs-identifier hs-type">fun_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682980150"><span class="hs-identifier hs-type">cont</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2412"></span><span>
</span><span id="line-2413"></span><span class="hs-comment">---------- No further useful info, revert to generic rebuild ------------</span><span>
</span><span id="line-2414"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuildCall"><span class="hs-identifier hs-var">rebuildCall</span></a></span><span> </span><span id="local-6989586621682980153"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980153"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ai_fun :: ArgInfo -&gt; CoreBndr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_fun"><span class="hs-identifier hs-var">ai_fun</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980154"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980154"><span class="hs-identifier hs-var">fun</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ai_args :: ArgInfo -&gt; [ArgSpec]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_args"><span class="hs-identifier hs-var">ai_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980155"><span class="annot"><span class="annottext">[ArgSpec]
</span><a href="#local-6989586621682980155"><span class="hs-identifier hs-var">rev_args</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621682980156"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980156"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-2415"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuild"><span class="hs-identifier hs-var">rebuild</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980153"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; [ArgSpec] -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#argInfoExpr"><span class="hs-identifier hs-var">argInfoExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980154"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgSpec]
</span><a href="#local-6989586621682980155"><span class="hs-identifier hs-var">rev_args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980156"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-2416"></span><span>
</span><span id="line-2417"></span><span class="hs-comment">-----------------------------------</span><span>
</span><span id="line-2418"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#tryInlining"><span class="hs-identifier hs-type">tryInlining</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2419"></span><span id="tryInlining"><span class="annot"><span class="annottext">tryInlining :: SimplEnv
-&gt; Logger -&gt; CoreBndr -&gt; SimplCont -&gt; SimplM (Maybe CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#tryInlining"><span class="hs-identifier hs-var hs-var">tryInlining</span></a></span></span><span> </span><span id="local-6989586621682980157"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980157"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980158"><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621682980158"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621682980159"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980159"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span id="local-6989586621682980160"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980160"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-2420"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682980161"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980161"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; Logger
-&gt; CoreBndr
-&gt; Bool
-&gt; [ArgSummary]
-&gt; CallCtxt
-&gt; Maybe CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Inline.html#callSiteInline"><span class="hs-identifier hs-var">callSiteInline</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980157"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621682980158"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980159"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682980163"><span class="hs-identifier hs-var">lone_variable</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgSummary]
</span><a href="#local-6989586621682980164"><span class="hs-identifier hs-var">arg_infos</span></a></span><span> </span><span class="annot"><span class="annottext">CallCtxt
</span><a href="#local-6989586621682980165"><span class="hs-identifier hs-var">interesting_cont</span></a></span><span>
</span><span id="line-2421"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; SimplCont -&gt; SimplM ()
</span><a href="#local-6989586621682980166"><span class="hs-identifier hs-var">dump_inline</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980161"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980160"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-2422"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Maybe CoreExpr -&gt; SimplM (Maybe CoreExpr)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; Maybe CoreExpr
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980161"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2423"></span><span>
</span><span id="line-2424"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2425"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe CoreExpr -&gt; SimplM (Maybe CoreExpr)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe CoreExpr
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-2426"></span><span>
</span><span id="line-2427"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2428"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682980163"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682980163"><span class="hs-identifier hs-var">lone_variable</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980164"><span class="annot"><span class="annottext">[ArgSummary]
</span><a href="#local-6989586621682980164"><span class="hs-identifier hs-var">arg_infos</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980167"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980167"><span class="hs-identifier hs-var">call_cont</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; (Bool, [ArgSummary], SimplCont)
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contArgs"><span class="hs-identifier hs-var">contArgs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980160"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-2429"></span><span>    </span><span id="local-6989586621682980165"><span class="annot"><span class="annottext">interesting_cont :: CallCtxt
</span><a href="#local-6989586621682980165"><span class="hs-identifier hs-var hs-var">interesting_cont</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplCont -&gt; CallCtxt
</span><a href="GHC.Core.Opt.Simplify.Utils.html#interestingCallContext"><span class="hs-identifier hs-var">interestingCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980157"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980167"><span class="hs-identifier hs-var">call_cont</span></a></span><span>
</span><span id="line-2430"></span><span>
</span><span id="line-2431"></span><span>    </span><span id="local-6989586621682980170"><span class="annot"><span class="annottext">log_inlining :: SDoc -&gt; SimplM ()
</span><a href="#local-6989586621682980170"><span class="hs-identifier hs-var hs-var">log_inlining</span></a></span></span><span> </span><span id="local-6989586621682980171"><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621682980171"><span class="hs-identifier hs-var">doc</span></a></span></span><span>
</span><span id="line-2432"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; SimplM ()
forall a. IO a -&gt; SimplM a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; SimplM ()) -&gt; IO () -&gt; SimplM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Logger
-&gt; PprStyle -&gt; DumpFlag -&gt; String -&gt; DumpFormat -&gt; SDoc -&gt; IO ()
</span><a href="GHC.Utils.Logger.html#logDumpFile"><span class="hs-identifier hs-var">logDumpFile</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621682980158"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NamePprCtx -&gt; PprStyle
</span><a href="GHC.Utils.Outputable.html#mkDumpStyle"><span class="hs-identifier hs-var">mkDumpStyle</span></a></span><span> </span><span class="annot"><span class="annottext">NamePprCtx
</span><a href="GHC.Utils.Outputable.html#alwaysQualify"><span class="hs-identifier hs-var">alwaysQualify</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2433"></span><span>           </span><span class="annot"><span class="annottext">DumpFlag
</span><a href="GHC.Driver.Flags.html#Opt_D_dump_inlinings"><span class="hs-identifier hs-var">Opt_D_dump_inlinings</span></a></span><span>
</span><span id="line-2434"></span><span>           </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">DumpFormat
</span><a href="GHC.Utils.Logger.html#FormatText"><span class="hs-identifier hs-var">FormatText</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621682980171"><span class="hs-identifier hs-var">doc</span></a></span><span>
</span><span id="line-2435"></span><span>
</span><span id="line-2436"></span><span>    </span><span id="local-6989586621682980166"><span class="annot"><span class="annottext">dump_inline :: CoreExpr -&gt; SimplCont -&gt; SimplM ()
</span><a href="#local-6989586621682980166"><span class="hs-identifier hs-var hs-var">dump_inline</span></a></span></span><span> </span><span id="local-6989586621682980177"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980177"><span class="hs-identifier hs-var">unfolding</span></a></span></span><span> </span><span id="local-6989586621682980178"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980178"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-2437"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Logger -&gt; DumpFlag -&gt; Bool
</span><a href="GHC.Utils.Logger.html#logHasDumpFlag"><span class="hs-identifier hs-var">logHasDumpFlag</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621682980158"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">DumpFlag
</span><a href="GHC.Driver.Flags.html#Opt_D_dump_inlinings"><span class="hs-identifier hs-var">Opt_D_dump_inlinings</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; SimplM ()
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2438"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Logger -&gt; DumpFlag -&gt; Bool
</span><a href="GHC.Utils.Logger.html#logHasDumpFlag"><span class="hs-identifier hs-var">logHasDumpFlag</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621682980158"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">DumpFlag
</span><a href="GHC.Driver.Flags.html#Opt_D_verbose_core2core"><span class="hs-identifier hs-var">Opt_D_verbose_core2core</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2439"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SimplM () -&gt; SimplM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Bool
</span><a href="GHC.Types.Name.html#isExternalName"><span class="hs-identifier hs-var">isExternalName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Name
</span><a href="GHC.Types.Id.html#idName"><span class="hs-identifier hs-var">idName</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980159"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SimplM () -&gt; SimplM ()) -&gt; SimplM () -&gt; SimplM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2440"></span><span>            </span><span class="annot"><span class="annottext">SDoc -&gt; SimplM ()
</span><a href="#local-6989586621682980170"><span class="hs-identifier hs-var">log_inlining</span></a></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; SimplM ()) -&gt; SDoc -&gt; SimplM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2441"></span><span>                </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Inlining done:&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">4</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980159"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-2442"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2443"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SimplM ()
</span><a href="#local-6989586621682980170"><span class="hs-identifier hs-var">log_inlining</span></a></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; SimplM ()) -&gt; SDoc -&gt; SimplM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2444"></span><span>           </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Inlining done: &quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980159"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-2445"></span><span>                </span><span class="annot"><span class="annottext">Int -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">4</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Inlined fn: &quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980177"><span class="hs-identifier hs-var">unfolding</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-2446"></span><span>                              </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Cont:  &quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980178"><span class="hs-identifier hs-var">cont</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-2447"></span><span>
</span><span id="line-2448"></span><span>
</span><span id="line-2449"></span><span class="hs-comment">{- Note [Trying rewrite rules]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider an application (f e1 e2 e3) where the e1,e2,e3 are not yet
simplified.  We want to simplify enough arguments to allow the rules
to apply, but it's more efficient to avoid simplifying e2,e3 if e1 alone
is sufficient.  Example: class ops
   (+) dNumInt e2 e3
If we rewrite ((+) dNumInt) to plusInt, we can take advantage of the
latter's strictness when simplifying e2, e3.  Moreover, suppose we have
  RULE  f Int = \x. x True

Then given (f Int e1) we rewrite to
   (\x. x True) e1
without simplifying e1.  Now we can inline x into its unique call site,
and absorb the True into it all in the same pass.  If we simplified
e1 first, we couldn't do that; see Note [Avoiding simplifying repeatedly].

So we try to apply rules if either
  (a) no_more_args: we've run out of argument that the rules can &quot;see&quot;
  (b) nr_wanted: none of the rules wants any more arguments


Note [RULES apply to simplified arguments]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It's very desirable to try RULES once the arguments have been simplified, because
doing so ensures that rule cascades work in one pass.  Consider
   {-# RULES g (h x) = k x
             f (k x) = x #-}
   ...f (g (h x))...
Then we want to rewrite (g (h x)) to (k x) and only then try f's rules. If
we match f's rules against the un-simplified RHS, it won't match.  This
makes a particularly big difference when superclass selectors are involved:
        op ($p1 ($p2 (df d)))
We want all this to unravel in one sweep.

Note [Rewrite rules and inlining]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In general we try to arrange that inlining is disabled (via a pragma) if
a rewrite rule should apply, so that the rule has a decent chance to fire
before we inline the function.

But it turns out that (especially when type-class specialisation or
SpecConstr is involved) it is very helpful for the the rewrite rule to
&quot;win&quot; over inlining when both are active at once: see #21851, #22097.

The simplifier arranges to do this, as follows. In effect, the ai_rewrite
field of the ArgInfo record is the state of a little state-machine:

* mkArgInfo sets the ai_rewrite field to TryRules if there are any rewrite
  rules avaialable for that function.

* rebuildCall simplifies arguments until enough are simplified to match the
  rule with greatest arity.  See Note [RULES apply to simplified arguments]
  and the first field of `TryRules`.

  But no more! As soon as we have simplified enough arguments to satisfy the
  maximum-arity rules, we try the rules; see Note [Trying rewrite rules].

* Once we have tried rules (or immediately if there are no rules) set
  ai_rewrite to TryInlining, and the Simplifier will try to inline the
  function.  We want to try this immediately (before simplifying any (more)
  arguments). Why? Consider
      f BIG      where   f = \x{OneOcc}. ...x...
  If we inline `f` before simplifying `BIG` well use preInlineUnconditionally,
  and we'll simplify BIG once, at x's occurrence, rather than twice.

* GHC.Core.Opt.Simplify.Utils. mkRewriteCall: if there are no rules, and no
  unfolding, we can skip both TryRules and TryInlining, which saves work.

Note [Avoid redundant simplification]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Because RULES apply to simplified arguments, there's a danger of repeatedly
simplifying already-simplified arguments.  An important example is that of
        (&gt;&gt;=) d e1 e2
Here e1, e2 are simplified before the rule is applied, but don't really
participate in the rule firing. So we mark them as Simplified to avoid
re-simplifying them.

Note [Shadowing in the Simplifier]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
This part of the simplifier may return an expression that has shadowing.
(See Note [Shadowing in Core] in GHC.Core.hs.) Consider
        f (...(\a -&gt; e)...) (case y of (a,b) -&gt; e')
where f is strict in its second arg
If we simplify the innermost one first we get (...(\a -&gt; e)...)
Simplifying the second arg makes us float the case out, so we end up with
        case y of (a,b) -&gt; f (...(\a -&gt; e)...) e'
So the output does not have the no-shadowing invariant.  However, there is
no danger of getting name-capture, because when the first arg was simplified
we used an in-scope set that at least mentioned all the variables free in its
static environment, and that is enough.

We can't just do innermost first, or we'd end up with a dual problem:
        case x of (a,b) -&gt; f e (...(\a -&gt; e')...)

I spent hours trying to recover the no-shadowing invariant, but I just could
not think of an elegant way to do it.  The simplifier is already knee-deep in
continuations.  We have to keep the right in-scope set around; AND we have
to get the effect that finding (error &quot;foo&quot;) in a strict arg position will
discard the entire application and replace it with (error &quot;foo&quot;).  Getting
all this at once is TOO HARD!

See also Note [Shadowing in prepareAlts] in GHC.Core.Opt.Simplify.Utils.

Note [No eta-expansion in runRW#]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we see `runRW# (\s. blah)` we must not attempt to eta-expand that
lambda.  Why not?  Because
* `blah` can mention join points bound outside the runRW#
* eta-expansion uses arityType, and
* `arityType` cannot cope with free join Ids:

So the simplifier spots the literal lambda, and simplifies inside it.
It's a very special lambda, because it is the one the OccAnal spots and
allows join points bound /outside/ to be called /inside/.

See Note [No free join points in arityType] in GHC.Core.Opt.Arity

************************************************************************
*                                                                      *
                Rewrite rules
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-2573"></span><span>
</span><span id="line-2574"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#tryRules"><span class="hs-identifier hs-type">tryRules</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2575"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>
</span><span id="line-2576"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgSpec"><span class="hs-identifier hs-type">ArgSpec</span></a></span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- In /normal, forward/ order</span><span>
</span><span id="line-2577"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-2578"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2579"></span><span>
</span><span id="line-2580"></span><span id="tryRules"><span class="annot"><span class="annottext">tryRules :: SimplEnv
-&gt; [CoreRule]
-&gt; CoreBndr
-&gt; [ArgSpec]
-&gt; SimplCont
-&gt; SimplM (Maybe (SimplEnv, CoreExpr, SimplCont))
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#tryRules"><span class="hs-identifier hs-var hs-var">tryRules</span></a></span></span><span> </span><span id="local-6989586621682980184"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980184"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980185"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682980185"><span class="hs-identifier hs-var">rules</span></a></span></span><span> </span><span id="local-6989586621682980186"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980186"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span id="local-6989586621682980187"><span class="annot"><span class="annottext">[ArgSpec]
</span><a href="#local-6989586621682980187"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621682980188"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980188"><span class="hs-identifier hs-var">call_cont</span></a></span></span><span>
</span><span id="line-2581"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[CoreRule] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682980185"><span class="hs-identifier hs-var">rules</span></a></span><span>
</span><span id="line-2582"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (SimplEnv, CoreExpr, SimplCont)
-&gt; SimplM (Maybe (SimplEnv, CoreExpr, SimplCont))
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe (SimplEnv, CoreExpr, SimplCont)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-2583"></span><span>
</span><span id="line-2584"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980189"><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682980189"><span class="hs-identifier hs-var">rule</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980190"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980190"><span class="hs-identifier hs-var">rule_rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RuleOpts
-&gt; InScopeEnv
-&gt; (Activation -&gt; Bool)
-&gt; CoreBndr
-&gt; [CoreExpr]
-&gt; [CoreRule]
-&gt; Maybe (CoreRule, CoreExpr)
</span><a href="GHC.Core.Rules.html#lookupRule"><span class="hs-identifier hs-var">lookupRule</span></a></span><span> </span><span class="annot"><span class="annottext">RuleOpts
</span><a href="#local-6989586621682980191"><span class="hs-identifier hs-var">ropts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv -&gt; InScopeEnv
</span><a href="GHC.Core.Opt.Simplify.Utils.html#getUnfoldingInRuleMatch"><span class="hs-identifier hs-var">getUnfoldingInRuleMatch</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980184"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2585"></span><span>                                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplMode -&gt; Activation -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#activeRule"><span class="hs-identifier hs-var">activeRule</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplMode
</span><a href="GHC.Core.Opt.Simplify.Env.html#seMode"><span class="hs-identifier hs-var">seMode</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980184"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980186"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-2586"></span><span>                                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ArgSpec] -&gt; [CoreExpr]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#argInfoAppArgs"><span class="hs-identifier hs-var">argInfoAppArgs</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgSpec]
</span><a href="#local-6989586621682980187"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682980185"><span class="hs-identifier hs-var">rules</span></a></span><span>
</span><span id="line-2587"></span><span>  </span><span class="hs-comment">-- Fire a rule for the function</span><span>
</span><span id="line-2588"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682980196"><span class="annot"><a href="#local-6989586621682980196"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplM Logger
forall (m :: * -&gt; *). HasLogger m =&gt; m Logger
</span><a href="GHC.Utils.Logger.html#getLogger"><span class="hs-identifier hs-var">getLogger</span></a></span><span>
</span><span id="line-2589"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#checkedTick"><span class="hs-identifier hs-type">checkedTick</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Stats.html#RuleFired"><span class="hs-identifier hs-type">RuleFired</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#ruleName"><span class="hs-identifier hs-type">ruleName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980189"><span class="hs-identifier hs-type">rule</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2590"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682980199"><span class="annot"><a href="#local-6989586621682980199"><span class="hs-identifier hs-var hs-var">cont'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; [ArgSpec] -&gt; SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#pushSimplifiedArgs"><span class="hs-identifier hs-var">pushSimplifiedArgs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980201"><span class="hs-identifier hs-var">zapped_env</span></a></span><span>
</span><span id="line-2591"></span><span>                                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; [ArgSpec] -&gt; [ArgSpec]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreRule -&gt; Int
</span><a href="GHC.Core.html#ruleArity"><span class="hs-identifier hs-var">ruleArity</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682980189"><span class="hs-identifier hs-var">rule</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ArgSpec]
</span><a href="#local-6989586621682980187"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2592"></span><span>                                        </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980188"><span class="hs-identifier hs-var">call_cont</span></a></span><span>
</span><span id="line-2593"></span><span>                     </span><span class="hs-comment">-- (ruleArity rule) says how</span><span>
</span><span id="line-2594"></span><span>                     </span><span class="hs-comment">-- many args the rule consumed</span><span>
</span><span id="line-2595"></span><span>
</span><span id="line-2596"></span><span>             </span><span id="local-6989586621682980204"><span class="annot"><a href="#local-6989586621682980204"><span class="hs-identifier hs-var hs-var">occ_anald_rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#occurAnalyseExpr"><span class="hs-identifier hs-var">occurAnalyseExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980190"><span class="hs-identifier hs-var">rule_rhs</span></a></span><span>
</span><span id="line-2597"></span><span>                 </span><span class="hs-comment">-- See Note [Occurrence-analyse after rule firing]</span><span>
</span><span id="line-2598"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="#local-6989586621682980205"><span class="hs-identifier hs-type">dump</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980196"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980189"><span class="hs-identifier hs-type">rule</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980190"><span class="hs-identifier hs-type">rule_rhs</span></a></span><span>
</span><span id="line-2599"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682980201"><span class="hs-identifier hs-type">zapped_env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682980204"><span class="hs-identifier hs-type">occ_anald_rhs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682980199"><span class="hs-identifier hs-type">cont'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2600"></span><span>            </span><span class="hs-comment">-- The occ_anald_rhs and cont' are all Out things</span><span>
</span><span id="line-2601"></span><span>            </span><span class="hs-comment">-- hence zapping the environment</span><span>
</span><span id="line-2602"></span><span>
</span><span id="line-2603"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>  </span><span class="hs-comment">-- No rule fires</span><span>
</span><span id="line-2604"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682980206"><span class="annot"><a href="#local-6989586621682980206"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplM Logger
forall (m :: * -&gt; *). HasLogger m =&gt; m Logger
</span><a href="GHC.Utils.Logger.html#getLogger"><span class="hs-identifier hs-var">getLogger</span></a></span><span>
</span><span id="line-2605"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="#local-6989586621682980207"><span class="hs-identifier hs-type">nodump</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980206"><span class="hs-identifier hs-type">logger</span></a></span><span>  </span><span class="hs-comment">-- This ensures that an empty file is written</span><span>
</span><span id="line-2606"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2607"></span><span>
</span><span id="line-2608"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2609"></span><span>    </span><span id="local-6989586621682980191"><span class="annot"><span class="annottext">ropts :: RuleOpts
</span><a href="#local-6989586621682980191"><span class="hs-identifier hs-var hs-var">ropts</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; RuleOpts
</span><a href="GHC.Core.Opt.Simplify.Env.html#seRuleOpts"><span class="hs-identifier hs-var">seRuleOpts</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980184"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-2610"></span><span>    </span><span id="local-6989586621682980201"><span class="annot"><span class="annottext">zapped_env :: SimplEnv
</span><a href="#local-6989586621682980201"><span class="hs-identifier hs-var hs-var">zapped_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#zapSubstEnv"><span class="hs-identifier hs-var">zapSubstEnv</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980184"><span class="hs-identifier hs-var">env</span></a></span><span>  </span><span class="hs-comment">-- See Note [zapSubstEnv]</span><span>
</span><span id="line-2611"></span><span>
</span><span id="line-2612"></span><span>    </span><span id="local-6989586621682980216"><span class="annot"><span class="annottext">printRuleModule :: CoreRule -&gt; doc
</span><a href="#local-6989586621682980216"><span class="hs-identifier hs-var hs-var">printRuleModule</span></a></span></span><span> </span><span id="local-6989586621682980217"><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682980217"><span class="hs-identifier hs-var">rule</span></a></span></span><span>
</span><span id="line-2613"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">doc -&gt; doc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">doc -&gt; (Module -&gt; doc) -&gt; Maybe Module -&gt; doc
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; doc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;BUILTIN&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-2614"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ModuleName -&gt; doc
forall doc. IsLine doc =&gt; ModuleName -&gt; doc
</span><a href="GHC.Utils.Outputable.html#pprModuleName"><span class="hs-identifier hs-var">pprModuleName</span></a></span><span> </span><span class="annot"><span class="annottext">(ModuleName -&gt; doc) -&gt; (Module -&gt; ModuleName) -&gt; Module -&gt; doc
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Module -&gt; ModuleName
forall unit. GenModule unit -&gt; ModuleName
</span><a href="GHC.Unit.Types.html#moduleName"><span class="hs-identifier hs-var">moduleName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2615"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreRule -&gt; Maybe Module
</span><a href="GHC.Core.html#ruleModule"><span class="hs-identifier hs-var">ruleModule</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682980217"><span class="hs-identifier hs-var">rule</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2616"></span><span>
</span><span id="line-2617"></span><span>    </span><span id="local-6989586621682980205"><span class="annot"><span class="annottext">dump :: Logger -&gt; CoreRule -&gt; CoreExpr -&gt; SimplM ()
</span><a href="#local-6989586621682980205"><span class="hs-identifier hs-var hs-var">dump</span></a></span></span><span> </span><span id="local-6989586621682980222"><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621682980222"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621682980223"><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682980223"><span class="hs-identifier hs-var">rule</span></a></span></span><span> </span><span id="local-6989586621682980224"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980224"><span class="hs-identifier hs-var">rule_rhs</span></a></span></span><span>
</span><span id="line-2618"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Logger -&gt; DumpFlag -&gt; Bool
</span><a href="GHC.Utils.Logger.html#logHasDumpFlag"><span class="hs-identifier hs-var">logHasDumpFlag</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621682980222"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">DumpFlag
</span><a href="GHC.Driver.Flags.html#Opt_D_dump_rule_rewrites"><span class="hs-identifier hs-var">Opt_D_dump_rule_rewrites</span></a></span><span>
</span><span id="line-2619"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DumpFlag -&gt; String -&gt; SDoc -&gt; SimplM ()
forall {m :: * -&gt; *}.
(HasLogger m, MonadIO m) =&gt;
DumpFlag -&gt; String -&gt; SDoc -&gt; m ()
</span><a href="#local-6989586621682980226"><span class="hs-identifier hs-var">log_rule</span></a></span><span> </span><span class="annot"><span class="annottext">DumpFlag
</span><a href="GHC.Driver.Flags.html#Opt_D_dump_rule_rewrites"><span class="hs-identifier hs-var">Opt_D_dump_rule_rewrites</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Rule fired&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; SimplM ()) -&gt; SDoc -&gt; SimplM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span>
</span><span id="line-2620"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Rule:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">FastString -&gt; SDoc
forall doc. IsLine doc =&gt; FastString -&gt; doc
</span><a href="GHC.Utils.Outputable.html#ftext"><span class="hs-identifier hs-var">ftext</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreRule -&gt; FastString
</span><a href="GHC.Core.html#ruleName"><span class="hs-identifier hs-var">ruleName</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682980223"><span class="hs-identifier hs-var">rule</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2621"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Module:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span>  </span><span class="annot"><span class="annottext">CoreRule -&gt; SDoc
forall {doc}. IsLine doc =&gt; CoreRule -&gt; doc
</span><a href="#local-6989586621682980216"><span class="hs-identifier hs-var">printRuleModule</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682980223"><span class="hs-identifier hs-var">rule</span></a></span><span>
</span><span id="line-2622"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Before:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; Int -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980186"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ArgSpec -&gt; SDoc) -&gt; [ArgSpec] -&gt; [SDoc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">ArgSpec -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgSpec]
</span><a href="#local-6989586621682980187"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2623"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;After: &quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; Int -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; SDoc
forall b. OutputableBndr b =&gt; Expr b -&gt; SDoc
</span><a href="GHC.Core.Ppr.html#pprCoreExpr"><span class="hs-identifier hs-var">pprCoreExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980224"><span class="hs-identifier hs-var">rule_rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span>
</span><span id="line-2624"></span><span>                               </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="annot"><span class="annottext">([SDoc] -&gt; SDoc) -&gt; [SDoc] -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(ArgSpec -&gt; SDoc) -&gt; [ArgSpec] -&gt; [SDoc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">ArgSpec -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">([ArgSpec] -&gt; [SDoc]) -&gt; [ArgSpec] -&gt; [SDoc]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [ArgSpec] -&gt; [ArgSpec]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreRule -&gt; Int
</span><a href="GHC.Core.html#ruleArity"><span class="hs-identifier hs-var">ruleArity</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682980223"><span class="hs-identifier hs-var">rule</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ArgSpec]
</span><a href="#local-6989586621682980187"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2625"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Cont:  &quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980188"><span class="hs-identifier hs-var">call_cont</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-2626"></span><span>
</span><span id="line-2627"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Logger -&gt; DumpFlag -&gt; Bool
</span><a href="GHC.Utils.Logger.html#logHasDumpFlag"><span class="hs-identifier hs-var">logHasDumpFlag</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621682980222"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">DumpFlag
</span><a href="GHC.Driver.Flags.html#Opt_D_dump_rule_firings"><span class="hs-identifier hs-var">Opt_D_dump_rule_firings</span></a></span><span>
</span><span id="line-2628"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DumpFlag -&gt; String -&gt; SDoc -&gt; SimplM ()
forall {m :: * -&gt; *}.
(HasLogger m, MonadIO m) =&gt;
DumpFlag -&gt; String -&gt; SDoc -&gt; m ()
</span><a href="#local-6989586621682980226"><span class="hs-identifier hs-var">log_rule</span></a></span><span> </span><span class="annot"><span class="annottext">DumpFlag
</span><a href="GHC.Driver.Flags.html#Opt_D_dump_rule_firings"><span class="hs-identifier hs-var">Opt_D_dump_rule_firings</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Rule fired:&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; SimplM ()) -&gt; SDoc -&gt; SimplM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2629"></span><span>          </span><span class="annot"><span class="annottext">FastString -&gt; SDoc
forall doc. IsLine doc =&gt; FastString -&gt; doc
</span><a href="GHC.Utils.Outputable.html#ftext"><span class="hs-identifier hs-var">ftext</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreRule -&gt; FastString
</span><a href="GHC.Core.html#ruleName"><span class="hs-identifier hs-var">ruleName</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682980223"><span class="hs-identifier hs-var">rule</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2630"></span><span>            </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule -&gt; SDoc
forall {doc}. IsLine doc =&gt; CoreRule -&gt; doc
</span><a href="#local-6989586621682980216"><span class="hs-identifier hs-var">printRuleModule</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682980223"><span class="hs-identifier hs-var">rule</span></a></span><span>
</span><span id="line-2631"></span><span>
</span><span id="line-2632"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2633"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; SimplM ()
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2634"></span><span>
</span><span id="line-2635"></span><span>    </span><span id="local-6989586621682980207"><span class="annot"><span class="annottext">nodump :: Logger -&gt; m ()
</span><a href="#local-6989586621682980207"><span class="hs-identifier hs-var hs-var">nodump</span></a></span></span><span> </span><span id="local-6989586621682980245"><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621682980245"><span class="hs-identifier hs-var">logger</span></a></span></span><span>
</span><span id="line-2636"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Logger -&gt; DumpFlag -&gt; Bool
</span><a href="GHC.Utils.Logger.html#logHasDumpFlag"><span class="hs-identifier hs-var">logHasDumpFlag</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621682980245"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">DumpFlag
</span><a href="GHC.Driver.Flags.html#Opt_D_dump_rule_rewrites"><span class="hs-identifier hs-var">Opt_D_dump_rule_rewrites</span></a></span><span>
</span><span id="line-2637"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2638"></span><span>          </span><span class="annot"><span class="annottext">Logger -&gt; DumpFlag -&gt; IO ()
</span><a href="GHC.Utils.Logger.html#touchDumpFile"><span class="hs-identifier hs-var">touchDumpFile</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621682980245"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">DumpFlag
</span><a href="GHC.Driver.Flags.html#Opt_D_dump_rule_rewrites"><span class="hs-identifier hs-var">Opt_D_dump_rule_rewrites</span></a></span><span>
</span><span id="line-2639"></span><span>
</span><span id="line-2640"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Logger -&gt; DumpFlag -&gt; Bool
</span><a href="GHC.Utils.Logger.html#logHasDumpFlag"><span class="hs-identifier hs-var">logHasDumpFlag</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621682980245"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">DumpFlag
</span><a href="GHC.Driver.Flags.html#Opt_D_dump_rule_firings"><span class="hs-identifier hs-var">Opt_D_dump_rule_firings</span></a></span><span>
</span><span id="line-2641"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2642"></span><span>          </span><span class="annot"><span class="annottext">Logger -&gt; DumpFlag -&gt; IO ()
</span><a href="GHC.Utils.Logger.html#touchDumpFile"><span class="hs-identifier hs-var">touchDumpFile</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621682980245"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">DumpFlag
</span><a href="GHC.Driver.Flags.html#Opt_D_dump_rule_firings"><span class="hs-identifier hs-var">Opt_D_dump_rule_firings</span></a></span><span>
</span><span id="line-2643"></span><span>
</span><span id="line-2644"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2645"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2646"></span><span>
</span><span id="line-2647"></span><span>    </span><span id="local-6989586621682980226"><span class="annot"><span class="annottext">log_rule :: DumpFlag -&gt; String -&gt; SDoc -&gt; m ()
</span><a href="#local-6989586621682980226"><span class="hs-identifier hs-var hs-var">log_rule</span></a></span></span><span> </span><span id="local-6989586621682980262"><span class="annot"><span class="annottext">DumpFlag
</span><a href="#local-6989586621682980262"><span class="hs-identifier hs-var">flag</span></a></span></span><span> </span><span id="local-6989586621682980263"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621682980263"><span class="hs-identifier hs-var">hdr</span></a></span></span><span> </span><span id="local-6989586621682980264"><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621682980264"><span class="hs-identifier hs-var">details</span></a></span></span><span>
</span><span id="line-2648"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2649"></span><span>      </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682980265"><span class="annot"><a href="#local-6989586621682980265"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m Logger
forall (m :: * -&gt; *). HasLogger m =&gt; m Logger
</span><a href="GHC.Utils.Logger.html#getLogger"><span class="hs-identifier hs-var">getLogger</span></a></span><span>
</span><span id="line-2650"></span><span>      </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#logDumpFile"><span class="hs-identifier hs-type">logDumpFile</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980265"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#mkDumpStyle"><span class="hs-identifier hs-type">mkDumpStyle</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#alwaysQualify"><span class="hs-identifier hs-type">alwaysQualify</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682980262"><span class="hs-identifier hs-type">flag</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#FormatText"><span class="hs-identifier hs-type">FormatText</span></a></span><span>
</span><span id="line-2651"></span><span>               </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#sep"><span class="hs-identifier hs-type">sep</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980263"><span class="hs-identifier hs-type">hdr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#nest"><span class="hs-identifier hs-type">nest</span></a></span><span> </span><span class="annot"><span class="hs-number">4</span></span><span> </span><span class="annot"><a href="#local-6989586621682980264"><span class="hs-identifier hs-type">details</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2652"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-2653"></span><span>
</span><span id="line-2654"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#trySeqRules"><span class="hs-identifier hs-type">trySeqRules</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span>
</span><span id="line-2655"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span>   </span><span class="hs-comment">-- Scrutinee and RHS</span><span>
</span><span id="line-2656"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-2657"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2658"></span><span class="hs-comment">-- See Note [User-defined RULES for seq]</span><span>
</span><span id="line-2659"></span><span id="trySeqRules"><span class="annot"><span class="annottext">trySeqRules :: SimplEnv
-&gt; CoreExpr
-&gt; CoreExpr
-&gt; SimplCont
-&gt; SimplM (Maybe (SimplEnv, CoreExpr, SimplCont))
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#trySeqRules"><span class="hs-identifier hs-var hs-var">trySeqRules</span></a></span></span><span> </span><span id="local-6989586621682980267"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980267"><span class="hs-identifier hs-var">in_env</span></a></span></span><span> </span><span id="local-6989586621682980268"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980268"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621682980269"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980269"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span id="local-6989586621682980270"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980270"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-2660"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682980271"><span class="annot"><a href="#local-6989586621682980271"><span class="hs-identifier hs-var">rule_base</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplM RuleEnv
</span><a href="GHC.Core.Opt.Simplify.Monad.html#getSimplRules"><span class="hs-identifier hs-var">getSimplRules</span></a></span><span>
</span><span id="line-2661"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#tryRules"><span class="hs-identifier hs-type">tryRules</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980267"><span class="hs-identifier hs-type">in_env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Rules.html#getRules"><span class="hs-identifier hs-type">getRules</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980271"><span class="hs-identifier hs-type">rule_base</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Id.Make.html#seqId"><span class="hs-identifier hs-type">seqId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="GHC.Types.Id.Make.html#seqId"><span class="hs-identifier hs-type">seqId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980272"><span class="hs-identifier hs-type">out_args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980273"><span class="hs-identifier hs-type">rule_cont</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2662"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2663"></span><span>    </span><span id="local-6989586621682980274"><span class="annot"><span class="annottext">no_cast_scrut :: CoreExpr
</span><a href="#local-6989586621682980274"><span class="hs-identifier hs-var hs-var">no_cast_scrut</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
forall {b}. Expr b -&gt; Expr b
</span><a href="#local-6989586621682980275"><span class="hs-identifier hs-var">drop_casts</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980268"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-2664"></span><span>    </span><span id="local-6989586621682980276"><span class="annot"><span class="annottext">scrut_ty :: Kind
</span><a href="#local-6989586621682980276"><span class="hs-identifier hs-var hs-var">scrut_ty</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; Kind
CoreExpr -&gt; Kind
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980274"><span class="hs-identifier hs-var">no_cast_scrut</span></a></span><span>
</span><span id="line-2665"></span><span>    </span><span id="local-6989586621682980277"><span class="annot"><span class="annottext">seq_id_ty :: Kind
</span><a href="#local-6989586621682980277"><span class="hs-identifier hs-var hs-var">seq_id_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Kind
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="GHC.Types.Id.Make.html#seqId"><span class="hs-identifier hs-var">seqId</span></a></span><span>                    </span><span class="hs-comment">-- forall r a (b::TYPE r). a -&gt; b -&gt; b</span><span>
</span><span id="line-2666"></span><span>    </span><span id="local-6989586621682980278"><span class="annot"><span class="annottext">res1_ty :: Kind
</span><a href="#local-6989586621682980278"><span class="hs-identifier hs-var hs-var">res1_ty</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Kind -&gt; Kind -&gt; Kind
Kind -&gt; Kind -&gt; Kind
</span><a href="GHC.Core.Type.html#piResultTy"><span class="hs-identifier hs-var">piResultTy</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980277"><span class="hs-identifier hs-var">seq_id_ty</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980280"><span class="hs-identifier hs-var">rhs_rep</span></a></span><span>    </span><span class="hs-comment">-- forall a (b::TYPE rhs_rep). a -&gt; b -&gt; b</span><span>
</span><span id="line-2667"></span><span>    </span><span id="local-6989586621682980281"><span class="annot"><span class="annottext">res2_ty :: Kind
</span><a href="#local-6989586621682980281"><span class="hs-identifier hs-var hs-var">res2_ty</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Kind -&gt; Kind -&gt; Kind
Kind -&gt; Kind -&gt; Kind
</span><a href="GHC.Core.Type.html#piResultTy"><span class="hs-identifier hs-var">piResultTy</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980278"><span class="hs-identifier hs-var">res1_ty</span></a></span><span>   </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980276"><span class="hs-identifier hs-var">scrut_ty</span></a></span><span>   </span><span class="hs-comment">-- forall (b::TYPE rhs_rep). scrut_ty -&gt; b -&gt; b</span><span>
</span><span id="line-2668"></span><span>    </span><span id="local-6989586621682980282"><span class="annot"><span class="annottext">res3_ty :: Kind
</span><a href="#local-6989586621682980282"><span class="hs-identifier hs-var hs-var">res3_ty</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Kind -&gt; Kind -&gt; Kind
Kind -&gt; Kind -&gt; Kind
</span><a href="GHC.Core.Type.html#piResultTy"><span class="hs-identifier hs-var">piResultTy</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980281"><span class="hs-identifier hs-var">res2_ty</span></a></span><span>   </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980283"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span>     </span><span class="hs-comment">-- scrut_ty -&gt; rhs_ty -&gt; rhs_ty</span><span>
</span><span id="line-2669"></span><span>    </span><span id="local-6989586621682980284"><span class="annot"><span class="annottext">res4_ty :: Kind
</span><a href="#local-6989586621682980284"><span class="hs-identifier hs-var hs-var">res4_ty</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Kind -&gt; Kind
Kind -&gt; Kind
</span><a href="GHC.Core.Type.html#funResultTy"><span class="hs-identifier hs-var">funResultTy</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980282"><span class="hs-identifier hs-var">res3_ty</span></a></span><span>             </span><span class="hs-comment">-- rhs_ty -&gt; rhs_ty</span><span>
</span><span id="line-2670"></span><span>    </span><span id="local-6989586621682980283"><span class="annot"><span class="annottext">rhs_ty :: Kind
</span><a href="#local-6989586621682980283"><span class="hs-identifier hs-var hs-var">rhs_ty</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; SimplEnv -&gt; Kind -&gt; Kind
SimplEnv -&gt; Kind -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Env.html#substTy"><span class="hs-identifier hs-var">substTy</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980267"><span class="hs-identifier hs-var">in_env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; Kind
CoreExpr -&gt; Kind
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980269"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2671"></span><span>    </span><span id="local-6989586621682980280"><span class="annot"><span class="annottext">rhs_rep :: Kind
</span><a href="#local-6989586621682980280"><span class="hs-identifier hs-var hs-var">rhs_rep</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Kind -&gt; Kind
Kind -&gt; Kind
</span><a href="GHC.Core.Type.html#getRuntimeRep"><span class="hs-identifier hs-var">getRuntimeRep</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980283"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span>
</span><span id="line-2672"></span><span>    </span><span id="local-6989586621682980272"><span class="annot"><span class="annottext">out_args :: [ArgSpec]
</span><a href="#local-6989586621682980272"><span class="hs-identifier hs-var hs-var">out_args</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#TyArg"><span class="hs-identifier hs-type">TyArg</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">as_arg_ty :: Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#as_arg_ty"><span class="hs-identifier hs-var">as_arg_ty</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980280"><span class="hs-identifier hs-var">rhs_rep</span></a></span><span>
</span><span id="line-2673"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">as_hole_ty :: Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#as_hole_ty"><span class="hs-identifier hs-var">as_hole_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980277"><span class="hs-identifier hs-var">seq_id_ty</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2674"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#TyArg"><span class="hs-identifier hs-type">TyArg</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">as_arg_ty :: Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#as_arg_ty"><span class="hs-identifier hs-var">as_arg_ty</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980276"><span class="hs-identifier hs-var">scrut_ty</span></a></span><span>
</span><span id="line-2675"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">as_hole_ty :: Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#as_hole_ty"><span class="hs-identifier hs-var">as_hole_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980278"><span class="hs-identifier hs-var">res1_ty</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2676"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#TyArg"><span class="hs-identifier hs-type">TyArg</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">as_arg_ty :: Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#as_arg_ty"><span class="hs-identifier hs-var">as_arg_ty</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980283"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span>
</span><span id="line-2677"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">as_hole_ty :: Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#as_hole_ty"><span class="hs-identifier hs-var">as_hole_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980281"><span class="hs-identifier hs-var">res2_ty</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2678"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ValArg"><span class="hs-identifier hs-type">ValArg</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">as_arg :: CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#as_arg"><span class="hs-identifier hs-var">as_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980274"><span class="hs-identifier hs-var">no_cast_scrut</span></a></span><span>
</span><span id="line-2679"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">as_dmd :: Demand
</span><a href="GHC.Core.Opt.Simplify.Utils.html#as_dmd"><span class="hs-identifier hs-var">as_dmd</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="GHC.Types.Demand.html#seqDmd"><span class="hs-identifier hs-var">seqDmd</span></a></span><span>
</span><span id="line-2680"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">as_hole_ty :: Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#as_hole_ty"><span class="hs-identifier hs-var">as_hole_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980282"><span class="hs-identifier hs-var">res3_ty</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-2681"></span><span>    </span><span id="local-6989586621682980273"><span class="annot"><span class="annottext">rule_cont :: SimplCont
</span><a href="#local-6989586621682980273"><span class="hs-identifier hs-var hs-var">rule_cont</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToVal"><span class="hs-identifier hs-type">ApplyToVal</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_dup :: DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_dup"><span class="hs-identifier hs-var">sc_dup</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#NoDup"><span class="hs-identifier hs-var">NoDup</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_arg :: CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_arg"><span class="hs-identifier hs-var">sc_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980269"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-2682"></span><span>                           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_env :: SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_env"><span class="hs-identifier hs-var">sc_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980267"><span class="hs-identifier hs-var">in_env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980270"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-2683"></span><span>                           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_hole_ty :: Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_hole_ty"><span class="hs-identifier hs-var">sc_hole_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980284"><span class="hs-identifier hs-var">res4_ty</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2684"></span><span>
</span><span id="line-2685"></span><span>    </span><span class="hs-comment">-- Lazily evaluated, so we don't do most of this</span><span>
</span><span id="line-2686"></span><span>
</span><span id="line-2687"></span><span>    </span><span id="local-6989586621682980275"><span class="annot"><span class="annottext">drop_casts :: Expr b -&gt; Expr b
</span><a href="#local-6989586621682980275"><span class="hs-identifier hs-var hs-var">drop_casts</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682980288"><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621682980288"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr b -&gt; Expr b
</span><a href="#local-6989586621682980275"><span class="hs-identifier hs-var">drop_casts</span></a></span><span> </span><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621682980288"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-2688"></span><span>    </span><span class="annot"><a href="#local-6989586621682980275"><span class="hs-identifier hs-var">drop_casts</span></a></span><span> </span><span id="local-6989586621682980289"><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621682980289"><span class="hs-identifier hs-var">e</span></a></span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621682980289"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-2689"></span><span>
</span><span id="line-2690"></span><span class="hs-comment">{- Note [User-defined RULES for seq]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Given
   case (scrut |&gt; co) of _ -&gt; rhs
look for rules that match the expression
   seq @t1 @t2 scrut
where scrut :: t1
      rhs   :: t2

If you find a match, rewrite it, and apply to 'rhs'.

Notice that we can simply drop casts on the fly here, which
makes it more likely that a rule will match.

See Note [User-defined RULES for seq] in GHC.Types.Id.Make.

Note [Occurrence-analyse after rule firing]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
After firing a rule, we occurrence-analyse the instantiated RHS before
simplifying it.  Usually this doesn't make much difference, but it can
be huge.  Here's an example (simplCore/should_compile/T7785)

  map f (map f (map f xs)

= -- Use build/fold form of map, twice
  map f (build (\cn. foldr (mapFB c f) n
                           (build (\cn. foldr (mapFB c f) n xs))))

= -- Apply fold/build rule
  map f (build (\cn. (\cn. foldr (mapFB c f) n xs) (mapFB c f) n))

= -- Beta-reduce
  -- Alas we have no occurrence-analysed, so we don't know
  -- that c is used exactly once
  map f (build (\cn. let c1 = mapFB c f in
                     foldr (mapFB c1 f) n xs))

= -- Use mapFB rule:   mapFB (mapFB c f) g = mapFB c (f.g)
  -- We can do this because (mapFB c n) is a PAP and hence expandable
  map f (build (\cn. let c1 = mapFB c n in
                     foldr (mapFB c (f.f)) n x))

This is not too bad.  But now do the same with the outer map, and
we get another use of mapFB, and t can interact with /both/ remaining
mapFB calls in the above expression.  This is stupid because actually
that 'c1' binding is dead.  The outer map introduces another c2. If
there is a deep stack of maps we get lots of dead bindings, and lots
of redundant work as we repeatedly simplify the result of firing rules.

The easy thing to do is simply to occurrence analyse the result of
the rule firing.  Note that this occ-anals not only the RHS of the
rule, but also the function arguments, which by now are OutExprs.
E.g.
      RULE f (g x) = x+1

Call   f (g BIG)  --&gt;   (\x. x+1) BIG

The rule binders are lambda-bound and applied to the OutExpr arguments
(here BIG) which lack all internal occurrence info.

Is this inefficient?  Not really: we are about to walk over the result
of the rule firing to simplify it, so occurrence analysis is at most
a constant factor.

Note, however, that the rule RHS is /already/ occ-analysed; see
Note [OccInfo in unfoldings and rules] in GHC.Core.  There is something
unsatisfactory about doing it twice; but the rule RHS is usually very
small, and this is simple.

Note [Rules for recursive functions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
You might think that we shouldn't apply rules for a loop breaker:
doing so might give rise to an infinite loop, because a RULE is
rather like an extra equation for the function:
     RULE:           f (g x) y = x+y
     Eqn:            f a     y = a-y

But it's too drastic to disable rules for loop breakers.
Even the foldr/build rule would be disabled, because foldr
is recursive, and hence a loop breaker:
     foldr k z (build g) = g k z
So it's up to the programmer: rules can cause divergence


************************************************************************
*                                                                      *
                Rebuilding a case expression
*                                                                      *
************************************************************************

Note [Case elimination]
~~~~~~~~~~~~~~~~~~~~~~~
The case-elimination transformation discards redundant case expressions.
Start with a simple situation:

        case x# of      ===&gt;   let y# = x# in e
          y# -&gt; e

(when x#, y# are of primitive type, of course).  We can't (in general)
do this for algebraic cases, because we might turn bottom into
non-bottom!

The code in GHC.Core.Opt.Simplify.Utils.prepareAlts has the effect of generalise
this idea to look for a case where we're scrutinising a variable, and we know
that only the default case can match.  For example:

        case x of
          0#      -&gt; ...
          DEFAULT -&gt; ...(case x of
                         0#      -&gt; ...
                         DEFAULT -&gt; ...) ...

Here the inner case is first trimmed to have only one alternative, the
DEFAULT, after which it's an instance of the previous case.  This
really only shows up in eliminating error-checking code.

Note that GHC.Core.Opt.Simplify.Utils.mkCase combines identical RHSs.  So

        case e of       ===&gt; case e of DEFAULT -&gt; r
           True  -&gt; r
           False -&gt; r

Now again the case may be eliminated by the CaseElim transformation.
This includes things like (==# a# b#)::Bool so that we simplify
      case ==# a# b# of { True -&gt; x; False -&gt; x }
to just
      x
This particular example shows up in default methods for
comparison operations (e.g. in (&gt;=) for Int.Int32)

Note [Case to let transformation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If a case over a lifted type has a single alternative, and is being
used as a strict 'let' (all isDeadBinder bndrs), we may want to do
this transformation:

    case e of r       ===&gt;   let r = e in ...r...
      _ -&gt; ...r...

We treat the unlifted and lifted cases separately:

* Unlifted case: 'e' satisfies exprOkForSpeculation
  (ok-for-spec is needed to satisfy the let-can-float invariant).
  This turns     case a +# b of r -&gt; ...r...
  into           let r = a +# b in ...r...
  and thence     .....(a +# b)....

  However, if we have
      case indexArray# a i of r -&gt; ...r...
  we might like to do the same, and inline the (indexArray# a i).
  But indexArray# is not okForSpeculation, so we don't build a let
  in rebuildCase (lest it get floated *out*), so the inlining doesn't
  happen either.  Annoying.

* Lifted case: we need to be sure that the expression is already
  evaluated (exprIsHNF).  If it's not already evaluated
      - we risk losing exceptions, divergence or
        user-specified thunk-forcing
      - even if 'e' is guaranteed to converge, we don't want to
        create a thunk (call by need) instead of evaluating it
        right away (call by value)

  However, we can turn the case into a /strict/ let if the 'r' is
  used strictly in the body.  Then we won't lose divergence; and
  we won't build a thunk because the let is strict.
  See also Note [Case-to-let for strictly-used binders]

Note [Case-to-let for strictly-used binders]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we have this:
   case &lt;scrut&gt; of r { _ -&gt; ..r.. }
where 'r' is used strictly in (..r..), we /could/ safely transform to
   let r = &lt;scrut&gt; in ...r...
As a special case,  we have a plain `seq` like
   case r of r1 { _ -&gt; ...r1... }
where `r` is used strictly, we /could/ simply drop the `case` to get
   ...r....

HOWEVER, there are some serious downsides to this transformation, so
GHC doesn't do it any longer (#24251):

* Suppose the Simplifier sees
     case x of y* { __DEFAULT -&gt;
     let z = case y of { __DEFAULT -&gt; expr } in
     z+1 }
  The &quot;y*&quot; means &quot;y is used strictly in its scope.  Now we may:
     - Eliminate the inner case because `y` is evaluated.
  Now the demand-info on `y` is not right, because `y` is no longer used
  strictly in its scope.  But it is hard to spot that without doing a new
  demand analysis.  So there is a danger that we will subsequently:
     - Eliminate the outer case because `y` is used strictly
  Yikes!  We can't eliminate both!

* It introduces space leaks (#24251).  Consider
      go 0 where go x = x `seq` go (x + 1)
  It is an infinite loop, true, but it should not leak space. Yet if we drop
  the `seq`, it will.  Another great example is #21741.

* Dropping the outer `case` can change the error behaviour.  For example,
  we might transform
       case x of { _ -&gt; error &quot;bad&quot; }    --&gt;     error &quot;bad&quot;
  which is might be puzzling if 'x' currently lambda-bound, but later gets
  let-bound to (error &quot;good&quot;).  Tht is OK accoring to the paper &quot;A semantics for
  imprecise exceptions&quot;, but see #8900 for an example where the loss of this
  transformation bit us in practice.

* If we have (case e of x -&gt; f x), where `f` is strict, then it looks as if `x`
  is strictly used, and we could soundly transform to
     let x = e in f x
  But if f's strictness info got worse (which can happen in in obscure cases;
  see #21392) then we might have turned a non-thunk into a thunk!  Bad.

Lacking this &quot;drop-strictly-used-seq&quot; transformation means we can end up with
some redundant-looking evals.  For example, consider
    f x y = case x of DEFAULT -&gt;    -- A redundant-looking eval
            case y of
              True  -&gt; case x of { Nothing -&gt; False; Just z  -&gt; z }
              False -&gt; case x of { Nothing -&gt; True;  Just z  -&gt; z }
That outer eval will be retained right through to code generation.  But,
perhaps surprisingly, that is probably a /good/ thing:

   Key point: those inner (case x) expressions will be compiled a simple 'if',
   because the code generator can see that `x` is, at those points, evaluated
   and properly tagged.

If we dropped the outer eval, both the inner (case x) expressions would need to
do a proper eval, pushing a return address, with an info table. See the example
in #15631 where, in the Description, the (case ys) will be a simple multi-way
jump.

In fact (#24251), when I stopped GHC implementing the drop-strictly-used-seqs
transformation, binary sizes fell by 1%, and a few programs actually allocated
less and ran faster.  A case in point is nofib/imaginary/digits-of-e2. (I'm not
sure exactly why it improves so much, though.)

Slightly related: Note [Empty case alternatives] in GHC.Core.

Historical notes:

There have been various earlier versions of this patch:

* By Sept 18 the code looked like this:
     || scrut_is_demanded_var scrut

    scrut_is_demanded_var :: CoreExpr -&gt; Bool
    scrut_is_demanded_var (Cast s _) = scrut_is_demanded_var s
    scrut_is_demanded_var (Var _)    = isStrUsedDmd (idDemandInfo case_bndr)
    scrut_is_demanded_var _          = False

  This only fired if the scrutinee was a /variable/, which seems
  an unnecessary restriction. So in #15631 I relaxed it to allow
  arbitrary scrutinees.  Less code, less to explain -- but the change
  had 0.00% effect on nofib.

* Previously, in Jan 13 the code looked like this:
     || case_bndr_evald_next rhs

    case_bndr_evald_next :: CoreExpr -&gt; Bool
      -- See Note [Case binder next]
    case_bndr_evald_next (Var v)         = v == case_bndr
    case_bndr_evald_next (Cast e _)      = case_bndr_evald_next e
    case_bndr_evald_next (App e _)       = case_bndr_evald_next e
    case_bndr_evald_next (Case e _ _ _)  = case_bndr_evald_next e
    case_bndr_evald_next _               = False

  This patch was part of fixing #7542. See also
  Note [Eta reduction soundness], criterion (E) in GHC.Core.Utils.)


Further notes about case elimination
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider:       test :: Integer -&gt; IO ()
                test = print

Turns out that this compiles to:
    Print.test
      = \ eta :: Integer
          eta1 :: Void# -&gt;
          case PrelNum.&lt; eta PrelNum.zeroInteger of wild { __DEFAULT -&gt;
          case hPutStr stdout
                 (PrelNum.jtos eta ($w[] @ Char))
                 eta1
          of wild1 { (# new_s, a4 #) -&gt; PrelIO.lvl23 new_s  }}

Notice the strange '&lt;' which has no effect at all. This is a funny one.
It started like this:

f x y = if x &lt; 0 then jtos x
          else if y==0 then &quot;&quot; else jtos x

At a particular call site we have (f v 1).  So we inline to get

        if v &lt; 0 then jtos x
        else if 1==0 then &quot;&quot; else jtos x

Now simplify the 1==0 conditional:

        if v&lt;0 then jtos v else jtos v

Now common-up the two branches of the case:

        case (v&lt;0) of DEFAULT -&gt; jtos v

Why don't we drop the case?  Because it's strict in v.  It's technically
wrong to drop even unnecessary evaluations, and in practice they
may be a result of 'seq' so we *definitely* don't want to drop those.
I don't really know how to improve this situation.


Note [FloatBinds from constructor wrappers]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we have FloatBinds coming from the constructor wrapper
(as in Note [exprIsConApp_maybe on data constructors with wrappers]),
we cannot float past them. We'd need to float the FloatBind
together with the simplify floats, unfortunately the
simplifier doesn't have case-floats. The simplest thing we can
do is to wrap all the floats here. The next iteration of the
simplifier will take care of all these cases and lets.

Given data T = MkT !Bool, this allows us to simplify
case $WMkT b of { MkT x -&gt; f x }
to
case b of { b' -&gt; f b' }.

We could try and be more clever (like maybe wfloats only contain
let binders, so we could float them). But the need for the
extra complication is not clear.

Note [Do not duplicate constructor applications]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this (#20125)
   let x = (a,b)
   in ...(case x of x' -&gt; blah)...x...x...

We want that `case` to vanish (since `x` is bound to a data con) leaving
   let x = (a,b)
   in ...(let x'=x in blah)...x..x...

In rebuildCase, `exprIsConApp_maybe` will succeed on the scrutinee `x`,
since is bound to (a,b).  But in eliminating the case, if the scrutinee
is trivial, we want to bind the case-binder to the scrutinee, /not/ to
the constructor application.  Hence the case_bndr_rhs in rebuildCase.

This applies equally to a non-DEFAULT case alternative, say
   let x = (a,b) in ...(case x of x' { (p,q) -&gt; blah })...
This variant is handled by bind_case_bndr in knownCon.

We want to bind x' to x, and not to a duplicated (a,b)).
-}</span><span>
</span><span id="line-3039"></span><span>
</span><span id="line-3040"></span><span class="hs-comment">---------------------------------------------------------</span><span>
</span><span id="line-3041"></span><span class="hs-comment">--      Eliminate the case if possible</span><span>
</span><span id="line-3042"></span><span>
</span><span id="line-3043"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuildCase"><span class="hs-identifier hs-type">rebuildCase</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#reallyRebuildCase"><span class="hs-identifier hs-type">reallyRebuildCase</span></a></span><span>
</span><span id="line-3044"></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span>
</span><span id="line-3045"></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>          </span><span class="hs-comment">-- Scrutinee</span><span>
</span><span id="line-3046"></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span>             </span><span class="hs-comment">-- Case binder</span><span>
</span><span id="line-3047"></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#InAlt"><span class="hs-identifier hs-type">InAlt</span></a></span><span class="hs-special">]</span><span>          </span><span class="hs-comment">-- Alternatives (increasing order)</span><span>
</span><span id="line-3048"></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-3049"></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3050"></span><span>
</span><span id="line-3051"></span><span class="hs-comment">--------------------------------------------------</span><span>
</span><span id="line-3052"></span><span class="hs-comment">--      1. Eliminate the case if there's a known constructor</span><span>
</span><span id="line-3053"></span><span class="hs-comment">--------------------------------------------------</span><span>
</span><span id="line-3054"></span><span>
</span><span id="line-3055"></span><span id="rebuildCase"><span class="annot"><span class="annottext">rebuildCase :: SimplEnv
-&gt; CoreExpr
-&gt; CoreBndr
-&gt; [Alt CoreBndr]
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuildCase"><span class="hs-identifier hs-var hs-var">rebuildCase</span></a></span></span><span> </span><span id="local-6989586621682980292"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980292"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980293"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980293"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621682980294"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980294"><span class="hs-identifier hs-var">case_bndr</span></a></span></span><span> </span><span id="local-6989586621682980295"><span class="annot"><span class="annottext">[Alt CoreBndr]
</span><a href="#local-6989586621682980295"><span class="hs-identifier hs-var">alts</span></a></span></span><span> </span><span id="local-6989586621682980296"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980296"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-3056"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-type">Lit</span></a></span><span> </span><span id="local-6989586621682980297"><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621682980297"><span class="hs-identifier hs-var">lit</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980293"><span class="hs-identifier hs-var">scrut</span></a></span><span>    </span><span class="hs-comment">-- No need for same treatment as constructors</span><span>
</span><span id="line-3057"></span><span>                        </span><span class="hs-comment">-- because literals are inlined more vigorously</span><span>
</span><span id="line-3058"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Literal -&gt; Bool
</span><a href="GHC.Types.Literal.html#litIsLifted"><span class="hs-identifier hs-var">litIsLifted</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621682980297"><span class="hs-identifier hs-var">lit</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3059"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Tick -&gt; SimplM ()
</span><a href="GHC.Core.Opt.Simplify.Monad.html#tick"><span class="hs-identifier hs-var">tick</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Tick
</span><a href="GHC.Core.Opt.Stats.html#KnownBranch"><span class="hs-identifier hs-var">KnownBranch</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980294"><span class="hs-identifier hs-var">case_bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3060"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">AltCon -&gt; [Alt CoreBndr] -&gt; Maybe (Alt CoreBndr)
forall b. AltCon -&gt; [Alt b] -&gt; Maybe (Alt b)
</span><a href="GHC.Core.Utils.html#findAlt"><span class="hs-identifier hs-var">findAlt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Literal -&gt; AltCon
</span><a href="GHC.Core.html#LitAlt"><span class="hs-identifier hs-var">LitAlt</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621682980297"><span class="hs-identifier hs-var">lit</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Alt CoreBndr]
</span><a href="#local-6989586621682980295"><span class="hs-identifier hs-var">alts</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3061"></span><span>            </span><span class="annot"><span class="annottext">Maybe (Alt CoreBndr)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; CoreBndr
-&gt; [Alt CoreBndr]
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#missingAlt"><span class="hs-identifier hs-var">missingAlt</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980292"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980294"><span class="hs-identifier hs-var">case_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt CoreBndr]
</span><a href="#local-6989586621682980295"><span class="hs-identifier hs-var">alts</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980296"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-3062"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682980302"><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980302"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621682980303"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980303"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; [FloatBind]
-&gt; CoreExpr
-&gt; [CoreBndr]
-&gt; CoreExpr
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="#local-6989586621682980304"><span class="hs-identifier hs-var">simple_rhs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980292"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980293"><span class="hs-identifier hs-var">scrut</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980302"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980303"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3063"></span><span>
</span><span id="line-3064"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980305"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682980305"><span class="hs-identifier hs-var">in_scope'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980306"><span class="annot"><span class="annottext">[FloatBind]
</span><a href="#local-6989586621682980306"><span class="hs-identifier hs-var">wfloats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980307"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682980307"><span class="hs-identifier hs-var">con</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980308"><span class="annot"><span class="annottext">[Kind]
</span><a href="#local-6989586621682980308"><span class="hs-identifier hs-var">ty_args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980309"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682980309"><span class="hs-identifier hs-var">other_args</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-3065"></span><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
InScopeEnv
-&gt; CoreExpr
-&gt; Maybe (InScopeSet, [FloatBind], DataCon, [Kind], [CoreExpr])
InScopeEnv
-&gt; CoreExpr
-&gt; Maybe (InScopeSet, [FloatBind], DataCon, [Kind], [CoreExpr])
</span><a href="GHC.Core.SimpleOpt.html#exprIsConApp_maybe"><span class="hs-identifier hs-var">exprIsConApp_maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv -&gt; InScopeEnv
</span><a href="GHC.Core.Opt.Simplify.Utils.html#getUnfoldingInRuleMatch"><span class="hs-identifier hs-var">getUnfoldingInRuleMatch</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980292"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980293"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-3066"></span><span>        </span><span class="hs-comment">-- Works when the scrutinee is a variable with a known unfolding</span><span>
</span><span id="line-3067"></span><span>        </span><span class="hs-comment">-- as well as when it's an explicit constructor application</span><span>
</span><span id="line-3068"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682980310"><span class="annot"><span class="annottext">env0 :: SimplEnv
</span><a href="#local-6989586621682980310"><span class="hs-identifier hs-var hs-var">env0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; InScopeSet -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#setInScopeSet"><span class="hs-identifier hs-var">setInScopeSet</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980292"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682980305"><span class="hs-identifier hs-var">in_scope'</span></a></span><span>
</span><span id="line-3069"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Tick -&gt; SimplM ()
</span><a href="GHC.Core.Opt.Simplify.Monad.html#tick"><span class="hs-identifier hs-var">tick</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Tick
</span><a href="GHC.Core.Opt.Stats.html#KnownBranch"><span class="hs-identifier hs-var">KnownBranch</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980294"><span class="hs-identifier hs-var">case_bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3070"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682980312"><span class="annot"><span class="annottext">scaled_wfloats :: [FloatBind]
</span><a href="#local-6989586621682980312"><span class="hs-identifier hs-var hs-var">scaled_wfloats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FloatBind -&gt; FloatBind) -&gt; [FloatBind] -&gt; [FloatBind]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">FloatBind -&gt; FloatBind
</span><a href="#local-6989586621682980313"><span class="hs-identifier hs-var">scale_float</span></a></span><span> </span><span class="annot"><span class="annottext">[FloatBind]
</span><a href="#local-6989586621682980306"><span class="hs-identifier hs-var">wfloats</span></a></span><span>
</span><span id="line-3071"></span><span>              </span><span class="hs-comment">-- case_bndr_unf: see Note [Do not duplicate constructor applications]</span><span>
</span><span id="line-3072"></span><span>              </span><span id="local-6989586621682980314"><span class="annot"><span class="annottext">case_bndr_rhs :: CoreExpr
</span><a href="#local-6989586621682980314"><span class="hs-identifier hs-var hs-var">case_bndr_rhs</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980293"><span class="hs-identifier hs-var">scrut</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980293"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-3073"></span><span>                            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980315"><span class="hs-identifier hs-var">con_app</span></a></span><span>
</span><span id="line-3074"></span><span>              </span><span id="local-6989586621682980315"><span class="annot"><span class="annottext">con_app :: CoreExpr
</span><a href="#local-6989586621682980315"><span class="hs-identifier hs-var hs-var">con_app</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; CoreExpr
forall b. CoreBndr -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; CoreBndr
</span><a href="GHC.Core.DataCon.html#dataConWorkId"><span class="hs-identifier hs-var">dataConWorkId</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682980307"><span class="hs-identifier hs-var">con</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; [Kind] -&gt; CoreExpr
forall b. Expr b -&gt; [Kind] -&gt; Expr b
</span><a href="GHC.Core.html#mkTyApps"><span class="hs-operator hs-var">`mkTyApps`</span></a></span><span> </span><span class="annot"><span class="annottext">[Kind]
</span><a href="#local-6989586621682980308"><span class="hs-identifier hs-var">ty_args</span></a></span><span>
</span><span id="line-3075"></span><span>                                                </span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; CoreExpr
forall b. Expr b -&gt; [Expr b] -&gt; Expr b
</span><a href="GHC.Core.html#mkApps"><span class="hs-operator hs-var">`mkApps`</span></a></span><span>   </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682980309"><span class="hs-identifier hs-var">other_args</span></a></span><span>
</span><span id="line-3076"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">AltCon -&gt; [Alt CoreBndr] -&gt; Maybe (Alt CoreBndr)
forall b. AltCon -&gt; [Alt b] -&gt; Maybe (Alt b)
</span><a href="GHC.Core.Utils.html#findAlt"><span class="hs-identifier hs-var">findAlt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; AltCon
</span><a href="GHC.Core.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682980307"><span class="hs-identifier hs-var">con</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Alt CoreBndr]
</span><a href="#local-6989586621682980295"><span class="hs-identifier hs-var">alts</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3077"></span><span>            </span><span class="annot"><span class="annottext">Maybe (Alt CoreBndr)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; CoreBndr
-&gt; [Alt CoreBndr]
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#missingAlt"><span class="hs-identifier hs-var">missingAlt</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980310"><span class="hs-identifier hs-var">env0</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980294"><span class="hs-identifier hs-var">case_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt CoreBndr]
</span><a href="#local-6989586621682980295"><span class="hs-identifier hs-var">alts</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980296"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-3078"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="GHC.Core.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a></span><span> </span><span id="local-6989586621682980318"><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980318"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621682980319"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980319"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; [FloatBind]
-&gt; CoreExpr
-&gt; [CoreBndr]
-&gt; CoreExpr
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="#local-6989586621682980304"><span class="hs-identifier hs-var">simple_rhs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980310"><span class="hs-identifier hs-var">env0</span></a></span><span> </span><span class="annot"><span class="annottext">[FloatBind]
</span><a href="#local-6989586621682980312"><span class="hs-identifier hs-var">scaled_wfloats</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980314"><span class="hs-identifier hs-var">case_bndr_rhs</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980318"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980319"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-3079"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><span class="hs-identifier">_</span></span><span>       </span><span id="local-6989586621682980320"><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980320"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621682980321"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980321"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; CoreExpr
-&gt; [FloatBind]
-&gt; DataCon
-&gt; [Kind]
-&gt; [CoreExpr]
-&gt; CoreBndr
-&gt; [CoreBndr]
-&gt; CoreExpr
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#knownCon"><span class="hs-identifier hs-var">knownCon</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980310"><span class="hs-identifier hs-var">env0</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980293"><span class="hs-identifier hs-var">scrut</span></a></span><span> </span><span class="annot"><span class="annottext">[FloatBind]
</span><a href="#local-6989586621682980312"><span class="hs-identifier hs-var">scaled_wfloats</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682980307"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">[Kind]
</span><a href="#local-6989586621682980308"><span class="hs-identifier hs-var">ty_args</span></a></span><span>
</span><span id="line-3080"></span><span>                                                  </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682980309"><span class="hs-identifier hs-var">other_args</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980294"><span class="hs-identifier hs-var">case_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980320"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980321"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980296"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-3081"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-3082"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3083"></span><span>    </span><span id="local-6989586621682980304"><span class="annot"><span class="annottext">simple_rhs :: SimplEnv
-&gt; [FloatBind]
-&gt; CoreExpr
-&gt; [CoreBndr]
-&gt; CoreExpr
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="#local-6989586621682980304"><span class="hs-identifier hs-var hs-var">simple_rhs</span></a></span></span><span> </span><span id="local-6989586621682980323"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980323"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980324"><span class="annot"><span class="annottext">[FloatBind]
</span><a href="#local-6989586621682980324"><span class="hs-identifier hs-var">wfloats</span></a></span></span><span> </span><span id="local-6989586621682980325"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980325"><span class="hs-identifier hs-var">case_bndr_rhs</span></a></span></span><span> </span><span id="local-6989586621682980326"><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980326"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621682980327"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980327"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-3084"></span><span>      </span><span class="annot"><span class="annottext">Bool
-&gt; SimplM (SimplFloats, CoreExpr) -&gt; SimplM (SimplFloats, CoreExpr)
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreBndr] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980326"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SimplM (SimplFloats, CoreExpr) -&gt; SimplM (SimplFloats, CoreExpr))
-&gt; SimplM (SimplFloats, CoreExpr) -&gt; SimplM (SimplFloats, CoreExpr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-3085"></span><span>      </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980328"><span class="annot"><a href="#local-6989586621682980328"><span class="hs-identifier hs-var">floats1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980329"><span class="annot"><a href="#local-6989586621682980329"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; SimplEnv
-&gt; CoreBndr
-&gt; CoreExpr
-&gt; SimplM (SimplFloats, SimplEnv)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplAuxBind"><span class="hs-identifier hs-var">simplAuxBind</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rebuildCase&quot;</span></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980323"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980294"><span class="hs-identifier hs-var">case_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980325"><span class="hs-identifier hs-var">case_bndr_rhs</span></a></span><span>
</span><span id="line-3086"></span><span>             </span><span class="hs-comment">-- scrut is a constructor application,</span><span>
</span><span id="line-3087"></span><span>             </span><span class="hs-comment">-- hence satisfies let-can-float invariant</span><span>
</span><span id="line-3088"></span><span>         </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980330"><span class="annot"><a href="#local-6989586621682980330"><span class="hs-identifier hs-var">floats2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980331"><span class="annot"><a href="#local-6989586621682980331"><span class="hs-identifier hs-var">expr'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF"><span class="hs-identifier hs-type">simplExprF</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980329"><span class="hs-identifier hs-type">env'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980327"><span class="hs-identifier hs-type">rhs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980296"><span class="hs-identifier hs-type">cont</span></a></span><span>
</span><span id="line-3089"></span><span>         </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621682980324"><span class="hs-identifier hs-type">wfloats</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3090"></span><span>             </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(SimplFloats, CoreExpr) -&gt; SimplM (SimplFloats, CoreExpr)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682980328"><span class="hs-identifier hs-var">floats1</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats -&gt; SimplFloats -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#addFloats"><span class="hs-operator hs-var">`addFloats`</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682980330"><span class="hs-identifier hs-var">floats2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980331"><span class="hs-identifier hs-var">expr'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3091"></span><span>             </span><span class="annot"><span class="annottext">[FloatBind]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(SimplFloats, CoreExpr) -&gt; SimplM (SimplFloats, CoreExpr)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-3092"></span><span>               </span><span class="hs-comment">-- See Note [FloatBinds from constructor wrappers]</span><span>
</span><span id="line-3093"></span><span>                   </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980323"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-3094"></span><span>                     </span><span class="annot"><span class="annottext">[FloatBind] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Make.html#wrapFloats"><span class="hs-identifier hs-var">GHC.Core.Make.wrapFloats</span></a></span><span> </span><span class="annot"><span class="annottext">[FloatBind]
</span><a href="#local-6989586621682980324"><span class="hs-identifier hs-var">wfloats</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr) -&gt; CoreExpr -&gt; CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-3095"></span><span>                     </span><span class="annot"><span class="annottext">SimplFloats -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Env.html#wrapFloats"><span class="hs-identifier hs-var">wrapFloats</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682980328"><span class="hs-identifier hs-var">floats1</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats -&gt; SimplFloats -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#addFloats"><span class="hs-operator hs-var">`addFloats`</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682980330"><span class="hs-identifier hs-var">floats2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980331"><span class="hs-identifier hs-var">expr'</span></a></span><span> </span><span class="hs-special">)</span><span class="hs-special">}</span><span>
</span><span id="line-3096"></span><span>
</span><span id="line-3097"></span><span>    </span><span class="hs-comment">-- This scales case floats by the multiplicity of the continuation hole (see</span><span>
</span><span id="line-3098"></span><span>    </span><span class="hs-comment">-- Note [Scaling in case-of-case]).  Let floats are _not_ scaled, because</span><span>
</span><span id="line-3099"></span><span>    </span><span class="hs-comment">-- they are aliases anyway.</span><span>
</span><span id="line-3100"></span><span>    </span><span id="local-6989586621682980313"><span class="annot"><span class="annottext">scale_float :: FloatBind -&gt; FloatBind
</span><a href="#local-6989586621682980313"><span class="hs-identifier hs-var hs-var">scale_float</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Make.html#FloatCase"><span class="hs-identifier hs-type">GHC.Core.Make.FloatCase</span></a></span><span> </span><span id="local-6989586621682980334"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980334"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621682980335"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980335"><span class="hs-identifier hs-var">case_bndr</span></a></span></span><span> </span><span id="local-6989586621682980336"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682980336"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span id="local-6989586621682980337"><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980337"><span class="hs-identifier hs-var">vars</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-3101"></span><span>      </span><span class="hs-keyword">let</span><span>
</span><span id="line-3102"></span><span>        </span><span id="local-6989586621682980338"><span class="annot"><span class="annottext">scale_id :: CoreBndr -&gt; CoreBndr
</span><a href="#local-6989586621682980338"><span class="hs-identifier hs-var hs-var">scale_id</span></a></span></span><span> </span><span id="local-6989586621682980339"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980339"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Kind -&gt; CoreBndr -&gt; CoreBndr
</span><a href="GHC.Types.Id.html#scaleVarBy"><span class="hs-identifier hs-var">scaleVarBy</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980340"><span class="hs-identifier hs-var">holeScaling</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980339"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-3103"></span><span>      </span><span class="hs-keyword">in</span><span>
</span><span id="line-3104"></span><span>      </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreBndr -&gt; AltCon -&gt; [CoreBndr] -&gt; FloatBind
</span><a href="GHC.Core.Make.html#FloatCase"><span class="hs-identifier hs-var">GHC.Core.Make.FloatCase</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980334"><span class="hs-identifier hs-var">scrut</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; CoreBndr
</span><a href="#local-6989586621682980338"><span class="hs-identifier hs-var">scale_id</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980335"><span class="hs-identifier hs-var">case_bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682980336"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CoreBndr -&gt; CoreBndr) -&gt; [CoreBndr] -&gt; [CoreBndr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; CoreBndr
</span><a href="#local-6989586621682980338"><span class="hs-identifier hs-var">scale_id</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980337"><span class="hs-identifier hs-var">vars</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3105"></span><span>    </span><span class="annot"><a href="#local-6989586621682980313"><span class="hs-identifier hs-var">scale_float</span></a></span><span> </span><span id="local-6989586621682980341"><span class="annot"><span class="annottext">FloatBind
</span><a href="#local-6989586621682980341"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FloatBind
</span><a href="#local-6989586621682980341"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-3106"></span><span>
</span><span id="line-3107"></span><span>    </span><span id="local-6989586621682980340"><span class="annot"><span class="annottext">holeScaling :: Kind
</span><a href="#local-6989586621682980340"><span class="hs-identifier hs-var hs-var">holeScaling</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleScaling"><span class="hs-identifier hs-var">contHoleScaling</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980296"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="annot"><span class="annottext">Kind -&gt; Kind -&gt; Kind
</span><a href="GHC.Core.Multiplicity.html#mkMultMul"><span class="hs-operator hs-var">`mkMultMul`</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Kind
</span><a href="GHC.Types.Id.html#idMult"><span class="hs-identifier hs-var">idMult</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980294"><span class="hs-identifier hs-var">case_bndr</span></a></span><span>
</span><span id="line-3108"></span><span>     </span><span class="hs-comment">-- We are in the following situation</span><span>
</span><span id="line-3109"></span><span>     </span><span class="hs-comment">--   case[p] case[q] u of { D x -&gt; C v } of { C x -&gt; w }</span><span>
</span><span id="line-3110"></span><span>     </span><span class="hs-comment">-- And we are producing case[??] u of { D x -&gt; w[x\v]}</span><span>
</span><span id="line-3111"></span><span>     </span><span class="hs-comment">--</span><span>
</span><span id="line-3112"></span><span>     </span><span class="hs-comment">-- What should the multiplicity `??` be? In order to preserve the usage of</span><span>
</span><span id="line-3113"></span><span>     </span><span class="hs-comment">-- variables in `u`, it needs to be `pq`.</span><span>
</span><span id="line-3114"></span><span>     </span><span class="hs-comment">--</span><span>
</span><span id="line-3115"></span><span>     </span><span class="hs-comment">-- As an illustration, consider the following</span><span>
</span><span id="line-3116"></span><span>     </span><span class="hs-comment">--   case[Many] case[1] of { C x -&gt; C x } of { C x -&gt; (x, x) }</span><span>
</span><span id="line-3117"></span><span>     </span><span class="hs-comment">-- Where C :: A %1 -&gt; T is linear</span><span>
</span><span id="line-3118"></span><span>     </span><span class="hs-comment">-- If we were to produce a case[1], like the inner case, we would get</span><span>
</span><span id="line-3119"></span><span>     </span><span class="hs-comment">--   case[1] of { C x -&gt; (x, x) }</span><span>
</span><span id="line-3120"></span><span>     </span><span class="hs-comment">-- Which is ill-typed with respect to linearity. So it needs to be a</span><span>
</span><span id="line-3121"></span><span>     </span><span class="hs-comment">-- case[Many].</span><span>
</span><span id="line-3122"></span><span>
</span><span id="line-3123"></span><span class="hs-comment">--------------------------------------------------</span><span>
</span><span id="line-3124"></span><span class="hs-comment">--      2. Eliminate the case if scrutinee is evaluated</span><span>
</span><span id="line-3125"></span><span class="hs-comment">--------------------------------------------------</span><span>
</span><span id="line-3126"></span><span>
</span><span id="line-3127"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuildCase"><span class="hs-identifier hs-var">rebuildCase</span></a></span><span> </span><span id="local-6989586621682980344"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980344"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980345"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980345"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621682980346"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980346"><span class="hs-identifier hs-var">case_bndr</span></a></span></span><span> </span><span id="local-6989586621682980347"><span class="annot"><span class="annottext">alts :: [Alt CoreBndr]
</span><a href="#local-6989586621682980347"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682980348"><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980348"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span id="local-6989586621682980349"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980349"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">]</span><span> </span><span id="local-6989586621682980350"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980350"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-3128"></span><span>  </span><span class="hs-comment">-- See if we can get rid of the case altogether</span><span>
</span><span id="line-3129"></span><span>  </span><span class="hs-comment">-- See Note [Case elimination]</span><span>
</span><span id="line-3130"></span><span>  </span><span class="hs-comment">-- mkCase made sure that if all the alternatives are equal,</span><span>
</span><span id="line-3131"></span><span>  </span><span class="hs-comment">-- then there is now only one (DEFAULT) rhs</span><span>
</span><span id="line-3132"></span><span>
</span><span id="line-3133"></span><span>  </span><span class="hs-comment">-- 2a.  Dropping the case altogether, if</span><span>
</span><span id="line-3134"></span><span>  </span><span class="hs-comment">--      a) it binds nothing (so it's really just a 'seq')</span><span>
</span><span id="line-3135"></span><span>  </span><span class="hs-comment">--      b) evaluating the scrutinee has no side effects</span><span>
</span><span id="line-3136"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682980351"><span class="hs-identifier hs-var">is_plain_seq</span></a></span><span>
</span><span id="line-3137"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprOkToDiscard"><span class="hs-identifier hs-var">exprOkToDiscard</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980345"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-3138"></span><span>          </span><span class="hs-comment">-- The entire case is dead, so we can drop it</span><span>
</span><span id="line-3139"></span><span>          </span><span class="hs-comment">-- if the scrutinee converges without having imperative</span><span>
</span><span id="line-3140"></span><span>          </span><span class="hs-comment">-- side effects or raising a Haskell exception</span><span>
</span><span id="line-3141"></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980344"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980349"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980350"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-3142"></span><span>
</span><span id="line-3143"></span><span>  </span><span class="hs-comment">-- 2b.  Turn the case into a let, if</span><span>
</span><span id="line-3144"></span><span>  </span><span class="hs-comment">--      a) it binds only the case-binder</span><span>
</span><span id="line-3145"></span><span>  </span><span class="hs-comment">--      b) unlifted case: the scrutinee is ok-for-speculation</span><span>
</span><span id="line-3146"></span><span>  </span><span class="hs-comment">--           lifted case: the scrutinee is in HNF (or will later be demanded)</span><span>
</span><span id="line-3147"></span><span>  </span><span class="hs-comment">-- See Note [Case to let transformation]</span><span>
</span><span id="line-3148"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682980353"><span class="hs-identifier hs-var">all_dead_bndrs</span></a></span><span>
</span><span id="line-3149"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreBndr -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#doCaseToLet"><span class="hs-identifier hs-var">doCaseToLet</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980345"><span class="hs-identifier hs-var">scrut</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980346"><span class="hs-identifier hs-var">case_bndr</span></a></span><span>
</span><span id="line-3150"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Tick -&gt; SimplM ()
</span><a href="GHC.Core.Opt.Simplify.Monad.html#tick"><span class="hs-identifier hs-var">tick</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Tick
</span><a href="GHC.Core.Opt.Stats.html#CaseElim"><span class="hs-identifier hs-var">CaseElim</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980346"><span class="hs-identifier hs-var">case_bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3151"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980356"><span class="annot"><a href="#local-6989586621682980356"><span class="hs-identifier hs-var">floats1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980357"><span class="annot"><a href="#local-6989586621682980357"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; SimplEnv
-&gt; CoreBndr
-&gt; CoreExpr
-&gt; SimplM (SimplFloats, SimplEnv)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplAuxBind"><span class="hs-identifier hs-var">simplAuxBind</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rebuildCaseAlt1&quot;</span></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980344"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980346"><span class="hs-identifier hs-var">case_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980345"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-3152"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980358"><span class="annot"><a href="#local-6989586621682980358"><span class="hs-identifier hs-var">floats2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980359"><span class="annot"><a href="#local-6989586621682980359"><span class="hs-identifier hs-var">expr'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF"><span class="hs-identifier hs-type">simplExprF</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980357"><span class="hs-identifier hs-type">env'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980349"><span class="hs-identifier hs-type">rhs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980350"><span class="hs-identifier hs-type">cont</span></a></span><span>
</span><span id="line-3153"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682980356"><span class="hs-identifier hs-type">floats1</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#addFloats"><span class="hs-operator hs-type">`addFloats`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980358"><span class="hs-identifier hs-type">floats2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682980359"><span class="hs-identifier hs-type">expr'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3154"></span><span>
</span><span id="line-3155"></span><span>  </span><span class="hs-comment">-- 2c. Try the seq rules if</span><span>
</span><span id="line-3156"></span><span>  </span><span class="hs-comment">--     a) it binds only the case binder</span><span>
</span><span id="line-3157"></span><span>  </span><span class="hs-comment">--     b) a rule for seq applies</span><span>
</span><span id="line-3158"></span><span>  </span><span class="hs-comment">-- See Note [User-defined RULES for seq] in GHC.Types.Id.Make</span><span>
</span><span id="line-3159"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682980351"><span class="hs-identifier hs-var">is_plain_seq</span></a></span><span>
</span><span id="line-3160"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682980360"><span class="annot"><a href="#local-6989586621682980360"><span class="hs-identifier hs-var">mb_rule</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; CoreExpr
-&gt; CoreExpr
-&gt; SimplCont
-&gt; SimplM (Maybe (SimplEnv, CoreExpr, SimplCont))
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#trySeqRules"><span class="hs-identifier hs-var">trySeqRules</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980344"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980345"><span class="hs-identifier hs-var">scrut</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980349"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980350"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-3161"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621682980360"><span class="hs-identifier hs-type">mb_rule</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3162"></span><span>           </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980361"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980361"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980362"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980362"><span class="hs-identifier hs-var">rule_rhs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980363"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980363"><span class="hs-identifier hs-var">cont'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF"><span class="hs-identifier hs-var">simplExprF</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980361"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980362"><span class="hs-identifier hs-var">rule_rhs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980363"><span class="hs-identifier hs-var">cont'</span></a></span><span>
</span><span id="line-3163"></span><span>           </span><span class="annot"><span class="annottext">Maybe (SimplEnv, CoreExpr, SimplCont)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; CoreExpr
-&gt; CoreBndr
-&gt; [Alt CoreBndr]
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#reallyRebuildCase"><span class="hs-identifier hs-var">reallyRebuildCase</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980344"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980345"><span class="hs-identifier hs-var">scrut</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980346"><span class="hs-identifier hs-var">case_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt CoreBndr]
</span><a href="#local-6989586621682980347"><span class="hs-identifier hs-var">alts</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980350"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3164"></span><span>
</span><span id="line-3165"></span><span class="hs-comment">--------------------------------------------------</span><span>
</span><span id="line-3166"></span><span class="hs-comment">--      3. Primop-related case-rules</span><span>
</span><span id="line-3167"></span><span class="hs-comment">--------------------------------------------------</span><span>
</span><span id="line-3168"></span><span>
</span><span id="line-3169"></span><span>  </span><span class="hs-glyph">|</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980364"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980364"><span class="hs-identifier hs-var">scrut'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980365"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980365"><span class="hs-identifier hs-var">case_bndr'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980366"><span class="annot"><span class="annottext">[Alt CoreBndr]
</span><a href="#local-6989586621682980366"><span class="hs-identifier hs-var">alts'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreExpr
-&gt; CoreBndr
-&gt; [Alt CoreBndr]
-&gt; Maybe (CoreExpr, CoreBndr, [Alt CoreBndr])
</span><a href="GHC.Core.Opt.ConstantFold.html#caseRules2"><span class="hs-identifier hs-var">caseRules2</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980345"><span class="hs-identifier hs-var">scrut</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980346"><span class="hs-identifier hs-var">case_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt CoreBndr]
</span><a href="#local-6989586621682980347"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-3170"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; CoreExpr
-&gt; CoreBndr
-&gt; [Alt CoreBndr]
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#reallyRebuildCase"><span class="hs-identifier hs-var">reallyRebuildCase</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980344"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980364"><span class="hs-identifier hs-var">scrut'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980365"><span class="hs-identifier hs-var">case_bndr'</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt CoreBndr]
</span><a href="#local-6989586621682980366"><span class="hs-identifier hs-var">alts'</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980350"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-3171"></span><span>
</span><span id="line-3172"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3173"></span><span>    </span><span id="local-6989586621682980353"><span class="annot"><span class="annottext">all_dead_bndrs :: Bool
</span><a href="#local-6989586621682980353"><span class="hs-identifier hs-var hs-var">all_dead_bndrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreBndr -&gt; Bool) -&gt; [CoreBndr] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Id.html#isDeadBinder"><span class="hs-identifier hs-var">isDeadBinder</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980348"><span class="hs-identifier hs-var">bndrs</span></a></span><span>       </span><span class="hs-comment">-- bndrs are [InId]</span><span>
</span><span id="line-3174"></span><span>    </span><span id="local-6989586621682980351"><span class="annot"><span class="annottext">is_plain_seq :: Bool
</span><a href="#local-6989586621682980351"><span class="hs-identifier hs-var hs-var">is_plain_seq</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682980353"><span class="hs-identifier hs-var">all_dead_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Id.html#isDeadBinder"><span class="hs-identifier hs-var">isDeadBinder</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980346"><span class="hs-identifier hs-var">case_bndr</span></a></span><span> </span><span class="hs-comment">-- Evaluation *only* for effect</span><span>
</span><span id="line-3175"></span><span>
</span><span id="line-3176"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuildCase"><span class="hs-identifier hs-var">rebuildCase</span></a></span><span> </span><span id="local-6989586621682980368"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980368"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980369"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980369"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621682980370"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980370"><span class="hs-identifier hs-var">case_bndr</span></a></span></span><span> </span><span id="local-6989586621682980371"><span class="annot"><span class="annottext">[Alt CoreBndr]
</span><a href="#local-6989586621682980371"><span class="hs-identifier hs-var">alts</span></a></span></span><span> </span><span id="local-6989586621682980372"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980372"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-3177"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; CoreExpr
-&gt; CoreBndr
-&gt; [Alt CoreBndr]
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#reallyRebuildCase"><span class="hs-identifier hs-var">reallyRebuildCase</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980368"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980369"><span class="hs-identifier hs-var">scrut</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980370"><span class="hs-identifier hs-var">case_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt CoreBndr]
</span><a href="#local-6989586621682980371"><span class="hs-identifier hs-var">alts</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980372"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-3178"></span><span>
</span><span id="line-3179"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#doCaseToLet"><span class="hs-identifier hs-type">doCaseToLet</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>          </span><span class="hs-comment">-- Scrutinee</span><span>
</span><span id="line-3180"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span>             </span><span class="hs-comment">-- Case binder</span><span>
</span><span id="line-3181"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-3182"></span><span class="hs-comment">-- The situation is         case scrut of b { DEFAULT -&gt; body }</span><span>
</span><span id="line-3183"></span><span class="hs-comment">-- Can we transform thus?   let { b = scrut } in body</span><span>
</span><span id="line-3184"></span><span id="doCaseToLet"><span class="annot"><span class="annottext">doCaseToLet :: CoreExpr -&gt; CoreBndr -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#doCaseToLet"><span class="hs-identifier hs-var hs-var">doCaseToLet</span></a></span></span><span> </span><span id="local-6989586621682980373"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980373"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621682980374"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980374"><span class="hs-identifier hs-var">case_bndr</span></a></span></span><span>
</span><span id="line-3185"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyCoVar"><span class="hs-identifier hs-var">isTyCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980374"><span class="hs-identifier hs-var">case_bndr</span></a></span><span>    </span><span class="hs-comment">-- Respect GHC.Core</span><span>
</span><span id="line-3186"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
forall {b}. Expr b -&gt; Bool
</span><a href="GHC.Core.html#isTyCoArg"><span class="hs-identifier hs-var">isTyCoArg</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980373"><span class="hs-identifier hs-var">scrut</span></a></span><span>        </span><span class="hs-comment">-- Note [Core type and coercion invariant]</span><span>
</span><span id="line-3187"></span><span>
</span><span id="line-3188"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Kind -&gt; Bool
Kind -&gt; Bool
</span><a href="GHC.Core.Type.html#isUnliftedType"><span class="hs-identifier hs-var">isUnliftedType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; Kind
CoreExpr -&gt; Kind
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980373"><span class="hs-identifier hs-var">scrut</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3189"></span><span>    </span><span class="hs-comment">-- We can call isUnliftedType here: scrutinees always have a fixed RuntimeRep (see FRRCase).</span><span>
</span><span id="line-3190"></span><span>    </span><span class="hs-comment">-- Note however that we must check 'scrut' (which is an 'OutExpr') and not 'case_bndr'</span><span>
</span><span id="line-3191"></span><span>    </span><span class="hs-comment">-- (which is an 'InId'): see Note [Dark corner with representation polymorphism].</span><span>
</span><span id="line-3192"></span><span>    </span><span class="hs-comment">-- Using `exprType` is typically cheap because `scrut` is typically a variable.</span><span>
</span><span id="line-3193"></span><span>    </span><span class="hs-comment">-- We could instead use mightBeUnliftedType (idType case_bndr), but that hurts</span><span>
</span><span id="line-3194"></span><span>    </span><span class="hs-comment">-- the brain more.  Consider that if this test ever turns out to be a perf</span><span>
</span><span id="line-3195"></span><span>    </span><span class="hs-comment">-- problem (which seems unlikely).</span><span>
</span><span id="line-3196"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprOkForSpeculation"><span class="hs-identifier hs-var">exprOkForSpeculation</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980373"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-3197"></span><span>
</span><span id="line-3198"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>  </span><span class="hs-comment">-- Scrut has a lifted type</span><span>
</span><span id="line-3199"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsHNF"><span class="hs-identifier hs-var">exprIsHNF</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980373"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-3200"></span><span>       </span><span class="hs-comment">--    || isStrUsedDmd (idDemandInfo case_bndr)</span><span>
</span><span id="line-3201"></span><span>       </span><span class="hs-comment">-- We no longer look at the demand on the case binder</span><span>
</span><span id="line-3202"></span><span>       </span><span class="hs-comment">-- See Note [Case-to-let for strictly-used binders]</span><span>
</span><span id="line-3203"></span><span>
</span><span id="line-3204"></span><span class="hs-comment">--------------------------------------------------</span><span>
</span><span id="line-3205"></span><span class="hs-comment">--      3. Catch-all case</span><span>
</span><span id="line-3206"></span><span class="hs-comment">--------------------------------------------------</span><span>
</span><span id="line-3207"></span><span>
</span><span id="line-3208"></span><span id="reallyRebuildCase"><span class="annot"><span class="annottext">reallyRebuildCase :: SimplEnv
-&gt; CoreExpr
-&gt; CoreBndr
-&gt; [Alt CoreBndr]
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#reallyRebuildCase"><span class="hs-identifier hs-var hs-var">reallyRebuildCase</span></a></span></span><span> </span><span id="local-6989586621682980379"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980379"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980380"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980380"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621682980381"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980381"><span class="hs-identifier hs-var">case_bndr</span></a></span></span><span> </span><span id="local-6989586621682980382"><span class="annot"><span class="annottext">[Alt CoreBndr]
</span><a href="#local-6989586621682980382"><span class="hs-identifier hs-var">alts</span></a></span></span><span> </span><span id="local-6989586621682980383"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980383"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-3209"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Env.html#seCaseCase"><span class="hs-identifier hs-var">seCaseCase</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980379"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- Only when case-of-case is on.</span><span>
</span><span id="line-3210"></span><span>                            </span><span class="hs-comment">-- See GHC.Driver.Config.Core.Opt.Simplify</span><span>
</span><span id="line-3211"></span><span>                            </span><span class="hs-comment">--    Note [Case-of-case and full laziness]</span><span>
</span><span id="line-3212"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682980384"><span class="annot"><a href="#local-6989586621682980384"><span class="hs-identifier hs-var">case_expr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; CoreExpr
-&gt; CoreBndr
-&gt; [Alt CoreBndr]
-&gt; SimplCont
-&gt; SimplM CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplAlts"><span class="hs-identifier hs-var">simplAlts</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980379"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980380"><span class="hs-identifier hs-var">scrut</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980381"><span class="hs-identifier hs-var">case_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt CoreBndr]
</span><a href="#local-6989586621682980382"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-3213"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Kind -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#mkBoringStop"><span class="hs-identifier hs-var">mkBoringStop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplCont -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleType"><span class="hs-identifier hs-var">contHoleType</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980383"><span class="hs-identifier hs-var">cont</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3214"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuild"><span class="hs-identifier hs-type">rebuild</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980379"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980384"><span class="hs-identifier hs-type">case_expr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980383"><span class="hs-identifier hs-type">cont</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3215"></span><span>
</span><span id="line-3216"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3217"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980386"><span class="annot"><a href="#local-6989586621682980386"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980387"><span class="annot"><a href="#local-6989586621682980387"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980388"><span class="annot"><a href="#local-6989586621682980388"><span class="hs-identifier hs-var">cont'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; [Alt CoreBndr]
-&gt; SimplCont
-&gt; SimplM (SimplFloats, SimplEnv, SimplCont)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#mkDupableCaseCont"><span class="hs-identifier hs-var">mkDupableCaseCont</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980379"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt CoreBndr]
</span><a href="#local-6989586621682980382"><span class="hs-identifier hs-var">alts</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980383"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-3218"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682980390"><span class="annot"><a href="#local-6989586621682980390"><span class="hs-identifier hs-var">case_expr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplAlts"><span class="hs-identifier hs-type">simplAlts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980387"><span class="hs-identifier hs-type">env'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980380"><span class="hs-identifier hs-type">scrut</span></a></span><span>
</span><span id="line-3219"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Id.html#scaleIdBy"><span class="hs-identifier hs-type">scaleIdBy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980392"><span class="hs-identifier hs-type">holeScaling</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980381"><span class="hs-identifier hs-type">case_bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3220"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Utils.html#scaleAltsBy"><span class="hs-identifier hs-type">scaleAltsBy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980392"><span class="hs-identifier hs-type">holeScaling</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980382"><span class="hs-identifier hs-type">alts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3221"></span><span>                                </span><span class="annot"><a href="#local-6989586621682980388"><span class="hs-identifier hs-type">cont'</span></a></span><span>
</span><span id="line-3222"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682980386"><span class="hs-identifier hs-type">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682980390"><span class="hs-identifier hs-type">case_expr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3223"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3224"></span><span>    </span><span id="local-6989586621682980392"><span class="annot"><span class="annottext">holeScaling :: Kind
</span><a href="#local-6989586621682980392"><span class="hs-identifier hs-var hs-var">holeScaling</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleScaling"><span class="hs-identifier hs-var">contHoleScaling</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980383"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-3225"></span><span>    </span><span class="hs-comment">-- Note [Scaling in case-of-case]</span><span>
</span><span id="line-3226"></span><span>
</span><span id="line-3227"></span><span class="hs-comment">{-
simplCaseBinder checks whether the scrutinee is a variable, v.  If so,
try to eliminate uses of v in the RHSs in favour of case_bndr; that
way, there's a chance that v will now only be used once, and hence
inlined.

Historical note: we use to do the &quot;case binder swap&quot; in the Simplifier
so there were additional complications if the scrutinee was a variable.
Now the binder-swap stuff is done in the occurrence analyser; see
&quot;GHC.Core.Opt.OccurAnal&quot; Note [Binder swap].

Note [knownCon occ info]
~~~~~~~~~~~~~~~~~~~~~~~~
If the case binder is not dead, then neither are the pattern bound
variables:
        case &lt;any&gt; of x { (a,b) -&gt;
        case x of { (p,q) -&gt; p } }
Here (a,b) both look dead, but come alive after the inner case is eliminated.
The point is that we bring into the envt a binding
        let x = (a,b)
after the outer case, and that makes (a,b) alive.  At least we do unless
the case binder is guaranteed dead.

Note [DataAlt occ info]
~~~~~~~~~~~~~~~~~~~~~~~
Our general goal is to preserve dead-ness occ-info on the field binders of a
case alternative. Why? It's generally a good idea, but one specific reason is to
support (SEQ4) of Note [seq# magic].

But we have to be careful: even if the field binder is not mentioned in the case
alternative and thus annotated IAmDead by OccurAnal, it might &quot;come back to
life&quot; in one of two ways:

 1. If the case binder is alive, its unfolding might bring back the field
    binder, as in Note [knownCon occ info]:
      case blah of y { I# _ -&gt; $wf (case y of I# v -&gt; v) }
      ==&gt;
      case blah of y { I# v -&gt; $wf v }
 2. Even if the case binder appears to be dead, there is the scenario in
    Note [Add unfolding for scrutinee], in which the fields come back to live
    through the unfolding of variable scrutinee, as follows:
      join j = case x of Just v -&gt; blah v; Nothing -&gt; ... in
      case x of Just _ -&gt; jump j; Nothing -&gt; ...
      ==&gt; { inline j, unfold x to Just v, simplify }
      join j = case x of Just v -&gt; blah v; Nothing -&gt; ... in
      case x of Just v -&gt; blah v; Nothing -&gt; ...

Thus, when we are simply reconstructing a case (the common case), and the
case binder is not dead, or the scrutinee is a variable, we zap the
occurrence info on DataAlt field binders. See `adjustFieldOccInfo`.

Note [Improving seq]
~~~~~~~~~~~~~~~~~~~~
Consider
        type family F :: * -&gt; *
        type instance F Int = Int

We'd like to transform
        case e of (x :: F Int) { DEFAULT -&gt; rhs }
===&gt;
        case e `cast` co of (x'::Int)
           I# x# -&gt; let x = x' `cast` sym co
                    in rhs

so that 'rhs' can take advantage of the form of x'.  Notice that Note
[Case of cast] (in OccurAnal) may then apply to the result.

We'd also like to eliminate empty types (#13468). So if

    data Void
    type instance F Bool = Void

then we'd like to transform
        case (x :: F Bool) of { _ -&gt; error &quot;urk&quot; }
===&gt;
        case (x |&gt; co) of (x' :: Void) of {}

Nota Bene: we used to have a built-in rule for 'seq' that dropped
casts, so that
    case (x |&gt; co) of { _ -&gt; blah }
dropped the cast; in order to improve the chances of trySeqRules
firing.  But that works in the /opposite/ direction to Note [Improving
seq] so there's a danger of flip/flopping.  Better to make trySeqRules
insensitive to the cast, which is now is.

The need for [Improving seq] showed up in Roman's experiments.  Example:
  foo :: F Int -&gt; Int -&gt; Int
  foo t n = t `seq` bar n
     where
       bar 0 = 0
       bar n = bar (n - case t of TI i -&gt; i)
Here we'd like to avoid repeated evaluating t inside the loop, by
taking advantage of the `seq`.

At one point I did transformation in LiberateCase, but it's more
robust here.  (Otherwise, there's a danger that we'll simply drop the
'seq' altogether, before LiberateCase gets to see it.)

Note [Scaling in case-of-case]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

When two cases commute, if done naively, the multiplicities will be wrong:

  case (case u of w[1] { (x[1], y[1]) } -&gt; f x y) of w'[Many]
  { (z[Many], t[Many]) -&gt; z
  }

The multiplicities here, are correct, but if I perform a case of case:

  case u of w[1]
  { (x[1], y[1]) -&gt; case f x y of w'[Many] of { (z[Many], t[Many]) -&gt; z }
  }

This is wrong! Using `f x y` inside a `case &#8230; of w'[Many]` means that `x` and
`y` must have multiplicities `Many` not `1`! The correct solution is to make
all the `1`-s be `Many`-s instead:

  case u of w[Many]
  { (x[Many], y[Many]) -&gt; case f x y of w'[Many] of { (z[Many], t[Many]) -&gt; z }
  }

In general, when commuting two cases, the rule has to be:

  case (case &#8230; of x[p] {&#8230;}) of y[q] { &#8230; }
  ===&gt; case &#8230; of x[p*q] { &#8230; case &#8230; of y[q] { &#8230; } }

This is materialised, in the simplifier, by the fact that every time we simplify
case alternatives with a continuation (the surrounded case (or more!)), we must
scale the entire case we are simplifying, by a scaling factor which can be
computed in the continuation (with function `contHoleScaling`).
-}</span><span>
</span><span id="line-3358"></span><span>
</span><span id="line-3359"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplAlts"><span class="hs-identifier hs-type">simplAlts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span>
</span><span id="line-3360"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>         </span><span class="hs-comment">-- Scrutinee</span><span>
</span><span id="line-3361"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span>            </span><span class="hs-comment">-- Case binder</span><span>
</span><span id="line-3362"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#InAlt"><span class="hs-identifier hs-type">InAlt</span></a></span><span class="hs-special">]</span><span>         </span><span class="hs-comment">-- Non-empty</span><span>
</span><span id="line-3363"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-3364"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>  </span><span class="hs-comment">-- Returns the complete simplified case expression</span><span>
</span><span id="line-3365"></span><span>
</span><span id="line-3366"></span><span id="simplAlts"><span class="annot"><span class="annottext">simplAlts :: SimplEnv
-&gt; CoreExpr
-&gt; CoreBndr
-&gt; [Alt CoreBndr]
-&gt; SimplCont
-&gt; SimplM CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplAlts"><span class="hs-identifier hs-var hs-var">simplAlts</span></a></span></span><span> </span><span id="local-6989586621682980394"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980394"><span class="hs-identifier hs-var">env0</span></a></span></span><span> </span><span id="local-6989586621682980395"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980395"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621682980396"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980396"><span class="hs-identifier hs-var">case_bndr</span></a></span></span><span> </span><span id="local-6989586621682980397"><span class="annot"><span class="annottext">[Alt CoreBndr]
</span><a href="#local-6989586621682980397"><span class="hs-identifier hs-var">alts</span></a></span></span><span> </span><span id="local-6989586621682980398"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980398"><span class="hs-identifier hs-var">cont'</span></a></span></span><span>
</span><span id="line-3367"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; SimplM ()
</span><a href="GHC.Core.Opt.Simplify.Monad.html#traceSmpl"><span class="hs-identifier hs-var">traceSmpl</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;simplAlts&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980396"><span class="hs-identifier hs-var">case_bndr</span></a></span><span>
</span><span id="line-3368"></span><span>                                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;cont':&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980398"><span class="hs-identifier hs-var">cont'</span></a></span><span>
</span><span id="line-3369"></span><span>                                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;in_scope&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv -&gt; InScopeSet
</span><a href="GHC.Core.Opt.Simplify.Env.html#seInScope"><span class="hs-identifier hs-var">seInScope</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980394"><span class="hs-identifier hs-var">env0</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-3370"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980399"><span class="annot"><a href="#local-6989586621682980399"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980400"><span class="annot"><a href="#local-6989586621682980400"><span class="hs-identifier hs-var">case_bndr1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; SimplM (SimplEnv, CoreBndr)
</span><a href="GHC.Core.Opt.Simplify.Env.html#simplBinder"><span class="hs-identifier hs-var">simplBinder</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980394"><span class="hs-identifier hs-var">env0</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980396"><span class="hs-identifier hs-var">case_bndr</span></a></span><span>
</span><span id="line-3371"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682980401"><span class="annot"><a href="#local-6989586621682980401"><span class="hs-identifier hs-var hs-var">case_bndr2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980400"><span class="hs-identifier hs-var">case_bndr1</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Unfolding -&gt; CoreBndr
</span><a href="GHC.Types.Id.html#setIdUnfolding"><span class="hs-operator hs-var">`setIdUnfolding`</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="GHC.Core.html#evaldUnfolding"><span class="hs-identifier hs-var">evaldUnfolding</span></a></span><span>
</span><span id="line-3372"></span><span>              </span><span id="local-6989586621682980403"><span class="annot"><a href="#local-6989586621682980403"><span class="hs-identifier hs-var hs-var">env2</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#modifyInScope"><span class="hs-identifier hs-var">modifyInScope</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980399"><span class="hs-identifier hs-var">env1</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980401"><span class="hs-identifier hs-var">case_bndr2</span></a></span><span>
</span><span id="line-3373"></span><span>              </span><span class="hs-comment">-- See Note [Case binder evaluated-ness]</span><span>
</span><span id="line-3374"></span><span>              </span><span id="local-6989586621682980405"><span class="annot"><a href="#local-6989586621682980405"><span class="hs-identifier hs-var hs-var">fam_envs</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; (FamInstEnv, FamInstEnv)
</span><a href="GHC.Core.Opt.Simplify.Env.html#seFamEnvs"><span class="hs-identifier hs-var">seFamEnvs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980394"><span class="hs-identifier hs-var">env0</span></a></span><span>
</span><span id="line-3375"></span><span>
</span><span id="line-3376"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980407"><span class="annot"><a href="#local-6989586621682980407"><span class="hs-identifier hs-var">alt_env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980408"><span class="annot"><a href="#local-6989586621682980408"><span class="hs-identifier hs-var">scrut'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980409"><span class="annot"><a href="#local-6989586621682980409"><span class="hs-identifier hs-var">case_bndr'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#improveSeq"><span class="hs-identifier hs-type">improveSeq</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980405"><span class="hs-identifier hs-type">fam_envs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980403"><span class="hs-identifier hs-type">env2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980395"><span class="hs-identifier hs-type">scrut</span></a></span><span>
</span><span id="line-3377"></span><span>                                                       </span><span class="annot"><a href="#local-6989586621682980396"><span class="hs-identifier hs-type">case_bndr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980401"><span class="hs-identifier hs-type">case_bndr2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980397"><span class="hs-identifier hs-type">alts</span></a></span><span>
</span><span id="line-3378"></span><span>
</span><span id="line-3379"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980411"><span class="annot"><a href="#local-6989586621682980411"><span class="hs-identifier hs-var">imposs_deflt_cons</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980412"><span class="annot"><a href="#local-6989586621682980412"><span class="hs-identifier hs-var">in_alts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#prepareAlts"><span class="hs-identifier hs-type">prepareAlts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980408"><span class="hs-identifier hs-type">scrut'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980396"><span class="hs-identifier hs-type">case_bndr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980397"><span class="hs-identifier hs-type">alts</span></a></span><span>
</span><span id="line-3380"></span><span>          </span><span class="hs-comment">-- NB: it's possible that the returned in_alts is empty: this is handled</span><span>
</span><span id="line-3381"></span><span>          </span><span class="hs-comment">--     by the caller (rebuildCase) in the missingAlt function</span><span>
</span><span id="line-3382"></span><span>          </span><span class="hs-comment">-- NB: pass case_bndr::InId, not case_bndr' :: OutId, to prepareAlts</span><span>
</span><span id="line-3383"></span><span>          </span><span class="hs-comment">--     See Note [Shadowing in prepareAlts] in GHC.Core.Opt.Simplify.Utils</span><span>
</span><span id="line-3384"></span><span>
</span><span id="line-3385"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682980414"><span class="annot"><a href="#local-6989586621682980414"><span class="hs-identifier hs-var">alts'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">forM</span></span><span> </span><span class="annot"><a href="#local-6989586621682980412"><span class="hs-identifier hs-type">in_alts</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-3386"></span><span>            </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplAlt"><span class="hs-identifier hs-type">simplAlt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980407"><span class="hs-identifier hs-type">alt_env'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="#local-6989586621682980408"><span class="hs-identifier hs-type">scrut'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682980411"><span class="hs-identifier hs-type">imposs_deflt_cons</span></a></span><span>
</span><span id="line-3387"></span><span>                     </span><span class="annot"><a href="#local-6989586621682980409"><span class="hs-identifier hs-type">case_bndr'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#scrutOkForBinderSwap"><span class="hs-identifier hs-type">scrutOkForBinderSwap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980395"><span class="hs-identifier hs-type">scrut</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682980398"><span class="hs-identifier hs-type">cont'</span></a></span><span>
</span><span id="line-3388"></span><span>
</span><span id="line-3389"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682980417"><span class="annot"><a href="#local-6989586621682980417"><span class="hs-identifier hs-var hs-var">alts_ty'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980398"><span class="hs-identifier hs-var">cont'</span></a></span><span>
</span><span id="line-3390"></span><span>        </span><span class="hs-comment">-- See Note [Avoiding space leaks in OutType]</span><span>
</span><span id="line-3391"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Core.Type.html#seqType"><span class="hs-identifier hs-type">seqType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980417"><span class="hs-identifier hs-type">alts_ty'</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">`seq`</span></span><span>
</span><span id="line-3392"></span><span>          </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#mkCase"><span class="hs-identifier hs-type">mkCase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#seMode"><span class="hs-identifier hs-var">seMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980394"><span class="hs-identifier hs-type">env0</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682980408"><span class="hs-identifier hs-type">scrut'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980409"><span class="hs-identifier hs-type">case_bndr'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980417"><span class="hs-identifier hs-type">alts_ty'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980414"><span class="hs-identifier hs-type">alts'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3393"></span><span>
</span><span id="line-3394"></span><span>
</span><span id="line-3395"></span><span class="hs-comment">------------------------------------</span><span>
</span><span id="line-3396"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#improveSeq"><span class="hs-identifier hs-type">improveSeq</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span>
</span><span id="line-3397"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#InAlt"><span class="hs-identifier hs-type">InAlt</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-3398"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3399"></span><span class="hs-comment">-- Note [Improving seq]</span><span>
</span><span id="line-3400"></span><span id="improveSeq"><span class="annot"><span class="annottext">improveSeq :: (FamInstEnv, FamInstEnv)
-&gt; SimplEnv
-&gt; CoreExpr
-&gt; CoreBndr
-&gt; CoreBndr
-&gt; [Alt CoreBndr]
-&gt; SimplM (SimplEnv, CoreExpr, CoreBndr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#improveSeq"><span class="hs-identifier hs-var hs-var">improveSeq</span></a></span></span><span> </span><span id="local-6989586621682980419"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621682980419"><span class="hs-identifier hs-var">fam_envs</span></a></span></span><span> </span><span id="local-6989586621682980420"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980420"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980421"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980421"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621682980422"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980422"><span class="hs-identifier hs-var">case_bndr</span></a></span></span><span> </span><span id="local-6989586621682980423"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980423"><span class="hs-identifier hs-var">case_bndr1</span></a></span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="GHC.Core.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span class="hs-special">]</span><span>
</span><span id="line-3401"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span> </span><span id="local-6989586621682980425"><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682980425"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span id="local-6989586621682980426"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980426"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv) -&gt; Kind -&gt; Maybe Reduction
</span><a href="GHC.Core.FamInstEnv.html#topNormaliseType_maybe"><span class="hs-identifier hs-var">topNormaliseType_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621682980419"><span class="hs-identifier hs-var">fam_envs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Kind
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980423"><span class="hs-identifier hs-var">case_bndr1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3402"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682980427"><span class="annot"><a href="#local-6989586621682980427"><span class="hs-identifier hs-var">case_bndr2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FastString -&gt; Kind -&gt; Kind -&gt; SimplM CoreBndr
</span><a href="GHC.Core.Opt.Simplify.Monad.html#newId"><span class="hs-identifier hs-var">newId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; FastString
</span><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;nt&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="GHC.Core.Type.html#ManyTy"><span class="hs-identifier hs-var">ManyTy</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980426"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-3403"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682980428"><span class="annot"><a href="#local-6989586621682980428"><span class="hs-identifier hs-var hs-var">rhs</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; JoinPointHood -&gt; SimplSR
</span><a href="GHC.Core.Opt.Simplify.Env.html#DoneEx"><span class="hs-identifier hs-var">DoneEx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; CoreExpr
forall b. CoreBndr -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980427"><span class="hs-identifier hs-var">case_bndr2</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoercionR -&gt; CoreExpr
forall b. Expr b -&gt; CoercionR -&gt; Expr b
</span><a href="GHC.Core.html#Cast"><span class="hs-operator hs-var">`Cast`</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionR -&gt; CoercionR
</span><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682980425"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">JoinPointHood
</span><a href="GHC.Utils.Outputable.html#NotJoinPoint"><span class="hs-identifier hs-var">NotJoinPoint</span></a></span><span>
</span><span id="line-3404"></span><span>              </span><span id="local-6989586621682980429"><span class="annot"><a href="#local-6989586621682980429"><span class="hs-identifier hs-var hs-var">env2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; SimplSR -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#extendIdSubst"><span class="hs-identifier hs-var">extendIdSubst</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980420"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980422"><span class="hs-identifier hs-var">case_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">SimplSR
</span><a href="#local-6989586621682980428"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-3405"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682980429"><span class="hs-identifier hs-type">env2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682980421"><span class="hs-identifier hs-type">scrut</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-operator hs-type">`Cast`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980425"><span class="hs-identifier hs-type">co</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682980427"><span class="hs-identifier hs-type">case_bndr2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3406"></span><span>
</span><span id="line-3407"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#improveSeq"><span class="hs-identifier hs-var">improveSeq</span></a></span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682980430"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980430"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980431"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980431"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682980432"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980432"><span class="hs-identifier hs-var">case_bndr1</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Alt CoreBndr]
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-3408"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SimplEnv, CoreExpr, CoreBndr)
-&gt; SimplM (SimplEnv, CoreExpr, CoreBndr)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980430"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980431"><span class="hs-identifier hs-var">scrut</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980432"><span class="hs-identifier hs-var">case_bndr1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3409"></span><span>
</span><span id="line-3410"></span><span>
</span><span id="line-3411"></span><span class="hs-comment">------------------------------------</span><span>
</span><span id="line-3412"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplAlt"><span class="hs-identifier hs-type">simplAlt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span>
</span><span id="line-3413"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>       </span><span class="hs-comment">-- The scrutinee</span><span>
</span><span id="line-3414"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a></span><span class="hs-special">]</span><span>            </span><span class="hs-comment">-- These constructors can't be present when</span><span>
</span><span id="line-3415"></span><span>                                </span><span class="hs-comment">-- matching the DEFAULT alternative</span><span>
</span><span id="line-3416"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span>               </span><span class="hs-comment">-- The case binder `bndr`</span><span>
</span><span id="line-3417"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#BinderSwapDecision"><span class="hs-identifier hs-type">BinderSwapDecision</span></a></span><span>  </span><span class="hs-comment">-- DoBinderSwap v co &lt;==&gt; scrut = Just (v |&gt; co),</span><span>
</span><span id="line-3418"></span><span>                                </span><span class="hs-comment">--           add unfolding `v :-&gt; bndr |&gt; sym co`</span><span>
</span><span id="line-3419"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-3420"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InAlt"><span class="hs-identifier hs-type">InAlt</span></a></span><span>
</span><span id="line-3421"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#OutAlt"><span class="hs-identifier hs-type">OutAlt</span></a></span><span>
</span><span id="line-3422"></span><span>
</span><span id="line-3423"></span><span id="simplAlt"><span class="annot"><span class="annottext">simplAlt :: SimplEnv
-&gt; Maybe CoreExpr
-&gt; [AltCon]
-&gt; CoreBndr
-&gt; BinderSwapDecision
-&gt; SimplCont
-&gt; Alt CoreBndr
-&gt; SimplM (Alt CoreBndr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplAlt"><span class="hs-identifier hs-var hs-var">simplAlt</span></a></span></span><span> </span><span id="local-6989586621682980434"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980434"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980435"><span class="annot"><span class="annottext">Maybe CoreExpr
</span><a href="#local-6989586621682980435"><span class="hs-identifier hs-var">_scrut'</span></a></span></span><span> </span><span id="local-6989586621682980436"><span class="annot"><span class="annottext">[AltCon]
</span><a href="#local-6989586621682980436"><span class="hs-identifier hs-var">imposs_deflt_cons</span></a></span></span><span> </span><span id="local-6989586621682980437"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980437"><span class="hs-identifier hs-var">case_bndr'</span></a></span></span><span> </span><span id="local-6989586621682980438"><span class="annot"><span class="annottext">BinderSwapDecision
</span><a href="#local-6989586621682980438"><span class="hs-identifier hs-var">bndr_swap'</span></a></span></span><span> </span><span id="local-6989586621682980439"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980439"><span class="hs-identifier hs-var">cont'</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="GHC.Core.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a></span><span> </span><span id="local-6989586621682980440"><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980440"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span id="local-6989586621682980441"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980441"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-3424"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SimplM (Alt CoreBndr) -&gt; SimplM (Alt CoreBndr)
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreBndr] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980440"><span class="hs-identifier hs-var">bndrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SimplM (Alt CoreBndr) -&gt; SimplM (Alt CoreBndr))
-&gt; SimplM (Alt CoreBndr) -&gt; SimplM (Alt CoreBndr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-3425"></span><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682980442"><span class="annot"><span class="annottext">env' :: SimplEnv
</span><a href="#local-6989586621682980442"><span class="hs-identifier hs-var hs-var hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; BinderSwapDecision -&gt; [AltCon] -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#addDefaultUnfoldings"><span class="hs-identifier hs-var">addDefaultUnfoldings</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980434"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980437"><span class="hs-identifier hs-var">case_bndr'</span></a></span><span> </span><span class="annot"><span class="annottext">BinderSwapDecision
</span><a href="#local-6989586621682980438"><span class="hs-identifier hs-var">bndr_swap'</span></a></span><span> </span><span class="annot"><span class="annottext">[AltCon]
</span><a href="#local-6989586621682980436"><span class="hs-identifier hs-var">imposs_deflt_cons</span></a></span><span>
</span><span id="line-3426"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682980444"><span class="annot"><a href="#local-6989586621682980444"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprC"><span class="hs-identifier hs-var">simplExprC</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980442"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980441"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980439"><span class="hs-identifier hs-var">cont'</span></a></span><span>
</span><span id="line-3427"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#DEFAULT"><span class="hs-identifier hs-type">DEFAULT</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><a href="#local-6989586621682980444"><span class="hs-identifier hs-type">rhs'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3428"></span><span>
</span><span id="line-3429"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplAlt"><span class="hs-identifier hs-var">simplAlt</span></a></span><span> </span><span id="local-6989586621682980445"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980445"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980446"><span class="annot"><span class="annottext">Maybe CoreExpr
</span><a href="#local-6989586621682980446"><span class="hs-identifier hs-var">_scrut'</span></a></span></span><span> </span><span class="annot"><span class="annottext">[AltCon]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682980447"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980447"><span class="hs-identifier hs-var">case_bndr'</span></a></span></span><span> </span><span id="local-6989586621682980448"><span class="annot"><span class="annottext">BinderSwapDecision
</span><a href="#local-6989586621682980448"><span class="hs-identifier hs-var">bndr_swap'</span></a></span></span><span> </span><span id="local-6989586621682980449"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980449"><span class="hs-identifier hs-var">cont'</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#LitAlt"><span class="hs-identifier hs-type">LitAlt</span></a></span><span> </span><span id="local-6989586621682980450"><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621682980450"><span class="hs-identifier hs-var">lit</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682980451"><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980451"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span id="local-6989586621682980452"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980452"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-3430"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SimplM (Alt CoreBndr) -&gt; SimplM (Alt CoreBndr)
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreBndr] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980451"><span class="hs-identifier hs-var">bndrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SimplM (Alt CoreBndr) -&gt; SimplM (Alt CoreBndr))
-&gt; SimplM (Alt CoreBndr) -&gt; SimplM (Alt CoreBndr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-3431"></span><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682980453"><span class="annot"><span class="annottext">env' :: SimplEnv
</span><a href="#local-6989586621682980453"><span class="hs-identifier hs-var hs-var hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; BinderSwapDecision -&gt; CoreExpr -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#addAltUnfoldings"><span class="hs-identifier hs-var">addAltUnfoldings</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980445"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980447"><span class="hs-identifier hs-var">case_bndr'</span></a></span><span> </span><span class="annot"><span class="annottext">BinderSwapDecision
</span><a href="#local-6989586621682980448"><span class="hs-identifier hs-var">bndr_swap'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Literal -&gt; CoreExpr
forall b. Literal -&gt; Expr b
</span><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-var">Lit</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621682980450"><span class="hs-identifier hs-var">lit</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3432"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682980455"><span class="annot"><a href="#local-6989586621682980455"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprC"><span class="hs-identifier hs-var">simplExprC</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980453"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980452"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980449"><span class="hs-identifier hs-var">cont'</span></a></span><span>
</span><span id="line-3433"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#LitAlt"><span class="hs-identifier hs-type">LitAlt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980450"><span class="hs-identifier hs-type">lit</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><a href="#local-6989586621682980455"><span class="hs-identifier hs-type">rhs'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3434"></span><span>
</span><span id="line-3435"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplAlt"><span class="hs-identifier hs-var">simplAlt</span></a></span><span> </span><span id="local-6989586621682980456"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980456"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980457"><span class="annot"><span class="annottext">Maybe CoreExpr
</span><a href="#local-6989586621682980457"><span class="hs-identifier hs-var">scrut'</span></a></span></span><span> </span><span class="annot"><span class="annottext">[AltCon]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682980458"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980458"><span class="hs-identifier hs-var">case_bndr'</span></a></span></span><span> </span><span id="local-6989586621682980459"><span class="annot"><span class="annottext">BinderSwapDecision
</span><a href="#local-6989586621682980459"><span class="hs-identifier hs-var">bndr_swap'</span></a></span></span><span> </span><span id="local-6989586621682980460"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980460"><span class="hs-identifier hs-var">cont'</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#DataAlt"><span class="hs-identifier hs-type">DataAlt</span></a></span><span> </span><span id="local-6989586621682980461"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682980461"><span class="hs-identifier hs-var">con</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682980462"><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980462"><span class="hs-identifier hs-var">vs</span></a></span></span><span> </span><span id="local-6989586621682980463"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980463"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-3436"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- See Note [Adding evaluatedness info to pattern-bound variables]</span><span>
</span><span id="line-3437"></span><span>          </span><span class="hs-comment">-- and Note [DataAlt occ info]</span><span>
</span><span id="line-3438"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682980464"><span class="annot"><span class="annottext">vs_with_info :: [CoreBndr]
</span><a href="#local-6989586621682980464"><span class="hs-identifier hs-var hs-var hs-var">vs_with_info</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe CoreExpr
-&gt; CoreBndr
-&gt; BinderSwapDecision
-&gt; DataCon
-&gt; [CoreBndr]
-&gt; [CoreBndr]
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#adjustFieldsIdInfo"><span class="hs-identifier hs-var">adjustFieldsIdInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe CoreExpr
</span><a href="#local-6989586621682980457"><span class="hs-identifier hs-var">scrut'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980458"><span class="hs-identifier hs-var">case_bndr'</span></a></span><span> </span><span class="annot"><span class="annottext">BinderSwapDecision
</span><a href="#local-6989586621682980459"><span class="hs-identifier hs-var">bndr_swap'</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682980461"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980462"><span class="hs-identifier hs-var">vs</span></a></span><span>
</span><span id="line-3439"></span><span>          </span><span class="hs-comment">-- Adjust evaluated-ness and occ-info flags before `simplBinders`</span><span>
</span><span id="line-3440"></span><span>          </span><span class="hs-comment">-- because the latter extends the in-scope set, which propagates this</span><span>
</span><span id="line-3441"></span><span>          </span><span class="hs-comment">-- adjusted info to use sites.</span><span>
</span><span id="line-3442"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980466"><span class="annot"><a href="#local-6989586621682980466"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980467"><span class="annot"><a href="#local-6989586621682980467"><span class="hs-identifier hs-var">vs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; [CoreBndr] -&gt; SimplM (SimplEnv, [CoreBndr])
</span><a href="GHC.Core.Opt.Simplify.Env.html#simplBinders"><span class="hs-identifier hs-var">simplBinders</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980456"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980464"><span class="hs-identifier hs-var">vs_with_info</span></a></span><span>
</span><span id="line-3443"></span><span>
</span><span id="line-3444"></span><span>                </span><span class="hs-comment">-- Bind the case-binder to (con args)</span><span>
</span><span id="line-3445"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682980468"><span class="annot"><a href="#local-6989586621682980468"><span class="hs-identifier hs-var hs-var">inst_tys'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Kind -&gt; [Kind]
Kind -&gt; [Kind]
</span><a href="GHC.Core.Type.html#tyConAppArgs"><span class="hs-identifier hs-var">tyConAppArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Kind
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980458"><span class="hs-identifier hs-var">case_bndr'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3446"></span><span>              </span><span class="annot"><a href="#local-6989586621682980470"><span class="hs-identifier hs-type">con_app</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>
</span><span id="line-3447"></span><span>              </span><span id="local-6989586621682980470"><span class="annot"><a href="#local-6989586621682980470"><span class="hs-identifier hs-var hs-var">con_app</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; [Kind] -&gt; [CoreBndr] -&gt; CoreExpr
forall b. DataCon -&gt; [Kind] -&gt; [CoreBndr] -&gt; Expr b
</span><a href="GHC.Core.html#mkConApp2"><span class="hs-identifier hs-var">mkConApp2</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682980461"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">[Kind]
</span><a href="#local-6989586621682980468"><span class="hs-identifier hs-var">inst_tys'</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980467"><span class="hs-identifier hs-var">vs'</span></a></span><span>
</span><span id="line-3448"></span><span>              </span><span id="local-6989586621682980472"><span class="annot"><a href="#local-6989586621682980472"><span class="hs-identifier hs-var hs-var">env''</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; BinderSwapDecision -&gt; CoreExpr -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#addAltUnfoldings"><span class="hs-identifier hs-var">addAltUnfoldings</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980466"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980458"><span class="hs-identifier hs-var">case_bndr'</span></a></span><span> </span><span class="annot"><span class="annottext">BinderSwapDecision
</span><a href="#local-6989586621682980459"><span class="hs-identifier hs-var">bndr_swap'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980470"><span class="hs-identifier hs-var">con_app</span></a></span><span>
</span><span id="line-3449"></span><span>
</span><span id="line-3450"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682980473"><span class="annot"><a href="#local-6989586621682980473"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprC"><span class="hs-identifier hs-type">simplExprC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980472"><span class="hs-identifier hs-type">env''</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980463"><span class="hs-identifier hs-type">rhs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980460"><span class="hs-identifier hs-type">cont'</span></a></span><span>
</span><span id="line-3451"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#DataAlt"><span class="hs-identifier hs-type">DataAlt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980461"><span class="hs-identifier hs-type">con</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682980467"><span class="hs-identifier hs-type">vs'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980473"><span class="hs-identifier hs-type">rhs'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3452"></span><span>
</span><span id="line-3453"></span><span class="hs-comment">{- Note [Adding evaluatedness info to pattern-bound variables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
addEvals records the evaluated-ness of the bound variables of
a case pattern.  This is *important*.  Consider

     data T = T !Int !Int

     case x of { T a b -&gt; T (a+1) b }

We really must record that b is already evaluated so that we don't
go and re-evaluate it when constructing the result.
See Note [Data-con worker strictness] in GHC.Core.DataCon

NB: simplLamBndrs preserves this eval info

In addition to handling data constructor fields with !s, addEvals
also records the fact that the result of seq# is always in WHNF.
See Note [seq# magic] in GHC.Types.Id.Make.  Example (#15226):

  case seq# v s of
    (# s', v' #) -&gt; E

we want the compiler to be aware that v' is in WHNF in E.

Open problem: we don't record that v itself is in WHNF (and we can't
do it here).  The right thing is to do some kind of binder-swap;
see #15226 for discussion.
-}</span><span>
</span><span id="line-3481"></span><span>
</span><span id="line-3482"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#adjustFieldsIdInfo"><span class="hs-identifier hs-type">adjustFieldsIdInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#BinderSwapDecision"><span class="hs-identifier hs-type">BinderSwapDecision</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-3483"></span><span class="hs-comment">-- See Note [Adding evaluatedness info to pattern-bound variables]</span><span>
</span><span id="line-3484"></span><span class="hs-comment">-- and Note [DataAlt occ info]</span><span>
</span><span id="line-3485"></span><span id="adjustFieldsIdInfo"><span class="annot"><span class="annottext">adjustFieldsIdInfo :: Maybe CoreExpr
-&gt; CoreBndr
-&gt; BinderSwapDecision
-&gt; DataCon
-&gt; [CoreBndr]
-&gt; [CoreBndr]
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#adjustFieldsIdInfo"><span class="hs-identifier hs-var hs-var">adjustFieldsIdInfo</span></a></span></span><span> </span><span id="local-6989586621682980474"><span class="annot"><span class="annottext">Maybe CoreExpr
</span><a href="#local-6989586621682980474"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621682980475"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980475"><span class="hs-identifier hs-var">case_bndr</span></a></span></span><span> </span><span id="local-6989586621682980476"><span class="annot"><span class="annottext">BinderSwapDecision
</span><a href="#local-6989586621682980476"><span class="hs-identifier hs-var">bndr_swap</span></a></span></span><span> </span><span id="local-6989586621682980477"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682980477"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span id="local-6989586621682980478"><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980478"><span class="hs-identifier hs-var">vs</span></a></span></span><span>
</span><span id="line-3486"></span><span>  </span><span class="hs-comment">-- Deal with seq# applications</span><span>
</span><span id="line-3487"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682980479"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980479"><span class="hs-identifier hs-var">scr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe CoreExpr
</span><a href="#local-6989586621682980474"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-3488"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; Bool
</span><a href="GHC.Core.DataCon.html#isUnboxedTupleDataCon"><span class="hs-identifier hs-var">isUnboxedTupleDataCon</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682980477"><span class="hs-identifier hs-var">con</span></a></span><span>
</span><span id="line-3489"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span id="local-6989586621682980480"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980480"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682980481"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980481"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980478"><span class="hs-identifier hs-var">vs</span></a></span><span>
</span><span id="line-3490"></span><span>    </span><span class="hs-comment">-- Use stripNArgs rather than collectArgsTicks to avoid building</span><span>
</span><span id="line-3491"></span><span>    </span><span class="hs-comment">-- a list of arguments only to throw it away immediately.</span><span>
</span><span id="line-3492"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682980482"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980482"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Word -&gt; CoreExpr -&gt; Maybe CoreExpr
forall a. Word -&gt; Expr a -&gt; Maybe (Expr a)
</span><a href="GHC.Core.html#stripNArgs"><span class="hs-identifier hs-var">stripNArgs</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">4</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980479"><span class="hs-identifier hs-var">scr</span></a></span><span>
</span><span id="line-3493"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980482"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#seqHashKey"><span class="hs-identifier hs-var">seqHashKey</span></a></span><span>
</span><span id="line-3494"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682980484"><span class="annot"><span class="annottext">x' :: CoreBndr
</span><a href="#local-6989586621682980484"><span class="hs-identifier hs-var hs-var">x'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictnessMark -&gt; CoreBndr -&gt; CoreBndr
</span><a href="GHC.Types.Id.html#setCaseBndrEvald"><span class="hs-identifier hs-var">setCaseBndrEvald</span></a></span><span> </span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="GHC.Core.DataCon.html#MarkedStrict"><span class="hs-identifier hs-var">MarkedStrict</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980481"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-3495"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreBndr -&gt; CoreBndr) -&gt; [CoreBndr] -&gt; [CoreBndr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; BinderSwapDecision -&gt; CoreBndr -&gt; CoreBndr
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#adjustFieldOccInfo"><span class="hs-identifier hs-var">adjustFieldOccInfo</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980475"><span class="hs-identifier hs-var">case_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">BinderSwapDecision
</span><a href="#local-6989586621682980476"><span class="hs-identifier hs-var">bndr_swap</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980480"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980484"><span class="hs-identifier hs-var">x'</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-3496"></span><span>
</span><span id="line-3497"></span><span>  </span><span class="hs-comment">-- Deal with banged datacon fields</span><span>
</span><span id="line-3498"></span><span>  </span><span class="hs-comment">-- This case is quite allocation sensitive to T9233 which has a large record</span><span>
</span><span id="line-3499"></span><span>  </span><span class="hs-comment">-- with strict fields. Hence we try not to update vs twice!</span><span>
</span><span id="line-3500"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#adjustFieldsIdInfo"><span class="hs-identifier hs-var">adjustFieldsIdInfo</span></a></span><span> </span><span id="local-6989586621682980488"><span class="annot"><span class="annottext">Maybe CoreExpr
</span><a href="#local-6989586621682980488"><span class="hs-identifier hs-var">_scrut</span></a></span></span><span> </span><span id="local-6989586621682980489"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980489"><span class="hs-identifier hs-var">case_bndr</span></a></span></span><span> </span><span id="local-6989586621682980490"><span class="annot"><span class="annottext">BinderSwapDecision
</span><a href="#local-6989586621682980490"><span class="hs-identifier hs-var">bndr_swap</span></a></span></span><span> </span><span id="local-6989586621682980491"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682980491"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span id="local-6989586621682980492"><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980492"><span class="hs-identifier hs-var">vs</span></a></span></span><span>
</span><span id="line-3501"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Maybe CoreBndr
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; Maybe CoreBndr
</span><a href="GHC.Core.DataCon.html#dataConWrapId_maybe"><span class="hs-identifier hs-var">dataConWrapId_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682980491"><span class="hs-identifier hs-var">con</span></a></span><span>
</span><span id="line-3502"></span><span>      </span><span class="hs-comment">-- A common fast path; no need to allocate the_strs when they are all lazy</span><span>
</span><span id="line-3503"></span><span>      </span><span class="hs-comment">-- anyway! It shaves off 2% in T9675</span><span>
</span><span id="line-3504"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreBndr -&gt; CoreBndr) -&gt; [CoreBndr] -&gt; [CoreBndr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; BinderSwapDecision -&gt; CoreBndr -&gt; CoreBndr
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#adjustFieldOccInfo"><span class="hs-identifier hs-var">adjustFieldOccInfo</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980489"><span class="hs-identifier hs-var">case_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">BinderSwapDecision
</span><a href="#local-6989586621682980490"><span class="hs-identifier hs-var">bndr_swap</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980492"><span class="hs-identifier hs-var">vs</span></a></span><span>
</span><span id="line-3505"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3506"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CoreBndr] -&gt; [StrictnessMark] -&gt; [CoreBndr]
</span><a href="#local-6989586621682980493"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980492"><span class="hs-identifier hs-var">vs</span></a></span><span> </span><span class="annot"><span class="annottext">[StrictnessMark]
</span><a href="#local-6989586621682980494"><span class="hs-identifier hs-var">the_strs</span></a></span><span>
</span><span id="line-3507"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3508"></span><span>    </span><span id="local-6989586621682980494"><span class="annot"><span class="annottext">the_strs :: [StrictnessMark]
</span><a href="#local-6989586621682980494"><span class="hs-identifier hs-var hs-var">the_strs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; [StrictnessMark]
</span><a href="GHC.Core.DataCon.html#dataConRepStrictness"><span class="hs-identifier hs-var">dataConRepStrictness</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682980491"><span class="hs-identifier hs-var">con</span></a></span><span>
</span><span id="line-3509"></span><span>
</span><span id="line-3510"></span><span>    </span><span id="local-6989586621682980493"><span class="annot"><span class="annottext">go :: [CoreBndr] -&gt; [StrictnessMark] -&gt; [CoreBndr]
</span><a href="#local-6989586621682980493"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-3511"></span><span>    </span><span class="annot"><a href="#local-6989586621682980493"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980495"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980495"><span class="hs-identifier hs-var">v</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682980496"><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980496"><span class="hs-identifier hs-var">vs'</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682980497"><span class="annot"><span class="annottext">[StrictnessMark]
</span><a href="#local-6989586621682980497"><span class="hs-identifier hs-var">strs</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980495"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980495"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; [CoreBndr] -&gt; [CoreBndr]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[CoreBndr] -&gt; [StrictnessMark] -&gt; [CoreBndr]
</span><a href="#local-6989586621682980493"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980496"><span class="hs-identifier hs-var">vs'</span></a></span><span> </span><span class="annot"><span class="annottext">[StrictnessMark]
</span><a href="#local-6989586621682980497"><span class="hs-identifier hs-var">strs</span></a></span><span>
</span><span id="line-3512"></span><span>    </span><span class="annot"><a href="#local-6989586621682980493"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980498"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980498"><span class="hs-identifier hs-var">v</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682980499"><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980499"><span class="hs-identifier hs-var">vs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980500"><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621682980500"><span class="hs-identifier hs-var">str</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682980501"><span class="annot"><span class="annottext">[StrictnessMark]
</span><a href="#local-6989586621682980501"><span class="hs-identifier hs-var">strs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; BinderSwapDecision -&gt; CoreBndr -&gt; CoreBndr
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#adjustFieldOccInfo"><span class="hs-identifier hs-var">adjustFieldOccInfo</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980489"><span class="hs-identifier hs-var">case_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">BinderSwapDecision
</span><a href="#local-6989586621682980490"><span class="hs-identifier hs-var">bndr_swap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictnessMark -&gt; CoreBndr -&gt; CoreBndr
</span><a href="GHC.Types.Id.html#setCaseBndrEvald"><span class="hs-identifier hs-var">setCaseBndrEvald</span></a></span><span> </span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621682980500"><span class="hs-identifier hs-var">str</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980498"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; [CoreBndr] -&gt; [CoreBndr]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[CoreBndr] -&gt; [StrictnessMark] -&gt; [CoreBndr]
</span><a href="#local-6989586621682980493"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980499"><span class="hs-identifier hs-var">vs'</span></a></span><span> </span><span class="annot"><span class="annottext">[StrictnessMark]
</span><a href="#local-6989586621682980501"><span class="hs-identifier hs-var">strs</span></a></span><span>
</span><span id="line-3513"></span><span>    </span><span class="annot"><a href="#local-6989586621682980493"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[StrictnessMark]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; [CoreBndr]
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Simplify.adjustFieldsIdInfo&quot;</span></span><span>
</span><span id="line-3514"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682980491"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-3515"></span><span>               </span><span class="annot"><span class="annottext">[CoreBndr] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980492"><span class="hs-identifier hs-var">vs</span></a></span><span>  </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-3516"></span><span>               </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall {t :: * -&gt; *} {a}.
(Outputable (t a), Foldable t) =&gt;
t a -&gt; SDoc
</span><a href="#local-6989586621682980502"><span class="hs-identifier hs-var">ppr_with_length</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(StrictnessMark -&gt; SDoc) -&gt; [StrictnessMark] -&gt; [SDoc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">StrictnessMark -&gt; SDoc
</span><a href="#local-6989586621682980503"><span class="hs-identifier hs-var">strdisp</span></a></span><span> </span><span class="annot"><span class="annottext">[StrictnessMark]
</span><a href="#local-6989586621682980494"><span class="hs-identifier hs-var">the_strs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-3517"></span><span>               </span><span class="annot"><span class="annottext">[Scaled Kind] -&gt; SDoc
forall {t :: * -&gt; *} {a}.
(Outputable (t a), Foldable t) =&gt;
t a -&gt; SDoc
</span><a href="#local-6989586621682980502"><span class="hs-identifier hs-var">ppr_with_length</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; [Scaled Kind]
</span><a href="GHC.Core.DataCon.html#dataConRepArgTys"><span class="hs-identifier hs-var">dataConRepArgTys</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682980491"><span class="hs-identifier hs-var">con</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-3518"></span><span>               </span><span class="annot"><span class="annottext">[StrictnessMark] -&gt; SDoc
forall {t :: * -&gt; *} {a}.
(Outputable (t a), Foldable t) =&gt;
t a -&gt; SDoc
</span><a href="#local-6989586621682980502"><span class="hs-identifier hs-var">ppr_with_length</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; [StrictnessMark]
</span><a href="GHC.Core.DataCon.html#dataConRepStrictness"><span class="hs-identifier hs-var">dataConRepStrictness</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682980491"><span class="hs-identifier hs-var">con</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3519"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-3520"></span><span>        </span><span id="local-6989586621682980502"><span class="annot"><span class="annottext">ppr_with_length :: t a -&gt; SDoc
</span><a href="#local-6989586621682980502"><span class="hs-identifier hs-var hs-var">ppr_with_length</span></a></span></span><span> </span><span id="local-6989586621682980514"><span class="annot"><span class="annottext">t a
</span><a href="#local-6989586621682980514"><span class="hs-identifier hs-var">list</span></a></span></span><span>
</span><span id="line-3521"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">t a -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">t a
</span><a href="#local-6989586621682980514"><span class="hs-identifier hs-var">list</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;length =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t a -&gt; Int
forall a. t a -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">t a
</span><a href="#local-6989586621682980514"><span class="hs-identifier hs-var">list</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3522"></span><span>        </span><span class="annot"><a href="#local-6989586621682980503"><span class="hs-identifier hs-type">strdisp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#StrictnessMark"><span class="hs-identifier hs-type">StrictnessMark</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span>
</span><span id="line-3523"></span><span>        </span><span id="local-6989586621682980503"><span class="annot"><span class="annottext">strdisp :: StrictnessMark -&gt; SDoc
</span><a href="#local-6989586621682980503"><span class="hs-identifier hs-var hs-var">strdisp</span></a></span></span><span> </span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="GHC.Core.DataCon.html#MarkedStrict"><span class="hs-identifier hs-var">MarkedStrict</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;MarkedStrict&quot;</span></span><span>
</span><span id="line-3524"></span><span>        </span><span class="annot"><a href="#local-6989586621682980503"><span class="hs-identifier hs-var">strdisp</span></a></span><span> </span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="GHC.Core.DataCon.html#NotMarkedStrict"><span class="hs-identifier hs-var">NotMarkedStrict</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;NotMarkedStrict&quot;</span></span><span>
</span><span id="line-3525"></span><span>
</span><span id="line-3526"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#adjustFieldOccInfo"><span class="hs-identifier hs-type">adjustFieldOccInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#BinderSwapDecision"><span class="hs-identifier hs-type">BinderSwapDecision</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a></span><span>
</span><span id="line-3527"></span><span class="hs-comment">-- Kill occ info if we do binder swap and the case binder is alive;</span><span>
</span><span id="line-3528"></span><span class="hs-comment">-- see Note [DataAlt occ info]</span><span>
</span><span id="line-3529"></span><span id="adjustFieldOccInfo"><span class="annot"><span class="annottext">adjustFieldOccInfo :: CoreBndr -&gt; BinderSwapDecision -&gt; CoreBndr -&gt; CoreBndr
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#adjustFieldOccInfo"><span class="hs-identifier hs-var hs-var">adjustFieldOccInfo</span></a></span></span><span> </span><span id="local-6989586621682980517"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980517"><span class="hs-identifier hs-var">case_bndr</span></a></span></span><span> </span><span id="local-6989586621682980518"><span class="annot"><span class="annottext">BinderSwapDecision
</span><a href="#local-6989586621682980518"><span class="hs-identifier hs-var">bndr_swap</span></a></span></span><span> </span><span id="local-6989586621682980519"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980519"><span class="hs-identifier hs-var">field_bndr</span></a></span></span><span>
</span><span id="line-3530"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980519"><span class="hs-identifier hs-var">field_bndr</span></a></span><span>
</span><span id="line-3531"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980519"><span class="hs-identifier hs-var">field_bndr</span></a></span><span>
</span><span id="line-3532"></span><span>
</span><span id="line-3533"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Id.html#isDeadBinder"><span class="hs-identifier hs-var">isDeadBinder</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980517"><span class="hs-identifier hs-var">case_bndr</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- (1) in the Note: If the case binder is alive,</span><span>
</span><span id="line-3534"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; CoreBndr
</span><a href="GHC.Types.Id.html#zapIdOccInfo"><span class="hs-identifier hs-var">zapIdOccInfo</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980519"><span class="hs-identifier hs-var">field_bndr</span></a></span><span>       </span><span class="hs-comment">-- the field binders might come back alive</span><span>
</span><span id="line-3535"></span><span>
</span><span id="line-3536"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#DoBinderSwap"><span class="hs-identifier hs-type">DoBinderSwap</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BinderSwapDecision
</span><a href="#local-6989586621682980518"><span class="hs-identifier hs-var">bndr_swap</span></a></span><span>   </span><span class="hs-comment">-- (2) in the Note: If binder swap might take place,</span><span>
</span><span id="line-3537"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; CoreBndr
</span><a href="GHC.Types.Id.html#zapIdOccInfo"><span class="hs-identifier hs-var">zapIdOccInfo</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980519"><span class="hs-identifier hs-var">field_bndr</span></a></span><span>       </span><span class="hs-comment">-- the case binder might come back alive</span><span>
</span><span id="line-3538"></span><span>
</span><span id="line-3539"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3540"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980519"><span class="hs-identifier hs-var">field_bndr</span></a></span><span>                    </span><span class="hs-comment">-- otherwise the field binders stay dead</span><span>
</span><span id="line-3541"></span><span>
</span><span id="line-3542"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#addDefaultUnfoldings"><span class="hs-identifier hs-type">addDefaultUnfoldings</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#BinderSwapDecision"><span class="hs-identifier hs-type">BinderSwapDecision</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span>
</span><span id="line-3543"></span><span id="addDefaultUnfoldings"><span class="annot"><span class="annottext">addDefaultUnfoldings :: SimplEnv -&gt; CoreBndr -&gt; BinderSwapDecision -&gt; [AltCon] -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#addDefaultUnfoldings"><span class="hs-identifier hs-var hs-var">addDefaultUnfoldings</span></a></span></span><span> </span><span id="local-6989586621682980522"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980522"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980523"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980523"><span class="hs-identifier hs-var">case_bndr</span></a></span></span><span> </span><span id="local-6989586621682980524"><span class="annot"><span class="annottext">BinderSwapDecision
</span><a href="#local-6989586621682980524"><span class="hs-identifier hs-var">bndr_swap</span></a></span></span><span> </span><span id="local-6989586621682980525"><span class="annot"><span class="annottext">[AltCon]
</span><a href="#local-6989586621682980525"><span class="hs-identifier hs-var">imposs_deflt_cons</span></a></span></span><span>
</span><span id="line-3544"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980526"><span class="hs-identifier hs-var">env2</span></a></span><span>
</span><span id="line-3545"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3546"></span><span>    </span><span id="local-6989586621682980527"><span class="annot"><span class="annottext">unf :: Unfolding
</span><a href="#local-6989586621682980527"><span class="hs-identifier hs-var hs-var">unf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[AltCon] -&gt; Unfolding
</span><a href="GHC.Core.html#mkOtherCon"><span class="hs-identifier hs-var">mkOtherCon</span></a></span><span> </span><span class="annot"><span class="annottext">[AltCon]
</span><a href="#local-6989586621682980525"><span class="hs-identifier hs-var">imposs_deflt_cons</span></a></span><span>
</span><span id="line-3547"></span><span>          </span><span class="hs-comment">-- Record the constructors that the case-binder *can't* be.</span><span>
</span><span id="line-3548"></span><span>    </span><span id="local-6989586621682980529"><span class="annot"><span class="annottext">env1 :: SimplEnv
</span><a href="#local-6989586621682980529"><span class="hs-identifier hs-var hs-var">env1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; Unfolding -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#addBinderUnfolding"><span class="hs-identifier hs-var">addBinderUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980522"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980523"><span class="hs-identifier hs-var">case_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682980527"><span class="hs-identifier hs-var">unf</span></a></span><span>
</span><span id="line-3549"></span><span>    </span><span id="local-6989586621682980526"><span class="annot"><span class="annottext">env2 :: SimplEnv
</span><a href="#local-6989586621682980526"><span class="hs-identifier hs-var hs-var">env2</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#DoBinderSwap"><span class="hs-identifier hs-type">DoBinderSwap</span></a></span><span> </span><span id="local-6989586621682980531"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980531"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621682980532"><span class="annot"><span class="annottext">MOutCoercion
</span><a href="#local-6989586621682980532"><span class="hs-identifier hs-var">_mco</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BinderSwapDecision
</span><a href="#local-6989586621682980524"><span class="hs-identifier hs-var">bndr_swap</span></a></span><span>
</span><span id="line-3550"></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; Unfolding -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#addBinderUnfolding"><span class="hs-identifier hs-var">addBinderUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980529"><span class="hs-identifier hs-var">env1</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980531"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682980527"><span class="hs-identifier hs-var">unf</span></a></span><span>
</span><span id="line-3551"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980529"><span class="hs-identifier hs-var">env1</span></a></span><span>
</span><span id="line-3552"></span><span>
</span><span id="line-3553"></span><span>
</span><span id="line-3554"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#addAltUnfoldings"><span class="hs-identifier hs-type">addAltUnfoldings</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#BinderSwapDecision"><span class="hs-identifier hs-type">BinderSwapDecision</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span>
</span><span id="line-3555"></span><span id="addAltUnfoldings"><span class="annot"><span class="annottext">addAltUnfoldings :: SimplEnv -&gt; CoreBndr -&gt; BinderSwapDecision -&gt; CoreExpr -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#addAltUnfoldings"><span class="hs-identifier hs-var hs-var">addAltUnfoldings</span></a></span></span><span> </span><span id="local-6989586621682980533"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980533"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980534"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980534"><span class="hs-identifier hs-var">case_bndr</span></a></span></span><span> </span><span id="local-6989586621682980535"><span class="annot"><span class="annottext">BinderSwapDecision
</span><a href="#local-6989586621682980535"><span class="hs-identifier hs-var">bndr_swap</span></a></span></span><span> </span><span id="local-6989586621682980536"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980536"><span class="hs-identifier hs-var">con_app</span></a></span></span><span>
</span><span id="line-3556"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980537"><span class="hs-identifier hs-var">env2</span></a></span><span>
</span><span id="line-3557"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3558"></span><span>    </span><span id="local-6989586621682980538"><span class="annot"><span class="annottext">con_app_unf :: Unfolding
</span><a href="#local-6989586621682980538"><span class="hs-identifier hs-var hs-var">con_app_unf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Unfolding
</span><a href="#local-6989586621682980539"><span class="hs-identifier hs-var">mk_simple_unf</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980536"><span class="hs-identifier hs-var">con_app</span></a></span><span>
</span><span id="line-3559"></span><span>    </span><span id="local-6989586621682980540"><span class="annot"><span class="annottext">env1 :: SimplEnv
</span><a href="#local-6989586621682980540"><span class="hs-identifier hs-var hs-var">env1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; Unfolding -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#addBinderUnfolding"><span class="hs-identifier hs-var">addBinderUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980533"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980534"><span class="hs-identifier hs-var">case_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682980538"><span class="hs-identifier hs-var">con_app_unf</span></a></span><span>
</span><span id="line-3560"></span><span>
</span><span id="line-3561"></span><span>    </span><span class="hs-comment">-- See Note [Add unfolding for scrutinee]</span><span>
</span><span id="line-3562"></span><span>    </span><span id="local-6989586621682980537"><span class="annot"><span class="annottext">env2 :: SimplEnv
</span><a href="#local-6989586621682980537"><span class="hs-identifier hs-var hs-var">env2</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#DoBinderSwap"><span class="hs-identifier hs-type">DoBinderSwap</span></a></span><span> </span><span id="local-6989586621682980541"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980541"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621682980542"><span class="annot"><span class="annottext">MOutCoercion
</span><a href="#local-6989586621682980542"><span class="hs-identifier hs-var">mco</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BinderSwapDecision
</span><a href="#local-6989586621682980535"><span class="hs-identifier hs-var">bndr_swap</span></a></span><span>
</span><span id="line-3563"></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; Unfolding -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#addBinderUnfolding"><span class="hs-identifier hs-var">addBinderUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980540"><span class="hs-identifier hs-var">env1</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980541"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(Unfolding -&gt; SimplEnv) -&gt; Unfolding -&gt; SimplEnv
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-3564"></span><span>              </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">MOutCoercion -&gt; Bool
</span><a href="GHC.Core.Coercion.html#isReflMCo"><span class="hs-identifier hs-var">isReflMCo</span></a></span><span> </span><span class="annot"><span class="annottext">MOutCoercion
</span><a href="#local-6989586621682980542"><span class="hs-identifier hs-var">mco</span></a></span><span>  </span><span class="hs-comment">-- isReflMCo: avoid calling mk_simple_unf</span><span>
</span><span id="line-3565"></span><span>              </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682980538"><span class="hs-identifier hs-var">con_app_unf</span></a></span><span>  </span><span class="hs-comment">--            twice in the common case</span><span>
</span><span id="line-3566"></span><span>              </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Unfolding
</span><a href="#local-6989586621682980539"><span class="hs-identifier hs-var">mk_simple_unf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; MOutCoercion -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkCastMCo"><span class="hs-identifier hs-var">mkCastMCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980536"><span class="hs-identifier hs-var">con_app</span></a></span><span> </span><span class="annot"><span class="annottext">MOutCoercion
</span><a href="#local-6989586621682980542"><span class="hs-identifier hs-var">mco</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3567"></span><span>
</span><span id="line-3568"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980540"><span class="hs-identifier hs-var">env1</span></a></span><span>
</span><span id="line-3569"></span><span>
</span><span id="line-3570"></span><span>    </span><span class="hs-comment">-- Force the opts, so that the whole SimplEnv isn't retained</span><span>
</span><span id="line-3571"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621682980545"><span class="annot"><span class="annottext">opts :: UnfoldingOpts
</span><a href="#local-6989586621682980545"><span class="hs-identifier hs-var hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; UnfoldingOpts
</span><a href="GHC.Core.Opt.Simplify.Env.html#seUnfoldingOpts"><span class="hs-identifier hs-var">seUnfoldingOpts</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980533"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-3572"></span><span>    </span><span id="local-6989586621682980539"><span class="annot"><span class="annottext">mk_simple_unf :: CoreExpr -&gt; Unfolding
</span><a href="#local-6989586621682980539"><span class="hs-identifier hs-var hs-var">mk_simple_unf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts -&gt; CoreExpr -&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkSimpleUnfolding"><span class="hs-identifier hs-var">mkSimpleUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682980545"><span class="hs-identifier hs-var">opts</span></a></span><span>
</span><span id="line-3573"></span><span>
</span><span id="line-3574"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#addBinderUnfolding"><span class="hs-identifier hs-type">addBinderUnfolding</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span>
</span><span id="line-3575"></span><span id="addBinderUnfolding"><span class="annot"><span class="annottext">addBinderUnfolding :: SimplEnv -&gt; CoreBndr -&gt; Unfolding -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#addBinderUnfolding"><span class="hs-identifier hs-var hs-var">addBinderUnfolding</span></a></span></span><span> </span><span id="local-6989586621682980547"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980547"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980548"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980548"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682980549"><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682980549"><span class="hs-identifier hs-var">unf</span></a></span></span><span>
</span><span id="line-3576"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Utils.Constants.html#debugIsOn"><span class="hs-identifier hs-var">debugIsOn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682980550"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980550"><span class="hs-identifier hs-var">tmpl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; Maybe CoreExpr
</span><a href="GHC.Core.html#maybeUnfoldingTemplate"><span class="hs-identifier hs-var">maybeUnfoldingTemplate</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682980549"><span class="hs-identifier hs-var">unf</span></a></span><span>
</span><span id="line-3577"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; String -&gt; SDoc -&gt; SimplEnv -&gt; SimplEnv
forall a. HasCallStack =&gt; Bool -&gt; String -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Trace.html#warnPprTrace"><span class="hs-identifier hs-var">warnPprTrace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasCallStack =&gt; Kind -&gt; Kind -&gt; Bool
Kind -&gt; Kind -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#eqType"><span class="hs-identifier hs-var">eqType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Kind
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980548"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; Kind
CoreExpr -&gt; Kind
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980550"><span class="hs-identifier hs-var">tmpl</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3578"></span><span>          </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;unfolding type mismatch&quot;</span></span><span>
</span><span id="line-3579"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980548"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">Kind -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Kind
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980548"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980550"><span class="hs-identifier hs-var">tmpl</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">Kind -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; Kind
CoreExpr -&gt; Kind
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980550"><span class="hs-identifier hs-var">tmpl</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SimplEnv -&gt; SimplEnv) -&gt; SimplEnv -&gt; SimplEnv
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-3580"></span><span>          </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#modifyInScope"><span class="hs-identifier hs-var">modifyInScope</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980547"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980548"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Unfolding -&gt; CoreBndr
</span><a href="GHC.Types.Id.html#setIdUnfolding"><span class="hs-operator hs-var">`setIdUnfolding`</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682980549"><span class="hs-identifier hs-var">unf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3581"></span><span>
</span><span id="line-3582"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3583"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#modifyInScope"><span class="hs-identifier hs-var">modifyInScope</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980547"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980548"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Unfolding -&gt; CoreBndr
</span><a href="GHC.Types.Id.html#setIdUnfolding"><span class="hs-operator hs-var">`setIdUnfolding`</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682980549"><span class="hs-identifier hs-var">unf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3584"></span><span>
</span><span id="line-3585"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#zapBndrOccInfo"><span class="hs-identifier hs-type">zapBndrOccInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>
</span><span id="line-3586"></span><span class="hs-comment">-- Consider  case e of b { (a,b) -&gt; ... }</span><span>
</span><span id="line-3587"></span><span class="hs-comment">-- Then if we bind b to (a,b) in &quot;...&quot;, and b is not dead,</span><span>
</span><span id="line-3588"></span><span class="hs-comment">-- then we must zap the deadness info on a,b</span><span>
</span><span id="line-3589"></span><span id="zapBndrOccInfo"><span class="annot"><span class="annottext">zapBndrOccInfo :: Bool -&gt; CoreBndr -&gt; CoreBndr
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#zapBndrOccInfo"><span class="hs-identifier hs-var hs-var">zapBndrOccInfo</span></a></span></span><span> </span><span id="local-6989586621682980553"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682980553"><span class="hs-identifier hs-var">keep_occ_info</span></a></span></span><span> </span><span id="local-6989586621682980554"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980554"><span class="hs-identifier hs-var">pat_id</span></a></span></span><span>
</span><span id="line-3590"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682980553"><span class="hs-identifier hs-var">keep_occ_info</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980554"><span class="hs-identifier hs-var">pat_id</span></a></span><span>
</span><span id="line-3591"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; CoreBndr
</span><a href="GHC.Types.Id.html#zapIdOccInfo"><span class="hs-identifier hs-var">zapIdOccInfo</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980554"><span class="hs-identifier hs-var">pat_id</span></a></span><span>
</span><span id="line-3592"></span><span>
</span><span id="line-3593"></span><span class="hs-comment">{- Note [Case binder evaluated-ness]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We pin on a (OtherCon []) unfolding to the case-binder of a Case,
even though it'll be over-ridden in every case alternative with a more
informative unfolding.  Why?  Because suppose a later, less clever, pass
simply replaces all occurrences of the case binder with the binder itself;
then Lint may complain about the let-can-float invariant.  Example
    case e of b { DEFAULT -&gt; let v = reallyUnsafePtrEquality# b y in ....
                ; K       -&gt; blah }

The let-can-float invariant requires that y is evaluated in the call to
reallyUnsafePtrEquality#, which it is.  But we still want that to be true if we
propagate binders to occurrences.

This showed up in #13027.

Note [Add unfolding for scrutinee]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In general it's unlikely that a variable scrutinee will appear
in the case alternatives   case x of { ...x unlikely to appear... }
because the binder-swap in OccurAnal has got rid of all such occurrences
See Note [Binder swap] in &quot;GHC.Core.Opt.OccurAnal&quot;.

BUT it is still VERY IMPORTANT to add a suitable unfolding for a
variable scrutinee, in simplAlt.  Here's why
   case x of y
     (a,b) -&gt; case b of c
                I# v -&gt; ...(f y)...
There is no occurrence of 'b' in the (...(f y)...).  But y gets
the unfolding (a,b), and *that* mentions b.  If f has a RULE
    RULE f (p, I# q) = ...
we want that rule to match, so we must extend the in-scope env with a
suitable unfolding for 'y'.  It's *essential* for rule matching; but
it's also good for case-elimination -- suppose that 'f' was inlined
and did multi-level case analysis, then we'd solve it in one
simplifier sweep instead of two.

HOWEVER, given
  case x of y { Just a -&gt; r1; Nothing -&gt; r2 }
we do not want to add the unfolding x -&gt; y to 'x', which might seem cool,
since 'y' itself has different unfoldings in r1 and r2.  Reason: if we
did that, we'd have to zap y's deadness info and that is a very useful
piece of information.

So instead we add the unfolding x -&gt; Just a, and x -&gt; Nothing in the
respective RHSs.

Since this transformation is tantamount to a binder swap, we use
GHC.Core.Opt.OccurAnal.scrutOkForBinderSwap to do the check.

Exactly the same issue arises in GHC.Core.Opt.SpecConstr;
see Note [Add scrutinee to ValueEnv too] in GHC.Core.Opt.SpecConstr


************************************************************************
*                                                                      *
\subsection{Known constructor}
*                                                                      *
************************************************************************

We are a bit careful with occurrence info.  Here's an example

        (\x* -&gt; case x of (a*, b) -&gt; f a) (h v, e)

where the * means &quot;occurs once&quot;.  This effectively becomes
        case (h v, e) of (a*, b) -&gt; f a)
and then
        let a* = h v; b = e in f a
and then
        f (h v)

All this should happen in one sweep.
-}</span><span>
</span><span id="line-3666"></span><span>
</span><span id="line-3667"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#knownCon"><span class="hs-identifier hs-type">knownCon</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span>
</span><span id="line-3668"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>                                           </span><span class="hs-comment">-- The scrutinee</span><span>
</span><span id="line-3669"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Make.html#FloatBind"><span class="hs-identifier hs-type">FloatBind</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#OutType"><span class="hs-identifier hs-type">OutType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- The scrutinee (in pieces)</span><span>
</span><span id="line-3670"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#InBndr"><span class="hs-identifier hs-type">InBndr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span>                        </span><span class="hs-comment">-- The alternative</span><span>
</span><span id="line-3671"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-3672"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3673"></span><span>
</span><span id="line-3674"></span><span id="knownCon"><span class="annot"><span class="annottext">knownCon :: SimplEnv
-&gt; CoreExpr
-&gt; [FloatBind]
-&gt; DataCon
-&gt; [Kind]
-&gt; [CoreExpr]
-&gt; CoreBndr
-&gt; [CoreBndr]
-&gt; CoreExpr
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#knownCon"><span class="hs-identifier hs-var hs-var">knownCon</span></a></span></span><span> </span><span id="local-6989586621682980555"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980555"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980556"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980556"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621682980557"><span class="annot"><span class="annottext">[FloatBind]
</span><a href="#local-6989586621682980557"><span class="hs-identifier hs-var">dc_floats</span></a></span></span><span> </span><span id="local-6989586621682980558"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682980558"><span class="hs-identifier hs-var">dc</span></a></span></span><span> </span><span id="local-6989586621682980559"><span class="annot"><span class="annottext">[Kind]
</span><a href="#local-6989586621682980559"><span class="hs-identifier hs-var">dc_ty_args</span></a></span></span><span> </span><span id="local-6989586621682980560"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682980560"><span class="hs-identifier hs-var">dc_args</span></a></span></span><span> </span><span id="local-6989586621682980561"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980561"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682980562"><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980562"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621682980563"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980563"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span id="local-6989586621682980564"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980564"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-3675"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980565"><span class="annot"><a href="#local-6989586621682980565"><span class="hs-identifier hs-var">floats1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980566"><span class="annot"><a href="#local-6989586621682980566"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; [CoreBndr] -&gt; [CoreExpr] -&gt; SimplM (SimplFloats, SimplEnv)
</span><a href="#local-6989586621682980567"><span class="hs-identifier hs-var">bind_args</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980555"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980562"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682980560"><span class="hs-identifier hs-var">dc_args</span></a></span><span>
</span><span id="line-3676"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980568"><span class="annot"><a href="#local-6989586621682980568"><span class="hs-identifier hs-var">floats2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980569"><span class="annot"><a href="#local-6989586621682980569"><span class="hs-identifier hs-var">env2</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621682980570"><span class="hs-identifier hs-type">bind_case_bndr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980566"><span class="hs-identifier hs-type">env1</span></a></span><span>
</span><span id="line-3677"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980571"><span class="annot"><a href="#local-6989586621682980571"><span class="hs-identifier hs-var">floats3</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980572"><span class="annot"><a href="#local-6989586621682980572"><span class="hs-identifier hs-var">expr'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprF"><span class="hs-identifier hs-type">simplExprF</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980569"><span class="hs-identifier hs-type">env2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980563"><span class="hs-identifier hs-type">rhs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980564"><span class="hs-identifier hs-type">cont</span></a></span><span>
</span><span id="line-3678"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621682980557"><span class="hs-identifier hs-type">dc_floats</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3679"></span><span>            </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-3680"></span><span>              </span><span class="annot"><span class="annottext">(SimplFloats, CoreExpr) -&gt; SimplM (SimplFloats, CoreExpr)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682980565"><span class="hs-identifier hs-var">floats1</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats -&gt; SimplFloats -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#addFloats"><span class="hs-operator hs-var">`addFloats`</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682980568"><span class="hs-identifier hs-var">floats2</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats -&gt; SimplFloats -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#addFloats"><span class="hs-operator hs-var">`addFloats`</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682980571"><span class="hs-identifier hs-var">floats3</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980572"><span class="hs-identifier hs-var">expr'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3681"></span><span>            </span><span class="annot"><span class="annottext">[FloatBind]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-3682"></span><span>              </span><span class="annot"><span class="annottext">(SimplFloats, CoreExpr) -&gt; SimplM (SimplFloats, CoreExpr)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980555"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-3683"></span><span>               </span><span class="hs-comment">-- See Note [FloatBinds from constructor wrappers]</span><span>
</span><span id="line-3684"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[FloatBind] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Make.html#wrapFloats"><span class="hs-identifier hs-var">GHC.Core.Make.wrapFloats</span></a></span><span> </span><span class="annot"><span class="annottext">[FloatBind]
</span><a href="#local-6989586621682980557"><span class="hs-identifier hs-var">dc_floats</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr) -&gt; CoreExpr -&gt; CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-3685"></span><span>                       </span><span class="annot"><span class="annottext">SimplFloats -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Env.html#wrapFloats"><span class="hs-identifier hs-var">wrapFloats</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682980565"><span class="hs-identifier hs-var">floats1</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats -&gt; SimplFloats -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#addFloats"><span class="hs-operator hs-var">`addFloats`</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682980568"><span class="hs-identifier hs-var">floats2</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats -&gt; SimplFloats -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#addFloats"><span class="hs-operator hs-var">`addFloats`</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682980571"><span class="hs-identifier hs-var">floats3</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980572"><span class="hs-identifier hs-var">expr'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3686"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3687"></span><span>    </span><span id="local-6989586621682980573"><span class="annot"><span class="annottext">zap_occ :: CoreBndr -&gt; CoreBndr
</span><a href="#local-6989586621682980573"><span class="hs-identifier hs-var hs-var">zap_occ</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; CoreBndr -&gt; CoreBndr
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#zapBndrOccInfo"><span class="hs-identifier hs-var">zapBndrOccInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Id.html#isDeadBinder"><span class="hs-identifier hs-var">isDeadBinder</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980561"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- bndr is an InId</span><span>
</span><span id="line-3688"></span><span>
</span><span id="line-3689"></span><span>                  </span><span class="hs-comment">-- Ugh!</span><span>
</span><span id="line-3690"></span><span>    </span><span id="local-6989586621682980567"><span class="annot"><span class="annottext">bind_args :: SimplEnv
-&gt; [CoreBndr] -&gt; [CoreExpr] -&gt; SimplM (SimplFloats, SimplEnv)
</span><a href="#local-6989586621682980567"><span class="hs-identifier hs-var hs-var">bind_args</span></a></span></span><span> </span><span id="local-6989586621682980574"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980574"><span class="hs-identifier hs-var">env'</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SimplFloats, SimplEnv) -&gt; SimplM (SimplFloats, SimplEnv)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980574"><span class="hs-identifier hs-var">env'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980574"><span class="hs-identifier hs-var">env'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3691"></span><span>
</span><span id="line-3692"></span><span>    </span><span class="annot"><a href="#local-6989586621682980567"><span class="hs-identifier hs-var">bind_args</span></a></span><span> </span><span id="local-6989586621682980575"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980575"><span class="hs-identifier hs-var">env'</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980576"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980576"><span class="hs-identifier hs-var">b</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682980577"><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980577"><span class="hs-identifier hs-var">bs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span id="local-6989586621682980578"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980578"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682980579"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682980579"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-3693"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; (SimplEnv
    -&gt; [CoreBndr] -&gt; [CoreExpr] -&gt; SimplM (SimplFloats, SimplEnv))
-&gt; SimplEnv
-&gt; [CoreBndr]
-&gt; [CoreExpr]
-&gt; SimplM (SimplFloats, SimplEnv)
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980576"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-3694"></span><span>        </span><span class="annot"><span class="annottext">SimplEnv
-&gt; [CoreBndr] -&gt; [CoreExpr] -&gt; SimplM (SimplFloats, SimplEnv)
</span><a href="#local-6989586621682980567"><span class="hs-identifier hs-var">bind_args</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; Kind -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#extendTvSubst"><span class="hs-identifier hs-var">extendTvSubst</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980575"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980576"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980578"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980577"><span class="hs-identifier hs-var">bs'</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682980579"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-3695"></span><span>
</span><span id="line-3696"></span><span>    </span><span class="annot"><a href="#local-6989586621682980567"><span class="hs-identifier hs-var">bind_args</span></a></span><span> </span><span id="local-6989586621682980580"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980580"><span class="hs-identifier hs-var">env'</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980581"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980581"><span class="hs-identifier hs-var">b</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682980582"><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980582"><span class="hs-identifier hs-var">bs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span id="local-6989586621682980583"><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682980583"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682980584"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682980584"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-3697"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; (SimplEnv
    -&gt; [CoreBndr] -&gt; [CoreExpr] -&gt; SimplM (SimplFloats, SimplEnv))
-&gt; SimplEnv
-&gt; [CoreBndr]
-&gt; [CoreExpr]
-&gt; SimplM (SimplFloats, SimplEnv)
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980581"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-3698"></span><span>        </span><span class="annot"><span class="annottext">SimplEnv
-&gt; [CoreBndr] -&gt; [CoreExpr] -&gt; SimplM (SimplFloats, SimplEnv)
</span><a href="#local-6989586621682980567"><span class="hs-identifier hs-var">bind_args</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; CoercionR -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#extendCvSubst"><span class="hs-identifier hs-var">extendCvSubst</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980580"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980581"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682980583"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980582"><span class="hs-identifier hs-var">bs'</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682980584"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-3699"></span><span>
</span><span id="line-3700"></span><span>    </span><span class="annot"><a href="#local-6989586621682980567"><span class="hs-identifier hs-var">bind_args</span></a></span><span> </span><span id="local-6989586621682980585"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980585"><span class="hs-identifier hs-var">env'</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980586"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980586"><span class="hs-identifier hs-var">b</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682980587"><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980587"><span class="hs-identifier hs-var">bs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980588"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980588"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682980589"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682980589"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-3701"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; SimplM (SimplFloats, SimplEnv) -&gt; SimplM (SimplFloats, SimplEnv)
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980586"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SimplM (SimplFloats, SimplEnv) -&gt; SimplM (SimplFloats, SimplEnv))
-&gt; SimplM (SimplFloats, SimplEnv) -&gt; SimplM (SimplFloats, SimplEnv)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-3702"></span><span>        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682980590"><span class="annot"><span class="annottext">b' :: CoreBndr
</span><a href="#local-6989586621682980590"><span class="hs-identifier hs-var hs-var hs-var">b'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; CoreBndr
</span><a href="#local-6989586621682980573"><span class="hs-identifier hs-var">zap_occ</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980586"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-3703"></span><span>             </span><span class="hs-comment">-- zap_occ: the binder might be &quot;dead&quot;, because it doesn't</span><span>
</span><span id="line-3704"></span><span>             </span><span class="hs-comment">-- occur in the RHS; and simplAuxBind may therefore discard it.</span><span>
</span><span id="line-3705"></span><span>             </span><span class="hs-comment">-- Nevertheless we must keep it if the case-binder is alive,</span><span>
</span><span id="line-3706"></span><span>             </span><span class="hs-comment">-- because it may be used in the con_app.  See Note [knownCon occ info]</span><span>
</span><span id="line-3707"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980591"><span class="annot"><a href="#local-6989586621682980591"><span class="hs-identifier hs-var">floats1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980592"><span class="annot"><a href="#local-6989586621682980592"><span class="hs-identifier hs-var">env2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; SimplEnv
-&gt; CoreBndr
-&gt; CoreExpr
-&gt; SimplM (SimplFloats, SimplEnv)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplAuxBind"><span class="hs-identifier hs-var">simplAuxBind</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;knownCon&quot;</span></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980585"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980590"><span class="hs-identifier hs-var">b'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980588"><span class="hs-identifier hs-var">arg</span></a></span><span>  </span><span class="hs-comment">-- arg satisfies let-can-float invariant</span><span>
</span><span id="line-3708"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980593"><span class="annot"><a href="#local-6989586621682980593"><span class="hs-identifier hs-var">floats2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980594"><span class="annot"><a href="#local-6989586621682980594"><span class="hs-identifier hs-var">env3</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621682980567"><span class="hs-identifier hs-type">bind_args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980592"><span class="hs-identifier hs-type">env2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980587"><span class="hs-identifier hs-type">bs'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980589"><span class="hs-identifier hs-type">args</span></a></span><span>
</span><span id="line-3709"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682980591"><span class="hs-identifier hs-type">floats1</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#addFloats"><span class="hs-operator hs-type">`addFloats`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980593"><span class="hs-identifier hs-type">floats2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682980594"><span class="hs-identifier hs-type">env3</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3710"></span><span>
</span><span id="line-3711"></span><span>    </span><span class="annot"><a href="#local-6989586621682980567"><span class="hs-identifier hs-var">bind_args</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-3712"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; SimplM (SimplFloats, SimplEnv)
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;bind_args&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; SimplM (SimplFloats, SimplEnv))
-&gt; SDoc -&gt; SimplM (SimplFloats, SimplEnv)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682980558"><span class="hs-identifier hs-var">dc</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980562"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682980560"><span class="hs-identifier hs-var">dc_args</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-3713"></span><span>                             </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;scrut:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980556"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-3714"></span><span>
</span><span id="line-3715"></span><span>       </span><span class="hs-comment">-- It's useful to bind bndr to scrut, rather than to a fresh</span><span>
</span><span id="line-3716"></span><span>       </span><span class="hs-comment">-- binding      x = Con arg1 .. argn</span><span>
</span><span id="line-3717"></span><span>       </span><span class="hs-comment">-- because very often the scrut is a variable, so we avoid</span><span>
</span><span id="line-3718"></span><span>       </span><span class="hs-comment">-- creating, and then subsequently eliminating, a let-binding</span><span>
</span><span id="line-3719"></span><span>       </span><span class="hs-comment">-- BUT, if scrut is a not a variable, we must be careful</span><span>
</span><span id="line-3720"></span><span>       </span><span class="hs-comment">-- about duplicating the arg redexes; in that case, make</span><span>
</span><span id="line-3721"></span><span>       </span><span class="hs-comment">-- a new con-app from the args</span><span>
</span><span id="line-3722"></span><span>    </span><span id="local-6989586621682980570"><span class="annot"><span class="annottext">bind_case_bndr :: SimplEnv -&gt; SimplM (SimplFloats, SimplEnv)
</span><a href="#local-6989586621682980570"><span class="hs-identifier hs-var hs-var">bind_case_bndr</span></a></span></span><span> </span><span id="local-6989586621682980595"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980595"><span class="hs-identifier hs-var">env</span></a></span></span><span>
</span><span id="line-3723"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Id.html#isDeadBinder"><span class="hs-identifier hs-var">isDeadBinder</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980561"><span class="hs-identifier hs-var">bndr</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SimplFloats, SimplEnv) -&gt; SimplM (SimplFloats, SimplEnv)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980595"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980595"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3724"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980556"><span class="hs-identifier hs-var">scrut</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SimplFloats, SimplEnv) -&gt; SimplM (SimplFloats, SimplEnv)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980595"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-3725"></span><span>                                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; SimplSR -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#extendIdSubst"><span class="hs-identifier hs-var">extendIdSubst</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980595"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980561"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; JoinPointHood -&gt; SimplSR
</span><a href="GHC.Core.Opt.Simplify.Env.html#DoneEx"><span class="hs-identifier hs-var">DoneEx</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980556"><span class="hs-identifier hs-var">scrut</span></a></span><span> </span><span class="annot"><span class="annottext">JoinPointHood
</span><a href="GHC.Utils.Outputable.html#NotJoinPoint"><span class="hs-identifier hs-var">NotJoinPoint</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3726"></span><span>                              </span><span class="hs-comment">-- See Note [Do not duplicate constructor applications]</span><span>
</span><span id="line-3727"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682980596"><span class="annot"><a href="#local-6989586621682980596"><span class="hs-identifier hs-var">dc_args</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(CoreBndr -&gt; SimplM CoreExpr) -&gt; [CoreBndr] -&gt; SimplM [CoreExpr]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; SimplM CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplVar"><span class="hs-identifier hs-var">simplVar</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980595"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980562"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-3728"></span><span>                                         </span><span class="hs-comment">-- dc_ty_args are already OutTypes,</span><span>
</span><span id="line-3729"></span><span>                                         </span><span class="hs-comment">-- but bs are InBndrs</span><span>
</span><span id="line-3730"></span><span>                                 </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682980598"><span class="annot"><a href="#local-6989586621682980598"><span class="hs-identifier hs-var hs-var">con_app</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; CoreExpr
forall b. CoreBndr -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; CoreBndr
</span><a href="GHC.Core.DataCon.html#dataConWorkId"><span class="hs-identifier hs-var">dataConWorkId</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682980558"><span class="hs-identifier hs-var">dc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3731"></span><span>                                                 </span><span class="annot"><span class="annottext">CoreExpr -&gt; [Kind] -&gt; CoreExpr
forall b. Expr b -&gt; [Kind] -&gt; Expr b
</span><a href="GHC.Core.html#mkTyApps"><span class="hs-operator hs-var">`mkTyApps`</span></a></span><span> </span><span class="annot"><span class="annottext">[Kind]
</span><a href="#local-6989586621682980559"><span class="hs-identifier hs-var">dc_ty_args</span></a></span><span>
</span><span id="line-3732"></span><span>                                                 </span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; CoreExpr
forall b. Expr b -&gt; [Expr b] -&gt; Expr b
</span><a href="GHC.Core.html#mkApps"><span class="hs-operator hs-var">`mkApps`</span></a></span><span>   </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682980596"><span class="hs-identifier hs-var">dc_args</span></a></span><span>
</span><span id="line-3733"></span><span>                                 </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplAuxBind"><span class="hs-identifier hs-type">simplAuxBind</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;case-bndr&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621682980595"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980561"><span class="hs-identifier hs-type">bndr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980598"><span class="hs-identifier hs-type">con_app</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3734"></span><span>
</span><span id="line-3735"></span><span class="hs-comment">-------------------</span><span>
</span><span id="line-3736"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#missingAlt"><span class="hs-identifier hs-type">missingAlt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#InAlt"><span class="hs-identifier hs-type">InAlt</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-3737"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3738"></span><span>                </span><span class="hs-comment">-- This isn't strictly an error, although it is unusual.</span><span>
</span><span id="line-3739"></span><span>                </span><span class="hs-comment">-- It's possible that the simplifier might &quot;see&quot; that</span><span>
</span><span id="line-3740"></span><span>                </span><span class="hs-comment">-- an inner case has no accessible alternatives before</span><span>
</span><span id="line-3741"></span><span>                </span><span class="hs-comment">-- it &quot;sees&quot; that the entire branch of an outer case is</span><span>
</span><span id="line-3742"></span><span>                </span><span class="hs-comment">-- inaccessible.  So we simply put an error case here instead.</span><span>
</span><span id="line-3743"></span><span id="missingAlt"><span class="annot"><span class="annottext">missingAlt :: SimplEnv
-&gt; CoreBndr
-&gt; [Alt CoreBndr]
-&gt; SimplCont
-&gt; SimplM (SimplFloats, CoreExpr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#missingAlt"><span class="hs-identifier hs-var hs-var">missingAlt</span></a></span></span><span> </span><span id="local-6989586621682980599"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980599"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980600"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980600"><span class="hs-identifier hs-var">case_bndr</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Alt CoreBndr]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682980601"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980601"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-3744"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; String
-&gt; SDoc
-&gt; SimplM (SimplFloats, CoreExpr)
-&gt; SimplM (SimplFloats, CoreExpr)
forall a. HasCallStack =&gt; Bool -&gt; String -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Trace.html#warnPprTrace"><span class="hs-identifier hs-var">warnPprTrace</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;missingAlt&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980600"><span class="hs-identifier hs-var">case_bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SimplM (SimplFloats, CoreExpr) -&gt; SimplM (SimplFloats, CoreExpr))
-&gt; SimplM (SimplFloats, CoreExpr) -&gt; SimplM (SimplFloats, CoreExpr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-3745"></span><span>    </span><span class="hs-comment">-- See Note [Avoiding space leaks in OutType]</span><span>
</span><span id="line-3746"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682980602"><span class="annot"><span class="annottext">cont_ty :: Kind
</span><a href="#local-6989586621682980602"><span class="hs-identifier hs-var hs-var">cont_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980601"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-3747"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Kind -&gt; ()
</span><a href="GHC.Core.Type.html#seqType"><span class="hs-identifier hs-var">seqType</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980602"><span class="hs-identifier hs-var">cont_ty</span></a></span><span> </span><span class="annot"><span class="annottext">()
-&gt; SimplM (SimplFloats, CoreExpr) -&gt; SimplM (SimplFloats, CoreExpr)
forall a b. a -&gt; b -&gt; b
</span><span class="hs-operator hs-var">`seq`</span></span><span>
</span><span id="line-3748"></span><span>       </span><span class="annot"><span class="annottext">(SimplFloats, CoreExpr) -&gt; SimplM (SimplFloats, CoreExpr)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980599"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Kind -&gt; String -&gt; CoreExpr
</span><a href="GHC.Core.Make.html#mkImpossibleExpr"><span class="hs-identifier hs-var">mkImpossibleExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980602"><span class="hs-identifier hs-var">cont_ty</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Simplify.Iteration.missingAlt&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-3749"></span><span>
</span><span id="line-3750"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Duplicating continuations}
*                                                                      *
************************************************************************

Consider
  let x* = case e of { True -&gt; e1; False -&gt; e2 }
  in b
where x* is a strict binding.  Then mkDupableCont will be given
the continuation
   case [] of { True -&gt; e1; False -&gt; e2 } ; let x* = [] in b ; stop
and will split it into
   dupable:      case [] of { True -&gt; $j1; False -&gt; $j2 } ; stop
   join floats:  $j1 = e1, $j2 = e2
   non_dupable:  let x* = [] in b; stop

Putting this back together would give
   let x* = let { $j1 = e1; $j2 = e2 } in
            case e of { True -&gt; $j1; False -&gt; $j2 }
   in b
(Of course we only do this if 'e' wants to duplicate that continuation.)
Note how important it is that the new join points wrap around the
inner expression, and not around the whole thing.

In contrast, any let-bindings introduced by mkDupableCont can wrap
around the entire thing.

Note [Bottom alternatives]
~~~~~~~~~~~~~~~~~~~~~~~~~~
When we have
     case (case x of { A -&gt; error .. ; B -&gt; e; C -&gt; error ..)
       of alts
then we can just duplicate those alts because the A and C cases
will disappear immediately.  This is more direct than creating
join points and inlining them away.  See #4930.
-}</span><span>
</span><span id="line-3788"></span><span>
</span><span id="line-3789"></span><span class="hs-comment">--------------------</span><span>
</span><span id="line-3790"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#mkDupableCaseCont"><span class="hs-identifier hs-type">mkDupableCaseCont</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#InAlt"><span class="hs-identifier hs-type">InAlt</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-3791"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span>  </span><span class="hs-comment">-- Join points (if any)</span><span>
</span><span id="line-3792"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span>     </span><span class="hs-comment">-- Use this for the alts</span><span>
</span><span id="line-3793"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3794"></span><span id="mkDupableCaseCont"><span class="annot"><span class="annottext">mkDupableCaseCont :: SimplEnv
-&gt; [Alt CoreBndr]
-&gt; SimplCont
-&gt; SimplM (SimplFloats, SimplEnv, SimplCont)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#mkDupableCaseCont"><span class="hs-identifier hs-var hs-var">mkDupableCaseCont</span></a></span></span><span> </span><span id="local-6989586621682980603"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980603"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980604"><span class="annot"><span class="annottext">[Alt CoreBndr]
</span><a href="#local-6989586621682980604"><span class="hs-identifier hs-var">alts</span></a></span></span><span> </span><span id="local-6989586621682980605"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980605"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-3795"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Alt CoreBndr] -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#altsWouldDup"><span class="hs-identifier hs-var">altsWouldDup</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt CoreBndr]
</span><a href="#local-6989586621682980604"><span class="hs-identifier hs-var">alts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980607"><span class="annot"><a href="#local-6989586621682980607"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980608"><span class="annot"><a href="#local-6989586621682980608"><span class="hs-identifier hs-var">cont</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplCont -&gt; SimplM (SimplFloats, SimplCont)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#mkDupableCont"><span class="hs-identifier hs-var">mkDupableCont</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980603"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980605"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-3796"></span><span>                           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682980609"><span class="annot"><a href="#local-6989586621682980609"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#bumpCaseDepth"><span class="hs-identifier hs-var">bumpCaseDepth</span></a></span><span> </span><span class="annot"><span class="annottext">(SimplEnv -&gt; SimplEnv) -&gt; SimplEnv -&gt; SimplEnv
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-3797"></span><span>                                        </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980603"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplFloats -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#setInScopeFromF"><span class="hs-operator hs-var">`setInScopeFromF`</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682980607"><span class="hs-identifier hs-var">floats</span></a></span><span>
</span><span id="line-3798"></span><span>                           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682980607"><span class="hs-identifier hs-type">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682980609"><span class="hs-identifier hs-type">env'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682980608"><span class="hs-identifier hs-type">cont</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3799"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SimplFloats, SimplEnv, SimplCont)
-&gt; SimplM (SimplFloats, SimplEnv, SimplCont)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980603"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980603"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980605"><span class="hs-identifier hs-var">cont</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3800"></span><span>
</span><span id="line-3801"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#altsWouldDup"><span class="hs-identifier hs-type">altsWouldDup</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#InAlt"><span class="hs-identifier hs-type">InAlt</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-comment">-- True iff strictly &gt; 1 non-bottom alternative</span><span>
</span><span id="line-3802"></span><span id="altsWouldDup"><span class="annot"><span class="annottext">altsWouldDup :: [Alt CoreBndr] -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#altsWouldDup"><span class="hs-identifier hs-var hs-var">altsWouldDup</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>        </span><span class="hs-comment">-- See Note [Bottom alternatives]</span><span>
</span><span id="line-3803"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#altsWouldDup"><span class="hs-identifier hs-var">altsWouldDup</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Alt CoreBndr
</span><span class="hs-identifier">_</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-3804"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#altsWouldDup"><span class="hs-identifier hs-var">altsWouldDup</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980611"><span class="annot"><span class="annottext">Alt CoreBndr
</span><a href="#local-6989586621682980611"><span class="hs-identifier hs-var">alt</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682980612"><span class="annot"><span class="annottext">[Alt CoreBndr]
</span><a href="#local-6989586621682980612"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-3805"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Alt CoreBndr -&gt; Bool
</span><a href="#local-6989586621682980613"><span class="hs-identifier hs-var">is_bot_alt</span></a></span><span> </span><span class="annot"><span class="annottext">Alt CoreBndr
</span><a href="#local-6989586621682980611"><span class="hs-identifier hs-var">alt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Alt CoreBndr] -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#altsWouldDup"><span class="hs-identifier hs-var">altsWouldDup</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt CoreBndr]
</span><a href="#local-6989586621682980612"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-3806"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Alt CoreBndr -&gt; Bool) -&gt; [Alt CoreBndr] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">Alt CoreBndr -&gt; Bool
</span><a href="#local-6989586621682980613"><span class="hs-identifier hs-var">is_bot_alt</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt CoreBndr]
</span><a href="#local-6989586621682980612"><span class="hs-identifier hs-var">alts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3807"></span><span>    </span><span class="hs-comment">-- otherwise case: first alt is non-bot, so all the rest must be bot</span><span>
</span><span id="line-3808"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3809"></span><span>    </span><span id="local-6989586621682980613"><span class="annot"><span class="annottext">is_bot_alt :: Alt CoreBndr -&gt; Bool
</span><a href="#local-6989586621682980613"><span class="hs-identifier hs-var hs-var">is_bot_alt</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682980614"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980614"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#exprIsDeadEnd"><span class="hs-identifier hs-var">exprIsDeadEnd</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980614"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-3810"></span><span>
</span><span id="line-3811"></span><span class="hs-comment">-------------------------</span><span>
</span><span id="line-3812"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#mkDupableCont"><span class="hs-identifier hs-type">mkDupableCont</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span>
</span><span id="line-3813"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span>
</span><span id="line-3814"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span>  </span><span class="hs-comment">-- Incoming SimplEnv augmented with</span><span>
</span><span id="line-3815"></span><span>                                       </span><span class="hs-comment">--   extra let/join-floats and in-scope variables</span><span>
</span><span id="line-3816"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- dup_cont: duplicable continuation</span><span>
</span><span id="line-3817"></span><span id="mkDupableCont"><span class="annot"><span class="annottext">mkDupableCont :: SimplEnv -&gt; SimplCont -&gt; SimplM (SimplFloats, SimplCont)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#mkDupableCont"><span class="hs-identifier hs-var hs-var">mkDupableCont</span></a></span></span><span> </span><span id="local-6989586621682980615"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980615"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980616"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980616"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-3818"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; [Demand] -&gt; SimplCont -&gt; SimplM (SimplFloats, SimplCont)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#mkDupableContWithDmds"><span class="hs-identifier hs-var">mkDupableContWithDmds</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980615"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Demand -&gt; [Demand]
forall a. a -&gt; [a]
</span><span class="hs-identifier hs-var">repeat</span></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="GHC.Types.Demand.html#topDmd"><span class="hs-identifier hs-var">topDmd</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980616"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-3819"></span><span>
</span><span id="line-3820"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#mkDupableContWithDmds"><span class="hs-identifier hs-type">mkDupableContWithDmds</span></a></span><span>
</span><span id="line-3821"></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Demands on arguments; always infinite</span><span>
</span><span id="line-3822"></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3823"></span><span>
</span><span id="line-3824"></span><span id="mkDupableContWithDmds"><span class="annot"><span class="annottext">mkDupableContWithDmds :: SimplEnv
-&gt; [Demand] -&gt; SimplCont -&gt; SimplM (SimplFloats, SimplCont)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#mkDupableContWithDmds"><span class="hs-identifier hs-var hs-var">mkDupableContWithDmds</span></a></span></span><span> </span><span id="local-6989586621682980619"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980619"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682980620"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980620"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-3825"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contIsDupable"><span class="hs-identifier hs-var">contIsDupable</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980620"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-3826"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SimplFloats, SimplCont) -&gt; SimplM (SimplFloats, SimplCont)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980619"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980620"><span class="hs-identifier hs-var">cont</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3827"></span><span>
</span><span id="line-3828"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#mkDupableContWithDmds"><span class="hs-identifier hs-var">mkDupableContWithDmds</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#Stop"><span class="hs-identifier hs-type">Stop</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SimplM (SimplFloats, SimplCont)
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;mkDupableCont&quot;</span></span><span>     </span><span class="hs-comment">-- Handled by previous eqn</span><span>
</span><span id="line-3829"></span><span>
</span><span id="line-3830"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#mkDupableContWithDmds"><span class="hs-identifier hs-var">mkDupableContWithDmds</span></a></span><span> </span><span id="local-6989586621682980623"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980623"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980624"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682980624"><span class="hs-identifier hs-var">dmds</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#CastIt"><span class="hs-identifier hs-type">CastIt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_co :: SimplCont -&gt; CoercionR
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_co"><span class="hs-identifier hs-var">sc_co</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980625"><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682980625"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_opt :: SimplCont -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_opt"><span class="hs-identifier hs-var">sc_opt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980626"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682980626"><span class="hs-identifier hs-var">opt</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980627"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980627"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3831"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980628"><span class="annot"><a href="#local-6989586621682980628"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980629"><span class="annot"><a href="#local-6989586621682980629"><span class="hs-identifier hs-var">cont'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; [Demand] -&gt; SimplCont -&gt; SimplM (SimplFloats, SimplCont)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#mkDupableContWithDmds"><span class="hs-identifier hs-var">mkDupableContWithDmds</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980623"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682980624"><span class="hs-identifier hs-var">dmds</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980627"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-3832"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682980628"><span class="hs-identifier hs-type">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#CastIt"><span class="hs-identifier hs-type">CastIt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_co"><span class="hs-identifier hs-var">sc_co</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#optOutCoercion"><span class="hs-identifier hs-type">optOutCoercion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980623"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980625"><span class="hs-identifier hs-type">co</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980626"><span class="hs-identifier hs-type">opt</span></a></span><span>
</span><span id="line-3833"></span><span>                                 </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_opt"><span class="hs-identifier hs-var">sc_opt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682980629"><span class="hs-identifier hs-type">cont'</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3834"></span><span>                 </span><span class="hs-comment">-- optOutCoercion: see Note [Avoid re-simplifying coercions]</span><span>
</span><span id="line-3835"></span><span>
</span><span id="line-3836"></span><span class="hs-comment">-- Duplicating ticks for now, not sure if this is good or not</span><span>
</span><span id="line-3837"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#mkDupableContWithDmds"><span class="hs-identifier hs-var">mkDupableContWithDmds</span></a></span><span> </span><span id="local-6989586621682980630"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980630"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980631"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682980631"><span class="hs-identifier hs-var">dmds</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#TickIt"><span class="hs-identifier hs-type">TickIt</span></a></span><span> </span><span id="local-6989586621682980632"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682980632"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621682980633"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980633"><span class="hs-identifier hs-var">cont</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-3838"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980634"><span class="annot"><a href="#local-6989586621682980634"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980635"><span class="annot"><a href="#local-6989586621682980635"><span class="hs-identifier hs-var">cont'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; [Demand] -&gt; SimplCont -&gt; SimplM (SimplFloats, SimplCont)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#mkDupableContWithDmds"><span class="hs-identifier hs-var">mkDupableContWithDmds</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980630"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682980631"><span class="hs-identifier hs-var">dmds</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980633"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-3839"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682980634"><span class="hs-identifier hs-type">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#TickIt"><span class="hs-identifier hs-type">TickIt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980632"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980635"><span class="hs-identifier hs-type">cont'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3840"></span><span>
</span><span id="line-3841"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#mkDupableContWithDmds"><span class="hs-identifier hs-var">mkDupableContWithDmds</span></a></span><span> </span><span id="local-6989586621682980636"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980636"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-3842"></span><span>     </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StrictBind"><span class="hs-identifier hs-type">StrictBind</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_bndr :: SimplCont -&gt; CoreBndr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_bndr"><span class="hs-identifier hs-var">sc_bndr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980637"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980637"><span class="hs-identifier hs-var">bndr</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_body :: SimplCont -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_body"><span class="hs-identifier hs-var">sc_body</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980638"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980638"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_from :: SimplCont -&gt; FromWhat
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_from"><span class="hs-identifier hs-var">sc_from</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980639"><span class="annot"><span class="annottext">FromWhat
</span><a href="#local-6989586621682980639"><span class="hs-identifier hs-var">from_what</span></a></span></span><span>
</span><span id="line-3843"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_env :: SimplCont -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_env"><span class="hs-identifier hs-var">sc_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980640"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980640"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980641"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980641"><span class="hs-identifier hs-var">cont</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3844"></span><span class="hs-comment">-- See Note [Duplicating StrictBind]</span><span>
</span><span id="line-3845"></span><span class="hs-comment">-- K[ let x = &lt;&gt; in b ]  --&gt;   join j x = K[ b ]</span><span>
</span><span id="line-3846"></span><span class="hs-comment">--                             j &lt;&gt;</span><span>
</span><span id="line-3847"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682980642"><span class="annot"><span class="annottext">sb_env :: SimplEnv
</span><a href="#local-6989586621682980642"><span class="hs-identifier hs-var hs-var hs-var">sb_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980640"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplEnv -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#setInScopeFromE"><span class="hs-operator hs-var">`setInScopeFromE`</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980636"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-3848"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980643"><span class="annot"><a href="#local-6989586621682980643"><span class="hs-identifier hs-var">sb_env1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980644"><span class="annot"><a href="#local-6989586621682980644"><span class="hs-identifier hs-var">bndr'</span></a></span></span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; SimplM (SimplEnv, CoreBndr)
</span><a href="GHC.Core.Opt.Simplify.Env.html#simplBinder"><span class="hs-identifier hs-var">simplBinder</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980642"><span class="hs-identifier hs-var">sb_env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980637"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-3849"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980645"><span class="annot"><a href="#local-6989586621682980645"><span class="hs-identifier hs-var">floats1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980646"><span class="annot"><a href="#local-6989586621682980646"><span class="hs-identifier hs-var">join_inner</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplNonRecBody"><span class="hs-identifier hs-type">simplNonRecBody</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980643"><span class="hs-identifier hs-type">sb_env1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980639"><span class="hs-identifier hs-type">from_what</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980638"><span class="hs-identifier hs-type">body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980641"><span class="hs-identifier hs-type">cont</span></a></span><span>
</span><span id="line-3850"></span><span>          </span><span class="hs-comment">-- No need to use mkDupableCont before simplNonRecBody; we</span><span>
</span><span id="line-3851"></span><span>          </span><span class="hs-comment">-- use cont once here, and then share the result if necessary</span><span>
</span><span id="line-3852"></span><span>
</span><span id="line-3853"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682980647"><span class="annot"><a href="#local-6989586621682980647"><span class="hs-identifier hs-var hs-var">join_body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplFloats -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Env.html#wrapFloats"><span class="hs-identifier hs-var">wrapFloats</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682980645"><span class="hs-identifier hs-var">floats1</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980646"><span class="hs-identifier hs-var">join_inner</span></a></span><span>
</span><span id="line-3854"></span><span>             </span><span id="local-6989586621682980648"><span class="annot"><a href="#local-6989586621682980648"><span class="hs-identifier hs-var hs-var">res_ty</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980641"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-3855"></span><span>
</span><span id="line-3856"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#mkDupableStrictBind"><span class="hs-identifier hs-type">mkDupableStrictBind</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980636"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980644"><span class="hs-identifier hs-type">bndr'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980647"><span class="hs-identifier hs-type">join_body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980648"><span class="hs-identifier hs-type">res_ty</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3857"></span><span>
</span><span id="line-3858"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#mkDupableContWithDmds"><span class="hs-identifier hs-var">mkDupableContWithDmds</span></a></span><span> </span><span id="local-6989586621682980650"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980650"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-3859"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StrictArg"><span class="hs-identifier hs-type">StrictArg</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_fun :: SimplCont -&gt; ArgInfo
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_fun"><span class="hs-identifier hs-var">sc_fun</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980651"><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682980651"><span class="hs-identifier hs-var">fun</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980652"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980652"><span class="hs-identifier hs-var">cont</span></a></span></span><span>
</span><span id="line-3860"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_fun_ty :: SimplCont -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_fun_ty"><span class="hs-identifier hs-var">sc_fun_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980653"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980653"><span class="hs-identifier hs-var">fun_ty</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3861"></span><span>  </span><span class="hs-comment">-- NB: sc_dup /= OkToDup; that is caught earlier by contIsDupable</span><span>
</span><span id="line-3862"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Maybe DataCon -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isNothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Maybe DataCon
</span><a href="GHC.Types.Id.html#isDataConId_maybe"><span class="hs-identifier hs-var">isDataConId_maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArgInfo -&gt; CoreBndr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_fun"><span class="hs-identifier hs-var">ai_fun</span></a></span><span> </span><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682980651"><span class="hs-identifier hs-var">fun</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3863"></span><span>         </span><span class="hs-comment">-- isDataConId: see point (DJ4) of Note [Duplicating join points]</span><span>
</span><span id="line-3864"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Bool
</span><a href="#local-6989586621682980655"><span class="hs-identifier hs-var">thumbsUpPlanA</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980652"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-3865"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- Use Plan A of Note [Duplicating StrictArg]</span><span>
</span><span id="line-3866"></span><span class="hs-comment">--    pprTrace &quot;Using plan A&quot; (ppr (ai_fun fun) $$ text &quot;args&quot; &lt;+&gt; ppr (ai_args fun) $$ text &quot;cont&quot; &lt;+&gt; ppr cont) $</span><span>
</span><span id="line-3867"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Demand
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682980656"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682980656"><span class="hs-identifier hs-var hs-var">dmds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArgInfo -&gt; [Demand]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_dmds"><span class="hs-identifier hs-var">ai_dmds</span></a></span><span> </span><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621682980651"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-3868"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980657"><span class="annot"><a href="#local-6989586621682980657"><span class="hs-identifier hs-var">floats1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980658"><span class="annot"><a href="#local-6989586621682980658"><span class="hs-identifier hs-var">cont'</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; [Demand] -&gt; SimplCont -&gt; SimplM (SimplFloats, SimplCont)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#mkDupableContWithDmds"><span class="hs-identifier hs-var">mkDupableContWithDmds</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980650"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682980656"><span class="hs-identifier hs-var">dmds</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980652"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-3869"></span><span>                              </span><span class="hs-comment">-- Use the demands from the function to add the right</span><span>
</span><span id="line-3870"></span><span>                              </span><span class="hs-comment">-- demand info on any bindings we make for further args</span><span>
</span><span id="line-3871"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980659"><span class="annot"><a href="#local-6989586621682980659"><span class="hs-identifier hs-var">floats_s</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980660"><span class="annot"><a href="#local-6989586621682980660"><span class="hs-identifier hs-var">args'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mapAndUnzipM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#makeTrivialArg"><span class="hs-identifier hs-type">makeTrivialArg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980650"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3872"></span><span>                                           </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ai_args"><span class="hs-identifier hs-var">ai_args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980651"><span class="hs-identifier hs-type">fun</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3873"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">foldl'</span></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#addLetFloats"><span class="hs-identifier hs-type">addLetFloats</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980657"><span class="hs-identifier hs-type">floats1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980659"><span class="hs-identifier hs-type">floats_s</span></a></span><span>
</span><span id="line-3874"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StrictArg"><span class="hs-identifier hs-type">StrictArg</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_fun"><span class="hs-identifier hs-var">sc_fun</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682980651"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ai_args"><span class="hs-identifier hs-var">ai_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682980660"><span class="hs-identifier hs-type">args'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3875"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682980658"><span class="hs-identifier hs-type">cont'</span></a></span><span>
</span><span id="line-3876"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_fun_ty"><span class="hs-identifier hs-var">sc_fun_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682980653"><span class="hs-identifier hs-type">fun_ty</span></a></span><span>
</span><span id="line-3877"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_dup"><span class="hs-identifier hs-var">sc_dup</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#OkToDup"><span class="hs-identifier hs-type">OkToDup</span></a></span><span class="hs-special">}</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3878"></span><span>
</span><span id="line-3879"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3880"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- Use Plan B of Note [Duplicating StrictArg]</span><span>
</span><span id="line-3881"></span><span>    </span><span class="hs-comment">--   K[ f a b &lt;&gt; ]   --&gt;   join j x = K[ f a b x ]</span><span>
</span><span id="line-3882"></span><span>    </span><span class="hs-comment">--                         j &lt;&gt;</span><span>
</span><span id="line-3883"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682980663"><span class="annot"><span class="annottext">rhs_ty :: Kind
</span><a href="#local-6989586621682980663"><span class="hs-identifier hs-var hs-var hs-var">rhs_ty</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980652"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-3884"></span><span>             </span><span class="hs-special">(</span><span id="local-6989586621682980664"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980664"><span class="hs-identifier hs-var hs-var">m</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682980665"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980665"><span class="hs-identifier hs-var hs-var">arg_ty</span></a></span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Kind
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Kind -&gt; (Kind, Kind, Kind)
</span><a href="GHC.Core.Type.html#splitFunTy"><span class="hs-identifier hs-var">splitFunTy</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980653"><span class="hs-identifier hs-var">fun_ty</span></a></span><span>
</span><span id="line-3885"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682980666"><span class="annot"><a href="#local-6989586621682980666"><span class="hs-identifier hs-var">arg_bndr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FastString -&gt; Kind -&gt; Kind -&gt; SimplM CoreBndr
</span><a href="GHC.Core.Opt.Simplify.Monad.html#newId"><span class="hs-identifier hs-var">newId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; FastString
</span><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;arg&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980664"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980665"><span class="hs-identifier hs-var">arg_ty</span></a></span><span>
</span><span id="line-3886"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682980667"><span class="annot"><a href="#local-6989586621682980667"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980650"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; [CoreBndr] -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#addNewInScopeIds"><span class="hs-operator hs-var">`addNewInScopeIds`</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980666"><span class="hs-identifier hs-var">arg_bndr</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-3887"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980668"><span class="annot"><a href="#local-6989586621682980668"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980669"><span class="annot"><a href="#local-6989586621682980669"><span class="hs-identifier hs-var">join_rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#rebuildCall"><span class="hs-identifier hs-type">rebuildCall</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980667"><span class="hs-identifier hs-type">env'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#addValArgTo"><span class="hs-identifier hs-type">addValArgTo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980651"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980666"><span class="hs-identifier hs-type">arg_bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682980653"><span class="hs-identifier hs-type">fun_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682980652"><span class="hs-identifier hs-type">cont</span></a></span><span>
</span><span id="line-3888"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#mkDupableStrictBind"><span class="hs-identifier hs-type">mkDupableStrictBind</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980667"><span class="hs-identifier hs-type">env'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980666"><span class="hs-identifier hs-type">arg_bndr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#wrapFloats"><span class="hs-identifier hs-type">wrapFloats</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980668"><span class="hs-identifier hs-type">floats</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980669"><span class="hs-identifier hs-type">join_rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682980663"><span class="hs-identifier hs-type">rhs_ty</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3889"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3890"></span><span>    </span><span id="local-6989586621682980655"><span class="annot"><span class="annottext">thumbsUpPlanA :: SimplCont -&gt; Bool
</span><a href="#local-6989586621682980655"><span class="hs-identifier hs-var hs-var">thumbsUpPlanA</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StrictArg"><span class="hs-identifier hs-type">StrictArg</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-3891"></span><span>    </span><span class="annot"><a href="#local-6989586621682980655"><span class="hs-identifier hs-var">thumbsUpPlanA</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StrictBind"><span class="hs-identifier hs-type">StrictBind</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-3892"></span><span>    </span><span class="annot"><a href="#local-6989586621682980655"><span class="hs-identifier hs-var">thumbsUpPlanA</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#Stop"><span class="hs-identifier hs-type">Stop</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>                    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-3893"></span><span>    </span><span class="annot"><a href="#local-6989586621682980655"><span class="hs-identifier hs-var">thumbsUpPlanA</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#Select"><span class="hs-identifier hs-type">Select</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-3894"></span><span>    </span><span class="annot"><a href="#local-6989586621682980655"><span class="hs-identifier hs-var">thumbsUpPlanA</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#CastIt"><span class="hs-identifier hs-type">CastIt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980670"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980670"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Bool
</span><a href="#local-6989586621682980655"><span class="hs-identifier hs-var">thumbsUpPlanA</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980670"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-3895"></span><span>    </span><span class="annot"><a href="#local-6989586621682980655"><span class="hs-identifier hs-var">thumbsUpPlanA</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#TickIt"><span class="hs-identifier hs-type">TickIt</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682980671"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980671"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">)</span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Bool
</span><a href="#local-6989586621682980655"><span class="hs-identifier hs-var">thumbsUpPlanA</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980671"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-3896"></span><span>    </span><span class="annot"><a href="#local-6989586621682980655"><span class="hs-identifier hs-var">thumbsUpPlanA</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToVal"><span class="hs-identifier hs-type">ApplyToVal</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980672"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980672"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Bool
</span><a href="#local-6989586621682980655"><span class="hs-identifier hs-var">thumbsUpPlanA</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980672"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-3897"></span><span>    </span><span class="annot"><a href="#local-6989586621682980655"><span class="hs-identifier hs-var">thumbsUpPlanA</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToTy"><span class="hs-identifier hs-type">ApplyToTy</span></a></span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980673"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980673"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Bool
</span><a href="#local-6989586621682980655"><span class="hs-identifier hs-var">thumbsUpPlanA</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980673"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-3898"></span><span>
</span><span id="line-3899"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#mkDupableContWithDmds"><span class="hs-identifier hs-var">mkDupableContWithDmds</span></a></span><span> </span><span id="local-6989586621682980674"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980674"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980675"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682980675"><span class="hs-identifier hs-var">dmds</span></a></span></span><span>
</span><span id="line-3900"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToTy"><span class="hs-identifier hs-type">ApplyToTy</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980676"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980676"><span class="hs-identifier hs-var">cont</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_arg_ty :: SimplCont -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_arg_ty"><span class="hs-identifier hs-var">sc_arg_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980677"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980677"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_hole_ty :: SimplCont -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_hole_ty"><span class="hs-identifier hs-var">sc_hole_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980678"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980678"><span class="hs-identifier hs-var">hole_ty</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3901"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980679"><span class="annot"><a href="#local-6989586621682980679"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980680"><span class="annot"><a href="#local-6989586621682980680"><span class="hs-identifier hs-var">cont'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; [Demand] -&gt; SimplCont -&gt; SimplM (SimplFloats, SimplCont)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#mkDupableContWithDmds"><span class="hs-identifier hs-var">mkDupableContWithDmds</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980674"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682980675"><span class="hs-identifier hs-var">dmds</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980676"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-3902"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682980679"><span class="hs-identifier hs-type">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToTy"><span class="hs-identifier hs-type">ApplyToTy</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682980680"><span class="hs-identifier hs-type">cont'</span></a></span><span>
</span><span id="line-3903"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_arg_ty"><span class="hs-identifier hs-var">sc_arg_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682980677"><span class="hs-identifier hs-type">arg_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_hole_ty"><span class="hs-identifier hs-var">sc_hole_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682980678"><span class="hs-identifier hs-type">hole_ty</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3904"></span><span>
</span><span id="line-3905"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#mkDupableContWithDmds"><span class="hs-identifier hs-var">mkDupableContWithDmds</span></a></span><span> </span><span id="local-6989586621682980681"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980681"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980682"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682980682"><span class="hs-identifier hs-var">dmds</span></a></span></span><span>
</span><span id="line-3906"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToVal"><span class="hs-identifier hs-type">ApplyToVal</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_arg :: SimplCont -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_arg"><span class="hs-identifier hs-var">sc_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980683"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980683"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_dup :: SimplCont -&gt; DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_dup"><span class="hs-identifier hs-var">sc_dup</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980684"><span class="annot"><span class="annottext">DupFlag
</span><a href="#local-6989586621682980684"><span class="hs-identifier hs-var">dup</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_env :: SimplCont -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_env"><span class="hs-identifier hs-var">sc_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980685"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980685"><span class="hs-identifier hs-var">se</span></a></span></span><span>
</span><span id="line-3907"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980686"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980686"><span class="hs-identifier hs-var">cont</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_hole_ty :: SimplCont -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_hole_ty"><span class="hs-identifier hs-var">sc_hole_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980687"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980687"><span class="hs-identifier hs-var">hole_ty</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3908"></span><span>  </span><span class="hs-glyph">=</span><span>     </span><span class="hs-comment">-- e.g.         [...hole...] (...arg...)</span><span>
</span><span id="line-3909"></span><span>        </span><span class="hs-comment">--      ==&gt;</span><span>
</span><span id="line-3910"></span><span>        </span><span class="hs-comment">--              let a = ...arg...</span><span>
</span><span id="line-3911"></span><span>        </span><span class="hs-comment">--              in [...hole...] a</span><span>
</span><span id="line-3912"></span><span>        </span><span class="hs-comment">-- NB: sc_dup /= OkToDup; that is caught earlier by contIsDupable</span><span>
</span><span id="line-3913"></span><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980688"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682980688"><span class="hs-identifier hs-var hs-var">dmd</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682980689"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682980689"><span class="hs-identifier hs-var hs-var">cont_dmds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682980682"><span class="hs-identifier hs-var">dmds</span></a></span><span>   </span><span class="hs-comment">-- Never fails</span><span>
</span><span id="line-3914"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980690"><span class="annot"><a href="#local-6989586621682980690"><span class="hs-identifier hs-var">floats1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980691"><span class="annot"><a href="#local-6989586621682980691"><span class="hs-identifier hs-var">cont'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; [Demand] -&gt; SimplCont -&gt; SimplM (SimplFloats, SimplCont)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#mkDupableContWithDmds"><span class="hs-identifier hs-var">mkDupableContWithDmds</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980681"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682980689"><span class="hs-identifier hs-var">cont_dmds</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980686"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-3915"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682980692"><span class="annot"><a href="#local-6989586621682980692"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980681"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplFloats -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#setInScopeFromF"><span class="hs-operator hs-var">`setInScopeFromF`</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682980690"><span class="hs-identifier hs-var">floats1</span></a></span><span>
</span><span id="line-3916"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980693"><span class="annot"><a href="#local-6989586621682980693"><span class="hs-identifier hs-var">se'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980694"><span class="annot"><a href="#local-6989586621682980694"><span class="hs-identifier hs-var">arg'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplLazyArg"><span class="hs-identifier hs-type">simplLazyArg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980692"><span class="hs-identifier hs-type">env'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980684"><span class="hs-identifier hs-type">dup</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980687"><span class="hs-identifier hs-type">hole_ty</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="annot"><a href="#local-6989586621682980685"><span class="hs-identifier hs-type">se</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980683"><span class="hs-identifier hs-type">arg</span></a></span><span>
</span><span id="line-3917"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980695"><span class="annot"><a href="#local-6989586621682980695"><span class="hs-identifier hs-var">let_floats2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980696"><span class="annot"><a href="#local-6989586621682980696"><span class="hs-identifier hs-var">arg''</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#makeTrivial"><span class="hs-identifier hs-type">makeTrivial</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980681"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#NotTopLevel"><span class="hs-identifier hs-type">NotTopLevel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980688"><span class="hs-identifier hs-type">dmd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier hs-type">fsLit</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;karg&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682980694"><span class="hs-identifier hs-type">arg'</span></a></span><span>
</span><span id="line-3918"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682980697"><span class="annot"><a href="#local-6989586621682980697"><span class="hs-identifier hs-var hs-var">all_floats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682980690"><span class="hs-identifier hs-var">floats1</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats -&gt; LetFloats -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#addLetFloats"><span class="hs-operator hs-var">`addLetFloats`</span></a></span><span> </span><span class="annot"><span class="annottext">LetFloats
</span><a href="#local-6989586621682980695"><span class="hs-identifier hs-var">let_floats2</span></a></span><span>
</span><span id="line-3919"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="#local-6989586621682980697"><span class="hs-identifier hs-type">all_floats</span></a></span><span>
</span><span id="line-3920"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ApplyToVal"><span class="hs-identifier hs-type">ApplyToVal</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_arg"><span class="hs-identifier hs-var">sc_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682980696"><span class="hs-identifier hs-type">arg''</span></a></span><span>
</span><span id="line-3921"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_env"><span class="hs-identifier hs-var">sc_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682980693"><span class="hs-identifier hs-type">se'</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#setInScopeFromF"><span class="hs-operator hs-type">`setInScopeFromF`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980697"><span class="hs-identifier hs-type">all_floats</span></a></span><span>
</span><span id="line-3922"></span><span>                                         </span><span class="hs-comment">-- Ensure that sc_env includes the free vars of</span><span>
</span><span id="line-3923"></span><span>                                         </span><span class="hs-comment">-- arg'' in its in-scope set, even if makeTrivial</span><span>
</span><span id="line-3924"></span><span>                                         </span><span class="hs-comment">-- has turned arg'' into a fresh variable</span><span>
</span><span id="line-3925"></span><span>                                         </span><span class="hs-comment">-- See Note [StaticEnv invariant] in GHC.Core.Opt.Simplify.Utils</span><span>
</span><span id="line-3926"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_dup"><span class="hs-identifier hs-var">sc_dup</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#OkToDup"><span class="hs-identifier hs-type">OkToDup</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682980691"><span class="hs-identifier hs-type">cont'</span></a></span><span>
</span><span id="line-3927"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_hole_ty"><span class="hs-identifier hs-var">sc_hole_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682980687"><span class="hs-identifier hs-type">hole_ty</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3928"></span><span>
</span><span id="line-3929"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#mkDupableContWithDmds"><span class="hs-identifier hs-var">mkDupableContWithDmds</span></a></span><span> </span><span id="local-6989586621682980698"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980698"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-3930"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#Select"><span class="hs-identifier hs-type">Select</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_bndr :: SimplCont -&gt; CoreBndr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_bndr"><span class="hs-identifier hs-var">sc_bndr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980699"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980699"><span class="hs-identifier hs-var">case_bndr</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_alts :: SimplCont -&gt; [Alt CoreBndr]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_alts"><span class="hs-identifier hs-var">sc_alts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980700"><span class="annot"><span class="annottext">[Alt CoreBndr]
</span><a href="#local-6989586621682980700"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_env :: SimplCont -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_env"><span class="hs-identifier hs-var">sc_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980701"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980701"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980702"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980702"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3931"></span><span>  </span><span class="hs-glyph">=</span><span>     </span><span class="hs-comment">-- e.g.         (case [...hole...] of { pi -&gt; ei })</span><span>
</span><span id="line-3932"></span><span>        </span><span class="hs-comment">--      ===&gt;</span><span>
</span><span id="line-3933"></span><span>        </span><span class="hs-comment">--              let ji = \xij -&gt; ei</span><span>
</span><span id="line-3934"></span><span>        </span><span class="hs-comment">--              in case [...hole...] of { pi -&gt; ji xij }</span><span>
</span><span id="line-3935"></span><span>        </span><span class="hs-comment">-- NB: sc_dup /= OkToDup; that is caught earlier by contIsDupable</span><span>
</span><span id="line-3936"></span><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Tick -&gt; SimplM ()
</span><a href="GHC.Core.Opt.Simplify.Monad.html#tick"><span class="hs-identifier hs-var">tick</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Tick
</span><a href="GHC.Core.Opt.Stats.html#CaseOfCase"><span class="hs-identifier hs-var">CaseOfCase</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980699"><span class="hs-identifier hs-var">case_bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3937"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980704"><span class="annot"><a href="#local-6989586621682980704"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980705"><span class="annot"><a href="#local-6989586621682980705"><span class="hs-identifier hs-var">alt_env</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980706"><span class="annot"><a href="#local-6989586621682980706"><span class="hs-identifier hs-var">alt_cont</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; [Alt CoreBndr]
-&gt; SimplCont
-&gt; SimplM (SimplFloats, SimplEnv, SimplCont)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#mkDupableCaseCont"><span class="hs-identifier hs-var">mkDupableCaseCont</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980701"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplEnv -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#setInScopeFromE"><span class="hs-operator hs-var">`setInScopeFromE`</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980698"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Alt CoreBndr]
</span><a href="#local-6989586621682980700"><span class="hs-identifier hs-var">alts</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980702"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-3938"></span><span>                </span><span class="hs-comment">-- NB: We call mkDupableCaseCont here to make cont duplicable</span><span>
</span><span id="line-3939"></span><span>                </span><span class="hs-comment">--     (if necessary, depending on the number of alts)</span><span>
</span><span id="line-3940"></span><span>                </span><span class="hs-comment">-- And this is important: see Note [Fusing case continuations]</span><span>
</span><span id="line-3941"></span><span>
</span><span id="line-3942"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682980707"><span class="annot"><a href="#local-6989586621682980707"><span class="hs-identifier hs-var hs-var">cont_scaling</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplCont -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Utils.html#contHoleScaling"><span class="hs-identifier hs-var">contHoleScaling</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980702"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-3943"></span><span>          </span><span class="hs-comment">-- See Note [Scaling in case-of-case]</span><span>
</span><span id="line-3944"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980708"><span class="annot"><a href="#local-6989586621682980708"><span class="hs-identifier hs-var">alt_env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980709"><span class="annot"><a href="#local-6989586621682980709"><span class="hs-identifier hs-var">case_bndr'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#simplBinder"><span class="hs-identifier hs-type">simplBinder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980705"><span class="hs-identifier hs-type">alt_env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Id.html#scaleIdBy"><span class="hs-identifier hs-type">scaleIdBy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980707"><span class="hs-identifier hs-type">cont_scaling</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980699"><span class="hs-identifier hs-type">case_bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3945"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682980710"><span class="annot"><a href="#local-6989586621682980710"><span class="hs-identifier hs-var">alts'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Utils.html#scaleAltsBy"><span class="hs-identifier hs-type">scaleAltsBy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980707"><span class="hs-identifier hs-type">cont_scaling</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980700"><span class="hs-identifier hs-type">alts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-3946"></span><span>            </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplAlt"><span class="hs-identifier hs-type">simplAlt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980708"><span class="hs-identifier hs-type">alt_env'</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><a href="#local-6989586621682980709"><span class="hs-identifier hs-type">case_bndr'</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#NoBinderSwap"><span class="hs-identifier hs-type">NoBinderSwap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980706"><span class="hs-identifier hs-type">alt_cont</span></a></span><span>
</span><span id="line-3947"></span><span>                </span><span class="hs-comment">-- Safe to say that there are no handled-cons for the DEFAULT case</span><span>
</span><span id="line-3948"></span><span>                </span><span class="hs-comment">-- NB: simplBinder does not zap deadness occ-info, so</span><span>
</span><span id="line-3949"></span><span>                </span><span class="hs-comment">-- a dead case_bndr' will still advertise its deadness</span><span>
</span><span id="line-3950"></span><span>                </span><span class="hs-comment">-- This is really important because in</span><span>
</span><span id="line-3951"></span><span>                </span><span class="hs-comment">--      case e of b { (# p,q #) -&gt; ... }</span><span>
</span><span id="line-3952"></span><span>                </span><span class="hs-comment">-- b is always dead, and indeed we are not allowed to bind b to (# p,q #),</span><span>
</span><span id="line-3953"></span><span>                </span><span class="hs-comment">-- which might happen if e was an explicit unboxed pair and b wasn't marked dead.</span><span>
</span><span id="line-3954"></span><span>                </span><span class="hs-comment">-- In the new alts we build, we have the new case binder, so it must retain</span><span>
</span><span id="line-3955"></span><span>                </span><span class="hs-comment">-- its deadness.</span><span>
</span><span id="line-3956"></span><span>        </span><span class="hs-comment">-- NB: we don't use alt_env further; it has the substEnv for</span><span>
</span><span id="line-3957"></span><span>        </span><span class="hs-comment">--     the alternatives, and we don't want that</span><span>
</span><span id="line-3958"></span><span>
</span><span id="line-3959"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980712"><span class="annot"><a href="#local-6989586621682980712"><span class="hs-identifier hs-var">join_floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980713"><span class="annot"><a href="#local-6989586621682980713"><span class="hs-identifier hs-var">alts''</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Utils.Monad.html#mapAccumLM"><span class="hs-identifier hs-type">mapAccumLM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#mkDupableAlt"><span class="hs-identifier hs-type">mkDupableAlt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980698"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980709"><span class="hs-identifier hs-type">case_bndr'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3960"></span><span>                                              </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#emptyJoinFloats"><span class="hs-identifier hs-type">emptyJoinFloats</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980710"><span class="hs-identifier hs-type">alts'</span></a></span><span>
</span><span id="line-3961"></span><span>
</span><span id="line-3962"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682980716"><span class="annot"><a href="#local-6989586621682980716"><span class="hs-identifier hs-var hs-var">all_floats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621682980704"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats -&gt; JoinFloats -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#addJoinFloats"><span class="hs-operator hs-var">`addJoinFloats`</span></a></span><span> </span><span class="annot"><span class="annottext">JoinFloats
</span><a href="#local-6989586621682980712"><span class="hs-identifier hs-var">join_floats</span></a></span><span>
</span><span id="line-3963"></span><span>                           </span><span class="hs-comment">-- Note [Duplicated env]</span><span>
</span><span id="line-3964"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682980716"><span class="hs-identifier hs-type">all_floats</span></a></span><span>
</span><span id="line-3965"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#Select"><span class="hs-identifier hs-type">Select</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_dup"><span class="hs-identifier hs-var">sc_dup</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#OkToDup"><span class="hs-identifier hs-type">OkToDup</span></a></span><span>
</span><span id="line-3966"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_bndr"><span class="hs-identifier hs-var">sc_bndr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682980709"><span class="hs-identifier hs-type">case_bndr'</span></a></span><span>
</span><span id="line-3967"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_alts"><span class="hs-identifier hs-var">sc_alts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682980713"><span class="hs-identifier hs-type">alts''</span></a></span><span>
</span><span id="line-3968"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_env"><span class="hs-identifier hs-var">sc_env</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#zapSubstEnv"><span class="hs-identifier hs-type">zapSubstEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980701"><span class="hs-identifier hs-type">se</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#setInScopeFromF"><span class="hs-operator hs-type">`setInScopeFromF`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980716"><span class="hs-identifier hs-type">all_floats</span></a></span><span>
</span><span id="line-3969"></span><span>                                      </span><span class="hs-comment">-- See Note [StaticEnv invariant] in GHC.Core.Opt.Simplify.Utils</span><span>
</span><span id="line-3970"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#mkBoringStop"><span class="hs-identifier hs-type">mkBoringStop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#contResultType"><span class="hs-identifier hs-type">contResultType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980702"><span class="hs-identifier hs-type">cont</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3971"></span><span>
</span><span id="line-3972"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#mkDupableStrictBind"><span class="hs-identifier hs-type">mkDupableStrictBind</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutType"><span class="hs-identifier hs-type">OutType</span></a></span><span>
</span><span id="line-3973"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3974"></span><span id="mkDupableStrictBind"><span class="annot"><span class="annottext">mkDupableStrictBind :: SimplEnv
-&gt; CoreBndr -&gt; CoreExpr -&gt; Kind -&gt; SimplM (SimplFloats, SimplCont)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#mkDupableStrictBind"><span class="hs-identifier hs-var hs-var">mkDupableStrictBind</span></a></span></span><span> </span><span id="local-6989586621682980718"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980718"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980719"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980719"><span class="hs-identifier hs-var">arg_bndr</span></a></span></span><span> </span><span id="local-6989586621682980720"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980720"><span class="hs-identifier hs-var">join_rhs</span></a></span></span><span> </span><span id="local-6989586621682980721"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980721"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span>
</span><span id="line-3975"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[CoreBndr] -&gt; CoreExpr -&gt; Bool
</span><a href="GHC.Core.Unfold.html#uncondInlineJoin"><span class="hs-identifier hs-var">uncondInlineJoin</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980719"><span class="hs-identifier hs-var">arg_bndr</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980720"><span class="hs-identifier hs-var">join_rhs</span></a></span><span>
</span><span id="line-3976"></span><span>     </span><span class="hs-comment">-- See point (DJ2) of Note [Duplicating join points]</span><span>
</span><span id="line-3977"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SimplFloats, SimplCont) -&gt; SimplM (SimplFloats, SimplCont)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplFloats
</span><a href="GHC.Core.Opt.Simplify.Env.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980718"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-3978"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StrictBind"><span class="hs-identifier hs-type">StrictBind</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_bndr :: CoreBndr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_bndr"><span class="hs-identifier hs-var">sc_bndr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980719"><span class="hs-identifier hs-var">arg_bndr</span></a></span><span>
</span><span id="line-3979"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_body :: CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_body"><span class="hs-identifier hs-var">sc_body</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980720"><span class="hs-identifier hs-var">join_rhs</span></a></span><span>
</span><span id="line-3980"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_env :: SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_env"><span class="hs-identifier hs-var">sc_env</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#zapSubstEnv"><span class="hs-identifier hs-var">zapSubstEnv</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980718"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-3981"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_from :: FromWhat
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_from"><span class="hs-identifier hs-var">sc_from</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FromWhat
</span><a href="GHC.Core.Opt.Simplify.Utils.html#FromLet"><span class="hs-identifier hs-var">FromLet</span></a></span><span>
</span><span id="line-3982"></span><span>                          </span><span class="hs-comment">-- See Note [StaticEnv invariant] in GHC.Core.Opt.Simplify.Utils</span><span>
</span><span id="line-3983"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_dup :: DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_dup"><span class="hs-identifier hs-var">sc_dup</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DupFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#OkToDup"><span class="hs-identifier hs-var">OkToDup</span></a></span><span>
</span><span id="line-3984"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sc_cont :: SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Kind -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#mkBoringStop"><span class="hs-identifier hs-var">mkBoringStop</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980721"><span class="hs-identifier hs-var">res_ty</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-3985"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3986"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682980723"><span class="annot"><a href="#local-6989586621682980723"><span class="hs-identifier hs-var">join_bndr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[CoreBndr] -&gt; Kind -&gt; SimplM CoreBndr
</span><a href="GHC.Core.Opt.Simplify.Monad.html#newJoinId"><span class="hs-identifier hs-var">newJoinId</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980719"><span class="hs-identifier hs-var">arg_bndr</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980721"><span class="hs-identifier hs-var">res_ty</span></a></span><span>
</span><span id="line-3987"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682980725"><span class="annot"><a href="#local-6989586621682980725"><span class="hs-identifier hs-var hs-var">arg_info</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ai_fun :: CoreBndr
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_fun"><span class="hs-identifier hs-var">ai_fun</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980723"><span class="hs-identifier hs-var">join_bndr</span></a></span><span>
</span><span id="line-3988"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ai_rewrite :: RewriteCall
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_rewrite"><span class="hs-identifier hs-var">ai_rewrite</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RewriteCall
</span><a href="GHC.Core.Opt.Simplify.Utils.html#TryNothing"><span class="hs-identifier hs-var">TryNothing</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ai_args :: [ArgSpec]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_args"><span class="hs-identifier hs-var">ai_args</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-3989"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ai_encl :: Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_encl"><span class="hs-identifier hs-var">ai_encl</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ai_dmds :: [Demand]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_dmds"><span class="hs-identifier hs-var">ai_dmds</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Demand -&gt; [Demand]
forall a. a -&gt; [a]
</span><span class="hs-identifier hs-var">repeat</span></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="GHC.Types.Demand.html#topDmd"><span class="hs-identifier hs-var">topDmd</span></a></span><span>
</span><span id="line-3990"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ai_discs :: [Int]
</span><a href="GHC.Core.Opt.Simplify.Utils.html#ai_discs"><span class="hs-identifier hs-var">ai_discs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Int]
forall a. a -&gt; [a]
</span><span class="hs-identifier hs-var">repeat</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3991"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#addJoinFloats"><span class="hs-identifier hs-type">addJoinFloats</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#emptyFloats"><span class="hs-identifier hs-type">emptyFloats</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980718"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-3992"></span><span>                  </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#unitJoinFloat"><span class="hs-identifier hs-type">unitJoinFloat</span></a></span><span>                   </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-3993"></span><span>                  </span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980723"><span class="hs-identifier hs-type">join_bndr</span></a></span><span>                </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-3994"></span><span>                  </span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Id.html#setOneShotLambda"><span class="hs-identifier hs-type">setOneShotLambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980719"><span class="hs-identifier hs-type">arg_bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682980720"><span class="hs-identifier hs-type">join_rhs</span></a></span><span>
</span><span id="line-3995"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#StrictArg"><span class="hs-identifier hs-type">StrictArg</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_dup"><span class="hs-identifier hs-var">sc_dup</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#OkToDup"><span class="hs-identifier hs-type">OkToDup</span></a></span><span>
</span><span id="line-3996"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_fun"><span class="hs-identifier hs-var">sc_fun</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682980725"><span class="hs-identifier hs-type">arg_info</span></a></span><span>
</span><span id="line-3997"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_fun_ty"><span class="hs-identifier hs-var">sc_fun_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-type">idType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980723"><span class="hs-identifier hs-type">join_bndr</span></a></span><span>
</span><span id="line-3998"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#sc_cont"><span class="hs-identifier hs-var">sc_cont</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#mkBoringStop"><span class="hs-identifier hs-type">mkBoringStop</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980721"><span class="hs-identifier hs-type">res_ty</span></a></span><span>
</span><span id="line-3999"></span><span>                            </span><span class="hs-special">}</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-4000"></span><span>
</span><span id="line-4001"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#mkDupableAlt"><span class="hs-identifier hs-type">mkDupableAlt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span>
</span><span id="line-4002"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#JoinFloats"><span class="hs-identifier hs-type">JoinFloats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutAlt"><span class="hs-identifier hs-type">OutAlt</span></a></span><span>
</span><span id="line-4003"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#JoinFloats"><span class="hs-identifier hs-type">JoinFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutAlt"><span class="hs-identifier hs-type">OutAlt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4004"></span><span id="mkDupableAlt"><span class="annot"><span class="annottext">mkDupableAlt :: SimplEnv
-&gt; CoreBndr
-&gt; JoinFloats
-&gt; Alt CoreBndr
-&gt; SimplM (JoinFloats, Alt CoreBndr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#mkDupableAlt"><span class="hs-identifier hs-var hs-var">mkDupableAlt</span></a></span></span><span> </span><span id="local-6989586621682980730"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980730"><span class="hs-identifier hs-var">_env</span></a></span></span><span> </span><span id="local-6989586621682980731"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980731"><span class="hs-identifier hs-var">case_bndr</span></a></span></span><span> </span><span id="local-6989586621682980732"><span class="annot"><span class="annottext">JoinFloats
</span><a href="#local-6989586621682980732"><span class="hs-identifier hs-var">jfloats</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span id="local-6989586621682980733"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682980733"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span id="local-6989586621682980734"><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980734"><span class="hs-identifier hs-var">alt_bndrs</span></a></span></span><span> </span><span id="local-6989586621682980735"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980735"><span class="hs-identifier hs-var">alt_rhs_in</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-4005"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[CoreBndr] -&gt; CoreExpr -&gt; Bool
</span><a href="GHC.Core.Unfold.html#uncondInlineJoin"><span class="hs-identifier hs-var">uncondInlineJoin</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980734"><span class="hs-identifier hs-var">alt_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980735"><span class="hs-identifier hs-var">alt_rhs_in</span></a></span><span>
</span><span id="line-4006"></span><span>    </span><span class="hs-comment">-- See point (DJ2) of Note [Duplicating join points]</span><span>
</span><span id="line-4007"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(JoinFloats, Alt CoreBndr) -&gt; SimplM (JoinFloats, Alt CoreBndr)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JoinFloats
</span><a href="#local-6989586621682980732"><span class="hs-identifier hs-var">jfloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AltCon -&gt; [CoreBndr] -&gt; CoreExpr -&gt; Alt CoreBndr
forall b. AltCon -&gt; [b] -&gt; Expr b -&gt; Alt b
</span><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-var">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682980733"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980734"><span class="hs-identifier hs-var">alt_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980735"><span class="hs-identifier hs-var">alt_rhs_in</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4008"></span><span>
</span><span id="line-4009"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-4010"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682980736"><span class="annot"><span class="annottext">rhs_ty' :: Kind
</span><a href="#local-6989586621682980736"><span class="hs-identifier hs-var hs-var hs-var">rhs_ty'</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; Kind
CoreExpr -&gt; Kind
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980735"><span class="hs-identifier hs-var">alt_rhs_in</span></a></span><span>
</span><span id="line-4011"></span><span>
</span><span id="line-4012"></span><span>              </span><span id="local-6989586621682980737"><span class="annot"><span class="annottext">bangs :: [StrictnessMark]
</span><a href="#local-6989586621682980737"><span class="hs-identifier hs-var hs-var hs-var">bangs</span></a></span></span><span>
</span><span id="line-4013"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.html#DataAlt"><span class="hs-identifier hs-type">DataAlt</span></a></span><span> </span><span id="local-6989586621682980738"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682980738"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682980733"><span class="hs-identifier hs-var">con</span></a></span><span>
</span><span id="line-4014"></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; [StrictnessMark]
</span><a href="GHC.Core.DataCon.html#dataConRepStrictness"><span class="hs-identifier hs-var">dataConRepStrictness</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682980738"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-4015"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-4016"></span><span>
</span><span id="line-4017"></span><span>              </span><span id="local-6989586621682980739"><span class="annot"><span class="annottext">abstracted_binders :: [(CoreBndr, StrictnessMark)]
</span><a href="#local-6989586621682980739"><span class="hs-identifier hs-var hs-var hs-var">abstracted_binders</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CoreBndr] -&gt; [StrictnessMark] -&gt; [(CoreBndr, StrictnessMark)]
</span><a href="#local-6989586621682980740"><span class="hs-identifier hs-var">abstract_binders</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980734"><span class="hs-identifier hs-var">alt_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">[StrictnessMark]
</span><a href="#local-6989586621682980737"><span class="hs-identifier hs-var">bangs</span></a></span><span>
</span><span id="line-4018"></span><span>
</span><span id="line-4019"></span><span>              </span><span class="annot"><a href="#local-6989586621682980740"><span class="hs-identifier hs-type">abstract_binders</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.DataCon.html#StrictnessMark"><span class="hs-identifier hs-type">StrictnessMark</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.DataCon.html#StrictnessMark"><span class="hs-identifier hs-type">StrictnessMark</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-4020"></span><span>              </span><span id="local-6989586621682980740"><span class="annot"><span class="annottext">abstract_binders :: [CoreBndr] -&gt; [StrictnessMark] -&gt; [(CoreBndr, StrictnessMark)]
</span><a href="#local-6989586621682980740"><span class="hs-identifier hs-var hs-var hs-var">abstract_binders</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-4021"></span><span>                </span><span class="hs-comment">-- Abstract over the case binder too if it's used.</span><span>
</span><span id="line-4022"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Id.html#isDeadBinder"><span class="hs-identifier hs-var">isDeadBinder</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980731"><span class="hs-identifier hs-var">case_bndr</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-4023"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980731"><span class="hs-identifier hs-var">case_bndr</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="GHC.Core.DataCon.html#MarkedStrict"><span class="hs-identifier hs-var">MarkedStrict</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-4024"></span><span>              </span><span class="annot"><a href="#local-6989586621682980740"><span class="hs-identifier hs-var">abstract_binders</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980742"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980742"><span class="hs-identifier hs-var">alt_bndr</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682980743"><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980743"><span class="hs-identifier hs-var">alt_bndrs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682980744"><span class="annot"><span class="annottext">[StrictnessMark]
</span><a href="#local-6989586621682980744"><span class="hs-identifier hs-var">marks</span></a></span></span><span>
</span><span id="line-4025"></span><span>                </span><span class="hs-comment">-- Abstract over all type variables just in case</span><span>
</span><span id="line-4026"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980742"><span class="hs-identifier hs-var">alt_bndr</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980742"><span class="hs-identifier hs-var">alt_bndr</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="GHC.Core.DataCon.html#NotMarkedStrict"><span class="hs-identifier hs-var">NotMarkedStrict</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(CoreBndr, StrictnessMark)
-&gt; [(CoreBndr, StrictnessMark)] -&gt; [(CoreBndr, StrictnessMark)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[CoreBndr] -&gt; [StrictnessMark] -&gt; [(CoreBndr, StrictnessMark)]
</span><a href="#local-6989586621682980740"><span class="hs-identifier hs-var">abstract_binders</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980743"><span class="hs-identifier hs-var">alt_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">[StrictnessMark]
</span><a href="#local-6989586621682980744"><span class="hs-identifier hs-var">marks</span></a></span><span>
</span><span id="line-4027"></span><span>              </span><span class="annot"><a href="#local-6989586621682980740"><span class="hs-identifier hs-var">abstract_binders</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980745"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980745"><span class="hs-identifier hs-var">alt_bndr</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682980746"><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980746"><span class="hs-identifier hs-var">alt_bndrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980747"><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621682980747"><span class="hs-identifier hs-var">mark</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682980748"><span class="annot"><span class="annottext">[StrictnessMark]
</span><a href="#local-6989586621682980748"><span class="hs-identifier hs-var">marks</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-4028"></span><span>                </span><span class="hs-comment">-- The deadness info on the new Ids is preserved by simplBinders</span><span>
</span><span id="line-4029"></span><span>                </span><span class="hs-comment">-- We don't abstract over dead ids here.</span><span>
</span><span id="line-4030"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Id.html#isDeadBinder"><span class="hs-identifier hs-var">isDeadBinder</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980745"><span class="hs-identifier hs-var">alt_bndr</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CoreBndr] -&gt; [StrictnessMark] -&gt; [(CoreBndr, StrictnessMark)]
</span><a href="#local-6989586621682980740"><span class="hs-identifier hs-var">abstract_binders</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980746"><span class="hs-identifier hs-var">alt_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">[StrictnessMark]
</span><a href="#local-6989586621682980748"><span class="hs-identifier hs-var">marks</span></a></span><span>
</span><span id="line-4031"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980745"><span class="hs-identifier hs-var">alt_bndr</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621682980747"><span class="hs-identifier hs-var">mark</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(CoreBndr, StrictnessMark)
-&gt; [(CoreBndr, StrictnessMark)] -&gt; [(CoreBndr, StrictnessMark)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[CoreBndr] -&gt; [StrictnessMark] -&gt; [(CoreBndr, StrictnessMark)]
</span><a href="#local-6989586621682980740"><span class="hs-identifier hs-var">abstract_binders</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980746"><span class="hs-identifier hs-var">alt_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">[StrictnessMark]
</span><a href="#local-6989586621682980748"><span class="hs-identifier hs-var">marks</span></a></span><span>
</span><span id="line-4032"></span><span>              </span><span class="annot"><a href="#local-6989586621682980740"><span class="hs-identifier hs-var">abstract_binders</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[StrictnessMark]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; [(CoreBndr, StrictnessMark)]
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;abstrict_binders - failed to abstract&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Alt CoreBndr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">(Alt CoreBndr -&gt; SDoc) -&gt; Alt CoreBndr -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">AltCon -&gt; [CoreBndr] -&gt; CoreExpr -&gt; Alt CoreBndr
forall b. AltCon -&gt; [b] -&gt; Expr b -&gt; Alt b
</span><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-var">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682980733"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980734"><span class="hs-identifier hs-var">alt_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980735"><span class="hs-identifier hs-var">alt_rhs_in</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4033"></span><span>
</span><span id="line-4034"></span><span>              </span><span id="local-6989586621682980749"><span class="annot"><span class="annottext">filtered_binders :: [CoreBndr]
</span><a href="#local-6989586621682980749"><span class="hs-identifier hs-var hs-var hs-var">filtered_binders</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((CoreBndr, StrictnessMark) -&gt; CoreBndr)
-&gt; [(CoreBndr, StrictnessMark)] -&gt; [CoreBndr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(CoreBndr, StrictnessMark) -&gt; CoreBndr
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(CoreBndr, StrictnessMark)]
</span><a href="#local-6989586621682980739"><span class="hs-identifier hs-var">abstracted_binders</span></a></span><span>
</span><span id="line-4035"></span><span>              </span><span class="hs-comment">-- We want to make any binder with an evaldUnfolding strict in the rhs.</span><span>
</span><span id="line-4036"></span><span>              </span><span class="hs-comment">-- See Note [Call-by-value for worker args] (which also applies to join points)</span><span>
</span><span id="line-4037"></span><span>              </span><span id="local-6989586621682980750"><span class="annot"><span class="annottext">rhs_with_seqs :: CoreExpr
</span><a href="#local-6989586621682980750"><span class="hs-identifier hs-var hs-var hs-var">rhs_with_seqs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(CoreBndr, StrictnessMark)] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkStrictFieldSeqs"><span class="hs-identifier hs-var">mkStrictFieldSeqs</span></a></span><span> </span><span class="annot"><span class="annottext">[(CoreBndr, StrictnessMark)]
</span><a href="#local-6989586621682980739"><span class="hs-identifier hs-var">abstracted_binders</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980735"><span class="hs-identifier hs-var">alt_rhs_in</span></a></span><span>
</span><span id="line-4038"></span><span>
</span><span id="line-4039"></span><span>              </span><span id="local-6989586621682980752"><span class="annot"><span class="annottext">final_args :: [CoreExpr]
</span><a href="#local-6989586621682980752"><span class="hs-identifier hs-var hs-var hs-var">final_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CoreBndr] -&gt; [CoreExpr]
forall b. [CoreBndr] -&gt; [Expr b]
</span><a href="GHC.Core.html#varsToCoreExprs"><span class="hs-identifier hs-var">varsToCoreExprs</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980749"><span class="hs-identifier hs-var">filtered_binders</span></a></span><span>
</span><span id="line-4040"></span><span>                           </span><span class="hs-comment">-- Note [Join point abstraction]</span><span>
</span><span id="line-4041"></span><span>
</span><span id="line-4042"></span><span>                </span><span class="hs-comment">-- We make the lambdas into one-shot-lambdas.  The</span><span>
</span><span id="line-4043"></span><span>                </span><span class="hs-comment">-- join point is sure to be applied at most once, and doing so</span><span>
</span><span id="line-4044"></span><span>                </span><span class="hs-comment">-- prevents the body of the join point being floated out by</span><span>
</span><span id="line-4045"></span><span>                </span><span class="hs-comment">-- the full laziness pass</span><span>
</span><span id="line-4046"></span><span>              </span><span id="local-6989586621682980754"><span class="annot"><span class="annottext">final_bndrs :: [CoreBndr]
</span><a href="#local-6989586621682980754"><span class="hs-identifier hs-var hs-var hs-var">final_bndrs</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreBndr -&gt; CoreBndr) -&gt; [CoreBndr] -&gt; [CoreBndr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; CoreBndr
</span><a href="#local-6989586621682980755"><span class="hs-identifier hs-var">one_shot</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980749"><span class="hs-identifier hs-var">filtered_binders</span></a></span><span>
</span><span id="line-4047"></span><span>              </span><span id="local-6989586621682980755"><span class="annot"><span class="annottext">one_shot :: CoreBndr -&gt; CoreBndr
</span><a href="#local-6989586621682980755"><span class="hs-identifier hs-var hs-var hs-var">one_shot</span></a></span></span><span> </span><span id="local-6989586621682980756"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980756"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980756"><span class="hs-identifier hs-var">v</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; CoreBndr
</span><a href="GHC.Types.Id.html#setOneShotLambda"><span class="hs-identifier hs-var">setOneShotLambda</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980756"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-4048"></span><span>                         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980756"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-4049"></span><span>
</span><span id="line-4050"></span><span>              </span><span class="hs-comment">-- No lambda binder has an unfolding, but (currently) case binders can,</span><span>
</span><span id="line-4051"></span><span>              </span><span class="hs-comment">-- so we must zap them here.</span><span>
</span><span id="line-4052"></span><span>              </span><span id="local-6989586621682980757"><span class="annot"><span class="annottext">join_rhs :: CoreExpr
</span><a href="#local-6989586621682980757"><span class="hs-identifier hs-var hs-var hs-var">join_rhs</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CoreBndr] -&gt; CoreExpr -&gt; CoreExpr
forall b. [b] -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#mkLams"><span class="hs-identifier hs-var">mkLams</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CoreBndr -&gt; CoreBndr) -&gt; [CoreBndr] -&gt; [CoreBndr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; CoreBndr
</span><a href="GHC.Types.Id.html#zapIdUnfolding"><span class="hs-identifier hs-var">zapIdUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980754"><span class="hs-identifier hs-var">final_bndrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980750"><span class="hs-identifier hs-var">rhs_with_seqs</span></a></span><span>
</span><span id="line-4053"></span><span>
</span><span id="line-4054"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682980758"><span class="annot"><a href="#local-6989586621682980758"><span class="hs-identifier hs-var">join_bndr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[CoreBndr] -&gt; Kind -&gt; SimplM CoreBndr
</span><a href="GHC.Core.Opt.Simplify.Monad.html#newJoinId"><span class="hs-identifier hs-var">newJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980749"><span class="hs-identifier hs-var">filtered_binders</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980736"><span class="hs-identifier hs-var">rhs_ty'</span></a></span><span>
</span><span id="line-4055"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- join_bndr_w_unf = join_bndr `setIdUnfolding`</span><span>
</span><span id="line-4056"></span><span>              </span><span class="hs-comment">--                   mkUnfolding uf_opts VanillaSrc False False join_rhs Nothing</span><span>
</span><span id="line-4057"></span><span>              </span><span class="hs-comment">-- See Note [Do not add unfoldings to join points at birth]</span><span>
</span><span id="line-4058"></span><span>              </span><span id="local-6989586621682980759"><span class="annot"><a href="#local-6989586621682980759"><span class="hs-identifier hs-var hs-var">join_call</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; CoreExpr
forall b. Expr b -&gt; [Expr b] -&gt; Expr b
</span><a href="GHC.Core.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; CoreExpr
forall b. CoreBndr -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980758"><span class="hs-identifier hs-var">join_bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682980752"><span class="hs-identifier hs-var">final_args</span></a></span><span>
</span><span id="line-4059"></span><span>              </span><span id="local-6989586621682980760"><span class="annot"><a href="#local-6989586621682980760"><span class="hs-identifier hs-var hs-var">alt'</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AltCon -&gt; [CoreBndr] -&gt; CoreExpr -&gt; Alt CoreBndr
forall b. AltCon -&gt; [b] -&gt; Expr b -&gt; Alt b
</span><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-var">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682980733"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980734"><span class="hs-identifier hs-var">alt_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980759"><span class="hs-identifier hs-var">join_call</span></a></span><span>
</span><span id="line-4060"></span><span>
</span><span id="line-4061"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="#local-6989586621682980732"><span class="hs-identifier hs-type">jfloats</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#addJoinFlts"><span class="hs-operator hs-type">`addJoinFlts`</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#unitJoinFloat"><span class="hs-identifier hs-type">unitJoinFloat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980758"><span class="hs-identifier hs-type">join_bndr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980757"><span class="hs-identifier hs-type">join_rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4062"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682980760"><span class="hs-identifier hs-type">alt'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-4063"></span><span>                </span><span class="hs-comment">-- See Note [Duplicated env]</span><span>
</span><span id="line-4064"></span><span>
</span><span id="line-4065"></span><span class="hs-comment">{-
Note [Do not add unfoldings to join points at birth]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this (#15360)

   case (case (case (case ...))) of
      Left x  -&gt; e1
      Right y -&gt; e2

We will make a join point for e1, e2, thus
    $j1a x = e1
    $j1b y = e2

Now those join point calls count as &quot;duplicable&quot; , so we feel free to duplicate
them into the loop nest.  And each of those calls are then subject to
callSiteInline, which might inline them, if e1, e2 are reasonably small.  Now,
if this applies recursive to the next `case` inwards, and so on, the net
effect is that we can get an exponential number of calls to $j1a and $j1b, and
an exponential number of inlinings (since each is done independently).

This hit #15360 (not a complicated program!) badly.  Our simple solution is this:
when a join point is born, we don't give it an unfolding, so it will not be inlined
at its call sites, at least not in that pass.  So we end up with
    $j1a x = e1
    $j1b y = e2
    $j2a x = ...$j1a ... $j1b...
    $j2b x = ...$j1a ... $j1b...
    ... and so on...

In the next iteration of the Simplifier we are into Note [Avoid inlining into
deeply nested cases] in Simplify.Inline, which is still a challenge.  But at
least we have a chance. If we add inlinings at birth we never get that chance.

Wrinkle

(JU1) It turns out that the same problem shows up in a different guise, via
      Note [Post-inline for single-use things] in Simplify.Utils.  I think
      we have something like
         case K (join $j x = &lt;rhs&gt; in jblah) of K y{OneOcc} -&gt; blah
      where $j is a freshly-born join point.  After case-of-known-constructor
      wo we end up substituting (join $j x = &lt;rhs&gt; in jblah) for `y` in `blah`;
      and thus we re-simplify that join binding.  In test T15630 this results in
      massive duplication.

      So in `simplLetUnfolding` we spot this case a bit hackily; a freshly-born
      join point will have OccInfo of ManyOccs, unlike an existing join point which
      will have OneOcc.  So in simplLetUnfolding we kill the unfolding of a freshly
      born join point.

I can't quite articulate precisely why this is so important.  But it makes a
MASSIVE difference in T15630 (a fantastic test case); and at worst it'll merely
delay inlining join points by one simplifier iteration.

In effect (JU1) just extends the original Note [Do not add unfoldings to join
points at birth] to occasions where we re-visit the same join-point in the same
Simplifier iteration.

Note [Fusing case continuations]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It's important to fuse two successive case continuations when the
first has one alternative.  That's why we call prepareCaseCont here.
Consider this, which arises from thunk splitting (see Note [Thunk
splitting] in GHC.Core.Opt.WorkWrap):

      let
        x* = case (case v of {pn -&gt; rn}) of
               I# a -&gt; I# a
      in body

The simplifier will find
    (Var v) with continuation
            Select (pn -&gt; rn) (
            Select [I# a -&gt; I# a] (
            StrictBind body Stop

So we'll call mkDupableCont on
   Select [I# a -&gt; I# a] (StrictBind body Stop)
There is just one alternative in the first Select, so we want to
simplify the rhs (I# a) with continuation (StrictBind body Stop)
Supposing that body is big, we end up with
          let $j a = &lt;let x = I# a in body&gt;
          in case v of { pn -&gt; case rn of
                                 I# a -&gt; $j a }
This is just what we want because the rn produces a box that
the case rn cancels with.

See #4957 a fuller example.

Note [Duplicating join points]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In #19996 we discovered that we want to be really careful about
inlining join points.   Consider
    case (join $j x = K f x )
         (in case v of      )
         (     p1 -&gt; $j x1  ) of
         (     p2 -&gt; $j x2  )
         (     p3 -&gt; $j x3  )
      K g y -&gt; blah[g,y]

Here the join-point RHS is very small, just a constructor
application (K f x).  So we might inline it to get
    case (case v of          )
         (     p1 -&gt; K f x1  ) of
         (     p2 -&gt; K f x2  )
         (     p3 -&gt; K f x3  )
      K g y -&gt; blah[g,y]

But now we have to make `blah` into a join point, /abstracted/
over `g` and `y`.   In contrast, if we /don't/ inline $j we
don't need a join point for `blah` and we'll get
    join $j x = let g=f, y=x in blah[g,y]
    in case v of
       p1 -&gt; $j x1
       p2 -&gt; $j x2
       p3 -&gt; $j x3

This can make a /massive/ difference, because `blah` can see
what `f` is, instead of lambda-abstracting over it.

Beyond this, not-inlining join points reduces duplication.  In the above
example, if `blah` was small enough we'd inline it, but that duplicates code,
for no gain.  Best just to keep not-inline the join point in the first place.
So not-inlining join points is our default: but see Note [Inlining join points]
in GHC.Core.Opt.Simplify.Inline for when we /do/ inline them.

To achieve this parsimonious inlining of join points, we need to do two things:
(a) create a join point even if the RHS is small; and (b) don't do
unconditional-inlining for join points.

(DJ1) Do not postInlineUnconditionally a join point, ever. Doing
   postInlineUnconditionally is primarily to push allocation into cold
   branches; but a join point doesn't allocate, so that's a non-motivation.

(DJ2) In mkDupableAlt and mkDupableStrictBind, generate an alterative for /all/
   alternatives, /except/ for ones that will definitely inline unconditionally
   straight away.  (In that case it's silly to make a join point in the first
   place; it just takes an extra Simplifier iteration to undo.)  This choice is
   made by GHC.Core.Unfold.uncondInlineJoin.

   This plan generates a lot of join points, but makes them much more
   case-of-case friendly.

(DJ3) When should `uncondInlineJoin` return True?
   * (exprIsTrivial rhs); this includes uses of unsafeEqualityProof etc; see
     the defn of exprIsTrivial.  Also nullary constructors.

   * The RHS is a call ($j x y z), where the arguments are all trivial and $j
     is a join point: there is no point in creating an indirection.

(DJ4) By the same token we want to use Plan B in Note [Duplicating StrictArg] when
   the RHS of the new join point is a data constructor application.  See the
   call to isDataConId in the StrictArg case of mkDupableContWithDmds.

   That same Note [Duplicating StrictArg] explains why we sometimes want Plan A
   when the RHS of the new join point would be a non-data-constructor
   application

(DJ5) You might worry that $j = K x y might look so small that it is inlined
   by the call site inliner, defeating (DJ3). But in fact

   - The UnfoldingGuidance for a join point is only UnfWhen (unconditional)
     if `uncondInlineJoin` is true; see GHC.Core.Unfold.uncondInline

   - `GHC.Core.Opt.Simplify.Inline.tryUnfolding` has a special case for join
     points, described Note [Inlining join points] in that module.

Historical Note [Case binders and join points]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
NB: this entire Note is now irrelevant.  In Jun 21 we stopped
adding unfoldings to lambda binders (#17530).  It was always a
hack and bit us in multiple small and not-so-small ways

Consider this
   case (case .. ) of c {
     I# c# -&gt; ....c....

If we make a join point with c but not c# we get
  $j = \c -&gt; ....c....

But if later inlining scrutinises the c, thus

  $j = \c -&gt; ... case c of { I# y -&gt; ... } ...

we won't see that 'c' has already been scrutinised.  This actually
happens in the 'tabulate' function in wave4main, and makes a significant
difference to allocation.

An alternative plan is this:

   $j = \c# -&gt; let c = I# c# in ...c....

but that is bad if 'c' is *not* later scrutinised.

So instead we do both: we pass 'c' and 'c#' , and record in c's inlining
(a stable unfolding) that it's really I# c#, thus

   $j = \c# -&gt; \c[=I# c#] -&gt; ...c....

Absence analysis may later discard 'c'.

NB: take great care when doing strictness analysis;
    see Note [Lambda-bound unfoldings] in GHC.Core.Opt.DmdAnal.

Also note that we can still end up passing stuff that isn't used.  Before
strictness analysis we have
   let $j x y c{=(x,y)} = (h c, ...)
   in ...
After strictness analysis we see that h is strict, we end up with
   let $j x y c{=(x,y)} = ($wh x y, ...)
and c is unused.

Note [Duplicated env]
~~~~~~~~~~~~~~~~~~~~~
Some of the alternatives are simplified, but have not been turned into a join point
So they *must* have a zapped subst-env.  So we can't use completeNonRecX to
bind the join point, because it might to do PostInlineUnconditionally, and
we'd lose that when zapping the subst-env.  We could have a per-alt subst-env,
but zapping it (as we do in mkDupableCont, the Select case) is safe, and
at worst delays the join-point inlining.

Note [Funky mkLamTypes]
~~~~~~~~~~~~~~~~~~~~~~
Notice the funky mkLamTypes.  If the constructor has existentials
it's possible that the join point will be abstracted over
type variables as well as term variables.
 Example:  Suppose we have
        data T = forall t.  C [t]
 Then faced with
        case (case e of ...) of
            C t xs::[t] -&gt; rhs
 We get the join point
        let j :: forall t. [t] -&gt; ...
            j = /\t \xs::[t] -&gt; rhs
        in
        case (case e of ...) of
            C t xs::[t] -&gt; j t xs

Note [Duplicating StrictArg]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Dealing with making a StrictArg continuation duplicable has turned out
to be one of the trickiest corners of the simplifier, giving rise
to several cases in which the simplier expanded the program's size
*exponentially*.  They include
  #13253 exponential inlining
  #10421 ditto
  #18140 strict constructors
  #18282 another nested-function call case

Suppose we have a call
  f e1 (case x of { True -&gt; r1; False -&gt; r2 }) e3
and f is strict in its second argument.  Then we end up in
mkDupableCont with a StrictArg continuation for (f e1 &lt;&gt; e3).
There are two ways to make it duplicable.

* Plan A: move the entire call inwards, being careful not
  to duplicate e1 or e3, thus:
     let a1 = e1
         a3 = e3
     in case x of { True  -&gt; f a1 r1 a3
                  ; False -&gt; f a1 r2 a3 }

* Plan B: make a join point:
     join $j x = f e1 x e3
     in case x of { True  -&gt; jump $j r1
                  ; False -&gt; jump $j r2 }

  Notice that Plan B is very like the way we handle strict bindings;
  see Note [Duplicating StrictBind].  And Plan B is exactly what we'd
  get if we turned use a case expression to evaluate the strict arg:

       case (case x of { True -&gt; r1; False -&gt; r2 }) of
         r -&gt; f e1 r e3

  So, looking at Note [Duplicating join points], we also want Plan B
  when `f` is a data constructor.

Plan A is often good:

* The calls to `f` may well be able to inline, since they are now applied
  to more informative arguments, `r1`, `r2`. For example:
        &amp;&amp; E (case x of { T -&gt; F; F -&gt; T })
  Pushing the call inward (being careful not to duplicate E) we get
        let a = E
        in case x of { T -&gt; &amp;&amp; a F; F -&gt; &amp;&amp; a T }
  and now the (&amp;&amp; a F) etc can optimise.

* Moreover there might be a RULE for the function that can fire when it &quot;sees&quot;
  the particular case alternative.

* More specialisation can happen.  Here's an example from #3116
     go (n+1) (case l of
                 1  -&gt; bs'
                 _  -&gt; Chunk p fpc (o+1) (l-1) bs')

  If we pushed the entire call for 'go' inside the case, we get
  call-pattern specialisation for 'go', which is *crucial* for
  this particular program.

But Plan A can have terrible, terrible behaviour. Here is a classic
case:
  f (f (f (f (f True))))

Suppose f is strict, and has a body that is small enough to inline.
The innermost call inlines (seeing the True) to give
  f (f (f (f (case v of { True -&gt; e1; False -&gt; e2 }))))

Now, suppose we naively push the entire continuation into both
case branches (it doesn't look large, just f.f.f.f). We get
  case v of
    True  -&gt; f (f (f (f e1)))
    False -&gt; f (f (f (f e2)))

And now the process repeats, so we end up with an exponentially large
number of copies of f. No good!

CONCLUSION: we want Plan A in general, but do Plan B is there a
danger of this nested call behaviour. The function that decides
this is called thumbsUpPlanA.

Note [Keeping demand info in StrictArg Plan A]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Following on from Note [Duplicating StrictArg], another common code
pattern that can go bad is this:
   f (case x1 of { T -&gt; F; F -&gt; T })
     (case x2 of { T -&gt; F; F -&gt; T })
     ...etc...
when f is strict in all its arguments.  (It might, for example, be a
strict data constructor whose wrapper has not yet been inlined.)

We use Plan A (because there is no nesting) giving
  let a2 = case x2 of ...
      a3 = case x3 of ...
  in case x1 of { T -&gt; f F a2 a3 ... ; F -&gt; f T a2 a3 ... }

Now we must be careful!  a2 and a3 are small, and the OneOcc code in
postInlineUnconditionally may inline them both at both sites; see Note
Note [Inline small things to avoid creating a thunk] in
Simplify.Utils. But if we do inline them, the entire process will
repeat -- back to exponential behaviour.

So we are careful to keep the demand-info on a2 and a3.  Then they'll
be /strict/ let-bindings, which will be dealt with by StrictBind.
That's why contIsDupableWithDmds is careful to propagage demand
info to the auxiliary bindings it creates.  See the Demand argument
to makeTrivial.

Note [Duplicating StrictBind]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We make a StrictBind duplicable in a very similar way to
that for case expressions.  After all,
   let x* = e in b   is similar to    case e of x -&gt; b

So we potentially make a join-point for the body, thus:
   let x = &lt;&gt; in b   ==&gt;   join j x = b
                           in j &lt;&gt;

Just like StrictArg in fact -- and indeed they share code.

Note [Join point abstraction]  Historical note
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
NB: This note is now historical, describing how (in the past) we used
to add a void argument to nullary join points.  But now that &quot;join
point&quot; is not a fuzzy concept but a formal syntactic construct (as
distinguished by the JoinId constructor of IdDetails), each of these
concerns is handled separately, with no need for a vestigial extra
argument.

Join points always have at least one value argument,
for several reasons

* If we try to lift a primitive-typed something out
  for let-binding-purposes, we will *caseify* it (!),
  with potentially-disastrous strictness results.  So
  instead we turn it into a function: \v -&gt; e
  where v::Void#.  The value passed to this function is void,
  which generates (almost) no code.

* CPR.  We used to say &quot;&amp;&amp; isUnliftedType rhs_ty'&quot; here, but now
  we make the join point into a function whenever used_bndrs'
  is empty.  This makes the join-point more CPR friendly.
  Consider:       let j = if .. then I# 3 else I# 4
                  in case .. of { A -&gt; j; B -&gt; j; C -&gt; ... }

  Now CPR doesn't w/w j because it's a thunk, so
  that means that the enclosing function can't w/w either,
  which is a lose.  Here's the example that happened in practice:
          kgmod :: Int -&gt; Int -&gt; Int
          kgmod x y = if x &gt; 0 &amp;&amp; y &lt; 0 || x &lt; 0 &amp;&amp; y &gt; 0
                      then 78
                      else 5

* Let-no-escape.  We want a join point to turn into a let-no-escape
  so that it is implemented as a jump, and one of the conditions
  for LNE is that it's not updatable.  In CoreToStg, see
  Note [What is a non-escaping let]

* Floating.  Since a join point will be entered once, no sharing is
  gained by floating out, but something might be lost by doing
  so because it might be allocated.

I have seen a case alternative like this:
        True -&gt; \v -&gt; ...
It's a bit silly to add the realWorld dummy arg in this case, making
        $j = \s v -&gt; ...
           True -&gt; $j s
(the \v alone is enough to make CPR happy) but I think it's rare

There's a slight infelicity here: we pass the overall
case_bndr to all the join points if it's used in *any* RHS,
because we don't know its usage in each RHS separately



************************************************************************
*                                                                      *
                    Unfoldings
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-4484"></span><span>
</span><span id="line-4485"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplLetUnfolding"><span class="hs-identifier hs-type">simplLetUnfolding</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span>
</span><span id="line-4486"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BindContext"><span class="hs-identifier hs-type">BindContext</span></a></span><span>
</span><span id="line-4487"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span>
</span><span id="line-4488"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutType"><span class="hs-identifier hs-type">OutType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>
</span><span id="line-4489"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a></span><span>
</span><span id="line-4490"></span><span id="simplLetUnfolding"><span class="annot"><span class="annottext">simplLetUnfolding :: SimplEnv
-&gt; BindContext
-&gt; CoreBndr
-&gt; CoreExpr
-&gt; Kind
-&gt; ArityType
-&gt; Unfolding
-&gt; SimplM Unfolding
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplLetUnfolding"><span class="hs-identifier hs-var hs-var">simplLetUnfolding</span></a></span></span><span> </span><span id="local-6989586621682980762"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980762"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980763"><span class="annot"><span class="annottext">BindContext
</span><a href="#local-6989586621682980763"><span class="hs-identifier hs-var">bind_cxt</span></a></span></span><span> </span><span id="local-6989586621682980764"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980764"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span id="local-6989586621682980765"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980765"><span class="hs-identifier hs-var">new_rhs</span></a></span></span><span> </span><span id="local-6989586621682980766"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980766"><span class="hs-identifier hs-var">rhs_ty</span></a></span></span><span> </span><span id="local-6989586621682980767"><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621682980767"><span class="hs-identifier hs-var">arity</span></a></span></span><span> </span><span id="local-6989586621682980768"><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682980768"><span class="hs-identifier hs-var">unf</span></a></span></span><span>
</span><span id="line-4491"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; Bool
</span><a href="GHC.Core.html#isStableUnfolding"><span class="hs-identifier hs-var">isStableUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682980768"><span class="hs-identifier hs-var">unf</span></a></span><span>
</span><span id="line-4492"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; BindContext
-&gt; CoreBndr
-&gt; Kind
-&gt; ArityType
-&gt; Unfolding
-&gt; SimplM Unfolding
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplStableUnfolding"><span class="hs-identifier hs-var">simplStableUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980762"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">BindContext
</span><a href="#local-6989586621682980763"><span class="hs-identifier hs-var">bind_cxt</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980764"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980766"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621682980767"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682980768"><span class="hs-identifier hs-var">unf</span></a></span><span>
</span><span id="line-4493"></span><span>
</span><span id="line-4494"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="#local-6989586621682980771"><span class="hs-identifier hs-var">freshly_born_join_point</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980764"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-4495"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- This is a tricky one!</span><span>
</span><span id="line-4496"></span><span>    </span><span class="hs-comment">-- See wrinkle (JU1) in Note [Do not add unfoldings to join points at birth]</span><span>
</span><span id="line-4497"></span><span>    </span><span class="annot"><span class="annottext">Unfolding -&gt; SimplM Unfolding
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="GHC.Core.html#noUnfolding"><span class="hs-identifier hs-var">noUnfolding</span></a></span><span>
</span><span id="line-4498"></span><span>
</span><span id="line-4499"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#isExitJoinId"><span class="hs-identifier hs-var">isExitJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980764"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-4500"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- See Note [Do not inline exit join points] in GHC.Core.Opt.Exitify</span><span>
</span><span id="line-4501"></span><span>    </span><span class="annot"><span class="annottext">Unfolding -&gt; SimplM Unfolding
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="GHC.Core.html#noUnfolding"><span class="hs-identifier hs-var">noUnfolding</span></a></span><span>
</span><span id="line-4502"></span><span>
</span><span id="line-4503"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-4504"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; TopLevelFlag
-&gt; UnfoldingSource
-&gt; CoreBndr
-&gt; Bool
-&gt; CoreExpr
-&gt; SimplM Unfolding
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#mkLetUnfolding"><span class="hs-identifier hs-var">mkLetUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980762"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BindContext -&gt; TopLevelFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#bindContextLevel"><span class="hs-identifier hs-var">bindContextLevel</span></a></span><span> </span><span class="annot"><span class="annottext">BindContext
</span><a href="#local-6989586621682980763"><span class="hs-identifier hs-var">bind_cxt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="GHC.Types.Basic.html#VanillaSrc"><span class="hs-identifier hs-var">VanillaSrc</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980764"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682980774"><span class="hs-identifier hs-var">is_join_point</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980765"><span class="hs-identifier hs-var">new_rhs</span></a></span><span>
</span><span id="line-4505"></span><span>
</span><span id="line-4506"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-4507"></span><span>    </span><span id="local-6989586621682980774"><span class="annot"><span class="annottext">is_join_point :: Bool
</span><a href="#local-6989586621682980774"><span class="hs-identifier hs-var hs-var">is_join_point</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980764"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-4508"></span><span>    </span><span id="local-6989586621682980771"><span class="annot"><span class="annottext">freshly_born_join_point :: CoreBndr -&gt; Bool
</span><a href="#local-6989586621682980771"><span class="hs-identifier hs-var hs-var">freshly_born_join_point</span></a></span></span><span> </span><span id="local-6989586621682980775"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980775"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682980774"><span class="hs-identifier hs-var">is_join_point</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">OccInfo -&gt; Bool
</span><a href="GHC.Types.Basic.html#isManyOccs"><span class="hs-identifier hs-var">isManyOccs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; OccInfo
</span><a href="GHC.Types.Id.html#idOccInfo"><span class="hs-identifier hs-var">idOccInfo</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980775"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4509"></span><span>      </span><span class="hs-comment">-- OLD: too_many_occs (OneOcc { occ_n_br = n }) = n &gt; 10 -- See #23627</span><span>
</span><span id="line-4510"></span><span>
</span><span id="line-4511"></span><span class="hs-comment">-------------------</span><span>
</span><span id="line-4512"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#mkLetUnfolding"><span class="hs-identifier hs-type">mkLetUnfolding</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#UnfoldingSource"><span class="hs-identifier hs-type">UnfoldingSource</span></a></span><span>
</span><span id="line-4513"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>    </span><span class="hs-comment">-- True &lt;=&gt; this is a join point</span><span>
</span><span id="line-4514"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a></span><span>
</span><span id="line-4515"></span><span id="mkLetUnfolding"><span class="annot"><span class="annottext">mkLetUnfolding :: SimplEnv
-&gt; TopLevelFlag
-&gt; UnfoldingSource
-&gt; CoreBndr
-&gt; Bool
-&gt; CoreExpr
-&gt; SimplM Unfolding
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#mkLetUnfolding"><span class="hs-identifier hs-var hs-var">mkLetUnfolding</span></a></span></span><span> </span><span id="local-6989586621682980777"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980777"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980778"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682980778"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621682980779"><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621682980779"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span id="local-6989586621682980780"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980780"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span id="local-6989586621682980781"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682980781"><span class="hs-identifier hs-var">is_join</span></a></span></span><span> </span><span id="local-6989586621682980782"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980782"><span class="hs-identifier hs-var">new_rhs</span></a></span></span><span>
</span><span id="line-4516"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; SimplM Unfolding
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UnfoldingOpts
-&gt; UnfoldingSource
-&gt; Bool
-&gt; Bool
-&gt; Bool
-&gt; CoreExpr
-&gt; Maybe UnfoldingCache
-&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkUnfolding"><span class="hs-identifier hs-var">mkUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621682980784"><span class="hs-identifier hs-var">uf_opts</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621682980779"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682980785"><span class="hs-identifier hs-var">is_top_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682980786"><span class="hs-identifier hs-var">is_bottoming</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682980781"><span class="hs-identifier hs-var">is_join</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980782"><span class="hs-identifier hs-var">new_rhs</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe UnfoldingCache
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-4517"></span><span>            </span><span class="hs-comment">-- We make an  unfolding *even for loop-breakers*.</span><span>
</span><span id="line-4518"></span><span>            </span><span class="hs-comment">-- Reason: (a) It might be useful to know that they are WHNF</span><span>
</span><span id="line-4519"></span><span>            </span><span class="hs-comment">--         (b) In GHC.Iface.Tidy we currently assume that, if we want to</span><span>
</span><span id="line-4520"></span><span>            </span><span class="hs-comment">--             expose the unfolding then indeed we *have* an unfolding</span><span>
</span><span id="line-4521"></span><span>            </span><span class="hs-comment">--             to expose.  (We could instead use the RHS, but currently</span><span>
</span><span id="line-4522"></span><span>            </span><span class="hs-comment">--             we don't.)  The simple thing is always to have one.</span><span>
</span><span id="line-4523"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-4524"></span><span>    </span><span class="hs-comment">-- !opts: otherwise, we end up retaining all the SimpleEnv</span><span>
</span><span id="line-4525"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621682980784"><span class="annot"><span class="annottext">uf_opts :: UnfoldingOpts
</span><a href="#local-6989586621682980784"><span class="hs-identifier hs-var hs-var">uf_opts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; UnfoldingOpts
</span><a href="GHC.Core.Opt.Simplify.Env.html#seUnfoldingOpts"><span class="hs-identifier hs-var">seUnfoldingOpts</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980777"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-4526"></span><span>
</span><span id="line-4527"></span><span>    </span><span class="hs-comment">-- Might as well force this, profiles indicate up to</span><span>
</span><span id="line-4528"></span><span>    </span><span class="hs-comment">-- 0.5MB of thunks just from this site.</span><span>
</span><span id="line-4529"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621682980785"><span class="annot"><span class="annottext">is_top_lvl :: Bool
</span><a href="#local-6989586621682980785"><span class="hs-identifier hs-var hs-var">is_top_lvl</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; Bool
</span><a href="GHC.Types.Basic.html#isTopLevel"><span class="hs-identifier hs-var">isTopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682980778"><span class="hs-identifier hs-var">top_lvl</span></a></span><span>
</span><span id="line-4530"></span><span>    </span><span class="hs-comment">-- See Note [Force bottoming field]</span><span>
</span><span id="line-4531"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621682980786"><span class="annot"><span class="annottext">is_bottoming :: Bool
</span><a href="#local-6989586621682980786"><span class="hs-identifier hs-var hs-var">is_bottoming</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Bool
</span><a href="GHC.Types.Id.html#isDeadEndId"><span class="hs-identifier hs-var">isDeadEndId</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980780"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-4532"></span><span>
</span><span id="line-4533"></span><span class="hs-comment">-------------------</span><span>
</span><span id="line-4534"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplStableUnfolding"><span class="hs-identifier hs-type">simplStableUnfolding</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BindContext"><span class="hs-identifier hs-type">BindContext</span></a></span><span>
</span><span id="line-4535"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span>
</span><span id="line-4536"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutType"><span class="hs-identifier hs-type">OutType</span></a></span><span>
</span><span id="line-4537"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>      </span><span class="hs-comment">-- Used to eta expand, but only for non-join-points</span><span>
</span><span id="line-4538"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a></span><span>
</span><span id="line-4539"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a></span><span>
</span><span id="line-4540"></span><span class="hs-comment">-- Note [Setting the new unfolding]</span><span>
</span><span id="line-4541"></span><span id="simplStableUnfolding"><span class="annot"><span class="annottext">simplStableUnfolding :: SimplEnv
-&gt; BindContext
-&gt; CoreBndr
-&gt; Kind
-&gt; ArityType
-&gt; Unfolding
-&gt; SimplM Unfolding
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplStableUnfolding"><span class="hs-identifier hs-var hs-var">simplStableUnfolding</span></a></span></span><span> </span><span id="local-6989586621682980788"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980788"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980789"><span class="annot"><span class="annottext">BindContext
</span><a href="#local-6989586621682980789"><span class="hs-identifier hs-var">bind_cxt</span></a></span></span><span> </span><span id="local-6989586621682980790"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980790"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span id="local-6989586621682980791"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980791"><span class="hs-identifier hs-var">rhs_ty</span></a></span></span><span> </span><span id="local-6989586621682980792"><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621682980792"><span class="hs-identifier hs-var">id_arity</span></a></span></span><span> </span><span id="local-6989586621682980793"><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682980793"><span class="hs-identifier hs-var">unf</span></a></span></span><span>
</span><span id="line-4542"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682980793"><span class="hs-identifier hs-var">unf</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4543"></span><span>      </span><span class="annot"><span class="annottext">Unfolding
</span><a href="GHC.Core.html#NoUnfolding"><span class="hs-identifier hs-var">NoUnfolding</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; SimplM Unfolding
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682980793"><span class="hs-identifier hs-var">unf</span></a></span><span>
</span><span id="line-4544"></span><span>      </span><span class="annot"><span class="annottext">Unfolding
</span><a href="GHC.Core.html#BootUnfolding"><span class="hs-identifier hs-var">BootUnfolding</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; SimplM Unfolding
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682980793"><span class="hs-identifier hs-var">unf</span></a></span><span>
</span><span id="line-4545"></span><span>      </span><span class="annot"><a href="GHC.Core.html#OtherCon"><span class="hs-identifier hs-type">OtherCon</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; SimplM Unfolding
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682980793"><span class="hs-identifier hs-var">unf</span></a></span><span>
</span><span id="line-4546"></span><span>
</span><span id="line-4547"></span><span>      </span><span class="annot"><a href="GHC.Core.html#DFunUnfolding"><span class="hs-identifier hs-type">DFunUnfolding</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">df_bndrs :: Unfolding -&gt; [CoreBndr]
</span><a href="GHC.Core.html#df_bndrs"><span class="hs-identifier hs-var">df_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980799"><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980799"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">df_con :: Unfolding -&gt; DataCon
</span><a href="GHC.Core.html#df_con"><span class="hs-identifier hs-var">df_con</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980801"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682980801"><span class="hs-identifier hs-var">con</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">df_args :: Unfolding -&gt; [CoreExpr]
</span><a href="GHC.Core.html#df_args"><span class="hs-identifier hs-var">df_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980803"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682980803"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-4548"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980804"><span class="annot"><a href="#local-6989586621682980804"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980805"><span class="annot"><a href="#local-6989586621682980805"><span class="hs-identifier hs-var">bndrs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; [CoreBndr] -&gt; SimplM (SimplEnv, [CoreBndr])
</span><a href="GHC.Core.Opt.Simplify.Env.html#simplBinders"><span class="hs-identifier hs-var">simplBinders</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980806"><span class="hs-identifier hs-var">unf_env</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980799"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-4549"></span><span>              </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682980807"><span class="annot"><a href="#local-6989586621682980807"><span class="hs-identifier hs-var">args'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExpr"><span class="hs-identifier hs-type">simplExpr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980804"><span class="hs-identifier hs-type">env'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682980803"><span class="hs-identifier hs-type">args</span></a></span><span>
</span><span id="line-4550"></span><span>              </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Unfold.Make.html#mkDFunUnfolding"><span class="hs-identifier hs-type">mkDFunUnfolding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980805"><span class="hs-identifier hs-type">bndrs'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980801"><span class="hs-identifier hs-type">con</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980807"><span class="hs-identifier hs-type">args'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-4551"></span><span>
</span><span id="line-4552"></span><span>      </span><span class="annot"><a href="GHC.Core.html#CoreUnfolding"><span class="hs-identifier hs-type">CoreUnfolding</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">uf_tmpl :: Unfolding -&gt; CoreExpr
</span><a href="GHC.Core.html#uf_tmpl"><span class="hs-identifier hs-var">uf_tmpl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980809"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980809"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uf_src :: Unfolding -&gt; UnfoldingSource
</span><a href="GHC.Core.html#uf_src"><span class="hs-identifier hs-var">uf_src</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980810"><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621682980810"><span class="hs-identifier hs-var">src</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uf_guidance :: Unfolding -&gt; UnfoldingGuidance
</span><a href="GHC.Core.html#uf_guidance"><span class="hs-identifier hs-var">uf_guidance</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980812"><span class="annot"><span class="annottext">UnfoldingGuidance
</span><a href="#local-6989586621682980812"><span class="hs-identifier hs-var">guide</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-4553"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">UnfoldingSource -&gt; Bool
</span><a href="GHC.Types.Basic.html#isStableSource"><span class="hs-identifier hs-var">isStableSource</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621682980810"><span class="hs-identifier hs-var">src</span></a></span><span>
</span><span id="line-4554"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682980813"><span class="annot"><a href="#local-6989586621682980813"><span class="hs-identifier hs-var">expr'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">BindContext
</span><a href="#local-6989586621682980789"><span class="hs-identifier hs-var">bind_cxt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4555"></span><span>                  </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BC_Join"><span class="hs-identifier hs-type">BC_Join</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682980814"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980814"><span class="hs-identifier hs-var">cont</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- Binder is a join point</span><span>
</span><span id="line-4556"></span><span>                                       </span><span class="hs-comment">-- See Note [Rules and unfolding for join points]</span><span>
</span><span id="line-4557"></span><span>                                       </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreBndr -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplJoinRhs"><span class="hs-identifier hs-var">simplJoinRhs</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980806"><span class="hs-identifier hs-var">unf_env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980790"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980809"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980814"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-4558"></span><span>                  </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BC_Let"><span class="hs-identifier hs-type">BC_Let</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682980815"><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621682980815"><span class="hs-identifier hs-var">is_rec</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- Binder is not a join point</span><span>
</span><span id="line-4559"></span><span>                                     </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682980816"><span class="annot"><span class="annottext">cont :: SimplCont
</span><a href="#local-6989586621682980816"><span class="hs-identifier hs-var hs-var hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Kind -&gt; RecFlag -&gt; Demand -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#mkRhsStop"><span class="hs-identifier hs-var">mkRhsStop</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980791"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621682980815"><span class="hs-identifier hs-var">is_rec</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="GHC.Types.Demand.html#topDmd"><span class="hs-identifier hs-var">topDmd</span></a></span><span>
</span><span id="line-4560"></span><span>                                           </span><span class="hs-comment">-- mkRhsStop: switch off eta-expansion at the top level</span><span>
</span><span id="line-4561"></span><span>                                        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682980817"><span class="annot"><a href="#local-6989586621682980817"><span class="hs-identifier hs-var">expr'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplCont -&gt; SimplM CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprC"><span class="hs-identifier hs-var">simplExprC</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980806"><span class="hs-identifier hs-var">unf_env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980809"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980816"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-4562"></span><span>                                        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682980818"><span class="hs-identifier hs-type">eta_expand</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980817"><span class="hs-identifier hs-type">expr'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-4563"></span><span>              </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621682980812"><span class="hs-identifier hs-type">guide</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4564"></span><span>                  </span><span class="annot"><a href="GHC.Core.html#UnfWhen"><span class="hs-identifier hs-type">UnfWhen</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ug_boring_ok :: UnfoldingGuidance -&gt; Bool
</span><a href="GHC.Core.html#ug_boring_ok"><span class="hs-identifier hs-var">ug_boring_ok</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980821"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682980821"><span class="hs-identifier hs-var">boring_ok</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-4565"></span><span>                     </span><span class="hs-comment">-- Happens for INLINE things</span><span>
</span><span id="line-4566"></span><span>                     </span><span class="hs-comment">-- Really important to force new_boring_ok since otherwise</span><span>
</span><span id="line-4567"></span><span>                     </span><span class="hs-comment">--   `ug_boring_ok` is a thunk chain of</span><span>
</span><span id="line-4568"></span><span>                     </span><span class="hs-comment">--   inlineBoringExprOk expr0 || inlineBoringExprOk expr1 || ...</span><span>
</span><span id="line-4569"></span><span>                     </span><span class="hs-comment">-- See #20134</span><span>
</span><span id="line-4570"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682980822"><span class="annot"><span class="annottext">new_boring_ok :: Bool
</span><a href="#local-6989586621682980822"><span class="hs-identifier hs-var hs-var">new_boring_ok</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682980821"><span class="hs-identifier hs-var">boring_ok</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="GHC.Core.Unfold.html#inlineBoringOk"><span class="hs-identifier hs-var">inlineBoringOk</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980813"><span class="hs-identifier hs-var">expr'</span></a></span><span>
</span><span id="line-4571"></span><span>                            </span><span id="local-6989586621682980824"><span class="annot"><span class="annottext">guide' :: UnfoldingGuidance
</span><a href="#local-6989586621682980824"><span class="hs-identifier hs-var hs-var">guide'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingGuidance
</span><a href="#local-6989586621682980812"><span class="hs-identifier hs-var">guide</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.html#ug_boring_ok"><span class="hs-identifier hs-var">ug_boring_ok</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682980822"><span class="hs-identifier hs-type">new_boring_ok</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-4572"></span><span>                        </span><span class="hs-comment">-- Refresh the boring-ok flag, in case expr'</span><span>
</span><span id="line-4573"></span><span>                        </span><span class="hs-comment">-- has got small. This happens, notably in the inlinings</span><span>
</span><span id="line-4574"></span><span>                        </span><span class="hs-comment">-- for dfuns for single-method classes; see</span><span>
</span><span id="line-4575"></span><span>                        </span><span class="hs-comment">-- Note [Single-method classes] in GHC.Tc.TyCl.Instance.</span><span>
</span><span id="line-4576"></span><span>                        </span><span class="hs-comment">-- A test case is #4138</span><span>
</span><span id="line-4577"></span><span>                        </span><span class="hs-comment">-- But retain a previous boring_ok of True; e.g. see</span><span>
</span><span id="line-4578"></span><span>                        </span><span class="hs-comment">-- the way it is set in calcUnfoldingGuidanceWithArity</span><span>
</span><span id="line-4579"></span><span>                        </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; SimplM Unfolding
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UnfoldingSource
-&gt; Bool
-&gt; CoreExpr
-&gt; Maybe UnfoldingCache
-&gt; UnfoldingGuidance
-&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkCoreUnfolding"><span class="hs-identifier hs-var">mkCoreUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621682980810"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682980826"><span class="hs-identifier hs-var">is_top_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980813"><span class="hs-identifier hs-var">expr'</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe UnfoldingCache
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">UnfoldingGuidance
</span><a href="#local-6989586621682980824"><span class="hs-identifier hs-var">guide'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4580"></span><span>                            </span><span class="hs-comment">-- See Note [Top-level flag on inline rules] in GHC.Core.Unfold</span><span>
</span><span id="line-4581"></span><span>
</span><span id="line-4582"></span><span>                  </span><span id="local-6989586621682980827"><span class="annot"><span class="annottext">UnfoldingGuidance
</span><a href="#local-6989586621682980827"><span class="hs-identifier hs-var">_other</span></a></span></span><span>              </span><span class="hs-comment">-- Happens for INLINABLE things</span><span>
</span><span id="line-4583"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; TopLevelFlag
-&gt; UnfoldingSource
-&gt; CoreBndr
-&gt; Bool
-&gt; CoreExpr
-&gt; SimplM Unfolding
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#mkLetUnfolding"><span class="hs-identifier hs-var">mkLetUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980788"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682980828"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621682980810"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980790"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980813"><span class="hs-identifier hs-var">expr'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-4584"></span><span>                </span><span class="hs-comment">-- If the guidance is UnfIfGoodArgs, this is an INLINABLE</span><span>
</span><span id="line-4585"></span><span>                </span><span class="hs-comment">-- unfolding, and we need to make sure the guidance is kept up</span><span>
</span><span id="line-4586"></span><span>                </span><span class="hs-comment">-- to date with respect to any changes in the unfolding.</span><span>
</span><span id="line-4587"></span><span>
</span><span id="line-4588"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; SimplM Unfolding
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="GHC.Core.html#noUnfolding"><span class="hs-identifier hs-var">noUnfolding</span></a></span><span>   </span><span class="hs-comment">-- Discard unstable unfoldings</span><span>
</span><span id="line-4589"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-4590"></span><span>    </span><span class="hs-comment">-- Forcing this can save about 0.5MB of max residency and the result</span><span>
</span><span id="line-4591"></span><span>    </span><span class="hs-comment">-- is small and easy to compute so might as well force it.</span><span>
</span><span id="line-4592"></span><span>    </span><span id="local-6989586621682980828"><span class="annot"><span class="annottext">top_lvl :: TopLevelFlag
</span><a href="#local-6989586621682980828"><span class="hs-identifier hs-var hs-var">top_lvl</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BindContext -&gt; TopLevelFlag
</span><a href="GHC.Core.Opt.Simplify.Utils.html#bindContextLevel"><span class="hs-identifier hs-var">bindContextLevel</span></a></span><span> </span><span class="annot"><span class="annottext">BindContext
</span><a href="#local-6989586621682980789"><span class="hs-identifier hs-var">bind_cxt</span></a></span><span>
</span><span id="line-4593"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621682980826"><span class="annot"><span class="annottext">is_top_lvl :: Bool
</span><a href="#local-6989586621682980826"><span class="hs-identifier hs-var hs-var">is_top_lvl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; Bool
</span><a href="GHC.Types.Basic.html#isTopLevel"><span class="hs-identifier hs-var">isTopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682980828"><span class="hs-identifier hs-var">top_lvl</span></a></span><span>
</span><span id="line-4594"></span><span>    </span><span id="local-6989586621682980829"><span class="annot"><span class="annottext">act :: Activation
</span><a href="#local-6989586621682980829"><span class="hs-identifier hs-var hs-var">act</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Activation
</span><a href="GHC.Types.Id.html#idInlineActivation"><span class="hs-identifier hs-var">idInlineActivation</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980790"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-4595"></span><span>    </span><span id="local-6989586621682980806"><span class="annot"><span class="annottext">unf_env :: SimplEnv
</span><a href="#local-6989586621682980806"><span class="hs-identifier hs-var hs-var">unf_env</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SimplMode -&gt; SimplMode) -&gt; SimplEnv -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#updMode"><span class="hs-identifier hs-var">updMode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Activation -&gt; SimplMode -&gt; SimplMode
</span><a href="GHC.Core.Opt.Simplify.Utils.html#updModeForStableUnfoldings"><span class="hs-identifier hs-var">updModeForStableUnfoldings</span></a></span><span> </span><span class="annot"><span class="annottext">Activation
</span><a href="#local-6989586621682980829"><span class="hs-identifier hs-var">act</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980788"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-4596"></span><span>         </span><span class="hs-comment">-- See Note [Simplifying inside stable unfoldings] in GHC.Core.Opt.Simplify.Utils</span><span>
</span><span id="line-4597"></span><span>
</span><span id="line-4598"></span><span>    </span><span class="hs-comment">-- See Note [Eta-expand stable unfoldings]</span><span>
</span><span id="line-4599"></span><span>    </span><span class="hs-comment">-- Use the arity from the main Id (in id_arity), rather than computing it from rhs</span><span>
</span><span id="line-4600"></span><span>    </span><span class="hs-comment">-- Not used for join points</span><span>
</span><span id="line-4601"></span><span>    </span><span id="local-6989586621682980818"><span class="annot"><span class="annottext">eta_expand :: CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682980818"><span class="hs-identifier hs-var hs-var">eta_expand</span></a></span></span><span> </span><span id="local-6989586621682980833"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980833"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Env.html#seEtaExpand"><span class="hs-identifier hs-var">seEtaExpand</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980788"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-4602"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Int
</span><a href="GHC.Core.Opt.Arity.html#exprArity"><span class="hs-identifier hs-var">exprArity</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980833"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">ArityType -&gt; Int
</span><a href="GHC.Core.Opt.Arity.html#arityTypeArity"><span class="hs-identifier hs-var">arityTypeArity</span></a></span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621682980792"><span class="hs-identifier hs-var">id_arity</span></a></span><span>
</span><span id="line-4603"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#wantEtaExpansion"><span class="hs-identifier hs-var">wantEtaExpansion</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980833"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-4604"></span><span>                    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; ArityType -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Arity.html#etaExpandAT"><span class="hs-identifier hs-var">etaExpandAT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv -&gt; InScopeSet
</span><a href="GHC.Core.Opt.Simplify.Env.html#getInScope"><span class="hs-identifier hs-var">getInScope</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980788"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621682980792"><span class="hs-identifier hs-var">id_arity</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980833"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-4605"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-4606"></span><span>                    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980833"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-4607"></span><span>
</span><span id="line-4608"></span><span class="hs-comment">{- Note [Eta-expand stable unfoldings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For INLINE/INLINABLE things (which get stable unfoldings) there's a danger
of getting
   f :: Int -&gt; Int -&gt; Int -&gt; Blah
   [ Arity = 3                 -- Good arity
   , Unf=Stable (\xy. blah)    -- Less good arity, only 2
   f = \pqr. e

This can happen because f's RHS is optimised more vigorously than
its stable unfolding.  Now suppose we have a call
   g = f x
Because f has arity=3, g will have arity=2.  But if we inline f (using
its stable unfolding) g's arity will reduce to 1, because &lt;blah&gt;
hasn't been optimised yet.  This happened in the 'parsec' library,
for Text.Pasec.Char.string.

Generally, if we know that 'f' has arity N, it seems sensible to
eta-expand the stable unfolding to arity N too. Simple and consistent.

Wrinkles

* See Historical-note [Eta-expansion in stable unfoldings] in
  GHC.Core.Opt.Simplify.Utils

* Don't eta-expand a trivial expr, else each pass will eta-reduce it,
  and then eta-expand again. See Note [Which RHSs do we eta-expand?]
  in GHC.Core.Opt.Simplify.Utils.

* Don't eta-expand join points; see Note [Do not eta-expand join points]
  in GHC.Core.Opt.Simplify.Utils.  We uphold this because the join-point
  case (bind_cxt = BC_Join {}) doesn't use eta_expand.

Note [Force bottoming field]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We need to force bottoming, or the new unfolding holds
on to the old unfolding (which is part of the id).

Note [Setting the new unfolding]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
* If there's an INLINE pragma, we simplify the RHS gently.  Maybe we
  should do nothing at all, but simplifying gently might get rid of
  more crap.

* If not, we make an unfolding from the new RHS.  But *only* for
  non-loop-breakers. Making loop breakers not have an unfolding at all
  means that we can avoid tests in exprIsConApp, for example.  This is
  important: if exprIsConApp says 'yes' for a recursive thing, then we
  can get into an infinite loop

If there's a stable unfolding on a loop breaker (which happens for
INLINABLE), we hang on to the inlining.  It's pretty dodgy, but the
user did say 'INLINE'.  May need to revisit this choice.

************************************************************************
*                                                                      *
                    Rules
*                                                                      *
************************************************************************

Note [Rules in a letrec]
~~~~~~~~~~~~~~~~~~~~~~~~
After creating fresh binders for the binders of a letrec, we
substitute the RULES and add them back onto the binders; this is done
*before* processing any of the RHSs.  This is important.  Manuel found
cases where he really, really wanted a RULE for a recursive function
to apply in that function's own right-hand side.

See Note [Forming Rec groups] in &quot;GHC.Core.Opt.OccurAnal&quot;
-}</span><span>
</span><span id="line-4678"></span><span>
</span><span id="line-4679"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#addBndrRules"><span class="hs-identifier hs-type">addBndrRules</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InBndr"><span class="hs-identifier hs-type">InBndr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutBndr"><span class="hs-identifier hs-type">OutBndr</span></a></span><span>
</span><span id="line-4680"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BindContext"><span class="hs-identifier hs-type">BindContext</span></a></span><span>
</span><span id="line-4681"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutBndr"><span class="hs-identifier hs-type">OutBndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4682"></span><span class="hs-comment">-- Rules are added back into the bin</span><span>
</span><span id="line-4683"></span><span id="addBndrRules"><span class="annot"><span class="annottext">addBndrRules :: SimplEnv
-&gt; CoreBndr
-&gt; CoreBndr
-&gt; BindContext
-&gt; SimplM (SimplEnv, CoreBndr)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#addBndrRules"><span class="hs-identifier hs-var hs-var">addBndrRules</span></a></span></span><span> </span><span id="local-6989586621682980838"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980838"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980839"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980839"><span class="hs-identifier hs-var">in_id</span></a></span></span><span> </span><span id="local-6989586621682980840"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980840"><span class="hs-identifier hs-var">out_id</span></a></span></span><span> </span><span id="local-6989586621682980841"><span class="annot"><span class="annottext">BindContext
</span><a href="#local-6989586621682980841"><span class="hs-identifier hs-var">bind_cxt</span></a></span></span><span>
</span><span id="line-4684"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[CoreRule] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682980842"><span class="hs-identifier hs-var">old_rules</span></a></span><span>
</span><span id="line-4685"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SimplEnv, CoreBndr) -&gt; SimplM (SimplEnv, CoreBndr)
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980838"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980840"><span class="hs-identifier hs-var">out_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4686"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-4687"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682980843"><span class="annot"><a href="#local-6989586621682980843"><span class="hs-identifier hs-var">new_rules</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; Maybe CoreBndr -&gt; [CoreRule] -&gt; BindContext -&gt; SimplM [CoreRule]
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplRules"><span class="hs-identifier hs-var">simplRules</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980838"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; Maybe CoreBndr
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980840"><span class="hs-identifier hs-var">out_id</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682980842"><span class="hs-identifier hs-var">old_rules</span></a></span><span> </span><span class="annot"><span class="annottext">BindContext
</span><a href="#local-6989586621682980841"><span class="hs-identifier hs-var">bind_cxt</span></a></span><span>
</span><span id="line-4688"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682980845"><span class="annot"><a href="#local-6989586621682980845"><span class="hs-identifier hs-var hs-var">final_id</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980840"><span class="hs-identifier hs-var">out_id</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; RuleInfo -&gt; CoreBndr
</span><a href="GHC.Types.Id.html#setIdSpecialisation"><span class="hs-operator hs-var">`setIdSpecialisation`</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule] -&gt; RuleInfo
</span><a href="GHC.Core.FVs.html#mkRuleInfo"><span class="hs-identifier hs-var">mkRuleInfo</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682980843"><span class="hs-identifier hs-var">new_rules</span></a></span><span>
</span><span id="line-4689"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#modifyInScope"><span class="hs-identifier hs-type">modifyInScope</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980838"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980845"><span class="hs-identifier hs-type">final_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682980845"><span class="hs-identifier hs-type">final_id</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-4690"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-4691"></span><span>    </span><span id="local-6989586621682980842"><span class="annot"><span class="annottext">old_rules :: [CoreRule]
</span><a href="#local-6989586621682980842"><span class="hs-identifier hs-var hs-var">old_rules</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleInfo -&gt; [CoreRule]
</span><a href="GHC.Types.Id.Info.html#ruleInfoRules"><span class="hs-identifier hs-var">ruleInfoRules</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr -&gt; RuleInfo
</span><a href="GHC.Types.Id.html#idSpecialisation"><span class="hs-identifier hs-var">idSpecialisation</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980839"><span class="hs-identifier hs-var">in_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4692"></span><span>
</span><span id="line-4693"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplImpRules"><span class="hs-identifier hs-type">simplImpRules</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-4694"></span><span class="hs-comment">-- Simplify local rules for imported Ids</span><span>
</span><span id="line-4695"></span><span id="simplImpRules"><span class="annot"><span class="annottext">simplImpRules :: SimplEnv -&gt; [CoreRule] -&gt; SimplM [CoreRule]
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplImpRules"><span class="hs-identifier hs-var hs-var">simplImpRules</span></a></span></span><span> </span><span id="local-6989586621682980849"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980849"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980850"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682980850"><span class="hs-identifier hs-var">rules</span></a></span></span><span>
</span><span id="line-4696"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplEnv
-&gt; Maybe CoreBndr -&gt; [CoreRule] -&gt; BindContext -&gt; SimplM [CoreRule]
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplRules"><span class="hs-identifier hs-var">simplRules</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980849"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe CoreBndr
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682980850"><span class="hs-identifier hs-var">rules</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelFlag -&gt; RecFlag -&gt; BindContext
</span><a href="GHC.Core.Opt.Simplify.Utils.html#BC_Let"><span class="hs-identifier hs-var">BC_Let</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="GHC.Types.Basic.html#TopLevel"><span class="hs-identifier hs-var">TopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="GHC.Types.Basic.html#NonRecursive"><span class="hs-identifier hs-var">NonRecursive</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4697"></span><span>
</span><span id="line-4698"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplRules"><span class="hs-identifier hs-type">simplRules</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-4699"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BindContext"><span class="hs-identifier hs-type">BindContext</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-4700"></span><span id="simplRules"><span class="annot"><span class="annottext">simplRules :: SimplEnv
-&gt; Maybe CoreBndr -&gt; [CoreRule] -&gt; BindContext -&gt; SimplM [CoreRule]
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplRules"><span class="hs-identifier hs-var hs-var">simplRules</span></a></span></span><span> </span><span id="local-6989586621682980851"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980851"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682980852"><span class="annot"><span class="annottext">Maybe CoreBndr
</span><a href="#local-6989586621682980852"><span class="hs-identifier hs-var">mb_new_id</span></a></span></span><span> </span><span id="local-6989586621682980853"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682980853"><span class="hs-identifier hs-var">rules</span></a></span></span><span> </span><span id="local-6989586621682980854"><span class="annot"><span class="annottext">BindContext
</span><a href="#local-6989586621682980854"><span class="hs-identifier hs-var">bind_cxt</span></a></span></span><span>
</span><span id="line-4701"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreRule -&gt; SimplM CoreRule) -&gt; [CoreRule] -&gt; SimplM [CoreRule]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">CoreRule -&gt; SimplM CoreRule
</span><a href="#local-6989586621682980855"><span class="hs-identifier hs-var">simpl_rule</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682980853"><span class="hs-identifier hs-var">rules</span></a></span><span>
</span><span id="line-4702"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-4703"></span><span>    </span><span id="local-6989586621682980855"><span class="annot"><span class="annottext">simpl_rule :: CoreRule -&gt; SimplM CoreRule
</span><a href="#local-6989586621682980855"><span class="hs-identifier hs-var hs-var">simpl_rule</span></a></span></span><span> </span><span id="local-6989586621682980856"><span class="annot"><span class="annottext">rule :: CoreRule
</span><a href="#local-6989586621682980856"><span class="hs-identifier hs-var">rule</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#BuiltinRule"><span class="hs-identifier hs-type">BuiltinRule</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-4704"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreRule -&gt; SimplM CoreRule
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682980856"><span class="hs-identifier hs-var">rule</span></a></span><span>
</span><span id="line-4705"></span><span>
</span><span id="line-4706"></span><span>    </span><span class="annot"><a href="#local-6989586621682980855"><span class="hs-identifier hs-var">simpl_rule</span></a></span><span> </span><span id="local-6989586621682980858"><span class="annot"><span class="annottext">rule :: CoreRule
</span><a href="#local-6989586621682980858"><span class="hs-identifier hs-var">rule</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rule"><span class="hs-identifier hs-type">Rule</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ru_bndrs :: CoreRule -&gt; [CoreBndr]
</span><a href="GHC.Core.html#ru_bndrs"><span class="hs-identifier hs-var">ru_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980861"><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980861"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_args :: CoreRule -&gt; [CoreExpr]
</span><a href="GHC.Core.html#ru_args"><span class="hs-identifier hs-var">ru_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980863"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682980863"><span class="hs-identifier hs-var">args</span></a></span></span><span>
</span><span id="line-4707"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_fn :: CoreRule -&gt; Name
</span><a href="GHC.Core.html#ru_fn"><span class="hs-identifier hs-var">ru_fn</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980865"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682980865"><span class="hs-identifier hs-var">fn_name</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_rhs :: CoreRule -&gt; CoreExpr
</span><a href="GHC.Core.html#ru_rhs"><span class="hs-identifier hs-var">ru_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980867"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980867"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-4708"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_act :: CoreRule -&gt; Activation
</span><a href="GHC.Core.html#ru_act"><span class="hs-identifier hs-var">ru_act</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682980869"><span class="annot"><span class="annottext">Activation
</span><a href="#local-6989586621682980869"><span class="hs-identifier hs-var">act</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-4709"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682980870"><span class="annot"><a href="#local-6989586621682980870"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682980871"><span class="annot"><a href="#local-6989586621682980871"><span class="hs-identifier hs-var">bndrs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; [CoreBndr] -&gt; SimplM (SimplEnv, [CoreBndr])
</span><a href="GHC.Core.Opt.Simplify.Env.html#simplBinders"><span class="hs-identifier hs-var">simplBinders</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980851"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBndr]
</span><a href="#local-6989586621682980861"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-4710"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682980872"><span class="annot"><a href="#local-6989586621682980872"><span class="hs-identifier hs-var hs-var">rhs_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; SimplEnv -&gt; Kind -&gt; Kind
SimplEnv -&gt; Kind -&gt; Kind
</span><a href="GHC.Core.Opt.Simplify.Env.html#substTy"><span class="hs-identifier hs-var">substTy</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980870"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; Kind
CoreExpr -&gt; Kind
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682980867"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4711"></span><span>                 </span><span id="local-6989586621682980873"><span class="annot"><a href="#local-6989586621682980873"><span class="hs-identifier hs-var hs-var">rhs_cont</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">BindContext
</span><a href="#local-6989586621682980854"><span class="hs-identifier hs-var">bind_cxt</span></a></span><span> </span><span class="hs-keyword">of</span><span>  </span><span class="hs-comment">-- See Note [Rules and unfolding for join points]</span><span>
</span><span id="line-4712"></span><span>                                </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BC_Let"><span class="hs-identifier hs-type">BC_Let</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Kind -&gt; SimplCont
</span><a href="GHC.Core.Opt.Simplify.Utils.html#mkBoringStop"><span class="hs-identifier hs-var">mkBoringStop</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682980872"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span>
</span><span id="line-4713"></span><span>                                </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#BC_Join"><span class="hs-identifier hs-type">BC_Join</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682980874"><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980874"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; SimplCont -&gt; SimplCont
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682980875"><span class="hs-identifier hs-var">join_ok</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621682980876"><span class="hs-identifier hs-var">bad_join_msg</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCont
</span><a href="#local-6989586621682980874"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-4714"></span><span>                 </span><span id="local-6989586621682980877"><span class="annot"><a href="#local-6989586621682980877"><span class="hs-identifier hs-var hs-var">lhs_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SimplMode -&gt; SimplMode) -&gt; SimplEnv -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#updMode"><span class="hs-identifier hs-var">updMode</span></a></span><span> </span><span class="annot"><span class="annottext">SimplMode -&gt; SimplMode
</span><a href="GHC.Core.Opt.Simplify.Utils.html#updModeForRules"><span class="hs-identifier hs-var">updModeForRules</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980870"><span class="hs-identifier hs-var">env'</span></a></span><span>
</span><span id="line-4715"></span><span>                 </span><span id="local-6989586621682980879"><span class="annot"><a href="#local-6989586621682980879"><span class="hs-identifier hs-var hs-var">rhs_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SimplMode -&gt; SimplMode) -&gt; SimplEnv -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#updMode"><span class="hs-identifier hs-var">updMode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Activation -&gt; SimplMode -&gt; SimplMode
</span><a href="GHC.Core.Opt.Simplify.Utils.html#updModeForStableUnfoldings"><span class="hs-identifier hs-var">updModeForStableUnfoldings</span></a></span><span> </span><span class="annot"><span class="annottext">Activation
</span><a href="#local-6989586621682980869"><span class="hs-identifier hs-var">act</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621682980870"><span class="hs-identifier hs-var">env'</span></a></span><span>
</span><span id="line-4716"></span><span>                           </span><span class="hs-comment">-- See Note [Simplifying the RHS of a RULE]</span><span>
</span><span id="line-4717"></span><span>                 </span><span class="hs-comment">-- Force this to avoid retaining reference to old Id</span><span>
</span><span id="line-4718"></span><span>                 </span><span class="hs-glyph">!</span><span id="local-6989586621682980880"><span class="annot"><a href="#local-6989586621682980880"><span class="hs-identifier hs-var hs-var">fn_name'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe CoreBndr
</span><a href="#local-6989586621682980852"><span class="hs-identifier hs-var">mb_new_id</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4719"></span><span>                              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682980881"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980881"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Name
</span><a href="GHC.Types.Id.html#idName"><span class="hs-identifier hs-var">idName</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980881"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-4720"></span><span>                              </span><span class="annot"><span class="annottext">Maybe CoreBndr
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682980865"><span class="hs-identifier hs-var">fn_name</span></a></span><span>
</span><span id="line-4721"></span><span>
</span><span id="line-4722"></span><span>                 </span><span class="hs-comment">-- join_ok is an assertion check that the join-arity of the</span><span>
</span><span id="line-4723"></span><span>                 </span><span class="hs-comment">-- binder matches that of the rule, so that pushing the</span><span>
</span><span id="line-4724"></span><span>                 </span><span class="hs-comment">-- continuation into the RHS makes sense</span><span>
</span><span id="line-4725"></span><span>                 </span><span id="local-6989586621682980875"><span class="annot"><a href="#local-6989586621682980875"><span class="hs-identifier hs-var hs-var">join_ok</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe CoreBndr
</span><a href="#local-6989586621682980852"><span class="hs-identifier hs-var">mb_new_id</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4726"></span><span>                             </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682980882"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980882"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#JoinPoint"><span class="hs-identifier hs-type">JoinPoint</span></a></span><span> </span><span id="local-6989586621682980883"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682980883"><span class="hs-identifier hs-var">join_arity</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; JoinPointHood
</span><a href="GHC.Types.Id.html#idJoinPointHood"><span class="hs-identifier hs-var">idJoinPointHood</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682980882"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-4727"></span><span>                                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[CoreExpr] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682980863"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682980883"><span class="hs-identifier hs-var">join_arity</span></a></span><span>
</span><span id="line-4728"></span><span>                             </span><span class="annot"><span class="annottext">Maybe CoreBndr
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-4729"></span><span>                 </span><span id="local-6989586621682980876"><span class="annot"><a href="#local-6989586621682980876"><span class="hs-identifier hs-var hs-var">bad_join_msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Maybe CoreBndr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe CoreBndr
</span><a href="#local-6989586621682980852"><span class="hs-identifier hs-var">mb_new_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreRule -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682980858"><span class="hs-identifier hs-var">rule</span></a></span><span>
</span><span id="line-4730"></span><span>                                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe JoinPointHood -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CoreBndr -&gt; JoinPointHood)
-&gt; Maybe CoreBndr -&gt; Maybe JoinPointHood
forall a b. (a -&gt; b) -&gt; Maybe a -&gt; Maybe b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; JoinPointHood
</span><a href="GHC.Types.Id.html#idJoinPointHood"><span class="hs-identifier hs-var">idJoinPointHood</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe CoreBndr
</span><a href="#local-6989586621682980852"><span class="hs-identifier hs-var">mb_new_id</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-4731"></span><span>
</span><span id="line-4732"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682980884"><span class="annot"><a href="#local-6989586621682980884"><span class="hs-identifier hs-var">args'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExpr"><span class="hs-identifier hs-type">simplExpr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980877"><span class="hs-identifier hs-type">lhs_env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682980863"><span class="hs-identifier hs-type">args</span></a></span><span>
</span><span id="line-4733"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682980885"><span class="annot"><a href="#local-6989586621682980885"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExprC"><span class="hs-identifier hs-type">simplExprC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980879"><span class="hs-identifier hs-type">rhs_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980867"><span class="hs-identifier hs-type">rhs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980873"><span class="hs-identifier hs-type">rhs_cont</span></a></span><span>
</span><span id="line-4734"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682980858"><span class="hs-identifier hs-type">rule</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.html#ru_bndrs"><span class="hs-identifier hs-var">ru_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682980871"><span class="hs-identifier hs-type">bndrs'</span></a></span><span>
</span><span id="line-4735"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#ru_fn"><span class="hs-identifier hs-var">ru_fn</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682980880"><span class="hs-identifier hs-type">fn_name'</span></a></span><span>
</span><span id="line-4736"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#ru_args"><span class="hs-identifier hs-var">ru_args</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682980884"><span class="hs-identifier hs-type">args'</span></a></span><span>
</span><span id="line-4737"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#ru_rhs"><span class="hs-identifier hs-var">ru_rhs</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occurAnalyseExpr"><span class="hs-identifier hs-type">occurAnalyseExpr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682980885"><span class="hs-identifier hs-type">rhs'</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-4738"></span><span>                            </span><span class="hs-comment">-- Remember to occ-analyse, to drop dead code.</span><span>
</span><span id="line-4739"></span><span>                            </span><span class="hs-comment">-- See Note [OccInfo in unfoldings and rules] in GHC.Core</span><span>
</span><span id="line-4740"></span><span>
</span><span id="line-4741"></span><span class="hs-comment">{- Note [Simplifying the RHS of a RULE]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We can simplify the RHS of a RULE much as we do the RHS of a stable
unfolding.  We used to use the much more conservative updModeForRules
for the RHS as well as the LHS, but that seems more conservative
than necesary.  Allowing some inlining might, for example, eliminate
a binding.
-}</span><span>
</span><span id="line-4749"></span></pre></body></html>