<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE TupleSections       #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE RecursiveDo         #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE MultiWayIf          #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards     #-}</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998
-}</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="annot"><span class="hs-comment">-- | Type subsumption and unification</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html"><span class="hs-identifier">GHC.Tc.Utils.Unify</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-14"></span><span>  </span><span class="hs-comment">-- Full-blown subsumption</span><span>
</span><span id="line-15"></span><span>  </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcWrapResult"><span class="hs-identifier">tcWrapResult</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcWrapResultO"><span class="hs-identifier">tcWrapResultO</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcWrapResultMono"><span class="hs-identifier">tcWrapResultMono</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>  </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcSubType"><span class="hs-identifier">tcSubType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcSubTypeSigma"><span class="hs-identifier">tcSubTypeSigma</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcSubTypePat"><span class="hs-identifier">tcSubTypePat</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcSubTypeDS"><span class="hs-identifier">tcSubTypeDS</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>  </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcSubTypeAmbiguity"><span class="hs-identifier">tcSubTypeAmbiguity</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcSubMult"><span class="hs-identifier">tcSubMult</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcSubMult%27"><span class="hs-identifier">tcSubMult'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>  </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#checkConstraints"><span class="hs-identifier">checkConstraints</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#checkTvConstraints"><span class="hs-identifier">checkTvConstraints</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>  </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#buildImplicationFor"><span class="hs-identifier">buildImplicationFor</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#buildTvImplication"><span class="hs-identifier">buildTvImplication</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#emitResidualTvConstraint"><span class="hs-identifier">emitResidualTvConstraint</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>
</span><span id="line-21"></span><span>  </span><span class="hs-comment">-- Skolemisation</span><span>
</span><span id="line-22"></span><span>  </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#DeepSubsumptionFlag"><span class="hs-identifier">DeepSubsumptionFlag</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#getDeepSubsumptionFlag"><span class="hs-identifier">getDeepSubsumptionFlag</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#isRhoTyDS"><span class="hs-identifier">isRhoTyDS</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-23"></span><span>  </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcSkolemise"><span class="hs-identifier">tcSkolemise</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcSkolemiseCompleteSig"><span class="hs-identifier">tcSkolemiseCompleteSig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcSkolemiseExpectedType"><span class="hs-identifier">tcSkolemiseExpectedType</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-24"></span><span>
</span><span id="line-25"></span><span>  </span><span class="hs-comment">-- Various unifications</span><span>
</span><span id="line-26"></span><span>  </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#unifyType"><span class="hs-identifier">unifyType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#unifyKind"><span class="hs-identifier">unifyKind</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#unifyInvisibleType"><span class="hs-identifier">unifyInvisibleType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#unifyExpectedType"><span class="hs-identifier">unifyExpectedType</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-27"></span><span>  </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#unifyExprType"><span class="hs-identifier">unifyExprType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#unifyTypeAndEmit"><span class="hs-identifier">unifyTypeAndEmit</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#promoteTcType"><span class="hs-identifier">promoteTcType</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-28"></span><span>  </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#swapOverTyVars"><span class="hs-identifier">swapOverTyVars</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#touchabilityAndShapeTest"><span class="hs-identifier">touchabilityAndShapeTest</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#checkTopShape"><span class="hs-identifier">checkTopShape</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#lhsPriority"><span class="hs-identifier">lhsPriority</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>  </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#UnifyEnv"><span class="hs-identifier">UnifyEnv</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#updUEnvLoc"><span class="hs-identifier">updUEnvLoc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#setUEnvRole"><span class="hs-identifier">setUEnvRole</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>  </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#uType"><span class="hs-identifier">uType</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-31"></span><span>
</span><span id="line-32"></span><span>  </span><span class="hs-comment">--------------------------------</span><span>
</span><span id="line-33"></span><span>  </span><span class="hs-comment">-- Holes</span><span>
</span><span id="line-34"></span><span>  </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#tcInfer"><span class="hs-identifier">tcInfer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-35"></span><span>  </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#matchExpectedListTy"><span class="hs-identifier">matchExpectedListTy</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-36"></span><span>  </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#matchExpectedTyConApp"><span class="hs-identifier">matchExpectedTyConApp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-37"></span><span>  </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#matchExpectedAppTy"><span class="hs-identifier">matchExpectedAppTy</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-38"></span><span>  </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#matchExpectedFunTys"><span class="hs-identifier">matchExpectedFunTys</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-39"></span><span>  </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#matchExpectedFunKind"><span class="hs-identifier">matchExpectedFunKind</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-40"></span><span>  </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#matchActualFunTy"><span class="hs-identifier">matchActualFunTy</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#matchActualFunTys"><span class="hs-identifier">matchActualFunTys</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-41"></span><span>
</span><span id="line-42"></span><span>  </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#checkTyEqRhs"><span class="hs-identifier">checkTyEqRhs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#recurseIntoTyConApp"><span class="hs-identifier">recurseIntoTyConApp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-43"></span><span>  </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuResult"><span class="hs-identifier">PuResult</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#failCheckWith"><span class="hs-identifier">failCheckWith</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#okCheckRefl"><span class="hs-identifier">okCheckRefl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#mapCheck"><span class="hs-identifier">mapCheck</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-44"></span><span>  </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#TyEqFlags"><span class="hs-identifier">TyEqFlags</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#TyEqFamApp"><span class="hs-identifier">TyEqFamApp</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#AreUnifying"><span class="hs-identifier">AreUnifying</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#LevelCheck"><span class="hs-identifier">LevelCheck</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#FamAppBreaker"><span class="hs-identifier">FamAppBreaker</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-45"></span><span>  </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#famAppArgFlags"><span class="hs-identifier">famAppArgFlags</span></a></span><span class="hs-special">,</span><span>  </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#checkPromoteFreeVars"><span class="hs-identifier">checkPromoteFreeVars</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-46"></span><span>  </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#simpleUnifyCheck"><span class="hs-identifier">simpleUnifyCheck</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#UnifyCheckCaller"><span class="hs-identifier">UnifyCheckCaller</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span>  </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#fillInferResult"><span class="hs-identifier">fillInferResult</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-49"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-50"></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-52"></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Hs.html"><span class="hs-identifier">GHC.Hs</span></a></span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Concrete.html"><span class="hs-identifier">GHC.Tc.Utils.Concrete</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Concrete.html#hasFixedRuntimeRep"><span class="hs-identifier">hasFixedRuntimeRep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Concrete.html#hasFixedRuntimeRep_syntactic"><span class="hs-identifier">hasFixedRuntimeRep_syntactic</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Env.html"><span class="hs-identifier">GHC.Tc.Utils.Env</span></a></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Instantiate.html"><span class="hs-identifier">GHC.Tc.Utils.Instantiate</span></a></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html"><span class="hs-identifier">GHC.Tc.Utils.Monad</span></a></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html"><span class="hs-identifier">GHC.Tc.Utils.TcMType</span></a></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html"><span class="hs-identifier">GHC.Tc.Utils.TcType</span></a></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html"><span class="hs-identifier">GHC.Tc.Types.Evidence</span></a></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html"><span class="hs-identifier">GHC.Tc.Types.Constraint</span></a></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Types.CtLoc.html"><span class="hs-identifier">GHC.Tc.Types.CtLoc</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Tc.Types.CtLoc.html#CtLoc"><span class="hs-identifier">CtLoc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.CtLoc.html#mkKindEqLoc"><span class="hs-identifier">mkKindEqLoc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.CtLoc.html#adjustCtLoc"><span class="hs-identifier">adjustCtLoc</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html"><span class="hs-identifier">GHC.Tc.Types.Origin</span></a></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Zonk.TcType.html"><span class="hs-identifier">GHC.Tc.Zonk.TcType</span></a></span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Type.html"><span class="hs-identifier">GHC.Core.Type</span></a></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html"><span class="hs-identifier">GHC.Core.TyCo.Rep</span></a></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.FVs.html"><span class="hs-identifier">GHC.Core.TyCo.FVs</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.FVs.html#isInjectiveInType"><span class="hs-identifier">isInjectiveInType</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Ppr.html"><span class="hs-identifier">GHC.Core.TyCo.Ppr</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Ppr.html#debugPprType"><span class="hs-identifier">debugPprType</span></a></span><span> </span><span class="hs-comment">{- pprTyVar -}</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html"><span class="hs-identifier">GHC.Core.TyCon</span></a></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html"><span class="hs-identifier">GHC.Core.Coercion</span></a></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Multiplicity.html"><span class="hs-identifier">GHC.Core.Multiplicity</span></a></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html"><span class="hs-identifier">GHC.Core.Reduction</span></a></span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../ghc-boot-9.12.2-1a37/src/GHC.LanguageExtensions.html"><span class="hs-identifier">GHC.LanguageExtensions</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LangExt</span></span><span>
</span><span id="line-77"></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.html"><span class="hs-identifier">GHC.Builtin.Types</span></a></span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.html"><span class="hs-identifier">GHC.Types.Name</span></a></span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.html"><span class="hs-identifier">GHC.Types.Id</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Id.html#idType"><span class="hs-identifier">idType</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.html"><span class="hs-identifier">GHC.Types.Var</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Var</span></span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html"><span class="hs-identifier">GHC.Types.Var.Set</span></a></span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html"><span class="hs-identifier">GHC.Types.Var.Env</span></a></span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html"><span class="hs-identifier">GHC.Types.Basic</span></a></span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Set.html"><span class="hs-identifier">GHC.Types.Unique.Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Unique.Set.html#nonDetEltsUniqSet"><span class="hs-identifier">nonDetEltsUniqSet</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Error.html"><span class="hs-identifier">GHC.Utils.Error</span></a></span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>
</span><span id="line-89"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Outputable</span></span><span>
</span><span id="line-90"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-91"></span><span>
</span><span id="line-92"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.DynFlags.html"><span class="hs-identifier">GHC.Driver.DynFlags</span></a></span><span>
</span><span id="line-93"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Bag.html"><span class="hs-identifier">GHC.Data.Bag</span></a></span><span>
</span><span id="line-94"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html"><span class="hs-identifier">GHC.Data.FastString</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier">fsLit</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-95"></span><span>
</span><span id="line-96"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span>
</span><span id="line-97"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.Monoid.html"><span class="hs-identifier">Data.Monoid</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DM</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">Any</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.Semigroup.html"><span class="hs-identifier">Data.Semigroup</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-operator">(&lt;&gt;)</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span class="annot"><span class="hs-comment">{- *********************************************************************
*                                                                      *
              matchActualFunTys
*                                                                      *
********************************************************************* -}</span></span><span>
</span><span id="line-105"></span><span>
</span><span id="line-106"></span><span class="hs-comment">-- | 'matchActualFunTy' looks for just one function arrow,</span><span>
</span><span id="line-107"></span><span class="hs-comment">-- returning an uninstantiated sigma-type.</span><span>
</span><span id="line-108"></span><span class="hs-comment">--</span><span>
</span><span id="line-109"></span><span class="hs-comment">-- Invariant: the returned argument type has a syntactically fixed</span><span>
</span><span id="line-110"></span><span class="hs-comment">-- RuntimeRep in the sense of Note [Fixed RuntimeRep]</span><span>
</span><span id="line-111"></span><span class="hs-comment">-- in GHC.Tc.Utils.Concrete.</span><span>
</span><span id="line-112"></span><span class="hs-comment">--</span><span>
</span><span id="line-113"></span><span class="hs-comment">-- See Note [Return arguments with a fixed RuntimeRep].</span><span>
</span><span id="line-114"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#matchActualFunTy"><span class="hs-identifier hs-type">matchActualFunTy</span></a></span><span>
</span><span id="line-115"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#ExpectedFunTyOrigin"><span class="hs-identifier hs-type">ExpectedFunTyOrigin</span></a></span><span>
</span><span id="line-116"></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ See Note [Herald for matchExpectedFunTys]</span></span><span>
</span><span id="line-117"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#TypedThing"><span class="hs-identifier hs-type">TypedThing</span></a></span><span>
</span><span id="line-118"></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ The thing with type TcSigmaType</span></span><span>
</span><span id="line-119"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-120"></span><span>      </span><span class="hs-comment">-- ^ Total number of value args in the call, and</span><span>
</span><span id="line-121"></span><span>      </span><span class="hs-comment">--   the original function type</span><span>
</span><span id="line-122"></span><span>      </span><span class="hs-comment">-- (Both are used only for error messages)</span><span>
</span><span id="line-123"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcRhoType"><span class="hs-identifier hs-type">TcRhoType</span></a></span><span>
</span><span id="line-124"></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ Type to analyse: a TcRhoType</span></span><span>
</span><span id="line-125"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Scaled"><span class="hs-identifier hs-type">Scaled</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcSigmaTypeFRR"><span class="hs-identifier hs-type">TcSigmaTypeFRR</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-126"></span><span class="hs-comment">-- This function takes in a type to analyse (a RhoType) and returns</span><span>
</span><span id="line-127"></span><span class="hs-comment">-- an argument type and a result type (splitting apart a function arrow).</span><span>
</span><span id="line-128"></span><span class="hs-comment">-- The returned argument type is a SigmaType with a fixed RuntimeRep;</span><span>
</span><span id="line-129"></span><span class="hs-comment">-- as explained in Note [Return arguments with a fixed RuntimeRep].</span><span>
</span><span id="line-130"></span><span class="hs-comment">--</span><span>
</span><span id="line-131"></span><span class="hs-comment">-- See Note [matchActualFunTy error handling] for the first three arguments</span><span>
</span><span id="line-132"></span><span>
</span><span id="line-133"></span><span class="hs-comment">-- If   (wrap, arg_ty, res_ty) = matchActualFunTy ... fun_ty</span><span>
</span><span id="line-134"></span><span class="hs-comment">-- then wrap :: fun_ty ~&gt; (arg_ty -&gt; res_ty)</span><span>
</span><span id="line-135"></span><span class="hs-comment">-- and NB: res_ty is an (uninstantiated) SigmaType</span><span>
</span><span id="line-136"></span><span>
</span><span id="line-137"></span><span id="matchActualFunTy"><span class="annot"><span class="annottext">matchActualFunTy :: ExpectedFunTyOrigin
-&gt; Maybe TypedThing
-&gt; (Int, TcType)
-&gt; TcType
-&gt; TcM (HsWrapper, Scaled TcType, TcType)
</span><a href="GHC.Tc.Utils.Unify.html#matchActualFunTy"><span class="hs-identifier hs-var hs-var">matchActualFunTy</span></a></span></span><span> </span><span id="local-6989586621683017940"><span class="annot"><span class="annottext">ExpectedFunTyOrigin
</span><a href="#local-6989586621683017940"><span class="hs-identifier hs-var">herald</span></a></span></span><span> </span><span id="local-6989586621683017941"><span class="annot"><span class="annottext">Maybe TypedThing
</span><a href="#local-6989586621683017941"><span class="hs-identifier hs-var">mb_thing</span></a></span></span><span> </span><span id="local-6989586621683017942"><span class="annot"><span class="annottext">(Int, TcType)
</span><a href="#local-6989586621683017942"><span class="hs-identifier hs-var">err_info</span></a></span></span><span> </span><span id="local-6989586621683017943"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683017943"><span class="hs-identifier hs-var">fun_ty</span></a></span></span><span>
</span><span id="line-138"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; SDoc
-&gt; TcM (HsWrapper, Scaled TcType, TcType)
-&gt; TcM (HsWrapper, Scaled TcType, TcType)
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isRhoTy"><span class="hs-identifier hs-var">isRhoTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683017943"><span class="hs-identifier hs-var">fun_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683017943"><span class="hs-identifier hs-var">fun_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcM (HsWrapper, Scaled TcType, TcType)
 -&gt; TcM (HsWrapper, Scaled TcType, TcType))
-&gt; TcM (HsWrapper, Scaled TcType, TcType)
-&gt; TcM (HsWrapper, Scaled TcType, TcType)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-139"></span><span>    </span><span class="annot"><span class="annottext">TcType -&gt; TcM (HsWrapper, Scaled TcType, TcType)
</span><a href="#local-6989586621683017947"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683017943"><span class="hs-identifier hs-var">fun_ty</span></a></span><span>
</span><span id="line-140"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-141"></span><span>    </span><span class="hs-comment">-- Does not allocate unnecessary meta variables: if the input already is</span><span>
</span><span id="line-142"></span><span>    </span><span class="hs-comment">-- a function, we just take it apart.  Not only is this efficient,</span><span>
</span><span id="line-143"></span><span>    </span><span class="hs-comment">-- it's important for higher rank: the argument might be of form</span><span>
</span><span id="line-144"></span><span>    </span><span class="hs-comment">--              (forall a. ty) -&gt; other</span><span>
</span><span id="line-145"></span><span>    </span><span class="hs-comment">-- If allocated (fresh-meta-var1 -&gt; fresh-meta-var2) and unified, we'd</span><span>
</span><span id="line-146"></span><span>    </span><span class="hs-comment">-- hide the forall inside a meta-variable</span><span>
</span><span id="line-147"></span><span>    </span><span class="annot"><a href="#local-6989586621683017947"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcRhoType"><span class="hs-identifier hs-type">TcRhoType</span></a></span><span>   </span><span class="hs-comment">-- The type we're processing, perhaps after</span><span>
</span><span id="line-148"></span><span>                      </span><span class="hs-comment">-- expanding type synonyms</span><span>
</span><span id="line-149"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Scaled"><span class="hs-identifier hs-type">Scaled</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcSigmaTypeFRR"><span class="hs-identifier hs-type">TcSigmaTypeFRR</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-150"></span><span>    </span><span id="local-6989586621683017947"><span class="annot"><span class="annottext">go :: TcType -&gt; TcM (HsWrapper, Scaled TcType, TcType)
</span><a href="#local-6989586621683017947"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621683017948"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683017948"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683017949"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683017949"><span class="hs-identifier hs-var">ty'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe TcType
</span><a href="GHC.Core.Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683017948"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcM (HsWrapper, Scaled TcType, TcType)
</span><a href="#local-6989586621683017947"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683017949"><span class="hs-identifier hs-var">ty'</span></a></span><span>
</span><span id="line-151"></span><span>
</span><span id="line-152"></span><span>    </span><span class="annot"><a href="#local-6989586621683017947"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#FunTy"><span class="hs-identifier hs-type">FunTy</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ft_af :: TcType -&gt; FunTyFlag
</span><a href="GHC.Core.TyCo.Rep.html#ft_af"><span class="hs-identifier hs-var">ft_af</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683017953"><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683017953"><span class="hs-identifier hs-var">af</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_mult :: TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#ft_mult"><span class="hs-identifier hs-var">ft_mult</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683017955"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683017955"><span class="hs-identifier hs-var">w</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_arg :: TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#ft_arg"><span class="hs-identifier hs-var">ft_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683017957"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683017957"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_res :: TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#ft_res"><span class="hs-identifier hs-var">ft_res</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683017959"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683017959"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-153"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; TcM (HsWrapper, Scaled TcType, TcType)
-&gt; TcM (HsWrapper, Scaled TcType, TcType)
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FunTyFlag -&gt; Bool
</span><a href="GHC.Types.Var.html#isVisibleFunArg"><span class="hs-identifier hs-var">isVisibleFunArg</span></a></span><span> </span><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683017953"><span class="hs-identifier hs-var">af</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcM (HsWrapper, Scaled TcType, TcType)
 -&gt; TcM (HsWrapper, Scaled TcType, TcType))
-&gt; TcM (HsWrapper, Scaled TcType, TcType)
-&gt; TcM (HsWrapper, Scaled TcType, TcType)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-154"></span><span>      </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; FixedRuntimeRepContext -&gt; TcType -&gt; TcM ()
FixedRuntimeRepContext -&gt; TcType -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Concrete.html#hasFixedRuntimeRep_syntactic"><span class="hs-identifier hs-var">hasFixedRuntimeRep_syntactic</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExpectedFunTyOrigin -&gt; Int -&gt; FixedRuntimeRepContext
</span><a href="GHC.Tc.Types.Origin.html#FRRExpectedFunTy"><span class="hs-identifier hs-var">FRRExpectedFunTy</span></a></span><span> </span><span class="annot"><span class="annottext">ExpectedFunTyOrigin
</span><a href="#local-6989586621683017940"><span class="hs-identifier hs-var">herald</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683017957"><span class="hs-identifier hs-var">arg_ty</span></a></span><span>
</span><span id="line-155"></span><span>         </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(HsWrapper, Scaled TcType, TcType)
-&gt; TcM (HsWrapper, Scaled TcType, TcType)
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HsWrapper
</span><a href="GHC.Tc.Types.Evidence.html#idHsWrapper"><span class="hs-identifier hs-var">idHsWrapper</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; Scaled TcType
forall a. TcType -&gt; a -&gt; Scaled a
</span><a href="GHC.Core.TyCo.Rep.html#Scaled"><span class="hs-identifier hs-var">Scaled</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683017955"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683017957"><span class="hs-identifier hs-var">arg_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683017959"><span class="hs-identifier hs-var">res_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-156"></span><span>
</span><span id="line-157"></span><span>    </span><span class="annot"><a href="#local-6989586621683017947"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683017965"><span class="annot"><span class="annottext">ty :: TcType
</span><a href="#local-6989586621683017965"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyVarTy"><span class="hs-identifier hs-type">TyVarTy</span></a></span><span> </span><span id="local-6989586621683017967"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683017967"><span class="hs-identifier hs-var">tv</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isMetaTyVar"><span class="hs-identifier hs-var">isMetaTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683017967"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-159"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683017969"><span class="annot"><a href="#local-6989586621683017969"><span class="hs-identifier hs-var">cts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; IOEnv (Env TcGblEnv TcLclEnv) MetaDetails
forall (m :: * -&gt; *). MonadIO m =&gt; TcTyVar -&gt; m MetaDetails
</span><a href="GHC.Tc.Utils.TcMType.html#readMetaTyVar"><span class="hs-identifier hs-var">readMetaTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683017967"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-160"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683017969"><span class="hs-identifier hs-type">cts</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-161"></span><span>               </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#Indirect"><span class="hs-identifier hs-type">Indirect</span></a></span><span> </span><span id="local-6989586621683017972"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683017972"><span class="hs-identifier hs-var">ty'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcM (HsWrapper, Scaled TcType, TcType)
</span><a href="#local-6989586621683017947"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683017972"><span class="hs-identifier hs-var">ty'</span></a></span><span>
</span><span id="line-162"></span><span>               </span><span class="annot"><span class="annottext">MetaDetails
</span><a href="GHC.Tc.Utils.TcType.html#Flexi"><span class="hs-identifier hs-var">Flexi</span></a></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcM (HsWrapper, Scaled TcType, TcType)
</span><a href="#local-6989586621683017974"><span class="hs-identifier hs-var">defer</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683017965"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-163"></span><span>
</span><span id="line-164"></span><span>       </span><span class="hs-comment">-- In all other cases we bale out into ordinary unification</span><span>
</span><span id="line-165"></span><span>       </span><span class="hs-comment">-- However unlike the meta-tyvar case, we are sure that the</span><span>
</span><span id="line-166"></span><span>       </span><span class="hs-comment">-- number of arguments doesn't match arity of the original</span><span>
</span><span id="line-167"></span><span>       </span><span class="hs-comment">-- type, so we can add a bit more context to the error message</span><span>
</span><span id="line-168"></span><span>       </span><span class="hs-comment">-- (cf #7869).</span><span>
</span><span id="line-169"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-170"></span><span>       </span><span class="hs-comment">-- It is not always an error, because specialized type may have</span><span>
</span><span id="line-171"></span><span>       </span><span class="hs-comment">-- different arity, for example:</span><span>
</span><span id="line-172"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-173"></span><span>       </span><span class="hs-comment">-- &gt; f1 = f2 'a'</span><span>
</span><span id="line-174"></span><span>       </span><span class="hs-comment">-- &gt; f2 :: Monad m =&gt; m Bool</span><span>
</span><span id="line-175"></span><span>       </span><span class="hs-comment">-- &gt; f2 = undefined</span><span>
</span><span id="line-176"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-177"></span><span>       </span><span class="hs-comment">-- But in that case we add specialized type into error context</span><span>
</span><span id="line-178"></span><span>       </span><span class="hs-comment">-- anyway, because it may be useful. See also #9605.</span><span>
</span><span id="line-179"></span><span>    </span><span class="annot"><a href="#local-6989586621683017947"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683017975"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683017975"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TidyEnv -&gt; ZonkM (TidyEnv, SDoc))
-&gt; TcM (HsWrapper, Scaled TcType, TcType)
-&gt; TcM (HsWrapper, Scaled TcType, TcType)
forall a. (TidyEnv -&gt; ZonkM (TidyEnv, SDoc)) -&gt; TcM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#addErrCtxtM"><span class="hs-identifier hs-var">addErrCtxtM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; TidyEnv -&gt; ZonkM (TidyEnv, SDoc)
</span><a href="#local-6989586621683017977"><span class="hs-identifier hs-var">mk_ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683017975"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; TcM (HsWrapper, Scaled TcType, TcType)
</span><a href="#local-6989586621683017974"><span class="hs-identifier hs-var">defer</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683017975"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-180"></span><span>
</span><span id="line-181"></span><span>    </span><span class="hs-comment">------------</span><span>
</span><span id="line-182"></span><span>    </span><span id="local-6989586621683017974"><span class="annot"><span class="annottext">defer :: TcType -&gt; TcM (HsWrapper, Scaled TcType, TcType)
</span><a href="#local-6989586621683017974"><span class="hs-identifier hs-var hs-var">defer</span></a></span></span><span> </span><span id="local-6989586621683017978"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683017978"><span class="hs-identifier hs-var">fun_ty</span></a></span></span><span>
</span><span id="line-183"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683017979"><span class="annot"><a href="#local-6989586621683017979"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ExpectedFunTyOrigin -&gt; Int -&gt; TcM (Scaled TcType)
</span><a href="GHC.Tc.Utils.Unify.html#new_check_arg_ty"><span class="hs-identifier hs-var">new_check_arg_ty</span></a></span><span> </span><span class="annot"><span class="annottext">ExpectedFunTyOrigin
</span><a href="#local-6989586621683017940"><span class="hs-identifier hs-var">herald</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-184"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683017981"><span class="annot"><a href="#local-6989586621683017981"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#newOpenFlexiTyVarTy"><span class="hs-identifier hs-type">newOpenFlexiTyVarTy</span></a></span><span>
</span><span id="line-185"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683017983"><span class="annot"><a href="#local-6989586621683017983"><span class="hs-identifier hs-var hs-var">unif_fun_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Scaled TcType] -&gt; TcType -&gt; TcType
HasDebugCallStack =&gt; [Scaled TcType] -&gt; TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#mkScaledFunTys"><span class="hs-identifier hs-var">mkScaledFunTys</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Scaled TcType
</span><a href="#local-6989586621683017979"><span class="hs-identifier hs-var">arg_ty</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683017981"><span class="hs-identifier hs-var">res_ty</span></a></span><span>
</span><span id="line-186"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683017985"><span class="annot"><a href="#local-6989586621683017985"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#unifyType"><span class="hs-identifier hs-type">unifyType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017941"><span class="hs-identifier hs-type">mb_thing</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017978"><span class="hs-identifier hs-type">fun_ty</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017983"><span class="hs-identifier hs-type">unif_fun_ty</span></a></span><span>
</span><span id="line-187"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#mkWpCastN"><span class="hs-identifier hs-type">mkWpCastN</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017985"><span class="hs-identifier hs-type">co</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683017979"><span class="hs-identifier hs-type">arg_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683017981"><span class="hs-identifier hs-type">res_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-188"></span><span>
</span><span id="line-189"></span><span>    </span><span class="hs-comment">------------</span><span>
</span><span id="line-190"></span><span>    </span><span class="annot"><a href="#local-6989586621683017977"><span class="hs-identifier hs-type">mk_ctxt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Zonk.Monad.html#ZonkM"><span class="hs-identifier hs-type">ZonkM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.Env.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span>    </span><span id="local-6989586621683017977"><span class="annot"><span class="annottext">mk_ctxt :: TcType -&gt; TidyEnv -&gt; ZonkM (TidyEnv, SDoc)
</span><a href="#local-6989586621683017977"><span class="hs-identifier hs-var hs-var">mk_ctxt</span></a></span></span><span> </span><span id="local-6989586621683017987"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683017987"><span class="hs-identifier hs-var">_res_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExpectedFunTyOrigin
-&gt; (Int, TcType) -&gt; TidyEnv -&gt; ZonkM (TidyEnv, SDoc)
</span><a href="GHC.Tc.Utils.Unify.html#mkFunTysMsg"><span class="hs-identifier hs-var">mkFunTysMsg</span></a></span><span> </span><span class="annot"><span class="annottext">ExpectedFunTyOrigin
</span><a href="#local-6989586621683017940"><span class="hs-identifier hs-var">herald</span></a></span><span> </span><span class="annot"><span class="annottext">(Int, TcType)
</span><a href="#local-6989586621683017942"><span class="hs-identifier hs-var">err_info</span></a></span><span>
</span><span id="line-192"></span><span>
</span><span id="line-193"></span><span class="hs-comment">{- Note [matchActualFunTy error handling]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
matchActualFunTy is made much more complicated by the
desire to produce good error messages. Consider the application
    f @Int x y
In GHC.Tc.Gen.Head.tcInstFun we instantiate the function type, one
argument at a time.  It must instantiate any type/dictionary args,
before looking for an arrow type.

But if it doesn't find an arrow type, it wants to generate a message
like &quot;f is applied to two arguments but its type only has one&quot;.
To do that, it needs to know about the args that tcArgs has already
munched up -- hence passing in n_val_args_in_call and arg_tys_so_far;
and hence also the accumulating so_far arg to 'go'.

This allows us (in mk_ctxt) to construct f's /instantiated/ type,
with just the values-arg arrows, which is what we really want
in the error message.

Ugh!
-}</span><span>
</span><span id="line-214"></span><span>
</span><span id="line-215"></span><span class="hs-comment">-- | Like 'matchExpectedFunTys', but used when you have an &quot;actual&quot; type,</span><span>
</span><span id="line-216"></span><span class="hs-comment">-- for example in function application.</span><span>
</span><span id="line-217"></span><span class="hs-comment">--</span><span>
</span><span id="line-218"></span><span class="hs-comment">-- INVARIANT: the returned argument types all have a syntactically fixed RuntimeRep</span><span>
</span><span id="line-219"></span><span class="hs-comment">-- in the sense of Note [Fixed RuntimeRep] in GHC.Tc.Utils.Concrete.</span><span>
</span><span id="line-220"></span><span class="hs-comment">-- See Note [Return arguments with a fixed RuntimeRep].</span><span>
</span><span id="line-221"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#matchActualFunTys"><span class="hs-identifier hs-type">matchActualFunTys</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#ExpectedFunTyOrigin"><span class="hs-identifier hs-type">ExpectedFunTyOrigin</span></a></span><span> </span><span class="annot"><span class="hs-comment">-- ^ See Note [Herald for matchExpectedFunTys]</span></span><span>
</span><span id="line-222"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a></span><span>
</span><span id="line-223"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span>
</span><span id="line-224"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a></span><span>
</span><span id="line-225"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Scaled"><span class="hs-identifier hs-type">Scaled</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcSigmaTypeFRR"><span class="hs-identifier hs-type">TcSigmaTypeFRR</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcRhoType"><span class="hs-identifier hs-type">TcRhoType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-226"></span><span class="hs-comment">-- If    matchActualFunTys n ty = (wrap, [t1,..,tn], res_ty)</span><span>
</span><span id="line-227"></span><span class="hs-comment">-- then  wrap : ty ~&gt; (t1 -&gt; ... -&gt; tn -&gt; res_ty)</span><span>
</span><span id="line-228"></span><span class="hs-comment">--       and res_ty is a RhoType</span><span>
</span><span id="line-229"></span><span class="hs-comment">-- NB: the returned type is top-instantiated; it's a RhoType</span><span>
</span><span id="line-230"></span><span id="matchActualFunTys"><span class="annot"><span class="annottext">matchActualFunTys :: ExpectedFunTyOrigin
-&gt; CtOrigin
-&gt; Int
-&gt; TcType
-&gt; TcM (HsWrapper, [Scaled TcType], TcType)
</span><a href="GHC.Tc.Utils.Unify.html#matchActualFunTys"><span class="hs-identifier hs-var hs-var">matchActualFunTys</span></a></span></span><span> </span><span id="local-6989586621683017989"><span class="annot"><span class="annottext">ExpectedFunTyOrigin
</span><a href="#local-6989586621683017989"><span class="hs-identifier hs-var">herald</span></a></span></span><span> </span><span id="local-6989586621683017990"><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683017990"><span class="hs-identifier hs-var">ct_orig</span></a></span></span><span> </span><span id="local-6989586621683017991"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683017991"><span class="hs-identifier hs-var">n_val_args_wanted</span></a></span></span><span> </span><span id="local-6989586621683017992"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683017992"><span class="hs-identifier hs-var">top_ty</span></a></span></span><span>
</span><span id="line-231"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; [Scaled TcType]
-&gt; TcType
-&gt; TcM (HsWrapper, [Scaled TcType], TcType)
</span><a href="#local-6989586621683017993"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683017991"><span class="hs-identifier hs-var">n_val_args_wanted</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683017992"><span class="hs-identifier hs-var">top_ty</span></a></span><span>
</span><span id="line-232"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-233"></span><span>    </span><span id="local-6989586621683017993"><span class="annot"><span class="annottext">go :: Int
-&gt; [Scaled TcType]
-&gt; TcType
-&gt; TcM (HsWrapper, [Scaled TcType], TcType)
</span><a href="#local-6989586621683017993"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621683017994"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683017994"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621683017995"><span class="annot"><span class="annottext">[Scaled TcType]
</span><a href="#local-6989586621683017995"><span class="hs-identifier hs-var">so_far</span></a></span></span><span> </span><span id="local-6989586621683017996"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683017996"><span class="hs-identifier hs-var">fun_ty</span></a></span></span><span>
</span><span id="line-234"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isRhoTy"><span class="hs-identifier hs-var">isRhoTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683017996"><span class="hs-identifier hs-var">fun_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-235"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683017998"><span class="annot"><a href="#local-6989586621683017998"><span class="hs-identifier hs-var">wrap1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683017999"><span class="annot"><a href="#local-6989586621683017999"><span class="hs-identifier hs-var">rho</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtOrigin -&gt; TcType -&gt; TcM (HsWrapper, TcType)
</span><a href="GHC.Tc.Utils.Instantiate.html#topInstantiate"><span class="hs-identifier hs-var">topInstantiate</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683017990"><span class="hs-identifier hs-var">ct_orig</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683017996"><span class="hs-identifier hs-var">fun_ty</span></a></span><span>
</span><span id="line-236"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018001"><span class="annot"><a href="#local-6989586621683018001"><span class="hs-identifier hs-var">wrap2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018002"><span class="annot"><a href="#local-6989586621683018002"><span class="hs-identifier hs-var">arg_tys</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018003"><span class="annot"><a href="#local-6989586621683018003"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621683017993"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017994"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017995"><span class="hs-identifier hs-type">so_far</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017999"><span class="hs-identifier hs-type">rho</span></a></span><span>
</span><span id="line-237"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683018001"><span class="hs-identifier hs-type">wrap2</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#%3C.%3E"><span class="hs-operator hs-type">&lt;.&gt;</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017998"><span class="hs-identifier hs-type">wrap1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683018002"><span class="hs-identifier hs-type">arg_tys</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683018003"><span class="hs-identifier hs-type">res_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-238"></span><span>
</span><span id="line-239"></span><span>    </span><span class="annot"><a href="#local-6989586621683017993"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">[Scaled TcType]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683018005"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018005"><span class="hs-identifier hs-var">fun_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(HsWrapper, [Scaled TcType], TcType)
-&gt; TcM (HsWrapper, [Scaled TcType], TcType)
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HsWrapper
</span><a href="GHC.Tc.Types.Evidence.html#idHsWrapper"><span class="hs-identifier hs-var">idHsWrapper</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018005"><span class="hs-identifier hs-var">fun_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-240"></span><span>
</span><span id="line-241"></span><span>    </span><span class="annot"><a href="#local-6989586621683017993"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683018006"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683018006"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621683018007"><span class="annot"><span class="annottext">[Scaled TcType]
</span><a href="#local-6989586621683018007"><span class="hs-identifier hs-var">so_far</span></a></span></span><span> </span><span id="local-6989586621683018008"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018008"><span class="hs-identifier hs-var">fun_ty</span></a></span></span><span>
</span><span id="line-242"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018009"><span class="annot"><a href="#local-6989586621683018009"><span class="hs-identifier hs-var">wrap_fun1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018010"><span class="annot"><a href="#local-6989586621683018010"><span class="hs-identifier hs-var">arg_ty1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018011"><span class="annot"><a href="#local-6989586621683018011"><span class="hs-identifier hs-var">res_ty1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ExpectedFunTyOrigin
-&gt; Maybe TypedThing
-&gt; (Int, TcType)
-&gt; TcType
-&gt; TcM (HsWrapper, Scaled TcType, TcType)
</span><a href="GHC.Tc.Utils.Unify.html#matchActualFunTy"><span class="hs-identifier hs-var">matchActualFunTy</span></a></span><span>
</span><span id="line-243"></span><span>                                                 </span><span class="annot"><span class="annottext">ExpectedFunTyOrigin
</span><a href="#local-6989586621683017989"><span class="hs-identifier hs-var">herald</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe TypedThing
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-244"></span><span>                                                 </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683017991"><span class="hs-identifier hs-var">n_val_args_wanted</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683017992"><span class="hs-identifier hs-var">top_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-245"></span><span>                                                 </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018008"><span class="hs-identifier hs-var">fun_ty</span></a></span><span>
</span><span id="line-246"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018012"><span class="annot"><a href="#local-6989586621683018012"><span class="hs-identifier hs-var">wrap_res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018013"><span class="annot"><a href="#local-6989586621683018013"><span class="hs-identifier hs-var">arg_tys</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018014"><span class="annot"><a href="#local-6989586621683018014"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621683017993"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683018006"><span class="hs-identifier hs-type">n</span></a></span><span class="annot"><span class="hs-glyph hs-type">-</span></span><span class="annot"><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683018010"><span class="hs-identifier hs-type">arg_ty1</span></a></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><a href="#local-6989586621683018007"><span class="hs-identifier hs-type">so_far</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683018011"><span class="hs-identifier hs-type">res_ty1</span></a></span><span>
</span><span id="line-247"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683018015"><span class="annot"><a href="#local-6989586621683018015"><span class="hs-identifier hs-var hs-var">wrap_fun2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HsWrapper -&gt; HsWrapper -&gt; Scaled TcType -&gt; TcType -&gt; HsWrapper
</span><a href="GHC.Tc.Types.Evidence.html#mkWpFun"><span class="hs-identifier hs-var">mkWpFun</span></a></span><span> </span><span class="annot"><span class="annottext">HsWrapper
</span><a href="GHC.Tc.Types.Evidence.html#idHsWrapper"><span class="hs-identifier hs-var">idHsWrapper</span></a></span><span> </span><span class="annot"><span class="annottext">HsWrapper
</span><a href="#local-6989586621683018012"><span class="hs-identifier hs-var">wrap_res</span></a></span><span> </span><span class="annot"><span class="annottext">Scaled TcType
</span><a href="#local-6989586621683018010"><span class="hs-identifier hs-var">arg_ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018014"><span class="hs-identifier hs-var">res_ty</span></a></span><span>
</span><span id="line-248"></span><span>           </span><span class="hs-comment">-- NB: arg_ty1 comes from matchActualFunTy, so it has</span><span>
</span><span id="line-249"></span><span>           </span><span class="hs-comment">-- a syntactically fixed RuntimeRep as needed to call mkWpFun.</span><span>
</span><span id="line-250"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683018015"><span class="hs-identifier hs-type">wrap_fun2</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#%3C.%3E"><span class="hs-operator hs-type">&lt;.&gt;</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018009"><span class="hs-identifier hs-type">wrap_fun1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683018010"><span class="hs-identifier hs-type">arg_ty1</span></a></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><a href="#local-6989586621683018013"><span class="hs-identifier hs-type">arg_tys</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683018014"><span class="hs-identifier hs-type">res_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-251"></span><span>
</span><span id="line-252"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
          Skolemisation and matchExpectedFunTys
*                                                                      *
************************************************************************

Note [Skolemisation overview]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose f :: (forall a. a-&gt;a) -&gt; blah, and we have the application (f e)
Then we want to typecheck `e` pushing in the type `forall a. a-&gt;a`. But we
need to be careful:

* Roughly speaking, in (tcPolyExpr e (forall a b. rho)), we skolemise `a` and `b`,
  and then call (tcExpr e rho)

* But not quite!  We must be careful if `e` is a type lambda (\ @p @q -&gt; blah).
  Then we want to line up the skolemised variables `a`,`b`
  with `p`,`q`, so we can't just call (tcExpr (\ @p @q -&gt; blah) rho)

* A very similar situation arises with
     (\ @p @q -&gt; blah) :: forall a b. rho
  Again, we must line up `p`, `q` with the skolemised `a` and `b`.

* Another similar situation arises with
    g :: forall a b. rho
    g @p @q x y = ....
  Here again when skolemising `a` and `b` we must be careful to match them up
  with `p` and `q`.

OK, so how exactly do we check @p binders in lambdas?  First note that we only
we only attempt to deal with @p binders when /checking/. We don't do inference for
(\ @a -&gt; blah), not yet anyway.

For checking, there are two cases to consider:
  * Function LHS, where the function has a type signature
                  f :: forall a. a -&gt; forall b. [b] -&gt; blah
                  f @p x @q y = ...

  * Lambda        \ @p x @q y -&gt; ...
                  \cases { @p x @q y -&gt; ... }
    (\case p behaves like \cases { p -&gt; ... }, and p is always a term pattern.)

Both ultimately handled by matchExpectedFunTys.

* Function LHS case is handled by `GHC.Tc.Gen.Bind.tcPolyCheck`:
  * It calls `tcSkolemiseCompleteSig`
  * Passes the skolemised variables into `tcFunBindMatches`
  * Which uses `matchExpectedFunTys` to decompose the function type to
    match the arguments
  * And then passes the (skolemised-variables ++ arg tys) on to `tcMatches`

* For the Lambda case there are two sub-cases:
   * An expression with a type signature: (\ @a x y -&gt; blah) :: hs_ty
     This is handled by `GHC.Tc.Gen.Head.tcExprWithSig`, which kind-checks
     the signature and hands off to `tcExprPolyCheck` vai `tcPolyLExprSig`
     Note that the foralls at the top of hs_ty scope over the expression.

   * A higher order call: h e, where h :: poly_ty -&gt; blah
     This is handlded by `GHC.Tc.Gen.Expr.tcPolyExpr`, which (in the
     checking case) again hands off to `tcExprPolyCheck`.  Here there is
     no type-variable scoping to worry about.

  So both sub-cases end up in `GHC.Tc.Gen.Expr.tcPolyExprCheck`
  * This skolemises the /top-level/ invisible binders, but remembers
    the binders as [ExpPatType]
  * Then it looks for a lambda, and if so, calls `tcLambdaMatches` passing in
    the skolemised binders so they can be matched up with the lambda binders.
  * Otherwise it does deep-skolemisation if DeepSubsumption is on,
    and then calls tcExpr to typecheck `e`

  The outer skolemisation in tcPolyExprCheck is done using
    * tcSkolemiseCompleteSig when there is a user-written signature
    * tcSkolemiseGeneral when the polytype just comes from the context e.g. (f e)
  The former just calls the latter, so the two cases differ only slightly:
    * Both do shallow skolemisation
    * Both go via checkConstraints, which uses implicationNeeded to decide whether
      to build an implication constraint even if there /are/ no skolems.
      See Note [When to build an implication] below.

  The difference between the two cases is that `tcSkolemiseCompleteSig`
  also brings the outer type variables into scope.  It would do no
  harm to do so in both cases, but I found that (to my surprise) doing
  so caused a non-trivial (1%-ish) perf hit on the compiler.

* `tcFunBindMatches` and `tcLambdaMatches` both use `matchExpectedFunTys`, which
  ensures that any trailing invisible binders are skolemised; and does so deeply
  if DeepSubsumption is on.

  This corresponds to the plan: &quot;skolemise at the '=' of a function binding or
  at the '-&gt;' of a lambda binding&quot;.  (See #17594 and &quot;Plan B2&quot;.)

Some wrinkles

(SK1) tcSkolemiseGeneral and tcSkolemiseCompleteSig make fresh type variables
      See Note [Instantiate sig with fresh variables]

(SK2) All skolemisation (even without DeepSubsumption) builds just one implication
      constraint for a nested forall like:
          forall a. Eq a =&gt; forall b. Ord b =&gt; blah
      The implication constraint will look like
          forall a b. (Eq a, Ord b) =&gt; &lt;constraints&gt;
      See the loop in GHC.Tc.Utils.Instantiate.topSkolemise.
      and Note [Skolemisation en-bloc] in that module


Some examples:

*     f :: forall a b. blah
      f @p x = rhs
  `tcPolyCheck` calls `tcSkolemiseCompleteSig` to skolemise the signature, and
  then calls `tcFunBindMatches` passing in [a_sk, b_sk], the skolemsed
  variables. The latter ultimately calls `tcMatches`, and thence `tcMatchPats`.
  The latter matches up the `a_sk` with `@p`, and discards the `b_sk`.

*     f :: forall (a::Type) (b::a). blah
      f @(p::b) x = rhs
  `tcSkolemiseCompleteSig` brings `a` and `b` into scope, bound to `a_sk` and `b_sk` resp.
  When `tcMatchPats` typechecks the pattern `@(p::b)` it'll find that `b` is in
  scope (as a result of tcSkolemiseCompleteSig) which is a bit strange.  But
  it'll then unify the kinds `Type ~ b`, which will fail as it should.

*     f :: Int -&gt; forall (a::Type) (b::a). blah
      f x  @p = rhs
  `matchExpectedFunTys` does shallow skolemisation eagerly, so we'll skolemise the
  forall a b.  Then `tcMatchPats` will bind [p :-&gt; a_sk], and discard `b_sk`.
  Discarding the `b_sk` means that
      f x @p = \ @q -&gt; blah
  or  f x @p = let .. in \ @q -&gt; blah
  will both be rejected: this is Plan B2: skolemise at the &quot;=&quot;.

* Suppose DeepSubsumption is on
    f :: forall a. a -&gt; forall b. b -&gt; b -&gt; forall z. z
    f @p x @q y = rhs
  The `tcSkolemiseCompleteSig` uses shallow skolemisation, so it only skolemises
  and brings into scope [a :-&gt; a_sk]. Then `matchExpectedFunTys` skolemises the
  forall b, because it needs to expose two value arguments.  Finally
  `matchExpectedFunTys` concludes with deeply skolemising the remaining type.

  So we end up with `[p :-&gt; a_sk, q :-&gt; b_sk]`.  Notice that we must not
  deeply-skolemise /first/ or we'd get the tyvars [a_sk, b_sk, c_sk] which would
  not line up with the patterns [@p, x, @q, y]
-}</span><span>
</span><span id="line-395"></span><span>
</span><span id="line-396"></span><span id="local-6989586621683017156"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcSkolemiseGeneral"><span class="hs-identifier hs-type">tcSkolemiseGeneral</span></a></span><span>
</span><span id="line-397"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#DeepSubsumptionFlag"><span class="hs-identifier hs-type">DeepSubsumptionFlag</span></a></span><span>
</span><span id="line-398"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span>
</span><span id="line-399"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>   </span><span class="hs-comment">-- top_ty and expected_ty</span><span>
</span><span id="line-400"></span><span>        </span><span class="hs-comment">-- Here, top_ty      is the type we started to skolemise; used only in SigSkol</span><span>
</span><span id="line-401"></span><span>        </span><span class="hs-comment">-- -     expected_ty is the type we are actually skolemising</span><span>
</span><span id="line-402"></span><span>        </span><span class="hs-comment">-- matchExpectedFunTys walks down the type, skolemising as it goes,</span><span>
</span><span id="line-403"></span><span>        </span><span class="hs-comment">-- keeping the same top_ty, but successively smaller expected_tys</span><span>
</span><span id="line-404"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcInvisTVBinder"><span class="hs-identifier hs-type">TcInvisTVBinder</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017156"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-405"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683017156"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-406"></span><span id="tcSkolemiseGeneral"><span class="annot"><span class="annottext">tcSkolemiseGeneral :: forall result.
DeepSubsumptionFlag
-&gt; UserTypeCtxt
-&gt; TcType
-&gt; TcType
-&gt; ([(Name, TcInvisTVBinder)] -&gt; TcType -&gt; TcM result)
-&gt; TcM (HsWrapper, result)
</span><a href="GHC.Tc.Utils.Unify.html#tcSkolemiseGeneral"><span class="hs-identifier hs-var hs-var">tcSkolemiseGeneral</span></a></span></span><span> </span><span id="local-6989586621683018036"><span class="annot"><span class="annottext">DeepSubsumptionFlag
</span><a href="#local-6989586621683018036"><span class="hs-identifier hs-var">ds_flag</span></a></span></span><span> </span><span id="local-6989586621683018037"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683018037"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span id="local-6989586621683018038"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018038"><span class="hs-identifier hs-var">top_ty</span></a></span></span><span> </span><span id="local-6989586621683018039"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018039"><span class="hs-identifier hs-var">expected_ty</span></a></span></span><span> </span><span id="local-6989586621683018040"><span class="annot"><span class="annottext">[(Name, TcInvisTVBinder)] -&gt; TcType -&gt; TcM result
</span><a href="#local-6989586621683018040"><span class="hs-identifier hs-var">thing_inside</span></a></span></span><span>
</span><span id="line-407"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">DeepSubsumptionFlag -&gt; TcType -&gt; Bool
</span><a href="GHC.Tc.Utils.Unify.html#isRhoTyDS"><span class="hs-identifier hs-var">isRhoTyDS</span></a></span><span> </span><span class="annot"><span class="annottext">DeepSubsumptionFlag
</span><a href="#local-6989586621683018036"><span class="hs-identifier hs-var">ds_flag</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018039"><span class="hs-identifier hs-var">expected_ty</span></a></span><span>
</span><span id="line-408"></span><span>    </span><span class="hs-comment">-- Fast path for a very very common case: no skolemisation to do</span><span>
</span><span id="line-409"></span><span>    </span><span class="hs-comment">-- But still call checkConstraints in case we need an implication regardless</span><span>
</span><span id="line-410"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683018041"><span class="annot"><span class="annottext">sig_skol :: SkolemInfoAnon
</span><a href="#local-6989586621683018041"><span class="hs-identifier hs-var hs-var hs-var">sig_skol</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt -&gt; TcType -&gt; [(Name, TcTyVar)] -&gt; SkolemInfoAnon
</span><a href="GHC.Tc.Types.Origin.html#SigSkol"><span class="hs-identifier hs-var">SigSkol</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683018037"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018038"><span class="hs-identifier hs-var">top_ty</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-411"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018043"><span class="annot"><a href="#local-6989586621683018043"><span class="hs-identifier hs-var">ev_binds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018044"><span class="annot"><a href="#local-6989586621683018044"><span class="hs-identifier hs-var">result</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SkolemInfoAnon
-&gt; [TcTyVar] -&gt; [TcTyVar] -&gt; TcM result -&gt; TcM (TcEvBinds, result)
forall result.
SkolemInfoAnon
-&gt; [TcTyVar] -&gt; [TcTyVar] -&gt; TcM result -&gt; TcM (TcEvBinds, result)
</span><a href="GHC.Tc.Utils.Unify.html#checkConstraints"><span class="hs-identifier hs-var">checkConstraints</span></a></span><span> </span><span class="annot"><span class="annottext">SkolemInfoAnon
</span><a href="#local-6989586621683018041"><span class="hs-identifier hs-var">sig_skol</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(TcM result -&gt; TcM (TcEvBinds, result))
-&gt; TcM result -&gt; TcM (TcEvBinds, result)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-412"></span><span>                               </span><span class="annot"><span class="annottext">[(Name, TcInvisTVBinder)] -&gt; TcType -&gt; TcM result
</span><a href="#local-6989586621683018040"><span class="hs-identifier hs-var">thing_inside</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018039"><span class="hs-identifier hs-var">expected_ty</span></a></span><span>
</span><span id="line-413"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#mkWpLet"><span class="hs-identifier hs-type">mkWpLet</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018043"><span class="hs-identifier hs-type">ev_binds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683018044"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-414"></span><span>
</span><span id="line-415"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-416"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- rec {..}: see Note [Keeping SkolemInfo inside a SkolemTv]</span><span>
</span><span id="line-417"></span><span>         </span><span class="hs-comment">--           in GHC.Tc.Utils.TcType</span><span>
</span><span id="line-418"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">rec</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018046"><span class="annot"><a href="#local-6989586621683018046"><span class="hs-identifier hs-var">wrap</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018047"><span class="annot"><a href="#local-6989586621683018047"><span class="hs-identifier hs-var">tv_prs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018048"><span class="annot"><a href="#local-6989586621683018048"><span class="hs-identifier hs-var">given</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018049"><span class="annot"><a href="#local-6989586621683018049"><span class="hs-identifier hs-var">rho_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683018036"><span class="hs-identifier hs-type">ds_flag</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-419"></span><span>                    </span><span class="annot"><span class="annottext">DeepSubsumptionFlag
</span><a href="GHC.Tc.Utils.Unify.html#Deep"><span class="hs-identifier hs-var">Deep</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SkolemInfo
-&gt; TcType
-&gt; IOEnv
     (Env TcGblEnv TcLclEnv)
     (HsWrapper, [(Name, TcInvisTVBinder)], [TcTyVar], TcType)
</span><a href="GHC.Tc.Utils.Unify.html#deeplySkolemise"><span class="hs-identifier hs-var">deeplySkolemise</span></a></span><span> </span><span class="annot"><span class="annottext">SkolemInfo
</span><a href="#local-6989586621683018052"><span class="hs-identifier hs-var">skol_info</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018039"><span class="hs-identifier hs-var">expected_ty</span></a></span><span>
</span><span id="line-420"></span><span>                    </span><span class="annot"><span class="annottext">DeepSubsumptionFlag
</span><a href="GHC.Tc.Utils.Unify.html#Shallow"><span class="hs-identifier hs-var">Shallow</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SkolemInfo
-&gt; TcType
-&gt; IOEnv
     (Env TcGblEnv TcLclEnv)
     (HsWrapper, [(Name, TcInvisTVBinder)], [TcTyVar], TcType)
</span><a href="GHC.Tc.Utils.Instantiate.html#topSkolemise"><span class="hs-identifier hs-var">topSkolemise</span></a></span><span> </span><span class="annot"><span class="annottext">SkolemInfo
</span><a href="#local-6989586621683018052"><span class="hs-identifier hs-var">skol_info</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018039"><span class="hs-identifier hs-var">expected_ty</span></a></span><span>
</span><span id="line-421"></span><span>             </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683018055"><span class="annot"><a href="#local-6989586621683018055"><span class="hs-identifier hs-var hs-var">sig_skol</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt -&gt; TcType -&gt; [(Name, TcTyVar)] -&gt; SkolemInfoAnon
</span><a href="GHC.Tc.Types.Origin.html#SigSkol"><span class="hs-identifier hs-var">SigSkol</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683018037"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018038"><span class="hs-identifier hs-var">top_ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Name, TcInvisTVBinder) -&gt; (Name, TcTyVar))
-&gt; [(Name, TcInvisTVBinder)] -&gt; [(Name, TcTyVar)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TcInvisTVBinder -&gt; TcTyVar)
-&gt; (Name, TcInvisTVBinder) -&gt; (Name, TcTyVar)
forall a b. (a -&gt; b) -&gt; (Name, a) -&gt; (Name, b)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">TcInvisTVBinder -&gt; TcTyVar
forall tv argf. VarBndr tv argf -&gt; tv
</span><a href="GHC.Types.Var.html#binderVar"><span class="hs-identifier hs-var">binderVar</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, TcInvisTVBinder)]
</span><a href="#local-6989586621683018047"><span class="hs-identifier hs-var">tv_prs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-422"></span><span>             </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018052"><span class="annot"><a href="#local-6989586621683018052"><span class="hs-identifier hs-var">skol_info</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#mkSkolemInfo"><span class="hs-identifier hs-type">mkSkolemInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018055"><span class="hs-identifier hs-type">sig_skol</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-423"></span><span>
</span><span id="line-424"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683018058"><span class="annot"><a href="#local-6989586621683018058"><span class="hs-identifier hs-var hs-var">skol_tvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Name, TcInvisTVBinder) -&gt; TcTyVar)
-&gt; [(Name, TcInvisTVBinder)] -&gt; [TcTyVar]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcInvisTVBinder -&gt; TcTyVar
forall tv argf. VarBndr tv argf -&gt; tv
</span><a href="GHC.Types.Var.html#binderVar"><span class="hs-identifier hs-var">binderVar</span></a></span><span> </span><span class="annot"><span class="annottext">(TcInvisTVBinder -&gt; TcTyVar)
-&gt; ((Name, TcInvisTVBinder) -&gt; TcInvisTVBinder)
-&gt; (Name, TcInvisTVBinder)
-&gt; TcTyVar
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Name, TcInvisTVBinder) -&gt; TcInvisTVBinder
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, TcInvisTVBinder)]
</span><a href="#local-6989586621683018047"><span class="hs-identifier hs-var">tv_prs</span></a></span><span>
</span><span id="line-425"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;tcSkolemiseGeneral&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#pprUserTypeCtxt"><span class="hs-identifier hs-type">pprUserTypeCtxt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018037"><span class="hs-identifier hs-type">ctxt</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018058"><span class="hs-identifier hs-type">skol_tvs</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018048"><span class="hs-identifier hs-type">given</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-426"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018064"><span class="annot"><a href="#local-6989586621683018064"><span class="hs-identifier hs-var">ev_binds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018065"><span class="annot"><a href="#local-6989586621683018065"><span class="hs-identifier hs-var">result</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#checkConstraints"><span class="hs-identifier hs-type">checkConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018055"><span class="hs-identifier hs-type">sig_skol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018058"><span class="hs-identifier hs-type">skol_tvs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018048"><span class="hs-identifier hs-type">given</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-427"></span><span>                               </span><span class="annot"><a href="#local-6989586621683018040"><span class="hs-identifier hs-type">thing_inside</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018047"><span class="hs-identifier hs-type">tv_prs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018049"><span class="hs-identifier hs-type">rho_ty</span></a></span><span>
</span><span id="line-428"></span><span>
</span><span id="line-429"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683018046"><span class="hs-identifier hs-type">wrap</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#%3C.%3E"><span class="hs-operator hs-type">&lt;.&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#mkWpLet"><span class="hs-identifier hs-type">mkWpLet</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018064"><span class="hs-identifier hs-type">ev_binds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683018065"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-430"></span><span>         </span><span class="hs-comment">-- The ev_binds returned by checkConstraints is very</span><span>
</span><span id="line-431"></span><span>         </span><span class="hs-comment">-- often empty, in which case mkWpLet is a no-op</span><span>
</span><span id="line-432"></span><span>
</span><span id="line-433"></span><span id="local-6989586621683017181"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcSkolemiseCompleteSig"><span class="hs-identifier hs-type">tcSkolemiseCompleteSig</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.BasicTypes.html#TcCompleteSig"><span class="hs-identifier hs-type">TcCompleteSig</span></a></span><span>
</span><span id="line-434"></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#ExpPatType"><span class="hs-identifier hs-type">ExpPatType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcRhoType"><span class="hs-identifier hs-type">TcRhoType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017181"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-435"></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683017181"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-436"></span><span class="hs-comment">-- ^ The wrapper has type: spec_ty ~&gt; expected_ty</span><span>
</span><span id="line-437"></span><span class="hs-comment">-- See Note [Skolemisation] for the differences between</span><span>
</span><span id="line-438"></span><span class="hs-comment">-- tcSkolemiseCompleteSig and tcTopSkolemise</span><span>
</span><span id="line-439"></span><span>
</span><span id="line-440"></span><span id="tcSkolemiseCompleteSig"><span class="annot"><span class="annottext">tcSkolemiseCompleteSig :: forall result.
TcCompleteSig
-&gt; ([ExpPatType] -&gt; TcType -&gt; TcM result)
-&gt; TcM (HsWrapper, result)
</span><a href="GHC.Tc.Utils.Unify.html#tcSkolemiseCompleteSig"><span class="hs-identifier hs-var hs-var">tcSkolemiseCompleteSig</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.BasicTypes.html#CSig"><span class="hs-identifier hs-type">CSig</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sig_bndr :: TcCompleteSig -&gt; TcTyVar
</span><a href="GHC.Tc.Types.BasicTypes.html#sig_bndr"><span class="hs-identifier hs-var">sig_bndr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683018070"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683018070"><span class="hs-identifier hs-var">poly_id</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sig_ctxt :: TcCompleteSig -&gt; UserTypeCtxt
</span><a href="GHC.Tc.Types.BasicTypes.html#sig_ctxt"><span class="hs-identifier hs-var">sig_ctxt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683018072"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683018072"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sig_loc :: TcCompleteSig -&gt; SrcSpan
</span><a href="GHC.Tc.Types.BasicTypes.html#sig_loc"><span class="hs-identifier hs-var">sig_loc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683018074"><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621683018074"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-441"></span><span>                       </span><span id="local-6989586621683018075"><span class="annot"><span class="annottext">[ExpPatType] -&gt; TcType -&gt; TcM result
</span><a href="#local-6989586621683018075"><span class="hs-identifier hs-var">thing_inside</span></a></span></span><span>
</span><span id="line-442"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018076"><span class="annot"><a href="#local-6989586621683018076"><span class="hs-identifier hs-var">cur_loc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcRn SrcSpan
</span><a href="GHC.Tc.Utils.Monad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a></span><span>
</span><span id="line-443"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683018078"><span class="annot"><a href="#local-6989586621683018078"><span class="hs-identifier hs-var hs-var">poly_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683018070"><span class="hs-identifier hs-var">poly_id</span></a></span><span>
</span><span id="line-444"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#setSrcSpan"><span class="hs-identifier hs-type">setSrcSpan</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018074"><span class="hs-identifier hs-type">loc</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>   </span><span class="hs-comment">-- Sets the location for the implication constraint</span><span>
</span><span id="line-445"></span><span>         </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcSkolemiseGeneral"><span class="hs-identifier hs-type">tcSkolemiseGeneral</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#Shallow"><span class="hs-identifier hs-type">Shallow</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018072"><span class="hs-identifier hs-type">ctxt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018078"><span class="hs-identifier hs-type">poly_ty</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018078"><span class="hs-identifier hs-type">poly_ty</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621683018080"><span class="annot"><span class="annottext">[(Name, TcInvisTVBinder)]
</span><a href="#local-6989586621683018080"><span class="hs-identifier hs-var">tv_prs</span></a></span></span><span> </span><span id="local-6989586621683018081"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018081"><span class="hs-identifier hs-var">rho_ty</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-446"></span><span>         </span><span class="annot"><span class="annottext">SrcSpan -&gt; TcM result -&gt; TcM result
forall a. SrcSpan -&gt; TcRn a -&gt; TcRn a
</span><a href="GHC.Tc.Utils.Monad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621683018076"><span class="hs-identifier hs-var">cur_loc</span></a></span><span> </span><span class="annot"><span class="annottext">(TcM result -&gt; TcM result) -&gt; TcM result -&gt; TcM result
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-comment">-- Revert to the original location</span><span>
</span><span id="line-447"></span><span>         </span><span class="annot"><span class="annottext">[(Name, TcTyVar)] -&gt; TcM result -&gt; TcM result
forall r. [(Name, TcTyVar)] -&gt; TcM r -&gt; TcM r
</span><a href="GHC.Tc.Utils.Env.html#tcExtendNameTyVarEnv"><span class="hs-identifier hs-var">tcExtendNameTyVarEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Name, TcInvisTVBinder) -&gt; (Name, TcTyVar))
-&gt; [(Name, TcInvisTVBinder)] -&gt; [(Name, TcTyVar)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TcInvisTVBinder -&gt; TcTyVar)
-&gt; (Name, TcInvisTVBinder) -&gt; (Name, TcTyVar)
forall a b. (a -&gt; b) -&gt; (Name, a) -&gt; (Name, b)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">TcInvisTVBinder -&gt; TcTyVar
forall tv argf. VarBndr tv argf -&gt; tv
</span><a href="GHC.Types.Var.html#binderVar"><span class="hs-identifier hs-var">binderVar</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, TcInvisTVBinder)]
</span><a href="#local-6989586621683018080"><span class="hs-identifier hs-var">tv_prs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcM result -&gt; TcM result) -&gt; TcM result -&gt; TcM result
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-448"></span><span>         </span><span class="annot"><span class="annottext">[ExpPatType] -&gt; TcType -&gt; TcM result
</span><a href="#local-6989586621683018075"><span class="hs-identifier hs-var">thing_inside</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Name, TcInvisTVBinder) -&gt; ExpPatType)
-&gt; [(Name, TcInvisTVBinder)] -&gt; [ExpPatType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcInvisTVBinder -&gt; ExpPatType
</span><a href="GHC.Tc.Utils.TcType.html#mkInvisExpPatType"><span class="hs-identifier hs-var">mkInvisExpPatType</span></a></span><span> </span><span class="annot"><span class="annottext">(TcInvisTVBinder -&gt; ExpPatType)
-&gt; ((Name, TcInvisTVBinder) -&gt; TcInvisTVBinder)
-&gt; (Name, TcInvisTVBinder)
-&gt; ExpPatType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Name, TcInvisTVBinder) -&gt; TcInvisTVBinder
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, TcInvisTVBinder)]
</span><a href="#local-6989586621683018080"><span class="hs-identifier hs-var">tv_prs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018081"><span class="hs-identifier hs-var">rho_ty</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-449"></span><span>
</span><span id="line-450"></span><span id="local-6989586621683017187"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcSkolemiseExpectedType"><span class="hs-identifier hs-type">tcSkolemiseExpectedType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a></span><span>
</span><span id="line-451"></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#ExpPatType"><span class="hs-identifier hs-type">ExpPatType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcRhoType"><span class="hs-identifier hs-type">TcRhoType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017187"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-452"></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683017187"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-453"></span><span class="hs-comment">-- Just like tcSkolemiseCompleteSig, except that we don't have a user-written</span><span>
</span><span id="line-454"></span><span class="hs-comment">-- type signature, we only have a type comimg from the context.</span><span>
</span><span id="line-455"></span><span class="hs-comment">-- Eg. f :: (forall a. blah) -&gt; blah</span><span>
</span><span id="line-456"></span><span class="hs-comment">--     In the call (f e) we will call tcSkolemiseExpectedType on (forall a.blah)</span><span>
</span><span id="line-457"></span><span class="hs-comment">--     before typececking `e`</span><span>
</span><span id="line-458"></span><span id="tcSkolemiseExpectedType"><span class="annot"><span class="annottext">tcSkolemiseExpectedType :: forall result.
TcType
-&gt; ([ExpPatType] -&gt; TcType -&gt; TcM result)
-&gt; TcM (HsWrapper, result)
</span><a href="GHC.Tc.Utils.Unify.html#tcSkolemiseExpectedType"><span class="hs-identifier hs-var hs-var">tcSkolemiseExpectedType</span></a></span></span><span> </span><span id="local-6989586621683018084"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018084"><span class="hs-identifier hs-var">exp_ty</span></a></span></span><span> </span><span id="local-6989586621683018085"><span class="annot"><span class="annottext">[ExpPatType] -&gt; TcType -&gt; TcM result
</span><a href="#local-6989586621683018085"><span class="hs-identifier hs-var">thing_inside</span></a></span></span><span>
</span><span id="line-459"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DeepSubsumptionFlag
-&gt; UserTypeCtxt
-&gt; TcType
-&gt; TcType
-&gt; ([(Name, TcInvisTVBinder)] -&gt; TcType -&gt; TcM result)
-&gt; TcM (HsWrapper, result)
forall result.
DeepSubsumptionFlag
-&gt; UserTypeCtxt
-&gt; TcType
-&gt; TcType
-&gt; ([(Name, TcInvisTVBinder)] -&gt; TcType -&gt; TcM result)
-&gt; TcM (HsWrapper, result)
</span><a href="GHC.Tc.Utils.Unify.html#tcSkolemiseGeneral"><span class="hs-identifier hs-var">tcSkolemiseGeneral</span></a></span><span> </span><span class="annot"><span class="annottext">DeepSubsumptionFlag
</span><a href="GHC.Tc.Utils.Unify.html#Shallow"><span class="hs-identifier hs-var">Shallow</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="GHC.Tc.Types.Origin.html#GenSigCtxt"><span class="hs-identifier hs-var">GenSigCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018084"><span class="hs-identifier hs-var">exp_ty</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018084"><span class="hs-identifier hs-var">exp_ty</span></a></span><span> </span><span class="annot"><span class="annottext">(([(Name, TcInvisTVBinder)] -&gt; TcType -&gt; TcM result)
 -&gt; TcM (HsWrapper, result))
-&gt; ([(Name, TcInvisTVBinder)] -&gt; TcType -&gt; TcM result)
-&gt; TcM (HsWrapper, result)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621683018087"><span class="annot"><span class="annottext">[(Name, TcInvisTVBinder)]
</span><a href="#local-6989586621683018087"><span class="hs-identifier hs-var">tv_prs</span></a></span></span><span> </span><span id="local-6989586621683018088"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018088"><span class="hs-identifier hs-var">rho_ty</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-460"></span><span>    </span><span class="annot"><span class="annottext">[ExpPatType] -&gt; TcType -&gt; TcM result
</span><a href="#local-6989586621683018085"><span class="hs-identifier hs-var">thing_inside</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Name, TcInvisTVBinder) -&gt; ExpPatType)
-&gt; [(Name, TcInvisTVBinder)] -&gt; [ExpPatType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcInvisTVBinder -&gt; ExpPatType
</span><a href="GHC.Tc.Utils.TcType.html#mkInvisExpPatType"><span class="hs-identifier hs-var">mkInvisExpPatType</span></a></span><span> </span><span class="annot"><span class="annottext">(TcInvisTVBinder -&gt; ExpPatType)
-&gt; ((Name, TcInvisTVBinder) -&gt; TcInvisTVBinder)
-&gt; (Name, TcInvisTVBinder)
-&gt; ExpPatType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Name, TcInvisTVBinder) -&gt; TcInvisTVBinder
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, TcInvisTVBinder)]
</span><a href="#local-6989586621683018087"><span class="hs-identifier hs-var">tv_prs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018088"><span class="hs-identifier hs-var">rho_ty</span></a></span><span>
</span><span id="line-461"></span><span>
</span><span id="line-462"></span><span id="local-6989586621683017189"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcSkolemise"><span class="hs-identifier hs-type">tcSkolemise</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#DeepSubsumptionFlag"><span class="hs-identifier hs-type">DeepSubsumptionFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a></span><span>
</span><span id="line-463"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcRhoType"><span class="hs-identifier hs-type">TcRhoType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017189"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-464"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683017189"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-465"></span><span id="tcSkolemise"><span class="annot"><span class="annottext">tcSkolemise :: forall result.
DeepSubsumptionFlag
-&gt; UserTypeCtxt
-&gt; TcType
-&gt; (TcType -&gt; TcM result)
-&gt; TcM (HsWrapper, result)
</span><a href="GHC.Tc.Utils.Unify.html#tcSkolemise"><span class="hs-identifier hs-var hs-var">tcSkolemise</span></a></span></span><span> </span><span id="local-6989586621683018089"><span class="annot"><span class="annottext">DeepSubsumptionFlag
</span><a href="#local-6989586621683018089"><span class="hs-identifier hs-var">ds_flag</span></a></span></span><span> </span><span id="local-6989586621683018090"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683018090"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span id="local-6989586621683018091"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018091"><span class="hs-identifier hs-var">expected_ty</span></a></span></span><span> </span><span id="local-6989586621683018092"><span class="annot"><span class="annottext">TcType -&gt; TcM result
</span><a href="#local-6989586621683018092"><span class="hs-identifier hs-var">thing_inside</span></a></span></span><span>
</span><span id="line-466"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DeepSubsumptionFlag
-&gt; UserTypeCtxt
-&gt; TcType
-&gt; TcType
-&gt; ([(Name, TcInvisTVBinder)] -&gt; TcType -&gt; TcM result)
-&gt; TcM (HsWrapper, result)
forall result.
DeepSubsumptionFlag
-&gt; UserTypeCtxt
-&gt; TcType
-&gt; TcType
-&gt; ([(Name, TcInvisTVBinder)] -&gt; TcType -&gt; TcM result)
-&gt; TcM (HsWrapper, result)
</span><a href="GHC.Tc.Utils.Unify.html#tcSkolemiseGeneral"><span class="hs-identifier hs-var">tcSkolemiseGeneral</span></a></span><span> </span><span class="annot"><span class="annottext">DeepSubsumptionFlag
</span><a href="#local-6989586621683018089"><span class="hs-identifier hs-var">ds_flag</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683018090"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018091"><span class="hs-identifier hs-var">expected_ty</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018091"><span class="hs-identifier hs-var">expected_ty</span></a></span><span> </span><span class="annot"><span class="annottext">(([(Name, TcInvisTVBinder)] -&gt; TcType -&gt; TcM result)
 -&gt; TcM (HsWrapper, result))
-&gt; ([(Name, TcInvisTVBinder)] -&gt; TcType -&gt; TcM result)
-&gt; TcM (HsWrapper, result)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">[(Name, TcInvisTVBinder)]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683018093"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018093"><span class="hs-identifier hs-var">rho_ty</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-467"></span><span>    </span><span class="annot"><span class="annottext">TcType -&gt; TcM result
</span><a href="#local-6989586621683018092"><span class="hs-identifier hs-var">thing_inside</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018093"><span class="hs-identifier hs-var">rho_ty</span></a></span><span>
</span><span id="line-468"></span><span>
</span><span id="line-469"></span><span id="local-6989586621683017162"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#checkConstraints"><span class="hs-identifier hs-type">checkConstraints</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#SkolemInfoAnon"><span class="hs-identifier hs-type">SkolemInfoAnon</span></a></span><span>
</span><span id="line-470"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span class="hs-special">]</span><span>           </span><span class="hs-comment">-- Skolems</span><span>
</span><span id="line-471"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#EvVar"><span class="hs-identifier hs-type">EvVar</span></a></span><span class="hs-special">]</span><span>             </span><span class="hs-comment">-- Given</span><span>
</span><span id="line-472"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017162"><span class="hs-identifier hs-type">result</span></a></span><span>
</span><span id="line-473"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#TcEvBinds"><span class="hs-identifier hs-type">TcEvBinds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683017162"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-474"></span><span class="hs-comment">-- checkConstraints is careful to build an implication even if</span><span>
</span><span id="line-475"></span><span class="hs-comment">-- `skol_tvs` and `given` are both empty, under certain circumstances</span><span>
</span><span id="line-476"></span><span class="hs-comment">-- See Note [When to build an implication]</span><span>
</span><span id="line-477"></span><span id="checkConstraints"><span class="annot"><span class="annottext">checkConstraints :: forall result.
SkolemInfoAnon
-&gt; [TcTyVar] -&gt; [TcTyVar] -&gt; TcM result -&gt; TcM (TcEvBinds, result)
</span><a href="GHC.Tc.Utils.Unify.html#checkConstraints"><span class="hs-identifier hs-var hs-var">checkConstraints</span></a></span></span><span> </span><span id="local-6989586621683018106"><span class="annot"><span class="annottext">SkolemInfoAnon
</span><a href="#local-6989586621683018106"><span class="hs-identifier hs-var">skol_info</span></a></span></span><span> </span><span id="local-6989586621683018107"><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683018107"><span class="hs-identifier hs-var">skol_tvs</span></a></span></span><span> </span><span id="local-6989586621683018108"><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683018108"><span class="hs-identifier hs-var">given</span></a></span></span><span> </span><span id="local-6989586621683018109"><span class="annot"><span class="annottext">TcM result
</span><a href="#local-6989586621683018109"><span class="hs-identifier hs-var">thing_inside</span></a></span></span><span>
</span><span id="line-478"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018110"><span class="annot"><a href="#local-6989586621683018110"><span class="hs-identifier hs-var">implication_needed</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SkolemInfoAnon -&gt; [TcTyVar] -&gt; [TcTyVar] -&gt; TcM Bool
</span><a href="GHC.Tc.Utils.Unify.html#implicationNeeded"><span class="hs-identifier hs-var">implicationNeeded</span></a></span><span> </span><span class="annot"><span class="annottext">SkolemInfoAnon
</span><a href="#local-6989586621683018106"><span class="hs-identifier hs-var">skol_info</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683018107"><span class="hs-identifier hs-var">skol_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683018108"><span class="hs-identifier hs-var">given</span></a></span><span>
</span><span id="line-479"></span><span>
</span><span id="line-480"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621683018110"><span class="hs-identifier hs-type">implication_needed</span></a></span><span>
</span><span id="line-481"></span><span>         </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018112"><span class="annot"><a href="#local-6989586621683018112"><span class="hs-identifier hs-var">tclvl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018113"><span class="annot"><a href="#local-6989586621683018113"><span class="hs-identifier hs-var">wanted</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018114"><span class="annot"><a href="#local-6989586621683018114"><span class="hs-identifier hs-var">result</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#pushLevelAndCaptureConstraints"><span class="hs-identifier hs-type">pushLevelAndCaptureConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018109"><span class="hs-identifier hs-type">thing_inside</span></a></span><span>
</span><span id="line-482"></span><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018116"><span class="annot"><a href="#local-6989586621683018116"><span class="hs-identifier hs-var">implics</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018117"><span class="annot"><a href="#local-6989586621683018117"><span class="hs-identifier hs-var">ev_binds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#buildImplicationFor"><span class="hs-identifier hs-type">buildImplicationFor</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018112"><span class="hs-identifier hs-type">tclvl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018106"><span class="hs-identifier hs-type">skol_info</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018107"><span class="hs-identifier hs-type">skol_tvs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018108"><span class="hs-identifier hs-type">given</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018113"><span class="hs-identifier hs-type">wanted</span></a></span><span>
</span><span id="line-483"></span><span>                 </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;checkConstraints&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018112"><span class="hs-identifier hs-type">tclvl</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-type">$$</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018107"><span class="hs-identifier hs-type">skol_tvs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-484"></span><span>                 </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#emitImplications"><span class="hs-identifier hs-type">emitImplications</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018116"><span class="hs-identifier hs-type">implics</span></a></span><span>
</span><span id="line-485"></span><span>                 </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683018117"><span class="hs-identifier hs-type">ev_binds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683018114"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-486"></span><span>
</span><span id="line-487"></span><span>         </span><span class="hs-keyword">else</span><span> </span><span class="hs-comment">-- Fast path.  We check every function argument with tcCheckPolyExpr,</span><span>
</span><span id="line-488"></span><span>              </span><span class="hs-comment">-- which uses tcTopSkolemise and hence checkConstraints.</span><span>
</span><span id="line-489"></span><span>              </span><span class="hs-comment">-- So this fast path is well-exercised</span><span>
</span><span id="line-490"></span><span>              </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018120"><span class="annot"><a href="#local-6989586621683018120"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621683018109"><span class="hs-identifier hs-type">thing_inside</span></a></span><span>
</span><span id="line-491"></span><span>                 </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#emptyTcEvBinds"><span class="hs-identifier hs-type">emptyTcEvBinds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683018120"><span class="hs-identifier hs-type">res</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-492"></span><span>
</span><span id="line-493"></span><span id="local-6989586621683017196"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#checkTvConstraints"><span class="hs-identifier hs-type">checkTvConstraints</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#SkolemInfo"><span class="hs-identifier hs-type">SkolemInfo</span></a></span><span>
</span><span id="line-494"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span class="hs-special">]</span><span>          </span><span class="hs-comment">-- Skolem tyvars</span><span>
</span><span id="line-495"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017196"><span class="hs-identifier hs-type">result</span></a></span><span>
</span><span id="line-496"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017196"><span class="hs-identifier hs-type">result</span></a></span></span><span>
</span><span id="line-497"></span><span>
</span><span id="line-498"></span><span id="checkTvConstraints"><span class="annot"><span class="annottext">checkTvConstraints :: forall result. SkolemInfo -&gt; [TcTyVar] -&gt; TcM result -&gt; TcM result
</span><a href="GHC.Tc.Utils.Unify.html#checkTvConstraints"><span class="hs-identifier hs-var hs-var">checkTvConstraints</span></a></span></span><span> </span><span id="local-6989586621683018125"><span class="annot"><span class="annottext">SkolemInfo
</span><a href="#local-6989586621683018125"><span class="hs-identifier hs-var">skol_info</span></a></span></span><span> </span><span id="local-6989586621683018126"><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683018126"><span class="hs-identifier hs-var">skol_tvs</span></a></span></span><span> </span><span id="local-6989586621683018127"><span class="annot"><span class="annottext">TcM result
</span><a href="#local-6989586621683018127"><span class="hs-identifier hs-var">thing_inside</span></a></span></span><span>
</span><span id="line-499"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018128"><span class="annot"><a href="#local-6989586621683018128"><span class="hs-identifier hs-var">tclvl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018129"><span class="annot"><a href="#local-6989586621683018129"><span class="hs-identifier hs-var">wanted</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018130"><span class="annot"><a href="#local-6989586621683018130"><span class="hs-identifier hs-var">result</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM result -&gt; TcM (TcLevel, WantedConstraints, result)
forall a. TcM a -&gt; TcM (TcLevel, WantedConstraints, a)
</span><a href="GHC.Tc.Utils.Monad.html#pushLevelAndCaptureConstraints"><span class="hs-identifier hs-var">pushLevelAndCaptureConstraints</span></a></span><span> </span><span class="annot"><span class="annottext">TcM result
</span><a href="#local-6989586621683018127"><span class="hs-identifier hs-var">thing_inside</span></a></span><span>
</span><span id="line-500"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#emitResidualTvConstraint"><span class="hs-identifier hs-type">emitResidualTvConstraint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018125"><span class="hs-identifier hs-type">skol_info</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018126"><span class="hs-identifier hs-type">skol_tvs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018128"><span class="hs-identifier hs-type">tclvl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018129"><span class="hs-identifier hs-type">wanted</span></a></span><span>
</span><span id="line-501"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683018130"><span class="hs-identifier hs-type">result</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-502"></span><span>
</span><span id="line-503"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#emitResidualTvConstraint"><span class="hs-identifier hs-type">emitResidualTvConstraint</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#SkolemInfo"><span class="hs-identifier hs-type">SkolemInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-504"></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcLevel"><span class="hs-identifier hs-type">TcLevel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-505"></span><span id="emitResidualTvConstraint"><span class="annot"><span class="annottext">emitResidualTvConstraint :: SkolemInfo -&gt; [TcTyVar] -&gt; TcLevel -&gt; WantedConstraints -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Unify.html#emitResidualTvConstraint"><span class="hs-identifier hs-var hs-var">emitResidualTvConstraint</span></a></span></span><span> </span><span id="local-6989586621683018131"><span class="annot"><span class="annottext">SkolemInfo
</span><a href="#local-6989586621683018131"><span class="hs-identifier hs-var">skol_info</span></a></span></span><span> </span><span id="local-6989586621683018132"><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683018132"><span class="hs-identifier hs-var">skol_tvs</span></a></span></span><span> </span><span id="local-6989586621683018133"><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683018133"><span class="hs-identifier hs-var">tclvl</span></a></span></span><span> </span><span id="local-6989586621683018134"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683018134"><span class="hs-identifier hs-var">wanted</span></a></span></span><span>
</span><span id="line-506"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WantedConstraints -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isEmptyWC"><span class="hs-identifier hs-var">isEmptyWC</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683018134"><span class="hs-identifier hs-var">wanted</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span>
</span><span id="line-507"></span><span>    </span><span class="annot"><span class="annottext">SkolemInfoAnon -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#checkTelescopeSkol"><span class="hs-identifier hs-var">checkTelescopeSkol</span></a></span><span> </span><span class="annot"><span class="annottext">SkolemInfoAnon
</span><a href="#local-6989586621683018138"><span class="hs-identifier hs-var">skol_info_anon</span></a></span><span>
</span><span id="line-508"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- checkTelescopeSkol: in this case, /always/ emit this implication</span><span>
</span><span id="line-509"></span><span>    </span><span class="hs-comment">-- even if 'wanted' is empty. We need the implication so that we check</span><span>
</span><span id="line-510"></span><span>    </span><span class="hs-comment">-- for a bad telescope. See Note [Skolem escape and forall-types] in</span><span>
</span><span id="line-511"></span><span>    </span><span class="hs-comment">-- GHC.Tc.Gen.HsType</span><span>
</span><span id="line-512"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018139"><span class="annot"><a href="#local-6989586621683018139"><span class="hs-identifier hs-var">implic</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SkolemInfoAnon
-&gt; [TcTyVar] -&gt; TcLevel -&gt; WantedConstraints -&gt; TcM Implication
</span><a href="GHC.Tc.Utils.Unify.html#buildTvImplication"><span class="hs-identifier hs-var">buildTvImplication</span></a></span><span> </span><span class="annot"><span class="annottext">SkolemInfoAnon
</span><a href="#local-6989586621683018138"><span class="hs-identifier hs-var">skol_info_anon</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683018132"><span class="hs-identifier hs-var">skol_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683018133"><span class="hs-identifier hs-var">tclvl</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683018134"><span class="hs-identifier hs-var">wanted</span></a></span><span>
</span><span id="line-513"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#emitImplication"><span class="hs-identifier hs-type">emitImplication</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018139"><span class="hs-identifier hs-type">implic</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-514"></span><span>
</span><span id="line-515"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>  </span><span class="hs-comment">-- Empty 'wanted', emit nothing</span><span>
</span><span id="line-516"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-517"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-518"></span><span>     </span><span id="local-6989586621683018138"><span class="annot"><span class="annottext">skol_info_anon :: SkolemInfoAnon
</span><a href="#local-6989586621683018138"><span class="hs-identifier hs-var hs-var">skol_info_anon</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SkolemInfo -&gt; SkolemInfoAnon
</span><a href="GHC.Tc.Types.Origin.html#getSkolemInfo"><span class="hs-identifier hs-var">getSkolemInfo</span></a></span><span> </span><span class="annot"><span class="annottext">SkolemInfo
</span><a href="#local-6989586621683018131"><span class="hs-identifier hs-var">skol_info</span></a></span><span>
</span><span id="line-519"></span><span>
</span><span id="line-520"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#buildTvImplication"><span class="hs-identifier hs-type">buildTvImplication</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#SkolemInfoAnon"><span class="hs-identifier hs-type">SkolemInfoAnon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-521"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcLevel"><span class="hs-identifier hs-type">TcLevel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Implication"><span class="hs-identifier hs-type">Implication</span></a></span><span>
</span><span id="line-522"></span><span id="buildTvImplication"><span class="annot"><span class="annottext">buildTvImplication :: SkolemInfoAnon
-&gt; [TcTyVar] -&gt; TcLevel -&gt; WantedConstraints -&gt; TcM Implication
</span><a href="GHC.Tc.Utils.Unify.html#buildTvImplication"><span class="hs-identifier hs-var hs-var">buildTvImplication</span></a></span></span><span> </span><span id="local-6989586621683018142"><span class="annot"><span class="annottext">SkolemInfoAnon
</span><a href="#local-6989586621683018142"><span class="hs-identifier hs-var">skol_info</span></a></span></span><span> </span><span id="local-6989586621683018143"><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683018143"><span class="hs-identifier hs-var">skol_tvs</span></a></span></span><span> </span><span id="local-6989586621683018144"><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683018144"><span class="hs-identifier hs-var">tclvl</span></a></span></span><span> </span><span id="local-6989586621683018145"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683018145"><span class="hs-identifier hs-var">wanted</span></a></span></span><span>
</span><span id="line-523"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; TcM Implication -&gt; TcM Implication
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TcTyVar -&gt; Bool) -&gt; [TcTyVar] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isSkolemTyVar"><span class="hs-identifier hs-var">isSkolemTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">(TcTyVar -&gt; Bool) -&gt; (TcTyVar -&gt; Bool) -&gt; TcTyVar -&gt; Bool
forall (f :: * -&gt; *). Applicative f =&gt; f Bool -&gt; f Bool -&gt; f Bool
</span><a href="GHC.Utils.Misc.html#%3C%7C%7C%3E"><span class="hs-operator hs-var">&lt;||&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isTyVarTyVar"><span class="hs-identifier hs-var">isTyVarTyVar</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683018143"><span class="hs-identifier hs-var">skol_tvs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TcTyVar] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683018143"><span class="hs-identifier hs-var">skol_tvs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcM Implication -&gt; TcM Implication)
-&gt; TcM Implication -&gt; TcM Implication
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-524"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018150"><span class="annot"><a href="#local-6989586621683018150"><span class="hs-identifier hs-var">ev_binds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM EvBindsVar
</span><a href="GHC.Tc.Utils.Monad.html#newNoTcEvBinds"><span class="hs-identifier hs-var">newNoTcEvBinds</span></a></span><span>  </span><span class="hs-comment">-- Used for equalities only, so all the constraints</span><span>
</span><span id="line-525"></span><span>                                     </span><span class="hs-comment">-- are solved by filling in coercion holes, not</span><span>
</span><span id="line-526"></span><span>                                     </span><span class="hs-comment">-- by creating a value-level evidence binding</span><span>
</span><span id="line-527"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018152"><span class="annot"><a href="#local-6989586621683018152"><span class="hs-identifier hs-var">implic</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#newImplication"><span class="hs-identifier hs-type">newImplication</span></a></span><span>
</span><span id="line-528"></span><span>
</span><span id="line-529"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683018154"><span class="annot"><a href="#local-6989586621683018154"><span class="hs-identifier hs-var hs-var">implic'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Implication
</span><a href="#local-6989586621683018152"><span class="hs-identifier hs-var">implic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ic_tclvl"><span class="hs-identifier hs-var">ic_tclvl</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683018144"><span class="hs-identifier hs-type">tclvl</span></a></span><span>
</span><span id="line-530"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ic_skols"><span class="hs-identifier hs-var">ic_skols</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683018143"><span class="hs-identifier hs-type">skol_tvs</span></a></span><span>
</span><span id="line-531"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ic_given_eqs"><span class="hs-identifier hs-var">ic_given_eqs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#NoGivenEqs"><span class="hs-identifier hs-type">NoGivenEqs</span></a></span><span>
</span><span id="line-532"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ic_wanted"><span class="hs-identifier hs-var">ic_wanted</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683018145"><span class="hs-identifier hs-type">wanted</span></a></span><span>
</span><span id="line-533"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ic_binds"><span class="hs-identifier hs-var">ic_binds</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683018150"><span class="hs-identifier hs-type">ev_binds</span></a></span><span>
</span><span id="line-534"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ic_info"><span class="hs-identifier hs-var">ic_info</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683018142"><span class="hs-identifier hs-type">skol_info</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-535"></span><span>
</span><span id="line-536"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#checkImplicationInvariants"><span class="hs-identifier hs-type">checkImplicationInvariants</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018154"><span class="hs-identifier hs-type">implic'</span></a></span><span>
</span><span id="line-537"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683018154"><span class="hs-identifier hs-type">implic'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-538"></span><span>
</span><span id="line-539"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#implicationNeeded"><span class="hs-identifier hs-type">implicationNeeded</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#SkolemInfoAnon"><span class="hs-identifier hs-type">SkolemInfoAnon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#EvVar"><span class="hs-identifier hs-type">EvVar</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-540"></span><span class="hs-comment">-- See Note [When to build an implication]</span><span>
</span><span id="line-541"></span><span id="implicationNeeded"><span class="annot"><span class="annottext">implicationNeeded :: SkolemInfoAnon -&gt; [TcTyVar] -&gt; [TcTyVar] -&gt; TcM Bool
</span><a href="GHC.Tc.Utils.Unify.html#implicationNeeded"><span class="hs-identifier hs-var hs-var">implicationNeeded</span></a></span></span><span> </span><span id="local-6989586621683018163"><span class="annot"><span class="annottext">SkolemInfoAnon
</span><a href="#local-6989586621683018163"><span class="hs-identifier hs-var">skol_info</span></a></span></span><span> </span><span id="local-6989586621683018164"><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683018164"><span class="hs-identifier hs-var">skol_tvs</span></a></span></span><span> </span><span id="local-6989586621683018165"><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683018165"><span class="hs-identifier hs-var">given</span></a></span></span><span>
</span><span id="line-542"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[TcTyVar] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683018164"><span class="hs-identifier hs-var">skol_tvs</span></a></span><span>
</span><span id="line-543"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TcTyVar] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683018165"><span class="hs-identifier hs-var">given</span></a></span><span>
</span><span id="line-544"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SkolemInfoAnon -&gt; Bool
</span><a href="GHC.Tc.Utils.Unify.html#alwaysBuildImplication"><span class="hs-identifier hs-var">alwaysBuildImplication</span></a></span><span> </span><span class="annot"><span class="annottext">SkolemInfoAnon
</span><a href="#local-6989586621683018163"><span class="hs-identifier hs-var">skol_info</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-545"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- Empty skolems and givens</span><span>
</span><span id="line-546"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018168"><span class="annot"><a href="#local-6989586621683018168"><span class="hs-identifier hs-var">tc_lvl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM TcLevel
</span><a href="GHC.Tc.Utils.Monad.html#getTcLevel"><span class="hs-identifier hs-var">getTcLevel</span></a></span><span>
</span><span id="line-547"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#isTopTcLevel"><span class="hs-identifier hs-type">isTopTcLevel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018168"><span class="hs-identifier hs-type">tc_lvl</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- No implication needed if we are</span><span>
</span><span id="line-548"></span><span>         </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span>             </span><span class="hs-comment">-- already inside an implication</span><span>
</span><span id="line-549"></span><span>         </span><span class="hs-keyword">else</span><span>
</span><span id="line-550"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018171"><span class="annot"><a href="#local-6989586621683018171"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Driver.DynFlags.html#getDynFlags"><span class="hs-identifier hs-type">getDynFlags</span></a></span><span>       </span><span class="hs-comment">-- If any deferral can happen,</span><span>
</span><span id="line-551"></span><span>                                     </span><span class="hs-comment">-- we must build an implication</span><span>
</span><span id="line-552"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Driver.DynFlags.html#gopt"><span class="hs-identifier hs-type">gopt</span></a></span><span> </span><span class="annot"><a href="GHC.Driver.Flags.html#Opt_DeferTypeErrors"><span class="hs-identifier hs-type">Opt_DeferTypeErrors</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018171"><span class="hs-identifier hs-type">dflags</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">||</span></span><span>
</span><span id="line-553"></span><span>                 </span><span class="annot"><a href="GHC.Driver.DynFlags.html#gopt"><span class="hs-identifier hs-type">gopt</span></a></span><span> </span><span class="annot"><a href="GHC.Driver.Flags.html#Opt_DeferTypedHoles"><span class="hs-identifier hs-type">Opt_DeferTypedHoles</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018171"><span class="hs-identifier hs-type">dflags</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">||</span></span><span>
</span><span id="line-554"></span><span>                 </span><span class="annot"><a href="GHC.Driver.DynFlags.html#gopt"><span class="hs-identifier hs-type">gopt</span></a></span><span> </span><span class="annot"><a href="GHC.Driver.Flags.html#Opt_DeferOutOfScopeVariables"><span class="hs-identifier hs-type">Opt_DeferOutOfScopeVariables</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018171"><span class="hs-identifier hs-type">dflags</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-555"></span><span>
</span><span id="line-556"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>     </span><span class="hs-comment">-- Non-empty skolems or givens</span><span>
</span><span id="line-557"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcM Bool
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>   </span><span class="hs-comment">-- Definitely need an implication</span><span>
</span><span id="line-558"></span><span>
</span><span id="line-559"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#alwaysBuildImplication"><span class="hs-identifier hs-type">alwaysBuildImplication</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#SkolemInfoAnon"><span class="hs-identifier hs-type">SkolemInfoAnon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-560"></span><span class="hs-comment">-- See Note [When to build an implication]</span><span>
</span><span id="line-561"></span><span id="alwaysBuildImplication"><span class="annot"><span class="annottext">alwaysBuildImplication :: SkolemInfoAnon -&gt; Bool
</span><a href="GHC.Tc.Utils.Unify.html#alwaysBuildImplication"><span class="hs-identifier hs-var hs-var">alwaysBuildImplication</span></a></span></span><span> </span><span class="annot"><span class="annottext">SkolemInfoAnon
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-562"></span><span>
</span><span id="line-563"></span><span class="hs-comment">{-  Commmented out for now while I figure out about error messages.
    See #14185

alwaysBuildImplication (SigSkol ctxt _ _)
  = case ctxt of
      FunSigCtxt {} -&gt; True  -- RHS of a binding with a signature
      _             -&gt; False
alwaysBuildImplication (RuleSkol {})      = True
alwaysBuildImplication (InstSkol {})      = True
alwaysBuildImplication (FamInstSkol {})   = True
alwaysBuildImplication _                  = False
-}</span><span>
</span><span id="line-575"></span><span>
</span><span id="line-576"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#buildImplicationFor"><span class="hs-identifier hs-type">buildImplicationFor</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcLevel"><span class="hs-identifier hs-type">TcLevel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#SkolemInfoAnon"><span class="hs-identifier hs-type">SkolemInfoAnon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-577"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#EvVar"><span class="hs-identifier hs-type">EvVar</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span>
</span><span id="line-578"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Implication"><span class="hs-identifier hs-type">Implication</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#TcEvBinds"><span class="hs-identifier hs-type">TcEvBinds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-579"></span><span id="buildImplicationFor"><span class="annot"><span class="annottext">buildImplicationFor :: TcLevel
-&gt; SkolemInfoAnon
-&gt; [TcTyVar]
-&gt; [TcTyVar]
-&gt; WantedConstraints
-&gt; TcM (Bag Implication, TcEvBinds)
</span><a href="GHC.Tc.Utils.Unify.html#buildImplicationFor"><span class="hs-identifier hs-var hs-var">buildImplicationFor</span></a></span></span><span> </span><span id="local-6989586621683018177"><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683018177"><span class="hs-identifier hs-var">tclvl</span></a></span></span><span> </span><span id="local-6989586621683018178"><span class="annot"><span class="annottext">SkolemInfoAnon
</span><a href="#local-6989586621683018178"><span class="hs-identifier hs-var">skol_info</span></a></span></span><span> </span><span id="local-6989586621683018179"><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683018179"><span class="hs-identifier hs-var">skol_tvs</span></a></span></span><span> </span><span id="local-6989586621683018180"><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683018180"><span class="hs-identifier hs-var">given</span></a></span></span><span> </span><span id="local-6989586621683018181"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683018181"><span class="hs-identifier hs-var">wanted</span></a></span></span><span>
</span><span id="line-580"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isEmptyWC"><span class="hs-identifier hs-var">isEmptyWC</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683018181"><span class="hs-identifier hs-var">wanted</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">[TcTyVar] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683018180"><span class="hs-identifier hs-var">given</span></a></span><span>
</span><span id="line-581"></span><span>             </span><span class="hs-comment">-- Optimisation : if there are no wanteds, and no givens</span><span>
</span><span id="line-582"></span><span>             </span><span class="hs-comment">-- don't generate an implication at all.</span><span>
</span><span id="line-583"></span><span>             </span><span class="hs-comment">-- Reason for the (null given): we don't want to lose</span><span>
</span><span id="line-584"></span><span>             </span><span class="hs-comment">-- the &quot;inaccessible alternative&quot; error check</span><span>
</span><span id="line-585"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Bag Implication, TcEvBinds) -&gt; TcM (Bag Implication, TcEvBinds)
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bag Implication
forall a. Bag a
</span><a href="GHC.Data.Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcEvBinds
</span><a href="GHC.Tc.Types.Evidence.html#emptyTcEvBinds"><span class="hs-identifier hs-var">emptyTcEvBinds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-586"></span><span>
</span><span id="line-587"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-588"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; SDoc
-&gt; TcM (Bag Implication, TcEvBinds)
-&gt; TcM (Bag Implication, TcEvBinds)
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TcTyVar -&gt; Bool) -&gt; [TcTyVar] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isSkolemTyVar"><span class="hs-identifier hs-var">isSkolemTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">(TcTyVar -&gt; Bool) -&gt; (TcTyVar -&gt; Bool) -&gt; TcTyVar -&gt; Bool
forall (f :: * -&gt; *). Applicative f =&gt; f Bool -&gt; f Bool -&gt; f Bool
</span><a href="GHC.Utils.Misc.html#%3C%7C%7C%3E"><span class="hs-operator hs-var">&lt;||&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isTyVarTyVar"><span class="hs-identifier hs-var">isTyVarTyVar</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683018179"><span class="hs-identifier hs-var">skol_tvs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TcTyVar] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683018179"><span class="hs-identifier hs-var">skol_tvs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcM (Bag Implication, TcEvBinds)
 -&gt; TcM (Bag Implication, TcEvBinds))
-&gt; TcM (Bag Implication, TcEvBinds)
-&gt; TcM (Bag Implication, TcEvBinds)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-589"></span><span>      </span><span class="hs-comment">-- Why allow TyVarTvs? Because implicitly declared kind variables in</span><span>
</span><span id="line-590"></span><span>      </span><span class="hs-comment">-- non-CUSK type declarations are TyVarTvs, and we need to bring them</span><span>
</span><span id="line-591"></span><span>      </span><span class="hs-comment">-- into scope as a skolem in an implication. This is OK, though,</span><span>
</span><span id="line-592"></span><span>      </span><span class="hs-comment">-- because TyVarTvs will always remain tyvars, even after unification.</span><span>
</span><span id="line-593"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018184"><span class="annot"><a href="#local-6989586621683018184"><span class="hs-identifier hs-var">ev_binds_var</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM EvBindsVar
</span><a href="GHC.Tc.Utils.Monad.html#newTcEvBinds"><span class="hs-identifier hs-var">newTcEvBinds</span></a></span><span>
</span><span id="line-594"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018186"><span class="annot"><a href="#local-6989586621683018186"><span class="hs-identifier hs-var">implic</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#newImplication"><span class="hs-identifier hs-type">newImplication</span></a></span><span>
</span><span id="line-595"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683018187"><span class="annot"><a href="#local-6989586621683018187"><span class="hs-identifier hs-var hs-var">implic'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Implication
</span><a href="#local-6989586621683018186"><span class="hs-identifier hs-var">implic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ic_tclvl"><span class="hs-identifier hs-var">ic_tclvl</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683018177"><span class="hs-identifier hs-type">tclvl</span></a></span><span>
</span><span id="line-596"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ic_skols"><span class="hs-identifier hs-var">ic_skols</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683018179"><span class="hs-identifier hs-type">skol_tvs</span></a></span><span>
</span><span id="line-597"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ic_given"><span class="hs-identifier hs-var">ic_given</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683018180"><span class="hs-identifier hs-type">given</span></a></span><span>
</span><span id="line-598"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ic_wanted"><span class="hs-identifier hs-var">ic_wanted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683018181"><span class="hs-identifier hs-type">wanted</span></a></span><span>
</span><span id="line-599"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ic_binds"><span class="hs-identifier hs-var">ic_binds</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683018184"><span class="hs-identifier hs-type">ev_binds_var</span></a></span><span>
</span><span id="line-600"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ic_info"><span class="hs-identifier hs-var">ic_info</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683018178"><span class="hs-identifier hs-type">skol_info</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-601"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#checkImplicationInvariants"><span class="hs-identifier hs-type">checkImplicationInvariants</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018187"><span class="hs-identifier hs-type">implic'</span></a></span><span>
</span><span id="line-602"></span><span>
</span><span id="line-603"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Bag.html#unitBag"><span class="hs-identifier hs-type">unitBag</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018187"><span class="hs-identifier hs-type">implic'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#TcEvBinds"><span class="hs-identifier hs-type">TcEvBinds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018184"><span class="hs-identifier hs-type">ev_binds_var</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-604"></span><span>
</span><span id="line-605"></span><span class="hs-comment">{- Note [When to build an implication]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have some 'skolems' and some 'givens', and we are
considering whether to wrap the constraints in their scope into an
implication.  We must /always/ do so if either 'skolems' or 'givens' are
non-empty.  But what if both are empty?  You might think we could
always drop the implication.  Other things being equal, the fewer
implications the better.  Less clutter and overhead.  But we must
take care:

* If we have an unsolved [W] g :: a ~# b, and -fdefer-type-errors,
  we'll make a /term-level/ evidence binding for 'g = error &quot;blah&quot;'.
  We must have an EvBindsVar those bindings!, otherwise they end up as
  top-level unlifted bindings, which are verboten. This only matters
  at top level, so we check for that
  See also Note [Deferred errors for coercion holes] in GHC.Tc.Errors.
  cf #14149 for an example of what goes wrong.

* This is /necessary/ for top level but may be /desirable/ even for
  nested bindings, because if the deferred coercion is bound too far
  out it will be reported even if that thunk (say) is not evaluated.

* If you have
     f :: Int;  f = f_blah
     g :: Bool; g = g_blah
  If we don't build an implication for f or g (no tyvars, no givens),
  the constraints for f_blah and g_blah are solved together.  And that
  can yield /very/ confusing error messages, because we can get
      [W] C Int b1    -- from f_blah
      [W] C Int b2    -- from g_blan
  and fundeps can yield [W] b1 ~ b2, even though the two functions have
  literally nothing to do with each other.  #14185 is an example.
  Building an implication keeps them separate.

Note [Herald for matchExpectedFunTys]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The 'herald' always looks like:
   &quot;The equation(s) for 'f' have&quot;
   &quot;The abstraction (\x.e) takes&quot;
   &quot;The section (+ x) expects&quot;
   &quot;The function 'f' is applied to&quot;

This is used to construct a message of form

   The abstraction `\Just 1 -&gt; ...' takes two arguments
   but its type `Maybe a -&gt; a' has only one

   The equation(s) for `f' have two arguments
   but its type `Maybe a -&gt; a' has only one

   The section `(f 3)' requires 'f' to take two arguments
   but its type `Int -&gt; Int' has only one

   The function 'f' is applied to two arguments
   but its type `Int -&gt; Int' has only one

When visible type applications (e.g., `f @Int 1 2`, as in #13902) enter the
picture, we have a choice in deciding whether to count the type applications as
proper arguments:

   The function 'f' is applied to one visible type argument
     and two value arguments
   but its type `forall a. a -&gt; a` has only one visible type argument
     and one value argument

Or whether to include the type applications as part of the herald itself:

   The expression 'f @Int' is applied to two arguments
   but its type `Int -&gt; Int` has only one

The latter is easier to implement and is arguably easier to understand, so we
choose to implement that option.

Note [matchExpectedFunTys]
~~~~~~~~~~~~~~~~~~~~~~~~~~
matchExpectedFunTys checks that a sigma has the form
of an n-ary function.  It passes the decomposed type to the
thing_inside, and returns a wrapper to coerce between the two types

It's used wherever a language construct must have a functional type,
namely:
        A lambda expression
        A function definition
     An operator section

This function must be written CPS'd because it needs to fill in the
ExpTypes produced for arguments before it can fill in the ExpType
passed in.

Note [Return arguments with a fixed RuntimeRep]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The functions

  - matchExpectedFunTys,
  - matchActualFunTy,
  - matchActualFunTys,

peel off argument types, as explained in Note [matchExpectedFunTys].
It's important that these functions return argument types that have
a fixed runtime representation, otherwise we would be in violation
of the representation-polymorphism invariants of
Note [Representation polymorphism invariants] in GHC.Core.

This is why all these functions have an additional invariant,
that the argument types they return all have a syntactically fixed RuntimeRep,
in the sense of Note [Fixed RuntimeRep] in GHC.Tc.Utils.Concrete.

Example:

  Suppose we have

    type F :: Type -&gt; RuntimeRep
    type family F a where { F Int = LiftedRep }

    type Dual :: Type -&gt; Type
    type family Dual a where
      Dual a = a -&gt; ()

    f :: forall (a :: TYPE (F Int)). Dual a
    f = \ x -&gt; ()

  The body of `f` is a lambda abstraction, so we must be able to split off
  one argument type from its type. This is handled by `matchExpectedFunTys`
  (see 'GHC.Tc.Gen.Match.tcLambdaMatches'). We end up with desugared Core that
  looks like this:

    f :: forall (a :: TYPE (F Int)). Dual (a |&gt; (TYPE F[0]))
    f = \ @(a :: TYPE (F Int)) -&gt;
          (\ (x :: (a |&gt; (TYPE F[0]))) -&gt; ())
          `cast`
          (Sub (Sym (Dual[0] &lt;(a |&gt; (TYPE F[0]))&gt;)))

  Two important transformations took place:

    1. We inserted casts around the argument type to ensure that it has
       a fixed runtime representation, as required by invariant (I1) from
       Note [Representation polymorphism invariants] in GHC.Core.
    2. We inserted a cast around the whole lambda to make everything line up
       with the type signature.
-}</span><span>
</span><span id="line-745"></span><span>
</span><span id="line-746"></span><span class="hs-comment">-- | Use this function to split off arguments types when you have an</span><span>
</span><span id="line-747"></span><span class="hs-comment">-- \&quot;expected\&quot; type.</span><span>
</span><span id="line-748"></span><span class="hs-comment">--</span><span>
</span><span id="line-749"></span><span class="hs-comment">-- This function skolemises at each polytype.</span><span>
</span><span id="line-750"></span><span class="hs-comment">--</span><span>
</span><span id="line-751"></span><span class="hs-comment">-- Invariant: this function only applies the provided function</span><span>
</span><span id="line-752"></span><span class="hs-comment">-- to a list of argument types which all have a syntactically fixed RuntimeRep</span><span>
</span><span id="line-753"></span><span class="hs-comment">-- in the sense of Note [Fixed RuntimeRep] in GHC.Tc.Utils.Concrete.</span><span>
</span><span id="line-754"></span><span class="hs-comment">-- See Note [Return arguments with a fixed RuntimeRep].</span><span>
</span><span id="line-755"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#matchExpectedFunTys"><span class="hs-identifier hs-type">matchExpectedFunTys</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621683017211"><span class="annot"><a href="#local-6989586621683017211"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-756"></span><span>                       </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#ExpectedFunTyOrigin"><span class="hs-identifier hs-type">ExpectedFunTyOrigin</span></a></span><span>  </span><span class="hs-comment">-- See Note [Herald for matchExpectedFunTys]</span><span>
</span><span id="line-757"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span>
</span><span id="line-758"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#VisArity"><span class="hs-identifier hs-type">VisArity</span></a></span><span>
</span><span id="line-759"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#ExpSigmaType"><span class="hs-identifier hs-type">ExpSigmaType</span></a></span><span>
</span><span id="line-760"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#ExpPatType"><span class="hs-identifier hs-type">ExpPatType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#ExpRhoType"><span class="hs-identifier hs-type">ExpRhoType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017211"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-761"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683017211"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-762"></span><span class="hs-comment">-- If    matchExpectedFunTys n ty = (wrap, _)</span><span>
</span><span id="line-763"></span><span class="hs-comment">-- then  wrap : (t1 -&gt; ... -&gt; tn -&gt; ty_r) ~&gt; ty,</span><span>
</span><span id="line-764"></span><span class="hs-comment">--   where [t1, ..., tn], ty_r are passed to the thing_inside</span><span>
</span><span id="line-765"></span><span class="hs-comment">--</span><span>
</span><span id="line-766"></span><span class="hs-comment">-- Unconditionally concludes by skolemising any trailing invisible</span><span>
</span><span id="line-767"></span><span class="hs-comment">-- binders and, if DeepSubsumption is on, it does so deeply.</span><span>
</span><span id="line-768"></span><span class="hs-comment">--</span><span>
</span><span id="line-769"></span><span class="hs-comment">-- Postcondition:</span><span>
</span><span id="line-770"></span><span class="hs-comment">--   If exp_ty is Check {}, then [ExpPatType] and ExpRhoType results are all Check{}</span><span>
</span><span id="line-771"></span><span class="hs-comment">--   If exp_ty is Infer {}, then [ExpPatType] and ExpRhoType results are all Infer{}</span><span>
</span><span id="line-772"></span><span id="matchExpectedFunTys"><span class="annot"><span class="annottext">matchExpectedFunTys :: forall a.
ExpectedFunTyOrigin
-&gt; UserTypeCtxt
-&gt; Int
-&gt; ExpRhoType
-&gt; ([ExpPatType] -&gt; ExpRhoType -&gt; TcM a)
-&gt; TcM (HsWrapper, a)
</span><a href="GHC.Tc.Utils.Unify.html#matchExpectedFunTys"><span class="hs-identifier hs-var hs-var">matchExpectedFunTys</span></a></span></span><span> </span><span id="local-6989586621683018256"><span class="annot"><span class="annottext">ExpectedFunTyOrigin
</span><a href="#local-6989586621683018256"><span class="hs-identifier hs-var">herald</span></a></span></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683018257"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683018257"><span class="hs-identifier hs-var">arity</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#Infer"><span class="hs-identifier hs-type">Infer</span></a></span><span> </span><span id="local-6989586621683018259"><span class="annot"><span class="annottext">InferResult
</span><a href="#local-6989586621683018259"><span class="hs-identifier hs-var">inf_res</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621683018260"><span class="annot"><span class="annottext">[ExpPatType] -&gt; ExpRhoType -&gt; TcM a
</span><a href="#local-6989586621683018260"><span class="hs-identifier hs-var">thing_inside</span></a></span></span><span>
</span><span id="line-773"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018261"><span class="annot"><a href="#local-6989586621683018261"><span class="hs-identifier hs-var">arg_tys</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; IOEnv (Env TcGblEnv TcLclEnv) (Scaled ExpRhoType))
-&gt; [Int] -&gt; IOEnv (Env TcGblEnv TcLclEnv) [Scaled ExpRhoType]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExpectedFunTyOrigin
-&gt; Int -&gt; IOEnv (Env TcGblEnv TcLclEnv) (Scaled ExpRhoType)
</span><a href="GHC.Tc.Utils.Unify.html#new_infer_arg_ty"><span class="hs-identifier hs-var">new_infer_arg_ty</span></a></span><span> </span><span class="annot"><span class="annottext">ExpectedFunTyOrigin
</span><a href="#local-6989586621683018256"><span class="hs-identifier hs-var">herald</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683018257"><span class="hs-identifier hs-var">arity</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-774"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018264"><span class="annot"><a href="#local-6989586621683018264"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#newInferExpType"><span class="hs-identifier hs-type">newInferExpType</span></a></span><span>
</span><span id="line-775"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018266"><span class="annot"><a href="#local-6989586621683018266"><span class="hs-identifier hs-var">result</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621683018260"><span class="hs-identifier hs-type">thing_inside</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">map</span></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#ExpFunPatTy"><span class="hs-identifier hs-type">ExpFunPatTy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018261"><span class="hs-identifier hs-type">arg_tys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683018264"><span class="hs-identifier hs-type">res_ty</span></a></span><span>
</span><span id="line-776"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018268"><span class="annot"><a href="#local-6989586621683018268"><span class="hs-identifier hs-var">arg_tys</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mapM</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Scaled"><span class="hs-identifier hs-type">Scaled</span></a></span><span> </span><span id="local-6989586621683018269"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018269"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621683018270"><span class="annot"><span class="annottext">ExpRhoType
</span><a href="#local-6989586621683018270"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; Scaled TcType
forall a. TcType -&gt; a -&gt; Scaled a
</span><a href="GHC.Core.TyCo.Rep.html#Scaled"><span class="hs-identifier hs-var">Scaled</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018269"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">(TcType -&gt; Scaled TcType) -&gt; TcM TcType -&gt; TcM (Scaled TcType)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ExpRhoType -&gt; TcM TcType
forall (m :: * -&gt; *). MonadIO m =&gt; ExpRhoType -&gt; m TcType
</span><a href="GHC.Tc.Utils.TcMType.html#readExpType"><span class="hs-identifier hs-var">readExpType</span></a></span><span> </span><span class="annot"><span class="annottext">ExpRhoType
</span><a href="#local-6989586621683018270"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683018261"><span class="hs-identifier hs-type">arg_tys</span></a></span><span>
</span><span id="line-777"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018273"><span class="annot"><a href="#local-6989586621683018273"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#readExpType"><span class="hs-identifier hs-type">readExpType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018264"><span class="hs-identifier hs-type">res_ty</span></a></span><span>
</span><span id="line-778"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018274"><span class="annot"><a href="#local-6989586621683018274"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#fillInferResult"><span class="hs-identifier hs-type">fillInferResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#mkScaledFunTys"><span class="hs-identifier hs-type">mkScaledFunTys</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018268"><span class="hs-identifier hs-type">arg_tys</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018273"><span class="hs-identifier hs-type">res_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683018259"><span class="hs-identifier hs-type">inf_res</span></a></span><span>
</span><span id="line-779"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#mkWpCastN"><span class="hs-identifier hs-type">mkWpCastN</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018274"><span class="hs-identifier hs-type">co</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683018266"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-780"></span><span>
</span><span id="line-781"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#matchExpectedFunTys"><span class="hs-identifier hs-var">matchExpectedFunTys</span></a></span><span> </span><span id="local-6989586621683018275"><span class="annot"><span class="annottext">ExpectedFunTyOrigin
</span><a href="#local-6989586621683018275"><span class="hs-identifier hs-var">herald</span></a></span></span><span> </span><span id="local-6989586621683018276"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683018276"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621683018277"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683018277"><span class="hs-identifier hs-var">arity</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#Check"><span class="hs-identifier hs-type">Check</span></a></span><span> </span><span id="local-6989586621683018279"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018279"><span class="hs-identifier hs-var">top_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621683018280"><span class="annot"><span class="annottext">[ExpPatType] -&gt; ExpRhoType -&gt; TcM a
</span><a href="#local-6989586621683018280"><span class="hs-identifier hs-var">thing_inside</span></a></span></span><span>
</span><span id="line-782"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; [ExpPatType]
-&gt; TcType
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (HsWrapper, a)
</span><a href="#local-6989586621683018281"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683018277"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018279"><span class="hs-identifier hs-var">top_ty</span></a></span><span>
</span><span id="line-783"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-784"></span><span>    </span><span class="annot"><a href="#local-6989586621683018281"><span class="hs-identifier hs-type">check</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#VisArity"><span class="hs-identifier hs-type">VisArity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#ExpPatType"><span class="hs-identifier hs-type">ExpPatType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683017211"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-785"></span><span>    </span><span class="hs-comment">-- `check` is called only in the Check{} case</span><span>
</span><span id="line-786"></span><span>    </span><span class="hs-comment">-- It collects rev_pat_tys in reversed order</span><span>
</span><span id="line-787"></span><span>    </span><span class="hs-comment">-- n_req is the number of /visible/ arguments still needed</span><span>
</span><span id="line-788"></span><span>
</span><span id="line-789"></span><span>    </span><span class="hs-comment">----------------------------</span><span>
</span><span id="line-790"></span><span>    </span><span class="hs-comment">-- Skolemise quantifiers, both visible (up to n_req) and invisible</span><span>
</span><span id="line-791"></span><span>    </span><span class="hs-comment">-- See Note [Visible type application and abstraction] in GHC.Tc.Gen.App</span><span>
</span><span id="line-792"></span><span>    </span><span id="local-6989586621683018281"><span class="annot"><span class="annottext">check :: Int
-&gt; [ExpPatType]
-&gt; TcType
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (HsWrapper, a)
</span><a href="#local-6989586621683018281"><span class="hs-identifier hs-var hs-var">check</span></a></span></span><span> </span><span id="local-6989586621683018282"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683018282"><span class="hs-identifier hs-var">n_req</span></a></span></span><span> </span><span id="local-6989586621683018283"><span class="annot"><span class="annottext">[ExpPatType]
</span><a href="#local-6989586621683018283"><span class="hs-identifier hs-var">rev_pat_tys</span></a></span></span><span> </span><span id="local-6989586621683018284"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018284"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-793"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isSigmaTy"><span class="hs-identifier hs-var">isSigmaTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018284"><span class="hs-identifier hs-var">ty</span></a></span><span>                     </span><span class="hs-comment">-- An invisible quantifier at the top</span><span>
</span><span id="line-794"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683018282"><span class="hs-identifier hs-var">n_req</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="GHC.Core.Type.html#isForAllTy"><span class="hs-identifier hs-var">isForAllTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018284"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- A visible quantifier at top, and we need it</span><span>
</span><span id="line-795"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">rec</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018288"><span class="annot"><a href="#local-6989586621683018288"><span class="hs-identifier hs-var">n_req'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018289"><span class="annot"><a href="#local-6989586621683018289"><span class="hs-identifier hs-var">wrap_gen</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018290"><span class="annot"><a href="#local-6989586621683018290"><span class="hs-identifier hs-var">tv_nms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018291"><span class="annot"><a href="#local-6989586621683018291"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018292"><span class="annot"><a href="#local-6989586621683018292"><span class="hs-identifier hs-var">given</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018293"><span class="annot"><a href="#local-6989586621683018293"><span class="hs-identifier hs-var">inner_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Instantiate.html#skolemiseRequired"><span class="hs-identifier hs-type">skolemiseRequired</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018295"><span class="hs-identifier hs-type">skol_info</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018282"><span class="hs-identifier hs-type">n_req</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018284"><span class="hs-identifier hs-type">ty</span></a></span><span>
</span><span id="line-796"></span><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683018296"><span class="annot"><a href="#local-6989586621683018296"><span class="hs-identifier hs-var hs-var">sig_skol</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt -&gt; TcType -&gt; [(Name, TcTyVar)] -&gt; SkolemInfoAnon
</span><a href="GHC.Tc.Types.Origin.html#SigSkol"><span class="hs-identifier hs-var">SigSkol</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683018276"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018279"><span class="hs-identifier hs-var">top_ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621683018290"><span class="hs-identifier hs-var">tv_nms</span></a></span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; [TcTyVar] -&gt; [(Name, TcTyVar)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-operator hs-var">`zip`</span></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683018297"><span class="hs-identifier hs-var">skol_tvs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-797"></span><span>                       </span><span id="local-6989586621683018297"><span class="annot"><a href="#local-6989586621683018297"><span class="hs-identifier hs-var hs-var">skol_tvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ForAllTyBinder] -&gt; [TcTyVar]
forall tv argf. [VarBndr tv argf] -&gt; [tv]
</span><a href="GHC.Types.Var.html#binderVars"><span class="hs-identifier hs-var">binderVars</span></a></span><span> </span><span class="annot"><span class="annottext">[ForAllTyBinder]
</span><a href="#local-6989586621683018291"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-798"></span><span>                 </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018295"><span class="annot"><a href="#local-6989586621683018295"><span class="hs-identifier hs-var">skol_info</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#mkSkolemInfo"><span class="hs-identifier hs-type">mkSkolemInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018296"><span class="hs-identifier hs-type">sig_skol</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-799"></span><span>             </span><span class="hs-comment">-- rec {..}: see Note [Keeping SkolemInfo inside a SkolemTv]</span><span>
</span><span id="line-800"></span><span>             </span><span class="hs-comment">--           in GHC.Tc.Utils.TcType</span><span>
</span><span id="line-801"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018299"><span class="annot"><a href="#local-6989586621683018299"><span class="hs-identifier hs-var">ev_binds</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018300"><span class="annot"><a href="#local-6989586621683018300"><span class="hs-identifier hs-var">wrap_res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018301"><span class="annot"><a href="#local-6989586621683018301"><span class="hs-identifier hs-var">result</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-802"></span><span>                  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#checkConstraints"><span class="hs-identifier hs-type">checkConstraints</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#getSkolemInfo"><span class="hs-identifier hs-type">getSkolemInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018295"><span class="hs-identifier hs-type">skol_info</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683018297"><span class="hs-identifier hs-type">skol_tvs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018292"><span class="hs-identifier hs-type">given</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-803"></span><span>                     </span><span class="annot"><a href="#local-6989586621683018281"><span class="hs-identifier hs-type">check</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018288"><span class="hs-identifier hs-type">n_req'</span></a></span><span>
</span><span id="line-804"></span><span>                           </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">reverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">map</span></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#ExpForAllPatTy"><span class="hs-identifier hs-type">ExpForAllPatTy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018291"><span class="hs-identifier hs-type">bndrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621683018283"><span class="hs-identifier hs-type">rev_pat_tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-805"></span><span>                           </span><span class="annot"><a href="#local-6989586621683018293"><span class="hs-identifier hs-type">inner_ty</span></a></span><span>
</span><span id="line-806"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-type">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">null</span></span><span> </span><span class="annot"><a href="#local-6989586621683018291"><span class="hs-identifier hs-type">bndrs</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&amp;&amp;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">null</span></span><span> </span><span class="annot"><a href="#local-6989586621683018292"><span class="hs-identifier hs-type">given</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018284"><span class="hs-identifier hs-type">ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-807"></span><span>                       </span><span class="hs-comment">-- The guard ensures that we made some progress</span><span>
</span><span id="line-808"></span><span>             </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683018289"><span class="hs-identifier hs-type">wrap_gen</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#%3C.%3E"><span class="hs-operator hs-type">&lt;.&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#mkWpLet"><span class="hs-identifier hs-type">mkWpLet</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018299"><span class="hs-identifier hs-type">ev_binds</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#%3C.%3E"><span class="hs-operator hs-type">&lt;.&gt;</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018300"><span class="hs-identifier hs-type">wrap_res</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683018301"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-809"></span><span>
</span><span id="line-810"></span><span>    </span><span class="hs-comment">----------------------------</span><span>
</span><span id="line-811"></span><span>    </span><span class="hs-comment">-- Base case: (n_req == 0): no more args</span><span>
</span><span id="line-812"></span><span>    </span><span class="hs-comment">--    The earlier skolemisation ensurs that rho_ty has no top-level invisible quantifiers</span><span>
</span><span id="line-813"></span><span>    </span><span class="hs-comment">--    If there is deep subsumption, do deep skolemisation now</span><span>
</span><span id="line-814"></span><span>    </span><span class="annot"><a href="#local-6989586621683018281"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span id="local-6989586621683018304"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683018304"><span class="hs-identifier hs-var">n_req</span></a></span></span><span> </span><span id="local-6989586621683018305"><span class="annot"><span class="annottext">[ExpPatType]
</span><a href="#local-6989586621683018305"><span class="hs-identifier hs-var">rev_pat_tys</span></a></span></span><span> </span><span id="local-6989586621683018306"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018306"><span class="hs-identifier hs-var">rho_ty</span></a></span></span><span>
</span><span id="line-815"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683018304"><span class="hs-identifier hs-var">n_req</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-816"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683018307"><span class="annot"><span class="annottext">pat_tys :: [ExpPatType]
</span><a href="#local-6989586621683018307"><span class="hs-identifier hs-var hs-var hs-var">pat_tys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ExpPatType] -&gt; [ExpPatType]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[ExpPatType]
</span><a href="#local-6989586621683018305"><span class="hs-identifier hs-var">rev_pat_tys</span></a></span><span>
</span><span id="line-817"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018308"><span class="annot"><a href="#local-6989586621683018308"><span class="hs-identifier hs-var">ds_flag</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM DeepSubsumptionFlag
</span><a href="GHC.Tc.Utils.Unify.html#getDeepSubsumptionFlag"><span class="hs-identifier hs-var">getDeepSubsumptionFlag</span></a></span><span>
</span><span id="line-818"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683018308"><span class="hs-identifier hs-type">ds_flag</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-819"></span><span>               </span><span class="annot"><span class="annottext">DeepSubsumptionFlag
</span><a href="GHC.Tc.Utils.Unify.html#Shallow"><span class="hs-identifier hs-var">Shallow</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018309"><span class="annot"><a href="#local-6989586621683018309"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[ExpPatType] -&gt; ExpRhoType -&gt; TcM a
</span><a href="#local-6989586621683018280"><span class="hs-identifier hs-var">thing_inside</span></a></span><span> </span><span class="annot"><span class="annottext">[ExpPatType]
</span><a href="#local-6989586621683018307"><span class="hs-identifier hs-var">pat_tys</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; ExpRhoType
</span><a href="GHC.Tc.Utils.TcType.html#mkCheckExpType"><span class="hs-identifier hs-var">mkCheckExpType</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018306"><span class="hs-identifier hs-var">rho_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-820"></span><span>                             </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#idHsWrapper"><span class="hs-identifier hs-type">idHsWrapper</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683018309"><span class="hs-identifier hs-type">res</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-821"></span><span>               </span><span class="annot"><span class="annottext">DeepSubsumptionFlag
</span><a href="GHC.Tc.Utils.Unify.html#Deep"><span class="hs-identifier hs-var">Deep</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DeepSubsumptionFlag
-&gt; UserTypeCtxt
-&gt; TcType
-&gt; TcType
-&gt; ([(Name, TcInvisTVBinder)] -&gt; TcType -&gt; TcM a)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (HsWrapper, a)
forall result.
DeepSubsumptionFlag
-&gt; UserTypeCtxt
-&gt; TcType
-&gt; TcType
-&gt; ([(Name, TcInvisTVBinder)] -&gt; TcType -&gt; TcM result)
-&gt; TcM (HsWrapper, result)
</span><a href="GHC.Tc.Utils.Unify.html#tcSkolemiseGeneral"><span class="hs-identifier hs-var">tcSkolemiseGeneral</span></a></span><span> </span><span class="annot"><span class="annottext">DeepSubsumptionFlag
</span><a href="GHC.Tc.Utils.Unify.html#Deep"><span class="hs-identifier hs-var">Deep</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683018276"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018279"><span class="hs-identifier hs-var">top_ty</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018306"><span class="hs-identifier hs-var">rho_ty</span></a></span><span> </span><span class="annot"><span class="annottext">(([(Name, TcInvisTVBinder)] -&gt; TcType -&gt; TcM a)
 -&gt; IOEnv (Env TcGblEnv TcLclEnv) (HsWrapper, a))
-&gt; ([(Name, TcInvisTVBinder)] -&gt; TcType -&gt; TcM a)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (HsWrapper, a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">[(Name, TcInvisTVBinder)]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683018311"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018311"><span class="hs-identifier hs-var">rho_ty</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-822"></span><span>                          </span><span class="hs-comment">-- &quot;_&quot; drop the /deeply/-skolemise binders</span><span>
</span><span id="line-823"></span><span>                          </span><span class="hs-comment">-- They do not line up with binders in the Match</span><span>
</span><span id="line-824"></span><span>                          </span><span class="annot"><span class="annottext">[ExpPatType] -&gt; ExpRhoType -&gt; TcM a
</span><a href="#local-6989586621683018280"><span class="hs-identifier hs-var">thing_inside</span></a></span><span> </span><span class="annot"><span class="annottext">[ExpPatType]
</span><a href="#local-6989586621683018307"><span class="hs-identifier hs-var">pat_tys</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; ExpRhoType
</span><a href="GHC.Tc.Utils.TcType.html#mkCheckExpType"><span class="hs-identifier hs-var">mkCheckExpType</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018311"><span class="hs-identifier hs-var">rho_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-825"></span><span>
</span><span id="line-826"></span><span>    </span><span class="hs-comment">----------------------------</span><span>
</span><span id="line-827"></span><span>    </span><span class="hs-comment">-- Function types</span><span>
</span><span id="line-828"></span><span>    </span><span class="annot"><a href="#local-6989586621683018281"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span id="local-6989586621683018312"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683018312"><span class="hs-identifier hs-var">n_req</span></a></span></span><span> </span><span id="local-6989586621683018313"><span class="annot"><span class="annottext">[ExpPatType]
</span><a href="#local-6989586621683018313"><span class="hs-identifier hs-var">rev_pat_tys</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#FunTy"><span class="hs-identifier hs-type">FunTy</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ft_af :: TcType -&gt; FunTyFlag
</span><a href="GHC.Core.TyCo.Rep.html#ft_af"><span class="hs-identifier hs-var">ft_af</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683018314"><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683018314"><span class="hs-identifier hs-var">af</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_mult :: TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#ft_mult"><span class="hs-identifier hs-var">ft_mult</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683018315"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018315"><span class="hs-identifier hs-var">mult</span></a></span></span><span>
</span><span id="line-829"></span><span>                                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_arg :: TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#ft_arg"><span class="hs-identifier hs-var">ft_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683018316"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018316"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_res :: TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#ft_res"><span class="hs-identifier hs-var">ft_res</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683018317"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018317"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-830"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (HsWrapper, a)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (HsWrapper, a)
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FunTyFlag -&gt; Bool
</span><a href="GHC.Types.Var.html#isVisibleFunArg"><span class="hs-identifier hs-var">isVisibleFunArg</span></a></span><span> </span><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683018314"><span class="hs-identifier hs-var">af</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IOEnv (Env TcGblEnv TcLclEnv) (HsWrapper, a)
 -&gt; IOEnv (Env TcGblEnv TcLclEnv) (HsWrapper, a))
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (HsWrapper, a)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (HsWrapper, a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-831"></span><span>        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683018318"><span class="annot"><span class="annottext">arg_pos :: Int
</span><a href="#local-6989586621683018318"><span class="hs-identifier hs-var hs-var hs-var">arg_pos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683018277"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683018312"><span class="hs-identifier hs-var">n_req</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>   </span><span class="hs-comment">-- 1 for the first argument etc</span><span>
</span><span id="line-832"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018320"><span class="annot"><a href="#local-6989586621683018320"><span class="hs-identifier hs-var">arg_co</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018321"><span class="annot"><a href="#local-6989586621683018321"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
FixedRuntimeRepContext -&gt; TcType -&gt; TcM (Coercion, TcType)
FixedRuntimeRepContext -&gt; TcType -&gt; TcM (Coercion, TcType)
</span><a href="GHC.Tc.Utils.Concrete.html#hasFixedRuntimeRep"><span class="hs-identifier hs-var">hasFixedRuntimeRep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExpectedFunTyOrigin -&gt; Int -&gt; FixedRuntimeRepContext
</span><a href="GHC.Tc.Types.Origin.html#FRRExpectedFunTy"><span class="hs-identifier hs-var">FRRExpectedFunTy</span></a></span><span> </span><span class="annot"><span class="annottext">ExpectedFunTyOrigin
</span><a href="#local-6989586621683018275"><span class="hs-identifier hs-var">herald</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683018318"><span class="hs-identifier hs-var">arg_pos</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018316"><span class="hs-identifier hs-var">arg_ty</span></a></span><span>
</span><span id="line-833"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018322"><span class="annot"><a href="#local-6989586621683018322"><span class="hs-identifier hs-var">wrap_res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018323"><span class="annot"><a href="#local-6989586621683018323"><span class="hs-identifier hs-var">result</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621683018281"><span class="hs-identifier hs-type">check</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683018312"><span class="hs-identifier hs-type">n_req</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">-</span></span><span> </span><span class="annot"><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-834"></span><span>                                         </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#mkCheckExpFunPatTy"><span class="hs-identifier hs-type">mkCheckExpFunPatTy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Scaled"><span class="hs-identifier hs-type">Scaled</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018315"><span class="hs-identifier hs-type">mult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018321"><span class="hs-identifier hs-type">arg_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="#local-6989586621683018313"><span class="hs-identifier hs-type">rev_pat_tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-835"></span><span>                                         </span><span class="annot"><a href="#local-6989586621683018317"><span class="hs-identifier hs-type">res_ty</span></a></span><span>
</span><span id="line-836"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683018325"><span class="annot"><a href="#local-6989586621683018325"><span class="hs-identifier hs-var hs-var">wrap_arg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; HsWrapper
</span><a href="GHC.Tc.Types.Evidence.html#mkWpCastN"><span class="hs-identifier hs-var">mkWpCastN</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683018320"><span class="hs-identifier hs-var">arg_co</span></a></span><span>
</span><span id="line-837"></span><span>                 </span><span id="local-6989586621683018326"><span class="annot"><a href="#local-6989586621683018326"><span class="hs-identifier hs-var hs-var">fun_wrap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HsWrapper -&gt; HsWrapper -&gt; Scaled TcType -&gt; TcType -&gt; HsWrapper
</span><a href="GHC.Tc.Types.Evidence.html#mkWpFun"><span class="hs-identifier hs-var">mkWpFun</span></a></span><span> </span><span class="annot"><span class="annottext">HsWrapper
</span><a href="#local-6989586621683018325"><span class="hs-identifier hs-var">wrap_arg</span></a></span><span> </span><span class="annot"><span class="annottext">HsWrapper
</span><a href="#local-6989586621683018322"><span class="hs-identifier hs-var">wrap_res</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; Scaled TcType
forall a. TcType -&gt; a -&gt; Scaled a
</span><a href="GHC.Core.TyCo.Rep.html#Scaled"><span class="hs-identifier hs-var">Scaled</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018315"><span class="hs-identifier hs-var">mult</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018321"><span class="hs-identifier hs-var">arg_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018317"><span class="hs-identifier hs-var">res_ty</span></a></span><span>
</span><span id="line-838"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683018326"><span class="hs-identifier hs-type">fun_wrap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683018323"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-839"></span><span>
</span><span id="line-840"></span><span>    </span><span class="hs-comment">----------------------------</span><span>
</span><span id="line-841"></span><span>    </span><span class="hs-comment">-- Type variables</span><span>
</span><span id="line-842"></span><span>    </span><span class="annot"><a href="#local-6989586621683018281"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span id="local-6989586621683018327"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683018327"><span class="hs-identifier hs-var">n_req</span></a></span></span><span> </span><span id="local-6989586621683018328"><span class="annot"><span class="annottext">[ExpPatType]
</span><a href="#local-6989586621683018328"><span class="hs-identifier hs-var">rev_pat_tys</span></a></span></span><span> </span><span id="local-6989586621683018329"><span class="annot"><span class="annottext">ty :: TcType
</span><a href="#local-6989586621683018329"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyVarTy"><span class="hs-identifier hs-type">TyVarTy</span></a></span><span> </span><span id="local-6989586621683018330"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683018330"><span class="hs-identifier hs-var">tv</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-843"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isMetaTyVar"><span class="hs-identifier hs-var">isMetaTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683018330"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-844"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018331"><span class="annot"><a href="#local-6989586621683018331"><span class="hs-identifier hs-var">cts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; IOEnv (Env TcGblEnv TcLclEnv) MetaDetails
forall (m :: * -&gt; *). MonadIO m =&gt; TcTyVar -&gt; m MetaDetails
</span><a href="GHC.Tc.Utils.TcMType.html#readMetaTyVar"><span class="hs-identifier hs-var">readMetaTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683018330"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-845"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683018331"><span class="hs-identifier hs-type">cts</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-846"></span><span>               </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#Indirect"><span class="hs-identifier hs-type">Indirect</span></a></span><span> </span><span id="local-6989586621683018332"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018332"><span class="hs-identifier hs-var">ty'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; [ExpPatType]
-&gt; TcType
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (HsWrapper, a)
</span><a href="#local-6989586621683018281"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683018327"><span class="hs-identifier hs-var">n_req</span></a></span><span> </span><span class="annot"><span class="annottext">[ExpPatType]
</span><a href="#local-6989586621683018328"><span class="hs-identifier hs-var">rev_pat_tys</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018332"><span class="hs-identifier hs-var">ty'</span></a></span><span>
</span><span id="line-847"></span><span>               </span><span class="annot"><span class="annottext">MetaDetails
</span><a href="GHC.Tc.Utils.TcType.html#Flexi"><span class="hs-identifier hs-var">Flexi</span></a></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; [ExpPatType]
-&gt; TcType
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (HsWrapper, a)
</span><a href="#local-6989586621683018333"><span class="hs-identifier hs-var">defer</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683018327"><span class="hs-identifier hs-var">n_req</span></a></span><span> </span><span class="annot"><span class="annottext">[ExpPatType]
</span><a href="#local-6989586621683018328"><span class="hs-identifier hs-var">rev_pat_tys</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018329"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-848"></span><span>
</span><span id="line-849"></span><span>    </span><span class="hs-comment">----------------------------</span><span>
</span><span id="line-850"></span><span>    </span><span class="hs-comment">-- NOW do coreView.  We didn't do it before, so that we do not unnecessarily</span><span>
</span><span id="line-851"></span><span>    </span><span class="hs-comment">-- unwrap a synonym in the returned rho_ty</span><span>
</span><span id="line-852"></span><span>    </span><span class="annot"><a href="#local-6989586621683018281"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span id="local-6989586621683018334"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683018334"><span class="hs-identifier hs-var">n_req</span></a></span></span><span> </span><span id="local-6989586621683018335"><span class="annot"><span class="annottext">[ExpPatType]
</span><a href="#local-6989586621683018335"><span class="hs-identifier hs-var">rev_pat_tys</span></a></span></span><span> </span><span id="local-6989586621683018336"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018336"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-853"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683018337"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018337"><span class="hs-identifier hs-var">ty'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe TcType
</span><a href="GHC.Core.Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018336"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; [ExpPatType]
-&gt; TcType
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (HsWrapper, a)
</span><a href="#local-6989586621683018281"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683018334"><span class="hs-identifier hs-var">n_req</span></a></span><span> </span><span class="annot"><span class="annottext">[ExpPatType]
</span><a href="#local-6989586621683018335"><span class="hs-identifier hs-var">rev_pat_tys</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018337"><span class="hs-identifier hs-var">ty'</span></a></span><span>
</span><span id="line-854"></span><span>
</span><span id="line-855"></span><span>       </span><span class="hs-comment">-- In all other cases we bale out into ordinary unification</span><span>
</span><span id="line-856"></span><span>       </span><span class="hs-comment">-- However unlike the meta-tyvar case, we are sure that the</span><span>
</span><span id="line-857"></span><span>       </span><span class="hs-comment">-- number of arguments doesn't match arity of the original</span><span>
</span><span id="line-858"></span><span>       </span><span class="hs-comment">-- type, so we can add a bit more context to the error message</span><span>
</span><span id="line-859"></span><span>       </span><span class="hs-comment">-- (cf #7869).</span><span>
</span><span id="line-860"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-861"></span><span>       </span><span class="hs-comment">-- It is not always an error, because specialized type may have</span><span>
</span><span id="line-862"></span><span>       </span><span class="hs-comment">-- different arity, for example:</span><span>
</span><span id="line-863"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-864"></span><span>       </span><span class="hs-comment">-- &gt; f1 = f2 'a'</span><span>
</span><span id="line-865"></span><span>       </span><span class="hs-comment">-- &gt; f2 :: Monad m =&gt; m Bool</span><span>
</span><span id="line-866"></span><span>       </span><span class="hs-comment">-- &gt; f2 = undefined</span><span>
</span><span id="line-867"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-868"></span><span>       </span><span class="hs-comment">-- But in that case we add specialized type into error context</span><span>
</span><span id="line-869"></span><span>       </span><span class="hs-comment">-- anyway, because it may be useful. See also #9605.</span><span>
</span><span id="line-870"></span><span>    </span><span class="annot"><a href="#local-6989586621683018281"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span id="local-6989586621683018338"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683018338"><span class="hs-identifier hs-var">n_req</span></a></span></span><span> </span><span id="local-6989586621683018339"><span class="annot"><span class="annottext">[ExpPatType]
</span><a href="#local-6989586621683018339"><span class="hs-identifier hs-var">rev_pat_tys</span></a></span></span><span> </span><span id="local-6989586621683018340"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018340"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span>
</span><span id="line-871"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TidyEnv -&gt; ZonkM (TidyEnv, SDoc))
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (HsWrapper, a)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (HsWrapper, a)
forall a. (TidyEnv -&gt; ZonkM (TidyEnv, SDoc)) -&gt; TcM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#addErrCtxtM"><span class="hs-identifier hs-var">addErrCtxtM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExpectedFunTyOrigin
-&gt; (Int, TcType) -&gt; TidyEnv -&gt; ZonkM (TidyEnv, SDoc)
</span><a href="GHC.Tc.Utils.Unify.html#mkFunTysMsg"><span class="hs-identifier hs-var">mkFunTysMsg</span></a></span><span> </span><span class="annot"><span class="annottext">ExpectedFunTyOrigin
</span><a href="#local-6989586621683018275"><span class="hs-identifier hs-var">herald</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683018277"><span class="hs-identifier hs-var">arity</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018279"><span class="hs-identifier hs-var">top_ty</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>  </span><span class="annot"><span class="annottext">(IOEnv (Env TcGblEnv TcLclEnv) (HsWrapper, a)
 -&gt; IOEnv (Env TcGblEnv TcLclEnv) (HsWrapper, a))
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (HsWrapper, a)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (HsWrapper, a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-872"></span><span>        </span><span class="annot"><span class="annottext">Int
-&gt; [ExpPatType]
-&gt; TcType
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (HsWrapper, a)
</span><a href="#local-6989586621683018333"><span class="hs-identifier hs-var">defer</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683018338"><span class="hs-identifier hs-var">n_req</span></a></span><span> </span><span class="annot"><span class="annottext">[ExpPatType]
</span><a href="#local-6989586621683018339"><span class="hs-identifier hs-var">rev_pat_tys</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018340"><span class="hs-identifier hs-var">res_ty</span></a></span><span>
</span><span id="line-873"></span><span>
</span><span id="line-874"></span><span>    </span><span class="hs-comment">------------</span><span>
</span><span id="line-875"></span><span>    </span><span class="annot"><a href="#local-6989586621683018333"><span class="hs-identifier hs-type">defer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#VisArity"><span class="hs-identifier hs-type">VisArity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#ExpPatType"><span class="hs-identifier hs-type">ExpPatType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcRhoType"><span class="hs-identifier hs-type">TcRhoType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683017211"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-876"></span><span>    </span><span id="local-6989586621683018333"><span class="annot"><span class="annottext">defer :: Int
-&gt; [ExpPatType]
-&gt; TcType
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (HsWrapper, a)
</span><a href="#local-6989586621683018333"><span class="hs-identifier hs-var hs-var">defer</span></a></span></span><span> </span><span id="local-6989586621683018341"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683018341"><span class="hs-identifier hs-var">n_req</span></a></span></span><span> </span><span id="local-6989586621683018342"><span class="annot"><span class="annottext">[ExpPatType]
</span><a href="#local-6989586621683018342"><span class="hs-identifier hs-var">rev_pat_tys</span></a></span></span><span> </span><span id="local-6989586621683018343"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018343"><span class="hs-identifier hs-var">fun_ty</span></a></span></span><span>
</span><span id="line-877"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018344"><span class="annot"><a href="#local-6989586621683018344"><span class="hs-identifier hs-var">more_arg_tys</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; TcM (Scaled TcType))
-&gt; [Int] -&gt; IOEnv (Env TcGblEnv TcLclEnv) [Scaled TcType]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExpectedFunTyOrigin -&gt; Int -&gt; TcM (Scaled TcType)
</span><a href="GHC.Tc.Utils.Unify.html#new_check_arg_ty"><span class="hs-identifier hs-var">new_check_arg_ty</span></a></span><span> </span><span class="annot"><span class="annottext">ExpectedFunTyOrigin
</span><a href="#local-6989586621683018275"><span class="hs-identifier hs-var">herald</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683018277"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683018341"><span class="hs-identifier hs-var">n_req</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683018277"><span class="hs-identifier hs-var">arity</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-878"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683018345"><span class="annot"><a href="#local-6989586621683018345"><span class="hs-identifier hs-var hs-var">all_pats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ExpPatType] -&gt; [ExpPatType]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[ExpPatType]
</span><a href="#local-6989586621683018342"><span class="hs-identifier hs-var">rev_pat_tys</span></a></span><span> </span><span class="annot"><span class="annottext">[ExpPatType] -&gt; [ExpPatType] -&gt; [ExpPatType]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(Scaled TcType -&gt; ExpPatType) -&gt; [Scaled TcType] -&gt; [ExpPatType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Scaled TcType -&gt; ExpPatType
</span><a href="GHC.Tc.Utils.TcType.html#mkCheckExpFunPatTy"><span class="hs-identifier hs-var">mkCheckExpFunPatTy</span></a></span><span> </span><span class="annot"><span class="annottext">[Scaled TcType]
</span><a href="#local-6989586621683018344"><span class="hs-identifier hs-var">more_arg_tys</span></a></span><span>
</span><span id="line-879"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018346"><span class="annot"><a href="#local-6989586621683018346"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#newOpenFlexiTyVarTy"><span class="hs-identifier hs-type">newOpenFlexiTyVarTy</span></a></span><span>
</span><span id="line-880"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018347"><span class="annot"><a href="#local-6989586621683018347"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621683018280"><span class="hs-identifier hs-type">thing_inside</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018345"><span class="hs-identifier hs-type">all_pats</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#mkCheckExpType"><span class="hs-identifier hs-type">mkCheckExpType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018346"><span class="hs-identifier hs-type">res_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-881"></span><span>
</span><span id="line-882"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018348"><span class="annot"><a href="#local-6989586621683018348"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#unifyType"><span class="hs-identifier hs-type">unifyType</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#mkScaledFunTys"><span class="hs-identifier hs-type">mkScaledFunTys</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018344"><span class="hs-identifier hs-type">more_arg_tys</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018346"><span class="hs-identifier hs-type">res_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683018343"><span class="hs-identifier hs-type">fun_ty</span></a></span><span>
</span><span id="line-883"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#mkWpCastN"><span class="hs-identifier hs-type">mkWpCastN</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018348"><span class="hs-identifier hs-type">co</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683018347"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-884"></span><span>
</span><span id="line-885"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#new_infer_arg_ty"><span class="hs-identifier hs-type">new_infer_arg_ty</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#ExpectedFunTyOrigin"><span class="hs-identifier hs-type">ExpectedFunTyOrigin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Scaled"><span class="hs-identifier hs-type">Scaled</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#ExpSigmaTypeFRR"><span class="hs-identifier hs-type">ExpSigmaTypeFRR</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-886"></span><span id="new_infer_arg_ty"><span class="annot"><span class="annottext">new_infer_arg_ty :: ExpectedFunTyOrigin
-&gt; Int -&gt; IOEnv (Env TcGblEnv TcLclEnv) (Scaled ExpRhoType)
</span><a href="GHC.Tc.Utils.Unify.html#new_infer_arg_ty"><span class="hs-identifier hs-var hs-var">new_infer_arg_ty</span></a></span></span><span> </span><span id="local-6989586621683018350"><span class="annot"><span class="annottext">ExpectedFunTyOrigin
</span><a href="#local-6989586621683018350"><span class="hs-identifier hs-var">herald</span></a></span></span><span> </span><span id="local-6989586621683018351"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683018351"><span class="hs-identifier hs-var">arg_pos</span></a></span></span><span> </span><span class="hs-comment">-- position for error messages only</span><span>
</span><span id="line-887"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018352"><span class="annot"><a href="#local-6989586621683018352"><span class="hs-identifier hs-var">mult</span></a></span></span><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcM TcType
</span><a href="GHC.Tc.Utils.TcMType.html#newFlexiTyVarTy"><span class="hs-identifier hs-var">newFlexiTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="GHC.Builtin.Types.html#multiplicityTy"><span class="hs-identifier hs-var">multiplicityTy</span></a></span><span>
</span><span id="line-888"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018355"><span class="annot"><a href="#local-6989586621683018355"><span class="hs-identifier hs-var">inf_hole</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#newInferExpTypeFRR"><span class="hs-identifier hs-type">newInferExpTypeFRR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#FRRExpectedFunTy"><span class="hs-identifier hs-type">FRRExpectedFunTy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018350"><span class="hs-identifier hs-type">herald</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018351"><span class="hs-identifier hs-type">arg_pos</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-889"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Type.html#mkScaled"><span class="hs-identifier hs-type">mkScaled</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018352"><span class="hs-identifier hs-type">mult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018355"><span class="hs-identifier hs-type">inf_hole</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-890"></span><span>
</span><span id="line-891"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#new_check_arg_ty"><span class="hs-identifier hs-type">new_check_arg_ty</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#ExpectedFunTyOrigin"><span class="hs-identifier hs-type">ExpectedFunTyOrigin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Scaled"><span class="hs-identifier hs-type">Scaled</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-892"></span><span id="new_check_arg_ty"><span class="annot"><span class="annottext">new_check_arg_ty :: ExpectedFunTyOrigin -&gt; Int -&gt; TcM (Scaled TcType)
</span><a href="GHC.Tc.Utils.Unify.html#new_check_arg_ty"><span class="hs-identifier hs-var hs-var">new_check_arg_ty</span></a></span></span><span> </span><span id="local-6989586621683018358"><span class="annot"><span class="annottext">ExpectedFunTyOrigin
</span><a href="#local-6989586621683018358"><span class="hs-identifier hs-var">herald</span></a></span></span><span> </span><span id="local-6989586621683018359"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683018359"><span class="hs-identifier hs-var">arg_pos</span></a></span></span><span> </span><span class="hs-comment">-- Position for error messages only, 1 for first arg</span><span>
</span><span id="line-893"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018360"><span class="annot"><a href="#local-6989586621683018360"><span class="hs-identifier hs-var">mult</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcM TcType
</span><a href="GHC.Tc.Utils.TcMType.html#newFlexiTyVarTy"><span class="hs-identifier hs-var">newFlexiTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="GHC.Builtin.Types.html#multiplicityTy"><span class="hs-identifier hs-var">multiplicityTy</span></a></span><span>
</span><span id="line-894"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018361"><span class="annot"><a href="#local-6989586621683018361"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#newOpenFlexiFRRTyVarTy"><span class="hs-identifier hs-type">newOpenFlexiFRRTyVarTy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#FRRExpectedFunTy"><span class="hs-identifier hs-type">FRRExpectedFunTy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018358"><span class="hs-identifier hs-type">herald</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018359"><span class="hs-identifier hs-type">arg_pos</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-895"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Type.html#mkScaled"><span class="hs-identifier hs-type">mkScaled</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018360"><span class="hs-identifier hs-type">mult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018361"><span class="hs-identifier hs-type">arg_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-896"></span><span>
</span><span id="line-897"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#mkFunTysMsg"><span class="hs-identifier hs-type">mkFunTysMsg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#ExpectedFunTyOrigin"><span class="hs-identifier hs-type">ExpectedFunTyOrigin</span></a></span><span>
</span><span id="line-898"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Basic.html#VisArity"><span class="hs-identifier hs-type">VisArity</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-899"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Zonk.Monad.html#ZonkM"><span class="hs-identifier hs-type">ZonkM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.Env.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-900"></span><span class="hs-comment">-- See Note [Reporting application arity errors]</span><span>
</span><span id="line-901"></span><span id="mkFunTysMsg"><span class="annot"><span class="annottext">mkFunTysMsg :: ExpectedFunTyOrigin
-&gt; (Int, TcType) -&gt; TidyEnv -&gt; ZonkM (TidyEnv, SDoc)
</span><a href="GHC.Tc.Utils.Unify.html#mkFunTysMsg"><span class="hs-identifier hs-var hs-var">mkFunTysMsg</span></a></span></span><span> </span><span id="local-6989586621683018363"><span class="annot"><span class="annottext">ExpectedFunTyOrigin
</span><a href="#local-6989586621683018363"><span class="hs-identifier hs-var">herald</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018364"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683018364"><span class="hs-identifier hs-var">n_vis_args_in_call</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018365"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018365"><span class="hs-identifier hs-var">fun_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621683018366"><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683018366"><span class="hs-identifier hs-var">env</span></a></span></span><span>
</span><span id="line-902"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018367"><span class="annot"><a href="#local-6989586621683018367"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018368"><span class="annot"><a href="#local-6989586621683018368"><span class="hs-identifier hs-var">fun_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TidyEnv -&gt; TcType -&gt; ZonkM (TidyEnv, TcType)
</span><a href="GHC.Tc.Zonk.TcType.html#zonkTidyTcType"><span class="hs-identifier hs-var">zonkTidyTcType</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683018366"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018365"><span class="hs-identifier hs-var">fun_ty</span></a></span><span>
</span><span id="line-903"></span><span>
</span><span id="line-904"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018370"><span class="annot"><a href="#local-6989586621683018370"><span class="hs-identifier hs-var">pi_ty_bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Type.html#splitPiTys"><span class="hs-identifier hs-type">splitPiTys</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018368"><span class="hs-identifier hs-type">fun_ty</span></a></span><span>
</span><span id="line-905"></span><span>             </span><span id="local-6989586621683018372"><span class="annot"><a href="#local-6989586621683018372"><span class="hs-identifier hs-var hs-var">n_fun_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PiTyBinder -&gt; Bool) -&gt; [PiTyBinder] -&gt; Int
forall a. (a -&gt; Bool) -&gt; [a] -&gt; Int
</span><a href="GHC.Utils.Misc.html#count"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="annot"><span class="annottext">PiTyBinder -&gt; Bool
</span><a href="GHC.Types.Var.html#isVisiblePiTyBinder"><span class="hs-identifier hs-var">isVisiblePiTyBinder</span></a></span><span> </span><span class="annot"><span class="annottext">[PiTyBinder]
</span><a href="#local-6989586621683018370"><span class="hs-identifier hs-var">pi_ty_bndrs</span></a></span><span>
</span><span id="line-906"></span><span>             </span><span id="local-6989586621683018375"><span class="annot"><a href="#local-6989586621683018375"><span class="hs-identifier hs-var hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683018364"><span class="hs-identifier hs-var">n_vis_args_in_call</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683018372"><span class="hs-identifier hs-var">n_fun_args</span></a></span><span>  </span><span class="hs-comment">-- Enough args, in the end</span><span>
</span><span id="line-907"></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;In the result of a function call&quot;</span></span><span>
</span><span id="line-908"></span><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-909"></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; Int -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683018379"><span class="hs-identifier hs-var">full_herald</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-910"></span><span>                      </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;but its type&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; SDoc
</span><a href="GHC.Core.TyCo.Ppr.html#pprSigmaType"><span class="hs-identifier hs-var">pprSigmaType</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018368"><span class="hs-identifier hs-var">fun_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-911"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683018372"><span class="hs-identifier hs-var">n_fun_args</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;has none&quot;</span></span><span>
</span><span id="line-912"></span><span>                               </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;has only&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#speakN"><span class="hs-identifier hs-var">speakN</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683018372"><span class="hs-identifier hs-var">n_fun_args</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-913"></span><span>
</span><span id="line-914"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683018367"><span class="hs-identifier hs-type">env'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683018375"><span class="hs-identifier hs-type">msg</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-915"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-916"></span><span>  </span><span id="local-6989586621683018379"><span class="annot"><span class="annottext">full_herald :: SDoc
</span><a href="#local-6989586621683018379"><span class="hs-identifier hs-var hs-var">full_herald</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExpectedFunTyOrigin -&gt; SDoc
</span><a href="GHC.Tc.Types.Origin.html#pprExpectedFunTyHerald"><span class="hs-identifier hs-var">pprExpectedFunTyHerald</span></a></span><span> </span><span class="annot"><span class="annottext">ExpectedFunTyOrigin
</span><a href="#local-6989586621683018363"><span class="hs-identifier hs-var">herald</span></a></span><span>
</span><span id="line-917"></span><span>            </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#speakNOf"><span class="hs-identifier hs-var">speakNOf</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683018364"><span class="hs-identifier hs-var">n_vis_args_in_call</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;visible argument&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-918"></span><span>             </span><span class="hs-comment">-- What are &quot;visible&quot; arguments? See Note [Visibility and arity] in GHC.Types.Basic</span><span>
</span><span id="line-919"></span><span>
</span><span id="line-920"></span><span>
</span><span id="line-921"></span><span class="hs-comment">{- Note [Reporting application arity errors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider      f :: Int -&gt; Int -&gt; Int
and the call  foo = f 3 4 5
We'd like to get an error like:

    &#8226; Couldn't match expected type &#8216;t0 -&gt; t&#8217; with actual type &#8216;Int&#8217;
    &#8226; The function &#8216;f&#8217; is applied to three visible arguments,           -- What are &quot;visible&quot; arguments?
        but its type &#8216;Int -&gt; Int -&gt; Int&#8217; has only two                   -- See Note [Visibility and arity] in GHC.Types.Basic

That is what `mkFunTysMsg` tries to do.  But what is the &quot;type of the function&quot;.
Most obviously, we can report its full, polymorphic type; that is simple and
explicable.  But sometimes a bit odd.  Consider
    f :: Bool -&gt; t Int Int
    foo = f True 5 10
We get this error:
    &#8226; Couldn't match type &#8216;Int&#8217; with &#8216;t0 -&gt; t&#8217;
      Expected: Int -&gt; t0 -&gt; t
        Actual: Int -&gt; Int
    &#8226; The function &#8216;f&#8217; is applied to three visible arguments,
        but its type &#8216;Bool -&gt; t Int Int&#8217; has only one

That's not /quite/ right beause we can instantiate `t` to an arrow and get
two arrows (but not three!).  With that in mind, one could consider reporting
the /instantiated/ type, and GHC used to do so.  But it's more work, and in
some ways more confusing, especially when nested quantifiers are concerned, e.g.
    f :: Bool -&gt; forall t. t Int Int

So we just keep it simple and report the original function type.


************************************************************************
*                                                                      *
                    Other matchExpected functions
*                                                                      *
********************************************************************* -}</span><span>
</span><span id="line-957"></span><span>
</span><span id="line-958"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#matchExpectedListTy"><span class="hs-identifier hs-type">matchExpectedListTy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcRhoType"><span class="hs-identifier hs-type">TcRhoType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#TcCoercionN"><span class="hs-identifier hs-type">TcCoercionN</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcRhoType"><span class="hs-identifier hs-type">TcRhoType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-959"></span><span class="hs-comment">-- Special case for lists</span><span>
</span><span id="line-960"></span><span id="matchExpectedListTy"><span class="annot"><span class="annottext">matchExpectedListTy :: TcType -&gt; TcM (Coercion, TcType)
</span><a href="GHC.Tc.Utils.Unify.html#matchExpectedListTy"><span class="hs-identifier hs-var hs-var">matchExpectedListTy</span></a></span></span><span> </span><span id="local-6989586621683018389"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018389"><span class="hs-identifier hs-var">exp_ty</span></a></span></span><span>
</span><span id="line-961"></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018390"><span class="annot"><a href="#local-6989586621683018390"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span id="local-6989586621683018391"><span class="annot"><a href="#local-6989586621683018391"><span class="hs-identifier hs-var">elt_ty</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; TcType -&gt; TcM (Coercion, [TcType])
</span><a href="GHC.Tc.Utils.Unify.html#matchExpectedTyConApp"><span class="hs-identifier hs-var">matchExpectedTyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="GHC.Builtin.Types.html#listTyCon"><span class="hs-identifier hs-var">listTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018389"><span class="hs-identifier hs-var">exp_ty</span></a></span><span>
</span><span id="line-962"></span><span>      </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683018390"><span class="hs-identifier hs-type">co</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683018391"><span class="hs-identifier hs-type">elt_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-963"></span><span>
</span><span id="line-964"></span><span class="hs-comment">---------------------</span><span>
</span><span id="line-965"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#matchExpectedTyConApp"><span class="hs-identifier hs-type">matchExpectedTyConApp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span>                </span><span class="hs-comment">-- T :: forall kv1 ... kvm. k1 -&gt; ... -&gt; kn -&gt; *</span><span>
</span><span id="line-966"></span><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcRhoType"><span class="hs-identifier hs-type">TcRhoType</span></a></span><span>            </span><span class="hs-comment">-- orig_ty</span><span>
</span><span id="line-967"></span><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#TcCoercionN"><span class="hs-identifier hs-type">TcCoercionN</span></a></span><span class="hs-special">,</span><span>    </span><span class="hs-comment">-- T k1 k2 k3 a b c ~N orig_ty</span><span>
</span><span id="line-968"></span><span>                              </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Element types, k1 k2 k3 a b c</span><span>
</span><span id="line-969"></span><span>
</span><span id="line-970"></span><span class="hs-comment">-- It's used for wired-in tycons, so we call checkWiredInTyCon</span><span>
</span><span id="line-971"></span><span class="hs-comment">-- Precondition: never called with FunTyCon</span><span>
</span><span id="line-972"></span><span class="hs-comment">-- Precondition: input type :: *</span><span>
</span><span id="line-973"></span><span class="hs-comment">-- Postcondition: (T k1 k2 k3 a b c) is well-kinded</span><span>
</span><span id="line-974"></span><span>
</span><span id="line-975"></span><span id="matchExpectedTyConApp"><span class="annot"><span class="annottext">matchExpectedTyConApp :: TyCon -&gt; TcType -&gt; TcM (Coercion, [TcType])
</span><a href="GHC.Tc.Utils.Unify.html#matchExpectedTyConApp"><span class="hs-identifier hs-var hs-var">matchExpectedTyConApp</span></a></span></span><span> </span><span id="local-6989586621683018393"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018393"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621683018394"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018394"><span class="hs-identifier hs-var">orig_ty</span></a></span></span><span>
</span><span id="line-976"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; SDoc -&gt; TcM (Coercion, [TcType]) -&gt; TcM (Coercion, [TcType])
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isAlgTyCon"><span class="hs-identifier hs-var">isAlgTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018393"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018393"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcM (Coercion, [TcType]) -&gt; TcM (Coercion, [TcType]))
-&gt; TcM (Coercion, [TcType]) -&gt; TcM (Coercion, [TcType])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-977"></span><span>    </span><span class="annot"><span class="annottext">TcType -&gt; TcM (Coercion, [TcType])
</span><a href="#local-6989586621683018396"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018394"><span class="hs-identifier hs-var">orig_ty</span></a></span><span>
</span><span id="line-978"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-979"></span><span>    </span><span id="local-6989586621683018396"><span class="annot"><span class="annottext">go :: TcType -&gt; TcM (Coercion, [TcType])
</span><a href="#local-6989586621683018396"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621683018397"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018397"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-980"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683018398"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018398"><span class="hs-identifier hs-var">ty'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe TcType
</span><a href="GHC.Core.Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018397"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-981"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcM (Coercion, [TcType])
</span><a href="#local-6989586621683018396"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018398"><span class="hs-identifier hs-var">ty'</span></a></span><span>
</span><span id="line-982"></span><span>
</span><span id="line-983"></span><span>    </span><span class="annot"><a href="#local-6989586621683018396"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683018399"><span class="annot"><span class="annottext">ty :: TcType
</span><a href="#local-6989586621683018399"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyConApp"><span class="hs-identifier hs-type">TyConApp</span></a></span><span> </span><span id="local-6989586621683018401"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018401"><span class="hs-identifier hs-var">tycon</span></a></span></span><span> </span><span id="local-6989586621683018402"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683018402"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-984"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018393"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; TyCon -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018401"><span class="hs-identifier hs-var">tycon</span></a></span><span>  </span><span class="hs-comment">-- Common case</span><span>
</span><span id="line-985"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Coercion, [TcType]) -&gt; TcM (Coercion, [TcType])
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018399"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683018402"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-986"></span><span>
</span><span id="line-987"></span><span>    </span><span class="annot"><a href="#local-6989586621683018396"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyVarTy"><span class="hs-identifier hs-type">TyVarTy</span></a></span><span> </span><span id="local-6989586621683018404"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683018404"><span class="hs-identifier hs-var">tv</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-988"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isMetaTyVar"><span class="hs-identifier hs-var">isMetaTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683018404"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-989"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018405"><span class="annot"><a href="#local-6989586621683018405"><span class="hs-identifier hs-var">cts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; IOEnv (Env TcGblEnv TcLclEnv) MetaDetails
forall (m :: * -&gt; *). MonadIO m =&gt; TcTyVar -&gt; m MetaDetails
</span><a href="GHC.Tc.Utils.TcMType.html#readMetaTyVar"><span class="hs-identifier hs-var">readMetaTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683018404"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-990"></span><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683018405"><span class="hs-identifier hs-type">cts</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-991"></span><span>                </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#Indirect"><span class="hs-identifier hs-type">Indirect</span></a></span><span> </span><span id="local-6989586621683018406"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018406"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcM (Coercion, [TcType])
</span><a href="#local-6989586621683018396"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018406"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-992"></span><span>                </span><span class="annot"><span class="annottext">MetaDetails
</span><a href="GHC.Tc.Utils.TcType.html#Flexi"><span class="hs-identifier hs-var">Flexi</span></a></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcM (Coercion, [TcType])
</span><a href="#local-6989586621683018407"><span class="hs-identifier hs-var">defer</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-993"></span><span>
</span><span id="line-994"></span><span>    </span><span class="annot"><a href="#local-6989586621683018396"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcM (Coercion, [TcType])
</span><a href="#local-6989586621683018407"><span class="hs-identifier hs-var">defer</span></a></span><span>
</span><span id="line-995"></span><span>
</span><span id="line-996"></span><span>    </span><span class="hs-comment">-- If the common case does not occur, instantiate a template</span><span>
</span><span id="line-997"></span><span>    </span><span class="hs-comment">-- T k1 .. kn t1 .. tm, and unify with the original type</span><span>
</span><span id="line-998"></span><span>    </span><span class="hs-comment">-- Doing it this way ensures that the types we return are</span><span>
</span><span id="line-999"></span><span>    </span><span class="hs-comment">-- kind-compatible with T.  For example, suppose we have</span><span>
</span><span id="line-1000"></span><span>    </span><span class="hs-comment">--       matchExpectedTyConApp T (f Maybe)</span><span>
</span><span id="line-1001"></span><span>    </span><span class="hs-comment">-- where data T a = MkT a</span><span>
</span><span id="line-1002"></span><span>    </span><span class="hs-comment">-- Then we don't want to instantiate T's data constructors with</span><span>
</span><span id="line-1003"></span><span>    </span><span class="hs-comment">--    (a::*) ~ Maybe</span><span>
</span><span id="line-1004"></span><span>    </span><span class="hs-comment">-- because that'll make types that are utterly ill-kinded.</span><span>
</span><span id="line-1005"></span><span>    </span><span class="hs-comment">-- This happened in #7368</span><span>
</span><span id="line-1006"></span><span>    </span><span id="local-6989586621683018407"><span class="annot"><span class="annottext">defer :: TcM (Coercion, [TcType])
</span><a href="#local-6989586621683018407"><span class="hs-identifier hs-var hs-var">defer</span></a></span></span><span>
</span><span id="line-1007"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018408"><span class="annot"><a href="#local-6989586621683018408"><span class="hs-identifier hs-var">arg_tvs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TcTyVar] -&gt; TcM (Subst, [TcTyVar])
</span><a href="GHC.Tc.Utils.TcMType.html#newMetaTyVars"><span class="hs-identifier hs-var">newMetaTyVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [TcTyVar]
</span><a href="GHC.Core.TyCon.html#tyConTyVars"><span class="hs-identifier hs-var">tyConTyVars</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018393"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1008"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;matchExpectedTyConApp&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018393"><span class="hs-identifier hs-type">tc</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-type">$$</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCon.html#tyConTyVars"><span class="hs-identifier hs-var">tyConTyVars</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018393"><span class="hs-identifier hs-type">tc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-type">$$</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018408"><span class="hs-identifier hs-type">arg_tvs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1009"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683018411"><span class="annot"><a href="#local-6989586621683018411"><span class="hs-identifier hs-var hs-var">args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TcTyVar] -&gt; [TcType]
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTys"><span class="hs-identifier hs-var">mkTyVarTys</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683018408"><span class="hs-identifier hs-var">arg_tvs</span></a></span><span>
</span><span id="line-1010"></span><span>                 </span><span id="local-6989586621683018413"><span class="annot"><a href="#local-6989586621683018413"><span class="hs-identifier hs-var hs-var">tc_template</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [TcType] -&gt; TcType
</span><a href="GHC.Core.Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018393"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683018411"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-1011"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018415"><span class="annot"><a href="#local-6989586621683018415"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#unifyType"><span class="hs-identifier hs-type">unifyType</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="annot"><a href="#local-6989586621683018413"><span class="hs-identifier hs-type">tc_template</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018394"><span class="hs-identifier hs-type">orig_ty</span></a></span><span>
</span><span id="line-1012"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683018415"><span class="hs-identifier hs-type">co</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683018411"><span class="hs-identifier hs-type">args</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1013"></span><span>
</span><span id="line-1014"></span><span class="hs-comment">----------------------</span><span>
</span><span id="line-1015"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#matchExpectedAppTy"><span class="hs-identifier hs-type">matchExpectedAppTy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcRhoType"><span class="hs-identifier hs-type">TcRhoType</span></a></span><span>                         </span><span class="hs-comment">-- orig_ty</span><span>
</span><span id="line-1016"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#TcCoercion"><span class="hs-identifier hs-type">TcCoercion</span></a></span><span class="hs-special">,</span><span>                   </span><span class="hs-comment">-- m a ~N orig_ty</span><span>
</span><span id="line-1017"></span><span>                           </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Returns m, a</span><span>
</span><span id="line-1018"></span><span class="hs-comment">-- If the incoming type is a mutable type variable of kind k, then</span><span>
</span><span id="line-1019"></span><span class="hs-comment">-- matchExpectedAppTy returns a new type variable (m: * -&gt; k); note the *.</span><span>
</span><span id="line-1020"></span><span>
</span><span id="line-1021"></span><span id="matchExpectedAppTy"><span class="annot"><span class="annottext">matchExpectedAppTy :: TcType -&gt; TcM (Coercion, (TcType, TcType))
</span><a href="GHC.Tc.Utils.Unify.html#matchExpectedAppTy"><span class="hs-identifier hs-var hs-var">matchExpectedAppTy</span></a></span></span><span> </span><span id="local-6989586621683018417"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018417"><span class="hs-identifier hs-var">orig_ty</span></a></span></span><span>
</span><span id="line-1022"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcM (Coercion, (TcType, TcType))
</span><a href="#local-6989586621683018418"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018417"><span class="hs-identifier hs-var">orig_ty</span></a></span><span>
</span><span id="line-1023"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1024"></span><span>    </span><span id="local-6989586621683018418"><span class="annot"><span class="annottext">go :: TcType -&gt; TcM (Coercion, (TcType, TcType))
</span><a href="#local-6989586621683018418"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621683018419"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018419"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-1025"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683018420"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018420"><span class="hs-identifier hs-var">ty'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe TcType
</span><a href="GHC.Core.Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018419"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcM (Coercion, (TcType, TcType))
</span><a href="#local-6989586621683018418"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018420"><span class="hs-identifier hs-var">ty'</span></a></span><span>
</span><span id="line-1026"></span><span>
</span><span id="line-1027"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018421"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018421"><span class="hs-identifier hs-var">fun_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018422"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018422"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe (TcType, TcType)
</span><a href="GHC.Tc.Utils.TcType.html#tcSplitAppTy_maybe"><span class="hs-identifier hs-var">tcSplitAppTy_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018419"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1028"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Coercion, (TcType, TcType)) -&gt; TcM (Coercion, (TcType, TcType))
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018417"><span class="hs-identifier hs-var">orig_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018421"><span class="hs-identifier hs-var">fun_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018422"><span class="hs-identifier hs-var">arg_ty</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1029"></span><span>
</span><span id="line-1030"></span><span>    </span><span class="annot"><a href="#local-6989586621683018418"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyVarTy"><span class="hs-identifier hs-type">TyVarTy</span></a></span><span> </span><span id="local-6989586621683018424"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683018424"><span class="hs-identifier hs-var">tv</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1031"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isMetaTyVar"><span class="hs-identifier hs-var">isMetaTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683018424"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-1032"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018425"><span class="annot"><a href="#local-6989586621683018425"><span class="hs-identifier hs-var">cts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; IOEnv (Env TcGblEnv TcLclEnv) MetaDetails
forall (m :: * -&gt; *). MonadIO m =&gt; TcTyVar -&gt; m MetaDetails
</span><a href="GHC.Tc.Utils.TcMType.html#readMetaTyVar"><span class="hs-identifier hs-var">readMetaTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683018424"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-1033"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683018425"><span class="hs-identifier hs-type">cts</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1034"></span><span>               </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#Indirect"><span class="hs-identifier hs-type">Indirect</span></a></span><span> </span><span id="local-6989586621683018426"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018426"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcM (Coercion, (TcType, TcType))
</span><a href="#local-6989586621683018418"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018426"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1035"></span><span>               </span><span class="annot"><span class="annottext">MetaDetails
</span><a href="GHC.Tc.Utils.TcType.html#Flexi"><span class="hs-identifier hs-var">Flexi</span></a></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcM (Coercion, (TcType, TcType))
</span><a href="#local-6989586621683018427"><span class="hs-identifier hs-var">defer</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1036"></span><span>
</span><span id="line-1037"></span><span>    </span><span class="annot"><a href="#local-6989586621683018418"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcM (Coercion, (TcType, TcType))
</span><a href="#local-6989586621683018427"><span class="hs-identifier hs-var">defer</span></a></span><span>
</span><span id="line-1038"></span><span>
</span><span id="line-1039"></span><span>    </span><span class="hs-comment">-- Defer splitting by generating an equality constraint</span><span>
</span><span id="line-1040"></span><span>    </span><span id="local-6989586621683018427"><span class="annot"><span class="annottext">defer :: TcM (Coercion, (TcType, TcType))
</span><a href="#local-6989586621683018427"><span class="hs-identifier hs-var hs-var">defer</span></a></span></span><span>
</span><span id="line-1041"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018428"><span class="annot"><a href="#local-6989586621683018428"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcM TcType
</span><a href="GHC.Tc.Utils.TcMType.html#newFlexiTyVarTy"><span class="hs-identifier hs-var">newFlexiTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018429"><span class="hs-identifier hs-var">kind1</span></a></span><span>
</span><span id="line-1042"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018430"><span class="annot"><a href="#local-6989586621683018430"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#newFlexiTyVarTy"><span class="hs-identifier hs-type">newFlexiTyVarTy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018431"><span class="hs-identifier hs-type">kind2</span></a></span><span>
</span><span id="line-1043"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018432"><span class="annot"><a href="#local-6989586621683018432"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#unifyType"><span class="hs-identifier hs-type">unifyType</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Type.html#mkAppTy"><span class="hs-identifier hs-type">mkAppTy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018428"><span class="hs-identifier hs-type">ty1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018430"><span class="hs-identifier hs-type">ty2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683018417"><span class="hs-identifier hs-type">orig_ty</span></a></span><span>
</span><span id="line-1044"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683018432"><span class="hs-identifier hs-type">co</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683018428"><span class="hs-identifier hs-type">ty1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683018430"><span class="hs-identifier hs-type">ty2</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1045"></span><span>
</span><span id="line-1046"></span><span>    </span><span id="local-6989586621683018434"><span class="annot"><span class="annottext">orig_kind :: TcType
</span><a href="#local-6989586621683018434"><span class="hs-identifier hs-var hs-var">orig_kind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; TcType -&gt; TcType
TcType -&gt; TcType
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018417"><span class="hs-identifier hs-var">orig_ty</span></a></span><span>
</span><span id="line-1047"></span><span>    </span><span id="local-6989586621683018429"><span class="annot"><span class="annottext">kind1 :: TcType
</span><a href="#local-6989586621683018429"><span class="hs-identifier hs-var hs-var">kind1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; TcType -&gt; TcType -&gt; TcType
TcType -&gt; TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#mkVisFunTyMany"><span class="hs-identifier hs-var">mkVisFunTyMany</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="GHC.Builtin.Types.html#liftedTypeKind"><span class="hs-identifier hs-var">liftedTypeKind</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018434"><span class="hs-identifier hs-var">orig_kind</span></a></span><span>
</span><span id="line-1048"></span><span>    </span><span id="local-6989586621683018431"><span class="annot"><span class="annottext">kind2 :: TcType
</span><a href="#local-6989586621683018431"><span class="hs-identifier hs-var hs-var">kind2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="GHC.Builtin.Types.html#liftedTypeKind"><span class="hs-identifier hs-var">liftedTypeKind</span></a></span><span>    </span><span class="hs-comment">-- m :: * -&gt; k</span><span>
</span><span id="line-1049"></span><span>                              </span><span class="hs-comment">-- arg type :: *</span><span>
</span><span id="line-1050"></span><span>
</span><span id="line-1051"></span><span class="annot"><span class="hs-comment">{- **********************************************************************
*
                      fillInferResult
*
********************************************************************** -}</span></span><span>
</span><span id="line-1056"></span><span>
</span><span id="line-1057"></span><span class="hs-comment">{- Note [inferResultToType]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
expTypeToType and inferResultType convert an InferResult to a monotype.
It must be a monotype because if the InferResult isn't already filled in,
we fill it in with a unification variable (hence monotype).  So to preserve
order-independence we check for mono-type-ness even if it *is* filled in
already.

See also Note [TcLevel of ExpType] in GHC.Tc.Utils.TcType, and
Note [fillInferResult].
-}</span><span>
</span><span id="line-1068"></span><span>
</span><span id="line-1069"></span><span class="hs-comment">-- | Fill an 'InferResult' with the given type.</span><span>
</span><span id="line-1070"></span><span class="hs-comment">--</span><span>
</span><span id="line-1071"></span><span class="hs-comment">-- If @co = fillInferResult t1 infer_res@, then @co :: t1 ~# t2@,</span><span>
</span><span id="line-1072"></span><span class="hs-comment">-- where @t2@ is the type stored in the 'ir_ref' field of @infer_res@.</span><span>
</span><span id="line-1073"></span><span class="hs-comment">--</span><span>
</span><span id="line-1074"></span><span class="hs-comment">-- This function enforces the following invariants:</span><span>
</span><span id="line-1075"></span><span class="hs-comment">--</span><span>
</span><span id="line-1076"></span><span class="hs-comment">--  - Level invariant.</span><span>
</span><span id="line-1077"></span><span class="hs-comment">--    The stored type @t2@ is at the same level as given by the</span><span>
</span><span id="line-1078"></span><span class="hs-comment">--    'ir_lvl' field.</span><span>
</span><span id="line-1079"></span><span class="hs-comment">--  - FRR invariant.</span><span>
</span><span id="line-1080"></span><span class="hs-comment">--    Whenever the 'ir_frr' field is not @Nothing@, @t2@ is guaranteed</span><span>
</span><span id="line-1081"></span><span class="hs-comment">--    to have a syntactically fixed RuntimeRep, in the sense of</span><span>
</span><span id="line-1082"></span><span class="hs-comment">--    Note [Fixed RuntimeRep] in GHC.Tc.Utils.Concrete.</span><span>
</span><span id="line-1083"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#fillInferResult"><span class="hs-identifier hs-type">fillInferResult</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#InferResult"><span class="hs-identifier hs-type">InferResult</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#TcCoercionN"><span class="hs-identifier hs-type">TcCoercionN</span></a></span><span>
</span><span id="line-1084"></span><span id="fillInferResult"><span class="annot"><span class="annottext">fillInferResult :: TcType -&gt; InferResult -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#fillInferResult"><span class="hs-identifier hs-var hs-var">fillInferResult</span></a></span></span><span> </span><span id="local-6989586621683018441"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018441"><span class="hs-identifier hs-var">act_res_ty</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#IR"><span class="hs-identifier hs-type">IR</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ir_uniq :: InferResult -&gt; Unique
</span><a href="GHC.Tc.Utils.TcType.html#ir_uniq"><span class="hs-identifier hs-var">ir_uniq</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683018444"><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621683018444"><span class="hs-identifier hs-var">u</span></a></span></span><span>
</span><span id="line-1085"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ir_lvl :: InferResult -&gt; TcLevel
</span><a href="GHC.Tc.Utils.TcType.html#ir_lvl"><span class="hs-identifier hs-var">ir_lvl</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683018445"><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683018445"><span class="hs-identifier hs-var">res_lvl</span></a></span></span><span>
</span><span id="line-1086"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ir_frr :: InferResult -&gt; Maybe FixedRuntimeRepContext
</span><a href="GHC.Tc.Utils.TcType.html#ir_frr"><span class="hs-identifier hs-var">ir_frr</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683018446"><span class="annot"><span class="annottext">Maybe FixedRuntimeRepContext
</span><a href="#local-6989586621683018446"><span class="hs-identifier hs-var">mb_frr</span></a></span></span><span>
</span><span id="line-1087"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ir_ref :: InferResult -&gt; IORef (Maybe TcType)
</span><a href="GHC.Tc.Utils.TcType.html#ir_ref"><span class="hs-identifier hs-var">ir_ref</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683018447"><span class="annot"><span class="annottext">IORef (Maybe TcType)
</span><a href="#local-6989586621683018447"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1088"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018448"><span class="annot"><a href="#local-6989586621683018448"><span class="hs-identifier hs-var">mb_exp_res_ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef (Maybe TcType)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (Maybe TcType)
forall (m :: * -&gt; *) a. MonadIO m =&gt; TcRef a -&gt; m a
</span><a href="GHC.Tc.Types.TcRef.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe TcType)
</span><a href="#local-6989586621683018447"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-1089"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683018448"><span class="hs-identifier hs-type">mb_exp_res_ty</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1090"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683018450"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018450"><span class="hs-identifier hs-var">exp_res_ty</span></a></span></span><span>
</span><span id="line-1091"></span><span>               </span><span class="hs-comment">-- We progressively refine the type stored in 'ref',</span><span>
</span><span id="line-1092"></span><span>               </span><span class="hs-comment">-- for example when inferring types across multiple equations.</span><span>
</span><span id="line-1093"></span><span>               </span><span class="hs-comment">--</span><span>
</span><span id="line-1094"></span><span>               </span><span class="hs-comment">-- Example:</span><span>
</span><span id="line-1095"></span><span>               </span><span class="hs-comment">--</span><span>
</span><span id="line-1096"></span><span>               </span><span class="hs-comment">--  \ x -&gt; case y of { True -&gt; x ; False -&gt; 3 :: Int }</span><span>
</span><span id="line-1097"></span><span>               </span><span class="hs-comment">--</span><span>
</span><span id="line-1098"></span><span>               </span><span class="hs-comment">-- When inferring the return type of this function, we will create</span><span>
</span><span id="line-1099"></span><span>               </span><span class="hs-comment">-- an 'Infer' 'ExpType', which will first be filled by the type of 'x'</span><span>
</span><span id="line-1100"></span><span>               </span><span class="hs-comment">-- after typechecking the first equation, and then filled again with</span><span>
</span><span id="line-1101"></span><span>               </span><span class="hs-comment">-- the type 'Int', at which point we want to ensure that we unify</span><span>
</span><span id="line-1102"></span><span>               </span><span class="hs-comment">-- the type of 'x' with 'Int'. This is what is happening below when</span><span>
</span><span id="line-1103"></span><span>               </span><span class="hs-comment">-- we are &quot;joining&quot; several inferred 'ExpType's.</span><span>
</span><span id="line-1104"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Joining inferred ExpType&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcM ()) -&gt; SDoc -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1105"></span><span>                       </span><span class="annot"><span class="annottext">Unique -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621683018444"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#colon"><span class="hs-identifier hs-var">colon</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018441"><span class="hs-identifier hs-var">act_res_ty</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Char -&gt; SDoc
forall doc. IsLine doc =&gt; Char -&gt; doc
</span><a href="GHC.Utils.Outputable.html#char"><span class="hs-identifier hs-var">char</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'~'</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018450"><span class="hs-identifier hs-var">exp_res_ty</span></a></span><span>
</span><span id="line-1106"></span><span>                     </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018453"><span class="annot"><a href="#local-6989586621683018453"><span class="hs-identifier hs-var">cur_lvl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM TcLevel
</span><a href="GHC.Tc.Utils.Monad.html#getTcLevel"><span class="hs-identifier hs-var">getTcLevel</span></a></span><span>
</span><span id="line-1107"></span><span>                     </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683018453"><span class="hs-identifier hs-type">cur_lvl</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#sameDepthAs"><span class="hs-operator hs-type">`sameDepthAs`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018445"><span class="hs-identifier hs-type">res_lvl</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-1108"></span><span>                       </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#ensureMonoType"><span class="hs-identifier hs-type">ensureMonoType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018441"><span class="hs-identifier hs-type">act_res_ty</span></a></span><span>
</span><span id="line-1109"></span><span>                     </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#unifyType"><span class="hs-identifier hs-type">unifyType</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="annot"><a href="#local-6989586621683018441"><span class="hs-identifier hs-type">act_res_ty</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018450"><span class="hs-identifier hs-type">exp_res_ty</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1110"></span><span>            </span><span class="annot"><span class="annottext">Maybe TcType
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1111"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Filling inferred ExpType&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcM ()) -&gt; SDoc -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1112"></span><span>                       </span><span class="annot"><span class="annottext">Unique -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621683018444"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;:=&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018441"><span class="hs-identifier hs-var">act_res_ty</span></a></span><span>
</span><span id="line-1113"></span><span>
</span><span id="line-1114"></span><span>                     </span><span class="hs-comment">-- Enforce the level invariant: ensure the TcLevel of</span><span>
</span><span id="line-1115"></span><span>                     </span><span class="hs-comment">-- the type we are writing to 'ref' matches 'ir_lvl'.</span><span>
</span><span id="line-1116"></span><span>                     </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018457"><span class="annot"><a href="#local-6989586621683018457"><span class="hs-identifier hs-var">prom_co</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018458"><span class="annot"><a href="#local-6989586621683018458"><span class="hs-identifier hs-var">act_res_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcLevel -&gt; TcType -&gt; TcM (Coercion, TcType)
</span><a href="GHC.Tc.Utils.TcMType.html#promoteTcType"><span class="hs-identifier hs-var">promoteTcType</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683018445"><span class="hs-identifier hs-var">res_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018441"><span class="hs-identifier hs-var">act_res_ty</span></a></span><span>
</span><span id="line-1117"></span><span>
</span><span id="line-1118"></span><span>                     </span><span class="hs-comment">-- Enforce the FRR invariant: ensure the type has a syntactically</span><span>
</span><span id="line-1119"></span><span>                     </span><span class="hs-comment">-- fixed RuntimeRep (if necessary, i.e. 'mb_frr' is not 'Nothing').</span><span>
</span><span id="line-1120"></span><span>                     </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018459"><span class="annot"><a href="#local-6989586621683018459"><span class="hs-identifier hs-var">frr_co</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018460"><span class="annot"><a href="#local-6989586621683018460"><span class="hs-identifier hs-var">act_res_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1121"></span><span>                         </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683018446"><span class="hs-identifier hs-type">mb_frr</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1122"></span><span>                           </span><span class="annot"><span class="annottext">Maybe FixedRuntimeRepContext
</span><span class="hs-identifier hs-var">Nothing</span></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Coercion, TcType) -&gt; TcM (Coercion, TcType)
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018458"><span class="hs-identifier hs-var">act_res_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018458"><span class="hs-identifier hs-var">act_res_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1123"></span><span>                           </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683018461"><span class="annot"><span class="annottext">FixedRuntimeRepContext
</span><a href="#local-6989586621683018461"><span class="hs-identifier hs-var">frr_orig</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
FixedRuntimeRepContext -&gt; TcType -&gt; TcM (Coercion, TcType)
FixedRuntimeRepContext -&gt; TcType -&gt; TcM (Coercion, TcType)
</span><a href="GHC.Tc.Utils.Concrete.html#hasFixedRuntimeRep"><span class="hs-identifier hs-var">hasFixedRuntimeRep</span></a></span><span> </span><span class="annot"><span class="annottext">FixedRuntimeRepContext
</span><a href="#local-6989586621683018461"><span class="hs-identifier hs-var">frr_orig</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018458"><span class="hs-identifier hs-var">act_res_ty</span></a></span><span>
</span><span id="line-1124"></span><span>
</span><span id="line-1125"></span><span>                     </span><span class="hs-comment">-- Compose the two coercions.</span><span>
</span><span id="line-1126"></span><span>                     </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683018462"><span class="annot"><a href="#local-6989586621683018462"><span class="hs-identifier hs-var hs-var">final_co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683018457"><span class="hs-identifier hs-var">prom_co</span></a></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Coercion -&gt; Coercion
Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkTransCo"><span class="hs-operator hs-var">`mkTransCo`</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683018459"><span class="hs-identifier hs-var">frr_co</span></a></span><span>
</span><span id="line-1127"></span><span>
</span><span id="line-1128"></span><span>                     </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TcRef.html#writeTcRef"><span class="hs-identifier hs-type">writeTcRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018447"><span class="hs-identifier hs-type">ref</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="#local-6989586621683018460"><span class="hs-identifier hs-type">act_res_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1129"></span><span>
</span><span id="line-1130"></span><span>                     </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683018462"><span class="hs-identifier hs-type">final_co</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1131"></span><span>     </span><span class="hs-special">}</span><span>
</span><span id="line-1132"></span><span>
</span><span id="line-1133"></span><span class="hs-comment">{- Note [fillInferResult]
~~~~~~~~~~~~~~~~~~~~~~~~~
When inferring, we use fillInferResult to &quot;fill in&quot; the hole in InferResult
   data InferResult = IR { ir_uniq :: Unique
                         , ir_lvl  :: TcLevel
                         , ir_ref  :: IORef (Maybe TcType) }

There are two things to worry about:

1. What if it is under a GADT or existential pattern match?
   - GADTs: a unification variable (and Infer's hole is similar) is untouchable
   - Existentials: be careful about skolem-escape

2. What if it is filled in more than once?  E.g. multiple branches of a case
     case e of
        T1 -&gt; e1
        T2 -&gt; e2

Our typing rules are:

* The RHS of a existential or GADT alternative must always be a
  monotype, regardless of the number of alternatives.

* Multiple non-existential/GADT branches can have (the same)
  higher rank type (#18412).  E.g. this is OK:
      case e of
        True  -&gt; hr
        False -&gt; hr
  where hr:: (forall a. a-&gt;a) -&gt; Int
  c.f. Section 7.1 of &quot;Practical type inference for arbitrary-rank types&quot;
       We use choice (2) in that Section.
       (GHC 8.10 and earlier used choice (1).)

  But note that
      case e of
        True  -&gt; hr
        False -&gt; \x -&gt; hr x
  will fail, because we still /infer/ both branches, so the \x will get
  a (monotype) unification variable, which will fail to unify with
  (forall a. a-&gt;a)

For (1) we can detect the GADT/existential situation by seeing that
the current TcLevel is greater than that stored in ir_lvl of the Infer
ExpType.  We bump the level whenever we go past a GADT/existential match.

Then, before filling the hole use promoteTcType to promote the type
to the outer ir_lvl.  promoteTcType does this
  - create a fresh unification variable alpha at level ir_lvl
  - emits an equality alpha[ir_lvl] ~ ty
  - fills the hole with alpha
That forces the type to be a monotype (since unification variables can
only unify with monotypes); and catches skolem-escapes because the
alpha is untouchable until the equality floats out.

For (2), we simply look to see if the hole is filled already.
  - if not, we promote (as above) and fill the hole
  - if it is filled, we simply unify with the type that is
    already there

There is one wrinkle.  Suppose we have
   case e of
      T1 -&gt; e1 :: (forall a. a-&gt;a) -&gt; Int
      G2 -&gt; e2
where T1 is not GADT or existential, but G2 is a GADT.  Then suppose the
T1 alternative fills the hole with (forall a. a-&gt;a) -&gt; Int, which is fine.
But now the G2 alternative must not *just* unify with that else we'd risk
allowing through (e2 :: (forall a. a-&gt;a) -&gt; Int).  If we'd checked G2 first
we'd have filled the hole with a unification variable, which enforces a
monotype.

So if we check G2 second, we still want to emit a constraint that restricts
the RHS to be a monotype. This is done by ensureMonoType, and it works
by simply generating a constraint (alpha ~ ty), where alpha is a fresh
unification variable.  We discard the evidence.

-}</span><span>
</span><span id="line-1209"></span><span>
</span><span id="line-1210"></span><span>
</span><span id="line-1211"></span><span>
</span><span id="line-1212"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Subsumption checking
*                                                                      *
************************************************************************

Note [Subsumption checking: tcSubType]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
All the tcSubType calls have the form
                tcSubType actual_ty expected_ty
which checks
                actual_ty &lt;= expected_ty

That is, that a value of type actual_ty is acceptable in
a place expecting a value of type expected_ty.  I.e. that

    actual ty   is more polymorphic than   expected_ty

It returns a wrapper function
        co_fn :: actual_ty ~ expected_ty
which takes an HsExpr of type actual_ty into one of type
expected_ty.

Note [Ambiguity check and deep subsumption]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
   f :: (forall b. Eq b =&gt; a -&gt; a) -&gt; Int

Does `f` have an ambiguous type?   The ambiguity check usually checks
that this definition of f' would typecheck, where f' has the exact same
type as f:
   f' :: (forall b. Eq b =&gt; a -&gt; a) -&gt; Intp
   f' = f

This will be /rejected/ with DeepSubsumption but /accepted/ with
ShallowSubsumption.  On the other hand, this eta-expanded version f''
would be rejected both ways:
   f'' :: (forall b. Eq b =&gt; a -&gt; a) -&gt; Intp
   f'' x = f x

This is squishy in the same way as other examples in GHC.Tc.Validity
Note [The squishiness of the ambiguity check]

The situation in June 2022.  Since we have SimpleSubsumption at the moment,
we don't want introduce new breakage if you add -XDeepSubsumption, by
rejecting types as ambiguous that weren't ambiguous before.  So, as a
holding decision, we /always/ use SimpleSubsumption for the ambiguity check
(erring on the side accepting more programs). Hence tcSubTypeAmbiguity.
-}</span><span>
</span><span id="line-1262"></span><span>
</span><span id="line-1263"></span><span>
</span><span id="line-1264"></span><span>
</span><span id="line-1265"></span><span class="hs-comment">-----------------</span><span>
</span><span id="line-1266"></span><span class="hs-comment">-- tcWrapResult needs both un-type-checked (for origins and error messages)</span><span>
</span><span id="line-1267"></span><span class="hs-comment">-- and type-checked (for wrapping) expressions</span><span>
</span><span id="line-1268"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcWrapResult"><span class="hs-identifier hs-type">tcWrapResult</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcTc"><span class="hs-identifier hs-type">GhcTc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#ExpRhoType"><span class="hs-identifier hs-type">ExpRhoType</span></a></span><span>
</span><span id="line-1269"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcTc"><span class="hs-identifier hs-type">GhcTc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1270"></span><span id="tcWrapResult"><span class="annot"><span class="annottext">tcWrapResult :: HsExpr GhcRn
-&gt; HsExpr GhcTc -&gt; TcType -&gt; ExpRhoType -&gt; TcM (HsExpr GhcTc)
</span><a href="GHC.Tc.Utils.Unify.html#tcWrapResult"><span class="hs-identifier hs-var hs-var">tcWrapResult</span></a></span></span><span> </span><span id="local-6989586621683018465"><span class="annot"><span class="annottext">HsExpr GhcRn
</span><a href="#local-6989586621683018465"><span class="hs-identifier hs-var">rn_expr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtOrigin
-&gt; HsExpr GhcRn
-&gt; HsExpr GhcTc
-&gt; TcType
-&gt; ExpRhoType
-&gt; TcM (HsExpr GhcTc)
</span><a href="GHC.Tc.Utils.Unify.html#tcWrapResultO"><span class="hs-identifier hs-var">tcWrapResultO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HsExpr GhcRn -&gt; CtOrigin
</span><a href="GHC.Tc.Types.Origin.html#exprCtOrigin"><span class="hs-identifier hs-var">exprCtOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">HsExpr GhcRn
</span><a href="#local-6989586621683018465"><span class="hs-identifier hs-var">rn_expr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HsExpr GhcRn
</span><a href="#local-6989586621683018465"><span class="hs-identifier hs-var">rn_expr</span></a></span><span>
</span><span id="line-1271"></span><span>
</span><span id="line-1272"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcWrapResultO"><span class="hs-identifier hs-type">tcWrapResultO</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcTc"><span class="hs-identifier hs-type">GhcTc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#ExpRhoType"><span class="hs-identifier hs-type">ExpRhoType</span></a></span><span>
</span><span id="line-1273"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcTc"><span class="hs-identifier hs-type">GhcTc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1274"></span><span id="tcWrapResultO"><span class="annot"><span class="annottext">tcWrapResultO :: CtOrigin
-&gt; HsExpr GhcRn
-&gt; HsExpr GhcTc
-&gt; TcType
-&gt; ExpRhoType
-&gt; TcM (HsExpr GhcTc)
</span><a href="GHC.Tc.Utils.Unify.html#tcWrapResultO"><span class="hs-identifier hs-var hs-var">tcWrapResultO</span></a></span></span><span> </span><span id="local-6989586621683018467"><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018467"><span class="hs-identifier hs-var">orig</span></a></span></span><span> </span><span id="local-6989586621683018468"><span class="annot"><span class="annottext">HsExpr GhcRn
</span><a href="#local-6989586621683018468"><span class="hs-identifier hs-var">rn_expr</span></a></span></span><span> </span><span id="local-6989586621683018469"><span class="annot"><span class="annottext">HsExpr GhcTc
</span><a href="#local-6989586621683018469"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span id="local-6989586621683018470"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018470"><span class="hs-identifier hs-var">actual_ty</span></a></span></span><span> </span><span id="local-6989586621683018471"><span class="annot"><span class="annottext">ExpRhoType
</span><a href="#local-6989586621683018471"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span>
</span><span id="line-1275"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tcWrapResult&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Actual:  &quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018470"><span class="hs-identifier hs-var">actual_ty</span></a></span><span>
</span><span id="line-1276"></span><span>                                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Expected:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ExpRhoType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">ExpRhoType
</span><a href="#local-6989586621683018471"><span class="hs-identifier hs-var">res_ty</span></a></span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1277"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018473"><span class="annot"><a href="#local-6989586621683018473"><span class="hs-identifier hs-var">wrap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtOrigin
-&gt; UserTypeCtxt
-&gt; Maybe TypedThing
-&gt; TcType
-&gt; ExpRhoType
-&gt; TcM HsWrapper
</span><a href="GHC.Tc.Utils.Unify.html#tcSubTypeNC"><span class="hs-identifier hs-var">tcSubTypeNC</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018467"><span class="hs-identifier hs-var">orig</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="GHC.Tc.Types.Origin.html#GenSigCtxt"><span class="hs-identifier hs-var">GenSigCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypedThing -&gt; Maybe TypedThing
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(TypedThing -&gt; Maybe TypedThing) -&gt; TypedThing -&gt; Maybe TypedThing
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HsExpr GhcRn -&gt; TypedThing
</span><a href="GHC.Tc.Types.Origin.html#HsExprRnThing"><span class="hs-identifier hs-var">HsExprRnThing</span></a></span><span> </span><span class="annot"><span class="annottext">HsExpr GhcRn
</span><a href="#local-6989586621683018468"><span class="hs-identifier hs-var">rn_expr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018470"><span class="hs-identifier hs-var">actual_ty</span></a></span><span> </span><span class="annot"><span class="annottext">ExpRhoType
</span><a href="#local-6989586621683018471"><span class="hs-identifier hs-var">res_ty</span></a></span><span>
</span><span id="line-1278"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Hs.Utils.html#mkHsWrap"><span class="hs-identifier hs-type">mkHsWrap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018473"><span class="hs-identifier hs-type">wrap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018469"><span class="hs-identifier hs-type">expr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1279"></span><span>
</span><span id="line-1280"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcWrapResultMono"><span class="hs-identifier hs-type">tcWrapResultMono</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcTc"><span class="hs-identifier hs-type">GhcTc</span></a></span><span>
</span><span id="line-1281"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcRhoType"><span class="hs-identifier hs-type">TcRhoType</span></a></span><span>   </span><span class="hs-comment">-- Actual -- a rho-type not a sigma-type</span><span>
</span><span id="line-1282"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#ExpRhoType"><span class="hs-identifier hs-type">ExpRhoType</span></a></span><span>  </span><span class="hs-comment">-- Expected</span><span>
</span><span id="line-1283"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcTc"><span class="hs-identifier hs-type">GhcTc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1284"></span><span class="hs-comment">-- A version of tcWrapResult to use when the actual type is a</span><span>
</span><span id="line-1285"></span><span class="hs-comment">-- rho-type, so nothing to instantiate; just go straight to unify.</span><span>
</span><span id="line-1286"></span><span class="hs-comment">-- It means we don't need to pass in a CtOrigin</span><span>
</span><span id="line-1287"></span><span id="tcWrapResultMono"><span class="annot"><span class="annottext">tcWrapResultMono :: HsExpr GhcRn
-&gt; HsExpr GhcTc -&gt; TcType -&gt; ExpRhoType -&gt; TcM (HsExpr GhcTc)
</span><a href="GHC.Tc.Utils.Unify.html#tcWrapResultMono"><span class="hs-identifier hs-var hs-var">tcWrapResultMono</span></a></span></span><span> </span><span id="local-6989586621683018477"><span class="annot"><span class="annottext">HsExpr GhcRn
</span><a href="#local-6989586621683018477"><span class="hs-identifier hs-var">rn_expr</span></a></span></span><span> </span><span id="local-6989586621683018478"><span class="annot"><span class="annottext">HsExpr GhcTc
</span><a href="#local-6989586621683018478"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span id="local-6989586621683018479"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018479"><span class="hs-identifier hs-var">act_ty</span></a></span></span><span> </span><span id="local-6989586621683018480"><span class="annot"><span class="annottext">ExpRhoType
</span><a href="#local-6989586621683018480"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span>
</span><span id="line-1288"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; TcM (HsExpr GhcTc) -&gt; TcM (HsExpr GhcTc)
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isRhoTy"><span class="hs-identifier hs-var">isRhoTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018479"><span class="hs-identifier hs-var">act_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018479"><span class="hs-identifier hs-var">act_ty</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">HsExpr GhcRn -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">HsExpr GhcRn
</span><a href="#local-6989586621683018477"><span class="hs-identifier hs-var">rn_expr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcM (HsExpr GhcTc) -&gt; TcM (HsExpr GhcTc))
-&gt; TcM (HsExpr GhcTc) -&gt; TcM (HsExpr GhcTc)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1289"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018481"><span class="annot"><a href="#local-6989586621683018481"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HsExpr GhcRn -&gt; TcType -&gt; ExpRhoType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#unifyExpectedType"><span class="hs-identifier hs-var">unifyExpectedType</span></a></span><span> </span><span class="annot"><span class="annottext">HsExpr GhcRn
</span><a href="#local-6989586621683018477"><span class="hs-identifier hs-var">rn_expr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018479"><span class="hs-identifier hs-var">act_ty</span></a></span><span> </span><span class="annot"><span class="annottext">ExpRhoType
</span><a href="#local-6989586621683018480"><span class="hs-identifier hs-var">res_ty</span></a></span><span>
</span><span id="line-1290"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Hs.Utils.html#mkHsWrapCo"><span class="hs-identifier hs-type">mkHsWrapCo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018481"><span class="hs-identifier hs-type">co</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018478"><span class="hs-identifier hs-type">expr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1291"></span><span>
</span><span id="line-1292"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#unifyExpectedType"><span class="hs-identifier hs-type">unifyExpectedType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span>
</span><span id="line-1293"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcRhoType"><span class="hs-identifier hs-type">TcRhoType</span></a></span><span>   </span><span class="hs-comment">-- Actual -- a rho-type not a sigma-type</span><span>
</span><span id="line-1294"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#ExpRhoType"><span class="hs-identifier hs-type">ExpRhoType</span></a></span><span>  </span><span class="hs-comment">-- Expected</span><span>
</span><span id="line-1295"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#TcCoercionN"><span class="hs-identifier hs-type">TcCoercionN</span></a></span><span>
</span><span id="line-1296"></span><span id="unifyExpectedType"><span class="annot"><span class="annottext">unifyExpectedType :: HsExpr GhcRn -&gt; TcType -&gt; ExpRhoType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#unifyExpectedType"><span class="hs-identifier hs-var hs-var">unifyExpectedType</span></a></span></span><span> </span><span id="local-6989586621683018483"><span class="annot"><span class="annottext">HsExpr GhcRn
</span><a href="#local-6989586621683018483"><span class="hs-identifier hs-var">rn_expr</span></a></span></span><span> </span><span id="local-6989586621683018484"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018484"><span class="hs-identifier hs-var">act_ty</span></a></span></span><span> </span><span id="local-6989586621683018485"><span class="annot"><span class="annottext">ExpRhoType
</span><a href="#local-6989586621683018485"><span class="hs-identifier hs-var">exp_ty</span></a></span></span><span>
</span><span id="line-1297"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ExpRhoType
</span><a href="#local-6989586621683018485"><span class="hs-identifier hs-var">exp_ty</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1298"></span><span>      </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#Infer"><span class="hs-identifier hs-type">Infer</span></a></span><span> </span><span id="local-6989586621683018486"><span class="annot"><span class="annottext">InferResult
</span><a href="#local-6989586621683018486"><span class="hs-identifier hs-var">inf_res</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; InferResult -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#fillInferResult"><span class="hs-identifier hs-var">fillInferResult</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018484"><span class="hs-identifier hs-var">act_ty</span></a></span><span> </span><span class="annot"><span class="annottext">InferResult
</span><a href="#local-6989586621683018486"><span class="hs-identifier hs-var">inf_res</span></a></span><span>
</span><span id="line-1299"></span><span>      </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#Check"><span class="hs-identifier hs-type">Check</span></a></span><span> </span><span id="local-6989586621683018487"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018487"><span class="hs-identifier hs-var">exp_ty</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe TypedThing -&gt; TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#unifyType"><span class="hs-identifier hs-var">unifyType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypedThing -&gt; Maybe TypedThing
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(TypedThing -&gt; Maybe TypedThing) -&gt; TypedThing -&gt; Maybe TypedThing
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HsExpr GhcRn -&gt; TypedThing
</span><a href="GHC.Tc.Types.Origin.html#HsExprRnThing"><span class="hs-identifier hs-var">HsExprRnThing</span></a></span><span> </span><span class="annot"><span class="annottext">HsExpr GhcRn
</span><a href="#local-6989586621683018483"><span class="hs-identifier hs-var">rn_expr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018484"><span class="hs-identifier hs-var">act_ty</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018487"><span class="hs-identifier hs-var">exp_ty</span></a></span><span>
</span><span id="line-1300"></span><span>
</span><span id="line-1301"></span><span class="hs-comment">------------------------</span><span>
</span><span id="line-1302"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcSubTypePat"><span class="hs-identifier hs-type">tcSubTypePat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span>
</span><span id="line-1303"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#ExpSigmaType"><span class="hs-identifier hs-type">ExpSigmaType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a></span><span>
</span><span id="line-1304"></span><span class="hs-comment">-- Used in patterns; polarity is backwards compared</span><span>
</span><span id="line-1305"></span><span class="hs-comment">--   to tcSubType</span><span>
</span><span id="line-1306"></span><span class="hs-comment">-- If wrap = tc_sub_type_et t1 t2</span><span>
</span><span id="line-1307"></span><span class="hs-comment">--    =&gt; wrap :: t1 ~&gt; t2</span><span>
</span><span id="line-1308"></span><span id="tcSubTypePat"><span class="annot"><span class="annottext">tcSubTypePat :: CtOrigin -&gt; UserTypeCtxt -&gt; ExpRhoType -&gt; TcType -&gt; TcM HsWrapper
</span><a href="GHC.Tc.Utils.Unify.html#tcSubTypePat"><span class="hs-identifier hs-var hs-var">tcSubTypePat</span></a></span></span><span> </span><span id="local-6989586621683018488"><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018488"><span class="hs-identifier hs-var">inst_orig</span></a></span></span><span> </span><span id="local-6989586621683018489"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683018489"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#Check"><span class="hs-identifier hs-type">Check</span></a></span><span> </span><span id="local-6989586621683018490"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018490"><span class="hs-identifier hs-var">ty_actual</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621683018491"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018491"><span class="hs-identifier hs-var">ty_expected</span></a></span></span><span>
</span><span id="line-1309"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TcType -&gt; TcType -&gt; TcM Coercion)
-&gt; CtOrigin -&gt; UserTypeCtxt -&gt; TcType -&gt; TcType -&gt; TcM HsWrapper
</span><a href="GHC.Tc.Utils.Unify.html#tc_sub_type"><span class="hs-identifier hs-var">tc_sub_type</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#unifyTypeET"><span class="hs-identifier hs-var">unifyTypeET</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018488"><span class="hs-identifier hs-var">inst_orig</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683018489"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018490"><span class="hs-identifier hs-var">ty_actual</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018491"><span class="hs-identifier hs-var">ty_expected</span></a></span><span>
</span><span id="line-1310"></span><span>
</span><span id="line-1311"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcSubTypePat"><span class="hs-identifier hs-var">tcSubTypePat</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#Infer"><span class="hs-identifier hs-type">Infer</span></a></span><span> </span><span id="local-6989586621683018494"><span class="annot"><span class="annottext">InferResult
</span><a href="#local-6989586621683018494"><span class="hs-identifier hs-var">inf_res</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621683018495"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018495"><span class="hs-identifier hs-var">ty_expected</span></a></span></span><span>
</span><span id="line-1312"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018496"><span class="annot"><a href="#local-6989586621683018496"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; InferResult -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#fillInferResult"><span class="hs-identifier hs-var">fillInferResult</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018495"><span class="hs-identifier hs-var">ty_expected</span></a></span><span> </span><span class="annot"><span class="annottext">InferResult
</span><a href="#local-6989586621683018494"><span class="hs-identifier hs-var">inf_res</span></a></span><span>
</span><span id="line-1313"></span><span>               </span><span class="hs-comment">-- In patterns we do not instantatiate</span><span>
</span><span id="line-1314"></span><span>
</span><span id="line-1315"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#mkWpCastN"><span class="hs-identifier hs-type">mkWpCastN</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-type">mkSymCo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018496"><span class="hs-identifier hs-type">co</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1316"></span><span>
</span><span id="line-1317"></span><span class="hs-comment">---------------</span><span>
</span><span id="line-1318"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcSubType"><span class="hs-identifier hs-type">tcSubType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span>
</span><span id="line-1319"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Actual</span></span><span>
</span><span id="line-1320"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#ExpRhoType"><span class="hs-identifier hs-type">ExpRhoType</span></a></span><span>   </span><span class="annot"><span class="hs-comment">-- ^ Expected</span></span><span>
</span><span id="line-1321"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a></span><span>
</span><span id="line-1322"></span><span class="hs-comment">-- Checks that 'actual' is more polymorphic than 'expected'</span><span>
</span><span id="line-1323"></span><span id="tcSubType"><span class="annot"><span class="annottext">tcSubType :: CtOrigin -&gt; UserTypeCtxt -&gt; TcType -&gt; ExpRhoType -&gt; TcM HsWrapper
</span><a href="GHC.Tc.Utils.Unify.html#tcSubType"><span class="hs-identifier hs-var hs-var">tcSubType</span></a></span></span><span> </span><span id="local-6989586621683018498"><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018498"><span class="hs-identifier hs-var">orig</span></a></span></span><span> </span><span id="local-6989586621683018499"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683018499"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span id="local-6989586621683018500"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018500"><span class="hs-identifier hs-var">ty_actual</span></a></span></span><span> </span><span id="local-6989586621683018501"><span class="annot"><span class="annottext">ExpRhoType
</span><a href="#local-6989586621683018501"><span class="hs-identifier hs-var">ty_expected</span></a></span></span><span>
</span><span id="line-1324"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; ExpRhoType -&gt; TcM HsWrapper -&gt; TcM HsWrapper
forall a. TcType -&gt; ExpRhoType -&gt; TcM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Unify.html#addSubTypeCtxt"><span class="hs-identifier hs-var">addSubTypeCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018500"><span class="hs-identifier hs-var">ty_actual</span></a></span><span> </span><span class="annot"><span class="annottext">ExpRhoType
</span><a href="#local-6989586621683018501"><span class="hs-identifier hs-var">ty_expected</span></a></span><span> </span><span class="annot"><span class="annottext">(TcM HsWrapper -&gt; TcM HsWrapper) -&gt; TcM HsWrapper -&gt; TcM HsWrapper
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1325"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tcSubType&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">UserTypeCtxt -&gt; SDoc
</span><a href="GHC.Tc.Types.Origin.html#pprUserTypeCtxt"><span class="hs-identifier hs-var">pprUserTypeCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683018499"><span class="hs-identifier hs-var">ctxt</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018500"><span class="hs-identifier hs-var">ty_actual</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ExpRhoType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">ExpRhoType
</span><a href="#local-6989586621683018501"><span class="hs-identifier hs-var">ty_expected</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1326"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CtOrigin
-&gt; UserTypeCtxt
-&gt; Maybe TypedThing
-&gt; TcType
-&gt; ExpRhoType
-&gt; TcM HsWrapper
</span><a href="GHC.Tc.Utils.Unify.html#tcSubTypeNC"><span class="hs-identifier hs-var">tcSubTypeNC</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018498"><span class="hs-identifier hs-var">orig</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683018499"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe TypedThing
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018500"><span class="hs-identifier hs-var">ty_actual</span></a></span><span> </span><span class="annot"><span class="annottext">ExpRhoType
</span><a href="#local-6989586621683018501"><span class="hs-identifier hs-var">ty_expected</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1327"></span><span>
</span><span id="line-1328"></span><span class="hs-comment">---------------</span><span>
</span><span id="line-1329"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcSubTypeDS"><span class="hs-identifier hs-type">tcSubTypeDS</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span>
</span><span id="line-1330"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcRhoType"><span class="hs-identifier hs-type">TcRhoType</span></a></span><span>   </span><span class="hs-comment">-- Actual type -- a rho-type not a sigma-type</span><span>
</span><span id="line-1331"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcRhoType"><span class="hs-identifier hs-type">TcRhoType</span></a></span><span>   </span><span class="hs-comment">-- Expected type</span><span>
</span><span id="line-1332"></span><span>                           </span><span class="hs-comment">-- DeepSubsumption &lt;=&gt; when checking, this type</span><span>
</span><span id="line-1333"></span><span>                           </span><span class="hs-comment">--                     is deeply skolemised</span><span>
</span><span id="line-1334"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a></span><span>
</span><span id="line-1335"></span><span class="hs-comment">-- Similar signature to unifyExpectedType; does deep subsumption</span><span>
</span><span id="line-1336"></span><span class="hs-comment">-- Only one call site, in GHC.Tc.Gen.App.tcApp</span><span>
</span><span id="line-1337"></span><span id="tcSubTypeDS"><span class="annot"><span class="annottext">tcSubTypeDS :: HsExpr GhcRn -&gt; TcType -&gt; TcType -&gt; TcM HsWrapper
</span><a href="GHC.Tc.Utils.Unify.html#tcSubTypeDS"><span class="hs-identifier hs-var hs-var">tcSubTypeDS</span></a></span></span><span> </span><span id="local-6989586621683018503"><span class="annot"><span class="annottext">HsExpr GhcRn
</span><a href="#local-6989586621683018503"><span class="hs-identifier hs-var">rn_expr</span></a></span></span><span> </span><span id="local-6989586621683018504"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018504"><span class="hs-identifier hs-var">act_rho</span></a></span></span><span> </span><span id="local-6989586621683018505"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018505"><span class="hs-identifier hs-var">exp_rho</span></a></span></span><span>
</span><span id="line-1338"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
(TcType -&gt; TcType -&gt; TcM Coercion)
-&gt; CtOrigin -&gt; UserTypeCtxt -&gt; TcType -&gt; TcType -&gt; TcM HsWrapper
(TcType -&gt; TcType -&gt; TcM Coercion)
-&gt; CtOrigin -&gt; UserTypeCtxt -&gt; TcType -&gt; TcType -&gt; TcM HsWrapper
</span><a href="GHC.Tc.Utils.Unify.html#tc_sub_type_deep"><span class="hs-identifier hs-var">tc_sub_type_deep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HsExpr GhcRn -&gt; TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#unifyExprType"><span class="hs-identifier hs-var">unifyExprType</span></a></span><span> </span><span class="annot"><span class="annottext">HsExpr GhcRn
</span><a href="#local-6989586621683018503"><span class="hs-identifier hs-var">rn_expr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018507"><span class="hs-identifier hs-var">orig</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="GHC.Tc.Types.Origin.html#GenSigCtxt"><span class="hs-identifier hs-var">GenSigCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018504"><span class="hs-identifier hs-var">act_rho</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018505"><span class="hs-identifier hs-var">exp_rho</span></a></span><span>
</span><span id="line-1339"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1340"></span><span>    </span><span id="local-6989586621683018507"><span class="annot"><span class="annottext">orig :: CtOrigin
</span><a href="#local-6989586621683018507"><span class="hs-identifier hs-var hs-var">orig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HsExpr GhcRn -&gt; CtOrigin
</span><a href="GHC.Tc.Types.Origin.html#exprCtOrigin"><span class="hs-identifier hs-var">exprCtOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">HsExpr GhcRn
</span><a href="#local-6989586621683018503"><span class="hs-identifier hs-var">rn_expr</span></a></span><span>
</span><span id="line-1341"></span><span>
</span><span id="line-1342"></span><span class="hs-comment">---------------</span><span>
</span><span id="line-1343"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcSubTypeNC"><span class="hs-identifier hs-type">tcSubTypeNC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a></span><span>          </span><span class="annot"><span class="hs-comment">-- ^ Used when instantiating</span></span><span>
</span><span id="line-1344"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ Used when skolemising</span></span><span>
</span><span id="line-1345"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#TypedThing"><span class="hs-identifier hs-type">TypedThing</span></a></span><span> </span><span class="annot"><span class="hs-comment">-- ^ The expression that has type 'actual' (if known)</span></span><span>
</span><span id="line-1346"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a></span><span>       </span><span class="annot"><span class="hs-comment">-- ^ Actual type</span></span><span>
</span><span id="line-1347"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#ExpRhoType"><span class="hs-identifier hs-type">ExpRhoType</span></a></span><span>        </span><span class="annot"><span class="hs-comment">-- ^ Expected type</span></span><span>
</span><span id="line-1348"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a></span><span>
</span><span id="line-1349"></span><span id="tcSubTypeNC"><span class="annot"><span class="annottext">tcSubTypeNC :: CtOrigin
-&gt; UserTypeCtxt
-&gt; Maybe TypedThing
-&gt; TcType
-&gt; ExpRhoType
-&gt; TcM HsWrapper
</span><a href="GHC.Tc.Utils.Unify.html#tcSubTypeNC"><span class="hs-identifier hs-var hs-var">tcSubTypeNC</span></a></span></span><span> </span><span id="local-6989586621683018508"><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018508"><span class="hs-identifier hs-var">inst_orig</span></a></span></span><span> </span><span id="local-6989586621683018509"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683018509"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span id="local-6989586621683018510"><span class="annot"><span class="annottext">Maybe TypedThing
</span><a href="#local-6989586621683018510"><span class="hs-identifier hs-var">m_thing</span></a></span></span><span> </span><span id="local-6989586621683018511"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018511"><span class="hs-identifier hs-var">ty_actual</span></a></span></span><span> </span><span id="local-6989586621683018512"><span class="annot"><span class="annottext">ExpRhoType
</span><a href="#local-6989586621683018512"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span>
</span><span id="line-1350"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ExpRhoType
</span><a href="#local-6989586621683018512"><span class="hs-identifier hs-var">res_ty</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1351"></span><span>      </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#Check"><span class="hs-identifier hs-type">Check</span></a></span><span> </span><span id="local-6989586621683018513"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018513"><span class="hs-identifier hs-var">ty_expected</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(TcType -&gt; TcType -&gt; TcM Coercion)
-&gt; CtOrigin -&gt; UserTypeCtxt -&gt; TcType -&gt; TcType -&gt; TcM HsWrapper
</span><a href="GHC.Tc.Utils.Unify.html#tc_sub_type"><span class="hs-identifier hs-var">tc_sub_type</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe TypedThing -&gt; TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#unifyType"><span class="hs-identifier hs-var">unifyType</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe TypedThing
</span><a href="#local-6989586621683018510"><span class="hs-identifier hs-var">m_thing</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018508"><span class="hs-identifier hs-var">inst_orig</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683018509"><span class="hs-identifier hs-var">ctxt</span></a></span><span>
</span><span id="line-1352"></span><span>                                       </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018511"><span class="hs-identifier hs-var">ty_actual</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018513"><span class="hs-identifier hs-var">ty_expected</span></a></span><span>
</span><span id="line-1353"></span><span>
</span><span id="line-1354"></span><span>      </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#Infer"><span class="hs-identifier hs-type">Infer</span></a></span><span> </span><span id="local-6989586621683018514"><span class="annot"><span class="annottext">InferResult
</span><a href="#local-6989586621683018514"><span class="hs-identifier hs-var">inf_res</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018515"><span class="annot"><a href="#local-6989586621683018515"><span class="hs-identifier hs-var">wrap</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018516"><span class="annot"><a href="#local-6989586621683018516"><span class="hs-identifier hs-var">rho</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtOrigin -&gt; TcType -&gt; TcM (HsWrapper, TcType)
</span><a href="GHC.Tc.Utils.Instantiate.html#topInstantiate"><span class="hs-identifier hs-var">topInstantiate</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018508"><span class="hs-identifier hs-var">inst_orig</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018511"><span class="hs-identifier hs-var">ty_actual</span></a></span><span>
</span><span id="line-1355"></span><span>                                   </span><span class="hs-comment">-- See Note [Instantiation of InferResult]</span><span>
</span><span id="line-1356"></span><span>                          </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018517"><span class="annot"><a href="#local-6989586621683018517"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#fillInferResult"><span class="hs-identifier hs-type">fillInferResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018516"><span class="hs-identifier hs-type">rho</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018514"><span class="hs-identifier hs-type">inf_res</span></a></span><span>
</span><span id="line-1357"></span><span>                          </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#mkWpCastN"><span class="hs-identifier hs-type">mkWpCastN</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018517"><span class="hs-identifier hs-type">co</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#%3C.%3E"><span class="hs-operator hs-type">&lt;.&gt;</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018515"><span class="hs-identifier hs-type">wrap</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1358"></span><span>
</span><span id="line-1359"></span><span class="hs-comment">---------------</span><span>
</span><span id="line-1360"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcSubTypeSigma"><span class="hs-identifier hs-type">tcSubTypeSigma</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a></span><span>       </span><span class="hs-comment">-- where did the actual type arise / why are we</span><span>
</span><span id="line-1361"></span><span>                                 </span><span class="hs-comment">-- doing this subtype check?</span><span>
</span><span id="line-1362"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span>   </span><span class="hs-comment">-- where did the expected type arise?</span><span>
</span><span id="line-1363"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a></span><span>
</span><span id="line-1364"></span><span class="hs-comment">-- External entry point, but no ExpTypes on either side</span><span>
</span><span id="line-1365"></span><span class="hs-comment">-- Checks that actual &lt;= expected</span><span>
</span><span id="line-1366"></span><span class="hs-comment">-- Returns HsWrapper :: actual ~ expected</span><span>
</span><span id="line-1367"></span><span id="tcSubTypeSigma"><span class="annot"><span class="annottext">tcSubTypeSigma :: CtOrigin -&gt; UserTypeCtxt -&gt; TcType -&gt; TcType -&gt; TcM HsWrapper
</span><a href="GHC.Tc.Utils.Unify.html#tcSubTypeSigma"><span class="hs-identifier hs-var hs-var">tcSubTypeSigma</span></a></span></span><span> </span><span id="local-6989586621683018518"><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018518"><span class="hs-identifier hs-var">orig</span></a></span></span><span> </span><span id="local-6989586621683018519"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683018519"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span id="local-6989586621683018520"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018520"><span class="hs-identifier hs-var">ty_actual</span></a></span></span><span> </span><span id="local-6989586621683018521"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018521"><span class="hs-identifier hs-var">ty_expected</span></a></span></span><span>
</span><span id="line-1368"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TcType -&gt; TcType -&gt; TcM Coercion)
-&gt; CtOrigin -&gt; UserTypeCtxt -&gt; TcType -&gt; TcType -&gt; TcM HsWrapper
</span><a href="GHC.Tc.Utils.Unify.html#tc_sub_type"><span class="hs-identifier hs-var">tc_sub_type</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe TypedThing -&gt; TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#unifyType"><span class="hs-identifier hs-var">unifyType</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe TypedThing
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018518"><span class="hs-identifier hs-var">orig</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683018519"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018520"><span class="hs-identifier hs-var">ty_actual</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018521"><span class="hs-identifier hs-var">ty_expected</span></a></span><span>
</span><span id="line-1369"></span><span>
</span><span id="line-1370"></span><span class="hs-comment">---------------</span><span>
</span><span id="line-1371"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcSubTypeAmbiguity"><span class="hs-identifier hs-type">tcSubTypeAmbiguity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span>   </span><span class="hs-comment">-- Where did this type arise</span><span>
</span><span id="line-1372"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a></span><span>
</span><span id="line-1373"></span><span class="hs-comment">-- See Note [Ambiguity check and deep subsumption]</span><span>
</span><span id="line-1374"></span><span id="tcSubTypeAmbiguity"><span class="annot"><span class="annottext">tcSubTypeAmbiguity :: UserTypeCtxt -&gt; TcType -&gt; TcType -&gt; TcM HsWrapper
</span><a href="GHC.Tc.Utils.Unify.html#tcSubTypeAmbiguity"><span class="hs-identifier hs-var hs-var">tcSubTypeAmbiguity</span></a></span></span><span> </span><span id="local-6989586621683018522"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683018522"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span id="local-6989586621683018523"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018523"><span class="hs-identifier hs-var">ty_actual</span></a></span></span><span> </span><span id="local-6989586621683018524"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018524"><span class="hs-identifier hs-var">ty_expected</span></a></span></span><span>
</span><span id="line-1375"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DeepSubsumptionFlag
-&gt; (TcType -&gt; TcType -&gt; TcM Coercion)
-&gt; CtOrigin
-&gt; UserTypeCtxt
-&gt; TcType
-&gt; TcType
-&gt; TcM HsWrapper
</span><a href="GHC.Tc.Utils.Unify.html#tc_sub_type_ds"><span class="hs-identifier hs-var">tc_sub_type_ds</span></a></span><span> </span><span class="annot"><span class="annottext">DeepSubsumptionFlag
</span><a href="GHC.Tc.Utils.Unify.html#Shallow"><span class="hs-identifier hs-var">Shallow</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe TypedThing -&gt; TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#unifyType"><span class="hs-identifier hs-var">unifyType</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe TypedThing
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-1376"></span><span>                           </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UserTypeCtxt -&gt; CtOrigin
</span><a href="GHC.Tc.Types.Origin.html#AmbiguityCheckOrigin"><span class="hs-identifier hs-var">AmbiguityCheckOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683018522"><span class="hs-identifier hs-var">ctxt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1377"></span><span>                           </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683018522"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018523"><span class="hs-identifier hs-var">ty_actual</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018524"><span class="hs-identifier hs-var">ty_expected</span></a></span><span>
</span><span id="line-1378"></span><span>
</span><span id="line-1379"></span><span class="hs-comment">---------------</span><span>
</span><span id="line-1380"></span><span id="local-6989586621683017243"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#addSubTypeCtxt"><span class="hs-identifier hs-type">addSubTypeCtxt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#ExpType"><span class="hs-identifier hs-type">ExpType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017243"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017243"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-1381"></span><span id="addSubTypeCtxt"><span class="annot"><span class="annottext">addSubTypeCtxt :: forall a. TcType -&gt; ExpRhoType -&gt; TcM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Unify.html#addSubTypeCtxt"><span class="hs-identifier hs-var hs-var">addSubTypeCtxt</span></a></span></span><span> </span><span id="local-6989586621683018539"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018539"><span class="hs-identifier hs-var">ty_actual</span></a></span></span><span> </span><span id="local-6989586621683018540"><span class="annot"><span class="annottext">ExpRhoType
</span><a href="#local-6989586621683018540"><span class="hs-identifier hs-var">ty_expected</span></a></span></span><span> </span><span id="local-6989586621683018541"><span class="annot"><span class="annottext">TcM a
</span><a href="#local-6989586621683018541"><span class="hs-identifier hs-var">thing_inside</span></a></span></span><span>
</span><span id="line-1382"></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isRhoTy"><span class="hs-identifier hs-var">isRhoTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018539"><span class="hs-identifier hs-var">ty_actual</span></a></span><span>        </span><span class="hs-comment">-- If there is no polymorphism involved, the</span><span>
</span><span id="line-1383"></span><span> </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ExpRhoType -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isRhoExpTy"><span class="hs-identifier hs-var">isRhoExpTy</span></a></span><span> </span><span class="annot"><span class="annottext">ExpRhoType
</span><a href="#local-6989586621683018540"><span class="hs-identifier hs-var">ty_expected</span></a></span><span>   </span><span class="hs-comment">-- TypeEqOrigin stuff (added by the _NC functions)</span><span>
</span><span id="line-1384"></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcM a
</span><a href="#local-6989586621683018541"><span class="hs-identifier hs-var">thing_inside</span></a></span><span>             </span><span class="hs-comment">-- gives enough context by itself</span><span>
</span><span id="line-1385"></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1386"></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TidyEnv -&gt; ZonkM (TidyEnv, SDoc)) -&gt; TcM a -&gt; TcM a
forall a. (TidyEnv -&gt; ZonkM (TidyEnv, SDoc)) -&gt; TcM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#addErrCtxtM"><span class="hs-identifier hs-var">addErrCtxtM</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv -&gt; ZonkM (TidyEnv, SDoc)
</span><a href="#local-6989586621683018543"><span class="hs-identifier hs-var">mk_msg</span></a></span><span> </span><span class="annot"><span class="annottext">TcM a
</span><a href="#local-6989586621683018541"><span class="hs-identifier hs-var">thing_inside</span></a></span><span>
</span><span id="line-1387"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1388"></span><span>    </span><span id="local-6989586621683018543"><span class="annot"><span class="annottext">mk_msg :: TidyEnv -&gt; ZonkM (TidyEnv, SDoc)
</span><a href="#local-6989586621683018543"><span class="hs-identifier hs-var hs-var">mk_msg</span></a></span></span><span> </span><span id="local-6989586621683018544"><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683018544"><span class="hs-identifier hs-var">tidy_env</span></a></span></span><span>
</span><span id="line-1389"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018545"><span class="annot"><a href="#local-6989586621683018545"><span class="hs-identifier hs-var">tidy_env</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018546"><span class="annot"><a href="#local-6989586621683018546"><span class="hs-identifier hs-var">ty_actual</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TidyEnv -&gt; TcType -&gt; ZonkM (TidyEnv, TcType)
</span><a href="GHC.Tc.Zonk.TcType.html#zonkTidyTcType"><span class="hs-identifier hs-var">zonkTidyTcType</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683018544"><span class="hs-identifier hs-var">tidy_env</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018539"><span class="hs-identifier hs-var">ty_actual</span></a></span><span>
</span><span id="line-1390"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018547"><span class="annot"><a href="#local-6989586621683018547"><span class="hs-identifier hs-var">ty_expected</span></a></span></span><span>             </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#readExpType"><span class="hs-identifier hs-type">readExpType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018540"><span class="hs-identifier hs-type">ty_expected</span></a></span><span>
</span><span id="line-1391"></span><span>                   </span><span class="hs-comment">-- A worry: might not be filled if we're debugging. Ugh.</span><span>
</span><span id="line-1392"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018548"><span class="annot"><a href="#local-6989586621683018548"><span class="hs-identifier hs-var">tidy_env</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018549"><span class="annot"><a href="#local-6989586621683018549"><span class="hs-identifier hs-var">ty_expected</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Zonk.TcType.html#zonkTidyTcType"><span class="hs-identifier hs-type">zonkTidyTcType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018545"><span class="hs-identifier hs-type">tidy_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018547"><span class="hs-identifier hs-type">ty_expected</span></a></span><span>
</span><span id="line-1393"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683018550"><span class="annot"><a href="#local-6989586621683018550"><span class="hs-identifier hs-var hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; Int -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;When checking that:&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-1394"></span><span>                                 </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">4</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018546"><span class="hs-identifier hs-var">ty_actual</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1395"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SDoc -&gt; Int -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;is more polymorphic than:&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-1396"></span><span>                                         </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018549"><span class="hs-identifier hs-var">ty_expected</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1397"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683018548"><span class="hs-identifier hs-type">tidy_env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683018550"><span class="hs-identifier hs-type">msg</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1398"></span><span>
</span><span id="line-1399"></span><span>
</span><span id="line-1400"></span><span class="hs-comment">{- Note [Instantiation of InferResult]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We now always instantiate before filling in InferResult, so that
the result is a TcRhoType: see #17173 for discussion.

For example:

1. Consider
    f x = (*)
   We want to instantiate the type of (*) before returning, else we
   will infer the type
     f :: forall {a}. a -&gt; forall b. Num b =&gt; b -&gt; b -&gt; b
   This is surely confusing for users.

   And worse, the monomorphism restriction won't work properly. The MR is
   dealt with in simplifyInfer, and simplifyInfer has no way of
   instantiating. This could perhaps be worked around, but it may be
   hard to know even when instantiation should happen.

2. Another reason.  Consider
       f :: (?x :: Int) =&gt; a -&gt; a
       g y = let ?x = 3::Int in f
   Here want to instantiate f's type so that the ?x::Int constraint
  gets discharged by the enclosing implicit-parameter binding.

3. Suppose one defines plus = (+). If we instantiate lazily, we will
   infer plus :: forall a. Num a =&gt; a -&gt; a -&gt; a. However, the monomorphism
   restriction compels us to infer
      plus :: Integer -&gt; Integer -&gt; Integer
   (or similar monotype). Indeed, the only way to know whether to apply
   the monomorphism restriction at all is to instantiate

There is one place where we don't want to instantiate eagerly,
namely in GHC.Tc.Module.tcRnExpr, which implements GHCi's :type
command. See Note [Implementing :type] in GHC.Tc.Module.
-}</span><span>
</span><span id="line-1436"></span><span>
</span><span id="line-1437"></span><span class="hs-comment">---------------</span><span>
</span><span id="line-1438"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tc_sub_type"><span class="hs-identifier hs-type">tc_sub_type</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#TcCoercionN"><span class="hs-identifier hs-type">TcCoercionN</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- How to unify</span><span>
</span><span id="line-1439"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a></span><span>       </span><span class="hs-comment">-- Used when instantiating</span><span>
</span><span id="line-1440"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span>   </span><span class="hs-comment">-- Used when skolemising</span><span>
</span><span id="line-1441"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a></span><span>    </span><span class="hs-comment">-- Actual; a sigma-type</span><span>
</span><span id="line-1442"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a></span><span>    </span><span class="hs-comment">-- Expected; also a sigma-type</span><span>
</span><span id="line-1443"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a></span><span>
</span><span id="line-1444"></span><span class="hs-comment">-- Checks that actual_ty is more polymorphic than expected_ty</span><span>
</span><span id="line-1445"></span><span class="hs-comment">-- If wrap = tc_sub_type t1 t2</span><span>
</span><span id="line-1446"></span><span class="hs-comment">--    =&gt; wrap :: t1 ~&gt; t2</span><span>
</span><span id="line-1447"></span><span class="hs-comment">--</span><span>
</span><span id="line-1448"></span><span class="hs-comment">-- The &quot;how to unify argument&quot; is always a call to `uType TypeLevel orig`,</span><span>
</span><span id="line-1449"></span><span class="hs-comment">-- but with different ways of constructing the CtOrigin `orig` from</span><span>
</span><span id="line-1450"></span><span class="hs-comment">-- the argument types and context.</span><span>
</span><span id="line-1451"></span><span>
</span><span id="line-1452"></span><span class="hs-comment">----------------------</span><span>
</span><span id="line-1453"></span><span id="tc_sub_type"><span class="annot"><span class="annottext">tc_sub_type :: (TcType -&gt; TcType -&gt; TcM Coercion)
-&gt; CtOrigin -&gt; UserTypeCtxt -&gt; TcType -&gt; TcType -&gt; TcM HsWrapper
</span><a href="GHC.Tc.Utils.Unify.html#tc_sub_type"><span class="hs-identifier hs-var hs-var">tc_sub_type</span></a></span></span><span> </span><span id="local-6989586621683018552"><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="#local-6989586621683018552"><span class="hs-identifier hs-var">unify</span></a></span></span><span> </span><span id="local-6989586621683018553"><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018553"><span class="hs-identifier hs-var">inst_orig</span></a></span></span><span> </span><span id="local-6989586621683018554"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683018554"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span id="local-6989586621683018555"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018555"><span class="hs-identifier hs-var">ty_actual</span></a></span></span><span> </span><span id="local-6989586621683018556"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018556"><span class="hs-identifier hs-var">ty_expected</span></a></span></span><span>
</span><span id="line-1454"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018557"><span class="annot"><a href="#local-6989586621683018557"><span class="hs-identifier hs-var">ds_flag</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM DeepSubsumptionFlag
</span><a href="GHC.Tc.Utils.Unify.html#getDeepSubsumptionFlag"><span class="hs-identifier hs-var">getDeepSubsumptionFlag</span></a></span><span>
</span><span id="line-1455"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tc_sub_type_ds"><span class="hs-identifier hs-type">tc_sub_type_ds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018557"><span class="hs-identifier hs-type">ds_flag</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018552"><span class="hs-identifier hs-type">unify</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018553"><span class="hs-identifier hs-type">inst_orig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018554"><span class="hs-identifier hs-type">ctxt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018555"><span class="hs-identifier hs-type">ty_actual</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018556"><span class="hs-identifier hs-type">ty_expected</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1456"></span><span>
</span><span id="line-1457"></span><span class="hs-comment">----------------------</span><span>
</span><span id="line-1458"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tc_sub_type_ds"><span class="hs-identifier hs-type">tc_sub_type_ds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#DeepSubsumptionFlag"><span class="hs-identifier hs-type">DeepSubsumptionFlag</span></a></span><span>
</span><span id="line-1459"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#TcCoercionN"><span class="hs-identifier hs-type">TcCoercionN</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1460"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a></span><span>
</span><span id="line-1461"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a></span><span>
</span><span id="line-1462"></span><span class="hs-comment">-- tc_sub_type_ds is the main subsumption worker function</span><span>
</span><span id="line-1463"></span><span class="hs-comment">-- It takes an explicit DeepSubsumptionFlag</span><span>
</span><span id="line-1464"></span><span id="tc_sub_type_ds"><span class="annot"><span class="annottext">tc_sub_type_ds :: DeepSubsumptionFlag
-&gt; (TcType -&gt; TcType -&gt; TcM Coercion)
-&gt; CtOrigin
-&gt; UserTypeCtxt
-&gt; TcType
-&gt; TcType
-&gt; TcM HsWrapper
</span><a href="GHC.Tc.Utils.Unify.html#tc_sub_type_ds"><span class="hs-identifier hs-var hs-var">tc_sub_type_ds</span></a></span></span><span> </span><span id="local-6989586621683018558"><span class="annot"><span class="annottext">DeepSubsumptionFlag
</span><a href="#local-6989586621683018558"><span class="hs-identifier hs-var">ds_flag</span></a></span></span><span> </span><span id="local-6989586621683018559"><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="#local-6989586621683018559"><span class="hs-identifier hs-var">unify</span></a></span></span><span> </span><span id="local-6989586621683018560"><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018560"><span class="hs-identifier hs-var">inst_orig</span></a></span></span><span> </span><span id="local-6989586621683018561"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683018561"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span id="local-6989586621683018562"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018562"><span class="hs-identifier hs-var">ty_actual</span></a></span></span><span> </span><span id="local-6989586621683018563"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018563"><span class="hs-identifier hs-var">ty_expected</span></a></span></span><span>
</span><span id="line-1465"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="GHC.Tc.Utils.Unify.html#definitely_poly"><span class="hs-identifier hs-var">definitely_poly</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018563"><span class="hs-identifier hs-var">ty_expected</span></a></span><span>   </span><span class="hs-comment">-- See Note [Don't skolemise unnecessarily]</span><span>
</span><span id="line-1466"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DeepSubsumptionFlag -&gt; TcType -&gt; Bool
</span><a href="GHC.Tc.Utils.Unify.html#isRhoTyDS"><span class="hs-identifier hs-var">isRhoTyDS</span></a></span><span> </span><span class="annot"><span class="annottext">DeepSubsumptionFlag
</span><a href="#local-6989586621683018558"><span class="hs-identifier hs-var">ds_flag</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018562"><span class="hs-identifier hs-var">ty_actual</span></a></span><span>
</span><span id="line-1467"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tc_sub_type (drop to equality)&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcM ()) -&gt; SDoc -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1468"></span><span>         </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ty_actual   =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018562"><span class="hs-identifier hs-var">ty_actual</span></a></span><span>
</span><span id="line-1469"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ty_expected =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018563"><span class="hs-identifier hs-var">ty_expected</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1470"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; HsWrapper
</span><a href="GHC.Tc.Types.Evidence.html#mkWpCastN"><span class="hs-identifier hs-var">mkWpCastN</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; HsWrapper) -&gt; TcM Coercion -&gt; TcM HsWrapper
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span>
</span><span id="line-1471"></span><span>         </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="#local-6989586621683018559"><span class="hs-identifier hs-var">unify</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018562"><span class="hs-identifier hs-var">ty_actual</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018563"><span class="hs-identifier hs-var">ty_expected</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1472"></span><span>
</span><span id="line-1473"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>   </span><span class="hs-comment">-- This is the general case</span><span>
</span><span id="line-1474"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tc_sub_type (general case)&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcM ()) -&gt; SDoc -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1475"></span><span>         </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ty_actual   =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018562"><span class="hs-identifier hs-var">ty_actual</span></a></span><span>
</span><span id="line-1476"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ty_expected =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018563"><span class="hs-identifier hs-var">ty_expected</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1477"></span><span>
</span><span id="line-1478"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018565"><span class="annot"><a href="#local-6989586621683018565"><span class="hs-identifier hs-var">sk_wrap</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018566"><span class="annot"><a href="#local-6989586621683018566"><span class="hs-identifier hs-var">inner_wrap</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1479"></span><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DeepSubsumptionFlag
-&gt; UserTypeCtxt
-&gt; TcType
-&gt; (TcType -&gt; TcM HsWrapper)
-&gt; TcM (HsWrapper, HsWrapper)
forall result.
DeepSubsumptionFlag
-&gt; UserTypeCtxt
-&gt; TcType
-&gt; (TcType -&gt; TcM result)
-&gt; TcM (HsWrapper, result)
</span><a href="GHC.Tc.Utils.Unify.html#tcSkolemise"><span class="hs-identifier hs-var">tcSkolemise</span></a></span><span> </span><span class="annot"><span class="annottext">DeepSubsumptionFlag
</span><a href="#local-6989586621683018558"><span class="hs-identifier hs-var">ds_flag</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683018561"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018563"><span class="hs-identifier hs-var">ty_expected</span></a></span><span> </span><span class="annot"><span class="annottext">((TcType -&gt; TcM HsWrapper) -&gt; TcM (HsWrapper, HsWrapper))
-&gt; (TcType -&gt; TcM HsWrapper) -&gt; TcM (HsWrapper, HsWrapper)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621683018567"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018567"><span class="hs-identifier hs-var">sk_rho</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1480"></span><span>               </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">DeepSubsumptionFlag
</span><a href="#local-6989586621683018558"><span class="hs-identifier hs-var">ds_flag</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1481"></span><span>                 </span><span class="annot"><span class="annottext">DeepSubsumptionFlag
</span><a href="GHC.Tc.Utils.Unify.html#Deep"><span class="hs-identifier hs-var">Deep</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
(TcType -&gt; TcType -&gt; TcM Coercion)
-&gt; CtOrigin -&gt; UserTypeCtxt -&gt; TcType -&gt; TcType -&gt; TcM HsWrapper
(TcType -&gt; TcType -&gt; TcM Coercion)
-&gt; CtOrigin -&gt; UserTypeCtxt -&gt; TcType -&gt; TcType -&gt; TcM HsWrapper
</span><a href="GHC.Tc.Utils.Unify.html#tc_sub_type_deep"><span class="hs-identifier hs-var">tc_sub_type_deep</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="#local-6989586621683018559"><span class="hs-identifier hs-var">unify</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018560"><span class="hs-identifier hs-var">inst_orig</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683018561"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018562"><span class="hs-identifier hs-var">ty_actual</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018567"><span class="hs-identifier hs-var">sk_rho</span></a></span><span>
</span><span id="line-1482"></span><span>                 </span><span class="annot"><span class="annottext">DeepSubsumptionFlag
</span><a href="GHC.Tc.Utils.Unify.html#Shallow"><span class="hs-identifier hs-var">Shallow</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(TcType -&gt; TcType -&gt; TcM Coercion)
-&gt; CtOrigin -&gt; TcType -&gt; TcType -&gt; TcM HsWrapper
</span><a href="GHC.Tc.Utils.Unify.html#tc_sub_type_shallow"><span class="hs-identifier hs-var">tc_sub_type_shallow</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="#local-6989586621683018559"><span class="hs-identifier hs-var">unify</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018560"><span class="hs-identifier hs-var">inst_orig</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018562"><span class="hs-identifier hs-var">ty_actual</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018567"><span class="hs-identifier hs-var">sk_rho</span></a></span><span>
</span><span id="line-1483"></span><span>
</span><span id="line-1484"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683018565"><span class="hs-identifier hs-type">sk_wrap</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#%3C.%3E"><span class="hs-operator hs-type">&lt;.&gt;</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018566"><span class="hs-identifier hs-type">inner_wrap</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1485"></span><span>
</span><span id="line-1486"></span><span class="hs-comment">----------------------</span><span>
</span><span id="line-1487"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tc_sub_type_shallow"><span class="hs-identifier hs-type">tc_sub_type_shallow</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#TcCoercionN"><span class="hs-identifier hs-type">TcCoercionN</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1488"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a></span><span>
</span><span id="line-1489"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a></span><span>
</span><span id="line-1490"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcRhoType"><span class="hs-identifier hs-type">TcRhoType</span></a></span><span>   </span><span class="hs-comment">-- Skolemised (shallow-ly)</span><span>
</span><span id="line-1491"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a></span><span>
</span><span id="line-1492"></span><span id="tc_sub_type_shallow"><span class="annot"><span class="annottext">tc_sub_type_shallow :: (TcType -&gt; TcType -&gt; TcM Coercion)
-&gt; CtOrigin -&gt; TcType -&gt; TcType -&gt; TcM HsWrapper
</span><a href="GHC.Tc.Utils.Unify.html#tc_sub_type_shallow"><span class="hs-identifier hs-var hs-var">tc_sub_type_shallow</span></a></span></span><span> </span><span id="local-6989586621683018569"><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="#local-6989586621683018569"><span class="hs-identifier hs-var">unify</span></a></span></span><span> </span><span id="local-6989586621683018570"><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018570"><span class="hs-identifier hs-var">inst_orig</span></a></span></span><span> </span><span id="local-6989586621683018571"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018571"><span class="hs-identifier hs-var">ty_actual</span></a></span></span><span> </span><span id="local-6989586621683018572"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018572"><span class="hs-identifier hs-var">sk_rho</span></a></span></span><span>
</span><span id="line-1493"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018573"><span class="annot"><a href="#local-6989586621683018573"><span class="hs-identifier hs-var">wrap</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018574"><span class="annot"><a href="#local-6989586621683018574"><span class="hs-identifier hs-var">rho_a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtOrigin -&gt; TcType -&gt; TcM (HsWrapper, TcType)
</span><a href="GHC.Tc.Utils.Instantiate.html#topInstantiate"><span class="hs-identifier hs-var">topInstantiate</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018570"><span class="hs-identifier hs-var">inst_orig</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018571"><span class="hs-identifier hs-var">ty_actual</span></a></span><span>
</span><span id="line-1494"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018575"><span class="annot"><a href="#local-6989586621683018575"><span class="hs-identifier hs-var">cow</span></a></span></span><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621683018569"><span class="hs-identifier hs-type">unify</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018574"><span class="hs-identifier hs-type">rho_a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018572"><span class="hs-identifier hs-type">sk_rho</span></a></span><span>
</span><span id="line-1495"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#mkWpCastN"><span class="hs-identifier hs-type">mkWpCastN</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018575"><span class="hs-identifier hs-type">cow</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#%3C.%3E"><span class="hs-operator hs-type">&lt;.&gt;</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018573"><span class="hs-identifier hs-type">wrap</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1496"></span><span>
</span><span id="line-1497"></span><span class="hs-comment">----------------------</span><span>
</span><span id="line-1498"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#definitely_poly"><span class="hs-identifier hs-type">definitely_poly</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1499"></span><span class="hs-comment">-- A very conservative test:</span><span>
</span><span id="line-1500"></span><span class="hs-comment">-- see Note [Don't skolemise unnecessarily]</span><span>
</span><span id="line-1501"></span><span id="definitely_poly"><span class="annot"><span class="annottext">definitely_poly :: TcType -&gt; Bool
</span><a href="GHC.Tc.Utils.Unify.html#definitely_poly"><span class="hs-identifier hs-var hs-var">definitely_poly</span></a></span></span><span> </span><span id="local-6989586621683018576"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018576"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-1502"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018577"><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683018577"><span class="hs-identifier hs-var">tvs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018578"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683018578"><span class="hs-identifier hs-var">theta</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018579"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018579"><span class="hs-identifier hs-var">tau</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; ([TcTyVar], [TcType], TcType)
</span><a href="GHC.Tc.Utils.TcType.html#tcSplitSigmaTy"><span class="hs-identifier hs-var">tcSplitSigmaTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018576"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1503"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018581"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683018581"><span class="hs-identifier hs-var">tv</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[TcTyVar]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683018577"><span class="hs-identifier hs-var">tvs</span></a></span><span>   </span><span class="hs-comment">-- At least one tyvar</span><span>
</span><span id="line-1504"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683018578"><span class="hs-identifier hs-var">theta</span></a></span><span>      </span><span class="hs-comment">-- No constraints; see (DP1)</span><span>
</span><span id="line-1505"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683018581"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType -&gt; Bool
</span><a href="GHC.Core.TyCo.FVs.html#isInjectiveInType"><span class="hs-operator hs-var">`isInjectiveInType`</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018579"><span class="hs-identifier hs-var">tau</span></a></span><span>
</span><span id="line-1506"></span><span>       </span><span class="hs-comment">-- The tyvar actually occurs (DP2),</span><span>
</span><span id="line-1507"></span><span>       </span><span class="hs-comment">-- and occurs in an injective position (DP3).</span><span>
</span><span id="line-1508"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1509"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1510"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1511"></span><span>
</span><span id="line-1512"></span><span class="hs-comment">{- Note [Don't skolemise unnecessarily]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we are trying to solve
     ty_actual   &lt;= ty_expected
    (Char-&gt;Char) &lt;= (forall a. a-&gt;a)
We could skolemise the 'forall a', and then complain
that (Char ~ a) is insoluble; but that's a pretty obscure
error.  It's better to say that
    (Char-&gt;Char) ~ (forall a. a-&gt;a)
fails.

If we prematurely go to equality we'll reject a program we should
accept (e.g. #13752).  So the test (which is only to improve error
message) is very conservative:

 * ty_actual   is /definitely/ monomorphic: see `definitely_mono`
   This definitely_mono test comes in &quot;shallow&quot; and &quot;deep&quot; variants

 * ty_expected is /definitely/ polymorphic: see `definitely_poly`
   This definitely_poly test is more subtle than you might think.
   Here are three cases where expected_ty looks polymorphic, but
   isn't, and where it would be /wrong/ to switch to equality:

   (DP1)  (Char-&gt;Char) &lt;= (forall a. (a~Char) =&gt; a -&gt; a)

   (DP2)  (Char-&gt;Char) &lt;= (forall a. Char -&gt; Char)

   (DP3)  (Char-&gt;Char) &lt;= (forall a. F [a] Char -&gt; Char)
                          where type instance F [x] t = t


Note [Coercions returned from tcSubMult]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
At the moment, we insist that all sub-multiplicity tests turn out
(once the typechecker has finished its work) to be equalities,
i.e. implementable by ReflCo.  Why?  Because our type system has
no way to express non-Refl sub-multiplicities.

How can we check that every call to `tcSubMult` returns `Refl`?
It might not be `Refl` *yet*.

[TODO: add counterexample #25130]

So we take a two-stage approach:
* Generate a coercion now, and hang it in the HsSyn syntax tree
* In the desugarer, after zonking, check that it is Refl.

We &quot;hang it in the tree&quot; in two different ways:
A) In a HsWrapper, in the WpMultCoercion alternative. The
   desugarer checks that WpMultCoercions are Refl, and then
   discards them.  See `GHC.HsToCore.Binds.dsHsWrapper`
B) In an extension field.  For example, in the extension
   field of `HsRecFields`.  See `check_omitted_fields_multiplicity`
   in `GHC.Tc.Gen.Pat.tcDataConPat`

The former mechanism (A) seemed convenient at the time, but has
turned out to add a lot of friction, so we plan to move towards
(B): see #25128

An alternative would be to have a kind of constraint which can
only produce trivial evidence. This would allow such checks to happen
in the constraint solver (#18756).
This would be similar to the existing setup for Concrete, see
  Note [The Concrete mechanism] in GHC.Tc.Utils.Concrete
    (PHASE 1 in particular).

-}</span><span>
</span><span id="line-1579"></span><span>
</span><span id="line-1580"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcSubMult"><span class="hs-identifier hs-type">tcSubMult</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Mult"><span class="hs-identifier hs-type">Mult</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Mult"><span class="hs-identifier hs-type">Mult</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a></span><span>
</span><span id="line-1581"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcSubMult%27"><span class="hs-identifier hs-type">tcSubMult'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Mult"><span class="hs-identifier hs-type">Mult</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Mult"><span class="hs-identifier hs-type">Mult</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#MultiplicityCheckCoercions"><span class="hs-identifier hs-type">MultiplicityCheckCoercions</span></a></span><span>
</span><span id="line-1582"></span><span id="tcSubMult"><span class="annot"><span class="annottext">tcSubMult :: CtOrigin -&gt; TcType -&gt; TcType -&gt; TcM HsWrapper
</span><a href="GHC.Tc.Utils.Unify.html#tcSubMult"><span class="hs-identifier hs-var hs-var">tcSubMult</span></a></span></span><span> </span><span id="local-6989586621683018583"><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018583"><span class="hs-identifier hs-var">origin</span></a></span></span><span> </span><span id="local-6989586621683018584"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018584"><span class="hs-identifier hs-var">w_actual</span></a></span></span><span> </span><span id="local-6989586621683018585"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018585"><span class="hs-identifier hs-var">w_expected</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1583"></span><span>  </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018586"><span class="annot"><a href="#local-6989586621683018586"><span class="hs-identifier hs-var">mult_cos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtOrigin -&gt; TcType -&gt; TcType -&gt; TcM MultiplicityCheckCoercions
</span><a href="GHC.Tc.Utils.Unify.html#tcSubMult%27"><span class="hs-identifier hs-var">tcSubMult'</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018583"><span class="hs-identifier hs-var">origin</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018584"><span class="hs-identifier hs-var">w_actual</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018585"><span class="hs-identifier hs-var">w_expected</span></a></span><span>
</span><span id="line-1584"></span><span>     </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">foldMap</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#WpMultCoercion"><span class="hs-identifier hs-type">WpMultCoercion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018586"><span class="hs-identifier hs-type">mult_cos</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1585"></span><span id="tcSubMult%27"><span class="annot"><span class="annottext">tcSubMult' :: CtOrigin -&gt; TcType -&gt; TcType -&gt; TcM MultiplicityCheckCoercions
</span><a href="GHC.Tc.Utils.Unify.html#tcSubMult%27"><span class="hs-identifier hs-var hs-var">tcSubMult'</span></a></span></span><span> </span><span id="local-6989586621683018589"><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018589"><span class="hs-identifier hs-var">origin</span></a></span></span><span> </span><span id="local-6989586621683018590"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018590"><span class="hs-identifier hs-var">w_actual</span></a></span></span><span> </span><span id="local-6989586621683018591"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018591"><span class="hs-identifier hs-var">w_expected</span></a></span></span><span>
</span><span id="line-1586"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018592"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018592"><span class="hs-identifier hs-var">w1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018593"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018593"><span class="hs-identifier hs-var">w2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe (TcType, TcType)
</span><a href="GHC.Core.Multiplicity.html#isMultMul"><span class="hs-identifier hs-var">isMultMul</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018590"><span class="hs-identifier hs-var">w_actual</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1587"></span><span>  </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018595"><span class="annot"><a href="#local-6989586621683018595"><span class="hs-identifier hs-var">w1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtOrigin -&gt; TcType -&gt; TcType -&gt; TcM MultiplicityCheckCoercions
</span><a href="GHC.Tc.Utils.Unify.html#tcSubMult%27"><span class="hs-identifier hs-var">tcSubMult'</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018589"><span class="hs-identifier hs-var">origin</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018592"><span class="hs-identifier hs-var">w1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018591"><span class="hs-identifier hs-var">w_expected</span></a></span><span>
</span><span id="line-1588"></span><span>     </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018596"><span class="annot"><a href="#local-6989586621683018596"><span class="hs-identifier hs-var">w2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcSubMult%27"><span class="hs-identifier hs-type">tcSubMult'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018589"><span class="hs-identifier hs-type">origin</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018593"><span class="hs-identifier hs-type">w2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018591"><span class="hs-identifier hs-type">w_expected</span></a></span><span>
</span><span id="line-1589"></span><span>     </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683018595"><span class="hs-identifier hs-type">w1</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621683018596"><span class="hs-identifier hs-type">w2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1590"></span><span>  </span><span class="hs-comment">-- Currently, we consider p*q and sup p q to be equal.  Therefore, p*q &lt;= r is</span><span>
</span><span id="line-1591"></span><span>  </span><span class="hs-comment">-- equivalent to p &lt;= r and q &lt;= r.  For other cases, we approximate p &lt;= q by p</span><span>
</span><span id="line-1592"></span><span>  </span><span class="hs-comment">-- ~ q.  This is not complete, but it's sound. See also Note [Overapproximating</span><span>
</span><span id="line-1593"></span><span>  </span><span class="hs-comment">-- multiplicities] in Multiplicity.</span><span>
</span><span id="line-1594"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcSubMult%27"><span class="hs-identifier hs-var">tcSubMult'</span></a></span><span> </span><span id="local-6989586621683018597"><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018597"><span class="hs-identifier hs-var">origin</span></a></span></span><span> </span><span id="local-6989586621683018598"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018598"><span class="hs-identifier hs-var">w_actual</span></a></span></span><span> </span><span id="local-6989586621683018599"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018599"><span class="hs-identifier hs-var">w_expected</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1595"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; IsSubmult
</span><a href="GHC.Core.Multiplicity.html#submult"><span class="hs-identifier hs-var">submult</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018598"><span class="hs-identifier hs-var">w_actual</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018599"><span class="hs-identifier hs-var">w_expected</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1596"></span><span>    </span><span class="annot"><span class="annottext">IsSubmult
</span><a href="GHC.Core.Multiplicity.html#Submult"><span class="hs-identifier hs-var">Submult</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MultiplicityCheckCoercions -&gt; TcM MultiplicityCheckCoercions
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1597"></span><span>    </span><span class="annot"><span class="annottext">IsSubmult
</span><a href="GHC.Core.Multiplicity.html#Unknown"><span class="hs-identifier hs-var">Unknown</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CtOrigin -&gt; TcType -&gt; TcType -&gt; TcM MultiplicityCheckCoercions
</span><a href="GHC.Tc.Utils.Unify.html#tcEqMult%27"><span class="hs-identifier hs-var">tcEqMult'</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018597"><span class="hs-identifier hs-var">origin</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018598"><span class="hs-identifier hs-var">w_actual</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018599"><span class="hs-identifier hs-var">w_expected</span></a></span><span>
</span><span id="line-1598"></span><span>
</span><span id="line-1599"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcEqMult"><span class="hs-identifier hs-type">tcEqMult</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Mult"><span class="hs-identifier hs-type">Mult</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Mult"><span class="hs-identifier hs-type">Mult</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a></span><span>
</span><span id="line-1600"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcEqMult%27"><span class="hs-identifier hs-type">tcEqMult'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Mult"><span class="hs-identifier hs-type">Mult</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Mult"><span class="hs-identifier hs-type">Mult</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#MultiplicityCheckCoercions"><span class="hs-identifier hs-type">MultiplicityCheckCoercions</span></a></span><span>
</span><span id="line-1601"></span><span id="tcEqMult"><span class="annot"><span class="annottext">tcEqMult :: CtOrigin -&gt; TcType -&gt; TcType -&gt; TcM HsWrapper
</span><a href="GHC.Tc.Utils.Unify.html#tcEqMult"><span class="hs-identifier hs-var hs-var">tcEqMult</span></a></span></span><span> </span><span id="local-6989586621683018605"><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018605"><span class="hs-identifier hs-var">origin</span></a></span></span><span> </span><span id="local-6989586621683018606"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018606"><span class="hs-identifier hs-var">w_actual</span></a></span></span><span> </span><span id="local-6989586621683018607"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018607"><span class="hs-identifier hs-var">w_expected</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1602"></span><span>  </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018608"><span class="annot"><a href="#local-6989586621683018608"><span class="hs-identifier hs-var">mult_cos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtOrigin -&gt; TcType -&gt; TcType -&gt; TcM MultiplicityCheckCoercions
</span><a href="GHC.Tc.Utils.Unify.html#tcEqMult%27"><span class="hs-identifier hs-var">tcEqMult'</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018605"><span class="hs-identifier hs-var">origin</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018606"><span class="hs-identifier hs-var">w_actual</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018607"><span class="hs-identifier hs-var">w_expected</span></a></span><span>
</span><span id="line-1603"></span><span>     </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">foldMap</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#WpMultCoercion"><span class="hs-identifier hs-type">WpMultCoercion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018608"><span class="hs-identifier hs-type">mult_cos</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1604"></span><span id="tcEqMult%27"><span class="annot"><span class="annottext">tcEqMult' :: CtOrigin -&gt; TcType -&gt; TcType -&gt; TcM MultiplicityCheckCoercions
</span><a href="GHC.Tc.Utils.Unify.html#tcEqMult%27"><span class="hs-identifier hs-var hs-var">tcEqMult'</span></a></span></span><span> </span><span id="local-6989586621683018609"><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018609"><span class="hs-identifier hs-var">origin</span></a></span></span><span> </span><span id="local-6989586621683018610"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018610"><span class="hs-identifier hs-var">w_actual</span></a></span></span><span> </span><span id="local-6989586621683018611"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018611"><span class="hs-identifier hs-var">w_expected</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1605"></span><span>  </span><span class="hs-special">{</span><span>
</span><span id="line-1606"></span><span>  </span><span class="hs-comment">-- Note that here we do not call to `submult`, so we check</span><span>
</span><span id="line-1607"></span><span>  </span><span class="hs-comment">-- for strict equality.</span><span>
</span><span id="line-1608"></span><span>  </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018612"><span class="annot"><a href="#local-6989586621683018612"><span class="hs-identifier hs-var">coercion</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TypeOrKind -&gt; CtOrigin -&gt; TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#unifyTypeAndEmit"><span class="hs-identifier hs-var">unifyTypeAndEmit</span></a></span><span> </span><span class="annot"><span class="annottext">TypeOrKind
</span><a href="GHC.Types.Basic.html#TypeLevel"><span class="hs-identifier hs-var">TypeLevel</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018609"><span class="hs-identifier hs-var">origin</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018610"><span class="hs-identifier hs-var">w_actual</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018611"><span class="hs-identifier hs-var">w_expected</span></a></span><span>
</span><span id="line-1609"></span><span>  </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#isReflCo"><span class="hs-identifier hs-type">isReflCo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018612"><span class="hs-identifier hs-type">coercion</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621683018612"><span class="hs-identifier hs-type">coercion</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1610"></span><span>
</span><span id="line-1611"></span><span>
</span><span id="line-1612"></span><span class="annot"><span class="hs-comment">{- *********************************************************************
*                                                                      *
                    Deep subsumption
*                                                                      *
********************************************************************* -}</span></span><span>
</span><span id="line-1617"></span><span>
</span><span id="line-1618"></span><span class="hs-comment">{- Note [Deep subsumption]
~~~~~~~~~~~~~~~~~~~~~~~~~~
The DeepSubsumption extension, documented here

    https://github.com/ghc-proposals/ghc-proposals/pull/511.

makes a best-efforts attempt implement deep subsumption as it was
prior to the Simplify Subsumption proposal:

    https://github.com/ghc-proposals/ghc-proposals/pull/287

The effects are in these main places:

1. In the subsumption check, tcSubType, we must do deep skolemisation:
   see the call to tcSkolemise Deep in tc_sub_type_deep

2. In tcPolyExpr we must do deep skolemisation:
   see the call to tcSkolemise in tcSkolemiseExpType

3. for expression type signatures (e :: ty), and functions with type
   signatures (e.g. f :: ty; f = e), we must deeply skolemise the type;
   see the call to tcDeeplySkolemise in tcSkolemiseScoped.

4. In GHC.Tc.Gen.App.tcApp we call tcSubTypeDS to match the result
   type. Without deep subsumption, unifyExpectedType would be sufficent.

In all these cases note that the deep skolemisation must be done /first/.
Consider (1)
     (forall a. Int -&gt; a -&gt; a)  &lt;=  Int -&gt; (forall b. b -&gt; b)
We must skolemise the `forall b` before instantiating the `forall a`.
See also Note [Deep skolemisation].

Wrinkles:

(DS1) Note that we /always/ use shallow subsumption in the ambiguity check.
      See Note [Ambiguity check and deep subsumption].

(DS2) Deep subsumption requires deep instantiation too.
      See Note [The need for deep instantiation]

(DS3) The interaction between deep subsumption and required foralls
      (forall a -&gt; ty) is a bit subtle.  See #24696 and
      Note [Deep subsumption and required foralls]

Note [Deep skolemisation]
~~~~~~~~~~~~~~~~~~~~~~~~~
deeplySkolemise decomposes and skolemises a type, returning a type
with all its arrows visible (ie not buried under foralls)

Examples:

  deeplySkolemise (Int -&gt; forall a. Ord a =&gt; blah)
    =  ( wp, [a], [d:Ord a], Int -&gt; blah )
    where wp = \x:Int. /\a. \(d:Ord a). &lt;hole&gt; x

  deeplySkolemise  (forall a. Ord a =&gt; Maybe a -&gt; forall b. Eq b =&gt; blah)
    =  ( wp, [a,b], [d1:Ord a,d2:Eq b], Maybe a -&gt; blah )
    where wp = /\a.\(d1:Ord a).\(x:Maybe a)./\b.\(d2:Ord b). &lt;hole&gt; x

In general,
  if      deeplySkolemise ty = (wrap, tvs, evs, rho)
    and   e :: rho
  then    wrap e :: ty
    and   'wrap' binds tvs, evs

ToDo: this eta-abstraction plays fast and loose with termination,
      because it can introduce extra lambdas.  Maybe add a `seq` to
      fix this

Note [Setting the argument context]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider we are doing the ambiguity check for the (bogus)
  f :: (forall a b. C b =&gt; a -&gt; a) -&gt; Int

We'll call
   tcSubType ((forall a b. C b =&gt; a-&gt;a) -&gt; Int )
             ((forall a b. C b =&gt; a-&gt;a) -&gt; Int )

with a UserTypeCtxt of (FunSigCtxt &quot;f&quot;).  Then we'll do the co/contra thing
on the argument type of the (-&gt;) -- and at that point we want to switch
to a UserTypeCtxt of GenSigCtxt.  Why?

* Error messages.  If we stick with FunSigCtxt we get errors like
     * Could not deduce: C b
       from the context: C b0
        bound by the type signature for:
            f :: forall a b. C b =&gt; a-&gt;a
  But of course f does not have that type signature!
  Example tests: T10508, T7220a, Simple14

* Implications. We may decide to build an implication for the whole
  ambiguity check, but we don't need one for each level within it,
  and TcUnify.alwaysBuildImplication checks the UserTypeCtxt.
  See Note [When to build an implication]

Note [Multiplicity in deep subsumption]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
   t1 -&gt;{mt} t2  &lt;=   s1 -&gt;{ms} s2

At the moment we /unify/ ms~mt, via tcEqMult.

Arguably we should use `tcSubMult`. But then if mt=m0 (a unification
variable) and ms=Many, `tcSubMult` is a no-op (since anything is a
sub-multiplicty of Many).  But then `m0` may never get unified with
anything.  It is then skolemised by the zonker; see GHC.HsToCore.Binds
Note [Free tyvars on rule LHS].  So we in RULE foldr/app in GHC.Base
we get this

 &quot;foldr/app&quot;     [1] forall ys m1 m2. foldr (\x{m1} \xs{m2}. (:) x xs) ys
                                       = \xs -&gt; xs ++ ys

where we eta-expanded that (:).  But now foldr expects an argument
with -&gt;{Many} and gets an argument with -&gt;{m1} or -&gt;{m2}, and Lint
complains.

The easiest solution was to use tcEqMult in tc_sub_type_deep, and
insist on equality. This is only in the DeepSubsumption code anyway.

Note [The need for deep instantiation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this, without Quick Look, but with Deep Subsumption:
   f :: &#8704;a b c. a b c -&gt; Int
   g :: Bool -&gt; &#8704;d. d -&gt; d
Consider the application (f g).  We need to do the subsumption test

  (Bool -&gt; &#8704; d. d-&gt;d)   &lt;=   (alpha beta gamma)

where alpha, beta, gamma are the unification variables that instantiate a,b,c,
respectively.  We must not drop down to unification, or we will reject the call.
Rather we must deeply instantiate the LHS to get

  (Bool -&gt; delta -&gt; delta)   &lt;=   (alpha beta gamma)

and now we can unify to get

   alpha = (-&gt;)
   beta = Bool
   gamma = delta -&gt; delta

Hence the call to `deeplyInstantiate` in `tc_sub_type_deep`.

See typecheck/should_compile/T11305 for an example of when this is important.

Note [Deep subsumption and required foralls]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
A required forall, (forall a -&gt; ty) behaves like a &quot;rho-type&quot;, one with no
top-level quantification.  In particular, it is neither implicitly instantiated nor
skolemised.  So

  rid1 :: forall a -&gt; a -&gt; a
  rid1 = id

  rid2 :: forall a -&gt; a -&gt; a
  rid2 a = id

Here `rid2` wll typecheck, but `rid1` will not, because we don't implicitly skolemise
the  type.

This &quot;no implicit subsumption nor skolemisation&quot; applies during subsumption.
For example
   (forall a. a-&gt;a)  &lt;=  (forall a -&gt; a -&gt; a)  -- NOT!
does /not/ hold, because that would require implicitly skoleming the (forall a-&gt;).

Note also that, in Core, `eqType` distinguishes between
   (forall a. blah) and forall a -&gt; blah)
See discussion on #22762 and these Notes in GHC.Core.TyCo.Compare
  * Note [ForAllTy and type equality]
  * Note [Comparing visibility]

So during deep subsumption we simply stop (and drop down to equality) when we encounter
a (forall a-&gt;).  This is a little odd:
* Deep subsumption looks inside invisible foralls (forall a. ty)
* Deep subsumption looks inside arrows (t1 -&gt; t2)
* But it does not look inside required foralls (forall a -&gt; ty)

There is discussion on #24696.  How is this implemented?

* In `tc_sub_type_deep`, the calls to `topInstantiate` and `deeplyInstantiate`
  instantiate only /invisible/ binders.
* In `tc_sub_type_ds`, the call to `tcSkolemise` skolemises only /invisible/
  binders.

Here is a slightly more powerful alternative
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 In the story above, if we have
    (forall a -&gt; Eq a =&gt; a -&gt; a)  &lt;=  (forall a -&gt; Ord a =&gt; a -&gt; a)
we'll reject it, because both are rho-types but they aren't equal.  But in the
&quot;drop to equality&quot; stage we could instead see if both rho-types are headed with
(forall a -&gt;) and if so strip that off and go back into deep subsumption.

This is a bit more powerful, but also a bit more complicated, so GHC
doesn't do it yet, awaiting credible user demand.  See #24696.
-}</span><span>
</span><span id="line-1812"></span><span>
</span><span id="line-1813"></span><span class="hs-keyword">data</span><span> </span><span id="DeepSubsumptionFlag"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#DeepSubsumptionFlag"><span class="hs-identifier hs-var">DeepSubsumptionFlag</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Deep"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#Deep"><span class="hs-identifier hs-var">Deep</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="Shallow"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#Shallow"><span class="hs-identifier hs-var">Shallow</span></a></span></span><span>
</span><span id="line-1814"></span><span>
</span><span id="line-1815"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#DeepSubsumptionFlag"><span class="hs-identifier hs-type">DeepSubsumptionFlag</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1816"></span><span>    </span><span id="local-6989586621683018620"><span class="annot"><span class="annottext">ppr :: DeepSubsumptionFlag -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="annot"><span class="annottext">DeepSubsumptionFlag
</span><a href="GHC.Tc.Utils.Unify.html#Deep"><span class="hs-identifier hs-var">Deep</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Deep&quot;</span></span><span>
</span><span id="line-1817"></span><span>    </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">DeepSubsumptionFlag
</span><a href="GHC.Tc.Utils.Unify.html#Shallow"><span class="hs-identifier hs-var">Shallow</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Shallow&quot;</span></span><span>
</span><span id="line-1818"></span><span>
</span><span id="line-1819"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#getDeepSubsumptionFlag"><span class="hs-identifier hs-type">getDeepSubsumptionFlag</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#DeepSubsumptionFlag"><span class="hs-identifier hs-type">DeepSubsumptionFlag</span></a></span><span>
</span><span id="line-1820"></span><span id="getDeepSubsumptionFlag"><span class="annot"><span class="annottext">getDeepSubsumptionFlag :: TcM DeepSubsumptionFlag
</span><a href="GHC.Tc.Utils.Unify.html#getDeepSubsumptionFlag"><span class="hs-identifier hs-var hs-var">getDeepSubsumptionFlag</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018621"><span class="annot"><a href="#local-6989586621683018621"><span class="hs-identifier hs-var">ds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Extension -&gt; TcM Bool
forall gbl lcl. Extension -&gt; TcRnIf gbl lcl Bool
</span><a href="GHC.Tc.Utils.Monad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a></span><span> </span><span class="annot"><span class="annottext">Extension
</span><span class="hs-identifier hs-var">LangExt.DeepSubsumption</span></span><span>
</span><span id="line-1821"></span><span>                            </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621683018621"><span class="hs-identifier hs-type">ds</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#Deep"><span class="hs-identifier hs-type">Deep</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#Shallow"><span class="hs-identifier hs-type">Shallow</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1822"></span><span>
</span><span id="line-1823"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tc_sub_type_deep"><span class="hs-identifier hs-type">tc_sub_type_deep</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span>
</span><span id="line-1824"></span><span>                 </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#TcCoercionN"><span class="hs-identifier hs-type">TcCoercionN</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- How to unify</span><span>
</span><span id="line-1825"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a></span><span>       </span><span class="hs-comment">-- Used when instantiating</span><span>
</span><span id="line-1826"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span>   </span><span class="hs-comment">-- Used when skolemising</span><span>
</span><span id="line-1827"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a></span><span>    </span><span class="hs-comment">-- Actual; a sigma-type</span><span>
</span><span id="line-1828"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcRhoType"><span class="hs-identifier hs-type">TcRhoType</span></a></span><span>      </span><span class="hs-comment">-- Expected; deeply skolemised</span><span>
</span><span id="line-1829"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a></span><span>
</span><span id="line-1830"></span><span>
</span><span id="line-1831"></span><span class="hs-comment">-- If wrap = tc_sub_type_deep t1 t2</span><span>
</span><span id="line-1832"></span><span class="hs-comment">--    =&gt; wrap :: t1 ~&gt; t2</span><span>
</span><span id="line-1833"></span><span class="hs-comment">-- Here is where the work actually happens!</span><span>
</span><span id="line-1834"></span><span class="hs-comment">-- Precondition: ty_expected is deeply skolemised</span><span>
</span><span id="line-1835"></span><span>
</span><span id="line-1836"></span><span id="tc_sub_type_deep"><span class="annot"><span class="annottext">tc_sub_type_deep :: HasDebugCallStack =&gt;
(TcType -&gt; TcType -&gt; TcM Coercion)
-&gt; CtOrigin -&gt; UserTypeCtxt -&gt; TcType -&gt; TcType -&gt; TcM HsWrapper
</span><a href="GHC.Tc.Utils.Unify.html#tc_sub_type_deep"><span class="hs-identifier hs-var hs-var">tc_sub_type_deep</span></a></span></span><span> </span><span id="local-6989586621683018660"><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="#local-6989586621683018660"><span class="hs-identifier hs-var">unify</span></a></span></span><span> </span><span id="local-6989586621683018661"><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018661"><span class="hs-identifier hs-var">inst_orig</span></a></span></span><span> </span><span id="local-6989586621683018662"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683018662"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span id="local-6989586621683018663"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018663"><span class="hs-identifier hs-var">ty_actual</span></a></span></span><span> </span><span id="local-6989586621683018664"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018664"><span class="hs-identifier hs-var">ty_expected</span></a></span></span><span>
</span><span id="line-1837"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; TcM HsWrapper -&gt; TcM HsWrapper
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="GHC.Tc.Utils.Unify.html#isDeepRhoTy"><span class="hs-identifier hs-var">isDeepRhoTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018664"><span class="hs-identifier hs-var">ty_expected</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018664"><span class="hs-identifier hs-var">ty_expected</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcM HsWrapper -&gt; TcM HsWrapper) -&gt; TcM HsWrapper -&gt; TcM HsWrapper
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1838"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tc_sub_type_deep&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcM ()) -&gt; SDoc -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1839"></span><span>         </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ty_actual   =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018663"><span class="hs-identifier hs-var">ty_actual</span></a></span><span>
</span><span id="line-1840"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ty_expected =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018664"><span class="hs-identifier hs-var">ty_expected</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1841"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TcM HsWrapper
</span><a href="#local-6989586621683018666"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018663"><span class="hs-identifier hs-var">ty_actual</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018664"><span class="hs-identifier hs-var">ty_expected</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1842"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1843"></span><span>    </span><span class="hs-comment">-- NB: 'go' is not recursive, except for doing coreView</span><span>
</span><span id="line-1844"></span><span>    </span><span id="local-6989586621683018666"><span class="annot"><span class="annottext">go :: TcType -&gt; TcType -&gt; TcM HsWrapper
</span><a href="#local-6989586621683018666"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621683018667"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018667"><span class="hs-identifier hs-var">ty_a</span></a></span></span><span> </span><span id="local-6989586621683018668"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018668"><span class="hs-identifier hs-var">ty_e</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683018669"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018669"><span class="hs-identifier hs-var">ty_a'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe TcType
</span><a href="GHC.Core.Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018667"><span class="hs-identifier hs-var">ty_a</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TcM HsWrapper
</span><a href="#local-6989586621683018666"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018669"><span class="hs-identifier hs-var">ty_a'</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018668"><span class="hs-identifier hs-var">ty_e</span></a></span><span>
</span><span id="line-1845"></span><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683018670"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018670"><span class="hs-identifier hs-var">ty_e'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe TcType
</span><a href="GHC.Core.Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018668"><span class="hs-identifier hs-var">ty_e</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TcM HsWrapper
</span><a href="#local-6989586621683018666"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018667"><span class="hs-identifier hs-var">ty_a</span></a></span><span>  </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018670"><span class="hs-identifier hs-var">ty_e'</span></a></span><span>
</span><span id="line-1846"></span><span>
</span><span id="line-1847"></span><span>    </span><span class="annot"><a href="#local-6989586621683018666"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyVarTy"><span class="hs-identifier hs-type">TyVarTy</span></a></span><span> </span><span id="local-6989586621683018671"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683018671"><span class="hs-identifier hs-var">tv_a</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621683018672"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018672"><span class="hs-identifier hs-var">ty_e</span></a></span></span><span>
</span><span id="line-1848"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018673"><span class="annot"><a href="#local-6989586621683018673"><span class="hs-identifier hs-var">lookup_res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; IOEnv (Env TcGblEnv TcLclEnv) (Maybe TcType)
</span><a href="GHC.Tc.Utils.TcMType.html#isFilledMetaTyVar_maybe"><span class="hs-identifier hs-var">isFilledMetaTyVar_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683018671"><span class="hs-identifier hs-var">tv_a</span></a></span><span>
</span><span id="line-1849"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683018673"><span class="hs-identifier hs-type">lookup_res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1850"></span><span>               </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683018675"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018675"><span class="hs-identifier hs-var">ty_a'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1851"></span><span>                 </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tc_sub_type_deep following filled meta-tyvar:&quot;</span></span><span>
</span><span id="line-1852"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683018671"><span class="hs-identifier hs-var">tv_a</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;--&gt;&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018675"><span class="hs-identifier hs-var">ty_a'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1853"></span><span>                    </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
(TcType -&gt; TcType -&gt; TcM Coercion)
-&gt; CtOrigin -&gt; UserTypeCtxt -&gt; TcType -&gt; TcType -&gt; TcM HsWrapper
(TcType -&gt; TcType -&gt; TcM Coercion)
-&gt; CtOrigin -&gt; UserTypeCtxt -&gt; TcType -&gt; TcType -&gt; TcM HsWrapper
</span><a href="GHC.Tc.Utils.Unify.html#tc_sub_type_deep"><span class="hs-identifier hs-var">tc_sub_type_deep</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="#local-6989586621683018660"><span class="hs-identifier hs-var">unify</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018661"><span class="hs-identifier hs-var">inst_orig</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683018662"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018675"><span class="hs-identifier hs-var">ty_a'</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018672"><span class="hs-identifier hs-var">ty_e</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1854"></span><span>               </span><span class="annot"><span class="annottext">Maybe TcType
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TcM HsWrapper
</span><a href="#local-6989586621683018676"><span class="hs-identifier hs-var">just_unify</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018663"><span class="hs-identifier hs-var">ty_actual</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018664"><span class="hs-identifier hs-var">ty_expected</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1855"></span><span>
</span><span id="line-1856"></span><span>    </span><span class="annot"><a href="#local-6989586621683018666"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683018677"><span class="annot"><span class="annottext">ty_a :: TcType
</span><a href="#local-6989586621683018677"><span class="hs-identifier hs-var">ty_a</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#FunTy"><span class="hs-identifier hs-type">FunTy</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ft_af :: TcType -&gt; FunTyFlag
</span><a href="GHC.Core.TyCo.Rep.html#ft_af"><span class="hs-identifier hs-var">ft_af</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683018678"><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683018678"><span class="hs-identifier hs-var">af1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_mult :: TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#ft_mult"><span class="hs-identifier hs-var">ft_mult</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683018679"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018679"><span class="hs-identifier hs-var">act_mult</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_arg :: TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#ft_arg"><span class="hs-identifier hs-var">ft_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683018680"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018680"><span class="hs-identifier hs-var">act_arg</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_res :: TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#ft_res"><span class="hs-identifier hs-var">ft_res</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683018681"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018681"><span class="hs-identifier hs-var">act_res</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1857"></span><span>       </span><span id="local-6989586621683018682"><span class="annot"><span class="annottext">ty_e :: TcType
</span><a href="#local-6989586621683018682"><span class="hs-identifier hs-var">ty_e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#FunTy"><span class="hs-identifier hs-type">FunTy</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ft_af :: TcType -&gt; FunTyFlag
</span><a href="GHC.Core.TyCo.Rep.html#ft_af"><span class="hs-identifier hs-var">ft_af</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683018683"><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683018683"><span class="hs-identifier hs-var">af2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_mult :: TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#ft_mult"><span class="hs-identifier hs-var">ft_mult</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683018684"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018684"><span class="hs-identifier hs-var">exp_mult</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_arg :: TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#ft_arg"><span class="hs-identifier hs-var">ft_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683018685"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018685"><span class="hs-identifier hs-var">exp_arg</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_res :: TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#ft_res"><span class="hs-identifier hs-var">ft_res</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683018686"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018686"><span class="hs-identifier hs-var">exp_res</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1858"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">FunTyFlag -&gt; Bool
</span><a href="GHC.Types.Var.html#isVisibleFunArg"><span class="hs-identifier hs-var">isVisibleFunArg</span></a></span><span> </span><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683018678"><span class="hs-identifier hs-var">af1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FunTyFlag -&gt; Bool
</span><a href="GHC.Types.Var.html#isVisibleFunArg"><span class="hs-identifier hs-var">isVisibleFunArg</span></a></span><span> </span><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683018683"><span class="hs-identifier hs-var">af2</span></a></span><span>
</span><span id="line-1859"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="GHC.Core.Type.html#isTauTy"><span class="hs-identifier hs-var">isTauTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018677"><span class="hs-identifier hs-var">ty_a</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="GHC.Core.Type.html#isTauTy"><span class="hs-identifier hs-var">isTauTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018682"><span class="hs-identifier hs-var">ty_e</span></a></span><span class="hs-special">)</span><span>       </span><span class="hs-comment">-- Short cut common case to avoid</span><span>
</span><span id="line-1860"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TcM HsWrapper
</span><a href="#local-6989586621683018676"><span class="hs-identifier hs-var">just_unify</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018663"><span class="hs-identifier hs-var">ty_actual</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018664"><span class="hs-identifier hs-var">ty_expected</span></a></span><span>   </span><span class="hs-comment">-- unnecessary eta expansion</span><span>
</span><span id="line-1861"></span><span>        </span><span class="hs-keyword">else</span><span>
</span><span id="line-1862"></span><span>        </span><span class="hs-comment">-- This is where we do the co/contra thing, and generate a WpFun, which in turn</span><span>
</span><span id="line-1863"></span><span>        </span><span class="hs-comment">-- causes eta-expansion, which we don't like; hence encouraging NoDeepSubsumption</span><span>
</span><span id="line-1864"></span><span>        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018688"><span class="annot"><a href="#local-6989586621683018688"><span class="hs-identifier hs-var">arg_wrap</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DeepSubsumptionFlag
-&gt; (TcType -&gt; TcType -&gt; TcM Coercion)
-&gt; CtOrigin
-&gt; UserTypeCtxt
-&gt; TcType
-&gt; TcType
-&gt; TcM HsWrapper
</span><a href="GHC.Tc.Utils.Unify.html#tc_sub_type_ds"><span class="hs-identifier hs-var">tc_sub_type_ds</span></a></span><span> </span><span class="annot"><span class="annottext">DeepSubsumptionFlag
</span><a href="GHC.Tc.Utils.Unify.html#Deep"><span class="hs-identifier hs-var">Deep</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="#local-6989586621683018660"><span class="hs-identifier hs-var">unify</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018689"><span class="hs-identifier hs-var">given_orig</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="GHC.Tc.Types.Origin.html#GenSigCtxt"><span class="hs-identifier hs-var">GenSigCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018685"><span class="hs-identifier hs-var">exp_arg</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018680"><span class="hs-identifier hs-var">act_arg</span></a></span><span>
</span><span id="line-1865"></span><span>                          </span><span class="hs-comment">-- GenSigCtxt: See Note [Setting the argument context]</span><span>
</span><span id="line-1866"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018690"><span class="annot"><a href="#local-6989586621683018690"><span class="hs-identifier hs-var">res_wrap</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tc_sub_type_deep"><span class="hs-identifier hs-type">tc_sub_type_deep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018660"><span class="hs-identifier hs-type">unify</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018661"><span class="hs-identifier hs-type">inst_orig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018662"><span class="hs-identifier hs-type">ctxt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018681"><span class="hs-identifier hs-type">act_res</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018686"><span class="hs-identifier hs-type">exp_res</span></a></span><span>
</span><span id="line-1867"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018691"><span class="annot"><a href="#local-6989586621683018691"><span class="hs-identifier hs-var">mult_wrap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcEqMult"><span class="hs-identifier hs-type">tcEqMult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018661"><span class="hs-identifier hs-type">inst_orig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018679"><span class="hs-identifier hs-type">act_mult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018684"><span class="hs-identifier hs-type">exp_mult</span></a></span><span>
</span><span id="line-1868"></span><span>                          </span><span class="hs-comment">-- See Note [Multiplicity in deep subsumption]</span><span>
</span><span id="line-1869"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683018691"><span class="hs-identifier hs-type">mult_wrap</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#%3C.%3E"><span class="hs-operator hs-type">&lt;.&gt;</span></a></span><span>
</span><span id="line-1870"></span><span>                     </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#mkWpFun"><span class="hs-identifier hs-type">mkWpFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018688"><span class="hs-identifier hs-type">arg_wrap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018690"><span class="hs-identifier hs-type">res_wrap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Scaled"><span class="hs-identifier hs-type">Scaled</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018684"><span class="hs-identifier hs-type">exp_mult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018685"><span class="hs-identifier hs-type">exp_arg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683018686"><span class="hs-identifier hs-type">exp_res</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1871"></span><span>                     </span><span class="hs-comment">-- arg_wrap :: exp_arg ~&gt; act_arg</span><span>
</span><span id="line-1872"></span><span>                     </span><span class="hs-comment">-- res_wrap :: act-res ~&gt; exp_res</span><span>
</span><span id="line-1873"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-1874"></span><span>        </span><span id="local-6989586621683018689"><span class="annot"><span class="annottext">given_orig :: CtOrigin
</span><a href="#local-6989586621683018689"><span class="hs-identifier hs-var hs-var">given_orig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SkolemInfoAnon -&gt; CtOrigin
</span><a href="GHC.Tc.Types.Origin.html#GivenOrigin"><span class="hs-identifier hs-var">GivenOrigin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UserTypeCtxt -&gt; TcType -&gt; [(Name, TcTyVar)] -&gt; SkolemInfoAnon
</span><a href="GHC.Tc.Types.Origin.html#SigSkol"><span class="hs-identifier hs-var">SigSkol</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="GHC.Tc.Types.Origin.html#GenSigCtxt"><span class="hs-identifier hs-var">GenSigCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018685"><span class="hs-identifier hs-var">exp_arg</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1875"></span><span>
</span><span id="line-1876"></span><span>    </span><span class="annot"><a href="#local-6989586621683018666"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683018693"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018693"><span class="hs-identifier hs-var">ty_a</span></a></span></span><span> </span><span id="local-6989586621683018694"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018694"><span class="hs-identifier hs-var">ty_e</span></a></span></span><span>
</span><span id="line-1877"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018695"><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683018695"><span class="hs-identifier hs-var">tvs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018696"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683018696"><span class="hs-identifier hs-var">theta</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcType
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; ([TcTyVar], [TcType], TcType)
</span><a href="GHC.Tc.Utils.TcType.html#tcSplitSigmaTy"><span class="hs-identifier hs-var">tcSplitSigmaTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018693"><span class="hs-identifier hs-var">ty_a</span></a></span><span>
</span><span id="line-1878"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TcTyVar] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683018695"><span class="hs-identifier hs-var">tvs</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683018696"><span class="hs-identifier hs-var">theta</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1879"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018697"><span class="annot"><a href="#local-6989586621683018697"><span class="hs-identifier hs-var">in_wrap</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018698"><span class="annot"><a href="#local-6989586621683018698"><span class="hs-identifier hs-var">in_rho</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtOrigin -&gt; TcType -&gt; TcM (HsWrapper, TcType)
</span><a href="GHC.Tc.Utils.Instantiate.html#topInstantiate"><span class="hs-identifier hs-var">topInstantiate</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018661"><span class="hs-identifier hs-var">inst_orig</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018693"><span class="hs-identifier hs-var">ty_a</span></a></span><span>
</span><span id="line-1880"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018699"><span class="annot"><a href="#local-6989586621683018699"><span class="hs-identifier hs-var">body_wrap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tc_sub_type_deep"><span class="hs-identifier hs-type">tc_sub_type_deep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018660"><span class="hs-identifier hs-type">unify</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018661"><span class="hs-identifier hs-type">inst_orig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018662"><span class="hs-identifier hs-type">ctxt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018698"><span class="hs-identifier hs-type">in_rho</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018694"><span class="hs-identifier hs-type">ty_e</span></a></span><span>
</span><span id="line-1881"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683018699"><span class="hs-identifier hs-type">body_wrap</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#%3C.%3E"><span class="hs-operator hs-type">&lt;.&gt;</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018697"><span class="hs-identifier hs-type">in_wrap</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1882"></span><span>
</span><span id="line-1883"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>   </span><span class="hs-comment">-- Revert to unification</span><span>
</span><span id="line-1884"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- It's still possible that ty_actual has nested foralls. Instantiate</span><span>
</span><span id="line-1885"></span><span>             </span><span class="hs-comment">-- these, as there's no way unification will succeed with them in.</span><span>
</span><span id="line-1886"></span><span>             </span><span class="hs-comment">-- See Note [The need for deep instantiation]</span><span>
</span><span id="line-1887"></span><span>             </span><span class="hs-special">(</span><span id="local-6989586621683018700"><span class="annot"><a href="#local-6989586621683018700"><span class="hs-identifier hs-var">inst_wrap</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018701"><span class="annot"><a href="#local-6989586621683018701"><span class="hs-identifier hs-var">rho_a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtOrigin -&gt; TcType -&gt; TcM (HsWrapper, TcType)
</span><a href="GHC.Tc.Utils.Unify.html#deeplyInstantiate"><span class="hs-identifier hs-var">deeplyInstantiate</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018661"><span class="hs-identifier hs-var">inst_orig</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018663"><span class="hs-identifier hs-var">ty_actual</span></a></span><span>
</span><span id="line-1888"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018703"><span class="annot"><a href="#local-6989586621683018703"><span class="hs-identifier hs-var">unify_wrap</span></a></span></span><span>         </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621683018676"><span class="hs-identifier hs-type">just_unify</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018701"><span class="hs-identifier hs-type">rho_a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018664"><span class="hs-identifier hs-type">ty_expected</span></a></span><span>
</span><span id="line-1889"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683018703"><span class="hs-identifier hs-type">unify_wrap</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#%3C.%3E"><span class="hs-operator hs-type">&lt;.&gt;</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018700"><span class="hs-identifier hs-type">inst_wrap</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1890"></span><span>
</span><span id="line-1891"></span><span>    </span><span id="local-6989586621683018676"><span class="annot"><span class="annottext">just_unify :: TcType -&gt; TcType -&gt; TcM HsWrapper
</span><a href="#local-6989586621683018676"><span class="hs-identifier hs-var hs-var">just_unify</span></a></span></span><span> </span><span id="local-6989586621683018704"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018704"><span class="hs-identifier hs-var">ty_a</span></a></span></span><span> </span><span id="local-6989586621683018705"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018705"><span class="hs-identifier hs-var">ty_e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018706"><span class="annot"><a href="#local-6989586621683018706"><span class="hs-identifier hs-var">cow</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="#local-6989586621683018660"><span class="hs-identifier hs-var">unify</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018704"><span class="hs-identifier hs-var">ty_a</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018705"><span class="hs-identifier hs-var">ty_e</span></a></span><span>
</span><span id="line-1892"></span><span>                              </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#mkWpCastN"><span class="hs-identifier hs-type">mkWpCastN</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018706"><span class="hs-identifier hs-type">cow</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1893"></span><span>
</span><span id="line-1894"></span><span class="hs-comment">-----------------------</span><span>
</span><span id="line-1895"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#deeplySkolemise"><span class="hs-identifier hs-type">deeplySkolemise</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#SkolemInfo"><span class="hs-identifier hs-type">SkolemInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a></span><span>
</span><span id="line-1896"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a></span><span>
</span><span id="line-1897"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcInvisTVBinder"><span class="hs-identifier hs-type">TcInvisTVBinder</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>     </span><span class="hs-comment">-- All skolemised variables</span><span>
</span><span id="line-1898"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#EvVar"><span class="hs-identifier hs-type">EvVar</span></a></span><span class="hs-special">]</span><span>                      </span><span class="hs-comment">-- All &quot;given&quot;s</span><span>
</span><span id="line-1899"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcRhoType"><span class="hs-identifier hs-type">TcRhoType</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-1900"></span><span class="hs-comment">-- See Note [Deep skolemisation]</span><span>
</span><span id="line-1901"></span><span id="deeplySkolemise"><span class="annot"><span class="annottext">deeplySkolemise :: SkolemInfo
-&gt; TcType
-&gt; IOEnv
     (Env TcGblEnv TcLclEnv)
     (HsWrapper, [(Name, TcInvisTVBinder)], [TcTyVar], TcType)
</span><a href="GHC.Tc.Utils.Unify.html#deeplySkolemise"><span class="hs-identifier hs-var hs-var">deeplySkolemise</span></a></span></span><span> </span><span id="local-6989586621683018707"><span class="annot"><span class="annottext">SkolemInfo
</span><a href="#local-6989586621683018707"><span class="hs-identifier hs-var">skol_info</span></a></span></span><span> </span><span id="local-6989586621683018708"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018708"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-1902"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst
-&gt; TcType
-&gt; IOEnv
     (Env TcGblEnv TcLclEnv)
     (HsWrapper, [(Name, TcInvisTVBinder)], [TcTyVar], TcType)
</span><a href="#local-6989586621683018709"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683018710"><span class="hs-identifier hs-var">init_subst</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018708"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1903"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1904"></span><span>    </span><span id="local-6989586621683018710"><span class="annot"><span class="annottext">init_subst :: Subst
</span><a href="#local-6989586621683018710"><span class="hs-identifier hs-var hs-var">init_subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#mkEmptySubst"><span class="hs-identifier hs-var">mkEmptySubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarSet -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#mkInScopeSet"><span class="hs-identifier hs-var">mkInScopeSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018708"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1905"></span><span>
</span><span id="line-1906"></span><span>    </span><span id="local-6989586621683018709"><span class="annot"><span class="annottext">go :: Subst
-&gt; TcType
-&gt; IOEnv
     (Env TcGblEnv TcLclEnv)
     (HsWrapper, [(Name, TcInvisTVBinder)], [TcTyVar], TcType)
</span><a href="#local-6989586621683018709"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621683018714"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683018714"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621683018715"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018715"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-1907"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018716"><span class="annot"><span class="annottext">[Scaled TcType]
</span><a href="#local-6989586621683018716"><span class="hs-identifier hs-var">arg_tys</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018717"><span class="annot"><span class="annottext">[TcInvisTVBinder]
</span><a href="#local-6989586621683018717"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018718"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683018718"><span class="hs-identifier hs-var">theta</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018719"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018719"><span class="hs-identifier hs-var">ty'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType
-&gt; Maybe ([Scaled TcType], [TcInvisTVBinder], [TcType], TcType)
</span><a href="GHC.Tc.Utils.Unify.html#tcDeepSplitSigmaTy_maybe"><span class="hs-identifier hs-var">tcDeepSplitSigmaTy_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018715"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1908"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683018721"><span class="annot"><span class="annottext">arg_tys' :: [Scaled TcType]
</span><a href="#local-6989586621683018721"><span class="hs-identifier hs-var hs-var hs-var">arg_tys'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; [Scaled TcType] -&gt; [Scaled TcType]
Subst -&gt; [Scaled TcType] -&gt; [Scaled TcType]
</span><a href="GHC.Core.TyCo.Subst.html#substScaledTys"><span class="hs-identifier hs-var">substScaledTys</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683018714"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">[Scaled TcType]
</span><a href="#local-6989586621683018716"><span class="hs-identifier hs-var">arg_tys</span></a></span><span>
</span><span id="line-1909"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018723"><span class="annot"><a href="#local-6989586621683018723"><span class="hs-identifier hs-var">ids1</span></a></span></span><span>             </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FastString -&gt; [Scaled TcType] -&gt; TcRnIf TcGblEnv TcLclEnv [TcTyVar]
forall gbl lcl.
FastString -&gt; [Scaled TcType] -&gt; TcRnIf gbl lcl [TcTyVar]
</span><a href="GHC.Tc.Utils.Monad.html#newSysLocalIds"><span class="hs-identifier hs-var">newSysLocalIds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; FastString
</span><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;dk&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Scaled TcType]
</span><a href="#local-6989586621683018721"><span class="hs-identifier hs-var">arg_tys'</span></a></span><span>
</span><span id="line-1910"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018725"><span class="annot"><a href="#local-6989586621683018725"><span class="hs-identifier hs-var">subst'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018726"><span class="annot"><a href="#local-6989586621683018726"><span class="hs-identifier hs-var">bndrs1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Instantiate.html#tcInstSkolTyVarBndrsX"><span class="hs-identifier hs-type">tcInstSkolTyVarBndrsX</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018707"><span class="hs-identifier hs-type">skol_info</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018714"><span class="hs-identifier hs-type">subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018717"><span class="hs-identifier hs-type">bndrs</span></a></span><span>
</span><span id="line-1911"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018728"><span class="annot"><a href="#local-6989586621683018728"><span class="hs-identifier hs-var">ev_vars1</span></a></span></span><span>         </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#newEvVars"><span class="hs-identifier hs-type">newEvVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#substTheta"><span class="hs-identifier hs-type">substTheta</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018725"><span class="hs-identifier hs-type">subst'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018718"><span class="hs-identifier hs-type">theta</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1912"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018731"><span class="annot"><a href="#local-6989586621683018731"><span class="hs-identifier hs-var">wrap</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018732"><span class="annot"><a href="#local-6989586621683018732"><span class="hs-identifier hs-var">tvs_prs2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018733"><span class="annot"><a href="#local-6989586621683018733"><span class="hs-identifier hs-var">ev_vars2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018734"><span class="annot"><a href="#local-6989586621683018734"><span class="hs-identifier hs-var">rho</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621683018709"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018725"><span class="hs-identifier hs-type">subst'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018719"><span class="hs-identifier hs-type">ty'</span></a></span><span>
</span><span id="line-1913"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683018735"><span class="annot"><a href="#local-6989586621683018735"><span class="hs-identifier hs-var hs-var">tvs</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TcInvisTVBinder] -&gt; [TcTyVar]
forall tv argf. [VarBndr tv argf] -&gt; [tv]
</span><a href="GHC.Types.Var.html#binderVars"><span class="hs-identifier hs-var">binderVars</span></a></span><span> </span><span class="annot"><span class="annottext">[TcInvisTVBinder]
</span><a href="#local-6989586621683018717"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-1914"></span><span>                 </span><span id="local-6989586621683018736"><span class="annot"><a href="#local-6989586621683018736"><span class="hs-identifier hs-var hs-var">tvs1</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TcInvisTVBinder] -&gt; [TcTyVar]
forall tv argf. [VarBndr tv argf] -&gt; [tv]
</span><a href="GHC.Types.Var.html#binderVars"><span class="hs-identifier hs-var">binderVars</span></a></span><span> </span><span class="annot"><span class="annottext">[TcInvisTVBinder]
</span><a href="#local-6989586621683018726"><span class="hs-identifier hs-var">bndrs1</span></a></span><span>
</span><span id="line-1915"></span><span>                 </span><span id="local-6989586621683018737"><span class="annot"><a href="#local-6989586621683018737"><span class="hs-identifier hs-var hs-var">tv_prs1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TcTyVar -&gt; Name) -&gt; [TcTyVar] -&gt; [Name]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; Name
</span><a href="GHC.Types.Var.html#tyVarName"><span class="hs-identifier hs-var">tyVarName</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683018735"><span class="hs-identifier hs-var">tvs</span></a></span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; [TcInvisTVBinder] -&gt; [(Name, TcInvisTVBinder)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-operator hs-var">`zip`</span></span><span> </span><span class="annot"><span class="annottext">[TcInvisTVBinder]
</span><a href="#local-6989586621683018726"><span class="hs-identifier hs-var">bndrs1</span></a></span><span>
</span><span id="line-1916"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#mkWpEta"><span class="hs-identifier hs-type">mkWpEta</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018723"><span class="hs-identifier hs-type">ids1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#mkWpTyLams"><span class="hs-identifier hs-type">mkWpTyLams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018736"><span class="hs-identifier hs-type">tvs1</span></a></span><span>
</span><span id="line-1917"></span><span>                                    </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#%3C.%3E"><span class="hs-operator hs-type">&lt;.&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#mkWpEvLams"><span class="hs-identifier hs-type">mkWpEvLams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018728"><span class="hs-identifier hs-type">ev_vars1</span></a></span><span>
</span><span id="line-1918"></span><span>                                    </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#%3C.%3E"><span class="hs-operator hs-type">&lt;.&gt;</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018731"><span class="hs-identifier hs-type">wrap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1919"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683018737"><span class="hs-identifier hs-type">tv_prs1</span></a></span><span>  </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621683018732"><span class="hs-identifier hs-type">tvs_prs2</span></a></span><span>
</span><span id="line-1920"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683018728"><span class="hs-identifier hs-type">ev_vars1</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621683018733"><span class="hs-identifier hs-type">ev_vars2</span></a></span><span>
</span><span id="line-1921"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#mkScaledFunTys"><span class="hs-identifier hs-type">mkScaledFunTys</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018721"><span class="hs-identifier hs-type">arg_tys'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018734"><span class="hs-identifier hs-type">rho</span></a></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1922"></span><span>
</span><span id="line-1923"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1924"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(HsWrapper, [(Name, TcInvisTVBinder)], [TcTyVar], TcType)
-&gt; IOEnv
     (Env TcGblEnv TcLclEnv)
     (HsWrapper, [(Name, TcInvisTVBinder)], [TcTyVar], TcType)
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HsWrapper
</span><a href="GHC.Tc.Types.Evidence.html#idHsWrapper"><span class="hs-identifier hs-var">idHsWrapper</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; TcType -&gt; TcType
Subst -&gt; TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Subst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683018714"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018715"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1925"></span><span>        </span><span class="hs-comment">-- substTy is a quick no-op on an empty substitution</span><span>
</span><span id="line-1926"></span><span>
</span><span id="line-1927"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#deeplyInstantiate"><span class="hs-identifier hs-type">deeplyInstantiate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1928"></span><span id="deeplyInstantiate"><span class="annot"><span class="annottext">deeplyInstantiate :: CtOrigin -&gt; TcType -&gt; TcM (HsWrapper, TcType)
</span><a href="GHC.Tc.Utils.Unify.html#deeplyInstantiate"><span class="hs-identifier hs-var hs-var">deeplyInstantiate</span></a></span></span><span> </span><span id="local-6989586621683018744"><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018744"><span class="hs-identifier hs-var">orig</span></a></span></span><span> </span><span id="local-6989586621683018745"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018745"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-1929"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; TcType -&gt; TcM (HsWrapper, TcType)
</span><a href="#local-6989586621683018746"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683018747"><span class="hs-identifier hs-var">init_subst</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018745"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1930"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1931"></span><span>    </span><span id="local-6989586621683018747"><span class="annot"><span class="annottext">init_subst :: Subst
</span><a href="#local-6989586621683018747"><span class="hs-identifier hs-var hs-var">init_subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#mkEmptySubst"><span class="hs-identifier hs-var">mkEmptySubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarSet -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#mkInScopeSet"><span class="hs-identifier hs-var">mkInScopeSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018745"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1932"></span><span>
</span><span id="line-1933"></span><span>    </span><span id="local-6989586621683018746"><span class="annot"><span class="annottext">go :: Subst -&gt; TcType -&gt; TcM (HsWrapper, TcType)
</span><a href="#local-6989586621683018746"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621683018748"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683018748"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621683018749"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018749"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-1934"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018750"><span class="annot"><span class="annottext">[Scaled TcType]
</span><a href="#local-6989586621683018750"><span class="hs-identifier hs-var">arg_tys</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018751"><span class="annot"><span class="annottext">[TcInvisTVBinder]
</span><a href="#local-6989586621683018751"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018752"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683018752"><span class="hs-identifier hs-var">theta</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018753"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018753"><span class="hs-identifier hs-var">rho</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType
-&gt; Maybe ([Scaled TcType], [TcInvisTVBinder], [TcType], TcType)
</span><a href="GHC.Tc.Utils.Unify.html#tcDeepSplitSigmaTy_maybe"><span class="hs-identifier hs-var">tcDeepSplitSigmaTy_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018749"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1935"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683018754"><span class="annot"><span class="annottext">tvs :: [TcTyVar]
</span><a href="#local-6989586621683018754"><span class="hs-identifier hs-var hs-var hs-var">tvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TcInvisTVBinder] -&gt; [TcTyVar]
forall tv argf. [VarBndr tv argf] -&gt; [tv]
</span><a href="GHC.Types.Var.html#binderVars"><span class="hs-identifier hs-var">binderVars</span></a></span><span> </span><span class="annot"><span class="annottext">[TcInvisTVBinder]
</span><a href="#local-6989586621683018751"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-1936"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018755"><span class="annot"><a href="#local-6989586621683018755"><span class="hs-identifier hs-var">subst'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018756"><span class="annot"><a href="#local-6989586621683018756"><span class="hs-identifier hs-var">tvs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; [TcTyVar] -&gt; TcM (Subst, [TcTyVar])
</span><a href="GHC.Tc.Utils.TcMType.html#newMetaTyVarsX"><span class="hs-identifier hs-var">newMetaTyVarsX</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683018748"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683018754"><span class="hs-identifier hs-var">tvs</span></a></span><span>
</span><span id="line-1937"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683018758"><span class="annot"><a href="#local-6989586621683018758"><span class="hs-identifier hs-var hs-var">arg_tys'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; [Scaled TcType] -&gt; [Scaled TcType]
Subst -&gt; [Scaled TcType] -&gt; [Scaled TcType]
</span><a href="GHC.Core.TyCo.Subst.html#substScaledTys"><span class="hs-identifier hs-var">substScaledTys</span></a></span><span>   </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683018755"><span class="hs-identifier hs-var">subst'</span></a></span><span> </span><span class="annot"><span class="annottext">[Scaled TcType]
</span><a href="#local-6989586621683018750"><span class="hs-identifier hs-var">arg_tys</span></a></span><span>
</span><span id="line-1938"></span><span>                 </span><span id="local-6989586621683018759"><span class="annot"><a href="#local-6989586621683018759"><span class="hs-identifier hs-var hs-var">theta'</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; [TcType] -&gt; [TcType]
Subst -&gt; [TcType] -&gt; [TcType]
</span><a href="GHC.Core.TyCo.Subst.html#substTheta"><span class="hs-identifier hs-var">substTheta</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683018755"><span class="hs-identifier hs-var">subst'</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683018752"><span class="hs-identifier hs-var">theta</span></a></span><span>
</span><span id="line-1939"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018760"><span class="annot"><a href="#local-6989586621683018760"><span class="hs-identifier hs-var">ids1</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#newSysLocalIds"><span class="hs-identifier hs-type">newSysLocalIds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier hs-type">fsLit</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;di&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683018758"><span class="hs-identifier hs-type">arg_tys'</span></a></span><span>
</span><span id="line-1940"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018761"><span class="annot"><a href="#local-6989586621683018761"><span class="hs-identifier hs-var">wrap1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Instantiate.html#instCall"><span class="hs-identifier hs-type">instCall</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018744"><span class="hs-identifier hs-type">orig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#mkTyVarTys"><span class="hs-identifier hs-type">mkTyVarTys</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018756"><span class="hs-identifier hs-type">tvs'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683018759"><span class="hs-identifier hs-type">theta'</span></a></span><span>
</span><span id="line-1941"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018763"><span class="annot"><a href="#local-6989586621683018763"><span class="hs-identifier hs-var">wrap2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018764"><span class="annot"><a href="#local-6989586621683018764"><span class="hs-identifier hs-var">rho2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621683018746"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018755"><span class="hs-identifier hs-type">subst'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018753"><span class="hs-identifier hs-type">rho</span></a></span><span>
</span><span id="line-1942"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#mkWpEta"><span class="hs-identifier hs-type">mkWpEta</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018760"><span class="hs-identifier hs-type">ids1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683018763"><span class="hs-identifier hs-type">wrap2</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#%3C.%3E"><span class="hs-operator hs-type">&lt;.&gt;</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018761"><span class="hs-identifier hs-type">wrap1</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1943"></span><span>                     </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#mkScaledFunTys"><span class="hs-identifier hs-type">mkScaledFunTys</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018758"><span class="hs-identifier hs-type">arg_tys'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018764"><span class="hs-identifier hs-type">rho2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1944"></span><span>
</span><span id="line-1945"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1946"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683018765"><span class="annot"><span class="annottext">ty' :: TcType
</span><a href="#local-6989586621683018765"><span class="hs-identifier hs-var hs-var">ty'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; TcType -&gt; TcType
Subst -&gt; TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Subst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683018748"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018749"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1947"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(HsWrapper, TcType) -&gt; TcM (HsWrapper, TcType)
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HsWrapper
</span><a href="GHC.Tc.Types.Evidence.html#idHsWrapper"><span class="hs-identifier hs-var">idHsWrapper</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018765"><span class="hs-identifier hs-var">ty'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1948"></span><span>
</span><span id="line-1949"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcDeepSplitSigmaTy_maybe"><span class="hs-identifier hs-type">tcDeepSplitSigmaTy_maybe</span></a></span><span>
</span><span id="line-1950"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Scaled"><span class="hs-identifier hs-type">Scaled</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcInvisTVBinder"><span class="hs-identifier hs-type">TcInvisTVBinder</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1951"></span><span class="hs-comment">-- Looks for a *non-trivial* quantified type, under zero or more function arrows</span><span>
</span><span id="line-1952"></span><span class="hs-comment">-- By &quot;non-trivial&quot; we mean either tyvars or constraints are non-empty</span><span>
</span><span id="line-1953"></span><span id="tcDeepSplitSigmaTy_maybe"><span class="annot"><span class="annottext">tcDeepSplitSigmaTy_maybe :: TcType
-&gt; Maybe ([Scaled TcType], [TcInvisTVBinder], [TcType], TcType)
</span><a href="GHC.Tc.Utils.Unify.html#tcDeepSplitSigmaTy_maybe"><span class="hs-identifier hs-var hs-var">tcDeepSplitSigmaTy_maybe</span></a></span></span><span> </span><span id="local-6989586621683018767"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018767"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-1954"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType
-&gt; Maybe ([Scaled TcType], [TcInvisTVBinder], [TcType], TcType)
</span><a href="#local-6989586621683018768"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018767"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1955"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1956"></span><span>  </span><span id="local-6989586621683018768"><span class="annot"><span class="annottext">go :: TcType
-&gt; Maybe ([Scaled TcType], [TcInvisTVBinder], [TcType], TcType)
</span><a href="#local-6989586621683018768"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621683018771"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018771"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018772"><span class="annot"><span class="annottext">Scaled TcType
</span><a href="#local-6989586621683018772"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018773"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018773"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span class="hs-special">)</span><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe (Scaled TcType, TcType)
</span><a href="GHC.Tc.Utils.TcType.html#tcSplitFunTy_maybe"><span class="hs-identifier hs-var">tcSplitFunTy_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018771"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1957"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018775"><span class="annot"><span class="annottext">[Scaled TcType]
</span><a href="#local-6989586621683018775"><span class="hs-identifier hs-var">arg_tys</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018776"><span class="annot"><span class="annottext">[TcInvisTVBinder]
</span><a href="#local-6989586621683018776"><span class="hs-identifier hs-var">tvs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018777"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683018777"><span class="hs-identifier hs-var">theta</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018778"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018778"><span class="hs-identifier hs-var">rho</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType
-&gt; Maybe ([Scaled TcType], [TcInvisTVBinder], [TcType], TcType)
</span><a href="#local-6989586621683018768"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018773"><span class="hs-identifier hs-var">res_ty</span></a></span><span>
</span><span id="line-1958"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([Scaled TcType], [TcInvisTVBinder], [TcType], TcType)
-&gt; Maybe ([Scaled TcType], [TcInvisTVBinder], [TcType], TcType)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scaled TcType
</span><a href="#local-6989586621683018772"><span class="hs-identifier hs-var">arg_ty</span></a></span><span class="annot"><span class="annottext">Scaled TcType -&gt; [Scaled TcType] -&gt; [Scaled TcType]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[Scaled TcType]
</span><a href="#local-6989586621683018775"><span class="hs-identifier hs-var">arg_tys</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TcInvisTVBinder]
</span><a href="#local-6989586621683018776"><span class="hs-identifier hs-var">tvs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683018777"><span class="hs-identifier hs-var">theta</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018778"><span class="hs-identifier hs-var">rho</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1959"></span><span>
</span><span id="line-1960"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018779"><span class="annot"><span class="annottext">[TcInvisTVBinder]
</span><a href="#local-6989586621683018779"><span class="hs-identifier hs-var">tvs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018780"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683018780"><span class="hs-identifier hs-var">theta</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018781"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018781"><span class="hs-identifier hs-var">rho</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; ([TcInvisTVBinder], [TcType], TcType)
</span><a href="GHC.Tc.Utils.TcType.html#tcSplitSigmaTyBndrs"><span class="hs-identifier hs-var">tcSplitSigmaTyBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018771"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1961"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TcInvisTVBinder] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[TcInvisTVBinder]
</span><a href="#local-6989586621683018779"><span class="hs-identifier hs-var">tvs</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683018780"><span class="hs-identifier hs-var">theta</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1962"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([Scaled TcType], [TcInvisTVBinder], [TcType], TcType)
-&gt; Maybe ([Scaled TcType], [TcInvisTVBinder], [TcType], TcType)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TcInvisTVBinder]
</span><a href="#local-6989586621683018779"><span class="hs-identifier hs-var">tvs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683018780"><span class="hs-identifier hs-var">theta</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018781"><span class="hs-identifier hs-var">rho</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1963"></span><span>
</span><span id="line-1964"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ([Scaled TcType], [TcInvisTVBinder], [TcType], TcType)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1965"></span><span>
</span><span id="line-1966"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#isDeepRhoTy"><span class="hs-identifier hs-type">isDeepRhoTy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1967"></span><span class="hs-comment">-- True if there are no foralls or (=&gt;) at the top, or nested under</span><span>
</span><span id="line-1968"></span><span class="hs-comment">-- arrows to the right.  e.g</span><span>
</span><span id="line-1969"></span><span class="hs-comment">--    forall a. a                  False</span><span>
</span><span id="line-1970"></span><span class="hs-comment">--    Int -&gt; forall a. a           False</span><span>
</span><span id="line-1971"></span><span class="hs-comment">--    (forall a. a) -&gt; Int         True</span><span>
</span><span id="line-1972"></span><span class="hs-comment">-- Returns True iff tcDeepSplitSigmaTy_maybe returns Nothing</span><span>
</span><span id="line-1973"></span><span id="isDeepRhoTy"><span class="annot"><span class="annottext">isDeepRhoTy :: TcType -&gt; Bool
</span><a href="GHC.Tc.Utils.Unify.html#isDeepRhoTy"><span class="hs-identifier hs-var hs-var">isDeepRhoTy</span></a></span></span><span> </span><span id="local-6989586621683018783"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018783"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-1974"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isRhoTy"><span class="hs-identifier hs-var">isRhoTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018783"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>                       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>  </span><span class="hs-comment">-- Foralls or (=&gt;) at top</span><span>
</span><span id="line-1975"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scaled TcType
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018784"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018784"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe (Scaled TcType, TcType)
</span><a href="GHC.Tc.Utils.TcType.html#tcSplitFunTy_maybe"><span class="hs-identifier hs-var">tcSplitFunTy_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018783"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="GHC.Tc.Utils.Unify.html#isDeepRhoTy"><span class="hs-identifier hs-var">isDeepRhoTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018784"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-1976"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>   </span><span class="hs-comment">-- No forall, (=&gt;), or (-&gt;) at top</span><span>
</span><span id="line-1977"></span><span>
</span><span id="line-1978"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#isRhoTyDS"><span class="hs-identifier hs-type">isRhoTyDS</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#DeepSubsumptionFlag"><span class="hs-identifier hs-type">DeepSubsumptionFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1979"></span><span id="isRhoTyDS"><span class="annot"><span class="annottext">isRhoTyDS :: DeepSubsumptionFlag -&gt; TcType -&gt; Bool
</span><a href="GHC.Tc.Utils.Unify.html#isRhoTyDS"><span class="hs-identifier hs-var hs-var">isRhoTyDS</span></a></span></span><span> </span><span id="local-6989586621683018785"><span class="annot"><span class="annottext">DeepSubsumptionFlag
</span><a href="#local-6989586621683018785"><span class="hs-identifier hs-var">ds_flag</span></a></span></span><span> </span><span id="local-6989586621683018786"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018786"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-1980"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">DeepSubsumptionFlag
</span><a href="#local-6989586621683018785"><span class="hs-identifier hs-var">ds_flag</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1981"></span><span>      </span><span class="annot"><span class="annottext">DeepSubsumptionFlag
</span><a href="GHC.Tc.Utils.Unify.html#Shallow"><span class="hs-identifier hs-var">Shallow</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isRhoTy"><span class="hs-identifier hs-var">isRhoTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018786"><span class="hs-identifier hs-var">ty</span></a></span><span>      </span><span class="hs-comment">-- isRhoTy: no top level forall or (=&gt;)</span><span>
</span><span id="line-1982"></span><span>      </span><span class="annot"><span class="annottext">DeepSubsumptionFlag
</span><a href="GHC.Tc.Utils.Unify.html#Deep"><span class="hs-identifier hs-var">Deep</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="GHC.Tc.Utils.Unify.html#isDeepRhoTy"><span class="hs-identifier hs-var">isDeepRhoTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018786"><span class="hs-identifier hs-var">ty</span></a></span><span>  </span><span class="hs-comment">-- &quot;deep&quot; version: no nested forall or (=&gt;)</span><span>
</span><span id="line-1983"></span><span>
</span><span id="line-1984"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Boxy unification
*                                                                      *
************************************************************************

The exported functions are all defined as versions of some
non-exported generic functions.
-}</span><span>
</span><span id="line-1994"></span><span>
</span><span id="line-1995"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#unifyExprType"><span class="hs-identifier hs-type">unifyExprType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Expr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#TcCoercionN"><span class="hs-identifier hs-type">TcCoercionN</span></a></span><span>
</span><span id="line-1996"></span><span id="unifyExprType"><span class="annot"><span class="annottext">unifyExprType :: HsExpr GhcRn -&gt; TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#unifyExprType"><span class="hs-identifier hs-var hs-var">unifyExprType</span></a></span></span><span> </span><span id="local-6989586621683018787"><span class="annot"><span class="annottext">HsExpr GhcRn
</span><a href="#local-6989586621683018787"><span class="hs-identifier hs-var">rn_expr</span></a></span></span><span> </span><span id="local-6989586621683018788"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018788"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683018789"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018789"><span class="hs-identifier hs-var">ty2</span></a></span></span><span>
</span><span id="line-1997"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe TypedThing -&gt; TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#unifyType"><span class="hs-identifier hs-var">unifyType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypedThing -&gt; Maybe TypedThing
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HsExpr GhcRn -&gt; TypedThing
</span><a href="GHC.Tc.Types.Origin.html#HsExprRnThing"><span class="hs-identifier hs-var">HsExprRnThing</span></a></span><span> </span><span class="annot"><span class="annottext">HsExpr GhcRn
</span><a href="#local-6989586621683018787"><span class="hs-identifier hs-var">rn_expr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018788"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018789"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-1998"></span><span>
</span><span id="line-1999"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#unifyType"><span class="hs-identifier hs-type">unifyType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#TypedThing"><span class="hs-identifier hs-type">TypedThing</span></a></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ If present, the thing that has type ty1</span></span><span>
</span><span id="line-2000"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcTauType"><span class="hs-identifier hs-type">TcTauType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcTauType"><span class="hs-identifier hs-type">TcTauType</span></a></span><span>    </span><span class="hs-comment">-- ty1 (actual), ty2 (expected)</span><span>
</span><span id="line-2001"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#TcCoercionN"><span class="hs-identifier hs-type">TcCoercionN</span></a></span><span>           </span><span class="hs-comment">-- :: ty1 ~# ty2</span><span>
</span><span id="line-2002"></span><span class="hs-comment">-- Actual and expected types</span><span>
</span><span id="line-2003"></span><span class="hs-comment">-- Returns a coercion : ty1 ~ ty2</span><span>
</span><span id="line-2004"></span><span id="unifyType"><span class="annot"><span class="annottext">unifyType :: Maybe TypedThing -&gt; TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#unifyType"><span class="hs-identifier hs-var hs-var">unifyType</span></a></span></span><span> </span><span id="local-6989586621683018791"><span class="annot"><span class="annottext">Maybe TypedThing
</span><a href="#local-6989586621683018791"><span class="hs-identifier hs-var">thing</span></a></span></span><span> </span><span id="local-6989586621683018792"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018792"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683018793"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018793"><span class="hs-identifier hs-var">ty2</span></a></span></span><span>
</span><span id="line-2005"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKind -&gt; CtOrigin -&gt; TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#unifyTypeAndEmit"><span class="hs-identifier hs-var">unifyTypeAndEmit</span></a></span><span> </span><span class="annot"><span class="annottext">TypeOrKind
</span><a href="GHC.Types.Basic.html#TypeLevel"><span class="hs-identifier hs-var">TypeLevel</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018794"><span class="hs-identifier hs-var">origin</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018792"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018793"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-2006"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2007"></span><span>    </span><span id="local-6989586621683018794"><span class="annot"><span class="annottext">origin :: CtOrigin
</span><a href="#local-6989586621683018794"><span class="hs-identifier hs-var hs-var">origin</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#TypeEqOrigin"><span class="hs-identifier hs-type">TypeEqOrigin</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">uo_actual :: TcType
</span><a href="GHC.Tc.Types.Origin.html#uo_actual"><span class="hs-identifier hs-var">uo_actual</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018792"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-2008"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uo_expected :: TcType
</span><a href="GHC.Tc.Types.Origin.html#uo_expected"><span class="hs-identifier hs-var">uo_expected</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018793"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-2009"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uo_thing :: Maybe TypedThing
</span><a href="GHC.Tc.Types.Origin.html#uo_thing"><span class="hs-identifier hs-var">uo_thing</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe TypedThing
</span><a href="#local-6989586621683018791"><span class="hs-identifier hs-var">thing</span></a></span><span>
</span><span id="line-2010"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uo_visible :: Bool
</span><a href="GHC.Tc.Types.Origin.html#uo_visible"><span class="hs-identifier hs-var">uo_visible</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2011"></span><span>
</span><span id="line-2012"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#unifyInvisibleType"><span class="hs-identifier hs-type">unifyInvisibleType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcTauType"><span class="hs-identifier hs-type">TcTauType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcTauType"><span class="hs-identifier hs-type">TcTauType</span></a></span><span>    </span><span class="hs-comment">-- ty1 (actual), ty2 (expected)</span><span>
</span><span id="line-2013"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#TcCoercionN"><span class="hs-identifier hs-type">TcCoercionN</span></a></span><span>           </span><span class="hs-comment">-- :: ty1 ~# ty2</span><span>
</span><span id="line-2014"></span><span class="hs-comment">-- Actual and expected types</span><span>
</span><span id="line-2015"></span><span class="hs-comment">-- Returns a coercion : ty1 ~ ty2</span><span>
</span><span id="line-2016"></span><span id="unifyInvisibleType"><span class="annot"><span class="annottext">unifyInvisibleType :: TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#unifyInvisibleType"><span class="hs-identifier hs-var hs-var">unifyInvisibleType</span></a></span></span><span> </span><span id="local-6989586621683018800"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018800"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683018801"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018801"><span class="hs-identifier hs-var">ty2</span></a></span></span><span>
</span><span id="line-2017"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKind -&gt; CtOrigin -&gt; TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#unifyTypeAndEmit"><span class="hs-identifier hs-var">unifyTypeAndEmit</span></a></span><span> </span><span class="annot"><span class="annottext">TypeOrKind
</span><a href="GHC.Types.Basic.html#TypeLevel"><span class="hs-identifier hs-var">TypeLevel</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018802"><span class="hs-identifier hs-var">origin</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018800"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018801"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-2018"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2019"></span><span>    </span><span id="local-6989586621683018802"><span class="annot"><span class="annottext">origin :: CtOrigin
</span><a href="#local-6989586621683018802"><span class="hs-identifier hs-var hs-var">origin</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#TypeEqOrigin"><span class="hs-identifier hs-type">TypeEqOrigin</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">uo_actual :: TcType
</span><a href="GHC.Tc.Types.Origin.html#uo_actual"><span class="hs-identifier hs-var">uo_actual</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018800"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-2020"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uo_expected :: TcType
</span><a href="GHC.Tc.Types.Origin.html#uo_expected"><span class="hs-identifier hs-var">uo_expected</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018801"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-2021"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uo_thing :: Maybe TypedThing
</span><a href="GHC.Tc.Types.Origin.html#uo_thing"><span class="hs-identifier hs-var">uo_thing</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe TypedThing
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-2022"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uo_visible :: Bool
</span><a href="GHC.Tc.Types.Origin.html#uo_visible"><span class="hs-identifier hs-var">uo_visible</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-special">}</span><span>  </span><span class="hs-comment">-- This is the &quot;invisible&quot; bit</span><span>
</span><span id="line-2023"></span><span>
</span><span id="line-2024"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#unifyTypeET"><span class="hs-identifier hs-type">unifyTypeET</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcTauType"><span class="hs-identifier hs-type">TcTauType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcTauType"><span class="hs-identifier hs-type">TcTauType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a></span><span>
</span><span id="line-2025"></span><span class="hs-comment">-- Like unifyType, but swap expected and actual in error messages</span><span>
</span><span id="line-2026"></span><span class="hs-comment">-- This is used when typechecking patterns</span><span>
</span><span id="line-2027"></span><span id="unifyTypeET"><span class="annot"><span class="annottext">unifyTypeET :: TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#unifyTypeET"><span class="hs-identifier hs-var hs-var">unifyTypeET</span></a></span></span><span> </span><span id="local-6989586621683018804"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018804"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683018805"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018805"><span class="hs-identifier hs-var">ty2</span></a></span></span><span>
</span><span id="line-2028"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKind -&gt; CtOrigin -&gt; TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#unifyTypeAndEmit"><span class="hs-identifier hs-var">unifyTypeAndEmit</span></a></span><span> </span><span class="annot"><span class="annottext">TypeOrKind
</span><a href="GHC.Types.Basic.html#TypeLevel"><span class="hs-identifier hs-var">TypeLevel</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018806"><span class="hs-identifier hs-var">origin</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018804"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018805"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-2029"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2030"></span><span>    </span><span id="local-6989586621683018806"><span class="annot"><span class="annottext">origin :: CtOrigin
</span><a href="#local-6989586621683018806"><span class="hs-identifier hs-var hs-var">origin</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#TypeEqOrigin"><span class="hs-identifier hs-type">TypeEqOrigin</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">uo_actual :: TcType
</span><a href="GHC.Tc.Types.Origin.html#uo_actual"><span class="hs-identifier hs-var">uo_actual</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018805"><span class="hs-identifier hs-var">ty2</span></a></span><span>   </span><span class="hs-comment">-- NB swapped</span><span>
</span><span id="line-2031"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uo_expected :: TcType
</span><a href="GHC.Tc.Types.Origin.html#uo_expected"><span class="hs-identifier hs-var">uo_expected</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018804"><span class="hs-identifier hs-var">ty1</span></a></span><span>   </span><span class="hs-comment">-- NB swapped</span><span>
</span><span id="line-2032"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uo_thing :: Maybe TypedThing
</span><a href="GHC.Tc.Types.Origin.html#uo_thing"><span class="hs-identifier hs-var">uo_thing</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe TypedThing
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-2033"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uo_visible :: Bool
</span><a href="GHC.Tc.Types.Origin.html#uo_visible"><span class="hs-identifier hs-var">uo_visible</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2034"></span><span>
</span><span id="line-2035"></span><span>
</span><span id="line-2036"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#unifyKind"><span class="hs-identifier hs-type">unifyKind</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#TypedThing"><span class="hs-identifier hs-type">TypedThing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcKind"><span class="hs-identifier hs-type">TcKind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcKind"><span class="hs-identifier hs-type">TcKind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a></span><span>
</span><span id="line-2037"></span><span id="unifyKind"><span class="annot"><span class="annottext">unifyKind :: Maybe TypedThing -&gt; TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#unifyKind"><span class="hs-identifier hs-var hs-var">unifyKind</span></a></span></span><span> </span><span id="local-6989586621683018808"><span class="annot"><span class="annottext">Maybe TypedThing
</span><a href="#local-6989586621683018808"><span class="hs-identifier hs-var">mb_thing</span></a></span></span><span> </span><span id="local-6989586621683018809"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018809"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683018810"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018810"><span class="hs-identifier hs-var">ty2</span></a></span></span><span>
</span><span id="line-2038"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKind -&gt; CtOrigin -&gt; TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#unifyTypeAndEmit"><span class="hs-identifier hs-var">unifyTypeAndEmit</span></a></span><span> </span><span class="annot"><span class="annottext">TypeOrKind
</span><a href="GHC.Types.Basic.html#KindLevel"><span class="hs-identifier hs-var">KindLevel</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018812"><span class="hs-identifier hs-var">origin</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018809"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018810"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-2039"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2040"></span><span>    </span><span id="local-6989586621683018812"><span class="annot"><span class="annottext">origin :: CtOrigin
</span><a href="#local-6989586621683018812"><span class="hs-identifier hs-var hs-var">origin</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#TypeEqOrigin"><span class="hs-identifier hs-type">TypeEqOrigin</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">uo_actual :: TcType
</span><a href="GHC.Tc.Types.Origin.html#uo_actual"><span class="hs-identifier hs-var">uo_actual</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018809"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-2041"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uo_expected :: TcType
</span><a href="GHC.Tc.Types.Origin.html#uo_expected"><span class="hs-identifier hs-var">uo_expected</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018810"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-2042"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uo_thing :: Maybe TypedThing
</span><a href="GHC.Tc.Types.Origin.html#uo_thing"><span class="hs-identifier hs-var">uo_thing</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe TypedThing
</span><a href="#local-6989586621683018808"><span class="hs-identifier hs-var">mb_thing</span></a></span><span>
</span><span id="line-2043"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uo_visible :: Bool
</span><a href="GHC.Tc.Types.Origin.html#uo_visible"><span class="hs-identifier hs-var">uo_visible</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2044"></span><span>
</span><span id="line-2045"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#unifyTypeAndEmit"><span class="hs-identifier hs-type">unifyTypeAndEmit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TypeOrKind"><span class="hs-identifier hs-type">TypeOrKind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a></span><span>
</span><span id="line-2046"></span><span class="hs-comment">-- Make a ref-cell, unify, emit the collected constraints</span><span>
</span><span id="line-2047"></span><span id="unifyTypeAndEmit"><span class="annot"><span class="annottext">unifyTypeAndEmit :: TypeOrKind -&gt; CtOrigin -&gt; TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#unifyTypeAndEmit"><span class="hs-identifier hs-var hs-var">unifyTypeAndEmit</span></a></span></span><span> </span><span id="local-6989586621683018813"><span class="annot"><span class="annottext">TypeOrKind
</span><a href="#local-6989586621683018813"><span class="hs-identifier hs-var">t_or_k</span></a></span></span><span> </span><span id="local-6989586621683018814"><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621683018814"><span class="hs-identifier hs-var">orig</span></a></span></span><span> </span><span id="local-6989586621683018815"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018815"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683018816"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018816"><span class="hs-identifier hs-var">ty2</span></a></span></span><span>
</span><span id="line-2048"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018817"><span class="annot"><a href="#local-6989586621683018817"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Bag Ct -&gt; IOEnv (Env TcGblEnv TcLclEnv) (TcRef (Bag Ct))
forall (m :: * -&gt; *) a. MonadIO m =&gt; a -&gt; m (TcRef a)
</span><a href="GHC.Tc.Types.TcRef.html#newTcRef"><span class="hs-identifier hs-var">newTcRef</span></a></span><span> </span><span class="annot"><span class="annottext">Bag Ct
forall a. Bag a
</span><a href="GHC.Data.Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a></span><span>
</span><span id="line-2049"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018819"><span class="annot"><a href="#local-6989586621683018819"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#getCtLocM"><span class="hs-identifier hs-type">getCtLocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018814"><span class="hs-identifier hs-type">orig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="#local-6989586621683018813"><span class="hs-identifier hs-type">t_or_k</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2050"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683018821"><span class="annot"><a href="#local-6989586621683018821"><span class="hs-identifier hs-var hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#UE"><span class="hs-identifier hs-type">UE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">u_loc :: CtLoc
</span><a href="GHC.Tc.Utils.Unify.html#u_loc"><span class="hs-identifier hs-var">u_loc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683018819"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">u_role :: Role
</span><a href="GHC.Tc.Utils.Unify.html#u_role"><span class="hs-identifier hs-var">u_role</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span>
</span><span id="line-2051"></span><span>                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">u_rewriters :: RewriterSet
</span><a href="GHC.Tc.Utils.Unify.html#u_rewriters"><span class="hs-identifier hs-var">u_rewriters</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RewriterSet
</span><a href="GHC.Tc.Types.Constraint.html#emptyRewriterSet"><span class="hs-identifier hs-var">emptyRewriterSet</span></a></span><span>  </span><span class="hs-comment">-- ToDo: check this</span><span>
</span><span id="line-2052"></span><span>                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">u_defer :: TcRef (Bag Ct)
</span><a href="GHC.Tc.Utils.Unify.html#u_defer"><span class="hs-identifier hs-var">u_defer</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcRef (Bag Ct)
</span><a href="#local-6989586621683018817"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">u_unified :: Maybe (TcRef [TcTyVar])
</span><a href="GHC.Tc.Utils.Unify.html#u_unified"><span class="hs-identifier hs-var">u_unified</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (TcRef [TcTyVar])
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2053"></span><span>
</span><span id="line-2054"></span><span>       </span><span class="hs-comment">-- The hard work happens here</span><span>
</span><span id="line-2055"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018830"><span class="annot"><a href="#local-6989586621683018830"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#uType"><span class="hs-identifier hs-type">uType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018821"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018815"><span class="hs-identifier hs-type">ty1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018816"><span class="hs-identifier hs-type">ty2</span></a></span><span>
</span><span id="line-2056"></span><span>
</span><span id="line-2057"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018831"><span class="annot"><a href="#local-6989586621683018831"><span class="hs-identifier hs-var">cts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TcRef.html#readTcRef"><span class="hs-identifier hs-type">readTcRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018817"><span class="hs-identifier hs-type">ref</span></a></span><span>
</span><span id="line-2058"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">null</span></span><span> </span><span class="annot"><a href="#local-6989586621683018831"><span class="hs-identifier hs-type">cts</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#emitSimples"><span class="hs-identifier hs-type">emitSimples</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018831"><span class="hs-identifier hs-type">cts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2059"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683018830"><span class="hs-identifier hs-type">co</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2060"></span><span>
</span><span id="line-2061"></span><span class="hs-comment">{-
%************************************************************************
%*                                                                      *
                 uType and friends
%*                                                                      *
%************************************************************************

Note [The eager unifier]
~~~~~~~~~~~~~~~~~~~~~~~~
The eager unifier, `uType`, is called by

  * The constraint generator (e.g. in GHC.Tc.Gen.Expr),
    via the wrappers `unifyType`, `unifyKind` etc

  * The constraint solver (e.g. in GHC.Tc.Solver.Equality),
    via `GHC.Tc.Solver.Monad.wrapUnifierTcS`.

`uType` runs in the TcM monad, but it carries a UnifyEnv that tells it
what to do when unifying a variable or deferring a constraint. Specifically,
  * it collects deferred constraints in `u_defer`, and
  * it records which unification variables it has unified in `u_unified`
Then it is up to the wrappers (one for the constraint generator, one for
the constraint solver) to deal with these collected sets.

Although `uType` runs in the TcM monad for convenience, really it could
operate just with the ability to
  * write to the accumulators of deferred constraints
    and unification variables in UnifyEnv.
  * read and update existing unification variables
  * zonk types befire unifying (`zonkTcType` in `uUnfilledVar`, and
    `zonkTyCoVarKind` in `uUnfilledVar1`
  * create fresh coercion holes (`newCoercionHole`)
  * emit tracing info for debugging
  * look at the ambient TcLevel: `getTcLevel`
A job for the future.
-}</span><span>
</span><span id="line-2097"></span><span>
</span><span id="line-2098"></span><span class="hs-keyword">data</span><span> </span><span id="UnifyEnv"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#UnifyEnv"><span class="hs-identifier hs-var">UnifyEnv</span></a></span></span><span>
</span><span id="line-2099"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="UE"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#UE"><span class="hs-identifier hs-var">UE</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="u_role"><span class="annot"><span class="annottext">UnifyEnv -&gt; Role
</span><a href="GHC.Tc.Utils.Unify.html#u_role"><span class="hs-identifier hs-var hs-var">u_role</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span>
</span><span id="line-2100"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="u_loc"><span class="annot"><span class="annottext">UnifyEnv -&gt; CtLoc
</span><a href="GHC.Tc.Utils.Unify.html#u_loc"><span class="hs-identifier hs-var hs-var">u_loc</span></a></span></span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.CtLoc.html#CtLoc"><span class="hs-identifier hs-type">CtLoc</span></a></span><span>
</span><span id="line-2101"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="u_rewriters"><span class="annot"><span class="annottext">UnifyEnv -&gt; RewriterSet
</span><a href="GHC.Tc.Utils.Unify.html#u_rewriters"><span class="hs-identifier hs-var hs-var">u_rewriters</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#RewriterSet"><span class="hs-identifier hs-type">RewriterSet</span></a></span><span>
</span><span id="line-2102"></span><span>
</span><span id="line-2103"></span><span>         </span><span class="hs-comment">-- Deferred constraints</span><span>
</span><span id="line-2104"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="u_defer"><span class="annot"><span class="annottext">UnifyEnv -&gt; TcRef (Bag Ct)
</span><a href="GHC.Tc.Utils.Unify.html#u_defer"><span class="hs-identifier hs-var hs-var">u_defer</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TcRef.html#TcRef"><span class="hs-identifier hs-type">TcRef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2105"></span><span>
</span><span id="line-2106"></span><span>         </span><span class="hs-comment">-- Which variables are unified;</span><span>
</span><span id="line-2107"></span><span>         </span><span class="hs-comment">-- if Nothing, we don't care</span><span>
</span><span id="line-2108"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="u_unified"><span class="annot"><span class="annottext">UnifyEnv -&gt; Maybe (TcRef [TcTyVar])
</span><a href="GHC.Tc.Utils.Unify.html#u_unified"><span class="hs-identifier hs-var hs-var">u_unified</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.TcRef.html#TcRef"><span class="hs-identifier hs-type">TcRef</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2109"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-2110"></span><span>
</span><span id="line-2111"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#setUEnvRole"><span class="hs-identifier hs-type">setUEnvRole</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#UnifyEnv"><span class="hs-identifier hs-type">UnifyEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#UnifyEnv"><span class="hs-identifier hs-type">UnifyEnv</span></a></span><span>
</span><span id="line-2112"></span><span id="setUEnvRole"><span class="annot"><span class="annottext">setUEnvRole :: UnifyEnv -&gt; Role -&gt; UnifyEnv
</span><a href="GHC.Tc.Utils.Unify.html#setUEnvRole"><span class="hs-identifier hs-var hs-var">setUEnvRole</span></a></span></span><span> </span><span id="local-6989586621683018833"><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683018833"><span class="hs-identifier hs-var">uenv</span></a></span></span><span> </span><span id="local-6989586621683018834"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683018834"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683018833"><span class="hs-identifier hs-var">uenv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#u_role"><span class="hs-identifier hs-var">u_role</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683018834"><span class="hs-keyword hs-type">role</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2113"></span><span>
</span><span id="line-2114"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#updUEnvLoc"><span class="hs-identifier hs-type">updUEnvLoc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#UnifyEnv"><span class="hs-identifier hs-type">UnifyEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.CtLoc.html#CtLoc"><span class="hs-identifier hs-type">CtLoc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.CtLoc.html#CtLoc"><span class="hs-identifier hs-type">CtLoc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#UnifyEnv"><span class="hs-identifier hs-type">UnifyEnv</span></a></span><span>
</span><span id="line-2115"></span><span id="updUEnvLoc"><span class="annot"><span class="annottext">updUEnvLoc :: UnifyEnv -&gt; (CtLoc -&gt; CtLoc) -&gt; UnifyEnv
</span><a href="GHC.Tc.Utils.Unify.html#updUEnvLoc"><span class="hs-identifier hs-var hs-var">updUEnvLoc</span></a></span></span><span> </span><span id="local-6989586621683018835"><span class="annot"><span class="annottext">uenv :: UnifyEnv
</span><a href="#local-6989586621683018835"><span class="hs-identifier hs-var">uenv</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#UE"><span class="hs-identifier hs-type">UE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">u_loc :: UnifyEnv -&gt; CtLoc
</span><a href="GHC.Tc.Utils.Unify.html#u_loc"><span class="hs-identifier hs-var">u_loc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683018836"><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683018836"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621683018837"><span class="annot"><span class="annottext">CtLoc -&gt; CtLoc
</span><a href="#local-6989586621683018837"><span class="hs-identifier hs-var">upd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683018835"><span class="hs-identifier hs-var">uenv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#u_loc"><span class="hs-identifier hs-var">u_loc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683018837"><span class="hs-identifier hs-type">upd</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018836"><span class="hs-identifier hs-type">loc</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2116"></span><span>
</span><span id="line-2117"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#mkKindEnv"><span class="hs-identifier hs-type">mkKindEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#UnifyEnv"><span class="hs-identifier hs-type">UnifyEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#UnifyEnv"><span class="hs-identifier hs-type">UnifyEnv</span></a></span><span>
</span><span id="line-2118"></span><span class="hs-comment">-- Modify the UnifyEnv to be right for unifing</span><span>
</span><span id="line-2119"></span><span class="hs-comment">-- the kinds of these two types</span><span>
</span><span id="line-2120"></span><span id="mkKindEnv"><span class="annot"><span class="annottext">mkKindEnv :: UnifyEnv -&gt; TcType -&gt; TcType -&gt; UnifyEnv
</span><a href="GHC.Tc.Utils.Unify.html#mkKindEnv"><span class="hs-identifier hs-var hs-var">mkKindEnv</span></a></span></span><span> </span><span id="local-6989586621683018839"><span class="annot"><span class="annottext">env :: UnifyEnv
</span><a href="#local-6989586621683018839"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#UE"><span class="hs-identifier hs-type">UE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">u_loc :: UnifyEnv -&gt; CtLoc
</span><a href="GHC.Tc.Utils.Unify.html#u_loc"><span class="hs-identifier hs-var">u_loc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683018840"><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683018840"><span class="hs-identifier hs-var">ctloc</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621683018841"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018841"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683018842"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018842"><span class="hs-identifier hs-var">ty2</span></a></span></span><span>
</span><span id="line-2121"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683018839"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#u_role"><span class="hs-identifier hs-var">u_role</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-type">Nominal</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#u_loc"><span class="hs-identifier hs-var">u_loc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.CtLoc.html#mkKindEqLoc"><span class="hs-identifier hs-type">mkKindEqLoc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018841"><span class="hs-identifier hs-type">ty1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018842"><span class="hs-identifier hs-type">ty2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018840"><span class="hs-identifier hs-type">ctloc</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2122"></span><span>
</span><span id="line-2123"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#uType"><span class="hs-identifier hs-type">uType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#uType_defer"><span class="hs-identifier hs-type">uType_defer</span></a></span><span>
</span><span id="line-2124"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#UnifyEnv"><span class="hs-identifier hs-type">UnifyEnv</span></a></span><span>
</span><span id="line-2125"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>    </span><span class="hs-comment">-- ty1 is the *actual* type</span><span>
</span><span id="line-2126"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>    </span><span class="hs-comment">-- ty2 is the *expected* type</span><span>
</span><span id="line-2127"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a></span><span>
</span><span id="line-2128"></span><span>
</span><span id="line-2129"></span><span class="hs-comment">-- It is always safe to defer unification to the main constraint solver</span><span>
</span><span id="line-2130"></span><span class="hs-comment">-- See Note [Deferred unification]</span><span>
</span><span id="line-2131"></span><span id="uType_defer"><span class="annot"><span class="annottext">uType_defer :: UnifyEnv -&gt; TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#uType_defer"><span class="hs-identifier hs-var hs-var">uType_defer</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#UE"><span class="hs-identifier hs-type">UE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">u_loc :: UnifyEnv -&gt; CtLoc
</span><a href="GHC.Tc.Utils.Unify.html#u_loc"><span class="hs-identifier hs-var">u_loc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683018844"><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683018844"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">u_defer :: UnifyEnv -&gt; TcRef (Bag Ct)
</span><a href="GHC.Tc.Utils.Unify.html#u_defer"><span class="hs-identifier hs-var">u_defer</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683018845"><span class="annot"><span class="annottext">TcRef (Bag Ct)
</span><a href="#local-6989586621683018845"><span class="hs-identifier hs-var">ref</span></a></span></span><span>
</span><span id="line-2132"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">u_role :: UnifyEnv -&gt; Role
</span><a href="GHC.Tc.Utils.Unify.html#u_role"><span class="hs-identifier hs-var">u_role</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683018846"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683018846"><span class="hs-keyword hs-var">role</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">u_rewriters :: UnifyEnv -&gt; RewriterSet
</span><a href="GHC.Tc.Utils.Unify.html#u_rewriters"><span class="hs-identifier hs-var">u_rewriters</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683018847"><span class="annot"><span class="annottext">RewriterSet
</span><a href="#local-6989586621683018847"><span class="hs-identifier hs-var">rewriters</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2133"></span><span>            </span><span id="local-6989586621683018848"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018848"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683018849"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018849"><span class="hs-identifier hs-var">ty2</span></a></span></span><span>  </span><span class="hs-comment">-- ty1 is &quot;actual&quot;, ty2 is &quot;expected&quot;</span><span>
</span><span id="line-2134"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683018850"><span class="annot"><span class="annottext">pred_ty :: TcType
</span><a href="#local-6989586621683018850"><span class="hs-identifier hs-var hs-var hs-var">pred_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role -&gt; TcType -&gt; TcType -&gt; TcType
</span><a href="GHC.Core.Coercion.html#mkPrimEqPredRole"><span class="hs-identifier hs-var">mkPrimEqPredRole</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683018846"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018848"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018849"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-2135"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018852"><span class="annot"><a href="#local-6989586621683018852"><span class="hs-identifier hs-var">hole</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; TcType -&gt; TcM CoercionHole
</span><a href="GHC.Tc.Utils.TcMType.html#newCoercionHole"><span class="hs-identifier hs-var">newCoercionHole</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683018844"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018850"><span class="hs-identifier hs-var">pred_ty</span></a></span><span>
</span><span id="line-2136"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683018854"><span class="annot"><a href="#local-6989586621683018854"><span class="hs-identifier hs-var hs-var">ct</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; Ct
</span><a href="GHC.Tc.Types.Constraint.html#mkNonCanonical"><span class="hs-identifier hs-var">mkNonCanonical</span></a></span><span> </span><span class="annot"><span class="annottext">(CtEvidence -&gt; Ct) -&gt; CtEvidence -&gt; Ct
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2137"></span><span>                  </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtWanted"><span class="hs-identifier hs-type">CtWanted</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ctev_pred :: TcType
</span><a href="GHC.Tc.Types.Constraint.html#ctev_pred"><span class="hs-identifier hs-var">ctev_pred</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018850"><span class="hs-identifier hs-var">pred_ty</span></a></span><span>
</span><span id="line-2138"></span><span>                           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ctev_dest :: TcEvDest
</span><a href="GHC.Tc.Types.Constraint.html#ctev_dest"><span class="hs-identifier hs-var">ctev_dest</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoercionHole -&gt; TcEvDest
</span><a href="GHC.Tc.Types.Constraint.html#HoleDest"><span class="hs-identifier hs-var">HoleDest</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionHole
</span><a href="#local-6989586621683018852"><span class="hs-identifier hs-var">hole</span></a></span><span>
</span><span id="line-2139"></span><span>                           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ctev_loc :: CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctev_loc"><span class="hs-identifier hs-var">ctev_loc</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683018844"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-2140"></span><span>                           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ctev_rewriters :: RewriterSet
</span><a href="GHC.Tc.Types.Constraint.html#ctev_rewriters"><span class="hs-identifier hs-var">ctev_rewriters</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RewriterSet
</span><a href="#local-6989586621683018847"><span class="hs-identifier hs-var">rewriters</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2141"></span><span>             </span><span id="local-6989586621683018862"><span class="annot"><a href="#local-6989586621683018862"><span class="hs-identifier hs-var hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoercionHole -&gt; Coercion
</span><a href="GHC.Core.TyCo.Rep.html#HoleCo"><span class="hs-identifier hs-var">HoleCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionHole
</span><a href="#local-6989586621683018852"><span class="hs-identifier hs-var">hole</span></a></span><span>
</span><span id="line-2142"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TcRef.html#updTcRef"><span class="hs-identifier hs-type">updTcRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018845"><span class="hs-identifier hs-type">ref</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">`snocBag`</span></span><span> </span><span class="annot"><span class="hs-identifier">ct</span></span><span class="hs-special">)</span><span>
</span><span id="line-2143"></span><span>         </span><span class="hs-comment">-- snocBag: see Note [Work-list ordering] in GHC.Tc.Solver.Equality</span><span>
</span><span id="line-2144"></span><span>
</span><span id="line-2145"></span><span>       </span><span class="hs-comment">-- Error trace only</span><span>
</span><span id="line-2146"></span><span>       </span><span class="hs-comment">-- NB. do *not* call mkErrInfo unless tracing is on,</span><span>
</span><span id="line-2147"></span><span>       </span><span class="hs-comment">--     because it is hugely expensive (#5631)</span><span>
</span><span id="line-2148"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#whenDOptM"><span class="hs-identifier hs-type">whenDOptM</span></a></span><span> </span><span class="annot"><a href="GHC.Driver.Flags.html#Opt_D_dump_tc_trace"><span class="hs-identifier hs-type">Opt_D_dump_tc_trace</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-2149"></span><span>         </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018868"><span class="annot"><a href="#local-6989586621683018868"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#getErrCtxt"><span class="hs-identifier hs-type">getErrCtxt</span></a></span><span>
</span><span id="line-2150"></span><span>            </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018870"><span class="annot"><a href="#local-6989586621683018870"><span class="hs-identifier hs-var">doc</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#mkErrInfo"><span class="hs-identifier hs-type">mkErrInfo</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#emptyTidyEnv"><span class="hs-identifier hs-type">emptyTidyEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018868"><span class="hs-identifier hs-type">ctxt</span></a></span><span>
</span><span id="line-2151"></span><span>            </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;utype_defer&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-type">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018846"><span class="hs-keyword hs-type">role</span></a></span><span>
</span><span id="line-2152"></span><span>                                          </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Ppr.html#debugPprType"><span class="hs-identifier hs-type">debugPprType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018848"><span class="hs-identifier hs-type">ty1</span></a></span><span>
</span><span id="line-2153"></span><span>                                          </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Ppr.html#debugPprType"><span class="hs-identifier hs-type">debugPprType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018849"><span class="hs-identifier hs-type">ty2</span></a></span><span>
</span><span id="line-2154"></span><span>                                          </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683018870"><span class="hs-identifier hs-type">doc</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2155"></span><span>            </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;utype_defer2&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018862"><span class="hs-identifier hs-type">co</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2156"></span><span>
</span><span id="line-2157"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683018862"><span class="hs-identifier hs-type">co</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2158"></span><span>
</span><span id="line-2159"></span><span>
</span><span id="line-2160"></span><span class="hs-comment">--------------</span><span>
</span><span id="line-2161"></span><span id="uType"><span class="annot"><span class="annottext">uType :: UnifyEnv -&gt; TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#uType"><span class="hs-identifier hs-var hs-var">uType</span></a></span></span><span> </span><span id="local-6989586621683018873"><span class="annot"><span class="annottext">env :: UnifyEnv
</span><a href="#local-6989586621683018873"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#UE"><span class="hs-identifier hs-type">UE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">u_role :: UnifyEnv -&gt; Role
</span><a href="GHC.Tc.Utils.Unify.html#u_role"><span class="hs-identifier hs-var">u_role</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683018874"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683018874"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621683018875"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018875"><span class="hs-identifier hs-var">orig_ty1</span></a></span></span><span> </span><span id="local-6989586621683018876"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018876"><span class="hs-identifier hs-var">orig_ty2</span></a></span></span><span>
</span><span id="line-2162"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Phantom"><span class="hs-identifier hs-var">Phantom</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683018874"><span class="hs-keyword hs-var">role</span></a></span><span>
</span><span id="line-2163"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018878"><span class="annot"><a href="#local-6989586621683018878"><span class="hs-identifier hs-var">kind_co</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UnifyEnv -&gt; TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#uType"><span class="hs-identifier hs-var">uType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UnifyEnv -&gt; TcType -&gt; TcType -&gt; UnifyEnv
</span><a href="GHC.Tc.Utils.Unify.html#mkKindEnv"><span class="hs-identifier hs-var">mkKindEnv</span></a></span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683018873"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018875"><span class="hs-identifier hs-var">orig_ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018876"><span class="hs-identifier hs-var">orig_ty2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2164"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; TcType -&gt; TcType
TcType -&gt; TcType
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018875"><span class="hs-identifier hs-var">orig_ty1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; TcType -&gt; TcType
TcType -&gt; TcType
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018876"><span class="hs-identifier hs-var">orig_ty2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2165"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.html#mkPhantomCo"><span class="hs-identifier hs-type">mkPhantomCo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018878"><span class="hs-identifier hs-type">kind_co</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018875"><span class="hs-identifier hs-type">orig_ty1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018876"><span class="hs-identifier hs-type">orig_ty2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2166"></span><span>
</span><span id="line-2167"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2168"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018880"><span class="annot"><a href="#local-6989586621683018880"><span class="hs-identifier hs-var">tclvl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM TcLevel
</span><a href="GHC.Tc.Utils.Monad.html#getTcLevel"><span class="hs-identifier hs-var">getTcLevel</span></a></span><span>
</span><span id="line-2169"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;u_tys&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-type">vcat</span></a></span><span>
</span><span id="line-2170"></span><span>              </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;tclvl&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018880"><span class="hs-identifier hs-type">tclvl</span></a></span><span>
</span><span id="line-2171"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#sep"><span class="hs-identifier hs-type">sep</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018875"><span class="hs-identifier hs-type">orig_ty1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;~&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-type">&lt;&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018874"><span class="hs-keyword hs-type">role</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018876"><span class="hs-identifier hs-type">orig_ty2</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-2172"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018881"><span class="annot"><a href="#local-6989586621683018881"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621683018882"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018875"><span class="hs-identifier hs-type">orig_ty1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018876"><span class="hs-identifier hs-type">orig_ty2</span></a></span><span>
</span><span id="line-2173"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#isReflCo"><span class="hs-identifier hs-type">isReflCo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018881"><span class="hs-identifier hs-type">co</span></a></span><span>
</span><span id="line-2174"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;u_tys yields no coercion&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#empty"><span class="hs-identifier hs-type">Outputable.empty</span></a></span><span>
</span><span id="line-2175"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;u_tys yields coercion:&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018881"><span class="hs-identifier hs-type">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2176"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683018881"><span class="hs-identifier hs-type">co</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2177"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2178"></span><span>    </span><span class="annot"><a href="#local-6989586621683018882"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a></span><span>
</span><span id="line-2179"></span><span>        </span><span class="hs-comment">-- The arguments to 'go' are always semantically identical</span><span>
</span><span id="line-2180"></span><span>        </span><span class="hs-comment">-- to orig_ty{1,2} except for looking through type synonyms</span><span>
</span><span id="line-2181"></span><span>
</span><span id="line-2182"></span><span>     </span><span class="hs-comment">-- Unwrap casts before looking for variables. This way, we can easily</span><span>
</span><span id="line-2183"></span><span>     </span><span class="hs-comment">-- recognize (t |&gt; co) ~ (t |&gt; co), which is nice. Previously, we</span><span>
</span><span id="line-2184"></span><span>     </span><span class="hs-comment">-- didn't do it this way, and then the unification above was deferred.</span><span>
</span><span id="line-2185"></span><span>    </span><span id="local-6989586621683018882"><span class="annot"><span class="annottext">go :: TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="#local-6989586621683018882"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CastTy"><span class="hs-identifier hs-type">CastTy</span></a></span><span> </span><span id="local-6989586621683018885"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018885"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621683018886"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683018886"><span class="hs-identifier hs-var">co1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621683018887"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018887"><span class="hs-identifier hs-var">t2</span></a></span></span><span>
</span><span id="line-2186"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018888"><span class="annot"><a href="#local-6989586621683018888"><span class="hs-identifier hs-var">co_tys</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UnifyEnv -&gt; TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#uType"><span class="hs-identifier hs-var">uType</span></a></span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683018873"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018885"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018887"><span class="hs-identifier hs-var">t2</span></a></span><span>
</span><span id="line-2187"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.html#mkCoherenceLeftCo"><span class="hs-identifier hs-type">mkCoherenceLeftCo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018874"><span class="hs-keyword hs-type">role</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018885"><span class="hs-identifier hs-type">t1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018886"><span class="hs-identifier hs-type">co1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018888"><span class="hs-identifier hs-type">co_tys</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2188"></span><span>
</span><span id="line-2189"></span><span>    </span><span class="annot"><a href="#local-6989586621683018882"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683018890"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018890"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CastTy"><span class="hs-identifier hs-type">CastTy</span></a></span><span> </span><span id="local-6989586621683018891"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018891"><span class="hs-identifier hs-var">t2</span></a></span></span><span> </span><span id="local-6989586621683018892"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683018892"><span class="hs-identifier hs-var">co2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2190"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018893"><span class="annot"><a href="#local-6989586621683018893"><span class="hs-identifier hs-var">co_tys</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UnifyEnv -&gt; TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#uType"><span class="hs-identifier hs-var">uType</span></a></span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683018873"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018890"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018891"><span class="hs-identifier hs-var">t2</span></a></span><span>
</span><span id="line-2191"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.html#mkCoherenceRightCo"><span class="hs-identifier hs-type">mkCoherenceRightCo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018874"><span class="hs-keyword hs-type">role</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018891"><span class="hs-identifier hs-type">t2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018892"><span class="hs-identifier hs-type">co2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018893"><span class="hs-identifier hs-type">co_tys</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2192"></span><span>
</span><span id="line-2193"></span><span>        </span><span class="hs-comment">-- Variables; go for uUnfilledVar</span><span>
</span><span id="line-2194"></span><span>        </span><span class="hs-comment">-- Note that we pass in *original* (before synonym expansion),</span><span>
</span><span id="line-2195"></span><span>        </span><span class="hs-comment">-- so that type variables tend to get filled in with</span><span>
</span><span id="line-2196"></span><span>        </span><span class="hs-comment">-- the most informative version of the type</span><span>
</span><span id="line-2197"></span><span>    </span><span class="annot"><a href="#local-6989586621683018882"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyVarTy"><span class="hs-identifier hs-type">TyVarTy</span></a></span><span> </span><span id="local-6989586621683018895"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683018895"><span class="hs-identifier hs-var">tv1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621683018896"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018896"><span class="hs-identifier hs-var">ty2</span></a></span></span><span>
</span><span id="line-2198"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018897"><span class="annot"><a href="#local-6989586621683018897"><span class="hs-identifier hs-var">lookup_res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; IOEnv (Env TcGblEnv TcLclEnv) (Maybe TcType)
</span><a href="GHC.Tc.Utils.TcMType.html#isFilledMetaTyVar_maybe"><span class="hs-identifier hs-var">isFilledMetaTyVar_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683018895"><span class="hs-identifier hs-var">tv1</span></a></span><span>
</span><span id="line-2199"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683018897"><span class="hs-identifier hs-type">lookup_res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2200"></span><span>               </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683018898"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018898"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;found filled tyvar&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683018895"><span class="hs-identifier hs-var">tv1</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;:-&gt;&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018898"><span class="hs-identifier hs-var">ty1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2201"></span><span>                              </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">UnifyEnv -&gt; TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#uType"><span class="hs-identifier hs-var">uType</span></a></span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683018873"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018898"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018876"><span class="hs-identifier hs-var">orig_ty2</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2202"></span><span>               </span><span class="annot"><span class="annottext">Maybe TcType
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UnifyEnv -&gt; SwapFlag -&gt; TcTyVar -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#uUnfilledVar"><span class="hs-identifier hs-var">uUnfilledVar</span></a></span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683018873"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#NotSwapped"><span class="hs-identifier hs-var">NotSwapped</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683018895"><span class="hs-identifier hs-var">tv1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018896"><span class="hs-identifier hs-var">ty2</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2203"></span><span>
</span><span id="line-2204"></span><span>    </span><span class="annot"><a href="#local-6989586621683018882"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683018901"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018901"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyVarTy"><span class="hs-identifier hs-type">TyVarTy</span></a></span><span> </span><span id="local-6989586621683018902"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683018902"><span class="hs-identifier hs-var">tv2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2205"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018903"><span class="annot"><a href="#local-6989586621683018903"><span class="hs-identifier hs-var">lookup_res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; IOEnv (Env TcGblEnv TcLclEnv) (Maybe TcType)
</span><a href="GHC.Tc.Utils.TcMType.html#isFilledMetaTyVar_maybe"><span class="hs-identifier hs-var">isFilledMetaTyVar_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683018902"><span class="hs-identifier hs-var">tv2</span></a></span><span>
</span><span id="line-2206"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683018903"><span class="hs-identifier hs-type">lookup_res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2207"></span><span>               </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683018904"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018904"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;found filled tyvar&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683018902"><span class="hs-identifier hs-var">tv2</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;:-&gt;&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018904"><span class="hs-identifier hs-var">ty2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2208"></span><span>                              </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">UnifyEnv -&gt; TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#uType"><span class="hs-identifier hs-var">uType</span></a></span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683018873"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018875"><span class="hs-identifier hs-var">orig_ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018904"><span class="hs-identifier hs-var">ty2</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2209"></span><span>               </span><span class="annot"><span class="annottext">Maybe TcType
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UnifyEnv -&gt; SwapFlag -&gt; TcTyVar -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#uUnfilledVar"><span class="hs-identifier hs-var">uUnfilledVar</span></a></span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683018873"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#IsSwapped"><span class="hs-identifier hs-var">IsSwapped</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683018902"><span class="hs-identifier hs-var">tv2</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018901"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2210"></span><span>
</span><span id="line-2211"></span><span>      </span><span class="hs-comment">-- See Note [Unifying type synonyms] in GHC.Core.Unify</span><span>
</span><span id="line-2212"></span><span>    </span><span class="annot"><a href="#local-6989586621683018882"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683018906"><span class="annot"><span class="annottext">ty1 :: TcType
</span><a href="#local-6989586621683018906"><span class="hs-identifier hs-var">ty1</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyConApp"><span class="hs-identifier hs-type">TyConApp</span></a></span><span> </span><span id="local-6989586621683018907"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018907"><span class="hs-identifier hs-var">tc1</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyConApp"><span class="hs-identifier hs-type">TyConApp</span></a></span><span> </span><span id="local-6989586621683018908"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018908"><span class="hs-identifier hs-var">tc2</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2213"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018907"><span class="hs-identifier hs-var">tc1</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; TyCon -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018908"><span class="hs-identifier hs-var">tc2</span></a></span><span>
</span><span id="line-2214"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; TcM Coercion
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; TcM Coercion) -&gt; Coercion -&gt; TcM Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Role -&gt; TcType -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683018874"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018906"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-2215"></span><span>
</span><span id="line-2216"></span><span>        </span><span class="hs-comment">-- Now expand synonyms</span><span>
</span><span id="line-2217"></span><span>        </span><span class="hs-comment">-- See Note [Expanding synonyms during unification]</span><span>
</span><span id="line-2218"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-2219"></span><span>        </span><span class="hs-comment">-- Also NB that we recurse to 'go' so that we don't push a</span><span>
</span><span id="line-2220"></span><span>        </span><span class="hs-comment">-- new item on the origin stack. As a result if we have</span><span>
</span><span id="line-2221"></span><span>        </span><span class="hs-comment">--   type Foo = Int</span><span>
</span><span id="line-2222"></span><span>        </span><span class="hs-comment">-- and we try to unify  Foo ~ Bool</span><span>
</span><span id="line-2223"></span><span>        </span><span class="hs-comment">-- we'll end up saying &quot;can't match Foo with Bool&quot;</span><span>
</span><span id="line-2224"></span><span>        </span><span class="hs-comment">-- rather than &quot;can't match &quot;Int with Bool&quot;.  See #4535.</span><span>
</span><span id="line-2225"></span><span>    </span><span class="annot"><a href="#local-6989586621683018882"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683018910"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018910"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683018911"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018911"><span class="hs-identifier hs-var">ty2</span></a></span></span><span>
</span><span id="line-2226"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683018912"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018912"><span class="hs-identifier hs-var">ty1'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe TcType
</span><a href="GHC.Core.Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018910"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="#local-6989586621683018882"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018912"><span class="hs-identifier hs-var">ty1'</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018911"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-2227"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683018913"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018913"><span class="hs-identifier hs-var">ty2'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe TcType
</span><a href="GHC.Core.Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018911"><span class="hs-identifier hs-var">ty2</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="#local-6989586621683018882"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018910"><span class="hs-identifier hs-var">ty1</span></a></span><span>  </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018913"><span class="hs-identifier hs-var">ty2'</span></a></span><span>
</span><span id="line-2228"></span><span>
</span><span id="line-2229"></span><span>    </span><span class="hs-comment">-- Functions (t1 -&gt; t2) just check the two parts</span><span>
</span><span id="line-2230"></span><span>    </span><span class="annot"><a href="#local-6989586621683018882"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#FunTy"><span class="hs-identifier hs-type">FunTy</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ft_af :: TcType -&gt; FunTyFlag
</span><a href="GHC.Core.TyCo.Rep.html#ft_af"><span class="hs-identifier hs-var">ft_af</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683018914"><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683018914"><span class="hs-identifier hs-var">af1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_mult :: TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#ft_mult"><span class="hs-identifier hs-var">ft_mult</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683018915"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018915"><span class="hs-identifier hs-var">w1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_arg :: TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#ft_arg"><span class="hs-identifier hs-var">ft_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683018916"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018916"><span class="hs-identifier hs-var">arg1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_res :: TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#ft_res"><span class="hs-identifier hs-var">ft_res</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683018917"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018917"><span class="hs-identifier hs-var">res1</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2231"></span><span>       </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#FunTy"><span class="hs-identifier hs-type">FunTy</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ft_af :: TcType -&gt; FunTyFlag
</span><a href="GHC.Core.TyCo.Rep.html#ft_af"><span class="hs-identifier hs-var">ft_af</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683018918"><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683018918"><span class="hs-identifier hs-var">af2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_mult :: TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#ft_mult"><span class="hs-identifier hs-var">ft_mult</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683018919"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018919"><span class="hs-identifier hs-var">w2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_arg :: TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#ft_arg"><span class="hs-identifier hs-var">ft_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683018920"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018920"><span class="hs-identifier hs-var">arg2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_res :: TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#ft_res"><span class="hs-identifier hs-var">ft_res</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683018921"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018921"><span class="hs-identifier hs-var">res2</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2232"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">FunTyFlag -&gt; Bool
</span><a href="GHC.Types.Var.html#isVisibleFunArg"><span class="hs-identifier hs-var">isVisibleFunArg</span></a></span><span> </span><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683018914"><span class="hs-identifier hs-var">af1</span></a></span><span>  </span><span class="hs-comment">-- Do not attempt (c =&gt; t); just defer</span><span>
</span><span id="line-2233"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683018914"><span class="hs-identifier hs-var">af1</span></a></span><span> </span><span class="annot"><span class="annottext">FunTyFlag -&gt; FunTyFlag -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683018918"><span class="hs-identifier hs-var">af2</span></a></span><span>           </span><span class="hs-comment">-- Important!  See #21530</span><span>
</span><span id="line-2234"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018922"><span class="annot"><a href="#local-6989586621683018922"><span class="hs-identifier hs-var">co_w</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UnifyEnv -&gt; TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#uType"><span class="hs-identifier hs-var">uType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683018873"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#u_role"><span class="hs-identifier hs-var">u_role</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#funRole"><span class="hs-identifier hs-type">funRole</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018874"><span class="hs-keyword hs-type">role</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#SelMult"><span class="hs-identifier hs-type">SelMult</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018915"><span class="hs-identifier hs-var">w1</span></a></span><span>   </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018919"><span class="hs-identifier hs-var">w2</span></a></span><span>
</span><span id="line-2235"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018925"><span class="annot"><a href="#local-6989586621683018925"><span class="hs-identifier hs-var">co_l</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#uType"><span class="hs-identifier hs-type">uType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683018873"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#u_role"><span class="hs-identifier hs-var">u_role</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#funRole"><span class="hs-identifier hs-type">funRole</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018874"><span class="hs-keyword hs-type">role</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#SelArg"><span class="hs-identifier hs-type">SelArg</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="annot"><a href="#local-6989586621683018916"><span class="hs-identifier hs-type">arg1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018920"><span class="hs-identifier hs-type">arg2</span></a></span><span>
</span><span id="line-2236"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018927"><span class="annot"><a href="#local-6989586621683018927"><span class="hs-identifier hs-var">co_r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#uType"><span class="hs-identifier hs-type">uType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683018873"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#u_role"><span class="hs-identifier hs-var">u_role</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#funRole"><span class="hs-identifier hs-type">funRole</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018874"><span class="hs-keyword hs-type">role</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#SelRes"><span class="hs-identifier hs-type">SelRes</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="annot"><a href="#local-6989586621683018917"><span class="hs-identifier hs-type">res1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018921"><span class="hs-identifier hs-type">res2</span></a></span><span>
</span><span id="line-2237"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#mkNakedFunCo"><span class="hs-identifier hs-type">mkNakedFunCo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018874"><span class="hs-keyword hs-type">role</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018914"><span class="hs-identifier hs-type">af1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018922"><span class="hs-identifier hs-type">co_w</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018925"><span class="hs-identifier hs-type">co_l</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018927"><span class="hs-identifier hs-type">co_r</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2238"></span><span>
</span><span id="line-2239"></span><span>        </span><span class="hs-comment">-- Always defer if a type synonym family (type function)</span><span>
</span><span id="line-2240"></span><span>        </span><span class="hs-comment">-- is involved.  (Data families behave rigidly.)</span><span>
</span><span id="line-2241"></span><span>    </span><span class="annot"><a href="#local-6989586621683018882"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683018930"><span class="annot"><span class="annottext">ty1 :: TcType
</span><a href="#local-6989586621683018930"><span class="hs-identifier hs-var">ty1</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyConApp"><span class="hs-identifier hs-type">TyConApp</span></a></span><span> </span><span id="local-6989586621683018931"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018931"><span class="hs-identifier hs-var">tc1</span></a></span></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621683018932"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018932"><span class="hs-identifier hs-var">ty2</span></a></span></span><span>
</span><span id="line-2242"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isTypeFamilyTyCon"><span class="hs-identifier hs-var">isTypeFamilyTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018931"><span class="hs-identifier hs-var">tc1</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="#local-6989586621683018934"><span class="hs-identifier hs-var">defer</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018930"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018932"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-2243"></span><span>    </span><span class="annot"><a href="#local-6989586621683018882"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683018935"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018935"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683018936"><span class="annot"><span class="annottext">ty2 :: TcType
</span><a href="#local-6989586621683018936"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyConApp"><span class="hs-identifier hs-type">TyConApp</span></a></span><span> </span><span id="local-6989586621683018937"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018937"><span class="hs-identifier hs-var">tc2</span></a></span></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-2244"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isTypeFamilyTyCon"><span class="hs-identifier hs-var">isTypeFamilyTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018937"><span class="hs-identifier hs-var">tc2</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="#local-6989586621683018934"><span class="hs-identifier hs-var">defer</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018935"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018936"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-2245"></span><span>
</span><span id="line-2246"></span><span>    </span><span class="annot"><a href="#local-6989586621683018882"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyConApp"><span class="hs-identifier hs-type">TyConApp</span></a></span><span> </span><span id="local-6989586621683018938"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018938"><span class="hs-identifier hs-var">tc1</span></a></span></span><span> </span><span id="local-6989586621683018939"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683018939"><span class="hs-identifier hs-var">tys1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyConApp"><span class="hs-identifier hs-type">TyConApp</span></a></span><span> </span><span id="local-6989586621683018940"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018940"><span class="hs-identifier hs-var">tc2</span></a></span></span><span> </span><span id="local-6989586621683018941"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683018941"><span class="hs-identifier hs-var">tys2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2247"></span><span>      </span><span class="hs-comment">-- See Note [Mismatched type lists and application decomposition]</span><span>
</span><span id="line-2248"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018938"><span class="hs-identifier hs-var">tc1</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; TyCon -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018940"><span class="hs-identifier hs-var">tc2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; [TcType] -&gt; Bool
forall a b. [a] -&gt; [b] -&gt; Bool
</span><a href="GHC.Utils.Misc.html#equalLength"><span class="hs-identifier hs-var">equalLength</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683018939"><span class="hs-identifier hs-var">tys1</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683018941"><span class="hs-identifier hs-var">tys2</span></a></span><span>
</span><span id="line-2249"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Role -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isInjectiveTyCon"><span class="hs-identifier hs-var">isInjectiveTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018938"><span class="hs-identifier hs-var">tc1</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683018874"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="hs-comment">-- don't look under newtypes at Rep equality</span><span>
</span><span id="line-2250"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; TcM Coercion -&gt; TcM Coercion
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Role -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isGenerativeTyCon"><span class="hs-identifier hs-var">isGenerativeTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018938"><span class="hs-identifier hs-var">tc1</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683018874"><span class="hs-keyword hs-var">role</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018938"><span class="hs-identifier hs-var">tc1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcM Coercion -&gt; TcM Coercion) -&gt; TcM Coercion -&gt; TcM Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2251"></span><span>        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;go-tycon&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018938"><span class="hs-identifier hs-var">tc1</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683018939"><span class="hs-identifier hs-var">tys1</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683018941"><span class="hs-identifier hs-var">tys2</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">[Role] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; [Role] -&gt; [Role]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">10</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; TyCon -&gt; [Role]
</span><a href="GHC.Core.Coercion.html#tyConRoleListX"><span class="hs-identifier hs-var">tyConRoleListX</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683018874"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018938"><span class="hs-identifier hs-var">tc1</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2252"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683018947"><span class="annot"><a href="#local-6989586621683018947"><span class="hs-identifier hs-var">cos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Role -&gt; TcType -&gt; TcType -&gt; TcM Coercion)
-&gt; [Bool]
-&gt; [Role]
-&gt; [TcType]
-&gt; [TcType]
-&gt; TcM MultiplicityCheckCoercions
forall (m :: * -&gt; *) a b c d e.
Monad m =&gt;
(a -&gt; b -&gt; c -&gt; d -&gt; m e) -&gt; [a] -&gt; [b] -&gt; [c] -&gt; [d] -&gt; m [e]
</span><a href="GHC.Utils.Monad.html#zipWith4M"><span class="hs-identifier hs-var">zipWith4M</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Role -&gt; TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="#local-6989586621683018949"><span class="hs-identifier hs-var">u_tc_arg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [Bool]
</span><a href="GHC.Tc.Utils.TcType.html#tyConVisibilities"><span class="hs-identifier hs-var">tyConVisibilities</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018938"><span class="hs-identifier hs-var">tc1</span></a></span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- Infinite</span><span>
</span><span id="line-2253"></span><span>                                       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; TyCon -&gt; [Role]
</span><a href="GHC.Core.Coercion.html#tyConRoleListX"><span class="hs-identifier hs-var">tyConRoleListX</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683018874"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018938"><span class="hs-identifier hs-var">tc1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Infinite</span><span>
</span><span id="line-2254"></span><span>                                       </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683018939"><span class="hs-identifier hs-var">tys1</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683018941"><span class="hs-identifier hs-var">tys2</span></a></span><span>
</span><span id="line-2255"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-type">mkTyConAppCo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018874"><span class="hs-keyword hs-type">role</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018938"><span class="hs-identifier hs-type">tc1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018947"><span class="hs-identifier hs-type">cos</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2256"></span><span>
</span><span id="line-2257"></span><span>    </span><span class="annot"><a href="#local-6989586621683018882"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#LitTy"><span class="hs-identifier hs-type">LitTy</span></a></span><span> </span><span id="local-6989586621683018953"><span class="annot"><span class="annottext">TyLit
</span><a href="#local-6989586621683018953"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621683018954"><span class="annot"><span class="annottext">ty :: TcType
</span><a href="#local-6989586621683018954"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#LitTy"><span class="hs-identifier hs-type">LitTy</span></a></span><span> </span><span id="local-6989586621683018955"><span class="annot"><span class="annottext">TyLit
</span><a href="#local-6989586621683018955"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2258"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyLit
</span><a href="#local-6989586621683018953"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">TyLit -&gt; TyLit -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TyLit
</span><a href="#local-6989586621683018955"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-2259"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; TcM Coercion
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; TcM Coercion) -&gt; Coercion -&gt; TcM Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Role -&gt; TcType -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683018874"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018954"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2260"></span><span>
</span><span id="line-2261"></span><span>        </span><span class="hs-comment">-- See Note [Care with type applications]</span><span>
</span><span id="line-2262"></span><span>        </span><span class="hs-comment">-- Do not decompose FunTy against App;</span><span>
</span><span id="line-2263"></span><span>        </span><span class="hs-comment">-- it's often a type error, so leave it for the constraint solver</span><span>
</span><span id="line-2264"></span><span>    </span><span class="annot"><a href="#local-6989586621683018882"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683018956"><span class="annot"><span class="annottext">ty1 :: TcType
</span><a href="#local-6989586621683018956"><span class="hs-identifier hs-var">ty1</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#AppTy"><span class="hs-identifier hs-type">AppTy</span></a></span><span> </span><span id="local-6989586621683018958"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018958"><span class="hs-identifier hs-var">s1</span></a></span></span><span> </span><span id="local-6989586621683018959"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018959"><span class="hs-identifier hs-var">t1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621683018960"><span class="annot"><span class="annottext">ty2 :: TcType
</span><a href="#local-6989586621683018960"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#AppTy"><span class="hs-identifier hs-type">AppTy</span></a></span><span> </span><span id="local-6989586621683018961"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018961"><span class="hs-identifier hs-var">s2</span></a></span></span><span> </span><span id="local-6989586621683018962"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018962"><span class="hs-identifier hs-var">t2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2265"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcM Coercion
</span><a href="#local-6989586621683018963"><span class="hs-identifier hs-var">go_app</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isNextArgVisible"><span class="hs-identifier hs-var">isNextArgVisible</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018958"><span class="hs-identifier hs-var">s1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018956"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018958"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018959"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018960"><span class="hs-identifier hs-var">ty2</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018961"><span class="hs-identifier hs-var">s2</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018962"><span class="hs-identifier hs-var">t2</span></a></span><span>
</span><span id="line-2266"></span><span>
</span><span id="line-2267"></span><span>    </span><span class="annot"><a href="#local-6989586621683018882"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683018965"><span class="annot"><span class="annottext">ty1 :: TcType
</span><a href="#local-6989586621683018965"><span class="hs-identifier hs-var">ty1</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#AppTy"><span class="hs-identifier hs-type">AppTy</span></a></span><span> </span><span id="local-6989586621683018966"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018966"><span class="hs-identifier hs-var">s1</span></a></span></span><span> </span><span id="local-6989586621683018967"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018967"><span class="hs-identifier hs-var">t1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621683018968"><span class="annot"><span class="annottext">ty2 :: TcType
</span><a href="#local-6989586621683018968"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyConApp"><span class="hs-identifier hs-type">TyConApp</span></a></span><span> </span><span id="local-6989586621683018969"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018969"><span class="hs-identifier hs-var">tc2</span></a></span></span><span> </span><span id="local-6989586621683018970"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683018970"><span class="hs-identifier hs-var">ts2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2268"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018971"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683018971"><span class="hs-identifier hs-var">ts2'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018972"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018972"><span class="hs-identifier hs-var">t2'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; Maybe ([TcType], TcType)
forall a. [a] -&gt; Maybe ([a], a)
</span><a href="GHC.Utils.Misc.html#snocView"><span class="hs-identifier hs-var">snocView</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683018970"><span class="hs-identifier hs-var">ts2</span></a></span><span>
</span><span id="line-2269"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcM Coercion -&gt; TcM Coercion
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#tyConMustBeSaturated"><span class="hs-identifier hs-var">tyConMustBeSaturated</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018969"><span class="hs-identifier hs-var">tc2</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcM Coercion -&gt; TcM Coercion) -&gt; TcM Coercion -&gt; TcM Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2270"></span><span>        </span><span class="annot"><span class="annottext">Bool
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcM Coercion
</span><a href="#local-6989586621683018963"><span class="hs-identifier hs-var">go_app</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [TcType] -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isNextTyConArgVisible"><span class="hs-identifier hs-var">isNextTyConArgVisible</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018969"><span class="hs-identifier hs-var">tc2</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683018971"><span class="hs-identifier hs-var">ts2'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2271"></span><span>               </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018965"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018966"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018967"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018968"><span class="hs-identifier hs-var">ty2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [TcType] -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018969"><span class="hs-identifier hs-var">tc2</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683018971"><span class="hs-identifier hs-var">ts2'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018972"><span class="hs-identifier hs-var">t2'</span></a></span><span>
</span><span id="line-2272"></span><span>
</span><span id="line-2273"></span><span>    </span><span class="annot"><a href="#local-6989586621683018882"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683018976"><span class="annot"><span class="annottext">ty1 :: TcType
</span><a href="#local-6989586621683018976"><span class="hs-identifier hs-var">ty1</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyConApp"><span class="hs-identifier hs-type">TyConApp</span></a></span><span> </span><span id="local-6989586621683018977"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018977"><span class="hs-identifier hs-var">tc1</span></a></span></span><span> </span><span id="local-6989586621683018978"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683018978"><span class="hs-identifier hs-var">ts1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621683018979"><span class="annot"><span class="annottext">ty2 :: TcType
</span><a href="#local-6989586621683018979"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#AppTy"><span class="hs-identifier hs-type">AppTy</span></a></span><span> </span><span id="local-6989586621683018980"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018980"><span class="hs-identifier hs-var">s2</span></a></span></span><span> </span><span id="local-6989586621683018981"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018981"><span class="hs-identifier hs-var">t2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2274"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683018982"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683018982"><span class="hs-identifier hs-var">ts1'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683018983"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018983"><span class="hs-identifier hs-var">t1'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; Maybe ([TcType], TcType)
forall a. [a] -&gt; Maybe ([a], a)
</span><a href="GHC.Utils.Misc.html#snocView"><span class="hs-identifier hs-var">snocView</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683018978"><span class="hs-identifier hs-var">ts1</span></a></span><span>
</span><span id="line-2275"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcM Coercion -&gt; TcM Coercion
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#tyConMustBeSaturated"><span class="hs-identifier hs-var">tyConMustBeSaturated</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018977"><span class="hs-identifier hs-var">tc1</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcM Coercion -&gt; TcM Coercion) -&gt; TcM Coercion -&gt; TcM Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2276"></span><span>        </span><span class="annot"><span class="annottext">Bool
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcM Coercion
</span><a href="#local-6989586621683018963"><span class="hs-identifier hs-var">go_app</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [TcType] -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isNextTyConArgVisible"><span class="hs-identifier hs-var">isNextTyConArgVisible</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018977"><span class="hs-identifier hs-var">tc1</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683018982"><span class="hs-identifier hs-var">ts1'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2277"></span><span>               </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018976"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [TcType] -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683018977"><span class="hs-identifier hs-var">tc1</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683018982"><span class="hs-identifier hs-var">ts1'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018983"><span class="hs-identifier hs-var">t1'</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018979"><span class="hs-identifier hs-var">ty2</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018980"><span class="hs-identifier hs-var">s2</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018981"><span class="hs-identifier hs-var">t2</span></a></span><span>
</span><span id="line-2278"></span><span>
</span><span id="line-2279"></span><span>    </span><span class="annot"><a href="#local-6989586621683018882"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683018984"><span class="annot"><span class="annottext">ty1 :: TcType
</span><a href="#local-6989586621683018984"><span class="hs-identifier hs-var">ty1</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionTy"><span class="hs-identifier hs-type">CoercionTy</span></a></span><span> </span><span id="local-6989586621683018986"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683018986"><span class="hs-identifier hs-var">co1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621683018987"><span class="annot"><span class="annottext">ty2 :: TcType
</span><a href="#local-6989586621683018987"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionTy"><span class="hs-identifier hs-type">CoercionTy</span></a></span><span> </span><span id="local-6989586621683018988"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683018988"><span class="hs-identifier hs-var">co2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2280"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683018989"><span class="annot"><a href="#local-6989586621683018989"><span class="hs-identifier hs-var">kco</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UnifyEnv -&gt; TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#uType"><span class="hs-identifier hs-var">uType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UnifyEnv -&gt; TcType -&gt; TcType -&gt; UnifyEnv
</span><a href="GHC.Tc.Utils.Unify.html#mkKindEnv"><span class="hs-identifier hs-var">mkKindEnv</span></a></span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683018873"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018984"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018987"><span class="hs-identifier hs-var">ty2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2281"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; TcType
</span><a href="GHC.Core.Coercion.html#coercionType"><span class="hs-identifier hs-var">coercionType</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683018986"><span class="hs-identifier hs-var">co1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; TcType
</span><a href="GHC.Core.Coercion.html#coercionType"><span class="hs-identifier hs-var">coercionType</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683018988"><span class="hs-identifier hs-var">co2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2282"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#mkProofIrrelCo"><span class="hs-identifier hs-type">mkProofIrrelCo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018874"><span class="hs-keyword hs-type">role</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018989"><span class="hs-identifier hs-type">kco</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018986"><span class="hs-identifier hs-type">co1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018988"><span class="hs-identifier hs-type">co2</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2283"></span><span>
</span><span id="line-2284"></span><span>        </span><span class="hs-comment">-- Anything else fails</span><span>
</span><span id="line-2285"></span><span>        </span><span class="hs-comment">-- E.g. unifying for-all types, which is relative unusual</span><span>
</span><span id="line-2286"></span><span>    </span><span class="annot"><a href="#local-6989586621683018882"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683018992"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018992"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683018993"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018993"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="#local-6989586621683018934"><span class="hs-identifier hs-var">defer</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018992"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018993"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-2287"></span><span>
</span><span id="line-2288"></span><span>    </span><span class="hs-comment">------------------</span><span>
</span><span id="line-2289"></span><span>    </span><span id="local-6989586621683018934"><span class="annot"><span class="annottext">defer :: TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="#local-6989586621683018934"><span class="hs-identifier hs-var hs-var">defer</span></a></span></span><span> </span><span id="local-6989586621683018994"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018994"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683018995"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018995"><span class="hs-identifier hs-var">ty2</span></a></span></span><span>   </span><span class="hs-comment">-- See Note [Check for equality before deferring]</span><span>
</span><span id="line-2290"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018994"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; TcType -&gt; TcType -&gt; Bool
TcType -&gt; TcType -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#tcEqType"><span class="hs-operator hs-var">`tcEqType`</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018995"><span class="hs-identifier hs-var">ty2</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; TcM Coercion
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; TcType -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683018874"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018994"><span class="hs-identifier hs-var">ty1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2291"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnifyEnv -&gt; TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#uType_defer"><span class="hs-identifier hs-var">uType_defer</span></a></span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683018873"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018875"><span class="hs-identifier hs-var">orig_ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018876"><span class="hs-identifier hs-var">orig_ty2</span></a></span><span>
</span><span id="line-2292"></span><span>
</span><span id="line-2293"></span><span>
</span><span id="line-2294"></span><span>    </span><span class="hs-comment">------------------</span><span>
</span><span id="line-2295"></span><span>    </span><span id="local-6989586621683018949"><span class="annot"><span class="annottext">u_tc_arg :: Bool -&gt; Role -&gt; TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="#local-6989586621683018949"><span class="hs-identifier hs-var hs-var">u_tc_arg</span></a></span></span><span> </span><span id="local-6989586621683018997"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683018997"><span class="hs-identifier hs-var">is_vis</span></a></span></span><span> </span><span id="local-6989586621683018998"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683018998"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span id="local-6989586621683018999"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018999"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683019000"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019000"><span class="hs-identifier hs-var">ty2</span></a></span></span><span>
</span><span id="line-2296"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;u_tc_arg&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683018998"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018999"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019000"><span class="hs-identifier hs-var">ty2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2297"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">UnifyEnv -&gt; TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#uType"><span class="hs-identifier hs-var">uType</span></a></span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683019001"><span class="hs-identifier hs-var">env_arg</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683018999"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019000"><span class="hs-identifier hs-var">ty2</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2298"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-2299"></span><span>        </span><span id="local-6989586621683019001"><span class="annot"><span class="annottext">env_arg :: UnifyEnv
</span><a href="#local-6989586621683019001"><span class="hs-identifier hs-var hs-var">env_arg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683018873"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#u_loc"><span class="hs-identifier hs-var">u_loc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.CtLoc.html#adjustCtLoc"><span class="hs-identifier hs-type">adjustCtLoc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018997"><span class="hs-identifier hs-type">is_vis</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#u_loc"><span class="hs-identifier hs-var">u_loc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018873"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2300"></span><span>                      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#u_role"><span class="hs-identifier hs-var">u_role</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683018998"><span class="hs-keyword hs-type">role</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2301"></span><span>
</span><span id="line-2302"></span><span>    </span><span class="hs-comment">------------------</span><span>
</span><span id="line-2303"></span><span>    </span><span class="hs-comment">-- For AppTy, decompose only nominal equalities</span><span>
</span><span id="line-2304"></span><span>    </span><span class="hs-comment">-- See Note [Decomposing AppTy equalities] in GHC.Tc.Solver.Equality</span><span>
</span><span id="line-2305"></span><span>    </span><span id="local-6989586621683018963"><span class="annot"><span class="annottext">go_app :: Bool
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcType
-&gt; TcM Coercion
</span><a href="#local-6989586621683018963"><span class="hs-identifier hs-var hs-var">go_app</span></a></span></span><span> </span><span id="local-6989586621683019002"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683019002"><span class="hs-identifier hs-var">vis</span></a></span></span><span> </span><span id="local-6989586621683019003"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019003"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683019004"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019004"><span class="hs-identifier hs-var">s1</span></a></span></span><span> </span><span id="local-6989586621683019005"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019005"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621683019006"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019006"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span id="local-6989586621683019007"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019007"><span class="hs-identifier hs-var">s2</span></a></span></span><span> </span><span id="local-6989586621683019008"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019008"><span class="hs-identifier hs-var">t2</span></a></span></span><span>
</span><span id="line-2306"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621683018874"><span class="hs-keyword hs-var">role</span></a></span><span>
</span><span id="line-2307"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- Unify arguments t1/t2 before function s1/s2, because</span><span>
</span><span id="line-2308"></span><span>        </span><span class="hs-comment">-- the former have smaller kinds, and hence simpler error messages</span><span>
</span><span id="line-2309"></span><span>        </span><span class="hs-comment">-- c.f. GHC.Tc.Solver.Equality.can_eq_app</span><span>
</span><span id="line-2310"></span><span>        </span><span class="hs-comment">-- Example: test T8603</span><span>
</span><span id="line-2311"></span><span>        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683019009"><span class="annot"><span class="annottext">env_arg :: UnifyEnv
</span><a href="#local-6989586621683019009"><span class="hs-identifier hs-var hs-var hs-var">env_arg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683018873"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#u_loc"><span class="hs-identifier hs-var">u_loc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.CtLoc.html#adjustCtLoc"><span class="hs-identifier hs-type">adjustCtLoc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019002"><span class="hs-identifier hs-type">vis</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#u_loc"><span class="hs-identifier hs-var">u_loc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018873"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2312"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683019010"><span class="annot"><a href="#local-6989586621683019010"><span class="hs-identifier hs-var">co_t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UnifyEnv -&gt; TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#uType"><span class="hs-identifier hs-var">uType</span></a></span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683019009"><span class="hs-identifier hs-var">env_arg</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019005"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019008"><span class="hs-identifier hs-var">t2</span></a></span><span>
</span><span id="line-2313"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683019011"><span class="annot"><a href="#local-6989586621683019011"><span class="hs-identifier hs-var">co_s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#uType"><span class="hs-identifier hs-type">uType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683018873"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019004"><span class="hs-identifier hs-type">s1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019007"><span class="hs-identifier hs-type">s2</span></a></span><span>
</span><span id="line-2314"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#mkAppCo"><span class="hs-identifier hs-type">mkAppCo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019011"><span class="hs-identifier hs-type">co_s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019010"><span class="hs-identifier hs-type">co_t</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2315"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2316"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="#local-6989586621683018934"><span class="hs-identifier hs-var">defer</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019003"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019006"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-2317"></span><span>
</span><span id="line-2318"></span><span class="hs-comment">{- Note [Check for equality before deferring]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Particularly in ambiguity checks we can get equalities like (ty ~ ty).
If ty involves a type function we may defer, which isn't very sensible.
An egregious example of this was in test T9872a, which has a type signature
       Proxy :: Proxy (Solutions Cubes)
Doing the ambiguity check on this signature generates the equality
   Solutions Cubes ~ Solutions Cubes
and currently the constraint solver normalises both sides at vast cost.
This little short-cut in 'defer' helps quite a bit.

Note [Care with type applications]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Note: type applications need a bit of care!
They can match FunTy and TyConApp, so use splitAppTy_maybe
NB: we've already dealt with type variables and Notes,
so if one type is an App the other one jolly well better be too

Note [Mismatched type lists and application decomposition]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we find two TyConApps, you might think that the argument lists
are guaranteed equal length.  But they aren't. Consider matching
        w (T x) ~ Foo (T x y)
We do match (w ~ Foo) first, but in some circumstances we simply create
a deferred constraint; and then go ahead and match (T x ~ T x y).
This came up in #3950.

So either
   (a) either we must check for identical argument kinds
       when decomposing applications,

   (b) or we must be prepared for ill-kinded unification sub-problems

Currently we adopt (b) since it seems more robust -- no need to maintain
a global invariant.

Note [Expanding synonyms during unification]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We expand synonyms during unification, but:
 * We expand *after* the variable case so that we tend to unify
   variables with un-expanded type synonym. This just makes it
   more likely that the inferred types will mention type synonyms
   understandable to the user

 * Similarly, we expand *after* the CastTy case, just in case the
   CastTy wraps a variable.

 * We expand *before* the TyConApp case.  For example, if we have
      type Phantom a = Int
   and are unifying
      Phantom Int ~ Phantom Char
   it is *wrong* to unify Int and Char.

 * The problem case immediately above can happen only with arguments
   to the tycon. So we check for nullary tycons *before* expanding.
   This is particularly helpful when checking (* ~ *), because * is
   now a type synonym.  See Note [Unifying type synonyms] in GHC.Core.Unify.

Note [Deferred unification]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
We may encounter a unification ty1 ~ ty2 that cannot be performed syntactically,
and yet its consistency is undetermined. Previously, there was no way to still
make it consistent. So a mismatch error was issued.

Now these unifications are deferred until constraint simplification, where type
family instances and given equations may (or may not) establish the consistency.
Deferred unifications are of the form
                F ... ~ ...
or              x ~ ...
where F is a type function and x is a type variable.
E.g.
        id :: x ~ y =&gt; x -&gt; y
        id e = e

involves the unification x = y. It is deferred until we bring into account the
context x ~ y to establish that it holds.

If available, we defer original types (rather than those where closed type
synonyms have already been expanded via tcCoreView).  This is, as usual, to
improve error messages.

************************************************************************
*                                                                      *
                 uUnfilledVar and friends
*                                                                      *
************************************************************************

@uunfilledVar@ is called when at least one of the types being unified is a
variable.  It does {\em not} assume that the variable is a fixed point
of the substitution; rather, notice that @uVar@ (defined below) nips
back into @uTys@ if it turns out that the variable is already bound.
-}</span><span>
</span><span id="line-2410"></span><span>
</span><span id="line-2411"></span><span class="hs-comment">----------</span><span>
</span><span id="line-2412"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#uUnfilledVar"><span class="hs-identifier hs-type">uUnfilledVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#uUnfilledVar1"><span class="hs-identifier hs-type">uUnfilledVar1</span></a></span><span>
</span><span id="line-2413"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#UnifyEnv"><span class="hs-identifier hs-type">UnifyEnv</span></a></span><span>
</span><span id="line-2414"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SwapFlag"><span class="hs-identifier hs-type">SwapFlag</span></a></span><span>
</span><span id="line-2415"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span>        </span><span class="hs-comment">-- Tyvar 1: not necessarily a meta-tyvar</span><span>
</span><span id="line-2416"></span><span>                      </span><span class="hs-comment">--    definitely not a /filled/ meta-tyvar</span><span>
</span><span id="line-2417"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcTauType"><span class="hs-identifier hs-type">TcTauType</span></a></span><span>      </span><span class="hs-comment">-- Type 2</span><span>
</span><span id="line-2418"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a></span><span>
</span><span id="line-2419"></span><span class="hs-comment">-- &quot;Unfilled&quot; means that the variable is definitely not a filled-in meta tyvar</span><span>
</span><span id="line-2420"></span><span class="hs-comment">--            It might be a skolem, or untouchable, or meta</span><span>
</span><span id="line-2421"></span><span id="uUnfilledVar"><span class="annot"><span class="annottext">uUnfilledVar :: UnifyEnv -&gt; SwapFlag -&gt; TcTyVar -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#uUnfilledVar"><span class="hs-identifier hs-var hs-var">uUnfilledVar</span></a></span></span><span> </span><span id="local-6989586621683019014"><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683019014"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621683019015"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683019015"><span class="hs-identifier hs-var">swapped</span></a></span></span><span> </span><span id="local-6989586621683019016"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019016"><span class="hs-identifier hs-var">tv1</span></a></span></span><span> </span><span id="local-6989586621683019017"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019017"><span class="hs-identifier hs-var">ty2</span></a></span></span><span>
</span><span id="line-2422"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UnifyEnv -&gt; Role
</span><a href="GHC.Tc.Utils.Unify.html#u_role"><span class="hs-identifier hs-var">u_role</span></a></span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683019014"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-2423"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683019018"><span class="annot"><a href="#local-6989586621683019018"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ZonkM TcType -&gt; TcM TcType
forall a. ZonkM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#liftZonkM"><span class="hs-identifier hs-var">liftZonkM</span></a></span><span> </span><span class="annot"><span class="annottext">(ZonkM TcType -&gt; TcM TcType) -&gt; ZonkM TcType -&gt; TcM TcType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; ZonkM TcType
</span><a href="GHC.Tc.Zonk.TcType.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019017"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-2424"></span><span>                  </span><span class="hs-comment">-- Zonk to expose things to the occurs check, and so</span><span>
</span><span id="line-2425"></span><span>                  </span><span class="hs-comment">-- that if ty2 looks like a type variable then it</span><span>
</span><span id="line-2426"></span><span>                  </span><span class="hs-comment">-- /is/ a type variable</span><span>
</span><span id="line-2427"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#uUnfilledVar1"><span class="hs-identifier hs-type">uUnfilledVar1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019014"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019015"><span class="hs-identifier hs-type">swapped</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019016"><span class="hs-identifier hs-type">tv1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019018"><span class="hs-identifier hs-type">ty2</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2428"></span><span>
</span><span id="line-2429"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>  </span><span class="hs-comment">-- See Note [Do not unify representational equalities]</span><span>
</span><span id="line-2430"></span><span>               </span><span class="hs-comment">-- in GHC.Tc.Solver.Equality</span><span>
</span><span id="line-2431"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SwapFlag
-&gt; (TcType -&gt; TcType -&gt; TcM Coercion)
-&gt; TcType
-&gt; TcType
-&gt; TcM Coercion
forall a b. SwapFlag -&gt; (a -&gt; a -&gt; b) -&gt; a -&gt; a -&gt; b
</span><a href="GHC.Types.Basic.html#unSwap"><span class="hs-identifier hs-var">unSwap</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683019015"><span class="hs-identifier hs-var">swapped</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UnifyEnv -&gt; TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#uType_defer"><span class="hs-identifier hs-var">uType_defer</span></a></span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683019014"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019016"><span class="hs-identifier hs-var">tv1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019017"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-2432"></span><span>
</span><span id="line-2433"></span><span id="uUnfilledVar1"><span class="annot"><span class="annottext">uUnfilledVar1 :: UnifyEnv -&gt; SwapFlag -&gt; TcTyVar -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#uUnfilledVar1"><span class="hs-identifier hs-var hs-var">uUnfilledVar1</span></a></span></span><span> </span><span id="local-6989586621683019023"><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683019023"><span class="hs-identifier hs-var">env</span></a></span></span><span>       </span><span class="hs-comment">-- Precondition: u_role==Nominal</span><span>
</span><span id="line-2434"></span><span>              </span><span id="local-6989586621683019024"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683019024"><span class="hs-identifier hs-var">swapped</span></a></span></span><span>
</span><span id="line-2435"></span><span>              </span><span id="local-6989586621683019025"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019025"><span class="hs-identifier hs-var">tv1</span></a></span></span><span>
</span><span id="line-2436"></span><span>              </span><span id="local-6989586621683019026"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019026"><span class="hs-identifier hs-var">ty2</span></a></span></span><span>       </span><span class="hs-comment">-- ty2 is zonked</span><span>
</span><span id="line-2437"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683019027"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019027"><span class="hs-identifier hs-var">tv2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe TcTyVar
</span><a href="GHC.Core.Type.html#getTyVar_maybe"><span class="hs-identifier hs-var">getTyVar_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019026"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-2438"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcM Coercion
</span><a href="#local-6989586621683019029"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019027"><span class="hs-identifier hs-var">tv2</span></a></span><span>
</span><span id="line-2439"></span><span>
</span><span id="line-2440"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2441"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnifyEnv -&gt; SwapFlag -&gt; TcTyVar -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#uUnfilledVar2"><span class="hs-identifier hs-var">uUnfilledVar2</span></a></span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683019023"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683019024"><span class="hs-identifier hs-var">swapped</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019025"><span class="hs-identifier hs-var">tv1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019026"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-2442"></span><span>
</span><span id="line-2443"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2444"></span><span>    </span><span class="hs-comment">-- 'go' handles the case where both are</span><span>
</span><span id="line-2445"></span><span>    </span><span class="hs-comment">-- tyvars so we might want to swap</span><span>
</span><span id="line-2446"></span><span>    </span><span class="hs-comment">-- E.g. maybe tv2 is a meta-tyvar and tv1 is not</span><span>
</span><span id="line-2447"></span><span>    </span><span id="local-6989586621683019029"><span class="annot"><span class="annottext">go :: TcTyVar -&gt; TcM Coercion
</span><a href="#local-6989586621683019029"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621683019031"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019031"><span class="hs-identifier hs-var">tv2</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019025"><span class="hs-identifier hs-var">tv1</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcTyVar -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019031"><span class="hs-identifier hs-var">tv2</span></a></span><span>  </span><span class="hs-comment">-- Same type variable =&gt; no-op</span><span>
</span><span id="line-2448"></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; TcM Coercion
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019025"><span class="hs-identifier hs-var">tv1</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2449"></span><span>
</span><span id="line-2450"></span><span>           </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcTyVar -&gt; TcTyVar -&gt; Bool
</span><a href="GHC.Tc.Utils.Unify.html#swapOverTyVars"><span class="hs-identifier hs-var">swapOverTyVars</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019025"><span class="hs-identifier hs-var">tv1</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019031"><span class="hs-identifier hs-var">tv2</span></a></span><span>   </span><span class="hs-comment">-- Distinct type variables</span><span>
</span><span id="line-2451"></span><span>               </span><span class="hs-comment">-- Swap meta tyvar to the left if poss</span><span>
</span><span id="line-2452"></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683019032"><span class="annot"><a href="#local-6989586621683019032"><span class="hs-identifier hs-var">tv1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ZonkM TcTyVar -&gt; TcM TcTyVar
forall a. ZonkM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#liftZonkM"><span class="hs-identifier hs-var">liftZonkM</span></a></span><span> </span><span class="annot"><span class="annottext">(ZonkM TcTyVar -&gt; TcM TcTyVar) -&gt; ZonkM TcTyVar -&gt; TcM TcTyVar
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; ZonkM TcTyVar
</span><a href="GHC.Tc.Zonk.TcType.html#zonkTyCoVarKind"><span class="hs-identifier hs-var">zonkTyCoVarKind</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019025"><span class="hs-identifier hs-var">tv1</span></a></span><span>
</span><span id="line-2453"></span><span>                     </span><span class="hs-comment">-- We must zonk tv1's kind because that might</span><span>
</span><span id="line-2454"></span><span>                     </span><span class="hs-comment">-- not have happened yet, and it's an invariant of</span><span>
</span><span id="line-2455"></span><span>                     </span><span class="hs-comment">-- uUnfilledTyVar2 that ty2 is fully zonked</span><span>
</span><span id="line-2456"></span><span>                     </span><span class="hs-comment">-- Omitting this caused #16902</span><span>
</span><span id="line-2457"></span><span>                </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#uUnfilledVar2"><span class="hs-identifier hs-type">uUnfilledVar2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019023"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Basic.html#flipSwap"><span class="hs-identifier hs-type">flipSwap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019024"><span class="hs-identifier hs-type">swapped</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683019031"><span class="hs-identifier hs-type">tv2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-type">mkTyVarTy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019032"><span class="hs-identifier hs-type">tv1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2458"></span><span>
</span><span id="line-2459"></span><span>           </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2460"></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnifyEnv -&gt; SwapFlag -&gt; TcTyVar -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#uUnfilledVar2"><span class="hs-identifier hs-var">uUnfilledVar2</span></a></span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683019023"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683019024"><span class="hs-identifier hs-var">swapped</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019025"><span class="hs-identifier hs-var">tv1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019026"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-2461"></span><span>
</span><span id="line-2462"></span><span class="hs-comment">----------</span><span>
</span><span id="line-2463"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#uUnfilledVar2"><span class="hs-identifier hs-type">uUnfilledVar2</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#UnifyEnv"><span class="hs-identifier hs-type">UnifyEnv</span></a></span><span>       </span><span class="hs-comment">-- Precondition: u_role==Nominal</span><span>
</span><span id="line-2464"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SwapFlag"><span class="hs-identifier hs-type">SwapFlag</span></a></span><span>
</span><span id="line-2465"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span>        </span><span class="hs-comment">-- Tyvar 1: not necessarily a meta-tyvar</span><span>
</span><span id="line-2466"></span><span>                                </span><span class="hs-comment">--    definitely not a /filled/ meta-tyvar</span><span>
</span><span id="line-2467"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcTauType"><span class="hs-identifier hs-type">TcTauType</span></a></span><span>      </span><span class="hs-comment">-- Type 2, zonked</span><span>
</span><span id="line-2468"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a></span><span>
</span><span id="line-2469"></span><span id="uUnfilledVar2"><span class="annot"><span class="annottext">uUnfilledVar2 :: UnifyEnv -&gt; SwapFlag -&gt; TcTyVar -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#uUnfilledVar2"><span class="hs-identifier hs-var hs-var">uUnfilledVar2</span></a></span></span><span> </span><span id="local-6989586621683019035"><span class="annot"><span class="annottext">env :: UnifyEnv
</span><a href="#local-6989586621683019035"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#UE"><span class="hs-identifier hs-type">UE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">u_defer :: UnifyEnv -&gt; TcRef (Bag Ct)
</span><a href="GHC.Tc.Utils.Unify.html#u_defer"><span class="hs-identifier hs-var">u_defer</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683019036"><span class="annot"><span class="annottext">TcRef (Bag Ct)
</span><a href="#local-6989586621683019036"><span class="hs-identifier hs-var">def_eq_ref</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621683019037"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683019037"><span class="hs-identifier hs-var">swapped</span></a></span></span><span> </span><span id="local-6989586621683019038"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019038"><span class="hs-identifier hs-var">tv1</span></a></span></span><span> </span><span id="local-6989586621683019039"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019039"><span class="hs-identifier hs-var">ty2</span></a></span></span><span>
</span><span id="line-2470"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683019040"><span class="annot"><a href="#local-6989586621683019040"><span class="hs-identifier hs-var">cur_lvl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM TcLevel
</span><a href="GHC.Tc.Utils.Monad.html#getTcLevel"><span class="hs-identifier hs-var">getTcLevel</span></a></span><span>
</span><span id="line-2471"></span><span>           </span><span class="hs-comment">-- See Note [Unification preconditions], (UNTOUCHABLE) wrinkles</span><span>
</span><span id="line-2472"></span><span>           </span><span class="hs-comment">-- Here we don't know about given equalities here; so we treat</span><span>
</span><span id="line-2473"></span><span>           </span><span class="hs-comment">-- /any/ level outside this one as untouchable.  Hence cur_lvl.</span><span>
</span><span id="line-2474"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#touchabilityAndShapeTest"><span class="hs-identifier hs-type">touchabilityAndShapeTest</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019040"><span class="hs-identifier hs-type">cur_lvl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019038"><span class="hs-identifier hs-type">tv1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019039"><span class="hs-identifier hs-type">ty2</span></a></span><span>
</span><span id="line-2475"></span><span>                 </span><span class="annot"><span class="hs-operator hs-type">&amp;&amp;</span></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#simpleUnifyCheck"><span class="hs-identifier hs-type">simpleUnifyCheck</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#UC_OnTheFly"><span class="hs-identifier hs-type">UC_OnTheFly</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019038"><span class="hs-identifier hs-type">tv1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019039"><span class="hs-identifier hs-type">ty2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2476"></span><span>         </span><span class="hs-keyword">then</span><span> </span><span class="annot"><a href="#local-6989586621683019042"><span class="hs-identifier hs-type">not_ok_so_defer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019040"><span class="hs-identifier hs-type">cur_lvl</span></a></span><span>
</span><span id="line-2477"></span><span>         </span><span class="hs-keyword">else</span><span>
</span><span id="line-2478"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683019043"><span class="annot"><a href="#local-6989586621683019043"><span class="hs-identifier hs-var">def_eqs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TcRef.html#readTcRef"><span class="hs-identifier hs-type">readTcRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019036"><span class="hs-identifier hs-type">def_eq_ref</span></a></span><span>  </span><span class="hs-comment">-- Capture current state of def_eqs</span><span>
</span><span id="line-2479"></span><span>
</span><span id="line-2480"></span><span>       </span><span class="hs-comment">-- Attempt to unify kinds</span><span>
</span><span id="line-2481"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683019044"><span class="annot"><a href="#local-6989586621683019044"><span class="hs-identifier hs-var">co_k</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#uType"><span class="hs-identifier hs-type">uType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#mkKindEnv"><span class="hs-identifier hs-type">mkKindEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019035"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019045"><span class="hs-identifier hs-type">ty1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019039"><span class="hs-identifier hs-type">ty2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-type">typeKind</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019039"><span class="hs-identifier hs-type">ty2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#tyVarKind"><span class="hs-identifier hs-type">tyVarKind</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019038"><span class="hs-identifier hs-type">tv1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2482"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;uUnfilledVar2 ok&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-2483"></span><span>         </span><span class="annot"><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-type">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019038"><span class="hs-identifier hs-type">tv1</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#dcolon"><span class="hs-identifier hs-type">dcolon</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#tyVarKind"><span class="hs-identifier hs-type">tyVarKind</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019038"><span class="hs-identifier hs-type">tv1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2484"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019039"><span class="hs-identifier hs-type">ty2</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#dcolon"><span class="hs-identifier hs-type">dcolon</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-type">typeKind</span></a></span><span>  </span><span class="annot"><a href="#local-6989586621683019039"><span class="hs-identifier hs-type">ty2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2485"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.html#isReflCo"><span class="hs-identifier hs-type">isReflCo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019044"><span class="hs-identifier hs-type">co_k</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019044"><span class="hs-identifier hs-type">co_k</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-2486"></span><span>
</span><span id="line-2487"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#isReflCo"><span class="hs-identifier hs-type">isReflCo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019044"><span class="hs-identifier hs-type">co_k</span></a></span><span>
</span><span id="line-2488"></span><span>           </span><span class="hs-comment">-- Only proceed if the kinds match</span><span>
</span><span id="line-2489"></span><span>           </span><span class="hs-comment">-- NB: tv1 should still be unfilled, despite the kind unification</span><span>
</span><span id="line-2490"></span><span>           </span><span class="hs-comment">--     because tv1 is not free in ty2' (or, hence, in its kind)</span><span>
</span><span id="line-2491"></span><span>         </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#liftZonkM"><span class="hs-identifier hs-type">liftZonkM</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Tc.Zonk.TcType.html#writeMetaTyVar"><span class="hs-identifier hs-type">writeMetaTyVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019038"><span class="hs-identifier hs-type">tv1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019039"><span class="hs-identifier hs-type">ty2</span></a></span><span>
</span><span id="line-2492"></span><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#u_unified"><span class="hs-identifier hs-var">u_unified</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019035"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2493"></span><span>                     </span><span class="annot"><span class="annottext">Maybe (TcRef [TcTyVar])
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2494"></span><span>                     </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683019049"><span class="annot"><span class="annottext">TcRef [TcTyVar]
</span><a href="#local-6989586621683019049"><span class="hs-identifier hs-var">uref</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcRef [TcTyVar] -&gt; ([TcTyVar] -&gt; [TcTyVar]) -&gt; TcM ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TcRef a -&gt; (a -&gt; a) -&gt; m ()
</span><a href="GHC.Tc.Types.TcRef.html#updTcRef"><span class="hs-identifier hs-var">updTcRef</span></a></span><span> </span><span class="annot"><span class="annottext">TcRef [TcTyVar]
</span><a href="#local-6989586621683019049"><span class="hs-identifier hs-var">uref</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019038"><span class="hs-identifier hs-var">tv1</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; [TcTyVar] -&gt; [TcTyVar]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="hs-special">)</span><span>
</span><span id="line-2495"></span><span>                 </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-type">mkNomReflCo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019039"><span class="hs-identifier hs-type">ty2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>  </span><span class="hs-comment">-- Unification is always Nominal</span><span>
</span><span id="line-2496"></span><span>
</span><span id="line-2497"></span><span>         </span><span class="hs-keyword">else</span><span> </span><span class="hs-comment">-- The kinds don't match yet, so defer instead.</span><span>
</span><span id="line-2498"></span><span>              </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TcRef.html#writeTcRef"><span class="hs-identifier hs-type">writeTcRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019036"><span class="hs-identifier hs-type">def_eq_ref</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019043"><span class="hs-identifier hs-type">def_eqs</span></a></span><span>
</span><span id="line-2499"></span><span>                     </span><span class="hs-comment">-- Since we are discarding co_k, also discard any constraints</span><span>
</span><span id="line-2500"></span><span>                     </span><span class="hs-comment">-- emitted by kind unification; they are just useless clutter.</span><span>
</span><span id="line-2501"></span><span>                     </span><span class="hs-comment">-- Do this dicarding by simply restoring the previous state</span><span>
</span><span id="line-2502"></span><span>                     </span><span class="hs-comment">-- of def_eqs; a bit imperative/yukky but works fine.</span><span>
</span><span id="line-2503"></span><span>                 </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="#local-6989586621683019050"><span class="hs-identifier hs-type">defer</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2504"></span><span>         </span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><span id="line-2505"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2506"></span><span>    </span><span id="local-6989586621683019045"><span class="annot"><span class="annottext">ty1 :: TcType
</span><a href="#local-6989586621683019045"><span class="hs-identifier hs-var hs-var">ty1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019038"><span class="hs-identifier hs-var">tv1</span></a></span><span>
</span><span id="line-2507"></span><span>    </span><span id="local-6989586621683019050"><span class="annot"><span class="annottext">defer :: TcM Coercion
</span><a href="#local-6989586621683019050"><span class="hs-identifier hs-var hs-var">defer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SwapFlag
-&gt; (TcType -&gt; TcType -&gt; TcM Coercion)
-&gt; TcType
-&gt; TcType
-&gt; TcM Coercion
forall a b. SwapFlag -&gt; (a -&gt; a -&gt; b) -&gt; a -&gt; a -&gt; b
</span><a href="GHC.Types.Basic.html#unSwap"><span class="hs-identifier hs-var">unSwap</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621683019037"><span class="hs-identifier hs-var">swapped</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UnifyEnv -&gt; TcType -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#uType_defer"><span class="hs-identifier hs-var">uType_defer</span></a></span><span> </span><span class="annot"><span class="annottext">UnifyEnv
</span><a href="#local-6989586621683019035"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019045"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019039"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-2508"></span><span>
</span><span id="line-2509"></span><span>    </span><span id="local-6989586621683019042"><span class="annot"><span class="annottext">not_ok_so_defer :: TcLevel -&gt; TcM Coercion
</span><a href="#local-6989586621683019042"><span class="hs-identifier hs-var hs-var">not_ok_so_defer</span></a></span></span><span> </span><span id="local-6989586621683019051"><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019051"><span class="hs-identifier hs-var">cur_lvl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2510"></span><span>      </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;uUnfilledVar2 not ok&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcM ()) -&gt; SDoc -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2511"></span><span>             </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tv1:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019038"><span class="hs-identifier hs-var">tv1</span></a></span><span>
</span><span id="line-2512"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ty2:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019039"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-2513"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;simple-unify-chk:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UnifyCheckCaller -&gt; TcTyVar -&gt; TcType -&gt; Bool
</span><a href="GHC.Tc.Utils.Unify.html#simpleUnifyCheck"><span class="hs-identifier hs-var">simpleUnifyCheck</span></a></span><span> </span><span class="annot"><span class="annottext">UnifyCheckCaller
</span><a href="GHC.Tc.Utils.Unify.html#UC_OnTheFly"><span class="hs-identifier hs-var">UC_OnTheFly</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019038"><span class="hs-identifier hs-var">tv1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019039"><span class="hs-identifier hs-var">ty2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2514"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;touchability:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcLevel -&gt; TcTyVar -&gt; TcType -&gt; Bool
</span><a href="GHC.Tc.Utils.Unify.html#touchabilityAndShapeTest"><span class="hs-identifier hs-var">touchabilityAndShapeTest</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019051"><span class="hs-identifier hs-var">cur_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019038"><span class="hs-identifier hs-var">tv1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019039"><span class="hs-identifier hs-var">ty2</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-2515"></span><span>               </span><span class="hs-comment">-- Occurs check or an untouchable: just defer</span><span>
</span><span id="line-2516"></span><span>               </span><span class="hs-comment">-- NB: occurs check isn't necessarily fatal:</span><span>
</span><span id="line-2517"></span><span>               </span><span class="hs-comment">--     eg tv1 occurred in type family parameter</span><span>
</span><span id="line-2518"></span><span>          </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">TcM Coercion
</span><a href="#local-6989586621683019050"><span class="hs-identifier hs-var">defer</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2519"></span><span>
</span><span id="line-2520"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#swapOverTyVars"><span class="hs-identifier hs-type">swapOverTyVars</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-2521"></span><span id="swapOverTyVars"><span class="annot"><span class="annottext">swapOverTyVars :: Bool -&gt; TcTyVar -&gt; TcTyVar -&gt; Bool
</span><a href="GHC.Tc.Utils.Unify.html#swapOverTyVars"><span class="hs-identifier hs-var hs-var">swapOverTyVars</span></a></span></span><span> </span><span id="local-6989586621683019052"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683019052"><span class="hs-identifier hs-var">is_given</span></a></span></span><span> </span><span id="local-6989586621683019053"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019053"><span class="hs-identifier hs-var">tv1</span></a></span></span><span> </span><span id="local-6989586621683019054"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019054"><span class="hs-identifier hs-var">tv2</span></a></span></span><span>
</span><span id="line-2522"></span><span>  </span><span class="hs-comment">-- See Note [Unification variables on the left]</span><span>
</span><span id="line-2523"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683019052"><span class="hs-identifier hs-var">is_given</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683019055"><span class="hs-identifier hs-var">pri1</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683019056"><span class="hs-identifier hs-var">pri2</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-2524"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683019052"><span class="hs-identifier hs-var">is_given</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683019056"><span class="hs-identifier hs-var">pri2</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683019055"><span class="hs-identifier hs-var">pri1</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-2525"></span><span>
</span><span id="line-2526"></span><span>  </span><span class="hs-comment">-- Level comparison: see Note [TyVar/TyVar orientation]</span><span>
</span><span id="line-2527"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019057"><span class="hs-identifier hs-var">lvl1</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel -&gt; TcLevel -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#strictlyDeeperThan"><span class="hs-operator hs-var">`strictlyDeeperThan`</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019059"><span class="hs-identifier hs-var">lvl2</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-2528"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019059"><span class="hs-identifier hs-var">lvl2</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel -&gt; TcLevel -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#strictlyDeeperThan"><span class="hs-operator hs-var">`strictlyDeeperThan`</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019057"><span class="hs-identifier hs-var">lvl1</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-2529"></span><span>
</span><span id="line-2530"></span><span>  </span><span class="hs-comment">-- Priority: see Note [TyVar/TyVar orientation]</span><span>
</span><span id="line-2531"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683019055"><span class="hs-identifier hs-var">pri1</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683019056"><span class="hs-identifier hs-var">pri2</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-2532"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683019056"><span class="hs-identifier hs-var">pri2</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683019055"><span class="hs-identifier hs-var">pri1</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-2533"></span><span>
</span><span id="line-2534"></span><span>  </span><span class="hs-comment">-- Names: see Note [TyVar/TyVar orientation]</span><span>
</span><span id="line-2535"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Bool
</span><a href="GHC.Types.Name.html#isSystemName"><span class="hs-identifier hs-var">isSystemName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683019061"><span class="hs-identifier hs-var">tv2_name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Bool
</span><a href="GHC.Types.Name.html#isSystemName"><span class="hs-identifier hs-var">isSystemName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683019062"><span class="hs-identifier hs-var">tv1_name</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-2536"></span><span>
</span><span id="line-2537"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-2538"></span><span>
</span><span id="line-2539"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2540"></span><span>    </span><span id="local-6989586621683019057"><span class="annot"><span class="annottext">lvl1 :: TcLevel
</span><a href="#local-6989586621683019057"><span class="hs-identifier hs-var hs-var">lvl1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcLevel
</span><a href="GHC.Tc.Utils.TcType.html#tcTyVarLevel"><span class="hs-identifier hs-var">tcTyVarLevel</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019053"><span class="hs-identifier hs-var">tv1</span></a></span><span>
</span><span id="line-2541"></span><span>    </span><span id="local-6989586621683019059"><span class="annot"><span class="annottext">lvl2 :: TcLevel
</span><a href="#local-6989586621683019059"><span class="hs-identifier hs-var hs-var">lvl2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcLevel
</span><a href="GHC.Tc.Utils.TcType.html#tcTyVarLevel"><span class="hs-identifier hs-var">tcTyVarLevel</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019054"><span class="hs-identifier hs-var">tv2</span></a></span><span>
</span><span id="line-2542"></span><span>    </span><span id="local-6989586621683019055"><span class="annot"><span class="annottext">pri1 :: Int
</span><a href="#local-6989586621683019055"><span class="hs-identifier hs-var hs-var">pri1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; Int
</span><a href="GHC.Tc.Utils.Unify.html#lhsPriority"><span class="hs-identifier hs-var">lhsPriority</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019053"><span class="hs-identifier hs-var">tv1</span></a></span><span>
</span><span id="line-2543"></span><span>    </span><span id="local-6989586621683019056"><span class="annot"><span class="annottext">pri2 :: Int
</span><a href="#local-6989586621683019056"><span class="hs-identifier hs-var hs-var">pri2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; Int
</span><a href="GHC.Tc.Utils.Unify.html#lhsPriority"><span class="hs-identifier hs-var">lhsPriority</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019054"><span class="hs-identifier hs-var">tv2</span></a></span><span>
</span><span id="line-2544"></span><span>    </span><span id="local-6989586621683019062"><span class="annot"><span class="annottext">tv1_name :: Name
</span><a href="#local-6989586621683019062"><span class="hs-identifier hs-var hs-var">tv1_name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; Name
</span><a href="GHC.Types.Var.html#varName"><span class="hs-identifier hs-var">Var.varName</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019053"><span class="hs-identifier hs-var">tv1</span></a></span><span>
</span><span id="line-2545"></span><span>    </span><span id="local-6989586621683019061"><span class="annot"><span class="annottext">tv2_name :: Name
</span><a href="#local-6989586621683019061"><span class="hs-identifier hs-var hs-var">tv2_name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; Name
</span><a href="GHC.Types.Var.html#varName"><span class="hs-identifier hs-var">Var.varName</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019054"><span class="hs-identifier hs-var">tv2</span></a></span><span>
</span><span id="line-2546"></span><span>
</span><span id="line-2547"></span><span>
</span><span id="line-2548"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#lhsPriority"><span class="hs-identifier hs-type">lhsPriority</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-2549"></span><span class="hs-comment">-- Higher =&gt; more important to be on the LHS</span><span>
</span><span id="line-2550"></span><span class="hs-comment">--        =&gt; more likely to be eliminated</span><span>
</span><span id="line-2551"></span><span class="hs-comment">-- Only used when the levels are identical</span><span>
</span><span id="line-2552"></span><span class="hs-comment">-- See Note [TyVar/TyVar orientation]</span><span>
</span><span id="line-2553"></span><span id="lhsPriority"><span class="annot"><span class="annottext">lhsPriority :: TcTyVar -&gt; Int
</span><a href="GHC.Tc.Utils.Unify.html#lhsPriority"><span class="hs-identifier hs-var hs-var">lhsPriority</span></a></span></span><span> </span><span id="local-6989586621683019065"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019065"><span class="hs-identifier hs-var">tv</span></a></span></span><span>
</span><span id="line-2554"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; Int -&gt; Int
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019065"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019065"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int) -&gt; Int -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2555"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcTyVarDetails
</span><a href="GHC.Types.Var.html#tcTyVarDetails"><span class="hs-identifier hs-var">tcTyVarDetails</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019065"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2556"></span><span>      </span><span class="annot"><span class="annottext">TcTyVarDetails
</span><a href="GHC.Tc.Utils.TcType.html#RuntimeUnk"><span class="hs-identifier hs-var">RuntimeUnk</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-2557"></span><span>      </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#SkolemTv"><span class="hs-identifier hs-type">SkolemTv</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-2558"></span><span>      </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#MetaTv"><span class="hs-identifier hs-type">MetaTv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mtv_info :: TcTyVarDetails -&gt; MetaInfo
</span><a href="GHC.Tc.Utils.TcType.html#mtv_info"><span class="hs-identifier hs-var">mtv_info</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683019072"><span class="annot"><span class="annottext">MetaInfo
</span><a href="#local-6989586621683019072"><span class="hs-identifier hs-var">info</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mtv_tclvl :: TcTyVarDetails -&gt; TcLevel
</span><a href="GHC.Tc.Utils.TcType.html#mtv_tclvl"><span class="hs-identifier hs-var">mtv_tclvl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683019074"><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019074"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2559"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="GHC.Tc.Utils.TcType.html#QLInstVar"><span class="hs-identifier hs-var">QLInstVar</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019074"><span class="hs-identifier hs-var">lvl</span></a></span><span>
</span><span id="line-2560"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">5</span></span><span>  </span><span class="hs-comment">-- Eliminate instantiation variables first</span><span>
</span><span id="line-2561"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2562"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MetaInfo
</span><a href="#local-6989586621683019072"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2563"></span><span>             </span><span class="annot"><span class="annottext">MetaInfo
</span><a href="GHC.Tc.Utils.TcType.html#CycleBreakerTv"><span class="hs-identifier hs-var">CycleBreakerTv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-2564"></span><span>             </span><span class="annot"><span class="annottext">MetaInfo
</span><a href="GHC.Tc.Utils.TcType.html#TyVarTv"><span class="hs-identifier hs-var">TyVarTv</span></a></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-2565"></span><span>             </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#ConcreteTv"><span class="hs-identifier hs-type">ConcreteTv</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span>
</span><span id="line-2566"></span><span>             </span><span class="annot"><span class="annottext">MetaInfo
</span><a href="GHC.Tc.Utils.TcType.html#TauTv"><span class="hs-identifier hs-var">TauTv</span></a></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">3</span></span><span>
</span><span id="line-2567"></span><span>             </span><span class="annot"><span class="annottext">MetaInfo
</span><a href="GHC.Tc.Utils.TcType.html#RuntimeUnkTv"><span class="hs-identifier hs-var">RuntimeUnkTv</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">4</span></span><span>
</span><span id="line-2568"></span><span>
</span><span id="line-2569"></span><span class="hs-comment">{- Note [Unification preconditions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Question: given a homogeneous equality (alpha ~# ty), when is it OK to
unify alpha := ty?

This note only applied to /homogeneous/ equalities, in which both
sides have the same kind.

There are five reasons not to unify:

1. (SKOL-ESC) Skolem-escape
   Consider the constraint
        forall[2] a[2]. alpha[1] ~ Maybe a[2]
   If we unify alpha := Maybe a, the skolem 'a' may escape its scope.
   The level alpha[1] says that alpha may be used outside this constraint,
   where 'a' is not in scope at all.  So we must not unify.

   Bottom line: when looking at a constraint alpha[n] := ty, do not unify
   if any free variable of 'ty' has level deeper (greater) than n

2. (UNTOUCHABLE) Untouchable unification variables
   Consider the constraint
        forall[2] a[2]. b[1] ~ Int =&gt; alpha[1] ~ Int
   There is no (SKOL-ESC) problem with unifying alpha := Int, but it might
   not be the principal solution. Perhaps the &quot;right&quot; solution is alpha := b.
   We simply can't tell.  See &quot;OutsideIn(X): modular type inference with local
   assumptions&quot;, section 2.2.  We say that alpha[1] is &quot;untouchable&quot; inside
   this implication.

   Bottom line: at ambient level 'l', when looking at a constraint
   alpha[n] ~ ty, do not unify alpha := ty if there are any given equalities
   between levels 'n' and 'l'.

   Exactly what is a &quot;given equality&quot; for the purpose of (UNTOUCHABLE)?
   Answer: see Note [Tracking Given equalities] in GHC.Tc.Solver.InertSet

3. (TYVAR-TV) Unifying TyVarTvs and CycleBreakerTvs
   This precondition looks at the MetaInfo of the unification variable:

   * TyVarTv: When considering alpha{tyv} ~ ty, if alpha{tyv} is a
     TyVarTv it can only unify with a type variable, not with a
     structured type.  So if 'ty' is a structured type, such as (Maybe x),
     don't unify.

   * CycleBreakerTv: never unified, except by restoreTyVarCycles.

4. (CONCRETE) A ConcreteTv can only unify with a concrete type,
    by definition.

    That is, if we have `rr[conc] ~ F Int`, we can't unify
    `rr` with `F Int`, so we hold off on unifying.
    Note however that the equality might get rewritten; for instance
    if we can rewrite `F Int` to a concrete type, say `FloatRep`,
    then we will have `rr[conc] ~ FloatRep` and we can unify `rr ~ FloatRep`.

    Note that we can still make progress on unification even if
    we can't fully solve an equality, e.g.

      alpha[conc] ~# TupleRep '[ beta[tau], F gamma[tau] ]

    we can fill beta[tau] := beta[conc]. This is why we call
    'makeTypeConcrete' in startSolvingByUnification.

5. (COERCION-HOLE) Confusing coercion holes
   Suppose our equality is
     (alpha :: k) ~ (Int |&gt; {co})
   where co :: Type ~ k is an unsolved wanted. Note that this equality
   is homogeneous; both sides have kind k. We refrain from unifying here, because
   of the coercion hole in the RHS -- see Wrinkle (EIK2) in
   Note [Equalities with incompatible kinds] in GHC.Solver.Equality.

Needless to say, all there are wrinkles:

* (SKOL-ESC) Promotion.  Given alpha[n] ~ ty, what if beta[k] is free
  in 'ty', where beta is a unification variable, and k&gt;n?  'beta'
  stands for a monotype, and since it is part of a level-n type
  (equal to alpha[n]), we must /promote/ beta to level n.  Just make
  up a fresh gamma[n], and unify beta[k] := gamma[n].

* (TYVAR-TV) Unification variables.  Suppose alpha[tyv,n] is a level-n
  TyVarTv (see Note [TyVarTv] in GHC.Tc.Types.TcMType)? Now
  consider alpha[tyv,n] ~ Bool.  We don't want to unify because that
  would break the TyVarTv invariant.

  What about alpha[tyv,n] ~ beta[tau,n], where beta is an ordinary
  TauTv?  Again, don't unify, because beta might later be unified
  with, say Bool.  (If levels permit, we reverse the orientation here;
  see Note [TyVar/TyVar orientation].)

* (UNTOUCHABLE) Untouchability.  When considering (alpha[n] ~ ty), how
  do we know whether there are any given equalities between level n
  and the ambient level?  We answer in two ways:

  * In the eager unifier, we only unify if l=n.  If not, alpha may be
    untouchable, and defer to the constraint solver.  This check is
    made in GHC.Tc.Utils.uUnifilledVar2, in the guard
    isTouchableMetaTyVar.

  * In the constraint solver, we track where Given equalities occur
    and use that to guard unification in
    GHC.Tc.Utils.Unify.touchabilityAndShapeTest. More details in
    Note [Tracking Given equalities] in GHC.Tc.Solver.InertSet

    Historical note: in the olden days (pre 2021) the constraint solver
    also used to unify only if l=n.  Equalities were &quot;floated&quot; out of the
    implication in a separate step, so that they would become touchable.
    But the float/don't-float question turned out to be very delicate,
    as you can see if you look at the long series of Notes associated with
    GHC.Tc.Solver.floatEqualities, around Nov 2020.  It's much easier
    to unify in-place, with no floating.

Note [TyVar/TyVar orientation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
See also Note [Fundeps with instances, and equality orientation]
where the kind equality orientation is important

Given (a ~ b), should we orient the equality as (a~b) or (b~a)?
This is a surprisingly tricky question!

The question is answered by swapOverTyVars, which is used
  - in the eager unifier, in GHC.Tc.Utils.Unify.uUnfilledVar1
  - in the constraint solver, in GHC.Tc.Solver.Equality.canEqCanLHS2

First note: only swap if you have to!
   See Note [Avoid unnecessary swaps]

So we look for a positive reason to swap, using a three-step test:

* Level comparison. If 'a' has deeper level than 'b',
  put 'a' on the left.  See Note [Deeper level on the left]

* Priority.  If the levels are the same, look at what kind of
  type variable it is, using 'lhsPriority'.

  Generally speaking we always try to put a MetaTv on the left in
  preference to SkolemTv or RuntimeUnkTv, because the MetaTv may be
  touchable and can be unified.

  Tie-breaking rules for MetaTvs:
  - CycleBreakerTv: This is essentially a stand-in for another type;
       it's untouchable and should have the same priority as a skolem: 0.

  - TyVarTv: These can unify only with another tyvar, but we can't unify
       a TyVarTv with a TauTv, because then the TyVarTv could (transitively)
       get a non-tyvar type. So give these a low priority: 1.

  - ConcreteTv: These are like TauTv, except they can only unify with
    a concrete type. So we want to be able to write to them, but not quite
    as much as TauTvs: 2.

  - TauTv: This is the common case; we want these on the left so that they
       can be written to: 3.

  - RuntimeUnkTv: These aren't really meta-variables used in type inference,
       but just a convenience in the implementation of the GHCi debugger.
       Eagerly write to these: 4. See Note [RuntimeUnkTv] in
       GHC.Runtime.Heap.Inspect.

* Names. If the level and priority comparisons are all
  equal, try to eliminate a TyVar with a System Name in
  favour of ones with a Name derived from a user type signature

* Age.  At one point in the past we tried to break any remaining
  ties by eliminating the younger type variable, based on their
  Uniques.  See Note [Eliminate younger unification variables]
  (which also explains why we don't do this any more)

Note [Unification variables on the left]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For wanteds, but not givens, swap (skolem ~ meta-tv) regardless of
level, so that the unification variable is on the left.

* We /don't/ want this for Givens because if we ave
    [G] a[2] ~ alpha[1]
    [W] Bool ~ a[2]
  we want to rewrite the wanted to Bool ~ alpha[1],
  so we can float the constraint and solve it.

* But for Wanteds putting the unification variable on
  the left means an easier job when floating, and when
  reporting errors -- just fewer cases to consider.

  In particular, we get better skolem-escape messages:
  see #18114

Note [Deeper level on the left]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The most important thing is that we want to put tyvars with
the deepest level on the left.  The reason to do so differs for
Wanteds and Givens, but either way, deepest wins!  Simple.

* Wanteds.  Putting the deepest variable on the left maximise the
  chances that it's a touchable meta-tyvar which can be solved.

* Givens. Suppose we have something like
     forall a[2]. b[1] ~ a[2] =&gt; beta[1] ~ a[2]

  If we orient the Given a[2] on the left, we'll rewrite the Wanted to
  (beta[1] ~ b[1]), and that can float out of the implication.
  Otherwise it can't.  By putting the deepest variable on the left
  we maximise our changes of eliminating skolem capture.

  See also GHC.Tc.Solver.InertSet Note [Let-bound skolems] for another reason
  to orient with the deepest skolem on the left.

  IMPORTANT NOTE: this test does a level-number comparison on
  skolems, so it's important that skolems have (accurate) level
  numbers.

See #15009 for an further analysis of why &quot;deepest on the left&quot;
is a good plan.

Note [Avoid unnecessary swaps]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we swap without actually improving matters, we can get an infinite loop.
Consider
    work item:  a ~ b
   inert item:  b ~ c
We canonicalise the work-item to (a ~ c).  If we then swap it before
adding to the inert set, we'll add (c ~ a), and therefore kick out the
inert guy, so we get
   new work item:  b ~ c
   inert item:     c ~ a
And now the cycle just repeats

Historical Note [Eliminate younger unification variables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Given a choice of unifying
     alpha := beta   or   beta := alpha
we try, if possible, to eliminate the &quot;younger&quot; one, as determined
by `ltUnique`.  Reason: the younger one is less likely to appear free in
an existing inert constraint, and hence we are less likely to be forced
into kicking out and rewriting inert constraints.

This is a performance optimisation only.  It turns out to fix
#14723 all by itself, but clearly not reliably so!

It's simple to implement (see nicer_to_update_tv2 in swapOverTyVars).
But, to my surprise, it didn't seem to make any significant difference
to the compiler's performance, so I didn't take it any further.  Still
it seemed too nice to discard altogether, so I'm leaving these
notes.  SLPJ Jan 18.

Note [Prevent unification with type families]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We prevent unification with type families because of an uneasy compromise.
It's perfectly sound to unify with type families, and it even improves the
error messages in the testsuite. It also modestly improves performance, at
least in some cases. But it's disastrous for test case perf/compiler/T3064.
Here is the problem: Suppose we have (F ty) where we also have [G] F ty ~ a.
What do we do? Do we reduce F? Or do we use the given? Hard to know what's
best. GHC reduces. This is a disaster for T3064, where the type's size
spirals out of control during reduction. If we prevent
unification with type families, then the solver happens to use the equality
before expanding the type family.

It would be lovely in the future to revisit this problem and remove this
extra, unnecessary check. But we retain it for now as it seems to work
better in practice.

Revisited in Nov '20, along with removing flattening variables. Problem
is still present, and the solution is still the same.

Note [Non-TcTyVars in GHC.Tc.Utils.Unify]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Because the same code is now shared between unifying types and unifying
kinds, we sometimes will see proper TyVars floating around the unifier.
Example (from test case polykinds/PolyKinds12):

    type family Apply (f :: k1 -&gt; k2) (x :: k1) :: k2
    type instance Apply g y = g y

When checking the instance declaration, we first *kind-check* the LHS
and RHS, discovering that the instance really should be

    type instance Apply k3 k4 (g :: k3 -&gt; k4) (y :: k3) = g y

During this kind-checking, all the tyvars will be TcTyVars. Then, however,
as a second pass, we desugar the RHS (which is done in functions prefixed
with &quot;tc&quot; in GHC.Tc.TyCl&quot;). By this time, all the kind-vars are proper
TyVars, not TcTyVars, get some kind unification must happen.

Thus, we always check if a TyVar is a TcTyVar before asking if it's a
meta-tyvar.

This used to not be necessary for type-checking (that is, before * :: *)
because expressions get desugared via an algorithm separate from
type-checking (with wrappers, etc.). Types get desugared very differently,
causing this wibble in behavior seen here.
-}</span><span>
</span><span id="line-2859"></span><span>
</span><span id="line-2860"></span><span class="annot"><span class="hs-comment">-- | Breaks apart a function kind into its pieces.</span></span><span>
</span><span id="line-2861"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#matchExpectedFunKind"><span class="hs-identifier hs-type">matchExpectedFunKind</span></a></span><span>
</span><span id="line-2862"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#TypedThing"><span class="hs-identifier hs-type">TypedThing</span></a></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ type, only for errors</span></span><span>
</span><span id="line-2863"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span>           </span><span class="annot"><span class="hs-comment">-- ^ n: number of desired arrows</span></span><span>
</span><span id="line-2864"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcKind"><span class="hs-identifier hs-type">TcKind</span></a></span><span>          </span><span class="annot"><span class="hs-comment">-- ^ fun_kind</span></span><span>
</span><span id="line-2865"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ co :: fun_kind ~ (arg1 -&gt; ... -&gt; argn -&gt; res)</span></span><span>
</span><span id="line-2866"></span><span>
</span><span id="line-2867"></span><span id="matchExpectedFunKind"><span class="annot"><span class="annottext">matchExpectedFunKind :: TypedThing -&gt; Int -&gt; TcType -&gt; TcM Coercion
</span><a href="GHC.Tc.Utils.Unify.html#matchExpectedFunKind"><span class="hs-identifier hs-var hs-var">matchExpectedFunKind</span></a></span></span><span> </span><span id="local-6989586621683019081"><span class="annot"><span class="annottext">TypedThing
</span><a href="#local-6989586621683019081"><span class="hs-identifier hs-var">hs_ty</span></a></span></span><span> </span><span id="local-6989586621683019082"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683019082"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621683019083"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019083"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; TcType -&gt; TcM Coercion
</span><a href="#local-6989586621683019084"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683019082"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019083"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-2868"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2869"></span><span>    </span><span id="local-6989586621683019084"><span class="annot"><span class="annottext">go :: Int -&gt; TcType -&gt; TcM Coercion
</span><a href="#local-6989586621683019084"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span id="local-6989586621683019085"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019085"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; TcM Coercion
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019085"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2870"></span><span>
</span><span id="line-2871"></span><span>    </span><span class="annot"><a href="#local-6989586621683019084"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683019086"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683019086"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621683019087"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019087"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683019088"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019088"><span class="hs-identifier hs-var">k'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe TcType
</span><a href="GHC.Core.Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019087"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; TcType -&gt; TcM Coercion
</span><a href="#local-6989586621683019084"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683019086"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019088"><span class="hs-identifier hs-var">k'</span></a></span><span>
</span><span id="line-2872"></span><span>
</span><span id="line-2873"></span><span>    </span><span class="annot"><a href="#local-6989586621683019084"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683019089"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683019089"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621683019090"><span class="annot"><span class="annottext">k :: TcType
</span><a href="#local-6989586621683019090"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyVarTy"><span class="hs-identifier hs-type">TyVarTy</span></a></span><span> </span><span id="local-6989586621683019091"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019091"><span class="hs-identifier hs-var">kvar</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2874"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isMetaTyVar"><span class="hs-identifier hs-var">isMetaTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019091"><span class="hs-identifier hs-var">kvar</span></a></span><span>
</span><span id="line-2875"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683019092"><span class="annot"><a href="#local-6989586621683019092"><span class="hs-identifier hs-var">maybe_kind</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; IOEnv (Env TcGblEnv TcLclEnv) MetaDetails
forall (m :: * -&gt; *). MonadIO m =&gt; TcTyVar -&gt; m MetaDetails
</span><a href="GHC.Tc.Utils.TcMType.html#readMetaTyVar"><span class="hs-identifier hs-var">readMetaTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019091"><span class="hs-identifier hs-var">kvar</span></a></span><span>
</span><span id="line-2876"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683019092"><span class="hs-identifier hs-type">maybe_kind</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2877"></span><span>                </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#Indirect"><span class="hs-identifier hs-type">Indirect</span></a></span><span> </span><span id="local-6989586621683019093"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019093"><span class="hs-identifier hs-var">fun_kind</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; TcType -&gt; TcM Coercion
</span><a href="#local-6989586621683019084"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683019089"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019093"><span class="hs-identifier hs-var">fun_kind</span></a></span><span>
</span><span id="line-2878"></span><span>                </span><span class="annot"><span class="annottext">MetaDetails
</span><a href="GHC.Tc.Utils.TcType.html#Flexi"><span class="hs-identifier hs-var">Flexi</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>             </span><span class="annot"><span class="annottext">Int -&gt; TcType -&gt; TcM Coercion
</span><a href="#local-6989586621683019094"><span class="hs-identifier hs-var">defer</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683019089"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019090"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2879"></span><span>
</span><span id="line-2880"></span><span>    </span><span class="annot"><a href="#local-6989586621683019084"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683019095"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683019095"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#FunTy"><span class="hs-identifier hs-type">FunTy</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ft_af :: TcType -&gt; FunTyFlag
</span><a href="GHC.Core.TyCo.Rep.html#ft_af"><span class="hs-identifier hs-var">ft_af</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683019096"><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683019096"><span class="hs-identifier hs-var">af</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_mult :: TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#ft_mult"><span class="hs-identifier hs-var">ft_mult</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683019097"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019097"><span class="hs-identifier hs-var">w</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_arg :: TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#ft_arg"><span class="hs-identifier hs-var">ft_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683019098"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019098"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_res :: TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#ft_res"><span class="hs-identifier hs-var">ft_res</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683019099"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019099"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2881"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">FunTyFlag -&gt; Bool
</span><a href="GHC.Types.Var.html#isVisibleFunArg"><span class="hs-identifier hs-var">isVisibleFunArg</span></a></span><span> </span><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683019096"><span class="hs-identifier hs-var">af</span></a></span><span>
</span><span id="line-2882"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683019100"><span class="annot"><a href="#local-6989586621683019100"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; TcType -&gt; TcM Coercion
</span><a href="#local-6989586621683019084"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683019095"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019099"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-2883"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.html#mkNakedFunCo"><span class="hs-identifier hs-type">mkNakedFunCo</span></a></span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-type">Nominal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019096"><span class="hs-identifier hs-type">af</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-type">mkNomReflCo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019097"><span class="hs-identifier hs-type">w</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-type">mkNomReflCo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019098"><span class="hs-identifier hs-type">arg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683019100"><span class="hs-identifier hs-type">co</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2884"></span><span>
</span><span id="line-2885"></span><span>    </span><span class="annot"><a href="#local-6989586621683019084"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683019101"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683019101"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621683019102"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019102"><span class="hs-identifier hs-var">other</span></a></span></span><span>
</span><span id="line-2886"></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; TcType -&gt; TcM Coercion
</span><a href="#local-6989586621683019094"><span class="hs-identifier hs-var">defer</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683019101"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019102"><span class="hs-identifier hs-var">other</span></a></span><span>
</span><span id="line-2887"></span><span>
</span><span id="line-2888"></span><span>    </span><span id="local-6989586621683019094"><span class="annot"><span class="annottext">defer :: Int -&gt; TcType -&gt; TcM Coercion
</span><a href="#local-6989586621683019094"><span class="hs-identifier hs-var hs-var">defer</span></a></span></span><span> </span><span id="local-6989586621683019103"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683019103"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621683019104"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019104"><span class="hs-identifier hs-var">k</span></a></span></span><span>
</span><span id="line-2889"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683019105"><span class="annot"><a href="#local-6989586621683019105"><span class="hs-identifier hs-var">arg_kinds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; TcM [TcType]
</span><a href="GHC.Tc.Utils.TcMType.html#newMetaKindVars"><span class="hs-identifier hs-var">newMetaKindVars</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683019103"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-2890"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683019107"><span class="annot"><a href="#local-6989586621683019107"><span class="hs-identifier hs-var">res_kind</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#newMetaKindVar"><span class="hs-identifier hs-type">newMetaKindVar</span></a></span><span>
</span><span id="line-2891"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683019109"><span class="annot"><a href="#local-6989586621683019109"><span class="hs-identifier hs-var hs-var">new_fun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#mkVisFunTysMany"><span class="hs-identifier hs-var">mkVisFunTysMany</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683019105"><span class="hs-identifier hs-var">arg_kinds</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019107"><span class="hs-identifier hs-var">res_kind</span></a></span><span>
</span><span id="line-2892"></span><span>                 </span><span id="local-6989586621683019111"><span class="annot"><a href="#local-6989586621683019111"><span class="hs-identifier hs-var hs-var">origin</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#TypeEqOrigin"><span class="hs-identifier hs-type">TypeEqOrigin</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">uo_actual :: TcType
</span><a href="GHC.Tc.Types.Origin.html#uo_actual"><span class="hs-identifier hs-var">uo_actual</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019104"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-2893"></span><span>                                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uo_expected :: TcType
</span><a href="GHC.Tc.Types.Origin.html#uo_expected"><span class="hs-identifier hs-var">uo_expected</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019109"><span class="hs-identifier hs-var">new_fun</span></a></span><span>
</span><span id="line-2894"></span><span>                                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uo_thing :: Maybe TypedThing
</span><a href="GHC.Tc.Types.Origin.html#uo_thing"><span class="hs-identifier hs-var">uo_thing</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypedThing -&gt; Maybe TypedThing
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">TypedThing
</span><a href="#local-6989586621683019081"><span class="hs-identifier hs-var">hs_ty</span></a></span><span>
</span><span id="line-2895"></span><span>                                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uo_visible :: Bool
</span><a href="GHC.Tc.Types.Origin.html#uo_visible"><span class="hs-identifier hs-var">uo_visible</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-2896"></span><span>                                        </span><span class="hs-special">}</span><span>
</span><span id="line-2897"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#unifyTypeAndEmit"><span class="hs-identifier hs-type">unifyTypeAndEmit</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#KindLevel"><span class="hs-identifier hs-type">KindLevel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019111"><span class="hs-identifier hs-type">origin</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019104"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019109"><span class="hs-identifier hs-type">new_fun</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2898"></span><span>
</span><span id="line-2899"></span><span class="annot"><span class="hs-comment">{- *********************************************************************
*                                                                      *
                 Checking alpha ~ ty
              for the on-the-fly unifier
*                                                                      *
********************************************************************* -}</span></span><span>
</span><span id="line-2905"></span><span>
</span><span id="line-2906"></span><span class="hs-keyword">data</span><span> </span><span id="UnifyCheckCaller"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#UnifyCheckCaller"><span class="hs-identifier hs-var">UnifyCheckCaller</span></a></span></span><span>
</span><span id="line-2907"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="UC_OnTheFly"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#UC_OnTheFly"><span class="hs-identifier hs-var">UC_OnTheFly</span></a></span></span><span>   </span><span class="hs-comment">-- Called from the on-the-fly unifier</span><span>
</span><span id="line-2908"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="UC_QuickLook"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#UC_QuickLook"><span class="hs-identifier hs-var">UC_QuickLook</span></a></span></span><span>  </span><span class="hs-comment">-- Called from Quick Look</span><span>
</span><span id="line-2909"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="UC_Solver"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#UC_Solver"><span class="hs-identifier hs-var">UC_Solver</span></a></span></span><span>     </span><span class="hs-comment">-- Called from constraint solver</span><span>
</span><span id="line-2910"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="UC_Defaulting"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#UC_Defaulting"><span class="hs-identifier hs-var">UC_Defaulting</span></a></span></span><span> </span><span class="hs-comment">-- Called when doing top-level defaulting</span><span>
</span><span id="line-2911"></span><span>
</span><span id="line-2912"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#simpleUnifyCheck"><span class="hs-identifier hs-type">simpleUnifyCheck</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#UnifyCheckCaller"><span class="hs-identifier hs-type">UnifyCheckCaller</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-2913"></span><span class="hs-comment">-- simpleUnifyCheck does a fast check: True &lt;=&gt; unification is OK</span><span>
</span><span id="line-2914"></span><span class="hs-comment">-- If it says 'False' then unification might still be OK, but</span><span>
</span><span id="line-2915"></span><span class="hs-comment">-- it'll take more work to do -- use the full checkTypeEq</span><span>
</span><span id="line-2916"></span><span class="hs-comment">--</span><span>
</span><span id="line-2917"></span><span class="annot"><span class="hs-comment">-- * Rejects if lhs_tv occurs in rhs_ty (occurs check)</span></span><span>
</span><span id="line-2918"></span><span class="annot"><span class="hs-comment">-- * Rejects foralls unless</span></span><span>
</span><span id="line-2919"></span><span class="hs-comment">--      lhs_tv is RuntimeUnk (used by GHCi debugger)</span><span>
</span><span id="line-2920"></span><span class="hs-comment">--          or is a QL instantiation variable</span><span>
</span><span id="line-2921"></span><span class="annot"><span class="hs-comment">-- * Rejects a non-concrete type if lhs_tv is concrete</span></span><span>
</span><span id="line-2922"></span><span class="annot"><span class="hs-comment">-- * Rejects type families unless fam_ok=True</span></span><span>
</span><span id="line-2923"></span><span class="annot"><span class="hs-comment">-- * Does a level-check for type variables, to avoid skolem escape</span></span><span>
</span><span id="line-2924"></span><span class="hs-comment">--</span><span>
</span><span id="line-2925"></span><span class="hs-comment">-- This function is pretty heavily used, so it's optimised not to allocate</span><span>
</span><span id="line-2926"></span><span id="simpleUnifyCheck"><span class="annot"><span class="annottext">simpleUnifyCheck :: UnifyCheckCaller -&gt; TcTyVar -&gt; TcType -&gt; Bool
</span><a href="GHC.Tc.Utils.Unify.html#simpleUnifyCheck"><span class="hs-identifier hs-var hs-var">simpleUnifyCheck</span></a></span></span><span> </span><span id="local-6989586621683019115"><span class="annot"><span class="annottext">UnifyCheckCaller
</span><a href="#local-6989586621683019115"><span class="hs-identifier hs-var">caller</span></a></span></span><span> </span><span id="local-6989586621683019116"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019116"><span class="hs-identifier hs-var">lhs_tv</span></a></span></span><span> </span><span id="local-6989586621683019117"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019117"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-2927"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="#local-6989586621683019118"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019117"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-2928"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2929"></span><span>
</span><span id="line-2930"></span><span>    </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span id="local-6989586621683019119"><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="#local-6989586621683019119"><span class="hs-identifier hs-var">occ_in_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683019120"><span class="annot"><span class="annottext">Coercion -&gt; Bool
</span><a href="#local-6989586621683019120"><span class="hs-identifier hs-var">occ_in_co</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; (TcType -&gt; Bool, Coercion -&gt; Bool)
</span><a href="GHC.Tc.Utils.Unify.html#mkOccFolders"><span class="hs-identifier hs-var">mkOccFolders</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019116"><span class="hs-identifier hs-var">lhs_tv</span></a></span><span>
</span><span id="line-2931"></span><span>
</span><span id="line-2932"></span><span>    </span><span id="local-6989586621683019122"><span class="annot"><span class="annottext">lhs_tv_lvl :: TcLevel
</span><a href="#local-6989586621683019122"><span class="hs-identifier hs-var hs-var">lhs_tv_lvl</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcLevel
</span><a href="GHC.Tc.Utils.TcType.html#tcTyVarLevel"><span class="hs-identifier hs-var">tcTyVarLevel</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019116"><span class="hs-identifier hs-var">lhs_tv</span></a></span><span>
</span><span id="line-2933"></span><span>    </span><span id="local-6989586621683019123"><span class="annot"><span class="annottext">lhs_tv_is_concrete :: Bool
</span><a href="#local-6989586621683019123"><span class="hs-identifier hs-var hs-var">lhs_tv_is_concrete</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isConcreteTyVar"><span class="hs-identifier hs-var">isConcreteTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019116"><span class="hs-identifier hs-var">lhs_tv</span></a></span><span>
</span><span id="line-2934"></span><span>
</span><span id="line-2935"></span><span>    </span><span id="local-6989586621683019125"><span class="annot"><span class="annottext">forall_ok :: Bool
</span><a href="#local-6989586621683019125"><span class="hs-identifier hs-var hs-var">forall_ok</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">UnifyCheckCaller
</span><a href="#local-6989586621683019115"><span class="hs-identifier hs-var">caller</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2936"></span><span>                   </span><span class="annot"><span class="annottext">UnifyCheckCaller
</span><a href="GHC.Tc.Utils.Unify.html#UC_QuickLook"><span class="hs-identifier hs-var">UC_QuickLook</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isQLInstTyVar"><span class="hs-identifier hs-var">isQLInstTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019116"><span class="hs-identifier hs-var">lhs_tv</span></a></span><span>
</span><span id="line-2937"></span><span>                   </span><span class="annot"><span class="annottext">UnifyCheckCaller
</span><span class="hs-identifier">_</span></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isRuntimeUnkTyVar"><span class="hs-identifier hs-var">isRuntimeUnkTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019116"><span class="hs-identifier hs-var">lhs_tv</span></a></span><span>
</span><span id="line-2938"></span><span>
</span><span id="line-2939"></span><span>    </span><span class="hs-comment">-- This fam_ok thing relates to a very specific perf problem</span><span>
</span><span id="line-2940"></span><span>    </span><span class="hs-comment">-- See Note [Prevent unification with type families]</span><span>
</span><span id="line-2941"></span><span>    </span><span class="hs-comment">-- A couple of QuickLook regression tests rely on unifying with type</span><span>
</span><span id="line-2942"></span><span>    </span><span class="hs-comment">--   families, so we let it through there (not very principled, but let's</span><span>
</span><span id="line-2943"></span><span>    </span><span class="hs-comment">--   see if it bites us)</span><span>
</span><span id="line-2944"></span><span>    </span><span id="local-6989586621683019128"><span class="annot"><span class="annottext">fam_ok :: Bool
</span><a href="#local-6989586621683019128"><span class="hs-identifier hs-var hs-var">fam_ok</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">UnifyCheckCaller
</span><a href="#local-6989586621683019115"><span class="hs-identifier hs-var">caller</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2945"></span><span>               </span><span class="annot"><span class="annottext">UnifyCheckCaller
</span><a href="GHC.Tc.Utils.Unify.html#UC_Solver"><span class="hs-identifier hs-var">UC_Solver</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-2946"></span><span>               </span><span class="annot"><span class="annottext">UnifyCheckCaller
</span><a href="GHC.Tc.Utils.Unify.html#UC_QuickLook"><span class="hs-identifier hs-var">UC_QuickLook</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-2947"></span><span>               </span><span class="annot"><span class="annottext">UnifyCheckCaller
</span><a href="GHC.Tc.Utils.Unify.html#UC_OnTheFly"><span class="hs-identifier hs-var">UC_OnTheFly</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-2948"></span><span>               </span><span class="annot"><span class="annottext">UnifyCheckCaller
</span><a href="GHC.Tc.Utils.Unify.html#UC_Defaulting"><span class="hs-identifier hs-var">UC_Defaulting</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-2949"></span><span>
</span><span id="line-2950"></span><span>    </span><span id="local-6989586621683019118"><span class="annot"><span class="annottext">go :: TcType -&gt; Bool
</span><a href="#local-6989586621683019118"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyVarTy"><span class="hs-identifier hs-type">TyVarTy</span></a></span><span> </span><span id="local-6989586621683019129"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019129"><span class="hs-identifier hs-var">tv</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2951"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019116"><span class="hs-identifier hs-var">lhs_tv</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcTyVar -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019129"><span class="hs-identifier hs-var">tv</span></a></span><span>                                    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-2952"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcLevel
</span><a href="GHC.Tc.Utils.TcType.html#tcTyVarLevel"><span class="hs-identifier hs-var">tcTyVarLevel</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019129"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel -&gt; TcLevel -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#strictlyDeeperThan"><span class="hs-operator hs-var">`strictlyDeeperThan`</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019122"><span class="hs-identifier hs-var">lhs_tv_lvl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-2953"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683019123"><span class="hs-identifier hs-var">lhs_tv_is_concrete</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isConcreteTyVar"><span class="hs-identifier hs-var">isConcreteTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019129"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-2954"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="#local-6989586621683019119"><span class="hs-identifier hs-var">occ_in_ty</span></a></span><span> </span><span class="annot"><span class="annottext">(TcType -&gt; Bool) -&gt; TcType -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType
</span><a href="GHC.Types.Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019129"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-2955"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                                       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-2956"></span><span>
</span><span id="line-2957"></span><span>    </span><span class="annot"><a href="#local-6989586621683019118"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#FunTy"><span class="hs-identifier hs-type">FunTy</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">ft_af :: TcType -&gt; FunTyFlag
</span><a href="GHC.Core.TyCo.Rep.html#ft_af"><span class="hs-identifier hs-var">ft_af</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683019131"><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683019131"><span class="hs-identifier hs-var">af</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_mult :: TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#ft_mult"><span class="hs-identifier hs-var">ft_mult</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683019132"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019132"><span class="hs-identifier hs-var">w</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_arg :: TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#ft_arg"><span class="hs-identifier hs-var">ft_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683019133"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019133"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_res :: TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#ft_res"><span class="hs-identifier hs-var">ft_res</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683019134"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019134"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2958"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683019125"><span class="hs-identifier hs-var">forall_ok</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FunTyFlag -&gt; Bool
</span><a href="GHC.Types.Var.html#isInvisibleFunArg"><span class="hs-identifier hs-var">isInvisibleFunArg</span></a></span><span> </span><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683019131"><span class="hs-identifier hs-var">af</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-2959"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="#local-6989586621683019118"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019132"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="#local-6989586621683019118"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019133"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="#local-6989586621683019118"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019134"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-2960"></span><span>
</span><span id="line-2961"></span><span>    </span><span class="annot"><a href="#local-6989586621683019118"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyConApp"><span class="hs-identifier hs-type">TyConApp</span></a></span><span> </span><span id="local-6989586621683019136"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683019136"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621683019137"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683019137"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2962"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683019123"><span class="hs-identifier hs-var">lhs_tv_is_concrete</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isConcreteTyCon"><span class="hs-identifier hs-var">isConcreteTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683019136"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-2963"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683019125"><span class="hs-identifier hs-var">forall_ok</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isTauTyCon"><span class="hs-identifier hs-var">isTauTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683019136"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-2964"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683019128"><span class="hs-identifier hs-var">fam_ok</span></a></span><span class="hs-special">,</span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isFamFreeTyCon"><span class="hs-identifier hs-var">isFamFreeTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683019136"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-2965"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                                    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TcType -&gt; Bool) -&gt; [TcType] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="#local-6989586621683019118"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683019137"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-2966"></span><span>
</span><span id="line-2967"></span><span>    </span><span class="annot"><a href="#local-6989586621683019118"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ForAllTy"><span class="hs-identifier hs-type">ForAllTy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Bndr"><span class="hs-identifier hs-type">Bndr</span></a></span><span> </span><span id="local-6989586621683019143"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019143"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621683019144"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019144"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2968"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683019125"><span class="hs-identifier hs-var">forall_ok</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="#local-6989586621683019118"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType
</span><a href="GHC.Types.Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019143"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019143"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcTyVar -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019116"><span class="hs-identifier hs-var">lhs_tv</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="#local-6989586621683019118"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019144"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2969"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-2970"></span><span>
</span><span id="line-2971"></span><span>    </span><span class="annot"><a href="#local-6989586621683019118"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#AppTy"><span class="hs-identifier hs-type">AppTy</span></a></span><span> </span><span id="local-6989586621683019145"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019145"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621683019146"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019146"><span class="hs-identifier hs-var">t2</span></a></span></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="#local-6989586621683019118"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019145"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="#local-6989586621683019118"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019146"><span class="hs-identifier hs-var">t2</span></a></span><span>
</span><span id="line-2972"></span><span>    </span><span class="annot"><a href="#local-6989586621683019118"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CastTy"><span class="hs-identifier hs-type">CastTy</span></a></span><span> </span><span id="local-6989586621683019147"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019147"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621683019148"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683019148"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; Bool
</span><a href="#local-6989586621683019120"><span class="hs-identifier hs-var">occ_in_co</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683019148"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="#local-6989586621683019118"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019147"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2973"></span><span>    </span><span class="annot"><a href="#local-6989586621683019118"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionTy"><span class="hs-identifier hs-type">CoercionTy</span></a></span><span> </span><span id="local-6989586621683019149"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683019149"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; Bool
</span><a href="#local-6989586621683019120"><span class="hs-identifier hs-var">occ_in_co</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683019149"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2974"></span><span>    </span><span class="annot"><a href="#local-6989586621683019118"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#LitTy"><span class="hs-identifier hs-type">LitTy</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-2975"></span><span>
</span><span id="line-2976"></span><span>
</span><span id="line-2977"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#mkOccFolders"><span class="hs-identifier hs-type">mkOccFolders</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#TcCoercion"><span class="hs-identifier hs-type">TcCoercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span>
</span><span id="line-2978"></span><span class="hs-comment">-- These functions return True</span><span>
</span><span id="line-2979"></span><span class="hs-comment">--   * if lhs_tv occurs (incl deeply, in the kind of variable)</span><span>
</span><span id="line-2980"></span><span class="hs-comment">--   * if there is a coercion hole</span><span>
</span><span id="line-2981"></span><span class="hs-comment">-- No expansion of type synonyms</span><span>
</span><span id="line-2982"></span><span id="mkOccFolders"><span class="annot"><span class="annottext">mkOccFolders :: TcTyVar -&gt; (TcType -&gt; Bool, Coercion -&gt; Bool)
</span><a href="GHC.Tc.Utils.Unify.html#mkOccFolders"><span class="hs-identifier hs-var hs-var">mkOccFolders</span></a></span></span><span> </span><span id="local-6989586621683019150"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019150"><span class="hs-identifier hs-var">lhs_tv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Any -&gt; Bool
</span><span class="hs-identifier hs-var">getAny</span></span><span> </span><span class="annot"><span class="annottext">(Any -&gt; Bool) -&gt; (TcType -&gt; Any) -&gt; TcType -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Any
</span><a href="#local-6989586621683019152"><span class="hs-identifier hs-var">check_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Any -&gt; Bool
</span><span class="hs-identifier hs-var">getAny</span></span><span> </span><span class="annot"><span class="annottext">(Any -&gt; Bool) -&gt; (Coercion -&gt; Any) -&gt; Coercion -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Any
</span><a href="#local-6989586621683019153"><span class="hs-identifier hs-var">check_co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2983"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2984"></span><span>    </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span id="local-6989586621683019152"><span class="annot"><span class="annottext">TcType -&gt; Any
</span><a href="#local-6989586621683019152"><span class="hs-identifier hs-var">check_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; Any
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683019153"><span class="annot"><span class="annottext">Coercion -&gt; Any
</span><a href="#local-6989586621683019153"><span class="hs-identifier hs-var">check_co</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MultiplicityCheckCoercions -&gt; Any
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCoFolder VarSet Any
-&gt; VarSet
-&gt; (TcType -&gt; Any, [TcType] -&gt; Any, Coercion -&gt; Any,
    MultiplicityCheckCoercions -&gt; Any)
forall a env.
Monoid a =&gt;
TyCoFolder env a
-&gt; env
-&gt; (TcType -&gt; a, [TcType] -&gt; a, Coercion -&gt; a,
    MultiplicityCheckCoercions -&gt; a)
</span><a href="GHC.Core.TyCo.Rep.html#foldTyCo"><span class="hs-identifier hs-var">foldTyCo</span></a></span><span> </span><span class="annot"><span class="annottext">TyCoFolder VarSet Any
</span><a href="#local-6989586621683019155"><span class="hs-identifier hs-var">occ_folder</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="GHC.Types.Var.Set.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a></span><span>
</span><span id="line-2985"></span><span>    </span><span id="local-6989586621683019155"><span class="annot"><span class="annottext">occ_folder :: TyCoFolder VarSet Any
</span><a href="#local-6989586621683019155"><span class="hs-identifier hs-var hs-var">occ_folder</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyCoFolder"><span class="hs-identifier hs-type">TyCoFolder</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">tcf_view :: TcType -&gt; Maybe TcType
</span><a href="GHC.Core.TyCo.Rep.html#tcf_view"><span class="hs-identifier hs-var">tcf_view</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe TcType
</span><a href="GHC.Core.TyCo.Rep.html#noView"><span class="hs-identifier hs-var">noView</span></a></span><span>  </span><span class="hs-comment">-- Don't expand synonyms</span><span>
</span><span id="line-2986"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tcf_tyvar :: VarSet -&gt; TcTyVar -&gt; Any
</span><a href="GHC.Core.TyCo.Rep.html#tcf_tyvar"><span class="hs-identifier hs-var">tcf_tyvar</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; TcTyVar -&gt; Any
</span><a href="#local-6989586621683019161"><span class="hs-identifier hs-var">do_tcv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tcf_covar :: VarSet -&gt; TcTyVar -&gt; Any
</span><a href="GHC.Core.TyCo.Rep.html#tcf_covar"><span class="hs-identifier hs-var">tcf_covar</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; TcTyVar -&gt; Any
</span><a href="#local-6989586621683019161"><span class="hs-identifier hs-var">do_tcv</span></a></span><span>
</span><span id="line-2987"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tcf_hole :: VarSet -&gt; CoercionHole -&gt; Any
</span><a href="GHC.Core.TyCo.Rep.html#tcf_hole"><span class="hs-identifier hs-var">tcf_hole</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; CoercionHole -&gt; Any
forall {p} {p}. p -&gt; p -&gt; Any
</span><a href="#local-6989586621683019164"><span class="hs-identifier hs-var">do_hole</span></a></span><span>
</span><span id="line-2988"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tcf_tycobinder :: VarSet -&gt; TcTyVar -&gt; ForAllTyFlag -&gt; VarSet
</span><a href="GHC.Core.TyCo.Rep.html#tcf_tycobinder"><span class="hs-identifier hs-var">tcf_tycobinder</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; TcTyVar -&gt; ForAllTyFlag -&gt; VarSet
forall {p}. VarSet -&gt; TcTyVar -&gt; p -&gt; VarSet
</span><a href="#local-6989586621683019166"><span class="hs-identifier hs-var">do_bndr</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2989"></span><span>
</span><span id="line-2990"></span><span>    </span><span id="local-6989586621683019161"><span class="annot"><span class="annottext">do_tcv :: VarSet -&gt; TcTyVar -&gt; Any
</span><a href="#local-6989586621683019161"><span class="hs-identifier hs-var hs-var">do_tcv</span></a></span></span><span> </span><span id="local-6989586621683019167"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683019167"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span id="local-6989586621683019168"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019168"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Any
</span><span class="hs-identifier hs-var">Any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019168"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683019167"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019168"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcTyVar -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019150"><span class="hs-identifier hs-var">lhs_tv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2991"></span><span>                  </span><span class="annot"><span class="annottext">Any -&gt; Any -&gt; Any
forall a. Monoid a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`mappend`</span></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Any
</span><a href="#local-6989586621683019152"><span class="hs-identifier hs-var">check_ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType
</span><a href="GHC.Types.Var.html#varType"><span class="hs-identifier hs-var">varType</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019168"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2992"></span><span>
</span><span id="line-2993"></span><span>    </span><span id="local-6989586621683019166"><span class="annot"><span class="annottext">do_bndr :: VarSet -&gt; TcTyVar -&gt; p -&gt; VarSet
</span><a href="#local-6989586621683019166"><span class="hs-identifier hs-var hs-var">do_bndr</span></a></span></span><span> </span><span id="local-6989586621683019172"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683019172"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span id="local-6989586621683019173"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019173"><span class="hs-identifier hs-var">tcv</span></a></span></span><span> </span><span id="local-6989586621683019174"><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621683019174"><span class="hs-identifier hs-var">_faf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; TcTyVar -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#extendVarSet"><span class="hs-identifier hs-var">extendVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683019172"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019173"><span class="hs-identifier hs-var">tcv</span></a></span><span>
</span><span id="line-2994"></span><span>    </span><span id="local-6989586621683019164"><span class="annot"><span class="annottext">do_hole :: p -&gt; p -&gt; Any
</span><a href="#local-6989586621683019164"><span class="hs-identifier hs-var hs-var">do_hole</span></a></span></span><span> </span><span id="local-6989586621683019176"><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621683019176"><span class="hs-identifier hs-var">_is</span></a></span></span><span> </span><span id="local-6989586621683019177"><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621683019177"><span class="hs-identifier hs-var">_hole</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Any
</span><span class="hs-identifier hs-var">DM.Any</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>  </span><span class="hs-comment">-- Reject coercion holes</span><span>
</span><span id="line-2995"></span><span>
</span><span id="line-2996"></span><span class="annot"><span class="hs-comment">{- *********************************************************************
*                                                                      *
                 Equality invariant checking
*                                                                      *
********************************************************************* -}</span></span><span>
</span><span id="line-3001"></span><span>
</span><span id="line-3002"></span><span>
</span><span id="line-3003"></span><span class="hs-comment">{-  Note [Checking for foralls]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We never want to unify
    alpha ~ (forall a. a-&gt;a) -&gt; Int
So we look for foralls hidden inside the type, and it's convenient
to do that at the same time as the occurs check (which looks for
occurrences of alpha).

However, it's not just a question of looking for foralls /anywhere/!
Consider
   (alpha :: forall k. k-&gt;*)  ~  (beta :: forall k. k-&gt;*)
This is legal; e.g. dependent/should_compile/T11635.

We don't want to reject it because of the forall in beta's kind, but
(see Note [Occurrence checking: look inside kinds] in GHC.Core.Type)
we do need to look in beta's kind.  So we carry a flag saying if a
'forall' is OK, and switch the flag on when stepping inside a kind.

Why is it OK?  Why does it not count as impredicative polymorphism?
The reason foralls are bad is because we reply on &quot;seeing&quot; foralls
when doing implicit instantiation.  But the forall inside the kind is
fine.  We'll generate a kind equality constraint
  (forall k. k-&gt;*) ~ (forall k. k-&gt;*)
to check that the kinds of lhs and rhs are compatible.  If alpha's
kind had instead been
  (alpha :: kappa)
then this kind equality would rightly complain about unifying kappa
with (forall k. k-&gt;*)

Note [Forgetful synonyms in checkTyConApp]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
   type S a b = b   -- Forgets 'a'

   [W] alpha[2] ~ Maybe (S beta[4] gamma[2])

We don't want to promote beta to level 2; rather, we should
expand the synonym. (Currently, in checkTypeEqRhs promotion
is irrevocable, by side effect.)

To avoid this risk we eagerly expand forgetful synonyms.
This also means we won't get an occurs check in
   a ~ Maybe (S a b)

The annoyance is that we might expand the synonym unnecessarily,
something we generally try to avoid.  But for now, this seems
simple.

In a forgetful case like a ~ Maybe (S a b), `checkTyEqRhs` returns
a Reduction that looks
    Reduction { reductionCoercion    = Refl
              , reductionReducedType = Maybe b }
We must jolly well use that reductionReduced type, even though the
reductionCoercion is Refl.  See `canEqCanLHSFinish_no_unification`.
-}</span><span>
</span><span id="line-3058"></span><span>
</span><span id="line-3059"></span><span class="hs-keyword">data</span><span> </span><span id="PuResult"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuResult"><span class="hs-identifier hs-var">PuResult</span></a></span></span><span> </span><span id="local-6989586621683017313"><span class="annot"><a href="#local-6989586621683017313"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621683017314"><span class="annot"><a href="#local-6989586621683017314"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PuFail"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuFail"><span class="hs-identifier hs-var">PuFail</span></a></span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CheckTyEqResult"><span class="hs-identifier hs-type">CheckTyEqResult</span></a></span><span>
</span><span id="line-3060"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span id="PuOK"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuOK"><span class="hs-identifier hs-var">PuOK</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017313"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683017314"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-3061"></span><span>
</span><span id="line-3062"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621683017310"><span id="local-6989586621683019182"><span class="annot"><span class="hs-identifier hs-type">Functor</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuResult"><span class="hs-identifier hs-type">PuResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017310"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-3063"></span><span>  </span><span id="local-6989586621683019186"><span class="annot"><span class="annottext">fmap :: forall a b. (a -&gt; b) -&gt; PuResult a a -&gt; PuResult a b
</span><span class="hs-identifier hs-var hs-var hs-var">fmap</span></span></span><span> </span><span class="annot"><span class="annottext">a -&gt; b
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuFail"><span class="hs-identifier hs-type">PuFail</span></a></span><span> </span><span id="local-6989586621683019187"><span class="annot"><span class="annottext">CheckTyEqResult
</span><a href="#local-6989586621683019187"><span class="hs-identifier hs-var">prob</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult -&gt; PuResult a b
forall a b. CheckTyEqResult -&gt; PuResult a b
</span><a href="GHC.Tc.Utils.Unify.html#PuFail"><span class="hs-identifier hs-var">PuFail</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult
</span><a href="#local-6989586621683019187"><span class="hs-identifier hs-var">prob</span></a></span><span>
</span><span id="line-3064"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">fmap</span></span><span> </span><span id="local-6989586621683019188"><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621683019188"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuOK"><span class="hs-identifier hs-type">PuOK</span></a></span><span> </span><span id="local-6989586621683019189"><span class="annot"><span class="annottext">Bag a
</span><a href="#local-6989586621683019189"><span class="hs-identifier hs-var">cts</span></a></span></span><span> </span><span id="local-6989586621683019190"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683019190"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bag a -&gt; b -&gt; PuResult a b
forall a b. Bag a -&gt; b -&gt; PuResult a b
</span><a href="GHC.Tc.Utils.Unify.html#PuOK"><span class="hs-identifier hs-var">PuOK</span></a></span><span> </span><span class="annot"><span class="annottext">Bag a
</span><a href="#local-6989586621683019189"><span class="hs-identifier hs-var">cts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621683019188"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683019190"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3065"></span><span>
</span><span id="line-3066"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621683017327"><span id="local-6989586621683019196"><span id="local-6989586621683019200"><span id="local-6989586621683019203"><span class="annot"><span class="hs-identifier hs-type">Applicative</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuResult"><span class="hs-identifier hs-type">PuResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017327"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-3067"></span><span>  </span><span id="local-6989586621683019206"><span class="annot"><span class="annottext">pure :: forall a. a -&gt; PuResult a a
</span><span class="hs-identifier hs-var hs-var hs-var">pure</span></span></span><span> </span><span id="local-6989586621683019207"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683019207"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bag a -&gt; a -&gt; PuResult a a
forall a b. Bag a -&gt; b -&gt; PuResult a b
</span><a href="GHC.Tc.Utils.Unify.html#PuOK"><span class="hs-identifier hs-var">PuOK</span></a></span><span> </span><span class="annot"><span class="annottext">Bag a
forall a. Bag a
</span><a href="GHC.Data.Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683019207"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-3068"></span><span>  </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuFail"><span class="hs-identifier hs-type">PuFail</span></a></span><span> </span><span id="local-6989586621683019210"><span class="annot"><span class="annottext">CheckTyEqResult
</span><a href="#local-6989586621683019210"><span class="hs-identifier hs-var">p1</span></a></span></span><span> </span><span id="local-6989586621683019211"><span class="annot"><span class="annottext">&lt;*&gt; :: forall a b. PuResult a (a -&gt; b) -&gt; PuResult a a -&gt; PuResult a b
</span><span class="hs-operator hs-var hs-var hs-var">&lt;*&gt;</span></span></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuFail"><span class="hs-identifier hs-type">PuFail</span></a></span><span> </span><span id="local-6989586621683019212"><span class="annot"><span class="annottext">CheckTyEqResult
</span><a href="#local-6989586621683019212"><span class="hs-identifier hs-var">p2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult -&gt; PuResult a b
forall a b. CheckTyEqResult -&gt; PuResult a b
</span><a href="GHC.Tc.Utils.Unify.html#PuFail"><span class="hs-identifier hs-var">PuFail</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CheckTyEqResult
</span><a href="#local-6989586621683019210"><span class="hs-identifier hs-var">p1</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult -&gt; CheckTyEqResult -&gt; CheckTyEqResult
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">S.&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult
</span><a href="#local-6989586621683019212"><span class="hs-identifier hs-var">p2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3069"></span><span>  </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuFail"><span class="hs-identifier hs-type">PuFail</span></a></span><span> </span><span id="local-6989586621683019213"><span class="annot"><span class="annottext">CheckTyEqResult
</span><a href="#local-6989586621683019213"><span class="hs-identifier hs-var">p1</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuOK"><span class="hs-identifier hs-type">PuOK</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult -&gt; PuResult a b
forall a b. CheckTyEqResult -&gt; PuResult a b
</span><a href="GHC.Tc.Utils.Unify.html#PuFail"><span class="hs-identifier hs-var">PuFail</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult
</span><a href="#local-6989586621683019213"><span class="hs-identifier hs-var">p1</span></a></span><span>
</span><span id="line-3070"></span><span>  </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuOK"><span class="hs-identifier hs-type">PuOK</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>   </span><span class="annot"><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuFail"><span class="hs-identifier hs-type">PuFail</span></a></span><span> </span><span id="local-6989586621683019214"><span class="annot"><span class="annottext">CheckTyEqResult
</span><a href="#local-6989586621683019214"><span class="hs-identifier hs-var">p2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult -&gt; PuResult a b
forall a b. CheckTyEqResult -&gt; PuResult a b
</span><a href="GHC.Tc.Utils.Unify.html#PuFail"><span class="hs-identifier hs-var">PuFail</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult
</span><a href="#local-6989586621683019214"><span class="hs-identifier hs-var">p2</span></a></span><span>
</span><span id="line-3071"></span><span>  </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuOK"><span class="hs-identifier hs-type">PuOK</span></a></span><span> </span><span id="local-6989586621683019215"><span class="annot"><span class="annottext">Bag a
</span><a href="#local-6989586621683019215"><span class="hs-identifier hs-var">c1</span></a></span></span><span> </span><span id="local-6989586621683019216"><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621683019216"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuOK"><span class="hs-identifier hs-type">PuOK</span></a></span><span> </span><span id="local-6989586621683019217"><span class="annot"><span class="annottext">Bag a
</span><a href="#local-6989586621683019217"><span class="hs-identifier hs-var">c2</span></a></span></span><span> </span><span id="local-6989586621683019218"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683019218"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bag a -&gt; b -&gt; PuResult a b
forall a b. Bag a -&gt; b -&gt; PuResult a b
</span><a href="GHC.Tc.Utils.Unify.html#PuOK"><span class="hs-identifier hs-var">PuOK</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bag a
</span><a href="#local-6989586621683019215"><span class="hs-identifier hs-var">c1</span></a></span><span> </span><span class="annot"><span class="annottext">Bag a -&gt; Bag a -&gt; Bag a
forall a. Bag a -&gt; Bag a -&gt; Bag a
</span><a href="GHC.Data.Bag.html#unionBags"><span class="hs-operator hs-var">`unionBags`</span></a></span><span> </span><span class="annot"><span class="annottext">Bag a
</span><a href="#local-6989586621683019217"><span class="hs-identifier hs-var">c2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621683019216"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683019218"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3072"></span><span>
</span><span id="line-3073"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621683017335"><span id="local-6989586621683017336"><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017335"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017336"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuResult"><span class="hs-identifier hs-type">PuResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017335"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017336"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-3074"></span><span>  </span><span id="local-6989586621683019239"><span class="annot"><span class="annottext">ppr :: PuResult a b -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuFail"><span class="hs-identifier hs-type">PuFail</span></a></span><span> </span><span id="local-6989586621683019240"><span class="annot"><span class="annottext">CheckTyEqResult
</span><a href="#local-6989586621683019240"><span class="hs-identifier hs-var">prob</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;PuFail&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CheckTyEqResult -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult
</span><a href="#local-6989586621683019240"><span class="hs-identifier hs-var">prob</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3075"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuOK"><span class="hs-identifier hs-type">PuOK</span></a></span><span> </span><span id="local-6989586621683019241"><span class="annot"><span class="annottext">Bag a
</span><a href="#local-6989586621683019241"><span class="hs-identifier hs-var">cts</span></a></span></span><span> </span><span id="local-6989586621683019242"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621683019242"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;PuOK&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#braces"><span class="hs-identifier hs-var">braces</span></a></span><span>
</span><span id="line-3076"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;redn:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621683019242"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-3077"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;cts:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Bag a -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Bag a
</span><a href="#local-6989586621683019241"><span class="hs-identifier hs-var">cts</span></a></span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-3078"></span><span>
</span><span id="line-3079"></span><span id="local-6989586621683017339"><span id="local-6989586621683017340"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#pprPur"><span class="hs-identifier hs-type">pprPur</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuResult"><span class="hs-identifier hs-type">PuResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017339"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017340"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span></span></span><span>
</span><span id="line-3080"></span><span class="hs-comment">-- For debugging</span><span>
</span><span id="line-3081"></span><span id="pprPur"><span class="annot"><span class="annottext">pprPur :: forall a b. PuResult a b -&gt; SDoc
</span><a href="GHC.Tc.Utils.Unify.html#pprPur"><span class="hs-identifier hs-var hs-var">pprPur</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuFail"><span class="hs-identifier hs-type">PuFail</span></a></span><span> </span><span id="local-6989586621683019249"><span class="annot"><span class="annottext">CheckTyEqResult
</span><a href="#local-6989586621683019249"><span class="hs-identifier hs-var">prob</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;PuFail:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult
</span><a href="#local-6989586621683019249"><span class="hs-identifier hs-var">prob</span></a></span><span>
</span><span id="line-3082"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#pprPur"><span class="hs-identifier hs-var">pprPur</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuOK"><span class="hs-identifier hs-type">PuOK</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;PuOK&quot;</span></span><span>
</span><span id="line-3083"></span><span>
</span><span id="line-3084"></span><span id="local-6989586621683017343"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#okCheckRefl"><span class="hs-identifier hs-type">okCheckRefl</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuResult"><span class="hs-identifier hs-type">PuResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017343"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-3085"></span><span id="okCheckRefl"><span class="annot"><span class="annottext">okCheckRefl :: forall a. TcType -&gt; TcM (PuResult a Reduction)
</span><a href="GHC.Tc.Utils.Unify.html#okCheckRefl"><span class="hs-identifier hs-var hs-var">okCheckRefl</span></a></span></span><span> </span><span id="local-6989586621683019251"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019251"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PuResult a Reduction
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (PuResult a Reduction)
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bag a -&gt; Reduction -&gt; PuResult a Reduction
forall a b. Bag a -&gt; b -&gt; PuResult a b
</span><a href="GHC.Tc.Utils.Unify.html#PuOK"><span class="hs-identifier hs-var">PuOK</span></a></span><span> </span><span class="annot"><span class="annottext">Bag a
forall a. Bag a
</span><a href="GHC.Data.Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; TcType -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkReflRedn"><span class="hs-identifier hs-var">mkReflRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019251"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3086"></span><span>
</span><span id="line-3087"></span><span id="local-6989586621683017346"><span id="local-6989586621683017347"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#failCheckWith"><span class="hs-identifier hs-type">failCheckWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CheckTyEqResult"><span class="hs-identifier hs-type">CheckTyEqResult</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuResult"><span class="hs-identifier hs-type">PuResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017346"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017347"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-3088"></span><span id="failCheckWith"><span class="annot"><span class="annottext">failCheckWith :: forall a b. CheckTyEqResult -&gt; TcM (PuResult a b)
</span><a href="GHC.Tc.Utils.Unify.html#failCheckWith"><span class="hs-identifier hs-var hs-var">failCheckWith</span></a></span></span><span> </span><span id="local-6989586621683019254"><span class="annot"><span class="annottext">CheckTyEqResult
</span><a href="#local-6989586621683019254"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PuResult a b -&gt; IOEnv (Env TcGblEnv TcLclEnv) (PuResult a b)
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CheckTyEqResult -&gt; PuResult a b
forall a b. CheckTyEqResult -&gt; PuResult a b
</span><a href="GHC.Tc.Utils.Unify.html#PuFail"><span class="hs-identifier hs-var">PuFail</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult
</span><a href="#local-6989586621683019254"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3089"></span><span>
</span><span id="line-3090"></span><span id="local-6989586621683017350"><span id="local-6989586621683017351"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#mapCheck"><span class="hs-identifier hs-type">mapCheck</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683017350"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuResult"><span class="hs-identifier hs-type">PuResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017351"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3091"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621683017350"><span class="hs-identifier hs-type">x</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-3092"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuResult"><span class="hs-identifier hs-type">PuResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017351"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reductions"><span class="hs-identifier hs-type">Reductions</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-3093"></span><span id="mapCheck"><span class="annot"><span class="annottext">mapCheck :: forall x a.
(x -&gt; TcM (PuResult a Reduction))
-&gt; [x] -&gt; TcM (PuResult a Reductions)
</span><a href="GHC.Tc.Utils.Unify.html#mapCheck"><span class="hs-identifier hs-var hs-var">mapCheck</span></a></span></span><span> </span><span id="local-6989586621683019262"><span class="annot"><span class="annottext">x -&gt; TcM (PuResult a Reduction)
</span><a href="#local-6989586621683019262"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621683019263"><span class="annot"><span class="annottext">[x]
</span><a href="#local-6989586621683019263"><span class="hs-identifier hs-var">xs</span></a></span></span><span>
</span><span id="line-3094"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683019265"><span class="annot"><a href="#local-6989586621683019265"><span class="hs-identifier hs-var">ress</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier">PuResult</span></span><span> </span><span class="annot"><span class="hs-identifier">a</span></span><span> </span><span class="annot"><span class="hs-identifier">Reduction</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(x -&gt; TcM (PuResult a Reduction))
-&gt; [x] -&gt; IOEnv (Env TcGblEnv TcLclEnv) [PuResult a Reduction]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">x -&gt; TcM (PuResult a Reduction)
</span><a href="#local-6989586621683019262"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">[x]
</span><a href="#local-6989586621683019263"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-3095"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Reduction.html#unzipRedns"><span class="hs-identifier hs-type">unzipRedns</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">sequenceA</span></span><span> </span><span class="annot"><a href="#local-6989586621683019265"><span class="hs-identifier hs-type">ress</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3096"></span><span>         </span><span class="hs-comment">-- sequenceA :: [PuResult a Reduction] -&gt; PuResult a [Reduction]</span><span>
</span><span id="line-3097"></span><span>         </span><span class="hs-comment">-- unzipRedns :: [Reduction] -&gt; Reductions</span><span>
</span><span id="line-3098"></span><span>
</span><span id="line-3099"></span><span class="hs-comment">-----------------------------</span><span>
</span><span id="line-3100"></span><span class="hs-comment">-- | Options describing how to deal with a type equality</span><span>
</span><span id="line-3101"></span><span class="hs-comment">-- in the pure unifier. See 'checkTyEqRhs'</span><span>
</span><span id="line-3102"></span><span class="hs-keyword">data</span><span> </span><span id="TyEqFlags"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#TyEqFlags"><span class="hs-identifier hs-var">TyEqFlags</span></a></span></span><span> </span><span id="local-6989586621683017357"><span class="annot"><a href="#local-6989586621683017357"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-3103"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="TEF"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#TEF"><span class="hs-identifier hs-var">TEF</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="tef_foralls"><span class="annot"><span class="annottext">forall a. TyEqFlags a -&gt; Bool
</span><a href="GHC.Tc.Utils.Unify.html#tef_foralls"><span class="hs-identifier hs-var hs-var">tef_foralls</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>         </span><span class="hs-comment">-- Allow foralls</span><span>
</span><span id="line-3104"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="tef_lhs"><span class="annot"><span class="annottext">forall a. TyEqFlags a -&gt; CanEqLHS
</span><a href="GHC.Tc.Utils.Unify.html#tef_lhs"><span class="hs-identifier hs-var hs-var">tef_lhs</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CanEqLHS"><span class="hs-identifier hs-type">CanEqLHS</span></a></span><span>     </span><span class="hs-comment">-- LHS of the constraint</span><span>
</span><span id="line-3105"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="tef_unifying"><span class="annot"><span class="annottext">forall a. TyEqFlags a -&gt; AreUnifying
</span><a href="GHC.Tc.Utils.Unify.html#tef_unifying"><span class="hs-identifier hs-var hs-var">tef_unifying</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#AreUnifying"><span class="hs-identifier hs-type">AreUnifying</span></a></span><span>  </span><span class="hs-comment">-- Always NotUnifying if tef_lhs is TyFamLHS</span><span>
</span><span id="line-3106"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="tef_fam_app"><span class="annot"><span class="annottext">forall a. TyEqFlags a -&gt; TyEqFamApp a
</span><a href="GHC.Tc.Utils.Unify.html#tef_fam_app"><span class="hs-identifier hs-var hs-var">tef_fam_app</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#TyEqFamApp"><span class="hs-identifier hs-type">TyEqFamApp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017357"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-3107"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="tef_occurs"><span class="annot"><span class="annottext">forall a. TyEqFlags a -&gt; CheckTyEqProblem
</span><a href="GHC.Tc.Utils.Unify.html#tef_occurs"><span class="hs-identifier hs-var hs-var">tef_occurs</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CheckTyEqProblem"><span class="hs-identifier hs-type">CheckTyEqProblem</span></a></span><span> </span><span class="hs-special">}</span><span>  </span><span class="hs-comment">-- Soluble or insoluble occurs check</span><span>
</span><span id="line-3108"></span><span>
</span><span id="line-3109"></span><span class="hs-comment">-- | What to do when encountering a type-family application while processing</span><span>
</span><span id="line-3110"></span><span class="hs-comment">-- a type equality in the pure unifier.</span><span>
</span><span id="line-3111"></span><span class="hs-comment">--</span><span>
</span><span id="line-3112"></span><span class="hs-comment">-- See Note [Family applications in canonical constraints]</span><span>
</span><span id="line-3113"></span><span class="hs-keyword">data</span><span> </span><span id="TyEqFamApp"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#TyEqFamApp"><span class="hs-identifier hs-var">TyEqFamApp</span></a></span></span><span> </span><span id="local-6989586621683017376"><span class="annot"><a href="#local-6989586621683017376"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-3114"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="TEFA_Fail"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#TEFA_Fail"><span class="hs-identifier hs-var">TEFA_Fail</span></a></span></span><span>                    </span><span class="hs-comment">-- Always fail</span><span>
</span><span id="line-3115"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="TEFA_Recurse"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#TEFA_Recurse"><span class="hs-identifier hs-var">TEFA_Recurse</span></a></span></span><span>                 </span><span class="hs-comment">-- Just recurse</span><span>
</span><span id="line-3116"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="TEFA_Break"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#TEFA_Break"><span class="hs-identifier hs-var">TEFA_Break</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#FamAppBreaker"><span class="hs-identifier hs-type">FamAppBreaker</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017376"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Recurse, but replace with cycle breaker if fails,</span><span>
</span><span id="line-3117"></span><span>                                 </span><span class="hs-comment">-- using the FamAppBreaker</span><span>
</span><span id="line-3118"></span><span>
</span><span id="line-3119"></span><span class="hs-keyword">data</span><span> </span><span id="AreUnifying"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#AreUnifying"><span class="hs-identifier hs-var">AreUnifying</span></a></span></span><span>
</span><span id="line-3120"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="Unifying"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#Unifying"><span class="hs-identifier hs-var">Unifying</span></a></span></span><span>
</span><span id="line-3121"></span><span>       </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#MetaInfo"><span class="hs-identifier hs-type">MetaInfo</span></a></span><span>         </span><span class="hs-comment">-- MetaInfo of the LHS tyvar (which is a meta-tyvar)</span><span>
</span><span id="line-3122"></span><span>       </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcLevel"><span class="hs-identifier hs-type">TcLevel</span></a></span><span>          </span><span class="hs-comment">-- Level of the LHS tyvar</span><span>
</span><span id="line-3123"></span><span>       </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#LevelCheck"><span class="hs-identifier hs-type">LevelCheck</span></a></span><span>
</span><span id="line-3124"></span><span>
</span><span id="line-3125"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="NotUnifying"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#NotUnifying"><span class="hs-identifier hs-var">NotUnifying</span></a></span></span><span>         </span><span class="hs-comment">-- Not attempting to unify</span><span>
</span><span id="line-3126"></span><span>
</span><span id="line-3127"></span><span class="hs-keyword">data</span><span> </span><span id="LevelCheck"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#LevelCheck"><span class="hs-identifier hs-var">LevelCheck</span></a></span></span><span>
</span><span id="line-3128"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="LC_None"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#LC_None"><span class="hs-identifier hs-var">LC_None</span></a></span></span><span>       </span><span class="hs-comment">-- Level check not needed: we should never encounter</span><span>
</span><span id="line-3129"></span><span>                  </span><span class="hs-comment">-- a tyvar at deeper level than the LHS</span><span>
</span><span id="line-3130"></span><span>
</span><span id="line-3131"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="LC_Check"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#LC_Check"><span class="hs-identifier hs-var">LC_Check</span></a></span></span><span>      </span><span class="hs-comment">-- Do a level check between the LHS tyvar and the occurrence tyvar</span><span>
</span><span id="line-3132"></span><span>                  </span><span class="hs-comment">-- Fail if the level check fails</span><span>
</span><span id="line-3133"></span><span>
</span><span id="line-3134"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="LC_Promote"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#LC_Promote"><span class="hs-identifier hs-var">LC_Promote</span></a></span></span><span>    </span><span class="hs-comment">-- Do a level check between the LHS tyvar and the occurrence tyvar</span><span>
</span><span id="line-3135"></span><span>                  </span><span class="hs-comment">-- If the level check fails, and the occurrence is a unification</span><span>
</span><span id="line-3136"></span><span>                  </span><span class="hs-comment">-- variable, promote it</span><span>
</span><span id="line-3137"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>        </span><span class="hs-comment">--   False &lt;=&gt; don't promote under type families (the common case)</span><span>
</span><span id="line-3138"></span><span>                  </span><span class="hs-comment">--   True  &lt;=&gt; promote even under type families</span><span>
</span><span id="line-3139"></span><span>                  </span><span class="hs-comment">--             see Note [Defaulting equalities] in GHC.Tc.Solver</span><span>
</span><span id="line-3140"></span><span>
</span><span id="line-3141"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621683017369"><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#TyEqFlags"><span class="hs-identifier hs-type">TyEqFlags</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017369"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-3142"></span><span>  </span><span id="local-6989586621683019307"><span class="annot"><span class="annottext">ppr :: TyEqFlags a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#TEF"><span class="hs-identifier hs-type">TEF</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683019308"><span id="local-6989586621683019309"><span id="local-6989586621683019310"><span id="local-6989586621683019311"><span id="local-6989586621683019312"><span class="annot"><span class="annottext">Bool
CheckTyEqProblem
CanEqLHS
AreUnifying
TyEqFamApp a
tef_foralls :: forall a. TyEqFlags a -&gt; Bool
tef_lhs :: forall a. TyEqFlags a -&gt; CanEqLHS
tef_unifying :: forall a. TyEqFlags a -&gt; AreUnifying
tef_fam_app :: forall a. TyEqFlags a -&gt; TyEqFamApp a
tef_occurs :: forall a. TyEqFlags a -&gt; CheckTyEqProblem
tef_foralls :: Bool
tef_lhs :: CanEqLHS
tef_unifying :: AreUnifying
tef_fam_app :: TyEqFamApp a
tef_occurs :: CheckTyEqProblem
</span><a href="GHC.Tc.Utils.Unify.html#tef_foralls"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;TEF&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#braces"><span class="hs-identifier hs-var">braces</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-3143"></span><span>                        </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tef_foralls =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683019308"><span class="hs-identifier hs-var">tef_foralls</span></a></span><span>
</span><span id="line-3144"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tef_lhs =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683019309"><span class="hs-identifier hs-var">tef_lhs</span></a></span><span>
</span><span id="line-3145"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tef_unifying =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">AreUnifying -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">AreUnifying
</span><a href="#local-6989586621683019310"><span class="hs-identifier hs-var">tef_unifying</span></a></span><span>
</span><span id="line-3146"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tef_fam_app =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TyEqFamApp a -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TyEqFamApp a
</span><a href="#local-6989586621683019311"><span class="hs-identifier hs-var">tef_fam_app</span></a></span><span>
</span><span id="line-3147"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tef_occurs =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqProblem -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqProblem
</span><a href="#local-6989586621683019312"><span class="hs-identifier hs-var">tef_occurs</span></a></span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-3148"></span><span>
</span><span id="line-3149"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621683017370"><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#TyEqFamApp"><span class="hs-identifier hs-type">TyEqFamApp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017370"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-3150"></span><span>  </span><span id="local-6989586621683019317"><span class="annot"><span class="annottext">ppr :: TyEqFamApp a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="annot"><span class="annottext">TyEqFamApp a
</span><a href="GHC.Tc.Utils.Unify.html#TEFA_Fail"><span class="hs-identifier hs-var">TEFA_Fail</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;TEFA_Fail&quot;</span></span><span>
</span><span id="line-3151"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TyEqFamApp a
</span><a href="GHC.Tc.Utils.Unify.html#TEFA_Recurse"><span class="hs-identifier hs-var">TEFA_Recurse</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;TEFA_Recurse&quot;</span></span><span>
</span><span id="line-3152"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#TEFA_Break"><span class="hs-identifier hs-type">TEFA_Break</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;TEFA_Break&quot;</span></span><span>
</span><span id="line-3153"></span><span>
</span><span id="line-3154"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#AreUnifying"><span class="hs-identifier hs-type">AreUnifying</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-3155"></span><span>  </span><span id="local-6989586621683019334"><span class="annot"><span class="annottext">ppr :: AreUnifying -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="annot"><span class="annottext">AreUnifying
</span><a href="GHC.Tc.Utils.Unify.html#NotUnifying"><span class="hs-identifier hs-var">NotUnifying</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;NotUnifying&quot;</span></span><span>
</span><span id="line-3156"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#Unifying"><span class="hs-identifier hs-type">Unifying</span></a></span><span> </span><span id="local-6989586621683019335"><span class="annot"><span class="annottext">MetaInfo
</span><a href="#local-6989586621683019335"><span class="hs-identifier hs-var">mi</span></a></span></span><span> </span><span id="local-6989586621683019336"><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019336"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span id="local-6989586621683019337"><span class="annot"><span class="annottext">LevelCheck
</span><a href="#local-6989586621683019337"><span class="hs-identifier hs-var">lc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Unifying&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span>
</span><span id="line-3157"></span><span>         </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#braces"><span class="hs-identifier hs-var">braces</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MetaInfo -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">MetaInfo
</span><a href="#local-6989586621683019335"><span class="hs-identifier hs-var">mi</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019336"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">LevelCheck -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">LevelCheck
</span><a href="#local-6989586621683019337"><span class="hs-identifier hs-var">lc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3158"></span><span>
</span><span id="line-3159"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#LevelCheck"><span class="hs-identifier hs-type">LevelCheck</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-3160"></span><span>  </span><span id="local-6989586621683019345"><span class="annot"><span class="annottext">ppr :: LevelCheck -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="annot"><span class="annottext">LevelCheck
</span><a href="GHC.Tc.Utils.Unify.html#LC_None"><span class="hs-identifier hs-var">LC_None</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;LC_None&quot;</span></span><span>
</span><span id="line-3161"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">LevelCheck
</span><a href="GHC.Tc.Utils.Unify.html#LC_Check"><span class="hs-identifier hs-var">LC_Check</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;LC_Check&quot;</span></span><span>
</span><span id="line-3162"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#LC_Promote"><span class="hs-identifier hs-type">LC_Promote</span></a></span><span> </span><span id="local-6989586621683019346"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683019346"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;LC_Promote&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; SDoc
forall doc. IsOutput doc =&gt; Bool -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#ppWhen"><span class="hs-identifier hs-var">ppWhen</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683019346"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;(deep)&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-3163"></span><span>
</span><span id="line-3164"></span><span id="local-6989586621683017374"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#famAppArgFlags"><span class="hs-identifier hs-type">famAppArgFlags</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#TyEqFlags"><span class="hs-identifier hs-type">TyEqFlags</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017374"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#TyEqFlags"><span class="hs-identifier hs-type">TyEqFlags</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017374"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-3165"></span><span class="hs-comment">-- Adjust the flags when going undter a type family</span><span>
</span><span id="line-3166"></span><span class="hs-comment">-- Only the outer family application gets the loop-breaker treatment</span><span>
</span><span id="line-3167"></span><span class="hs-comment">-- Ditto tyvar promotion.  E.g.</span><span>
</span><span id="line-3168"></span><span class="hs-comment">--        [W] alpha[2] ~ Maybe (F beta[3])</span><span>
</span><span id="line-3169"></span><span class="hs-comment">-- Do not promote beta[3]; instead promote (F beta[3])</span><span>
</span><span id="line-3170"></span><span id="famAppArgFlags"><span class="annot"><span class="annottext">famAppArgFlags :: forall a. TyEqFlags a -&gt; TyEqFlags a
</span><a href="GHC.Tc.Utils.Unify.html#famAppArgFlags"><span class="hs-identifier hs-var hs-var">famAppArgFlags</span></a></span></span><span> </span><span id="local-6989586621683019348"><span class="annot"><span class="annottext">flags :: TyEqFlags a
</span><a href="#local-6989586621683019348"><span class="hs-identifier hs-var">flags</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#TEF"><span class="hs-identifier hs-type">TEF</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">tef_unifying :: forall a. TyEqFlags a -&gt; AreUnifying
</span><a href="GHC.Tc.Utils.Unify.html#tef_unifying"><span class="hs-identifier hs-var">tef_unifying</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683019349"><span class="annot"><span class="annottext">AreUnifying
</span><a href="#local-6989586621683019349"><span class="hs-identifier hs-var">unifying</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3171"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyEqFlags a
</span><a href="#local-6989586621683019348"><span class="hs-identifier hs-var">flags</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tef_fam_app"><span class="hs-identifier hs-var">tef_fam_app</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#TEFA_Recurse"><span class="hs-identifier hs-type">TEFA_Recurse</span></a></span><span>
</span><span id="line-3172"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tef_unifying"><span class="hs-identifier hs-var">tef_unifying</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683019350"><span class="hs-identifier hs-type">zap_promotion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019349"><span class="hs-identifier hs-type">unifying</span></a></span><span>
</span><span id="line-3173"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tef_occurs"><span class="hs-identifier hs-var">tef_occurs</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#cteSolubleOccurs"><span class="hs-identifier hs-type">cteSolubleOccurs</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3174"></span><span>            </span><span class="hs-comment">-- tef_occurs: under a type family, an occurs check is not definitely-insoluble</span><span>
</span><span id="line-3175"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3176"></span><span>    </span><span id="local-6989586621683019350"><span class="annot"><span class="annottext">zap_promotion :: AreUnifying -&gt; AreUnifying
</span><a href="#local-6989586621683019350"><span class="hs-identifier hs-var hs-var">zap_promotion</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#Unifying"><span class="hs-identifier hs-type">Unifying</span></a></span><span> </span><span id="local-6989586621683019352"><span class="annot"><span class="annottext">MetaInfo
</span><a href="#local-6989586621683019352"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span id="local-6989586621683019353"><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019353"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#LC_Promote"><span class="hs-identifier hs-type">LC_Promote</span></a></span><span> </span><span id="local-6989586621683019354"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683019354"><span class="hs-identifier hs-var">deeply</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3177"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683019354"><span class="hs-identifier hs-var">deeply</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MetaInfo -&gt; TcLevel -&gt; LevelCheck -&gt; AreUnifying
</span><a href="GHC.Tc.Utils.Unify.html#Unifying"><span class="hs-identifier hs-var">Unifying</span></a></span><span> </span><span class="annot"><span class="annottext">MetaInfo
</span><a href="#local-6989586621683019352"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019353"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">LevelCheck
</span><a href="GHC.Tc.Utils.Unify.html#LC_Check"><span class="hs-identifier hs-var">LC_Check</span></a></span><span>
</span><span id="line-3178"></span><span>    </span><span class="annot"><a href="#local-6989586621683019350"><span class="hs-identifier hs-var">zap_promotion</span></a></span><span> </span><span id="local-6989586621683019355"><span class="annot"><span class="annottext">AreUnifying
</span><a href="#local-6989586621683019355"><span class="hs-identifier hs-var">unifying</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AreUnifying
</span><a href="#local-6989586621683019355"><span class="hs-identifier hs-var">unifying</span></a></span><span>
</span><span id="line-3179"></span><span>
</span><span id="line-3180"></span><span class="hs-keyword">type</span><span> </span><span id="FamAppBreaker"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#FamAppBreaker"><span class="hs-identifier hs-var">FamAppBreaker</span></a></span></span><span> </span><span id="local-6989586621683019356"><span class="annot"><a href="#local-6989586621683019356"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuResult"><span class="hs-identifier hs-type">PuResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019356"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3181"></span><span>     </span><span class="hs-comment">-- Given a family-application ty, return a Reduction :: ty ~ cvb</span><span>
</span><span id="line-3182"></span><span>     </span><span class="hs-comment">-- where 'cbv' is a fresh loop-breaker tyvar (for Given), or</span><span>
</span><span id="line-3183"></span><span>     </span><span class="hs-comment">-- just a fresh TauTv (for Wanted)</span><span>
</span><span id="line-3184"></span><span>
</span><span id="line-3185"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#checkTyEqRhs"><span class="hs-identifier hs-type">checkTyEqRhs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621683017377"><span class="annot"><a href="#local-6989586621683017377"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#TyEqFlags"><span class="hs-identifier hs-type">TyEqFlags</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017377"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-3186"></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>           </span><span class="hs-comment">-- Already zonked</span><span>
</span><span id="line-3187"></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuResult"><span class="hs-identifier hs-type">PuResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017377"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3188"></span><span id="checkTyEqRhs"><span class="annot"><span class="annottext">checkTyEqRhs :: forall a. TyEqFlags a -&gt; TcType -&gt; TcM (PuResult a Reduction)
</span><a href="GHC.Tc.Utils.Unify.html#checkTyEqRhs"><span class="hs-identifier hs-var hs-var">checkTyEqRhs</span></a></span></span><span> </span><span id="local-6989586621683019377"><span class="annot"><span class="annottext">TyEqFlags a
</span><a href="#local-6989586621683019377"><span class="hs-identifier hs-var">flags</span></a></span></span><span> </span><span id="local-6989586621683019378"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019378"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-3189"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019378"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3190"></span><span>      </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#LitTy"><span class="hs-identifier hs-type">LitTy</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcM (PuResult a Reduction)
forall a. TcType -&gt; TcM (PuResult a Reduction)
</span><a href="GHC.Tc.Utils.Unify.html#okCheckRefl"><span class="hs-identifier hs-var">okCheckRefl</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019378"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-3191"></span><span>      </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyConApp"><span class="hs-identifier hs-type">TyConApp</span></a></span><span> </span><span id="local-6989586621683019379"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683019379"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621683019380"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683019380"><span class="hs-identifier hs-var">tys</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TyEqFlags a
-&gt; TcType -&gt; TyCon -&gt; [TcType] -&gt; TcM (PuResult a Reduction)
forall a.
TyEqFlags a
-&gt; TcType -&gt; TyCon -&gt; [TcType] -&gt; TcM (PuResult a Reduction)
</span><a href="GHC.Tc.Utils.Unify.html#checkTyConApp"><span class="hs-identifier hs-var">checkTyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyEqFlags a
</span><a href="#local-6989586621683019377"><span class="hs-identifier hs-var">flags</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019378"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683019379"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683019380"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-3192"></span><span>      </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyVarTy"><span class="hs-identifier hs-type">TyVarTy</span></a></span><span> </span><span id="local-6989586621683019382"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019382"><span class="hs-identifier hs-var">tv</span></a></span></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TyEqFlags a -&gt; TcTyVar -&gt; TcM (PuResult a Reduction)
forall a. TyEqFlags a -&gt; TcTyVar -&gt; TcM (PuResult a Reduction)
</span><a href="GHC.Tc.Utils.Unify.html#checkTyVar"><span class="hs-identifier hs-var">checkTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TyEqFlags a
</span><a href="#local-6989586621683019377"><span class="hs-identifier hs-var">flags</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019382"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-3193"></span><span>        </span><span class="hs-comment">-- Don't worry about foralls inside the kind; see Note [Checking for foralls]</span><span>
</span><span id="line-3194"></span><span>        </span><span class="hs-comment">-- Nor can we expand synonyms; see Note [Occurrence checking: look inside kinds]</span><span>
</span><span id="line-3195"></span><span>        </span><span class="hs-comment">--                             in GHC.Core.FVs</span><span>
</span><span id="line-3196"></span><span>
</span><span id="line-3197"></span><span>      </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#FunTy"><span class="hs-identifier hs-type">FunTy</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">ft_af :: TcType -&gt; FunTyFlag
</span><a href="GHC.Core.TyCo.Rep.html#ft_af"><span class="hs-identifier hs-var">ft_af</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683019384"><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683019384"><span class="hs-identifier hs-var">af</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_mult :: TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#ft_mult"><span class="hs-identifier hs-var">ft_mult</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683019385"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019385"><span class="hs-identifier hs-var">w</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_arg :: TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#ft_arg"><span class="hs-identifier hs-var">ft_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683019386"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019386"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_res :: TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#ft_res"><span class="hs-identifier hs-var">ft_res</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683019387"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019387"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">}</span><span>
</span><span id="line-3198"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">FunTyFlag -&gt; Bool
</span><a href="GHC.Types.Var.html#isInvisibleFunArg"><span class="hs-identifier hs-var">isInvisibleFunArg</span></a></span><span> </span><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683019384"><span class="hs-identifier hs-var">af</span></a></span><span>  </span><span class="hs-comment">-- e.g.  Num a =&gt; blah</span><span>
</span><span id="line-3199"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyEqFlags a -&gt; Bool
forall a. TyEqFlags a -&gt; Bool
</span><a href="GHC.Tc.Utils.Unify.html#tef_foralls"><span class="hs-identifier hs-var">tef_foralls</span></a></span><span> </span><span class="annot"><span class="annottext">TyEqFlags a
</span><a href="#local-6989586621683019377"><span class="hs-identifier hs-var">flags</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3200"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult -&gt; TcM (PuResult a Reduction)
forall a b. CheckTyEqResult -&gt; TcM (PuResult a b)
</span><a href="GHC.Tc.Utils.Unify.html#failCheckWith"><span class="hs-identifier hs-var">failCheckWith</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult
</span><a href="GHC.Tc.Types.Constraint.html#impredicativeProblem"><span class="hs-identifier hs-var">impredicativeProblem</span></a></span><span> </span><span class="hs-comment">-- Not allowed (TyEq:F)</span><span>
</span><span id="line-3201"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3202"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683019389"><span class="annot"><a href="#local-6989586621683019389"><span class="hs-identifier hs-var">w_res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyEqFlags a -&gt; TcType -&gt; TcM (PuResult a Reduction)
forall a. TyEqFlags a -&gt; TcType -&gt; TcM (PuResult a Reduction)
</span><a href="GHC.Tc.Utils.Unify.html#checkTyEqRhs"><span class="hs-identifier hs-var">checkTyEqRhs</span></a></span><span> </span><span class="annot"><span class="annottext">TyEqFlags a
</span><a href="#local-6989586621683019377"><span class="hs-identifier hs-var">flags</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019385"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-3203"></span><span>             </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683019390"><span class="annot"><a href="#local-6989586621683019390"><span class="hs-identifier hs-var">a_res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#checkTyEqRhs"><span class="hs-identifier hs-type">checkTyEqRhs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019377"><span class="hs-identifier hs-type">flags</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019386"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-3204"></span><span>             </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683019391"><span class="annot"><a href="#local-6989586621683019391"><span class="hs-identifier hs-var">r_res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#checkTyEqRhs"><span class="hs-identifier hs-type">checkTyEqRhs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019377"><span class="hs-identifier hs-type">flags</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019387"><span class="hs-identifier hs-type">r</span></a></span><span>
</span><span id="line-3205"></span><span>             </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Reduction.html#mkFunRedn"><span class="hs-identifier hs-type">mkFunRedn</span></a></span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-type">Nominal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019384"><span class="hs-identifier hs-type">af</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621683019389"><span class="hs-identifier hs-type">w_res</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;*&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621683019390"><span class="hs-identifier hs-type">a_res</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;*&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621683019391"><span class="hs-identifier hs-type">r_res</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3206"></span><span>
</span><span id="line-3207"></span><span>      </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#AppTy"><span class="hs-identifier hs-type">AppTy</span></a></span><span> </span><span id="local-6989586621683019393"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019393"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621683019394"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019394"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683019395"><span class="annot"><a href="#local-6989586621683019395"><span class="hs-identifier hs-var">fun_res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyEqFlags a -&gt; TcType -&gt; TcM (PuResult a Reduction)
forall a. TyEqFlags a -&gt; TcType -&gt; TcM (PuResult a Reduction)
</span><a href="GHC.Tc.Utils.Unify.html#checkTyEqRhs"><span class="hs-identifier hs-var">checkTyEqRhs</span></a></span><span> </span><span class="annot"><span class="annottext">TyEqFlags a
</span><a href="#local-6989586621683019377"><span class="hs-identifier hs-var">flags</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019393"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-3208"></span><span>                          </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683019396"><span class="annot"><a href="#local-6989586621683019396"><span class="hs-identifier hs-var">arg_res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#checkTyEqRhs"><span class="hs-identifier hs-type">checkTyEqRhs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019377"><span class="hs-identifier hs-type">flags</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019394"><span class="hs-identifier hs-type">arg</span></a></span><span>
</span><span id="line-3209"></span><span>                          </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Reduction.html#mkAppRedn"><span class="hs-identifier hs-type">mkAppRedn</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621683019395"><span class="hs-identifier hs-type">fun_res</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;*&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621683019396"><span class="hs-identifier hs-type">arg_res</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3210"></span><span>
</span><span id="line-3211"></span><span>      </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CastTy"><span class="hs-identifier hs-type">CastTy</span></a></span><span> </span><span id="local-6989586621683019398"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019398"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621683019399"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683019399"><span class="hs-identifier hs-var">co</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683019400"><span class="annot"><a href="#local-6989586621683019400"><span class="hs-identifier hs-var">ty_res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyEqFlags a -&gt; TcType -&gt; TcM (PuResult a Reduction)
forall a. TyEqFlags a -&gt; TcType -&gt; TcM (PuResult a Reduction)
</span><a href="GHC.Tc.Utils.Unify.html#checkTyEqRhs"><span class="hs-identifier hs-var">checkTyEqRhs</span></a></span><span> </span><span class="annot"><span class="annottext">TyEqFlags a
</span><a href="#local-6989586621683019377"><span class="hs-identifier hs-var">flags</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019398"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-3212"></span><span>                          </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683019401"><span class="annot"><a href="#local-6989586621683019401"><span class="hs-identifier hs-var">co_res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#checkCo"><span class="hs-identifier hs-type">checkCo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019377"><span class="hs-identifier hs-type">flags</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019399"><span class="hs-identifier hs-type">co</span></a></span><span>
</span><span id="line-3213"></span><span>                          </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Reduction.html#mkCastRedn1"><span class="hs-identifier hs-type">mkCastRedn1</span></a></span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-type">Nominal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019398"><span class="hs-identifier hs-type">ty</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621683019401"><span class="hs-identifier hs-type">co_res</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;*&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621683019400"><span class="hs-identifier hs-type">ty_res</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3214"></span><span>
</span><span id="line-3215"></span><span>      </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionTy"><span class="hs-identifier hs-type">CoercionTy</span></a></span><span> </span><span id="local-6989586621683019404"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683019404"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683019405"><span class="annot"><a href="#local-6989586621683019405"><span class="hs-identifier hs-var">co_res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyEqFlags a -&gt; Coercion -&gt; TcM (PuResult a Coercion)
forall a. TyEqFlags a -&gt; Coercion -&gt; TcM (PuResult a Coercion)
</span><a href="GHC.Tc.Utils.Unify.html#checkCo"><span class="hs-identifier hs-var">checkCo</span></a></span><span> </span><span class="annot"><span class="annottext">TyEqFlags a
</span><a href="#local-6989586621683019377"><span class="hs-identifier hs-var">flags</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683019404"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-3216"></span><span>                          </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Reduction.html#mkReflCoRedn"><span class="hs-identifier hs-type">mkReflCoRedn</span></a></span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-type">Nominal</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621683019405"><span class="hs-identifier hs-type">co_res</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3217"></span><span>
</span><span id="line-3218"></span><span>      </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ForAllTy"><span class="hs-identifier hs-type">ForAllTy</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>
</span><span id="line-3219"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyEqFlags a -&gt; Bool
forall a. TyEqFlags a -&gt; Bool
</span><a href="GHC.Tc.Utils.Unify.html#tef_foralls"><span class="hs-identifier hs-var">tef_foralls</span></a></span><span> </span><span class="annot"><span class="annottext">TyEqFlags a
</span><a href="#local-6989586621683019377"><span class="hs-identifier hs-var">flags</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcM (PuResult a Reduction)
forall a. TcType -&gt; TcM (PuResult a Reduction)
</span><a href="GHC.Tc.Utils.Unify.html#okCheckRefl"><span class="hs-identifier hs-var">okCheckRefl</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019378"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-3220"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult -&gt; TcM (PuResult a Reduction)
forall a b. CheckTyEqResult -&gt; TcM (PuResult a b)
</span><a href="GHC.Tc.Utils.Unify.html#failCheckWith"><span class="hs-identifier hs-var">failCheckWith</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult
</span><a href="GHC.Tc.Types.Constraint.html#impredicativeProblem"><span class="hs-identifier hs-var">impredicativeProblem</span></a></span><span>  </span><span class="hs-comment">-- Not allowed (TyEq:F)</span><span>
</span><span id="line-3221"></span><span>
</span><span id="line-3222"></span><span>
</span><span id="line-3223"></span><span class="hs-comment">-------------------</span><span>
</span><span id="line-3224"></span><span id="local-6989586621683017381"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#checkCo"><span class="hs-identifier hs-type">checkCo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#TyEqFlags"><span class="hs-identifier hs-type">TyEqFlags</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017381"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuResult"><span class="hs-identifier hs-type">PuResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017381"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-3225"></span><span class="hs-comment">-- See Note [checkCo]</span><span>
</span><span id="line-3226"></span><span id="checkCo"><span class="annot"><span class="annottext">checkCo :: forall a. TyEqFlags a -&gt; Coercion -&gt; TcM (PuResult a Coercion)
</span><a href="GHC.Tc.Utils.Unify.html#checkCo"><span class="hs-identifier hs-var hs-var">checkCo</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#TEF"><span class="hs-identifier hs-type">TEF</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">tef_lhs :: forall a. TyEqFlags a -&gt; CanEqLHS
</span><a href="GHC.Tc.Utils.Unify.html#tef_lhs"><span class="hs-identifier hs-var">tef_lhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#TyFamLHS"><span class="hs-identifier hs-type">TyFamLHS</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621683019415"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683019415"><span class="hs-identifier hs-var">co</span></a></span></span><span>
</span><span id="line-3227"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PuResult a Coercion
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (PuResult a Coercion)
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; PuResult a Coercion
forall a. a -&gt; PuResult a a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683019415"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3228"></span><span>
</span><span id="line-3229"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#checkCo"><span class="hs-identifier hs-var">checkCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#TEF"><span class="hs-identifier hs-type">TEF</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">tef_lhs :: forall a. TyEqFlags a -&gt; CanEqLHS
</span><a href="GHC.Tc.Utils.Unify.html#tef_lhs"><span class="hs-identifier hs-var">tef_lhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#TyVarLHS"><span class="hs-identifier hs-type">TyVarLHS</span></a></span><span> </span><span id="local-6989586621683019417"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019417"><span class="hs-identifier hs-var">lhs_tv</span></a></span></span><span>
</span><span id="line-3230"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tef_unifying :: forall a. TyEqFlags a -&gt; AreUnifying
</span><a href="GHC.Tc.Utils.Unify.html#tef_unifying"><span class="hs-identifier hs-var">tef_unifying</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683019418"><span class="annot"><span class="annottext">AreUnifying
</span><a href="#local-6989586621683019418"><span class="hs-identifier hs-var">unifying</span></a></span></span><span>
</span><span id="line-3231"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tef_occurs :: forall a. TyEqFlags a -&gt; CheckTyEqProblem
</span><a href="GHC.Tc.Utils.Unify.html#tef_occurs"><span class="hs-identifier hs-var">tef_occurs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683019419"><span class="annot"><span class="annottext">CheckTyEqProblem
</span><a href="#local-6989586621683019419"><span class="hs-identifier hs-var">occ_prob</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621683019420"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683019420"><span class="hs-identifier hs-var">co</span></a></span></span><span>
</span><span id="line-3232"></span><span>  </span><span class="hs-comment">-- Check for coercion holes, if unifying</span><span>
</span><span id="line-3233"></span><span>  </span><span class="hs-comment">-- See (COERCION-HOLE) in Note [Unification preconditions]</span><span>
</span><span id="line-3234"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Bool
</span><a href="GHC.Core.Coercion.html#hasCoercionHoleCo"><span class="hs-identifier hs-var">hasCoercionHoleCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683019420"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-3235"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (PuResult a Coercion)
forall a b. CheckTyEqResult -&gt; TcM (PuResult a b)
</span><a href="GHC.Tc.Utils.Unify.html#failCheckWith"><span class="hs-identifier hs-var">failCheckWith</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CheckTyEqProblem -&gt; CheckTyEqResult
</span><a href="GHC.Tc.Types.Constraint.html#cteProblem"><span class="hs-identifier hs-var">cteProblem</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqProblem
</span><a href="GHC.Tc.Types.Constraint.html#cteCoercionHole"><span class="hs-identifier hs-var">cteCoercionHole</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3236"></span><span>
</span><span id="line-3237"></span><span>  </span><span class="hs-comment">-- Occurs check (can promote)</span><span>
</span><span id="line-3238"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#Unifying"><span class="hs-identifier hs-type">Unifying</span></a></span><span> </span><span class="annot"><span class="annottext">MetaInfo
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683019424"><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019424"><span class="hs-identifier hs-var">lhs_tv_lvl</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#LC_Promote"><span class="hs-identifier hs-type">LC_Promote</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AreUnifying
</span><a href="#local-6989586621683019418"><span class="hs-identifier hs-var">unifying</span></a></span><span>
</span><span id="line-3239"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683019425"><span class="annot"><a href="#local-6989586621683019425"><span class="hs-identifier hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CheckTyEqProblem
-&gt; TcTyVar -&gt; TcLevel -&gt; VarSet -&gt; TcM CheckTyEqResult
</span><a href="GHC.Tc.Utils.Unify.html#checkPromoteFreeVars"><span class="hs-identifier hs-var">checkPromoteFreeVars</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqProblem
</span><a href="#local-6989586621683019419"><span class="hs-identifier hs-var">occ_prob</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019417"><span class="hs-identifier hs-var">lhs_tv</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019424"><span class="hs-identifier hs-var">lhs_tv_lvl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfCo"><span class="hs-identifier hs-var">tyCoVarsOfCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683019420"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3240"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#cterHasNoProblem"><span class="hs-identifier hs-type">cterHasNoProblem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019425"><span class="hs-identifier hs-type">reason</span></a></span><span>
</span><span id="line-3241"></span><span>         </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><a href="#local-6989586621683019420"><span class="hs-identifier hs-type">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3242"></span><span>         </span><span class="hs-keyword">else</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#failCheckWith"><span class="hs-identifier hs-type">failCheckWith</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019425"><span class="hs-identifier hs-type">reason</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3243"></span><span>
</span><span id="line-3244"></span><span>  </span><span class="hs-comment">-- Occurs check (no promotion)</span><span>
</span><span id="line-3245"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019417"><span class="hs-identifier hs-var">lhs_tv</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfCo"><span class="hs-identifier hs-var">tyCoVarsOfCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683019420"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-3246"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (PuResult a Coercion)
forall a b. CheckTyEqResult -&gt; TcM (PuResult a b)
</span><a href="GHC.Tc.Utils.Unify.html#failCheckWith"><span class="hs-identifier hs-var">failCheckWith</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CheckTyEqProblem -&gt; CheckTyEqResult
</span><a href="GHC.Tc.Types.Constraint.html#cteProblem"><span class="hs-identifier hs-var">cteProblem</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqProblem
</span><a href="#local-6989586621683019419"><span class="hs-identifier hs-var">occ_prob</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3247"></span><span>
</span><span id="line-3248"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3249"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PuResult a Coercion
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (PuResult a Coercion)
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; PuResult a Coercion
forall a. a -&gt; PuResult a a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683019420"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3250"></span><span>
</span><span id="line-3251"></span><span class="hs-comment">{- Note [checkCo]
~~~~~~~~~~~~~~~~~
We don't often care about the contents of coercions, so checking
coercions before making an equality constraint may be surprising.
But there are several cases we need to be wary of:

(1) When we're unifying a variable, we must make sure that the variable
    appears nowhere on the RHS -- even in a coercion. Otherwise, we'll
    create a loop.

(2) We must still make sure that no variable in a coercion is at too
    high a level. But, when unifying, we can promote any variables we encounter.

(3) We do not unify variables with a type with a free coercion hole.
    See (COERCION-HOLE) in Note [Unification preconditions].


Note [Promotion and level-checking]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
&quot;Promotion&quot; happens when we have this:

  [W] w1: alpha[2] ~ Maybe beta[4]

Here we must NOT unify alpha := Maybe beta, because beta may turn out
to stand for a type involving some inner skolem.  Yikes!
Skolem-escape.  So instead we /promote/ beta, like this:

  beta[4] := beta'[2]
  [W] w1: alpha[2] ~ Maybe beta'[2]

Now we can unify alpha := Maybe beta', which might unlock other
constraints.  But if some other constraint wants to unify beta with a
nested skolem, it'll get stuck with a skolem-escape error.

Now consider `w2` where a type family is involved (#22194):

  [W] w2: alpha[2] ~ Maybe (F gamma beta[4])

In `w2`, it may or may not be the case that `beta` is level 2; suppose
we later discover gamma := Int, and type instance F Int _ = Int.
So, instead, we promote the entire funcion call:

  [W] w2': alpha[2] ~ Maybe gamma[2]
  [W] w3:  gamma[2] ~ F gamma beta[4]

Now we can unify alpha := Maybe gamma, which is a Good Thng.

Wrinkle (W1)

There is an important wrinkle: /all this only applies when unifying/.
For example, suppose we have
 [G] a[2] ~ Maybe b[4]
where 'a' is a skolem.  This Given might arise from a GADT match, and
we can absolutely use it to rewrite locally. In fact we must do so:
that is how we exploit local knowledge about the outer skolem a[2].
This applies equally for a Wanted [W] a[2] ~ Maybe b[4]. Using it for
local rewriting is fine. (It's not clear to me that it is /useful/,
but it's fine anyway.)

So we only do the level-check in checkTyVar when /unifying/ not for
skolems (or untouchable unification variables).

Note [Family applications in canonical constraints]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
A constraint with a type family application in the RHS needs special care.

* First, occurs checks.  If we have
     [G] a ~ Maybe (F (Maybe a))
     [W] alpha ~ Maybe (F (Maybe alpha))
  it looks as if we have an occurs check.  But go read
  Note [Type equality cycles] in GHC.Tc.Solver.Equality

  The same considerations apply when the LHS is a type family:
     [G] G a ~ Maybe (F (Maybe (G a)))
     [W] G alpha ~ Maybe (F (Maybe (G alpha)))

* Second, promotion. If we have (#22194)
     [W] alpha[2] ~ Maybe (F beta[4])
  it is wrong to promote beta.  Instead we want to split to
     [W] alpha[2] ~ Maybe gamma[2]
     [W] gamma[2] ~ F beta[4]
  See Note [Promotion and level-checking] above.

* Third, concrete type variables.  If we have
     [W] alpha[conc] ~ Maybe (F tys)
  we want to add an extra variable thus:
     [W] alpha[conc] ~ Maybe gamma[conc]
     [W] gamma[conc] ~ F tys
  Now we can unify alpha, and that might unlock something else.

In all these cases we want to create a fresh type variable, and
emit a new equality connecting it to the type family application.

The `tef_fam_app` field of `TypeEqFlags` says what to do at a type
family application in the RHS of the constraint.  `TEFA_Fail` and
`TEFA_Recurse` are straightforward.  `TEFA_Break` is the clever
one. As you can see in `checkFamApp`, it
  * Checks the arguments, but using `famAppArgFlags` to record that
    we are now &quot;under&quot; a type-family application. It `tef_fam_app` to
    `TEFA_Recurse`.
  * If any of the arguments fail (level-check error, occurs check)
    use the `FamAppBreaker` to create the extra binding.

Note that this always cycle-breaks the /outermost/ family application.
If we have  [W] alpha ~ Maybe (F (G alpha))
* We'll use checkFamApp on `(F (G alpha))`
* It will recurse into `(G alpha)` with TEFA_Recurse, but not cycle-break it
* The occurs check will fire when we hit `alpha`
* `checkFamApp` on `(F (G alpha))` will see the failure and invoke
  the `FamAppBreaker`.
-}</span><span>
</span><span id="line-3362"></span><span>
</span><span id="line-3363"></span><span class="hs-comment">-------------------</span><span>
</span><span id="line-3364"></span><span id="local-6989586621683017379"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#checkTyConApp"><span class="hs-identifier hs-type">checkTyConApp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#TyEqFlags"><span class="hs-identifier hs-type">TyEqFlags</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017379"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-3365"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-3366"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuResult"><span class="hs-identifier hs-type">PuResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017379"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-3367"></span><span id="checkTyConApp"><span class="annot"><span class="annottext">checkTyConApp :: forall a.
TyEqFlags a
-&gt; TcType -&gt; TyCon -&gt; [TcType] -&gt; TcM (PuResult a Reduction)
</span><a href="GHC.Tc.Utils.Unify.html#checkTyConApp"><span class="hs-identifier hs-var hs-var">checkTyConApp</span></a></span></span><span> </span><span id="local-6989586621683019442"><span class="annot"><span class="annottext">flags :: TyEqFlags a
</span><a href="#local-6989586621683019442"><span class="hs-identifier hs-var">flags</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#TEF"><span class="hs-identifier hs-type">TEF</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">tef_unifying :: forall a. TyEqFlags a -&gt; AreUnifying
</span><a href="GHC.Tc.Utils.Unify.html#tef_unifying"><span class="hs-identifier hs-var">tef_unifying</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683019443"><span class="annot"><span class="annottext">AreUnifying
</span><a href="#local-6989586621683019443"><span class="hs-identifier hs-var">unifying</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tef_foralls :: forall a. TyEqFlags a -&gt; Bool
</span><a href="GHC.Tc.Utils.Unify.html#tef_foralls"><span class="hs-identifier hs-var">tef_foralls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683019444"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683019444"><span class="hs-identifier hs-var">foralls_ok</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3368"></span><span>              </span><span id="local-6989586621683019445"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019445"><span class="hs-identifier hs-var">tc_app</span></a></span></span><span> </span><span id="local-6989586621683019446"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683019446"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621683019447"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683019447"><span class="hs-identifier hs-var">tys</span></a></span></span><span>
</span><span id="line-3369"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isTypeFamilyTyCon"><span class="hs-identifier hs-var">isTypeFamilyTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683019446"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-3370"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683019448"><span class="annot"><span class="annottext">arity :: Int
</span><a href="#local-6989586621683019448"><span class="hs-identifier hs-var hs-var">arity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Int
</span><a href="GHC.Core.TyCon.html#tyConArity"><span class="hs-identifier hs-var">tyConArity</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683019446"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-3371"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683019447"><span class="hs-identifier hs-var">tys</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; Int -&gt; Bool
forall a. [a] -&gt; Int -&gt; Bool
</span><a href="GHC.Utils.Misc.html#lengthIs"><span class="hs-operator hs-var">`lengthIs`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683019448"><span class="hs-identifier hs-var">arity</span></a></span><span>
</span><span id="line-3372"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">TyEqFlags a
-&gt; TcType -&gt; TyCon -&gt; [TcType] -&gt; TcM (PuResult a Reduction)
forall a.
TyEqFlags a
-&gt; TcType -&gt; TyCon -&gt; [TcType] -&gt; TcM (PuResult a Reduction)
</span><a href="GHC.Tc.Utils.Unify.html#checkFamApp"><span class="hs-identifier hs-var">checkFamApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyEqFlags a
</span><a href="#local-6989586621683019442"><span class="hs-identifier hs-var">flags</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019445"><span class="hs-identifier hs-var">tc_app</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683019446"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683019447"><span class="hs-identifier hs-var">tys</span></a></span><span>  </span><span class="hs-comment">-- Common case</span><span>
</span><span id="line-3373"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683019452"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683019452"><span class="hs-identifier hs-var hs-var">fun_args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683019453"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683019453"><span class="hs-identifier hs-var hs-var">extra_args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [TcType] -&gt; ([TcType], [TcType])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Int
</span><a href="GHC.Core.TyCon.html#tyConArity"><span class="hs-identifier hs-var">tyConArity</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683019446"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683019447"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-3374"></span><span>                  </span><span id="local-6989586621683019455"><span class="annot"><span class="annottext">fun_app :: TcType
</span><a href="#local-6989586621683019455"><span class="hs-identifier hs-var hs-var hs-var">fun_app</span></a></span></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [TcType] -&gt; TcType
</span><a href="GHC.Core.Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683019446"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683019452"><span class="hs-identifier hs-var">fun_args</span></a></span><span>
</span><span id="line-3375"></span><span>            </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683019456"><span class="annot"><a href="#local-6989586621683019456"><span class="hs-identifier hs-var">fun_res</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyEqFlags a
-&gt; TcType -&gt; TyCon -&gt; [TcType] -&gt; TcM (PuResult a Reduction)
forall a.
TyEqFlags a
-&gt; TcType -&gt; TyCon -&gt; [TcType] -&gt; TcM (PuResult a Reduction)
</span><a href="GHC.Tc.Utils.Unify.html#checkFamApp"><span class="hs-identifier hs-var">checkFamApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyEqFlags a
</span><a href="#local-6989586621683019442"><span class="hs-identifier hs-var">flags</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019455"><span class="hs-identifier hs-var">fun_app</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683019446"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683019452"><span class="hs-identifier hs-var">fun_args</span></a></span><span>
</span><span id="line-3376"></span><span>            </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683019457"><span class="annot"><a href="#local-6989586621683019457"><span class="hs-identifier hs-var">extra_res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#mapCheck"><span class="hs-identifier hs-type">mapCheck</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#checkTyEqRhs"><span class="hs-identifier hs-type">checkTyEqRhs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019442"><span class="hs-identifier hs-type">flags</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683019453"><span class="hs-identifier hs-type">extra_args</span></a></span><span>
</span><span id="line-3377"></span><span>            </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Over-sat&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019446"><span class="hs-identifier hs-type">tc</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019447"><span class="hs-identifier hs-type">tys</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-type">$$</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019448"><span class="hs-identifier hs-type">arity</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-type">$$</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#pprPur"><span class="hs-identifier hs-type">pprPur</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019456"><span class="hs-identifier hs-type">fun_res</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-type">$$</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#pprPur"><span class="hs-identifier hs-type">pprPur</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019457"><span class="hs-identifier hs-type">extra_res</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3378"></span><span>            </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Reduction.html#mkAppRedns"><span class="hs-identifier hs-type">mkAppRedns</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621683019456"><span class="hs-identifier hs-type">fun_res</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;*&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621683019457"><span class="hs-identifier hs-type">extra_res</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3379"></span><span>
</span><span id="line-3380"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683019459"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019459"><span class="hs-identifier hs-var">ty'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe TcType
</span><a href="GHC.Core.Type.html#rewriterView"><span class="hs-identifier hs-var">rewriterView</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019445"><span class="hs-identifier hs-var">tc_app</span></a></span><span>
</span><span id="line-3381"></span><span>       </span><span class="hs-comment">-- e.g. S a  where  type S a = F [a]</span><span>
</span><span id="line-3382"></span><span>       </span><span class="hs-comment">--             or   type S a = Int</span><span>
</span><span id="line-3383"></span><span>       </span><span class="hs-comment">-- See Note [Forgetful synonyms in checkTyConApp]</span><span>
</span><span id="line-3384"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyEqFlags a -&gt; TcType -&gt; TcM (PuResult a Reduction)
forall a. TyEqFlags a -&gt; TcType -&gt; TcM (PuResult a Reduction)
</span><a href="GHC.Tc.Utils.Unify.html#checkTyEqRhs"><span class="hs-identifier hs-var">checkTyEqRhs</span></a></span><span> </span><span class="annot"><span class="annottext">TyEqFlags a
</span><a href="#local-6989586621683019442"><span class="hs-identifier hs-var">flags</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019459"><span class="hs-identifier hs-var">ty'</span></a></span><span>
</span><span id="line-3385"></span><span>
</span><span id="line-3386"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isTauTyCon"><span class="hs-identifier hs-var">isTauTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683019446"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683019444"><span class="hs-identifier hs-var">foralls_ok</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3387"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult -&gt; TcM (PuResult a Reduction)
forall a b. CheckTyEqResult -&gt; TcM (PuResult a b)
</span><a href="GHC.Tc.Utils.Unify.html#failCheckWith"><span class="hs-identifier hs-var">failCheckWith</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult
</span><a href="GHC.Tc.Types.Constraint.html#impredicativeProblem"><span class="hs-identifier hs-var">impredicativeProblem</span></a></span><span>
</span><span id="line-3388"></span><span>
</span><span id="line-3389"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#Unifying"><span class="hs-identifier hs-type">Unifying</span></a></span><span> </span><span id="local-6989586621683019461"><span class="annot"><span class="annottext">MetaInfo
</span><a href="#local-6989586621683019461"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">LevelCheck
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AreUnifying
</span><a href="#local-6989586621683019443"><span class="hs-identifier hs-var">unifying</span></a></span><span>
</span><span id="line-3390"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MetaInfo -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isConcreteInfo"><span class="hs-identifier hs-var">isConcreteInfo</span></a></span><span> </span><span class="annot"><span class="annottext">MetaInfo
</span><a href="#local-6989586621683019461"><span class="hs-identifier hs-var">info</span></a></span><span>
</span><span id="line-3391"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isConcreteTyCon"><span class="hs-identifier hs-var">isConcreteTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683019446"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3392"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult -&gt; TcM (PuResult a Reduction)
forall a b. CheckTyEqResult -&gt; TcM (PuResult a b)
</span><a href="GHC.Tc.Utils.Unify.html#failCheckWith"><span class="hs-identifier hs-var">failCheckWith</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CheckTyEqProblem -&gt; CheckTyEqResult
</span><a href="GHC.Tc.Types.Constraint.html#cteProblem"><span class="hs-identifier hs-var">cteProblem</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqProblem
</span><a href="GHC.Tc.Types.Constraint.html#cteConcrete"><span class="hs-identifier hs-var">cteConcrete</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3393"></span><span>
</span><span id="line-3394"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>  </span><span class="hs-comment">-- Recurse on arguments</span><span>
</span><span id="line-3395"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyEqFlags a -&gt; TyCon -&gt; [TcType] -&gt; TcM (PuResult a Reduction)
forall a.
TyEqFlags a -&gt; TyCon -&gt; [TcType] -&gt; TcM (PuResult a Reduction)
</span><a href="GHC.Tc.Utils.Unify.html#recurseIntoTyConApp"><span class="hs-identifier hs-var">recurseIntoTyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyEqFlags a
</span><a href="#local-6989586621683019442"><span class="hs-identifier hs-var">flags</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683019446"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683019447"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-3396"></span><span>
</span><span id="line-3397"></span><span id="local-6989586621683017386"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#recurseIntoTyConApp"><span class="hs-identifier hs-type">recurseIntoTyConApp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#TyEqFlags"><span class="hs-identifier hs-type">TyEqFlags</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017386"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuResult"><span class="hs-identifier hs-type">PuResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017386"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-3398"></span><span id="recurseIntoTyConApp"><span class="annot"><span class="annottext">recurseIntoTyConApp :: forall a.
TyEqFlags a -&gt; TyCon -&gt; [TcType] -&gt; TcM (PuResult a Reduction)
</span><a href="GHC.Tc.Utils.Unify.html#recurseIntoTyConApp"><span class="hs-identifier hs-var hs-var">recurseIntoTyConApp</span></a></span></span><span> </span><span id="local-6989586621683019467"><span class="annot"><span class="annottext">TyEqFlags a
</span><a href="#local-6989586621683019467"><span class="hs-identifier hs-var">flags</span></a></span></span><span> </span><span id="local-6989586621683019468"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683019468"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621683019469"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683019469"><span class="hs-identifier hs-var">tys</span></a></span></span><span>
</span><span id="line-3399"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683019470"><span class="annot"><a href="#local-6989586621683019470"><span class="hs-identifier hs-var">tys_res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TcType -&gt; TcM (PuResult a Reduction))
-&gt; [TcType] -&gt; TcM (PuResult a Reductions)
forall x a.
(x -&gt; TcM (PuResult a Reduction))
-&gt; [x] -&gt; TcM (PuResult a Reductions)
</span><a href="GHC.Tc.Utils.Unify.html#mapCheck"><span class="hs-identifier hs-var">mapCheck</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyEqFlags a -&gt; TcType -&gt; TcM (PuResult a Reduction)
forall a. TyEqFlags a -&gt; TcType -&gt; TcM (PuResult a Reduction)
</span><a href="GHC.Tc.Utils.Unify.html#checkTyEqRhs"><span class="hs-identifier hs-var">checkTyEqRhs</span></a></span><span> </span><span class="annot"><span class="annottext">TyEqFlags a
</span><a href="#local-6989586621683019467"><span class="hs-identifier hs-var">flags</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683019469"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-3400"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Reduction.html#mkTyConAppRedn"><span class="hs-identifier hs-type">mkTyConAppRedn</span></a></span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-type">Nominal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019468"><span class="hs-identifier hs-type">tc</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621683019470"><span class="hs-identifier hs-type">tys_res</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3401"></span><span>
</span><span id="line-3402"></span><span class="hs-comment">-------------------</span><span>
</span><span id="line-3403"></span><span id="local-6989586621683019472"><span class="annot"><a href="GHC.Tc.Utils.Unify.html#checkFamApp"><span class="hs-identifier hs-type">checkFamApp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#TyEqFlags"><span class="hs-identifier hs-type">TyEqFlags</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019472"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-3404"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Saturated family application</span><span>
</span><span id="line-3405"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuResult"><span class="hs-identifier hs-type">PuResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019472"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-3406"></span><span class="hs-comment">-- See Note [Family applications in canonical constraints]</span><span>
</span><span id="line-3407"></span><span id="checkFamApp"><span class="annot"><span class="annottext">checkFamApp :: forall a.
TyEqFlags a
-&gt; TcType -&gt; TyCon -&gt; [TcType] -&gt; TcM (PuResult a Reduction)
</span><a href="GHC.Tc.Utils.Unify.html#checkFamApp"><span class="hs-identifier hs-var hs-var">checkFamApp</span></a></span></span><span> </span><span id="local-6989586621683019483"><span class="annot"><span class="annottext">flags :: TyEqFlags a
</span><a href="#local-6989586621683019483"><span class="hs-identifier hs-var">flags</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#TEF"><span class="hs-identifier hs-type">TEF</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">tef_unifying :: forall a. TyEqFlags a -&gt; AreUnifying
</span><a href="GHC.Tc.Utils.Unify.html#tef_unifying"><span class="hs-identifier hs-var">tef_unifying</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683019484"><span class="annot"><span class="annottext">AreUnifying
</span><a href="#local-6989586621683019484"><span class="hs-identifier hs-var">unifying</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tef_occurs :: forall a. TyEqFlags a -&gt; CheckTyEqProblem
</span><a href="GHC.Tc.Utils.Unify.html#tef_occurs"><span class="hs-identifier hs-var">tef_occurs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683019485"><span class="annot"><span class="annottext">CheckTyEqProblem
</span><a href="#local-6989586621683019485"><span class="hs-identifier hs-var">occ_prob</span></a></span></span><span>
</span><span id="line-3408"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tef_fam_app :: forall a. TyEqFlags a -&gt; TyEqFamApp a
</span><a href="GHC.Tc.Utils.Unify.html#tef_fam_app"><span class="hs-identifier hs-var">tef_fam_app</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683019486"><span class="annot"><span class="annottext">TyEqFamApp a
</span><a href="#local-6989586621683019486"><span class="hs-identifier hs-var">fam_app_flag</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tef_lhs :: forall a. TyEqFlags a -&gt; CanEqLHS
</span><a href="GHC.Tc.Utils.Unify.html#tef_lhs"><span class="hs-identifier hs-var">tef_lhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683019487"><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683019487"><span class="hs-identifier hs-var">lhs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3409"></span><span>            </span><span id="local-6989586621683019488"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019488"><span class="hs-identifier hs-var">fam_app</span></a></span></span><span> </span><span id="local-6989586621683019489"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683019489"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621683019490"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683019490"><span class="hs-identifier hs-var">tys</span></a></span></span><span>
</span><span id="line-3410"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TyEqFamApp a
</span><a href="#local-6989586621683019486"><span class="hs-identifier hs-var">fam_app_flag</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3411"></span><span>      </span><span class="annot"><span class="annottext">TyEqFamApp a
</span><a href="GHC.Tc.Utils.Unify.html#TEFA_Fail"><span class="hs-identifier hs-var">TEFA_Fail</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult -&gt; TcM (PuResult a Reduction)
forall a b. CheckTyEqResult -&gt; TcM (PuResult a b)
</span><a href="GHC.Tc.Utils.Unify.html#failCheckWith"><span class="hs-identifier hs-var">failCheckWith</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CheckTyEqProblem -&gt; CheckTyEqResult
</span><a href="GHC.Tc.Types.Constraint.html#cteProblem"><span class="hs-identifier hs-var">cteProblem</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqProblem
</span><a href="GHC.Tc.Types.Constraint.html#cteTypeFamily"><span class="hs-identifier hs-var">cteTypeFamily</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3412"></span><span>
</span><span id="line-3413"></span><span>      </span><span class="hs-comment">-- Occurs check: F ty ~ ...(F ty)...</span><span>
</span><span id="line-3414"></span><span>      </span><span class="annot"><span class="annottext">TyEqFamApp a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#TyFamLHS"><span class="hs-identifier hs-type">TyFamLHS</span></a></span><span> </span><span id="local-6989586621683019492"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683019492"><span class="hs-identifier hs-var">lhs_tc</span></a></span></span><span> </span><span id="local-6989586621683019493"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683019493"><span class="hs-identifier hs-var">lhs_tys</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683019487"><span class="hs-identifier hs-var">lhs</span></a></span><span>
</span><span id="line-3415"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [TcType] -&gt; TyCon -&gt; [TcType] -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#tcEqTyConApps"><span class="hs-identifier hs-var">tcEqTyConApps</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683019492"><span class="hs-identifier hs-var">lhs_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683019493"><span class="hs-identifier hs-var">lhs_tys</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683019489"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683019490"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-3416"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TyEqFamApp a
</span><a href="#local-6989586621683019486"><span class="hs-identifier hs-var">fam_app_flag</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3417"></span><span>             </span><span class="annot"><span class="annottext">TyEqFamApp a
</span><a href="GHC.Tc.Utils.Unify.html#TEFA_Recurse"><span class="hs-identifier hs-var">TEFA_Recurse</span></a></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult -&gt; TcM (PuResult a Reduction)
forall a b. CheckTyEqResult -&gt; TcM (PuResult a b)
</span><a href="GHC.Tc.Utils.Unify.html#failCheckWith"><span class="hs-identifier hs-var">failCheckWith</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CheckTyEqProblem -&gt; CheckTyEqResult
</span><a href="GHC.Tc.Types.Constraint.html#cteProblem"><span class="hs-identifier hs-var">cteProblem</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqProblem
</span><a href="#local-6989586621683019485"><span class="hs-identifier hs-var">occ_prob</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3418"></span><span>             </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#TEFA_Break"><span class="hs-identifier hs-type">TEFA_Break</span></a></span><span> </span><span id="local-6989586621683019495"><span class="annot"><span class="annottext">FamAppBreaker a
</span><a href="#local-6989586621683019495"><span class="hs-identifier hs-var">breaker</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FamAppBreaker a
</span><a href="#local-6989586621683019495"><span class="hs-identifier hs-var">breaker</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019488"><span class="hs-identifier hs-var">fam_app</span></a></span><span>
</span><span id="line-3419"></span><span>
</span><span id="line-3420"></span><span>      </span><span class="annot"><span class="annottext">TyEqFamApp a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#Unifying"><span class="hs-identifier hs-type">Unifying</span></a></span><span> </span><span id="local-6989586621683019496"><span class="annot"><span class="annottext">MetaInfo
</span><a href="#local-6989586621683019496"><span class="hs-identifier hs-var">lhs_info</span></a></span></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">LevelCheck
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AreUnifying
</span><a href="#local-6989586621683019484"><span class="hs-identifier hs-var">unifying</span></a></span><span>
</span><span id="line-3421"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MetaInfo -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isConcreteInfo"><span class="hs-identifier hs-var">isConcreteInfo</span></a></span><span> </span><span class="annot"><span class="annottext">MetaInfo
</span><a href="#local-6989586621683019496"><span class="hs-identifier hs-var">lhs_info</span></a></span><span>
</span><span id="line-3422"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TyEqFamApp a
</span><a href="#local-6989586621683019486"><span class="hs-identifier hs-var">fam_app_flag</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3423"></span><span>             </span><span class="annot"><span class="annottext">TyEqFamApp a
</span><a href="GHC.Tc.Utils.Unify.html#TEFA_Recurse"><span class="hs-identifier hs-var">TEFA_Recurse</span></a></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult -&gt; TcM (PuResult a Reduction)
forall a b. CheckTyEqResult -&gt; TcM (PuResult a b)
</span><a href="GHC.Tc.Utils.Unify.html#failCheckWith"><span class="hs-identifier hs-var">failCheckWith</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CheckTyEqProblem -&gt; CheckTyEqResult
</span><a href="GHC.Tc.Types.Constraint.html#cteProblem"><span class="hs-identifier hs-var">cteProblem</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqProblem
</span><a href="GHC.Tc.Types.Constraint.html#cteConcrete"><span class="hs-identifier hs-var">cteConcrete</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3424"></span><span>             </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#TEFA_Break"><span class="hs-identifier hs-type">TEFA_Break</span></a></span><span> </span><span id="local-6989586621683019497"><span class="annot"><span class="annottext">FamAppBreaker a
</span><a href="#local-6989586621683019497"><span class="hs-identifier hs-var">breaker</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FamAppBreaker a
</span><a href="#local-6989586621683019497"><span class="hs-identifier hs-var">breaker</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019488"><span class="hs-identifier hs-var">fam_app</span></a></span><span>
</span><span id="line-3425"></span><span>
</span><span id="line-3426"></span><span>      </span><span class="annot"><span class="annottext">TyEqFamApp a
</span><a href="GHC.Tc.Utils.Unify.html#TEFA_Recurse"><span class="hs-identifier hs-var">TEFA_Recurse</span></a></span><span>
</span><span id="line-3427"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683019498"><span class="annot"><a href="#local-6989586621683019498"><span class="hs-identifier hs-var">tys_res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FamAppBreaker a -&gt; [TcType] -&gt; TcM (PuResult a Reductions)
forall x a.
(x -&gt; TcM (PuResult a Reduction))
-&gt; [x] -&gt; TcM (PuResult a Reductions)
</span><a href="GHC.Tc.Utils.Unify.html#mapCheck"><span class="hs-identifier hs-var">mapCheck</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyEqFlags a -&gt; FamAppBreaker a
forall a. TyEqFlags a -&gt; TcType -&gt; TcM (PuResult a Reduction)
</span><a href="GHC.Tc.Utils.Unify.html#checkTyEqRhs"><span class="hs-identifier hs-var">checkTyEqRhs</span></a></span><span> </span><span class="annot"><span class="annottext">TyEqFlags a
</span><a href="#local-6989586621683019499"><span class="hs-identifier hs-var">arg_flags</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683019490"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-3428"></span><span>              </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;under&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019489"><span class="hs-identifier hs-type">tc</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-type">$$</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#pprPur"><span class="hs-identifier hs-type">pprPur</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019498"><span class="hs-identifier hs-type">tys_res</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-type">$$</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019483"><span class="hs-identifier hs-type">flags</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3429"></span><span>              </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Reduction.html#mkTyConAppRedn"><span class="hs-identifier hs-type">mkTyConAppRedn</span></a></span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-type">Nominal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019489"><span class="hs-identifier hs-type">tc</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621683019498"><span class="hs-identifier hs-type">tys_res</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3430"></span><span>
</span><span id="line-3431"></span><span>      </span><span class="hs-comment">-- For TEFA_Break, try recursion; and break if there is a problem</span><span>
</span><span id="line-3432"></span><span>      </span><span class="hs-comment">-- e.g.  alpha[2] ~ Maybe (F beta[2])    No problem: just unify</span><span>
</span><span id="line-3433"></span><span>      </span><span class="hs-comment">--       alpha[2] ~ Maybe (F beta[4])    Level-check problem: break</span><span>
</span><span id="line-3434"></span><span>      </span><span class="hs-comment">-- NB: in the latter case, don't promote beta[4]; hence arg_flags!</span><span>
</span><span id="line-3435"></span><span>      </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#TEFA_Break"><span class="hs-identifier hs-type">TEFA_Break</span></a></span><span> </span><span id="local-6989586621683019500"><span class="annot"><span class="annottext">FamAppBreaker a
</span><a href="#local-6989586621683019500"><span class="hs-identifier hs-var">breaker</span></a></span></span><span>
</span><span id="line-3436"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683019501"><span class="annot"><a href="#local-6989586621683019501"><span class="hs-identifier hs-var">tys_res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FamAppBreaker a -&gt; [TcType] -&gt; TcM (PuResult a Reductions)
forall x a.
(x -&gt; TcM (PuResult a Reduction))
-&gt; [x] -&gt; TcM (PuResult a Reductions)
</span><a href="GHC.Tc.Utils.Unify.html#mapCheck"><span class="hs-identifier hs-var">mapCheck</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyEqFlags a -&gt; FamAppBreaker a
forall a. TyEqFlags a -&gt; TcType -&gt; TcM (PuResult a Reduction)
</span><a href="GHC.Tc.Utils.Unify.html#checkTyEqRhs"><span class="hs-identifier hs-var">checkTyEqRhs</span></a></span><span> </span><span class="annot"><span class="annottext">TyEqFlags a
</span><a href="#local-6989586621683019499"><span class="hs-identifier hs-var">arg_flags</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683019490"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-3437"></span><span>              </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683019501"><span class="hs-identifier hs-type">tys_res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3438"></span><span>                  </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuOK"><span class="hs-identifier hs-type">PuOK</span></a></span><span> </span><span id="local-6989586621683019502"><span class="annot"><span class="annottext">Bag a
</span><a href="#local-6989586621683019502"><span class="hs-identifier hs-var">cts</span></a></span></span><span> </span><span id="local-6989586621683019503"><span class="annot"><span class="annottext">Reductions
</span><a href="#local-6989586621683019503"><span class="hs-identifier hs-var">redns</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PuResult a Reduction -&gt; TcM (PuResult a Reduction)
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bag a -&gt; Reduction -&gt; PuResult a Reduction
forall a b. Bag a -&gt; b -&gt; PuResult a b
</span><a href="GHC.Tc.Utils.Unify.html#PuOK"><span class="hs-identifier hs-var">PuOK</span></a></span><span> </span><span class="annot"><span class="annottext">Bag a
</span><a href="#local-6989586621683019502"><span class="hs-identifier hs-var">cts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; TyCon -&gt; Reductions -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkTyConAppRedn"><span class="hs-identifier hs-var">mkTyConAppRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683019489"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">Reductions
</span><a href="#local-6989586621683019503"><span class="hs-identifier hs-var">redns</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3439"></span><span>                  </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuFail"><span class="hs-identifier hs-type">PuFail</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FamAppBreaker a
</span><a href="#local-6989586621683019500"><span class="hs-identifier hs-var">breaker</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019488"><span class="hs-identifier hs-var">fam_app</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3440"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3441"></span><span>    </span><span id="local-6989586621683019499"><span class="annot"><span class="annottext">arg_flags :: TyEqFlags a
</span><a href="#local-6989586621683019499"><span class="hs-identifier hs-var hs-var">arg_flags</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyEqFlags a -&gt; TyEqFlags a
forall a. TyEqFlags a -&gt; TyEqFlags a
</span><a href="GHC.Tc.Utils.Unify.html#famAppArgFlags"><span class="hs-identifier hs-var">famAppArgFlags</span></a></span><span> </span><span class="annot"><span class="annottext">TyEqFlags a
</span><a href="#local-6989586621683019483"><span class="hs-identifier hs-var">flags</span></a></span><span>
</span><span id="line-3442"></span><span>
</span><span id="line-3443"></span><span class="hs-comment">-------------------</span><span>
</span><span id="line-3444"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#checkTyVar"><span class="hs-identifier hs-type">checkTyVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621683017380"><span class="annot"><a href="#local-6989586621683017380"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#TyEqFlags"><span class="hs-identifier hs-type">TyEqFlags</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017380"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuResult"><span class="hs-identifier hs-type">PuResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017380"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3445"></span><span id="checkTyVar"><span class="annot"><span class="annottext">checkTyVar :: forall a. TyEqFlags a -&gt; TcTyVar -&gt; TcM (PuResult a Reduction)
</span><a href="GHC.Tc.Utils.Unify.html#checkTyVar"><span class="hs-identifier hs-var hs-var">checkTyVar</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#TEF"><span class="hs-identifier hs-type">TEF</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">tef_lhs :: forall a. TyEqFlags a -&gt; CanEqLHS
</span><a href="GHC.Tc.Utils.Unify.html#tef_lhs"><span class="hs-identifier hs-var">tef_lhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683019516"><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683019516"><span class="hs-identifier hs-var">lhs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tef_unifying :: forall a. TyEqFlags a -&gt; AreUnifying
</span><a href="GHC.Tc.Utils.Unify.html#tef_unifying"><span class="hs-identifier hs-var">tef_unifying</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683019517"><span class="annot"><span class="annottext">AreUnifying
</span><a href="#local-6989586621683019517"><span class="hs-identifier hs-var">unifying</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tef_occurs :: forall a. TyEqFlags a -&gt; CheckTyEqProblem
</span><a href="GHC.Tc.Utils.Unify.html#tef_occurs"><span class="hs-identifier hs-var">tef_occurs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683019518"><span class="annot"><span class="annottext">CheckTyEqProblem
</span><a href="#local-6989586621683019518"><span class="hs-identifier hs-var">occ_prob</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621683019519"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019519"><span class="hs-identifier hs-var">occ_tv</span></a></span></span><span>
</span><span id="line-3446"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621683019516"><span class="hs-identifier hs-var">lhs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3447"></span><span>      </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#TyFamLHS"><span class="hs-identifier hs-type">TyFamLHS</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcM (PuResult a Reduction)
</span><a href="#local-6989586621683019520"><span class="hs-identifier hs-var">success</span></a></span><span>   </span><span class="hs-comment">-- Nothing to do if the LHS is a type-family</span><span>
</span><span id="line-3448"></span><span>      </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#TyVarLHS"><span class="hs-identifier hs-type">TyVarLHS</span></a></span><span> </span><span id="local-6989586621683019521"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019521"><span class="hs-identifier hs-var">lhs_tv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">AreUnifying -&gt; TcTyVar -&gt; TcM (PuResult a Reduction)
</span><a href="#local-6989586621683019522"><span class="hs-identifier hs-var">check_tv</span></a></span><span> </span><span class="annot"><span class="annottext">AreUnifying
</span><a href="#local-6989586621683019517"><span class="hs-identifier hs-var">unifying</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019521"><span class="hs-identifier hs-var">lhs_tv</span></a></span><span>
</span><span id="line-3449"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3450"></span><span>    </span><span id="local-6989586621683019523"><span class="annot"><span class="annottext">lvl_occ :: TcLevel
</span><a href="#local-6989586621683019523"><span class="hs-identifier hs-var hs-var">lvl_occ</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcLevel
</span><a href="GHC.Tc.Utils.TcType.html#tcTyVarLevel"><span class="hs-identifier hs-var">tcTyVarLevel</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019519"><span class="hs-identifier hs-var">occ_tv</span></a></span><span>
</span><span id="line-3451"></span><span>    </span><span id="local-6989586621683019520"><span class="annot"><span class="annottext">success :: TcM (PuResult a Reduction)
</span><a href="#local-6989586621683019520"><span class="hs-identifier hs-var hs-var">success</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcM (PuResult a Reduction)
forall a. TcType -&gt; TcM (PuResult a Reduction)
</span><a href="GHC.Tc.Utils.Unify.html#okCheckRefl"><span class="hs-identifier hs-var">okCheckRefl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019519"><span class="hs-identifier hs-var">occ_tv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3452"></span><span>
</span><span id="line-3453"></span><span>    </span><span class="hs-comment">---------------------</span><span>
</span><span id="line-3454"></span><span>    </span><span id="local-6989586621683019522"><span class="annot"><span class="annottext">check_tv :: AreUnifying -&gt; TcTyVar -&gt; TcM (PuResult a Reduction)
</span><a href="#local-6989586621683019522"><span class="hs-identifier hs-var hs-var">check_tv</span></a></span></span><span> </span><span class="annot"><span class="annottext">AreUnifying
</span><a href="GHC.Tc.Utils.Unify.html#NotUnifying"><span class="hs-identifier hs-var">NotUnifying</span></a></span><span> </span><span id="local-6989586621683019524"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019524"><span class="hs-identifier hs-var">lhs_tv</span></a></span></span><span>
</span><span id="line-3455"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcM (PuResult a Reduction)
</span><a href="#local-6989586621683019525"><span class="hs-identifier hs-var">simple_occurs_check</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019524"><span class="hs-identifier hs-var">lhs_tv</span></a></span><span>
</span><span id="line-3456"></span><span>      </span><span class="hs-comment">-- We need an occurs-check here, but no level check</span><span>
</span><span id="line-3457"></span><span>      </span><span class="hs-comment">-- See Note [Promotion and level-checking] wrinkle (W1)</span><span>
</span><span id="line-3458"></span><span>
</span><span id="line-3459"></span><span>    </span><span class="annot"><a href="#local-6989586621683019522"><span class="hs-identifier hs-var">check_tv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#Unifying"><span class="hs-identifier hs-type">Unifying</span></a></span><span> </span><span id="local-6989586621683019526"><span class="annot"><span class="annottext">MetaInfo
</span><a href="#local-6989586621683019526"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span id="local-6989586621683019527"><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019527"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span id="local-6989586621683019528"><span class="annot"><span class="annottext">LevelCheck
</span><a href="#local-6989586621683019528"><span class="hs-identifier hs-var">prom</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621683019529"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019529"><span class="hs-identifier hs-var">lhs_tv</span></a></span></span><span>
</span><span id="line-3460"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683019530"><span class="annot"><a href="#local-6989586621683019530"><span class="hs-identifier hs-var">mb_done</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; IOEnv (Env TcGblEnv TcLclEnv) (Maybe TcType)
</span><a href="GHC.Tc.Utils.TcMType.html#isFilledMetaTyVar_maybe"><span class="hs-identifier hs-var">isFilledMetaTyVar_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019519"><span class="hs-identifier hs-var">occ_tv</span></a></span><span>
</span><span id="line-3461"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683019530"><span class="hs-identifier hs-type">mb_done</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3462"></span><span>               </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcM (PuResult a Reduction)
</span><a href="#local-6989586621683019520"><span class="hs-identifier hs-var">success</span></a></span><span>
</span><span id="line-3463"></span><span>               </span><span class="hs-comment">-- Already promoted; job done</span><span>
</span><span id="line-3464"></span><span>               </span><span class="hs-comment">-- Example alpha[2] ~ Maybe (beta[4], beta[4])</span><span>
</span><span id="line-3465"></span><span>               </span><span class="hs-comment">-- We promote the first occurrence, and then encounter it</span><span>
</span><span id="line-3466"></span><span>               </span><span class="hs-comment">-- a second time; we don't want to re-promote it!</span><span>
</span><span id="line-3467"></span><span>               </span><span class="hs-comment">-- Remember, the entire process started with a fully zonked type</span><span>
</span><span id="line-3468"></span><span>
</span><span id="line-3469"></span><span>               </span><span class="annot"><span class="annottext">Maybe TcType
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MetaInfo
-&gt; TcLevel -&gt; LevelCheck -&gt; TcTyVar -&gt; TcM (PuResult a Reduction)
</span><a href="#local-6989586621683019531"><span class="hs-identifier hs-var">check_unif</span></a></span><span> </span><span class="annot"><span class="annottext">MetaInfo
</span><a href="#local-6989586621683019526"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019527"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">LevelCheck
</span><a href="#local-6989586621683019528"><span class="hs-identifier hs-var">prom</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019529"><span class="hs-identifier hs-var">lhs_tv</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3470"></span><span>
</span><span id="line-3471"></span><span>    </span><span class="hs-comment">---------------------</span><span>
</span><span id="line-3472"></span><span>    </span><span class="hs-comment">-- We are in the Unifying branch of AreUnifying; and occ_tv is unfilled</span><span>
</span><span id="line-3473"></span><span>    </span><span class="annot"><a href="#local-6989586621683019531"><span class="hs-identifier hs-type">check_unif</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#MetaInfo"><span class="hs-identifier hs-type">MetaInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcLevel"><span class="hs-identifier hs-type">TcLevel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#LevelCheck"><span class="hs-identifier hs-type">LevelCheck</span></a></span><span>
</span><span id="line-3474"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuResult"><span class="hs-identifier hs-type">PuResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683017380"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3475"></span><span>    </span><span id="local-6989586621683019531"><span class="annot"><span class="annottext">check_unif :: MetaInfo
-&gt; TcLevel -&gt; LevelCheck -&gt; TcTyVar -&gt; TcM (PuResult a Reduction)
</span><a href="#local-6989586621683019531"><span class="hs-identifier hs-var hs-var">check_unif</span></a></span></span><span> </span><span id="local-6989586621683019532"><span class="annot"><span class="annottext">MetaInfo
</span><a href="#local-6989586621683019532"><span class="hs-identifier hs-var">lhs_tv_info</span></a></span></span><span> </span><span id="local-6989586621683019533"><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019533"><span class="hs-identifier hs-var">lhs_tv_lvl</span></a></span></span><span> </span><span id="local-6989586621683019534"><span class="annot"><span class="annottext">LevelCheck
</span><a href="#local-6989586621683019534"><span class="hs-identifier hs-var">prom</span></a></span></span><span> </span><span id="local-6989586621683019535"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019535"><span class="hs-identifier hs-var">lhs_tv</span></a></span></span><span>
</span><span id="line-3476"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">MetaInfo -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isConcreteInfo"><span class="hs-identifier hs-var">isConcreteInfo</span></a></span><span> </span><span class="annot"><span class="annottext">MetaInfo
</span><a href="#local-6989586621683019532"><span class="hs-identifier hs-var">lhs_tv_info</span></a></span><span>
</span><span id="line-3477"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isConcreteTyVar"><span class="hs-identifier hs-var">isConcreteTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019519"><span class="hs-identifier hs-var">occ_tv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3478"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; Bool
</span><a href="#local-6989586621683019536"><span class="hs-identifier hs-var">can_make_concrete</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019519"><span class="hs-identifier hs-var">occ_tv</span></a></span><span>
</span><span id="line-3479"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; MetaInfo -&gt; TcLevel -&gt; TcM (PuResult a Reduction)
</span><a href="#local-6989586621683019537"><span class="hs-identifier hs-var">promote</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019535"><span class="hs-identifier hs-var">lhs_tv</span></a></span><span> </span><span class="annot"><span class="annottext">MetaInfo
</span><a href="#local-6989586621683019532"><span class="hs-identifier hs-var">lhs_tv_info</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019533"><span class="hs-identifier hs-var">lhs_tv_lvl</span></a></span><span>
</span><span id="line-3480"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult -&gt; TcM (PuResult a Reduction)
forall a b. CheckTyEqResult -&gt; TcM (PuResult a b)
</span><a href="GHC.Tc.Utils.Unify.html#failCheckWith"><span class="hs-identifier hs-var">failCheckWith</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CheckTyEqProblem -&gt; CheckTyEqResult
</span><a href="GHC.Tc.Types.Constraint.html#cteProblem"><span class="hs-identifier hs-var">cteProblem</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqProblem
</span><a href="GHC.Tc.Types.Constraint.html#cteConcrete"><span class="hs-identifier hs-var">cteConcrete</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3481"></span><span>
</span><span id="line-3482"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019523"><span class="hs-identifier hs-var">lvl_occ</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel -&gt; TcLevel -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#strictlyDeeperThan"><span class="hs-operator hs-var">`strictlyDeeperThan`</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019533"><span class="hs-identifier hs-var">lhs_tv_lvl</span></a></span><span>
</span><span id="line-3483"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LevelCheck
</span><a href="#local-6989586621683019534"><span class="hs-identifier hs-var">prom</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3484"></span><span>           </span><span class="annot"><span class="annottext">LevelCheck
</span><a href="GHC.Tc.Utils.Unify.html#LC_None"><span class="hs-identifier hs-var">LC_None</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM (PuResult a Reduction)
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;check_unif&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019535"><span class="hs-identifier hs-var">lhs_tv</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019519"><span class="hs-identifier hs-var">occ_tv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3485"></span><span>           </span><span class="annot"><span class="annottext">LevelCheck
</span><a href="GHC.Tc.Utils.Unify.html#LC_Check"><span class="hs-identifier hs-var">LC_Check</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult -&gt; TcM (PuResult a Reduction)
forall a b. CheckTyEqResult -&gt; TcM (PuResult a b)
</span><a href="GHC.Tc.Utils.Unify.html#failCheckWith"><span class="hs-identifier hs-var">failCheckWith</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CheckTyEqProblem -&gt; CheckTyEqResult
</span><a href="GHC.Tc.Types.Constraint.html#cteProblem"><span class="hs-identifier hs-var">cteProblem</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqProblem
</span><a href="GHC.Tc.Types.Constraint.html#cteSkolemEscape"><span class="hs-identifier hs-var">cteSkolemEscape</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3486"></span><span>           </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#LC_Promote"><span class="hs-identifier hs-type">LC_Promote</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>
</span><span id="line-3487"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isSkolemTyVar"><span class="hs-identifier hs-var">isSkolemTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019519"><span class="hs-identifier hs-var">occ_tv</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult -&gt; TcM (PuResult a Reduction)
forall a b. CheckTyEqResult -&gt; TcM (PuResult a b)
</span><a href="GHC.Tc.Utils.Unify.html#failCheckWith"><span class="hs-identifier hs-var">failCheckWith</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CheckTyEqProblem -&gt; CheckTyEqResult
</span><a href="GHC.Tc.Types.Constraint.html#cteProblem"><span class="hs-identifier hs-var">cteProblem</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqProblem
</span><a href="GHC.Tc.Types.Constraint.html#cteSkolemEscape"><span class="hs-identifier hs-var">cteSkolemEscape</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3488"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; MetaInfo -&gt; TcLevel -&gt; TcM (PuResult a Reduction)
</span><a href="#local-6989586621683019537"><span class="hs-identifier hs-var">promote</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019535"><span class="hs-identifier hs-var">lhs_tv</span></a></span><span> </span><span class="annot"><span class="annottext">MetaInfo
</span><a href="#local-6989586621683019532"><span class="hs-identifier hs-var">lhs_tv_info</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019533"><span class="hs-identifier hs-var">lhs_tv_lvl</span></a></span><span>
</span><span id="line-3489"></span><span>
</span><span id="line-3490"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3491"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcM (PuResult a Reduction)
</span><a href="#local-6989586621683019525"><span class="hs-identifier hs-var">simple_occurs_check</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019535"><span class="hs-identifier hs-var">lhs_tv</span></a></span><span>
</span><span id="line-3492"></span><span>
</span><span id="line-3493"></span><span>    </span><span class="hs-comment">---------------------</span><span>
</span><span id="line-3494"></span><span>    </span><span id="local-6989586621683019525"><span class="annot"><span class="annottext">simple_occurs_check :: TcTyVar -&gt; TcM (PuResult a Reduction)
</span><a href="#local-6989586621683019525"><span class="hs-identifier hs-var hs-var">simple_occurs_check</span></a></span></span><span> </span><span id="local-6989586621683019540"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019540"><span class="hs-identifier hs-var">lhs_tv</span></a></span></span><span>
</span><span id="line-3495"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019540"><span class="hs-identifier hs-var">lhs_tv</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcTyVar -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019519"><span class="hs-identifier hs-var">occ_tv</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="#local-6989586621683019541"><span class="hs-identifier hs-var">check_kind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType
</span><a href="GHC.Types.Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019519"><span class="hs-identifier hs-var">occ_tv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3496"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult -&gt; TcM (PuResult a Reduction)
forall a b. CheckTyEqResult -&gt; TcM (PuResult a b)
</span><a href="GHC.Tc.Utils.Unify.html#failCheckWith"><span class="hs-identifier hs-var">failCheckWith</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CheckTyEqProblem -&gt; CheckTyEqResult
</span><a href="GHC.Tc.Types.Constraint.html#cteProblem"><span class="hs-identifier hs-var">cteProblem</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqProblem
</span><a href="#local-6989586621683019518"><span class="hs-identifier hs-var">occ_prob</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3497"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3498"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcM (PuResult a Reduction)
</span><a href="#local-6989586621683019520"><span class="hs-identifier hs-var">success</span></a></span><span>
</span><span id="line-3499"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-3500"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621683019541"><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="#local-6989586621683019541"><span class="hs-identifier hs-var">check_kind</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; (TcType -&gt; Bool, Coercion -&gt; Bool)
</span><a href="GHC.Tc.Utils.Unify.html#mkOccFolders"><span class="hs-identifier hs-var">mkOccFolders</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019540"><span class="hs-identifier hs-var">lhs_tv</span></a></span><span>
</span><span id="line-3501"></span><span>
</span><span id="line-3502"></span><span>    </span><span class="hs-comment">---------------------</span><span>
</span><span id="line-3503"></span><span>    </span><span id="local-6989586621683019536"><span class="annot"><span class="annottext">can_make_concrete :: TcTyVar -&gt; Bool
</span><a href="#local-6989586621683019536"><span class="hs-identifier hs-var hs-var">can_make_concrete</span></a></span></span><span> </span><span id="local-6989586621683019542"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019542"><span class="hs-identifier hs-var">occ_tv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcTyVarDetails
</span><a href="GHC.Types.Var.html#tcTyVarDetails"><span class="hs-identifier hs-var">tcTyVarDetails</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019542"><span class="hs-identifier hs-var">occ_tv</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3504"></span><span>      </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#MetaTv"><span class="hs-identifier hs-type">MetaTv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mtv_info :: TcTyVarDetails -&gt; MetaInfo
</span><a href="GHC.Tc.Utils.TcType.html#mtv_info"><span class="hs-identifier hs-var">mtv_info</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683019543"><span class="annot"><span class="annottext">MetaInfo
</span><a href="#local-6989586621683019543"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MetaInfo
</span><a href="#local-6989586621683019543"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3505"></span><span>                                      </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#ConcreteTv"><span class="hs-identifier hs-type">ConcreteTv</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-3506"></span><span>                                      </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TauTv"><span class="hs-identifier hs-type">TauTv</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-3507"></span><span>                                      </span><span class="annot"><span class="annottext">MetaInfo
</span><span class="hs-identifier">_</span></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-3508"></span><span>      </span><span class="annot"><span class="annottext">TcTyVarDetails
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>  </span><span class="hs-comment">-- Don't attempt to make other type variables concrete</span><span>
</span><span id="line-3509"></span><span>                  </span><span class="hs-comment">-- (e.g. SkolemTv, TyVarTv, CycleBreakerTv, RuntimeUnkTv).</span><span>
</span><span id="line-3510"></span><span>
</span><span id="line-3511"></span><span>    </span><span class="hs-comment">---------------------</span><span>
</span><span id="line-3512"></span><span>    </span><span class="hs-comment">-- occ_tv is definitely a MetaTyVar</span><span>
</span><span id="line-3513"></span><span>    </span><span id="local-6989586621683019537"><span class="annot"><span class="annottext">promote :: TcTyVar -&gt; MetaInfo -&gt; TcLevel -&gt; TcM (PuResult a Reduction)
</span><a href="#local-6989586621683019537"><span class="hs-identifier hs-var hs-var">promote</span></a></span></span><span> </span><span id="local-6989586621683019544"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019544"><span class="hs-identifier hs-var">lhs_tv</span></a></span></span><span> </span><span id="local-6989586621683019545"><span class="annot"><span class="annottext">MetaInfo
</span><a href="#local-6989586621683019545"><span class="hs-identifier hs-var">lhs_tv_info</span></a></span></span><span> </span><span id="local-6989586621683019546"><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019546"><span class="hs-identifier hs-var">lhs_tv_lvl</span></a></span></span><span>
</span><span id="line-3514"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#MetaTv"><span class="hs-identifier hs-type">MetaTv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mtv_info :: TcTyVarDetails -&gt; MetaInfo
</span><a href="GHC.Tc.Utils.TcType.html#mtv_info"><span class="hs-identifier hs-var">mtv_info</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683019547"><span class="annot"><span class="annottext">MetaInfo
</span><a href="#local-6989586621683019547"><span class="hs-identifier hs-var">info_occ</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mtv_tclvl :: TcTyVarDetails -&gt; TcLevel
</span><a href="GHC.Tc.Utils.TcType.html#mtv_tclvl"><span class="hs-identifier hs-var">mtv_tclvl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683019548"><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019548"><span class="hs-identifier hs-var">lvl_occ</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcTyVarDetails
</span><a href="GHC.Types.Var.html#tcTyVarDetails"><span class="hs-identifier hs-var">tcTyVarDetails</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019519"><span class="hs-identifier hs-var">occ_tv</span></a></span><span>
</span><span id="line-3515"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683019549"><span class="annot"><span class="annottext">new_info :: MetaInfo
</span><a href="#local-6989586621683019549"><span class="hs-identifier hs-var hs-var hs-var">new_info</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">MetaInfo -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isConcreteInfo"><span class="hs-identifier hs-var">isConcreteInfo</span></a></span><span> </span><span class="annot"><span class="annottext">MetaInfo
</span><a href="#local-6989586621683019545"><span class="hs-identifier hs-var">lhs_tv_info</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MetaInfo
</span><a href="#local-6989586621683019545"><span class="hs-identifier hs-var">lhs_tv_info</span></a></span><span>
</span><span id="line-3516"></span><span>                          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MetaInfo
</span><a href="#local-6989586621683019547"><span class="hs-identifier hs-var">info_occ</span></a></span><span>
</span><span id="line-3517"></span><span>                 </span><span id="local-6989586621683019550"><span class="annot"><span class="annottext">new_lvl :: TcLevel
</span><a href="#local-6989586621683019550"><span class="hs-identifier hs-var hs-var hs-var">new_lvl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019546"><span class="hs-identifier hs-var">lhs_tv_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel -&gt; TcLevel -&gt; TcLevel
</span><a href="GHC.Tc.Utils.TcType.html#minTcLevel"><span class="hs-operator hs-var">`minTcLevel`</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019548"><span class="hs-identifier hs-var">lvl_occ</span></a></span><span>
</span><span id="line-3518"></span><span>                           </span><span class="hs-comment">-- c[conc,3] ~ p[tau,2]: want to clone p:=p'[conc,2]</span><span>
</span><span id="line-3519"></span><span>                           </span><span class="hs-comment">-- c[tau,2]  ~ p[tau,3]: want to clone p:=p'[tau,2]</span><span>
</span><span id="line-3520"></span><span>
</span><span id="line-3521"></span><span>           </span><span class="hs-comment">-- Check the kind of occ_tv</span><span>
</span><span id="line-3522"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683019552"><span class="annot"><a href="#local-6989586621683019552"><span class="hs-identifier hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CheckTyEqProblem
-&gt; TcTyVar -&gt; TcLevel -&gt; VarSet -&gt; TcM CheckTyEqResult
</span><a href="GHC.Tc.Utils.Unify.html#checkPromoteFreeVars"><span class="hs-identifier hs-var">checkPromoteFreeVars</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqProblem
</span><a href="#local-6989586621683019518"><span class="hs-identifier hs-var">occ_prob</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019544"><span class="hs-identifier hs-var">lhs_tv</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019546"><span class="hs-identifier hs-var">lhs_tv_lvl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType
</span><a href="GHC.Types.Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019519"><span class="hs-identifier hs-var">occ_tv</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3523"></span><span>
</span><span id="line-3524"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#cterHasNoProblem"><span class="hs-identifier hs-type">cterHasNoProblem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019552"><span class="hs-identifier hs-type">reason</span></a></span><span>  </span><span class="hs-comment">-- Successfully promoted</span><span>
</span><span id="line-3525"></span><span>             </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683019553"><span class="annot"><a href="#local-6989586621683019553"><span class="hs-identifier hs-var">new_tv_ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#promote_meta_tyvar"><span class="hs-identifier hs-type">promote_meta_tyvar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019549"><span class="hs-identifier hs-type">new_info</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019550"><span class="hs-identifier hs-type">new_lvl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019519"><span class="hs-identifier hs-type">occ_tv</span></a></span><span>
</span><span id="line-3526"></span><span>                     </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#okCheckRefl"><span class="hs-identifier hs-type">okCheckRefl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019553"><span class="hs-identifier hs-type">new_tv_ty</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3527"></span><span>             </span><span class="hs-keyword">else</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#failCheckWith"><span class="hs-identifier hs-type">failCheckWith</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019552"><span class="hs-identifier hs-type">reason</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3528"></span><span>
</span><span id="line-3529"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM (PuResult a Reduction)
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;promote&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019519"><span class="hs-identifier hs-var">occ_tv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3530"></span><span>
</span><span id="line-3531"></span><span class="hs-comment">-------------------------</span><span>
</span><span id="line-3532"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#checkPromoteFreeVars"><span class="hs-identifier hs-type">checkPromoteFreeVars</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CheckTyEqProblem"><span class="hs-identifier hs-type">CheckTyEqProblem</span></a></span><span>    </span><span class="hs-comment">-- What occurs check problem to report</span><span>
</span><span id="line-3533"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcLevel"><span class="hs-identifier hs-type">TcLevel</span></a></span><span>
</span><span id="line-3534"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#TyCoVarSet"><span class="hs-identifier hs-type">TyCoVarSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CheckTyEqResult"><span class="hs-identifier hs-type">CheckTyEqResult</span></a></span><span>
</span><span id="line-3535"></span><span class="hs-comment">-- Check this set of TyCoVars for</span><span>
</span><span id="line-3536"></span><span class="hs-comment">--   (a) occurs check</span><span>
</span><span id="line-3537"></span><span class="hs-comment">--   (b) promote if necessary, or report skolem escape</span><span>
</span><span id="line-3538"></span><span id="checkPromoteFreeVars"><span class="annot"><span class="annottext">checkPromoteFreeVars :: CheckTyEqProblem
-&gt; TcTyVar -&gt; TcLevel -&gt; VarSet -&gt; TcM CheckTyEqResult
</span><a href="GHC.Tc.Utils.Unify.html#checkPromoteFreeVars"><span class="hs-identifier hs-var hs-var">checkPromoteFreeVars</span></a></span></span><span> </span><span id="local-6989586621683019556"><span class="annot"><span class="annottext">CheckTyEqProblem
</span><a href="#local-6989586621683019556"><span class="hs-identifier hs-var">occ_prob</span></a></span></span><span> </span><span id="local-6989586621683019557"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019557"><span class="hs-identifier hs-var">lhs_tv</span></a></span></span><span> </span><span id="local-6989586621683019558"><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019558"><span class="hs-identifier hs-var">lhs_tv_lvl</span></a></span></span><span> </span><span id="local-6989586621683019559"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683019559"><span class="hs-identifier hs-var">vs</span></a></span></span><span>
</span><span id="line-3539"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683019560"><span class="annot"><a href="#local-6989586621683019560"><span class="hs-identifier hs-var">oks</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TcTyVar -&gt; TcM CheckTyEqResult)
-&gt; [TcTyVar] -&gt; IOEnv (Env TcGblEnv TcLclEnv) [CheckTyEqResult]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcM CheckTyEqResult
</span><a href="#local-6989586621683019561"><span class="hs-identifier hs-var">do_one</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarSet -&gt; [TcTyVar]
forall elt. UniqSet elt -&gt; [elt]
</span><a href="GHC.Types.Unique.Set.html#nonDetEltsUniqSet"><span class="hs-identifier hs-var">nonDetEltsUniqSet</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683019559"><span class="hs-identifier hs-var">vs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3540"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">mconcat</span></span><span> </span><span class="annot"><a href="#local-6989586621683019560"><span class="hs-identifier hs-type">oks</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3541"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3542"></span><span>    </span><span class="annot"><a href="#local-6989586621683019561"><span class="hs-identifier hs-type">do_one</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CheckTyEqResult"><span class="hs-identifier hs-type">CheckTyEqResult</span></a></span><span>
</span><span id="line-3543"></span><span>    </span><span id="local-6989586621683019561"><span class="annot"><span class="annottext">do_one :: TcTyVar -&gt; TcM CheckTyEqResult
</span><a href="#local-6989586621683019561"><span class="hs-identifier hs-var hs-var">do_one</span></a></span></span><span> </span><span id="local-6989586621683019563"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019563"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019563"><span class="hs-identifier hs-var">v</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult -&gt; TcM CheckTyEqResult
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult
</span><a href="GHC.Tc.Types.Constraint.html#cteOK"><span class="hs-identifier hs-var">cteOK</span></a></span><span>
</span><span id="line-3544"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019557"><span class="hs-identifier hs-var">lhs_tv</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcTyVar -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019563"><span class="hs-identifier hs-var">v</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult -&gt; TcM CheckTyEqResult
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CheckTyEqProblem -&gt; CheckTyEqResult
</span><a href="GHC.Tc.Types.Constraint.html#cteProblem"><span class="hs-identifier hs-var">cteProblem</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqProblem
</span><a href="#local-6989586621683019556"><span class="hs-identifier hs-var">occ_prob</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3545"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683019566"><span class="hs-identifier hs-var">no_promotion</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult -&gt; TcM CheckTyEqResult
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult
</span><a href="GHC.Tc.Types.Constraint.html#cteOK"><span class="hs-identifier hs-var">cteOK</span></a></span><span>
</span><span id="line-3546"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isMetaTyVar"><span class="hs-identifier hs-var">isMetaTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019563"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CheckTyEqResult -&gt; TcM CheckTyEqResult
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CheckTyEqProblem -&gt; CheckTyEqResult
</span><a href="GHC.Tc.Types.Constraint.html#cteProblem"><span class="hs-identifier hs-var">cteProblem</span></a></span><span> </span><span class="annot"><span class="annottext">CheckTyEqProblem
</span><a href="GHC.Tc.Types.Constraint.html#cteSkolemEscape"><span class="hs-identifier hs-var">cteSkolemEscape</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3547"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcM CheckTyEqResult
</span><a href="#local-6989586621683019567"><span class="hs-identifier hs-var">promote_one</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019563"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-3548"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-3549"></span><span>        </span><span id="local-6989586621683019566"><span class="annot"><span class="annottext">no_promotion :: Bool
</span><a href="#local-6989586621683019566"><span class="hs-identifier hs-var hs-var">no_promotion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; TcLevel
</span><a href="GHC.Tc.Utils.TcType.html#tcTyVarLevel"><span class="hs-identifier hs-var">tcTyVarLevel</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019563"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel -&gt; TcLevel -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#strictlyDeeperThan"><span class="hs-operator hs-var">`strictlyDeeperThan`</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019558"><span class="hs-identifier hs-var">lhs_tv_lvl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3550"></span><span>
</span><span id="line-3551"></span><span>    </span><span class="hs-comment">-- isCoVar case: coercion variables are not an escape risk</span><span>
</span><span id="line-3552"></span><span>    </span><span class="hs-comment">-- If an implication binds a coercion variable, it'll have equalities,</span><span>
</span><span id="line-3553"></span><span>    </span><span class="hs-comment">-- so the &quot;intervening given equalities&quot; test above will catch it</span><span>
</span><span id="line-3554"></span><span>    </span><span class="hs-comment">-- Coercion holes get filled with coercions, so again no problem.</span><span>
</span><span id="line-3555"></span><span>
</span><span id="line-3556"></span><span>    </span><span id="local-6989586621683019567"><span class="annot"><span class="annottext">promote_one :: TcTyVar -&gt; TcM CheckTyEqResult
</span><a href="#local-6989586621683019567"><span class="hs-identifier hs-var hs-var">promote_one</span></a></span></span><span> </span><span id="local-6989586621683019568"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019568"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MetaInfo -&gt; TcLevel -&gt; TcTyVar -&gt; TcM TcType
</span><a href="GHC.Tc.Utils.Unify.html#promote_meta_tyvar"><span class="hs-identifier hs-var">promote_meta_tyvar</span></a></span><span> </span><span class="annot"><span class="annottext">MetaInfo
</span><a href="GHC.Tc.Utils.TcType.html#TauTv"><span class="hs-identifier hs-var">TauTv</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019558"><span class="hs-identifier hs-var">lhs_tv_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019568"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-3557"></span><span>                        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#cteOK"><span class="hs-identifier hs-type">cteOK</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3558"></span><span>
</span><span id="line-3559"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#promote_meta_tyvar"><span class="hs-identifier hs-type">promote_meta_tyvar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#MetaInfo"><span class="hs-identifier hs-type">MetaInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcLevel"><span class="hs-identifier hs-type">TcLevel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>
</span><span id="line-3560"></span><span id="promote_meta_tyvar"><span class="annot"><span class="annottext">promote_meta_tyvar :: MetaInfo -&gt; TcLevel -&gt; TcTyVar -&gt; TcM TcType
</span><a href="GHC.Tc.Utils.Unify.html#promote_meta_tyvar"><span class="hs-identifier hs-var hs-var">promote_meta_tyvar</span></a></span></span><span> </span><span id="local-6989586621683019569"><span class="annot"><span class="annottext">MetaInfo
</span><a href="#local-6989586621683019569"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span id="local-6989586621683019570"><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019570"><span class="hs-identifier hs-var">dest_lvl</span></a></span></span><span> </span><span id="local-6989586621683019571"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019571"><span class="hs-identifier hs-var">occ_tv</span></a></span></span><span>
</span><span id="line-3561"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Check whether occ_tv is already unified. The rhs-type</span><span>
</span><span id="line-3562"></span><span>         </span><span class="hs-comment">-- started zonked, but we may have promoted one of its type</span><span>
</span><span id="line-3563"></span><span>         </span><span class="hs-comment">-- variables, and we then encounter it for the second time.</span><span>
</span><span id="line-3564"></span><span>         </span><span class="hs-comment">-- But if so, it'll definitely be another already-checked TyVar</span><span>
</span><span id="line-3565"></span><span>         </span><span id="local-6989586621683019572"><span class="annot"><a href="#local-6989586621683019572"><span class="hs-identifier hs-var">mb_filled</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; IOEnv (Env TcGblEnv TcLclEnv) (Maybe TcType)
</span><a href="GHC.Tc.Utils.TcMType.html#isFilledMetaTyVar_maybe"><span class="hs-identifier hs-var">isFilledMetaTyVar_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019571"><span class="hs-identifier hs-var">occ_tv</span></a></span><span>
</span><span id="line-3566"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683019572"><span class="hs-identifier hs-type">mb_filled</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-3567"></span><span>           </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683019573"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019573"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcM TcType
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019573"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-special">;</span><span>
</span><span id="line-3568"></span><span>           </span><span class="annot"><span class="annottext">Maybe TcType
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-3569"></span><span>
</span><span id="line-3570"></span><span>    </span><span class="hs-comment">-- OK, not done already, so clone/promote it</span><span>
</span><span id="line-3571"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683019574"><span class="annot"><a href="#local-6989586621683019574"><span class="hs-identifier hs-var">new_tv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MetaInfo -&gt; TcLevel -&gt; TcTyVar -&gt; TcM TcTyVar
</span><a href="GHC.Tc.Utils.TcMType.html#cloneMetaTyVarWithInfo"><span class="hs-identifier hs-var">cloneMetaTyVarWithInfo</span></a></span><span> </span><span class="annot"><span class="annottext">MetaInfo
</span><a href="#local-6989586621683019569"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019570"><span class="hs-identifier hs-var">dest_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019571"><span class="hs-identifier hs-var">occ_tv</span></a></span><span>
</span><span id="line-3572"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#liftZonkM"><span class="hs-identifier hs-type">liftZonkM</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Tc.Zonk.TcType.html#writeMetaTyVar"><span class="hs-identifier hs-type">writeMetaTyVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019571"><span class="hs-identifier hs-type">occ_tv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-type">mkTyVarTy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019574"><span class="hs-identifier hs-type">new_tv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3573"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;promoteTyVar&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019571"><span class="hs-identifier hs-type">occ_tv</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;--&gt;&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019574"><span class="hs-identifier hs-type">new_tv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3574"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-type">mkTyVarTy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683019574"><span class="hs-identifier hs-type">new_tv</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3575"></span><span>
</span><span id="line-3576"></span><span>
</span><span id="line-3577"></span><span>
</span><span id="line-3578"></span><span class="hs-comment">-------------------------</span><span>
</span><span id="line-3579"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#touchabilityAndShapeTest"><span class="hs-identifier hs-type">touchabilityAndShapeTest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcLevel"><span class="hs-identifier hs-type">TcLevel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-3580"></span><span class="hs-comment">-- This is the key test for untouchability:</span><span>
</span><span id="line-3581"></span><span class="hs-comment">-- See Note [Unification preconditions] in GHC.Tc.Utils.Unify</span><span>
</span><span id="line-3582"></span><span class="hs-comment">-- and Note [Solve by unification] in GHC.Tc.Solver.Equality</span><span>
</span><span id="line-3583"></span><span class="hs-comment">-- True &lt;=&gt; touchability and shape are OK</span><span>
</span><span id="line-3584"></span><span id="touchabilityAndShapeTest"><span class="annot"><span class="annottext">touchabilityAndShapeTest :: TcLevel -&gt; TcTyVar -&gt; TcType -&gt; Bool
</span><a href="GHC.Tc.Utils.Unify.html#touchabilityAndShapeTest"><span class="hs-identifier hs-var hs-var">touchabilityAndShapeTest</span></a></span></span><span> </span><span id="local-6989586621683019576"><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019576"><span class="hs-identifier hs-var">given_eq_lvl</span></a></span></span><span> </span><span id="local-6989586621683019577"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019577"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span id="local-6989586621683019578"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019578"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-3585"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#MetaTv"><span class="hs-identifier hs-type">MetaTv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mtv_info :: TcTyVarDetails -&gt; MetaInfo
</span><a href="GHC.Tc.Utils.TcType.html#mtv_info"><span class="hs-identifier hs-var">mtv_info</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683019579"><span class="annot"><span class="annottext">MetaInfo
</span><a href="#local-6989586621683019579"><span class="hs-identifier hs-var">info</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mtv_tclvl :: TcTyVarDetails -&gt; TcLevel
</span><a href="GHC.Tc.Utils.TcType.html#mtv_tclvl"><span class="hs-identifier hs-var">mtv_tclvl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683019580"><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019580"><span class="hs-identifier hs-var">tv_lvl</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcTyVarDetails
</span><a href="GHC.Types.Var.html#tcTyVarDetails"><span class="hs-identifier hs-var">tcTyVarDetails</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019577"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-3586"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019580"><span class="hs-identifier hs-var">tv_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel -&gt; TcLevel -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#deeperThanOrSame"><span class="hs-operator hs-var">`deeperThanOrSame`</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683019576"><span class="hs-identifier hs-var">given_eq_lvl</span></a></span><span>
</span><span id="line-3587"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MetaInfo -&gt; TcType -&gt; Bool
</span><a href="GHC.Tc.Utils.Unify.html#checkTopShape"><span class="hs-identifier hs-var">checkTopShape</span></a></span><span> </span><span class="annot"><span class="annottext">MetaInfo
</span><a href="#local-6989586621683019579"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019578"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-3588"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-3589"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3590"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-3591"></span><span>
</span><span id="line-3592"></span><span class="hs-comment">-------------------------</span><span>
</span><span id="line-3593"></span><span class="hs-comment">-- | checkTopShape checks (TYVAR-TV)</span><span>
</span><span id="line-3594"></span><span class="hs-comment">-- Note [Unification preconditions]; returns True if these conditions</span><span>
</span><span id="line-3595"></span><span class="hs-comment">-- are satisfied. But see the Note for other preconditions, too.</span><span>
</span><span id="line-3596"></span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#checkTopShape"><span class="hs-identifier hs-type">checkTopShape</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#MetaInfo"><span class="hs-identifier hs-type">MetaInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-3597"></span><span id="checkTopShape"><span class="annot"><span class="annottext">checkTopShape :: MetaInfo -&gt; TcType -&gt; Bool
</span><a href="GHC.Tc.Utils.Unify.html#checkTopShape"><span class="hs-identifier hs-var hs-var">checkTopShape</span></a></span></span><span> </span><span id="local-6989586621683019582"><span class="annot"><span class="annottext">MetaInfo
</span><a href="#local-6989586621683019582"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span id="local-6989586621683019583"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019583"><span class="hs-identifier hs-var">xi</span></a></span></span><span>
</span><span id="line-3598"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MetaInfo
</span><a href="#local-6989586621683019582"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3599"></span><span>      </span><span class="annot"><span class="annottext">MetaInfo
</span><a href="GHC.Tc.Utils.TcType.html#TyVarTv"><span class="hs-identifier hs-var">TyVarTv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-3600"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe TcTyVar
</span><a href="GHC.Core.Type.html#getTyVar_maybe"><span class="hs-identifier hs-var">getTyVar_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683019583"><span class="hs-identifier hs-var">xi</span></a></span><span> </span><span class="hs-keyword">of</span><span>   </span><span class="hs-comment">-- Looks through type synonyms</span><span>
</span><span id="line-3601"></span><span>           </span><span class="annot"><span class="annottext">Maybe TcTyVar
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-3602"></span><span>           </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683019584"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019584"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcTyVarDetails
</span><a href="GHC.Types.Var.html#tcTyVarDetails"><span class="hs-identifier hs-var">tcTyVarDetails</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683019584"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-comment">-- (TYVAR-TV) wrinkle</span><span>
</span><span id="line-3603"></span><span>                        </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#SkolemTv"><span class="hs-identifier hs-type">SkolemTv</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-3604"></span><span>                        </span><span class="annot"><span class="annottext">TcTyVarDetails
</span><a href="GHC.Tc.Utils.TcType.html#RuntimeUnk"><span class="hs-identifier hs-var">RuntimeUnk</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-3605"></span><span>                        </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#MetaTv"><span class="hs-identifier hs-type">MetaTv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mtv_info :: TcTyVarDetails -&gt; MetaInfo
</span><a href="GHC.Tc.Utils.TcType.html#mtv_info"><span class="hs-identifier hs-var">mtv_info</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MetaInfo
</span><a href="GHC.Tc.Utils.TcType.html#TyVarTv"><span class="hs-identifier hs-var">TyVarTv</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-3606"></span><span>                        </span><span class="annot"><span class="annottext">TcTyVarDetails
</span><span class="hs-identifier">_</span></span><span>                             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-3607"></span><span>      </span><span class="annot"><span class="annottext">MetaInfo
</span><a href="GHC.Tc.Utils.TcType.html#CycleBreakerTv"><span class="hs-identifier hs-var">CycleBreakerTv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>  </span><span class="hs-comment">-- We never unify these</span><span>
</span><span id="line-3608"></span><span>      </span><span class="annot"><span class="annottext">MetaInfo
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-3609"></span></pre></body></html>